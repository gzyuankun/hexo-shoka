<!-- build time:Mon May 15 2023 23:19:41 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Hide your thoughts" href="http://blog.itshare.work/rss.xml"><link rel="alternate" type="application/atom+xml" title="Hide your thoughts" href="http://blog.itshare.work/atom.xml"><link rel="alternate" type="application/json" title="Hide your thoughts" href="http://blog.itshare.work/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Kubernetes"><link rel="canonical" href="http://blog.itshare.work/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/"><title>搭建Kubernetes集群 - Kubernetes | Cookie = Hide your thoughts</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">搭建Kubernetes集群</h1><div class="meta"><span class="item" title="创建时间：2023-03-21 00:14:18"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-03-21T00:14:18+08:00">2023-03-21</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>13k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>12 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Cookie</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/23.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/3.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/16.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/13.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/19.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/30.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Kubernetes/" itemprop="item" rel="index" title="分类于 Kubernetes"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://blog.itshare.work/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="yuan kun"><meta itemprop="description" content=", 解决各种服务器、网络、应用等技术问题，致力于保障系统稳定、高效运行"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hide your thoughts"></span><div class="body md" itemprop="articleBody"><h1 id="搭建kubernetes集群"><a class="anchor" href="#搭建kubernetes集群">#</a> 搭建 Kubernetes 集群</h1><h2 id="部署前提"><a class="anchor" href="#部署前提">#</a> 部署前提</h2><ul><li>使用 kubeadm 部署 Kubernetes 集群的前提条件</li><li>支持 Kubernetes 运行的 Linux 主机，例如 Debian、RedHat 及其变体等</li><li>每主机 2GB 以上的内存，以及 2 颗以上的 CPU</li><li>各主机间能够通过网络无障碍通信</li><li>独占的 hostname、MAC 地址以及 product_uuid，主机名能够正常解析</li><li>放行由 Kubernetes 使用到的各端口，或直接禁用 iptables</li><li>禁用各主机的上的 Swap 设备</li><li>各主机时间同步</li></ul><h2 id="部署环境"><a class="anchor" href="#部署环境">#</a> 部署环境</h2><ul><li>OS: Ubuntu 20.04.2 LTS</li><li>Docker：20.10.10，CGroup Driver: systemd</li><li>Kubernetes：v1.26.3, CRI: containerd, CNI: Flannel</li><li>主机</li></ul><table><thead><tr><th>主机 IP</th><th>主机名称</th><th>角色</th></tr></thead><tbody><tr><td>192.168.32.200</td><td><span class="exturl" data-url="aHR0cDovL2s4cy1tYXN0ZXIwMS5vcmc=">k8s-master01.org</span></td><td>master</td></tr><tr><td>192.168.32.203</td><td><span class="exturl" data-url="aHR0cDovL2s4cy1ub2RlMDEub3Jn">k8s-node01.org</span></td><td>node01</td></tr><tr><td>192.168.32.204</td><td><span class="exturl" data-url="aHR0cDovL2s4cy1ub2RlMDIub3Jn">k8s-node02.org</span></td><td>node02</td></tr><tr><td>192.168.32.205</td><td><span class="exturl" data-url="aHR0cDovL2s4cy1ub2RlMDMub3Jn">k8s-node03.org</span></td><td>node03</td></tr></tbody></table><h2 id="修改主机名称"><a class="anchor" href="#修改主机名称">#</a> 修改主机名称</h2><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 修改 192.168.32.200 的主机名称为 k8s-master01.org</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 修改 192.168.32.203 的主机名称为 k8s-node01.org</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 修改 192.168.32.204 的主机名称为 k8s-node02.org</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 修改 192.168.32.205 的主机名称为 k8s-node03.org</span></pre></td></tr></table></figure><h2 id="主机时间同步"><a class="anchor" href="#主机时间同步">#</a> 主机时间同步</h2><p>在所有主机上安装 chrony</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">## 所有主机上执行</span></pre></td></tr><tr><td data-num="2"></td><td><pre>root@k8s-master01:~<span class="token comment"># apt install -y chrony</span></pre></td></tr></table></figure><p>建议用户配置使用本地的的时间服务器，在节点数量众多时尤其如此。存在可用的本地时间服务器时，修改节点的 /etc/chrony/chrony.conf 配置文件，并将时间服务器指向相应的主机即可，配置格式如下：</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>server CHRONY-SERVER-NAME-OR-IP iburst</pre></td></tr></table></figure><h2 id="主机名称解析"><a class="anchor" href="#主机名称解析">#</a> 主机名称解析</h2><p>出于简化配置步骤的目的，本测试环境使用 hosts 文件进行各节点名称解析，文件内容如下所示。其中，我们使用 kubeapi 主机名作为 API Server 在高可用环境中的专用接入名称，也为控制平面的高可用配置留下便于配置的余地。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 编辑 /etc/hosts 文件加入如下内容</span></pre></td></tr><tr><td data-num="2"></td><td><pre>root@k8s-master01:~<span class="token comment"># vim /etc/hosts</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">192.168</span>.32.200 k8s-master01.org</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">192.168</span>.32.203 k8s-node01.org</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">192.168</span>.32.204 k8s-node02.org</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">192.168</span>.32.205 k8s-node03.org</pre></td></tr></table></figure><h2 id="禁用swap设备"><a class="anchor" href="#禁用swap设备">#</a> 禁用 Swap 设备</h2><p>部署集群时，kubeadm 默认会预先检查当前主机是否禁用了 Swap 设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的 Swap 设备，否则，就需要在后文的 kubeadm init 及 kubeadm join 命令执行时额外使用相关的选项忽略检查错误。</p><p>关闭 Swap 设备，需要分两步完成。首先是关闭当前已启用的所有 Swap 设备：</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 临时关闭，所有机器执行</span></pre></td></tr><tr><td data-num="2"></td><td><pre>root@k8s-master01:~<span class="token comment"># swapoff -a</span></pre></td></tr></table></figure><p>而后编辑 /etc/fstab 配置文件，注释用于挂载 Swap 设备的所有行</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 所有机器执行</span></pre></td></tr><tr><td data-num="2"></td><td><pre>root@k8s-master01:~<span class="token comment">#vim /etc/fstab</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 注释如下一行</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#/swap.img      none    swap    sw      0       0</span></pre></td></tr></table></figure><h2 id="禁用默认的防火墙服务"><a class="anchor" href="#禁用默认的防火墙服务">#</a> 禁用默认的防火墙服务</h2><p>Ubuntu 和 Debian 等 Linux 发行版默认使用 ufw（Uncomplicated FireWall）作为前端来简化 iptables 的使用，处于启用状态时，它默认会生成一些规则以加强系统安全。出于降低配置复杂度之目的，本文选择直接将其禁用。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment"># ufw disable</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Firewall stopped and disabled on system startup</pre></td></tr><tr><td data-num="3"></td><td><pre>root@k8s-master01:~<span class="token comment"># ufw status</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Status: inactive</pre></td></tr><tr><td data-num="5"></td><td><pre>root@k8s-master01:~<span class="token comment">#</span></pre></td></tr></table></figure><h2 id="安装程序包"><a class="anchor" href="#安装程序包">#</a> 安装程序包</h2><p>提示：以下操作需要在本示例中的所有四台主机上分别进行</p><h3 id="安装并启动docker"><a class="anchor" href="#安装并启动docker">#</a> 安装并启动 docker</h3><p>首先，生成 docker-ce 相关程序包的仓库，这里以阿里云的镜像服务器为例进行说明<br><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9taXJyb3IvZG9ja2VyLWNlP3NwbT1hMmM2aC4xMzY1MTEwMi4wLjAuM2UyMjFiMTFld0FsMnI=">docker-ce 镜像_docker-ce 下载地址_docker-ce 安装教程 - 阿里巴巴开源镜像站 (aliyun.com)</span></p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># step 1: 安装必要的一些系统工具</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> update</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># step 2: 安装 GPG 证书</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Step 3: 写入软件源信息</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">sudo</span> add-apt-repository <span class="token string">"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># Step 4: 更新并安装 Docker-CE</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> update</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 安装指定版本的 Docker-CE:</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># Step 1: 查找 Docker-CE 的版本:</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># apt-cache madison docker-ce</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># Step 2: 安装指定版本的 Docker-CE: (VERSION 例如上面的 17.03.1~ce-0~ubuntu-xenial)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># sudo apt-get -y install docker-ce=[VERSION]</span></pre></td></tr></table></figure><p>本文以为 20.10.10 版本为例</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-node3:~<span class="token comment"># apt install docker-ce=5:20.10.10~3-0~ubuntu-focal docker-ce-cli=5:20.10.10~3-0~ubuntu-focal</span></pre></td></tr></table></figure><p>kubelet 需要让 docker 容器引擎使用 systemd 作为 CGroup 的驱动，其默认值为 cgroupfs，因而，我们还需要编辑 docker 的配置文件 /etc/docker/daemon.json，添加如下内容，其中的 registry-mirrors 用于指明使用的镜像加速服务。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /etc/docker/daemon.json</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token string">"https://ung2thfc.mirror.aliyuncs.com"</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token string">"https://mirror.ccs.tencentyun.com"</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token string">"https://registry.docker-cn.com"</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token string">"http://hub-mirror.c.163.com"</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token string">"exec-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart <span class="token function">docker</span></pre></td></tr></table></figure><h2 id="安装cri-dockerd"><a class="anchor" href="#安装cri-dockerd">#</a> 安装 cri-dockerd</h2><p>Kubernetes 自 v1.24 移除了对 docker-shim 的支持，而 Docker Engine 默认又不支持 CRI 规范，因而二者将无法直接完成整合。为此，Mirantis 和 Docker 联合创建了 cri-dockerd 项目，用于为 Docker Engine 提供一个能够支持到 CRI 规范的垫片，从而能够让 Kubernetes 基于 CRI 控制 Docker 。</p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01pcmFudGlzL2NyaS1kb2NrZXJk">项目地址</span></p><p>cri-dockerd 项目提供了预制的二进制格式的程序包，用户按需下载相应的系统和对应平台的版本即可完成安装，这里以 Ubuntu 2004 64bits 系统环境，以及 cri-dockerd 目前最新的程序版本 v0.3.0 为例。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.0/cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>dpkg <span class="token parameter variable">-i</span> cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb</pre></td></tr></table></figure><p>完成安装后，相应的服务 cri-dockerd.service 便会自动启动。我们也可以使用如下命令进行验证，若服务处于 Running 状态即可进行后续步骤 。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment"># systemctl status cri-docker.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre>● cri-docker.service - CRI Interface <span class="token keyword">for</span> Docker Application Container Engine</pre></td></tr><tr><td data-num="3"></td><td><pre>     Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/cri-docker.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue <span class="token number">2023</span>-03-21 <span class="token number">10</span>:59:57 CST<span class="token punctuation">;</span> 1min 20s ago</pre></td></tr><tr><td data-num="5"></td><td><pre>TriggeredBy: ● cri-docker.socket</pre></td></tr><tr><td data-num="6"></td><td><pre>       Docs: https://docs.mirantis.com</pre></td></tr><tr><td data-num="7"></td><td><pre>   Main PID: <span class="token number">17591</span> <span class="token punctuation">(</span>cri-dockerd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      Tasks: <span class="token number">7</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     Memory: <span class="token number">11</span>.9M</pre></td></tr><tr><td data-num="10"></td><td><pre>     CGroup: /system.slice/cri-docker.service</pre></td></tr><tr><td data-num="11"></td><td><pre>             └─17591 /usr/bin/cri-dockerd --container-runtime-endpoint fd://</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:57 k8s-master01.org cri-dockerd<span class="token punctuation">[</span><span class="token number">17591</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2023-03-21T10:59:57+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Start docker client with request timeout 0s"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:57 k8s-master01.org cri-dockerd<span class="token punctuation">[</span><span class="token number">17591</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2023-03-21T10:59:57+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Hairpin mode is set to none"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:57 k8s-master01.org cri-dockerd<span class="token punctuation">[</span><span class="token number">17591</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2023-03-21T10:59:57+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Loaded network plugin cni"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:57 k8s-master01.org cri-dockerd<span class="token punctuation">[</span><span class="token number">17591</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2023-03-21T10:59:57+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Docker cri networking managed by network plugin cni"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:57 k8s-master01.org systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started CRI Interface <span class="token keyword">for</span> Docker Application Container Engine.</pre></td></tr><tr><td data-num="18"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:58 k8s-master01.org cri-dockerd<span class="token punctuation">[</span><span class="token number">17591</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2023-03-21T10:59:57+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Docker Info: &amp;&#123;ID:WQBA:P7R2:H6ZI:KWU3:FVFW:MHLC:QTT7:CJCX></span></pre></td></tr><tr><td data-num="19"></td><td><pre>Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time="<span class="token number">2023</span>-03-21T10:59:57+08:00<span class="token string">" level=info msg="</span>Setting cgroupDriver cgroupfs<span class="token string">"</span></pre></td></tr><tr><td data-num="20"></td><td><pre>Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time="<span class="token number">2023</span>-03-21T10:59:57+08:00<span class="token string">" level=info msg="</span>Docker cri received runtime config <span class="token operator">&amp;</span>RuntimeConfig<span class="token punctuation">&#123;</span>Network<span class="token operator">></span></pre></td></tr><tr><td data-num="21"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:58 k8s-master01.org cri-dockerd<span class="token punctuation">[</span><span class="token number">17591</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2023-03-21T10:59:57+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Starting the GRPC backend for the Docker CRI interface."</span></pre></td></tr><tr><td data-num="22"></td><td><pre>Mar <span class="token number">21</span> <span class="token number">10</span>:59:58 k8s-master01.org cri-dockerd<span class="token punctuation">[</span><span class="token number">17591</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2023-03-21T10:59:57+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Start cri-dockerd grpc backend"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>lines <span class="token number">1</span>-21/21 <span class="token punctuation">(</span>END<span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="安装kubelet-kubeadm和kubectl"><a class="anchor" href="#安装kubelet-kubeadm和kubectl">#</a> 安装 kubelet、kubeadm 和 kubectl</h2><p>首先，在各主机上生成 kubelet 和 kubeadm 等相关程序包的仓库，这里以阿里云的镜像服务为例</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> apt-transport-https</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> apt-key <span class="token function">add</span> - </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span>/etc/apt/sources.list.d/kubernetes.list</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</pre></td></tr><tr><td data-num="5"></td><td><pre>EOF</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">apt-get</span> update</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectl</pre></td></tr></table></figure><p>安装完成后，要确保 kubeadm 等程序文件的版本，这将也是后面初始化 Kubernetes 集群时需要明确指定的版本号</p><h3 id="整合kubelet和cri-dockerd"><a class="anchor" href="#整合kubelet和cri-dockerd">#</a> 整合 kubelet 和 cri-dockerd</h3><p>仅支持 CRI 规范的 kubelet 需要经由遵循该规范的 cri-dockerd 完成与 docker-ce 的整合。</p><h3 id="配置cri-dockerd"><a class="anchor" href="#配置cri-dockerd">#</a> 配置 cri-dockerd</h3><p>配置 cri-dockerd，确保其能够正确加载到 CNI 插件。编辑 /usr/lib/systemd/system/cri-docker.service 文件，确保其 [Service] 配置段中的 ExecStart 的值类似如下内容</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --network-plugin<span class="token operator">=</span>cni --pod-infra-container-image<span class="token operator">=</span>registry.aliyuncs.com/google_containers/pause:3.7 --cni-bin-dir<span class="token operator">=</span>/opt/cni/bin --cni-cache-dir<span class="token operator">=</span>/var/lib/cni/cache --cni-conf-dir<span class="token operator">=</span>/etc/cni/net.d</pre></td></tr></table></figure><p>需要添加的各配置参数（各参数的值要与系统部署的 CNI 插件的实际路径相对应）：</p><ul><li>--network-plugin：指定网络插件规范的类型，这里要使用 CNI；</li><li>--cni-bin-dir：指定 CNI 插件二进制程序文件的搜索目录；</li><li>--cni-cache-dir：CNI 插件使用的缓存目录；</li><li>--cni-conf-dir：CNI 插件加载配置文件的目录；</li></ul><p>配置完成后，重载并重启 cri-docker.service 服务。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment"># systemctl daemon-reload;systemctl restart cri-docker</span></pre></td></tr></table></figure><h2 id="配置kubelet"><a class="anchor" href="#配置kubelet">#</a> 配置 kubelet</h2><p>配置 kubelet，为其指定 cri-dockerd 在本地打开的 Unix Sock 文件的路径，该路径一般默认为 “/run/cri-dockerd.sock“。编辑文件 /etc/sysconfig/kubelet，为其添加 如下指定参数。</p><blockquote><p>提示：若 /etc/sysconfig 目录不存在，则需要先创建该目录。</p></blockquote><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token assign-left variable">KUBELET_KUBEADM_ARGS</span><span class="token operator">=</span><span class="token string">"--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock"</span></pre></td></tr></table></figure><p>需要说明的是，该配置也可不进行，而是直接在后面的各 kubeadm 命令上使用 “--cri-socket unix:///run/cri-dockerd.sock” 选项。</p><h3 id="初始化第一个主节点"><a class="anchor" href="#初始化第一个主节点">#</a> 初始化第一个主节点</h3><p>该步骤开始尝试构建 Kubernetes 集群的 master 节点，配置完成后，各 worker 节点直接加入到集群中的即可。需要特别说明的是，由 kubeadm 部署的 Kubernetes 集群上，集群核心组件 kube-apiserver、kube-controller-manager、kube-scheduler 和 etcd 等均会以静态 Pod 的形式运行，它们所依赖的镜像文件默认来自于 registry.k8s.io 这一 Registry 服务之上。但我们无法直接访问该服务，常用的解决办法有如下两种</p><ul><li>使用能够到达该服务的代理服务；</li><li>使用国内的镜像服务器上的服务，<span class="exturl" data-url="aHR0cDovL3huLS1yZWdpc3RyeS1reDJtMjYzZi5hbGl5dW5jcy5jb20vZ29vZ2xlX2NvbnRhaW5lcnMlRTclQUQlODklRTMlODAlODI=">例如 registry.aliyuncs.com/google_containers 等。</span></li></ul><h3 id="初始化master节点在k8s-master01上完成如下操作"><a class="anchor" href="#初始化master节点在k8s-master01上完成如下操作">#</a> 初始化 master 节点（在 k8s-master01 上完成如下操作）</h3><p>运行如下命令完成 k8s-master01 节点的初始化：</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version<span class="token operator">=</span>v1.26.3 --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 --service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12 --token-ttl<span class="token operator">=</span><span class="token number">0</span> --cri-socket unix:///run/cri-dockerd.sock</pre></td></tr></table></figure><p>命令中的各选项简单说明如下：</p><ul><li>--image-repository：指定要使用的镜像仓库，<span class="exturl" data-url="aHR0cDovL3huLS1yZWdpc3RyeS13ZzBtczU4MWM5ZXZiLms4cy5pbw==">默认为 registry.k8s.io</span>；</li><li>--kubernetes-version：kubernetes 程序组件的版本号，它必须要与安装的 kubelet 程序包的版本号相同；</li><li>--control-plane-endpoint：控制平面的固定访问端点，可以是 IP 地址或 DNS 名称，会被用于集群管理员及集群组件的 kubeconfig 配置文件的 API Server 的访问地址；单控制平面部署时可以不使用该选项；</li><li>--pod-network-cidr：Pod 网络的地址范围，其值为 CIDR 格式的网络地址，通常，Flannel 网络插件的默认为 10.244.0.0/16，Project Calico 插件的默认值为 192.168.0.0/16；</li><li>--service-cidr：Service 的网络地址范围，其值为 CIDR 格式的网络地址，默认为 10.96.0.0/12；通常，仅 Flannel 一类的网络插件需要手动指定该地址；</li><li>--apiserver-advertise-address：apiserver 通告给其他组件的 IP 地址，一般应该为 Master 节点的用于集群内部通信的 IP 地址，0.0.0.0 表示节点上所有可用地址；</li><li>--token-ttl：共享令牌（token）的过期时长，默认为 24 小时，0 表示永不过期；为防止不安全存储等原因导致的令牌泄露危及集群安全，建议为其设定过期时长。未设定该选项时，在 token 过期后，若期望再向集群中加入其它节点，可以使用如下命令重新创建 token，并生成节点加入命令。</li></ul><h4 id="初始化完成后的操作步骤"><a class="anchor" href="#初始化完成后的操作步骤">#</a> 初始化完成后的操作步骤</h4><p>对于 Kubernetes 系统的新用户来说，无论使用上述哪种方法，命令运行结束后，请记录最后的 kubeadm join 命令输出的最后提示的操作步骤。下面的内容是需要用户记录的一个命令输出示例，它提示了后续需要的操作步骤。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下面是成功完成第一个控制平面节点初始化的提示信息及后续需要完成的步骤</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 为了完成初始化操作，管理员需要额外手动完成几个必要的步骤</span></pre></td></tr><tr><td data-num="5"></td><td><pre>To start using your cluster, you need to run the following as a regular user:</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 第 1 个步骤提示， Kubernetes 集群管理员认证到 Kubernetes 集群时使用的 kubeconfig 配置文件</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 我们也可以不做上述设定，而使用环境变量 KUBECONFIG 为 kubectl 等指定默认使用的 kubeconfig；</span></pre></td></tr><tr><td data-num="13"></td><td><pre>Alternatively, <span class="token keyword">if</span> you are the root user, you can run:</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 第 2 个步骤提示，为 Kubernetes 集群部署一个网络插件，具体选用的插件则取决于管理员；</span></pre></td></tr><tr><td data-num="18"></td><td><pre>You should now deploy a pod network to the cluster.</pre></td></tr><tr><td data-num="19"></td><td><pre>Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</pre></td></tr><tr><td data-num="20"></td><td><pre>https://kubernetes.io/docs/concepts/cluster-administration/addons/</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 第 3 个步骤提示，向集群添加额外的控制平面节点，但本文会略过该步骤，并将在其它文章介绍其实现方式。</span></pre></td></tr><tr><td data-num="23"></td><td><pre>You can now <span class="token function">join</span> any number of the control-plane <span class="token function">node</span> running the following <span class="token builtin class-name">command</span> on each as root:</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 第 4 个步骤提示，向集群添加工作节点</span></pre></td></tr><tr><td data-num="26"></td><td><pre>Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 在部署好 kubeadm 等程序包的各工作节点上以 root 用户运行类似如下命令；</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># 提示：与 cri-dockerd 结合使用 docker-ce 作为 container runtime 时，通常需要为下面的命令</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#     额外附加 “--cri-socket unix:///run/cri-dockerd.sock” 选项；</span></pre></td></tr><tr><td data-num="31"></td><td><pre>kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.32.200:6443 <span class="token parameter variable">--token</span> ivu3t7.pogk70dd5pualoz2 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="32"></td><td><pre>--discovery-token-ca-cert-hash</pre></td></tr><tr><td data-num="33"></td><td><pre>sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d</pre></td></tr></table></figure><h3 id="设定kubectl"><a class="anchor" href="#设定kubectl">#</a> 设定 kubectl</h3><p>kubectl 是 kube-apiserver 的命令行客户端程序，实现了除系统部署之外的几乎全部的管理操作，是 kubernetes 管理员使用最多的命令之一。kubectl 需经由 API server 认证及授权后方能执行相应的管理操作，kubeadm 部署的集群为其生成了一个具有管理员权限的认证配置文件 /etc/kubernetes/admin.conf，它可由 kubectl 通过默认的 “$HOME/.kube/config” 的路径进行加载。当然，用户也可在 kubectl 命令上使用 --kubeconfig 选项指定一个别的位置。</p><p>下面复制认证为 Kubernetes 系统管理员的配置文件至目标用户（例如当前用户 root）的家目录下：</p><p>~# mkdir ~/.kube</p><p>~# cp /etc/kubernetes/admin.conf ~/.kube/config</p><h3 id="部署网络插件"><a class="anchor" href="#部署网络插件">#</a> 部署网络插件</h3><p>Kubernetes 系统上 Pod 网络的实现依赖于第三方插件进行，这类插件有近数十种之多，较为著名的有 flannel、calico、canal 和 kube-router 等，简单易用的实现是为 CoreOS 提供的 flannel 项目。下面的命令用于在线部署 flannel 至 Kubernetes 系统之上：</p><p>首先，下载适配系统及硬件平台环境的 flanneld 至每个节点，并放置于 /opt/bin/ 目录下。我们这里选用 flanneld-amd64，目前最新的版本为 v0.21.3，因而，我们需要在集群的每个节点上执行如下命令：</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>~<span class="token comment"># mkdir /opt/cni/bin/</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>~<span class="token comment"># curl -L https://github.com/flannel-io/flannel/releases/download/v0.20.2/flanneld-amd64  -o /opt/cni/bin/flanneld</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>~<span class="token comment"># chmod +x /opt/cni/bin/flanneld</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>提示：下载flanneld的地址为 https://github.com/flannel-io/flannel/releases</pre></td></tr></table></figure><p>随后，在初始化的第一个 master 节点 k8s-master01 上运行如下命令，向 Kubernetes 部署 kube-flannel</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/flannel-io/flannel/v0.21.3/Documentation/kube-flannel.yml</pre></td></tr></table></figure><p>而后使用如下命令确认其输出结果中 Pod 的状态为 “Running”，类似如下命令及其输入的结果所示：</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment">#  kubectl get pods -n kube-flannel</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>kube-flannel-ds-jgkxd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m59s</pre></td></tr><tr><td data-num="4"></td><td><pre>root@k8s-master01:~<span class="token comment">#</span></pre></td></tr></table></figure><h3 id="验证master节点已经就绪"><a class="anchor" href="#验证master节点已经就绪">#</a> 验证 master 节点已经就绪</h3><p>kubectl get nodes</p><p>上述命令应该会得到类似如下输出，这表示 k8s-master01 节点已经就绪</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment"># kubectl get nodes</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME               STATUS   ROLES           AGE   VERSION</pre></td></tr><tr><td data-num="3"></td><td><pre>k8s-master01.org   Ready    control-plane   62m   v1.26.3</pre></td></tr><tr><td data-num="4"></td><td><pre>root@k8s-master01:~<span class="token comment">#</span></pre></td></tr></table></figure><h3 id="添加节点到集群中"><a class="anchor" href="#添加节点到集群中">#</a> 添加节点到集群中</h3><p>下面的两个步骤，需要分别在 k8s-node01、k8s-node02 和 k8s-node03 上各自完成。</p><p>1、若未禁用 Swap 设备，编辑 kubelet 的配置文件 /etc/default/kubelet，设置其忽略 Swap 启用的状态错误，内容如下：KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</p><p>2、将节点加入第二步中创建的 master 的集群中，要使用主节点初始化过程中记录的 kubeadm join 命令；</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-node01:/opt/cni/bin<span class="token comment"># kubeadm join 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 --discovery-token-ca-cert-hash sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d --cri-socket unix:///run/cri-dockerd.sock</span></pre></td></tr></table></figure><h3 id="验证节点添加结果"><a class="anchor" href="#验证节点添加结果">#</a> 验证节点添加结果</h3><p>在每个节点添加完成后，即可通过 kubectl 验证添加结果。下面的命令及其输出是在所有的三个节点均添加完成后运行的，其输出结果表明三个 Worker Node 已经准备就绪。</p><p>~# kubectl get nodes</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment"># kubectl get nodes</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME               STATUS   ROLES           AGE    VERSION</pre></td></tr><tr><td data-num="3"></td><td><pre>k8s-master01.org   Ready    control-plane   80m    v1.26.3</pre></td></tr><tr><td data-num="4"></td><td><pre>k8s-node01.org     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>          15m    v1.26.3</pre></td></tr><tr><td data-num="5"></td><td><pre>k8s-node2.org      Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>          114s   v1.26.3</pre></td></tr><tr><td data-num="6"></td><td><pre>k8s-node3.org      Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>          11m    v1.26.3</pre></td></tr><tr><td data-num="7"></td><td><pre>root@k8s-master01:~<span class="token comment">#</span></pre></td></tr></table></figure><h3 id="测试应用编排及服务访问"><a class="anchor" href="#测试应用编排及服务访问">#</a> 测试应用编排及服务访问</h3><p>到此为止，一个 master，并附带有三个 worker 的 kubernetes 集群基础设施已经部署完成，用户随后即可测试其核心功能。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment"># kubectl create deployment test-nginx --image=nginx:latest --replicas=3</span></pre></td></tr><tr><td data-num="2"></td><td><pre>deployment.apps/test-nginx created</pre></td></tr><tr><td data-num="3"></td><td><pre>root@k8s-master01:~<span class="token comment"># </span></pre></td></tr><tr><td data-num="4"></td><td><pre>root@k8s-master01:~<span class="token comment"># kubectl create service nodeport test-nginx --tcp=80:80</span></pre></td></tr><tr><td data-num="5"></td><td><pre>service/test-nginx created</pre></td></tr><tr><td data-num="6"></td><td><pre>root@k8s-master01:~<span class="token comment">#</span></pre></td></tr></table></figure><p>而后，使用如下命令了解 Service 对象 test-nginx 使用的 NodePort，以便于在集群外部进行访问：</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>root@k8s-master01:~<span class="token comment"># kubectl get svc -l app=test-nginx</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>test-nginx   NodePort   <span class="token number">10.100</span>.229.239   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:31888/TCP   50s</pre></td></tr><tr><td data-num="4"></td><td><pre>root@k8s-master01:~<span class="token comment">#</span></pre></td></tr></table></figure><figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tr><td data-num="1"></td><td><pre>因此，用户可以于集群外部通过"http://NodeIP:31888"这个URL访问we应用，例如于集群外通过浏览器访问"http://192.168.32.203:31888"</pre></td></tr></table></figure><p><img data-src="../image.assets/1679388005874.png" alt="1679388005874"></p><h2 id="小结"><a class="anchor" href="#小结">#</a> 小结</h2><p>本文给出了部署 Kubernetes 分布式集群的具体步骤，并在最后测试了将应用部署并运行于 Kubernetes 系统上的结果。在读者朋友们自行测试时，cri-dockerd、docker-ce、flannel、kubeadm、kubectl 和 kubelet 的版本均可能存在版本上的不同，也因此可能会存在一定程度上的配置差异，具体调整方式请大家自行参考相关的文档进行</p><div class="tags"><a href="/tags/Kubernetes/" rel="tag"><i class="ic i-tag"></i> Kubernetes</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-05-11 21:14:58" itemprop="dateModified" datetime="2023-05-11T21:14:58+08:00">2023-05-11</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>yuan kun <i class="ic i-at"><em>@</em></i>Hide your thoughts</li><li class="link"><strong>本文链接：</strong> <a href="http://blog.itshare.work/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/" title="搭建Kubernetes集群">http://blog.itshare.work/Kubernetes/搭建Kubernetes集群/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Docker/Docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/" itemprop="url" rel="prev" data-background-image="http:&#x2F;&#x2F;oss.itshare.work&#x2F;itshare-work-images&#x2F;12.jpg" title="Docker镜像加速"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Docker</span><h3>Docker镜像加速</h3></a></div><div class="item right"><a href="/zabbix/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/" itemprop="url" rel="next" data-background-image="http:&#x2F;&#x2F;oss.itshare.work&#x2F;itshare-work-images&#x2F;22.jpg" title="zabbix5部署安装"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> zabbix</span><h3>zabbix5部署安装</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAkubernetes%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">搭建 Kubernetes 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%89%8D%E6%8F%90"><span class="toc-number">1.1.</span> <span class="toc-text">部署前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">部署环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D%E7%A7%B0"><span class="toc-number">1.3.</span> <span class="toc-text">修改主机名称</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-number">1.4.</span> <span class="toc-text">主机时间同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%90%8D%E7%A7%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">主机名称解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%81%E7%94%A8swap%E8%AE%BE%E5%A4%87"><span class="toc-number">1.6.</span> <span class="toc-text">禁用 Swap 设备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E9%BB%98%E8%AE%A4%E7%9A%84%E9%98%B2%E7%81%AB%E5%A2%99%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.7.</span> <span class="toc-text">禁用默认的防火墙服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F%E5%8C%85"><span class="toc-number">1.8.</span> <span class="toc-text">安装程序包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8docker"><span class="toc-number">1.8.1.</span> <span class="toc-text">安装并启动 docker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85cri-dockerd"><span class="toc-number">1.9.</span> <span class="toc-text">安装 cri-dockerd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kubelet-kubeadm%E5%92%8Ckubectl"><span class="toc-number">1.10.</span> <span class="toc-text">安装 kubelet、kubeadm 和 kubectl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E5%90%88kubelet%E5%92%8Ccri-dockerd"><span class="toc-number">1.10.1.</span> <span class="toc-text">整合 kubelet 和 cri-dockerd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEcri-dockerd"><span class="toc-number">1.10.2.</span> <span class="toc-text">配置 cri-dockerd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEkubelet"><span class="toc-number">1.11.</span> <span class="toc-text">配置 kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.11.1.</span> <span class="toc-text">初始化第一个主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96master%E8%8A%82%E7%82%B9%E5%9C%A8k8s-master01%E4%B8%8A%E5%AE%8C%E6%88%90%E5%A6%82%E4%B8%8B%E6%93%8D%E4%BD%9C"><span class="toc-number">1.11.2.</span> <span class="toc-text">初始化 master 节点（在 k8s-master01 上完成如下操作）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%8C%E6%88%90%E5%90%8E%E7%9A%84%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.11.2.1.</span> <span class="toc-text">初始化完成后的操作步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%AE%9Akubectl"><span class="toc-number">1.11.3.</span> <span class="toc-text">设定 kubectl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-number">1.11.4.</span> <span class="toc-text">部署网络插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81master%E8%8A%82%E7%82%B9%E5%B7%B2%E7%BB%8F%E5%B0%B1%E7%BB%AA"><span class="toc-number">1.11.5.</span> <span class="toc-text">验证 master 节点已经就绪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4%E4%B8%AD"><span class="toc-number">1.11.6.</span> <span class="toc-text">添加节点到集群中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E7%BB%93%E6%9E%9C"><span class="toc-number">1.11.7.</span> <span class="toc-text">验证节点添加结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%BA%94%E7%94%A8%E7%BC%96%E6%8E%92%E5%8F%8A%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE"><span class="toc-number">1.11.8.</span> <span class="toc-text">测试应用编排及服务访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.12.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/" rel="bookmark" title="搭建Kubernetes集群">搭建Kubernetes集群</a></li><li><a href="/Kubernetes/Kubernetes%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="bookmark" title="Kubernetes读书笔记">Kubernetes读书笔记</a></li><li><a href="/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/" rel="bookmark" title="Kubernetes详细教程">Kubernetes详细教程</a></li><li><a href="/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B-%E8%B0%83%E6%95%B4%E7%89%88/" rel="bookmark" title="Kubernetes详细教程-调整版">Kubernetes详细教程-调整版</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="yuan kun" data-src="/images/avatar.jpg"><p class="name" itemprop="name">yuan kun</p><div class="description" itemprop="description">解决各种服务器、网络、应用等技术问题，致力于保障系统稳定、高效运行</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">16</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">7</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">3</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==" title="https:&#x2F;&#x2F;github.com&#x2F;amehime&#x2F;hexo-theme-shoka"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Docker/Docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/zabbix/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Ansible/" title="分类于 Ansible">Ansible</a></div><span><a href="/Ansible/Ansible/" title="运维自动化工具Ansible(一)">运维自动化工具Ansible(一)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a></div><span><a href="/Linux/DNS/" title="DNS服务">DNS服务</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/zabbix/" title="分类于 zabbix">zabbix</a></div><span><a href="/zabbix/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/" title="zabbix5部署安装">zabbix5部署安装</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于 Kubernetes">Kubernetes</a></div><span><a href="/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/" title="Kubernetes详细教程">Kubernetes详细教程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a></div><span><a href="/Linux/Disk/" title="磁盘存储和文件系统管理">磁盘存储和文件系统管理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Docker/" title="分类于 Docker">Docker</a></div><span><a href="/Docker/docker-compose%E9%83%A8%E7%BD%B2MySQL/" title="docker-compose部署MySql">docker-compose部署MySql</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于 Kubernetes">Kubernetes</a></div><span><a href="/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/" title="搭建Kubernetes集群">搭建Kubernetes集群</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/MySQL/" title="分类于 MySQL">MySQL</a></div><span><a href="/MySQL/MySQL%E9%9B%86%E7%BE%A4/" title="MySQL集群">MySQL集群</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/MySQL/" title="分类于 MySQL">MySQL</a></div><span><a href="/MySQL/MySQL/" title="MySQL数据库基础和安装使用">MySQL数据库基础和安装使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/tomcat/" title="分类于 tomcat">tomcat</a></div><span><a href="/Linux/tomcat/tomcat/" title="tomcat">tomcat</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">yuan kun @ Cookie</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">392k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:56</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Kubernetes/搭建Kubernetes集群/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->