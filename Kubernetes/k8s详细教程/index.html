<!-- build time:Tue Jun 06 2023 19:23:36 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Hide your thoughts" href="http://blog.itshare.work/rss.xml"><link rel="alternate" type="application/atom+xml" title="Hide your thoughts" href="http://blog.itshare.work/atom.xml"><link rel="alternate" type="application/json" title="Hide your thoughts" href="http://blog.itshare.work/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Kubernetes"><link rel="canonical" href="http://blog.itshare.work/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/"><title>Kubernetes详细教程 - Kubernetes | Cookie = Hide your thoughts</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Kubernetes详细教程</h1><div class="meta"><span class="item" title="创建时间：2023-05-15 23:15:18"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-05-15T23:15:18+08:00">2023-05-15</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>121k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>1:50</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Cookie</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/12.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/24.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/25.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/20.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/26.jpg"></li><li class="item" data-background-image="http://oss.itshare.work/itshare-work-images/8.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Kubernetes/" itemprop="item" rel="index" title="分类于 Kubernetes"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://blog.itshare.work/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="yuan kun"><meta itemprop="description" content=", 解决各种服务器、网络、应用等技术问题，致力于保障系统稳定、高效运行"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hide your thoughts"></span><div class="body md" itemprop="articleBody"><h2 id="kubernetes详细教程"><a class="anchor" href="#kubernetes详细教程">#</a> Kubernetes 详细教程</h2><h3 id="1-kubernetes介绍"><a class="anchor" href="#1-kubernetes介绍">#</a> 1. Kubernetes 介绍</h3><h4 id="11-应用部署方式演变"><a class="anchor" href="#11-应用部署方式演变">#</a> 1.1 应用部署方式演变</h4><p>在部署应用程序的方式上，主要经历了三个时代：</p><ul><li><p><strong>传统部署</strong>：互联网早期，会直接将应用程序部署在物理机上</p><blockquote><p>优点：简单，不需要其它技术的参与</p><p>缺点：不能为应用程序定义资源使用边界，很难合理地分配计算资源，而且程序之间容易产生影响</p></blockquote></li><li><p><strong>虚拟化部署</strong>：可以在一台物理机上运行多个虚拟机，每个虚拟机都是独立的一个环境</p><blockquote><p>优点：程序环境不会相互产生影响，提供了一定程度的安全性</p><p>缺点：增加了操作系统，浪费了部分资源</p></blockquote></li><li><p><strong>容器化部署</strong>：与虚拟化类似，但是共享了操作系统</p><blockquote><p>优点：</p><p>可以保证每个容器拥有自己的文件系统、CPU、内存、进程空间等</p><p>运行应用程序所需要的资源都被容器包装，并和底层基础架构解耦</p><p>容器化的应用程序可以跨云服务商、跨 Linux 操作系统发行版进行部署</p></blockquote></li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200505183738289.png" alt="image-20200505183738289"></p><p>容器化部署方式给带来很多的便利，但是也会出现一些问题，比如说：</p><ul><li>一个容器故障停机了，怎么样让另外一个容器立刻启动去替补停机的容器</li><li>当并发访问量变大的时候，怎么样做到横向扩展容器数量</li></ul><p>这些容器管理的问题统称为<strong>容器编排</strong>问题，为了解决这些容器编排问题，就产生了一些容器编排的软件：</p><ul><li><strong>Swarm</strong>：Docker 自己的容器编排工具</li><li><strong>Mesos</strong>：Apache 的一个资源统一管控的工具，需要和 Marathon 结合使用</li><li><strong>Kubernetes</strong>：Google 开源的的容器编排工具</li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200524150339551.png" alt="image-20200524150339551"></p><h4 id="12-kubernetes简介"><a class="anchor" href="#12-kubernetes简介">#</a> 1.2 kubernetes 简介</h4><p><img data-src="http://oss.itshare.work/blog-images/image-20200406232838722.png" alt="image-20200406232838722"></p><p>kubernetes，是一个全新的基于容器技术的分布式架构领先方案，是谷歌严格保密十几年的秘密武器 ----Borg 系统的一个开源版本，于 2014 年 9 月发布第一个版本，2015 年 7 月发布第一个正式版本。</p><p>kubernetes 的本质是<strong>一组服务器集群</strong>，它可以在集群的每个节点上运行特定的程序，来对节点中的容器进行管理。目的是实现资源管理的自动化，主要提供了如下的主要功能：</p><ul><li><strong>自我修复</strong>：一旦某一个容器崩溃，能够在 1 秒中左右迅速启动新的容器</li><li><strong>弹性伸缩</strong>：可以根据需要，自动对集群中正在运行的容器数量进行调整</li><li><strong>服务发现</strong>：服务可以通过自动发现的形式找到它所依赖的服务</li><li><strong>负载均衡</strong>：如果一个服务起动了多个容器，能够自动实现请求的负载均衡</li><li><strong>版本回退</strong>：如果发现新发布的程序版本有问题，可以立即回退到原来的版本</li><li><strong>存储编排</strong>：可以根据容器自身的需求自动创建存储卷</li></ul><h4 id="13-kubernetes组件"><a class="anchor" href="#13-kubernetes组件">#</a> 1.3 kubernetes 组件</h4><p>一个 kubernetes 集群主要是由<strong>控制节点 (master)</strong>、** 工作节点 (node)** 构成，每个节点上都会安装不同的组件。</p><p><strong>master：集群的控制平面，负责集群的决策 (管理)</strong></p><blockquote><p><strong>ApiServer</strong> : 资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API 注册和发现等机制</p><p><strong>Scheduler</strong> : 负责集群资源调度，按照预定的调度策略将 Pod 调度到相应的 node 节点上</p><p><strong>ControllerManager</strong> : 负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等</p><p><strong>Etcd</strong> ：负责存储集群中各种资源对象的信息</p></blockquote><p><strong>node：集群的数据平面，负责为容器提供运行环境 (干活)</strong></p><blockquote><p><strong>Kubelet</strong> : 负责维护容器的生命周期，即通过控制 docker，来创建、更新、销毁容器</p><p><strong>KubeProxy</strong> : 负责提供集群内部的服务发现和负载均衡</p><p><strong>Docker</strong> : 负责节点上容器的各种操作</p></blockquote><p><img data-src="http://oss.itshare.work/blog-images/image-20200406184656917.png" alt="image-20200406184656917"></p><p>下面，以部署一个 nginx 服务来说明 kubernetes 系统各个组件调用关系：</p><ol><li><p>首先要明确，一旦 kubernetes 环境启动之后，master 和 node 都会将自身的信息存储到 etcd 数据库中</p></li><li><p>一个 nginx 服务的安装请求会首先被发送到 master 节点的 apiServer 组件</p></li><li><p>apiServer 组件会调用 scheduler 组件来决定到底应该把这个服务安装到哪个 node 节点上</p><p>在此时，它会从 etcd 中读取各个 node 节点的信息，然后按照一定的算法进行选择，并将结果告知 apiServer</p></li><li><p>apiServer 调用 controller-manager 去调度 Node 节点安装 nginx 服务</p></li><li><p>kubelet 接收到指令后，会通知 docker，然后由 docker 来启动一个 nginx 的 pod</p><p>pod 是 kubernetes 的最小操作单元，容器必须跑在 pod 中至此，</p></li><li><p>一个 nginx 服务就运行了，如果需要访问 nginx，就需要通过 kube-proxy 来对 pod 产生访问的代理</p></li></ol><p>这样，外界用户就可以访问集群中的 nginx 服务了</p><h4 id="14-kubernetes概念"><a class="anchor" href="#14-kubernetes概念">#</a> 1.4 kubernetes 概念</h4><p><strong>Master</strong>：集群控制节点，每个集群需要至少一个 master 节点负责集群的管控</p><p><strong>Node</strong>：工作负载节点，由 master 分配容器到这些 node 工作节点上，然后 node 节点上的 docker 负责容器的运行</p><p><strong>Pod</strong>：kubernetes 的最小控制单元，容器都是运行在 pod 中的，一个 pod 中可以有 1 个或者多个容器</p><p><strong>Controller</strong>：控制器，通过它来实现对 pod 的管理，比如启动 pod、停止 pod、伸缩 pod 的数量等等</p><p><strong>Service</strong>：pod 对外服务的统一入口，下面可以维护者同一类的多个 pod</p><p><strong>Label</strong>：标签，用于对 pod 进行分类，同一类 pod 会拥有相同的标签</p><p><strong>NameSpace</strong>：命名空间，用来隔离 pod 的运行环境</p><h3 id="2-kubernetes集群环境搭建"><a class="anchor" href="#2-kubernetes集群环境搭建">#</a> 2. kubernetes 集群环境搭建</h3><h4 id="21-前置知识点"><a class="anchor" href="#21-前置知识点">#</a> 2.1 前置知识点</h4><p>目前生产部署 Kubernetes 集群主要有两种方式：</p><p><strong>kubeadm</strong></p><p>Kubeadm 是一个 K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部署 Kubernetes 集群。</p><p>官方地址：<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvcmVmZXJlbmNlL3NldHVwLXRvb2xzL2t1YmVhZG0va3ViZWFkbS8=">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</span></p><p><strong>二进制包</strong></p><p>从 github 下载发行版的二进制包，手动部署每个组件，组成 Kubernetes 集群。</p><p>Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署 Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200404094800622.png" alt="image-20200404094800622"></p><h4 id="22-kubeadm-部署方式介绍"><a class="anchor" href="#22-kubeadm-部署方式介绍">#</a> 2.2 kubeadm 部署方式介绍</h4><p>kubeadm 是官方社区推出的一个用于快速部署 kubernetes 集群的工具，这个工具能通过两条指令完成一个 kubernetes 集群的部署：</p><ul><li>创建一个 Master 节点 kubeadm init</li><li>将 Node 节点加入到当前集群中 $ kubeadm join &lt;Master 节点的 IP 和端口&gt;</li></ul><h4 id="23-安装要求"><a class="anchor" href="#23-安装要求">#</a> 2.3 安装要求</h4><p>在开始之前，部署 Kubernetes 集群机器需要满足以下几个条件：</p><ul><li>一台或多台机器，操作系统 CentOS7.x-86_x64</li><li>硬件配置：2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多</li><li>集群中所有机器之间网络互通</li><li>可以访问外网，需要拉取镜像</li><li>禁止 swap 分区</li></ul><h4 id="24-最终目标"><a class="anchor" href="#24-最终目标">#</a> 2.4 最终目标</h4><ul><li>在所有节点上安装 Docker 和 kubeadm</li><li>部署 Kubernetes Master</li><li>部署容器网络插件</li><li>部署 Kubernetes Node，将节点加入 Kubernetes 集群中</li><li>部署 Dashboard Web 页面，可视化查看 Kubernetes 资源</li></ul><h4 id="25-准备环境"><a class="anchor" href="#25-准备环境">#</a> 2.5 准备环境</h4><p><img data-src="http://oss.itshare.work/blog-images/image-20210609000002940.png" alt="image-20210609000002940"></p><table><thead><tr><th style="text-align:left">角色</th><th style="text-align:left">IP 地址</th><th style="text-align:left">组件</th></tr></thead><tbody><tr><td style="text-align:left">master01</td><td style="text-align:left">192.168.90.100</td><td style="text-align:left">docker，kubectl，kubeadm，kubelet</td></tr><tr><td style="text-align:left">node01</td><td style="text-align:left">192.168.90.101</td><td style="text-align:left">docker，kubectl，kubeadm，kubelet</td></tr><tr><td style="text-align:left">node02</td><td style="text-align:left">192.168.90.102</td><td style="text-align:left">docker，kubectl，kubeadm，kubelet</td></tr></tbody></table><h4 id="26-环境初始化"><a class="anchor" href="#26-环境初始化">#</a> 2.6 环境初始化</h4><h5 id="261-检查操作系统的版本"><a class="anchor" href="#261-检查操作系统的版本">#</a> 2.6.1 检查操作系统的版本</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 此方式下安装 kubernetes 集群要求 Centos 版本要在 7.5 或之上</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># cat /etc/redhat-release</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Centos Linux 7<span class="token punctuation">.</span>5<span class="token punctuation">.</span>1804 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span></pre></td></tr></table></figure><h5 id="262-主机名解析"><a class="anchor" href="#262-主机名解析">#</a> 2.6.2 主机名解析</h5><p>为了方便集群节点间的直接调用，在这个配置一下主机名解析，企业中推荐使用内部 DNS 服务器</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 主机名成解析 编辑三台服务器的 /etc/hosts 文件，添加下面内容</span></pre></td></tr><tr><td data-num="2"></td><td><pre>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>90<span class="token punctuation">.</span>100 master</pre></td></tr><tr><td data-num="3"></td><td><pre>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>90<span class="token punctuation">.</span>101 node1</pre></td></tr><tr><td data-num="4"></td><td><pre>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>90<span class="token punctuation">.</span>102 node2</pre></td></tr></table></figure><h5 id="263-时间同步"><a class="anchor" href="#263-时间同步">#</a> 2.6.3 时间同步</h5><p>kubernetes 要求集群中的节点时间必须精确一直，这里使用 chronyd 服务从网络同步时间</p><p>企业中建议配置内部的会见同步服务器</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 启动 chronyd 服务</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl start chronyd</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl enable chronyd</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># date</span></pre></td></tr></table></figure><h5 id="264-禁用iptable和firewalld服务"><a class="anchor" href="#264-禁用iptable和firewalld服务">#</a> 2.6.4 禁用 iptable 和 firewalld 服务</h5><p>kubernetes 和 docker 在运行的中会产生大量的 iptables 规则，为了不让系统规则跟它们混淆，直接关闭系统的规则</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1 关闭 firewalld 服务</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 2 关闭 iptables 服务</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl stop iptables</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl disable iptables</span></pre></td></tr></table></figure><h5 id="265-禁用selinux"><a class="anchor" href="#265-禁用selinux">#</a> 2.6.5 禁用 selinux</h5><p>selinux 是 linux 系统下的一个安全服务，如果不关闭它，在安装集群中会产生各种各样的奇葩问题</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 编辑 /etc/selinux/config 文件，修改 SELINUX 的值为 disable</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 注意修改完毕之后需要重启 linux 服务</span></pre></td></tr><tr><td data-num="3"></td><td><pre>SELINUX=disabled</pre></td></tr></table></figure><h5 id="266-禁用swap分区"><a class="anchor" href="#266-禁用swap分区">#</a> 2.6.6 禁用 swap 分区</h5><p>swap 分区指的是虚拟内存分区，它的作用是物理内存使用完，之后将磁盘空间虚拟成内存来使用，启用 swap 设备会对系统的性能产生非常负面的影响，因此 kubernetes 要求每个节点都要禁用 swap 设备，但是如果因为某些原因确实不能关闭 swap 分区，就需要在集群安装过程中通过明确的参数进行配置说明</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 编辑分区配置文件 /etc/fstab，注释掉 swap 分区一行</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 注意修改完毕之后需要重启 linux 服务</span></pre></td></tr><tr><td data-num="3"></td><td><pre>vim <span class="token operator">/</span>etc/fstab</pre></td></tr><tr><td data-num="4"></td><td><pre>注释掉 <span class="token operator">/</span>dev/mapper/centos-swap swap</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># /dev/mapper/centos-swap swap</span></pre></td></tr></table></figure><h5 id="267-修改linux的内核参数"><a class="anchor" href="#267-修改linux的内核参数">#</a> 2.6.7 修改 linux 的内核参数</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 修改 linux 的内核采纳数，添加网桥过滤和地址转发功能</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 编辑 /etc/sysctl.d/kubernetes.conf 文件，添加如下配置：</span></pre></td></tr><tr><td data-num="3"></td><td><pre>net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge-nf-call-ip6tables = 1</pre></td></tr><tr><td data-num="4"></td><td><pre>net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge-nf-call-iptables = 1</pre></td></tr><tr><td data-num="5"></td><td><pre>net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ip_forward = 1</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 重新加载配置</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># sysctl -p</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 加载网桥过滤模块</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># modprobe br_netfilter</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 查看网桥过滤模块是否加载成功</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># lsmod | grep br_netfilter</span></pre></td></tr></table></figure><h5 id="268-配置ipvs功能"><a class="anchor" href="#268-配置ipvs功能">#</a> 2.6.8 配置 ipvs 功能</h5><p>在 Kubernetes 中 Service 有两种带来模型，一种是基于 iptables 的，一种是基于 ipvs 的两者比较的话，ipvs 的性能明显要高一些，但是如果要使用它，需要手动载入 ipvs 模块</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1. 安装 ipset 和 ipvsadm</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># yum install ipset ipvsadm -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 2. 添加需要加载的模块写入脚本文件</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># cat &lt;&lt;EOF> /etc/sysconfig/modules/ipvs.modules</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#!/bin/bash</span></pre></td></tr><tr><td data-num="6"></td><td><pre>modprobe <span class="token operator">--</span> ip_vs</pre></td></tr><tr><td data-num="7"></td><td><pre>modprobe <span class="token operator">--</span> ip_vs_rr</pre></td></tr><tr><td data-num="8"></td><td><pre>modprobe <span class="token operator">--</span> ip_vs_wrr</pre></td></tr><tr><td data-num="9"></td><td><pre>modprobe <span class="token operator">--</span> ip_vs_sh</pre></td></tr><tr><td data-num="10"></td><td><pre>modprobe <span class="token operator">--</span> nf_conntrack_ipv4</pre></td></tr><tr><td data-num="11"></td><td><pre>EOF</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 3. 为脚本添加执行权限</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># chmod +x /etc/sysconfig/modules/ipvs.modules</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 4. 执行脚本文件</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># /bin/bash /etc/sysconfig/modules/ipvs.modules</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 5. 查看对应的模块是否加载成功</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span></pre></td></tr></table></figure><h5 id="269-安装docker"><a class="anchor" href="#269-安装docker">#</a> 2.6.9 安装 docker</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1、切换镜像源</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 2、查看当前镜像源中支持的 docker 版本</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># yum list docker-ce --showduplicates</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 3、安装特定版本的 docker-ce</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 必须制定 --setopt=obsoletes=0，否则 yum 会自动安装更高版本</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># yum install --setopt=obsoletes=0 docker-ce-18.06.3.ce-3.el7 -y</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 4、添加一个配置文件</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#Docker 在默认情况下使用 Vgroup Driver 为 cgroupfs，而 Kubernetes 推荐使用 systemd 来替代 cgroupfs</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># mkdir /etc/docker</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># cat &lt;&lt;EOF> /etc/docker/daemon.json</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token string">"exec-opts"</span>: <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token string">"registry-mirrors"</span>: <span class="token punctuation">[</span><span class="token string">"https://kn0t2bca.mirror.aliyuncs.com"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>EOF</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 5、启动 dokcer</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl restart docker</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl enable docker</span></pre></td></tr></table></figure><h5 id="2610-安装kubernetes组件"><a class="anchor" href="#2610-安装kubernetes组件">#</a> 2.6.10 安装 Kubernetes 组件</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1、由于 kubernetes 的镜像在国外，速度比较慢，这里切换成国内的镜像源</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 2、编辑 /etc/yum.repos.d/kubernetes.repo, 添加下面的配置</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token namespace">[kubernetes]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>name=Kubernetes</pre></td></tr><tr><td data-num="5"></td><td><pre>baseurl=http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com/kubernetes/yum/repos/kubernetes-el7-x86_64</pre></td></tr><tr><td data-num="6"></td><td><pre>enabled=1</pre></td></tr><tr><td data-num="7"></td><td><pre>gpgchech=0</pre></td></tr><tr><td data-num="8"></td><td><pre>repo_gpgcheck=0</pre></td></tr><tr><td data-num="9"></td><td><pre>gpgkey=http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com/kubernetes/yum/doc/yum-key<span class="token punctuation">.</span>gpg</pre></td></tr><tr><td data-num="10"></td><td><pre>			http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com/kubernetes/yum/doc/rpm-package-key<span class="token punctuation">.</span>gpg</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 3、安装 kubeadm、kubelet 和 kubectl</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># yum install --setopt=obsoletes=0 kubeadm-1.17.4-0 kubelet-1.17.4-0 kubectl-1.17.4-0 -y</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 4、配置 kubelet 的 cgroup</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#编辑 /etc/sysconfig/kubelet, 添加下面的配置</span></pre></td></tr><tr><td data-num="17"></td><td><pre>KUBELET_CGROUP_ARGS=<span class="token string">"--cgroup-driver=systemd"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>KUBE_PROXY_MODE=<span class="token string">"ipvs"</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 5、设置 kubelet 开机自启</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl enable kubelet</span></pre></td></tr></table></figure><h5 id="2611-准备集群镜像"><a class="anchor" href="#2611-准备集群镜像">#</a> 2.6.11 准备集群镜像</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在安装 kubernetes 集群之前，必须要提前准备好集群需要的镜像，所需镜像可以通过下面命令查看</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubeadm config images list</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 下载镜像</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 此镜像 kubernetes 的仓库中，由于网络原因，无法连接，下面提供了一种替换方案</span></pre></td></tr><tr><td data-num="6"></td><td><pre>images=<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	kube-apiserver:v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4</pre></td></tr><tr><td data-num="8"></td><td><pre>	kube-controller-manager:v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4</pre></td></tr><tr><td data-num="9"></td><td><pre>	kube-scheduler:v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4</pre></td></tr><tr><td data-num="10"></td><td><pre>	kube-proxy:v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4</pre></td></tr><tr><td data-num="11"></td><td><pre>	pause:3<span class="token punctuation">.</span>1</pre></td></tr><tr><td data-num="12"></td><td><pre>	etcd:3<span class="token punctuation">.</span>4<span class="token punctuation">.</span>3-0</pre></td></tr><tr><td data-num="13"></td><td><pre>	coredns:1<span class="token punctuation">.</span>6<span class="token punctuation">.</span>5</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">for</span> imageName in $<span class="token punctuation">&#123;</span>images<span class="token punctuation">[</span>@<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">do</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	docker pull registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$imageName</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	docker tag registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$imageName</span> k8s<span class="token punctuation">.</span>gcr<span class="token punctuation">.</span>io/<span class="token variable">$imageName</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	docker rmi registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$imageName</span> </pre></td></tr><tr><td data-num="20"></td><td><pre>done</pre></td></tr></table></figure><h5 id="2611-集群初始化"><a class="anchor" href="#2611-集群初始化">#</a> 2.6.11 集群初始化</h5><blockquote><p>下面的操作只需要在 master 节点上执行即可</p></blockquote><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建集群</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubeadm init \</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token operator">--</span>apiserver-advertise-address=192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>90<span class="token punctuation">.</span>100 \</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token operator">--</span>image-repository registry<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/google_containers \</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token operator">--</span>kubernetes-version=v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4 \</pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token operator">--</span>service-cidr=10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/12 \</pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token operator">--</span>pod-network-cidr=10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/16</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 创建必要文件</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># mkdir -p $HOME/.kube</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></pre></td></tr></table></figure><blockquote><p>下面的操作只需要在 node 节点上执行即可</p></blockquote><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>kubeadm join 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>100:6443 <span class="token operator">--</span>token awk15p<span class="token punctuation">.</span>t6bamck54w69u4s8 \</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token operator">--</span>discovery-token-ca-cert-hash sha256:a94fa09562466d32d29523ab6cff122186f1127599fa4dcd5fa0152694f17117</pre></td></tr></table></figure><p>在 master 上查看节点信息</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get nodes</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME    STATUS   ROLES     AGE   VERSION</pre></td></tr><tr><td data-num="3"></td><td><pre>master  NotReady  master   6m    v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4</pre></td></tr><tr><td data-num="4"></td><td><pre>node1   NotReady   &lt;none>  22s   v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4</pre></td></tr><tr><td data-num="5"></td><td><pre>node2   NotReady   &lt;none>  19s   v1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>4</pre></td></tr></table></figure><h5 id="2613-安装网络插件只在master节点操作即可"><a class="anchor" href="#2613-安装网络插件只在master节点操作即可">#</a> 2.6.13 安装网络插件，只在 master 节点操作即可</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com/coreos/flannel/master/Documentation/kube-flannel<span class="token punctuation">.</span>yml</pre></td></tr></table></figure><p>由于外网不好访问，如果出现无法访问的情况，可以直接用下面的 记得文件名是 kube-flannel.yml，位置：/root/kube-flannel.yml 内容：</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/flannel-io/flannel/tree/master/Documentation/kube-flannel<span class="token punctuation">.</span>yml</pre></td></tr></table></figure><p>也可手动拉取指定版本<br>docker pull <span class="exturl" data-url="aHR0cDovL3F1YXkuaW8vY29yZW9zL2ZsYW5uZWw6djAuMTQuMA==">quay.io/coreos/flannel:v0.14.0</span> #拉取 flannel 网络，三台主机<br>docker images #查看仓库是否拉去下来</p><p><code>个人笔记</code><br>若是集群状态一直是 notready, 用下面语句查看原因，<br>journalctl -f -u kubelet.service<br>若原因是： cni.go:237] Unable to update cni config: no networks found in /etc/cni/net.d<br>mkdir -p /etc/cni/net.d #创建目录给 flannel 做配置文件<br>vim /etc/cni/net.d/10-flannel.conf #编写配置文件</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token string">"name"</span>:<span class="token string">"cbr0"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token string">"cniVersion"</span>:<span class="token string">"0.3.1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token string">"type"</span>:<span class="token string">"flannel"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token string">"deledate"</span>:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token string">"hairpinMode"</span>:true<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token string">"isDefaultGateway"</span>:true</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2614-使用kubeadm-reset重置集群"><a class="anchor" href="#2614-使用kubeadm-reset重置集群">#</a> 2.6.14 使用 kubeadm reset 重置集群</h5><pre><code>#在master节点之外的节点进行操作
kubeadm reset
systemctl stop kubelet
systemctl stop docker
rm -rf /var/lib/cni/
rm -rf /var/lib/kubelet/*
rm -rf /etc/cni/
ifconfig cni0 down
ifconfig flannel.1 down
ifconfig docker0 down
ip link delete cni0
ip link delete flannel.1
##重启kubelet
systemctl restart kubelet
##重启docker
systemctl restart docker
</code></pre><h5 id="2615-重启kubelet和docker"><a class="anchor" href="#2615-重启kubelet和docker">#</a> 2.6.15 重启 kubelet 和 docker</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 重启 kubelet</span></pre></td></tr><tr><td data-num="2"></td><td><pre>systemctl restart kubelet</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 重启 docker</span></pre></td></tr><tr><td data-num="4"></td><td><pre>systemctl restart docker</pre></td></tr></table></figure><p>使用配置文件启动 fannel</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl apply <span class="token operator">-</span>f kube-flannel<span class="token punctuation">.</span>yml</pre></td></tr></table></figure><p>等待它安装完毕 发现已经是 集群的状态已经是 Ready</p><p><img data-src="http://oss.itshare.work/blog-images/2232696-20210621233106024-1676033717.png" alt="img"></p><h5 id="2616-kubeadm中的命令"><a class="anchor" href="#2616-kubeadm中的命令">#</a> 2.6.16 kubeadm 中的命令</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 生成 新的 token</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubeadm token create --print-join-command</span></pre></td></tr></table></figure><h4 id="27-集群测试"><a class="anchor" href="#27-集群测试">#</a> 2.7 集群测试</h4><h5 id="271-创建一个nginx服务"><a class="anchor" href="#271-创建一个nginx服务">#</a> 2.7.1 创建一个 nginx 服务</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl create deployment nginx  <span class="token operator">--</span>image=nginx:1<span class="token punctuation">.</span>14-alpine</pre></td></tr></table></figure><h5 id="272-暴露端口"><a class="anchor" href="#272-暴露端口">#</a> 2.7.2 暴露端口</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl expose deploy nginx  <span class="token operator">--</span>port=80 <span class="token operator">--</span>target-port=80  <span class="token operator">--</span><span class="token function">type</span>=NodePort</pre></td></tr></table></figure><h5 id="273-查看服务"><a class="anchor" href="#273-查看服务">#</a> 2.7.3 查看服务</h5><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl get pod<span class="token punctuation">,</span>svc</pre></td></tr></table></figure><h5 id="274-查看pod"><a class="anchor" href="#274-查看pod">#</a> 2.7.4 查看 pod</h5><p><img data-src="http://oss.itshare.work/blog-images/2232696-20210621233130477-111035427.png" alt="img"></p><p>浏览器测试结果：</p><p><img data-src="http://oss.itshare.work/blog-images/2232696-20210621233157075-1117518703.png" alt="img"></p><h3 id="3-资源管理"><a class="anchor" href="#3-资源管理">#</a> 3. 资源管理</h3><h4 id="31-资源管理介绍"><a class="anchor" href="#31-资源管理介绍">#</a> 3.1 资源管理介绍</h4><p>在 kubernetes 中，所有的内容都抽象为资源，用户需要通过操作资源来管理 kubernetes。</p><blockquote><p>kubernetes 的本质上就是一个集群系统，用户可以在集群中部署各种服务，所谓的部署服务，其实就是在 kubernetes 集群中运行一个个的容器，并将指定的程序跑在容器中。</p><p>kubernetes 的最小管理单元是 pod 而不是容器，所以只能将容器放在 <code>Pod</code> 中，而 kubernetes 一般也不会直接管理 Pod，而是通过 <code>Pod控制器</code> 来管理 Pod 的。</p><p>Pod 可以提供服务之后，就要考虑如何访问 Pod 中服务，kubernetes 提供了 <code>Service</code> 资源实现这个功能。</p><p>当然，如果 Pod 中程序的数据需要持久化，kubernetes 还提供了各种 <code>存储</code> 系统。</p></blockquote><p><img data-src="http://oss.itshare.work/blog-images/image-20200406225334627.png" alt="image-20200406225334627"></p><blockquote><p>学习 kubernetes 的核心，就是学习如何对集群上的 <code>Pod、Pod控制器、Service、存储</code> 等各种资源进行操作</p></blockquote><h4 id="32-yaml语言介绍"><a class="anchor" href="#32-yaml语言介绍">#</a> 3.2 YAML 语言介绍</h4><p>YAML 是一个类似 XML、JSON 的标记性语言。它强调以<strong>数据</strong>为中心，并不是以标识语言为重点。因而 YAML 本身的定义比较简单，号称 &quot;一种人性化的数据格式语言&quot;。</p><pre><code>&lt;heima&gt;
    &lt;age&gt;15&lt;/age&gt;
    &lt;address&gt;Beijing&lt;/address&gt;
&lt;/heima&gt;
</code></pre><pre><code>heima:
  age: 15
  address: Beijing
</code></pre><p>YAML 的语法比较简单，主要有下面几个：</p><ul><li>大小写敏感</li><li>使用缩进表示层级关系</li><li>缩进不允许使用 tab，只允许空格 (低版本限制)</li><li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li><li>'#' 表示注释</li></ul><p>YAML 支持以下几种数据类型：</p><ul><li>纯量：单个的、不可再分的值</li><li>对象：键值对的集合，又称为映射（mapping）/ 哈希（hash） / 字典（dictionary）</li><li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li></ul><figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 纯量，就是指的一个简单的值，字符串、布尔值、整数、浮点数、Null、时间、日期</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 1 布尔类型</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">c1</span><span class="token punctuation">:</span> true (或者True)</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 2 整型</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">c2</span><span class="token punctuation">:</span> <span class="token number">234</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 3 浮点型</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">c3</span><span class="token punctuation">:</span> <span class="token number">3.14</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 4 null 类型 </span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">c4</span><span class="token punctuation">:</span> <span class="token null important">~</span>  <span class="token comment"># 使用～表示 null</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 5 日期类型</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">c5</span><span class="token punctuation">:</span> <span class="token datetime number">2018-02-17</span>    <span class="token comment"># 日期必须使用 ISO 8601 格式，即 yyyy-MM-dd</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 6 时间类型</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">c6</span><span class="token punctuation">:</span> <span class="token datetime number">2018-02-17T15:02:31+08:00</span>  <span class="token comment"># 时间使用 ISO 8601 格式，时间和日期之间使用 T 连接，最后使用 + 代表时区</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 7 字符串类型</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">c7</span><span class="token punctuation">:</span> heima     <span class="token comment"># 简单写法，直接写值，如果字符串中间有特殊字符，必须使用双引号或者单引号包裹 </span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">c8</span><span class="token punctuation">:</span> line1</pre></td></tr><tr><td data-num="17"></td><td><pre>    line2     <span class="token comment"># 字符串过多的情况可以拆成多行，每一行会被转化成一个空格</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 对象</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 形式一 (推荐):</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">heima</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">15</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">address</span><span class="token punctuation">:</span> Beijing</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 形式二 (了解):</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">heima</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span><span class="token key atrule">address</span><span class="token punctuation">:</span> Beijing<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 数组</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 形式一 (推荐):</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">address</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">-</span> 顺义</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">-</span> 昌平  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 形式二 (了解):</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>顺义<span class="token punctuation">,</span>昌平<span class="token punctuation">]</span></pre></td></tr></table></figure><blockquote><p>小提示：</p><p>1 书写 yaml 切记 <code>:</code> 后面要加一个空格</p><p>2 如果需要将多段 yaml 配置放在一个文件中，中间要使用 <code>---</code> 分隔</p><p>3 下面是一个 yaml 转 json 的网站，可以通过它验证 yaml 是否书写正确</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuanNvbjJ5YW1sLmNvbS9jb252ZXJ0LXlhbWwtdG8tanNvbg==">https://www.json2yaml.com/convert-yaml-to-json</span></p></blockquote><h4 id="33-资源管理方式"><a class="anchor" href="#33-资源管理方式">#</a> 3.3 资源管理方式</h4><ul><li><p>命令式对象管理：直接使用命令去操作 kubernetes 资源</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl run nginx-pod <span class="token operator">--</span>image=nginx:1<span class="token punctuation">.</span>17<span class="token punctuation">.</span>1 <span class="token operator">--</span>port=80</pre></td></tr></table></figure></li><li><p>命令式对象配置：通过命令配置和配置文件去操作 kubernetes 资源</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl create/patch <span class="token operator">-</span>f nginx-pod<span class="token punctuation">.</span>yaml</pre></td></tr></table></figure></li><li><p>声明式对象配置：通过 apply 命令和配置文件去操作 kubernetes 资源</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl apply <span class="token operator">-</span>f nginx-pod<span class="token punctuation">.</span>yaml</pre></td></tr></table></figure></li></ul><table><thead><tr><th style="text-align:left">类型</th><th style="text-align:left">操作对象</th><th style="text-align:left">适用环境</th><th style="text-align:left">优点</th><th style="text-align:left">缺点</th></tr></thead><tbody><tr><td style="text-align:left">命令式对象管理</td><td style="text-align:left">对象</td><td style="text-align:left">测试</td><td style="text-align:left">简单</td><td style="text-align:left">只能操作活动对象，无法审计、跟踪</td></tr><tr><td style="text-align:left">命令式对象配置</td><td style="text-align:left">文件</td><td style="text-align:left">开发</td><td style="text-align:left">可以审计、跟踪</td><td style="text-align:left">项目大时，配置文件多，操作麻烦</td></tr><tr><td style="text-align:left">声明式对象配置</td><td style="text-align:left">目录</td><td style="text-align:left">开发</td><td style="text-align:left">支持目录操作</td><td style="text-align:left">意外情况下难以调试</td></tr></tbody></table><h5 id="331-命令式对象管理"><a class="anchor" href="#331-命令式对象管理">#</a> 3.3.1 命令式对象管理</h5><p><strong>kubectl 命令</strong></p><p>kubectl 是 kubernetes 集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。kubectl 命令的语法如下：</p><pre><code>kubectl [command] [type] [name] [flags]
</code></pre><p><strong>comand</strong>：指定要对资源执行的操作，例如 create、get、delete</p><p><strong>type</strong>：指定资源类型，比如 deployment、pod、service</p><p><strong>name</strong>：指定资源的名称，名称大小写敏感</p><p><strong>flags</strong>：指定额外的可选参数</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看所有 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl get pod </pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查看某个 pod</span></pre></td></tr><tr><td data-num="5"></td><td><pre>kubectl get pod pod_name</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 查看某个 pod, 以 yaml 格式展示结果</span></pre></td></tr><tr><td data-num="8"></td><td><pre>kubectl get pod pod_name <span class="token parameter variable">-o</span> yaml</pre></td></tr></table></figure><p><strong>资源类型</strong></p><p>kubernetes 中所有的内容都抽象为资源，可以通过下面的命令进行查看:</p><pre><code>kubectl api-resources
</code></pre><p>经常使用的资源有下面这些：</p><table><thead><tr><th style="text-align:left">资源分类</th><th style="text-align:left">资源名称</th><th style="text-align:left">缩写</th><th style="text-align:left">资源作用</th></tr></thead><tbody><tr><td style="text-align:left">集群级别资源</td><td style="text-align:left">nodes</td><td style="text-align:left">no</td><td style="text-align:left">集群组成部分</td></tr><tr><td style="text-align:left">namespaces</td><td style="text-align:left">ns</td><td style="text-align:left">隔离 Pod</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">pod 资源</td><td style="text-align:left">pods</td><td style="text-align:left">po</td><td style="text-align:left">装载容器</td></tr><tr><td style="text-align:left">pod 资源控制器</td><td style="text-align:left">replicationcontrollers</td><td style="text-align:left">rc</td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">replicasets</td><td style="text-align:left">rs</td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">deployments</td><td style="text-align:left">deploy</td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">daemonsets</td><td style="text-align:left">ds</td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">jobs</td><td style="text-align:left"></td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">cronjobs</td><td style="text-align:left">cj</td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">horizontalpodautoscalers</td><td style="text-align:left">hpa</td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">statefulsets</td><td style="text-align:left">sts</td><td style="text-align:left">控制 pod 资源</td></tr><tr><td style="text-align:left">服务发现资源</td><td style="text-align:left">services</td><td style="text-align:left">svc</td><td style="text-align:left">统一 pod 对外接口</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">ingress</td><td style="text-align:left">ing</td><td style="text-align:left">统一 pod 对外接口</td></tr><tr><td style="text-align:left">存储资源</td><td style="text-align:left">volumeattachments</td><td style="text-align:left"></td><td style="text-align:left">存储</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">persistentvolumes</td><td style="text-align:left">pv</td><td style="text-align:left">存储</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">persistentvolumeclaims</td><td style="text-align:left">pvc</td><td style="text-align:left">存储</td></tr><tr><td style="text-align:left">配置资源</td><td style="text-align:left">configmaps</td><td style="text-align:left">cm</td><td style="text-align:left">配置</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">secrets</td><td style="text-align:left"></td><td style="text-align:left">配置</td></tr></tbody></table><p><strong>操作</strong></p><p>kubernetes 允许对资源进行多种操作，可以通过 --help 查看详细的操作命令</p><pre><code>kubectl --help
</code></pre><p>经常使用的操作有下面这些：</p><table><thead><tr><th style="text-align:left">命令分类</th><th style="text-align:left">命令</th><th style="text-align:left">翻译</th><th style="text-align:left">命令作用</th></tr></thead><tbody><tr><td style="text-align:left">基本命令</td><td style="text-align:left">create</td><td style="text-align:left">创建</td><td style="text-align:left">创建一个资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">edit</td><td style="text-align:left">编辑</td><td style="text-align:left">编辑一个资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">get</td><td style="text-align:left">获取</td><td style="text-align:left">获取一个资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">patch</td><td style="text-align:left">更新</td><td style="text-align:left">更新一个资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">delete</td><td style="text-align:left">删除</td><td style="text-align:left">删除一个资源</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">explain</td><td style="text-align:left">解释</td><td style="text-align:left">展示资源文档</td></tr><tr><td style="text-align:left">运行和调试</td><td style="text-align:left">run</td><td style="text-align:left">运行</td><td style="text-align:left">在集群中运行一个指定的镜像</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">expose</td><td style="text-align:left">暴露</td><td style="text-align:left">暴露资源为 Service</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">describe</td><td style="text-align:left">描述</td><td style="text-align:left">显示资源内部信息</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">logs</td><td style="text-align:left">日志输出容器在 pod 中的日志</td><td style="text-align:left">输出容器在 pod 中的日志</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">attach</td><td style="text-align:left">缠绕进入运行中的容器</td><td style="text-align:left">进入运行中的容器</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">exec</td><td style="text-align:left">执行容器中的一个命令</td><td style="text-align:left">执行容器中的一个命令</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">cp</td><td style="text-align:left">复制</td><td style="text-align:left">在 Pod 内外复制文件</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">rollout</td><td style="text-align:left">首次展示</td><td style="text-align:left">管理资源的发布</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">scale</td><td style="text-align:left">规模</td><td style="text-align:left">扩 (缩) 容 Pod 的数量</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">autoscale</td><td style="text-align:left">自动调整</td><td style="text-align:left">自动调整 Pod 的数量</td></tr><tr><td style="text-align:left">高级命令</td><td style="text-align:left">apply</td><td style="text-align:left">rc</td><td style="text-align:left">通过文件对资源进行配置</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">label</td><td style="text-align:left">标签</td><td style="text-align:left">更新资源上的标签</td></tr><tr><td style="text-align:left">其他命令</td><td style="text-align:left">cluster-info</td><td style="text-align:left">集群信息</td><td style="text-align:left">显示集群信息</td></tr><tr><td style="text-align:left"></td><td style="text-align:left">version</td><td style="text-align:left">版本</td><td style="text-align:left">显示当前 Server 和 Client 的版本</td></tr></tbody></table><p>下面以一个 namespace /pod 的创建和删除简单演示下命令的使用：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建一个 namespace</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create namespace dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>namespace/dev created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 获取 namespace</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME              STATUS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>default           Active   21h</pre></td></tr><tr><td data-num="9"></td><td><pre>dev               Active   21s</pre></td></tr><tr><td data-num="10"></td><td><pre>kube-node-lease   Active   21h</pre></td></tr><tr><td data-num="11"></td><td><pre>kube-public       Active   21h</pre></td></tr><tr><td data-num="12"></td><td><pre>kube-system       Active   21h</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 在此 namespace 下创建并运行一个 nginx 的 Pod</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run pod --image=nginx:latest -n dev</span></pre></td></tr><tr><td data-num="16"></td><td><pre>kubectl run <span class="token parameter variable">--generator</span><span class="token operator">=</span>deployment/apps.v1 is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl run <span class="token parameter variable">--generator</span><span class="token operator">=</span>run-pod/v1 or kubectl create instead.</pre></td></tr><tr><td data-num="17"></td><td><pre>deployment.apps/pod created</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 查看新创建的 pod</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev</span></pre></td></tr><tr><td data-num="21"></td><td><pre>NAME  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="22"></td><td><pre>pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># 删除指定的 pod</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod pod-864f9875b9-pcw7x</span></pre></td></tr><tr><td data-num="26"></td><td><pre>pod <span class="token string">"pod"</span> deleted</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 删除指定的 namespace</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete ns dev</span></pre></td></tr><tr><td data-num="30"></td><td><pre>namespace <span class="token string">"dev"</span> deleted</pre></td></tr></table></figure><h5 id="332-命令式对象配置"><a class="anchor" href="#332-命令式对象配置">#</a> 3.3.2 命令式对象配置</h5><p>命令式对象配置就是使用命令配合配置文件一起来操作 kubernetes 资源。</p><p>1） 创建一个 nginxpod.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxpod</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>containers</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest</pre></td></tr></table></figure><p>2）执行 create 命令，创建资源：</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f nginxpod.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>namespace/dev created</pre></td></tr><tr><td data-num="3"></td><td><pre>pod/nginxpod created</pre></td></tr></table></figure><p>此时发现创建了两个资源对象，分别是 namespace 和 pod</p><p>3）执行 get 命令，查看资源：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get -f nginxpod.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME            STATUS   AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>namespace/dev   Active   18s</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="6"></td><td><pre>pod/nginxpod    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17s</pre></td></tr></table></figure><p>这样就显示了两个资源对象的信息</p><p>4）执行 delete 命令，删除资源：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f nginxpod.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>namespace <span class="token string">"dev"</span> deleted</pre></td></tr><tr><td data-num="3"></td><td><pre>pod <span class="token string">"nginxpod"</span> deleted</pre></td></tr></table></figure><p>此时发现两个资源对象被删除了</p><pre><code>总结:
    命令式对象配置的方式操作资源，可以简单的认为：命令  +  yaml配置文件（里面是命令需要的各种参数）
</code></pre><h5 id="333-声明式对象配置"><a class="anchor" href="#333-声明式对象配置">#</a> 3.3.3 声明式对象配置</h5><p>声明式对象配置跟命令式对象配置很相似，但是它只有一个命令 apply。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 首先执行一次 kubectl apply -f yaml 文件，发现创建了资源</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f nginxpod.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>namespace/dev created</pre></td></tr><tr><td data-num="4"></td><td><pre>pod/nginxpod created</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 再次执行一次 kubectl apply -f yaml 文件，发现说资源没有变动</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f nginxpod.yaml</span></pre></td></tr><tr><td data-num="8"></td><td><pre>namespace/dev unchanged</pre></td></tr><tr><td data-num="9"></td><td><pre>pod/nginxpod unchanged</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>总结:</pre></td></tr><tr><td data-num="2"></td><td><pre>    其实声明式对象配置就是使用apply描述一个资源最终的状态（在yaml中定义状态）</pre></td></tr><tr><td data-num="3"></td><td><pre>    使用apply操作资源：</pre></td></tr><tr><td data-num="4"></td><td><pre>        如果资源不存在，就创建，相当于 kubectl create</pre></td></tr><tr><td data-num="5"></td><td><pre>        如果资源已存在，就更新，相当于 kubectl patch</pre></td></tr></table></figure><blockquote><p>扩展：kubectl 可以在 node 节点上运行吗？</p></blockquote><p>kubectl 的运行是需要进行配置的，它的配置文件是 $HOME/.kube，如果想要在 node 节点运行此命令，需要将 master 上的.kube 文件复制到 node 节点上，即在 master 节点上执行下面操作：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">scp</span>  <span class="token parameter variable">-r</span>  <span class="token environment constant">HOME</span>/.kube   node1: <span class="token environment constant">HOME</span>/</pre></td></tr></table></figure><blockquote><p>使用推荐：三种方式应该怎么用？</p></blockquote><p>创建 / 更新资源 使用声明式对象配置 kubectl apply -f XXX.yaml</p><p>删除资源 使用命令式对象配置 kubectl delete -f XXX.yaml</p><p>查询资源 使用命令式对象管理 kubectl get (describe) 资源名称</p><h3 id="4-实战入门"><a class="anchor" href="#4-实战入门">#</a> 4. 实战入门</h3><p>本章节将介绍如何在 kubernetes 集群中部署一个 nginx 服务，并且能够对其进行访问。</p><h4 id="41-namespace"><a class="anchor" href="#41-namespace">#</a> 4.1 Namespace</h4><p>Namespace 是 kubernetes 系统中的一种非常重要资源，它的主要作用是用来实现<strong>多套环境的资源隔离</strong>或者<strong>多租户的资源隔离</strong>。</p><p>默认情况下，kubernetes 集群中的所有的 Pod 都是可以相互访问的。但是在实际中，可能不想让两个 Pod 之间进行互相的访问，那此时就可以将两个 Pod 划分到不同的 namespace 下。kubernetes 通过将集群内部的资源分配到不同的 Namespace 中，可以形成逻辑上的 &quot;组&quot;，以方便不同的组的资源进行隔离使用和管理。</p><p>可以通过 kubernetes 的授权机制，将不同的 namespace 交给不同租户进行管理，这样就实现了多租户的资源隔离。此时还能结合 kubernetes 的资源配额机制，限定不同租户能占用的资源，例如 CPU 使用量、内存使用量等等，来实现租户可用资源的管理。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200407100850484.png" alt="image-20200407100850484"></p><p>kubernetes 在集群启动之后，会默认创建几个 namespace</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get namespace</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME              STATUS   AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>default           Active   45h     <span class="token comment">#  所有未指定 Namespace 的对象都会被分配在 default 命名空间</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kube-node-lease   Active   45h     <span class="token comment">#  集群节点之间的心跳维护，v1.13 开始引入</span></pre></td></tr><tr><td data-num="5"></td><td><pre>kube-public       Active   45h     <span class="token comment">#  此命名空间下的资源可以被所有人访问（包括未认证用户）</span></pre></td></tr><tr><td data-num="6"></td><td><pre>kube-system       Active   45h     <span class="token comment">#  所有由 Kubernetes 系统创建的资源都处于这个命名空间</span></pre></td></tr></table></figure><p>下面来看 namespace 资源的具体操作：</p><h5 id="411-查看"><a class="anchor" href="#411-查看">#</a> 4.1.1 <strong>查看</strong></h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1 查看所有的 ns  命令：kubectl get ns</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns</span></pre></td></tr><tr><td data-num="3"></td><td><pre>NAME              STATUS   AGE</pre></td></tr><tr><td data-num="4"></td><td><pre>default           Active   45h</pre></td></tr><tr><td data-num="5"></td><td><pre>kube-node-lease   Active   45h</pre></td></tr><tr><td data-num="6"></td><td><pre>kube-public       Active   45h     </pre></td></tr><tr><td data-num="7"></td><td><pre>kube-system       Active   45h     </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 2 查看指定的 ns   命令：kubectl get ns ns 名称</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns default</span></pre></td></tr><tr><td data-num="11"></td><td><pre>NAME      STATUS   AGE</pre></td></tr><tr><td data-num="12"></td><td><pre>default   Active   45h</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 3 指定输出格式  命令：kubectl get ns ns 名称  -o 格式参数</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># kubernetes 支持的格式有很多，比较常见的是 wide、json、yaml</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns default -o yaml</span></pre></td></tr><tr><td data-num="17"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="18"></td><td><pre>kind: Namespace</pre></td></tr><tr><td data-num="19"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="20"></td><td><pre>  creationTimestamp: <span class="token string">"2021-05-08T04:44:16Z"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  name: default</pre></td></tr><tr><td data-num="22"></td><td><pre>  resourceVersion: <span class="token string">"151"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  selfLink: /api/v1/namespaces/default</pre></td></tr><tr><td data-num="24"></td><td><pre>  uid: 7405f73a-e486-43d4-9db6-145f1409f090</pre></td></tr><tr><td data-num="25"></td><td><pre>spec:</pre></td></tr><tr><td data-num="26"></td><td><pre>  finalizers:</pre></td></tr><tr><td data-num="27"></td><td><pre>  - kubernetes</pre></td></tr><tr><td data-num="28"></td><td><pre>status:</pre></td></tr><tr><td data-num="29"></td><td><pre>  phase: Active</pre></td></tr><tr><td data-num="30"></td><td><pre>  </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># 4 查看 ns 详情  命令：kubectl describe ns ns 名称</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ns default</span></pre></td></tr><tr><td data-num="33"></td><td><pre>Name:         default</pre></td></tr><tr><td data-num="34"></td><td><pre>Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="36"></td><td><pre>Status:       Active  <span class="token comment"># Active 命名空间正在使用中  Terminating 正在删除命名空间</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># ResourceQuota 针对 namespace 做的资源限制</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># LimitRange 针对 namespace 中的每个组件做的资源限制</span></pre></td></tr><tr><td data-num="40"></td><td><pre>No resource quota.</pre></td></tr><tr><td data-num="41"></td><td><pre>No LimitRange resource.</pre></td></tr></table></figure><h5 id="412-创建"><a class="anchor" href="#412-创建">#</a> 4.1.2 <strong>创建</strong></h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 namespace</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create ns dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>namespace/dev created</pre></td></tr></table></figure><h5 id="413-删除"><a class="anchor" href="#413-删除">#</a> 4.1.3 <strong>删除</strong></h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 删除 namespace</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete ns dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>namespace <span class="token string">"dev"</span> deleted</pre></td></tr></table></figure><h5 id="414-配置方式"><a class="anchor" href="#414-配置方式">#</a> 4.1.4 <strong>配置方式</strong></h5><p>首先准备一个 yaml 文件：ns-dev.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f ns-dev.yaml</p><p>删除：kubectl delete -f ns-dev.yaml</p><h4 id="42-pod"><a class="anchor" href="#42-pod">#</a> 4.2 Pod</h4><p>Pod 是 kubernetes 集群进行管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于 Pod 中。</p><p>Pod 可以认为是容器的封装，一个 Pod 中可以存在一个或者多个容器。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200407121501907.png" alt="image-20200407121501907"></p><p>kubernetes 在集群启动之后，集群中的各个组件也都是以 Pod 方式运行的。可以通过下面命令查看：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>kube-system   coredns-6955765f44-68g6v         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="4"></td><td><pre>kube-system   coredns-6955765f44-cs5r8         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="5"></td><td><pre>kube-system   etcd-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="6"></td><td><pre>kube-system   kube-apiserver-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="7"></td><td><pre>kube-system   kube-controller-manager-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="8"></td><td><pre>kube-system   kube-flannel-ds-amd64-47r25      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="9"></td><td><pre>kube-system   kube-flannel-ds-amd64-ls5lh      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="10"></td><td><pre>kube-system   kube-proxy-685tk                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="11"></td><td><pre>kube-system   kube-proxy-87spt                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr><tr><td data-num="12"></td><td><pre>kube-system   kube-scheduler-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></td></tr></table></figure><h5 id="421-创建并运行"><a class="anchor" href="#421-创建并运行">#</a> 4.2.1 创建并运行</h5><p>kubernetes 没有提供单独运行 Pod 的命令，都是通过 Pod 控制器来实现的</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 命令格式： kubectl run (pod 控制器名称) [参数] </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># --image  指定 Pod 的镜像</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># --port   指定端口</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># --namespace  指定 namespace</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:latest --port=80 --namespace dev </span></pre></td></tr><tr><td data-num="6"></td><td><pre>deployment.apps/nginx created</pre></td></tr></table></figure><h5 id="422-查看pod信息"><a class="anchor" href="#422-查看pod信息">#</a> 4.2.2 查看 pod 信息</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 Pod 基本信息</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>NAME    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="4"></td><td><pre>nginx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          43s</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 查看 Pod 的详细信息</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod nginx -n dev</span></pre></td></tr><tr><td data-num="8"></td><td><pre>Name:         nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num="10"></td><td><pre>Priority:     <span class="token number">0</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Node:         node1/192.168.5.4</pre></td></tr><tr><td data-num="12"></td><td><pre>Start Time:   Wed, 08 May <span class="token number">2021</span> 09:29:24 +0800</pre></td></tr><tr><td data-num="13"></td><td><pre>Labels:       pod-template-hash<span class="token operator">=</span>5ff7956ff6</pre></td></tr><tr><td data-num="14"></td><td><pre>              <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>Status:       Running</pre></td></tr><tr><td data-num="17"></td><td><pre>IP:           <span class="token number">10.244</span>.1.23</pre></td></tr><tr><td data-num="18"></td><td><pre>IPs:</pre></td></tr><tr><td data-num="19"></td><td><pre>  IP:           <span class="token number">10.244</span>.1.23</pre></td></tr><tr><td data-num="20"></td><td><pre>Controlled By:  ReplicaSet/nginx</pre></td></tr><tr><td data-num="21"></td><td><pre>Containers:</pre></td></tr><tr><td data-num="22"></td><td><pre>  nginx:</pre></td></tr><tr><td data-num="23"></td><td><pre>    Container ID:   docker://4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c</pre></td></tr><tr><td data-num="24"></td><td><pre>    Image:          nginx:latest</pre></td></tr><tr><td data-num="25"></td><td><pre>    Image ID:       docker-pullable://nginx@sha256:485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7</pre></td></tr><tr><td data-num="26"></td><td><pre>    Port:           <span class="token number">80</span>/TCP</pre></td></tr><tr><td data-num="27"></td><td><pre>    Host Port:      <span class="token number">0</span>/TCP</pre></td></tr><tr><td data-num="28"></td><td><pre>    State:          Running</pre></td></tr><tr><td data-num="29"></td><td><pre>      Started:      Wed, 08 May <span class="token number">2021</span> 09:30:01 +0800</pre></td></tr><tr><td data-num="30"></td><td><pre>    Ready:          True</pre></td></tr><tr><td data-num="31"></td><td><pre>    Restart Count:  <span class="token number">0</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    Environment:    <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>    Mounts:</pre></td></tr><tr><td data-num="34"></td><td><pre>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hwvvw <span class="token punctuation">(</span>ro<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>Conditions:</pre></td></tr><tr><td data-num="36"></td><td><pre>  Type              Status</pre></td></tr><tr><td data-num="37"></td><td><pre>  Initialized       True</pre></td></tr><tr><td data-num="38"></td><td><pre>  Ready             True</pre></td></tr><tr><td data-num="39"></td><td><pre>  ContainersReady   True</pre></td></tr><tr><td data-num="40"></td><td><pre>  PodScheduled      True</pre></td></tr><tr><td data-num="41"></td><td><pre>Volumes:</pre></td></tr><tr><td data-num="42"></td><td><pre>  default-token-hwvvw:</pre></td></tr><tr><td data-num="43"></td><td><pre>    Type:        Secret <span class="token punctuation">(</span>a volume populated by a Secret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    SecretName:  default-token-hwvvw</pre></td></tr><tr><td data-num="45"></td><td><pre>    Optional:    <span class="token boolean">false</span></pre></td></tr><tr><td data-num="46"></td><td><pre>QoS Class:       BestEffort</pre></td></tr><tr><td data-num="47"></td><td><pre>Node-Selectors:  <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="48"></td><td><pre>Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="token keyword">for</span> 300s</pre></td></tr><tr><td data-num="49"></td><td><pre>                 node.kubernetes.io/unreachable:NoExecute <span class="token keyword">for</span> 300s</pre></td></tr><tr><td data-num="50"></td><td><pre>Events:</pre></td></tr><tr><td data-num="51"></td><td><pre>  Type    Reason     Age        From               Message</pre></td></tr><tr><td data-num="52"></td><td><pre>  ----    ------     ----       ----               -------</pre></td></tr><tr><td data-num="53"></td><td><pre>  Normal  Scheduled  <span class="token operator">&lt;</span>unknown<span class="token operator">></span>  default-scheduler  Successfully assigned dev/nginx-5ff7956ff6-fg2db to node1</pre></td></tr><tr><td data-num="54"></td><td><pre>  Normal  Pulling    4m11s      kubelet, node1     Pulling image <span class="token string">"nginx:latest"</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  Normal  Pulled     3m36s      kubelet, node1     Successfully pulled image <span class="token string">"nginx:latest"</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  Normal  Created    3m36s      kubelet, node1     Created container nginx</pre></td></tr><tr><td data-num="57"></td><td><pre>  Normal  Started    3m36s      kubelet, node1     Started container nginx</pre></td></tr></table></figure><h5 id="423-访问pod"><a class="anchor" href="#423-访问pod">#</a> 4.2.3 访问 Pod</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 获取 podIP</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="3"></td><td><pre>NAME    READY   STATUS    RESTARTS   AGE    IP             NODE    <span class="token punctuation">..</span>. </pre></td></tr><tr><td data-num="4"></td><td><pre>nginx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          190s   <span class="token number">10.244</span>.1.23   node1   <span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#访问 POD</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl http://10.244.1.23:80</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">&lt;</span>html<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">&lt;</span>head<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token operator">&lt;</span>title<span class="token operator">></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">&lt;</span>/head<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">&lt;</span>body<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token operator">&lt;</span>p<span class="token operator">></span><span class="token operator">&lt;</span>em<span class="token operator">></span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">&lt;</span>/body<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">&lt;</span>/html<span class="token operator">></span></pre></td></tr></table></figure><h5 id="424-删除指定pod"><a class="anchor" href="#424-删除指定pod">#</a> 4.2.4 删除指定 Pod</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 删除指定 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod nginx -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod <span class="token string">"nginx"</span> deleted</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 此时，显示删除 Pod 成功，但是再查询，发现又新产生了一个 </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>nginx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 这是因为当前 Pod 是由 Pod 控制器创建的，控制器会监控 Pod 状况，一旦发现 Pod 死亡，会立即重建</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 此时要想删除 Pod，必须删除 Pod 控制器</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 先来查询一下当前 namespace 下的 Pod 控制器</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n  dev</span></pre></td></tr><tr><td data-num="15"></td><td><pre>NAME    READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num="16"></td><td><pre>nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           9m7s</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 接下来，删除此 PodPod 控制器</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deploy nginx -n dev</span></pre></td></tr><tr><td data-num="20"></td><td><pre>deployment.apps <span class="token string">"nginx"</span> deleted</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 稍等片刻，再查询 Pod，发现 Pod 被删除了</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="24"></td><td><pre>No resources found <span class="token keyword">in</span> dev namespace.</pre></td></tr></table></figure><h5 id="425-配置操作"><a class="anchor" href="#425-配置操作">#</a> 4.2.5 配置操作</h5><p>创建一个 pod-nginx.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f pod-nginx.yaml</p><p>删除：kubectl delete -f pod-nginx.yaml</p><h4 id="43-label"><a class="anchor" href="#43-label">#</a> 4.3 Label</h4><p>Label 是 kubernetes 系统中的一个重要概念。它的作用就是在资源上添加标识，用来对它们进行区分和选择。</p><p>Label 的特点：</p><ul><li>一个 Label 会以 key/value 键值对的形式附加到各种对象上，如 Node、Pod、Service 等等</li><li>一个资源对象可以定义任意数量的 Label ，同一个 Label 也可以被添加到任意数量的资源对象上去</li><li>Label 通常在资源对象定义时确定，当然也可以在对象创建后动态添加或者删除</li></ul><p>可以通过 Label 实现资源的多维度分组，以便灵活、方便地进行资源分配、调度、配置、部署等管理工作。</p><blockquote><p>一些常用的 Label 示例如下：</p><ul><li>版本标签：&quot;version&quot;:&quot;release&quot;, &quot;version&quot;:&quot;stable&quot;......</li><li>环境标签：&quot;environment&quot;:&quot;dev&quot;，&quot;environment&quot;:&quot;test&quot;，&quot;environment&quot;:&quot;pro&quot;</li><li>架构标签：&quot;tier&quot;:&quot;frontend&quot;，&quot;tier&quot;:&quot;backend&quot;</li></ul></blockquote><p>标签定义完毕之后，还要考虑到标签的选择，这就要使用到 Label Selector，即：</p><p>Label 用于给某个资源对象定义标识</p><p>Label Selector 用于查询和筛选拥有某些标签的资源对象</p><p>当前有两种 Label Selector：</p><ul><li><p>基于等式的 Label Selector</p><p>name = slave: 选择所有包含 Label 中 key=&quot;name&quot; 且 value=&quot;slave&quot; 的对象</p><p>env != production: 选择所有包括 Label 中的 key=&quot;env&quot; 且 value 不等于 &quot;production&quot; 的对象</p></li><li><p>基于集合的 Label Selector</p><p>name in (master, slave): 选择所有包含 Label 中的 key=&quot;name&quot; 且 value=&quot;master&quot; 或 &quot;slave&quot; 的对象</p><p>name not in (frontend): 选择所有包含 Label 中的 key=&quot;name&quot; 且 value 不等于 &quot;frontend&quot; 的对象</p></li></ul><p>标签的选择条件可以使用多个，此时将多个 Label Selector 进行组合，使用逗号 &quot;,&quot; 进行分隔即可。例如：</p><p>name=slave，env!=production</p><p>name not in (frontend)，env!=production</p><h5 id="431-命令方式"><a class="anchor" href="#431-命令方式">#</a> 4.3.1 命令方式</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 为 pod 资源打标签</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label pod nginx-pod version=1.0 -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/nginx-pod labeled</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 为 pod 资源更新标签</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label pod nginx-pod version=2.0 -n dev --overwrite</span></pre></td></tr><tr><td data-num="7"></td><td><pre>pod/nginx-pod labeled</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 查看标签</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod nginx-pod  -n dev --show-labels</span></pre></td></tr><tr><td data-num="11"></td><td><pre>NAME        READY   STATUS    RESTARTS   AGE   LABELS</pre></td></tr><tr><td data-num="12"></td><td><pre>nginx-pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m   <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token number">2.0</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 筛选标签</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev -l version=2.0  --show-labels</span></pre></td></tr><tr><td data-num="16"></td><td><pre>NAME        READY   STATUS    RESTARTS   AGE   LABELS</pre></td></tr><tr><td data-num="17"></td><td><pre>nginx-pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17m   <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token number">2.0</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev -l version!=2.0 --show-labels</span></pre></td></tr><tr><td data-num="19"></td><td><pre>No resources found <span class="token keyword">in</span> dev namespace.</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#删除标签</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label pod nginx-pod version- -n dev</span></pre></td></tr><tr><td data-num="23"></td><td><pre>pod/nginx-pod labeled</pre></td></tr></table></figure><h5 id="432-配置方式"><a class="anchor" href="#432-配置方式">#</a> 4.3.2 配置方式</h5><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.0"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">env</span><span class="token punctuation">:</span> <span class="token string">"test"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr></table></figure><p>然后就可以执行对应的更新命令了：kubectl apply -f pod-nginx.yaml</p><h4 id="44-deployment"><a class="anchor" href="#44-deployment">#</a> 4.4 Deployment</h4><p>在 kubernetes 中，Pod 是最小的控制单元，但是 kubernetes 很少直接控制 Pod，一般都是通过 Pod 控制器来完成的。Pod 控制器用于 pod 的管理，确保 pod 资源符合预期的状态，当 pod 的资源出现故障时，会尝试进行重启或重建 pod。</p><p>在 kubernetes 中 Pod 控制器的种类有很多，本章节只介绍一种：Deployment。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200408193950807.png" alt="image-20200408193950807"></p><h5 id="441待操作"><a class="anchor" href="#441待操作">#</a> 4.4.1 待操作。。。。。</h5><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 命令格式: kubectl create deployment 名称  [参数] </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># --image  指定 pod 的镜像</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># --port   指定端口</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># --replicas  指定创建 pod 数量</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># --namespace  指定 namespace</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:latest --port=80 --replicas=3 -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>deployment.apps/nginx created</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 查看创建的 Pod</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="11"></td><td><pre>NAME                     READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="12"></td><td><pre>nginx<span class="token punctuation">-</span>5ff7956ff6<span class="token punctuation">-</span>6k8cb   1/1     Running   0          19s</pre></td></tr><tr><td data-num="13"></td><td><pre>nginx<span class="token punctuation">-</span>5ff7956ff6<span class="token punctuation">-</span>jxfjt   1/1     Running   0          19s</pre></td></tr><tr><td data-num="14"></td><td><pre>nginx<span class="token punctuation">-</span>5ff7956ff6<span class="token punctuation">-</span>v6jqw   1/1     Running   0          19s</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 查看 deployment 的信息</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n dev</span></pre></td></tr><tr><td data-num="18"></td><td><pre>NAME    READY   UP<span class="token punctuation">-</span>TO<span class="token punctuation">-</span>DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num="19"></td><td><pre>nginx   3/3     3            3           2m42s</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># UP-TO-DATE：成功升级的副本数量</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># AVAILABLE：可用副本的数量</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n dev -o wide</span></pre></td></tr><tr><td data-num="24"></td><td><pre>NAME    READY UP<span class="token punctuation">-</span>TO<span class="token punctuation">-</span>DATE  AVAILABLE   AGE     CONTAINERS   IMAGES              SELECTOR</pre></td></tr><tr><td data-num="25"></td><td><pre>nginx   3/3     3         3           2m51s   nginx        nginx<span class="token punctuation">:</span>latest        run=nginx</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># 查看 deployment 的详细信息</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe deploy nginx -n dev</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token key atrule">Name</span><span class="token punctuation">:</span>                   nginx</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token key atrule">Namespace</span><span class="token punctuation">:</span>              dev</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token key atrule">CreationTimestamp</span><span class="token punctuation">:</span>      Wed<span class="token punctuation">,</span> 08 May 2021 11<span class="token punctuation">:</span>14<span class="token punctuation">:</span>14 +0800</pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token key atrule">Labels</span><span class="token punctuation">:</span>                 run=nginx</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token key atrule">Annotations</span><span class="token punctuation">:</span>            <span class="token key atrule">deployment.kubernetes.io/revision</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">Selector</span><span class="token punctuation">:</span>               run=nginx</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token key atrule">Replicas</span><span class="token punctuation">:</span>               3 desired <span class="token punctuation">|</span> 3 updated <span class="token punctuation">|</span> 3 total <span class="token punctuation">|</span> 3 available <span class="token punctuation">|</span> 0 unavailable</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token key atrule">StrategyType</span><span class="token punctuation">:</span>           RollingUpdate</pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token key atrule">MinReadySeconds</span><span class="token punctuation">:</span>        <span class="token number">0</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token key atrule">RollingUpdateStrategy</span><span class="token punctuation">:</span>  25% max unavailable<span class="token punctuation">,</span> 25% max 违规词汇</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token key atrule">Pod Template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token key atrule">Labels</span><span class="token punctuation">:</span>  run=nginx</pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token key atrule">Containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>   <span class="token key atrule">nginx</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token key atrule">Image</span><span class="token punctuation">:</span>        nginx<span class="token punctuation">:</span>latest</pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token key atrule">Port</span><span class="token punctuation">:</span>         80/TCP</pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token key atrule">Host Port</span><span class="token punctuation">:</span>    0/TCP</pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token key atrule">Environment</span><span class="token punctuation">:</span>  &lt;none<span class="token punctuation">></span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token key atrule">Mounts</span><span class="token punctuation">:</span>       &lt;none<span class="token punctuation">></span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token key atrule">Volumes</span><span class="token punctuation">:</span>        &lt;none<span class="token punctuation">></span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token key atrule">Conditions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  Type           Status  Reason</pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token punctuation">---</span><span class="token punctuation">-</span>           <span class="token punctuation">---</span><span class="token punctuation">---</span>  <span class="token punctuation">---</span><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  Available      True    MinimumReplicasAvailable</pre></td></tr><tr><td data-num="53"></td><td><pre>  Progressing    True    NewReplicaSetAvailable</pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token key atrule">OldReplicaSets</span><span class="token punctuation">:</span>  &lt;none<span class="token punctuation">></span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token key atrule">NewReplicaSet</span><span class="token punctuation">:</span>   nginx<span class="token punctuation">-</span>5ff7956ff6 (3/3 replicas created)</pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token key atrule">Events</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  Type    Reason             Age    From                   Message</pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token punctuation">---</span><span class="token punctuation">-</span>    <span class="token punctuation">---</span><span class="token punctuation">---</span>             <span class="token punctuation">---</span><span class="token punctuation">-</span>   <span class="token punctuation">---</span><span class="token punctuation">-</span>                   <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  Normal  ScalingReplicaSet  5m43s  deployment<span class="token punctuation">-</span>controller  Scaled up replicaset nginx<span class="token punctuation">-</span>5ff7956ff6 to 3</pre></td></tr><tr><td data-num="60"></td><td><pre>  </pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># 删除 </span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deploy nginx -n dev</span></pre></td></tr><tr><td data-num="63"></td><td><pre>deployment.apps "nginx" deleted</pre></td></tr></table></figure><h5 id="442-配置操作"><a class="anchor" href="#442-配置操作">#</a> 4.4.2 配置操作</h5><p>创建一个 deploy-nginx.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f deploy-nginx.yaml</p><p>删除：kubectl delete -f deploy-nginx.yaml</p><h4 id="45-service"><a class="anchor" href="#45-service">#</a> 4.5 Service</h4><p>通过上节课的学习，已经能够利用 Deployment 来创建一组 Pod 来提供具有高可用性的服务。</p><p>虽然每个 Pod 都会分配一个单独的 Pod IP，然而却存在如下两问题：</p><ul><li>Pod IP 会随着 Pod 的重建产生变化</li><li>Pod IP 仅仅是集群内可见的虚拟 IP，外部无法访问</li></ul><p>这样对于访问这个服务带来了难度。因此，kubernetes 设计了 Service 来解决这个问题。</p><p>Service 可以看作是一组同类 Pod<strong> 对外的访问接口</strong>。借助 Service，应用可以方便地实现服务发现和负载均衡。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200408194716912.png" alt="image-20200408194716912"></p><h5 id="451-创建集群内部可访问的service"><a class="anchor" href="#451-创建集群内部可访问的service">#</a> 4.5.1 创建集群内部可访问的 Service</h5><pre><code class="language-yacas"># 暴露Service
[root@master ~]# kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev
service/svc-nginx1 exposed

# 查看service
[root@master ~]# kubectl get svc svc-nginx1 -n dev -o wide
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE     SELECTOR
svc-nginx1   ClusterIP   10.109.179.231   &lt;none&gt;        80/TCP    3m51s   run=nginx

# 这里产生了一个CLUSTER-IP，这就是service的IP，在Service的生命周期中，这个地址是不会变动的
# 可以通过这个IP访问当前service对应的POD
[root@master ~]# curl 10.109.179.231:80
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
.......
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h5 id="452-创建集群外部也可访问的service"><a class="anchor" href="#452-创建集群外部也可访问的service">#</a> 4.5.2 创建集群外部也可访问的 Service</h5><pre><code class="language-yacas"># 上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问
# 如果需要创建外部也可以访问的Service，需要修改type为NodePort
[root@master ~]# kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev
service/svc-nginx2 exposed

# 此时查看，会发现出现了NodePort类型的Service，而且有一对Port（80:31928/TC）
[root@master ~]# kubectl get svc  svc-nginx2  -n dev -o wide
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE    SELECTOR
svc-nginx2    NodePort    10.100.94.0      &lt;none&gt;        80:31928/TCP   9s     run=nginx

# 接下来就可以通过集群外的主机访问 节点IP:31928访问服务了
# 例如在的电脑主机上通过浏览器访问下面的地址
http://192.168.90.100:31928/
</code></pre><h5 id="453-删除service"><a class="anchor" href="#453-删除service">#</a> 4.5.3 删除 Service</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete svc svc-nginx-1 -n dev </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">service</span> <span class="token string">"svc-nginx-1"</span> deleted</pre></td></tr></table></figure><h5 id="454-配置方式"><a class="anchor" href="#454-配置方式">#</a> 4.5.4 配置方式</h5><p>创建一个 svc-nginx.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span>nginx</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.109.179.231 <span class="token comment">#固定 svc 的内网 ip</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f svc-nginx.yaml</p><p>删除：kubectl delete -f svc-nginx.yaml</p><blockquote><p><strong>小结</strong></p><p>至此，已经掌握了 Namespace、Pod、Deployment、Service 资源的基本操作，有了这些操作，就可以在 kubernetes 集群中实现一个服务的简单部署和访问了，但是如果想要更好的使用 kubernetes，就需要深入学习这几种资源的细节和原理。</p></blockquote><h3 id="5-pod详解"><a class="anchor" href="#5-pod详解">#</a> 5. Pod 详解</h3><h4 id="51-pod介绍"><a class="anchor" href="#51-pod介绍">#</a> 5.1 Pod 介绍</h4><h5 id="511-pod结构"><a class="anchor" href="#511-pod结构">#</a> 5.1.1 Pod 结构</h5><p><img data-src="http://oss.itshare.work/blog-images/image-20200407121501907-1626781151898.png" alt="image-20200407121501907"></p><p>每个 Pod 中都可以包含一个或者多个容器，这些容器可以分为两类：</p><ul><li><p>用户程序所在的容器，数量可多可少</p></li><li><p>Pause 容器，这是每个 Pod 都会有的一个<strong>根容器</strong>，它的作用有两个：</p><ul><li><p>可以以它为依据，评估整个 Pod 的健康状态</p></li><li><p>可以在根容器上设置 Ip 地址，其它容器都此 Ip（Pod IP），以实现 Pod 内部的网路通信</p><pre><code>这里是Pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术来实现，我们当前环境用的是Flannel
</code></pre></li></ul></li></ul><h5 id="512-pod定义"><a class="anchor" href="#512-pod定义">#</a> 5.1.2 Pod 定义</h5><p>下面是 Pod 的资源清单：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1     <span class="token comment">#必选，版本号，例如 v1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod       　 <span class="token comment">#必选，资源类型，例如 Pod</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span>       　 <span class="token comment">#必选，元数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> string     <span class="token comment">#必选，Pod 名称</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> string  <span class="token comment">#Pod 所属的命名空间，默认为 "default"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>       　　  <span class="token comment">#自定义标签列表</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string      　          </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token comment">#必选，Pod 中容器的详细定义</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token comment">#必选，Pod 中容器列表</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string   <span class="token comment">#必选，容器名称</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> string  <span class="token comment">#必选，容器的镜像名称</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> Always<span class="token punctuation">|</span>Never<span class="token punctuation">|</span>IfNotPresent <span class="token punctuation">]</span>  <span class="token comment">#获取镜像的策略 </span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>   <span class="token comment">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>      <span class="token comment">#容器的启动命令参数列表</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> string  <span class="token comment">#容器的工作目录</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>       <span class="token comment">#挂载到容器内部的存储卷配置</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string      <span class="token comment">#引用 pod 定义的共享存储卷的名称，需用 volumes [] 部分定义的的卷名</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> string <span class="token comment">#存储卷在容器内 mount 的绝对路径，应少于 512 字符</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> boolean <span class="token comment">#是否为只读模式</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment">#需要暴露的端口库号列表</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string        <span class="token comment">#端口的名称</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> int  <span class="token comment">#容器需要监听的端口号</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> int       <span class="token comment">#容器所在主机需要监听的端口号，默认与 Container 相同</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> string    <span class="token comment">#端口协议，支持 TCP 和 UDP，默认 TCP</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">env</span><span class="token punctuation">:</span>   <span class="token comment">#容器运行前需设置的环境变量列表</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string  <span class="token comment">#环境变量名称</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> string <span class="token comment">#环境变量的值</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment">#资源限制和请求的设置</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment">#资源限制的设置</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> string     <span class="token comment">#Cpu 的限制，单位为 core 数，将用于 docker run --cpu-shares 参数</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> string  <span class="token comment">#内存限制，单位可以为 Mib/Gib，将用于 docker run --memory 参数</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment">#资源请求的设置</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> string    <span class="token comment">#Cpu 请求，容器启动的初始可用数量</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> string <span class="token comment">#内存请求，容器启动的初始可用数量</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span> <span class="token comment">#生命周期钩子</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token key atrule">postStart</span><span class="token punctuation">:</span> <span class="token comment">#容器启动后立即执行此钩子，如果执行失败，会根据重启策略进行重启</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token key atrule">preStop</span><span class="token punctuation">:</span> <span class="token comment">#容器终止前执行此钩子，无论结果如何，容器都会终止</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>  <span class="token comment">#对 Pod 内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>       　 <span class="token comment">#对 Pod 容器内检查方式设置为 exec 方式</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>  <span class="token comment">#exec 方式需要制定的命令或脚本</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>       <span class="token comment">#对 Pod 内个容器健康检查方法设置为 HttpGet，需要制定 Path、port</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> number</pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token key atrule">host</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token key atrule">HttpHeaders</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token key atrule">value</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>     <span class="token comment">#对 Pod 内个容器健康检查方式设置为 tcpSocket 方式</span></pre></td></tr><tr><td data-num="50"></td><td><pre>         <span class="token key atrule">port</span><span class="token punctuation">:</span> number</pre></td></tr><tr><td data-num="51"></td><td><pre>       <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>       <span class="token comment">#容器启动完成后首次探测的时间，单位为秒</span></pre></td></tr><tr><td data-num="52"></td><td><pre>       <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> 0    　　    <span class="token comment">#对容器健康检查探测等待响应的超时时间，单位秒，默认 1 秒</span></pre></td></tr><tr><td data-num="53"></td><td><pre>       <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> 0     　　    <span class="token comment">#对容器监控检查的定期探测时间设置，单位秒，默认 10 秒一次</span></pre></td></tr><tr><td data-num="54"></td><td><pre>       <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="55"></td><td><pre>       <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="56"></td><td><pre>       <span class="token key atrule">securityContext</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>         <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Always <span class="token punctuation">|</span> Never <span class="token punctuation">|</span> OnFailure<span class="token punctuation">]</span>  <span class="token comment">#Pod 的重启策略</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span> <span class="token comment">#设置 NodeName 表示将该 Pod 调度到指定到名称的 node 节点上</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> obeject <span class="token comment">#设置 NodeSelector 表示将该 Pod 调度到包含这个 label 的 node 上</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span> <span class="token comment">#Pull 镜像时使用的 secret 名称，以 key：secretkey 格式指定</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment">#是否使用主机网络模式，默认为 false，如果设置为 true，表示使用宿主机网络</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>   <span class="token comment">#在该 pod 上定义共享存储卷列表</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string    <span class="token comment">#共享存储卷名称 （volumes 类型有很多种）</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>       <span class="token comment">#类型为 emtyDir 的存储卷，与 Pod 同生命周期的一个临时目录。为空值</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> string   <span class="token comment">#类型为 hostPath 的存储卷，表示挂载 Pod 所在宿主机的目录</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token key atrule">path</span><span class="token punctuation">:</span> string      　　        <span class="token comment">#Pod 所在宿主机的目录，将被用于同期中 mount 的目录</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token key atrule">secret</span><span class="token punctuation">:</span>       　　　<span class="token comment">#类型为 secret 的存储卷，挂载集群与定义的 secret 对象到容器内部</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token key atrule">scretname</span><span class="token punctuation">:</span> string  </pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token key atrule">items</span><span class="token punctuation">:</span>     </pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token comment">#类型为 configMap 的存储卷，挂载预定义的 configMap 对象到容器内部</span></pre></td></tr><tr><td data-num="75"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token key atrule">items</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> string</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#小提示：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#   在这里，可通过一个命令来查看每种资源的可配置项</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#   kubectl explain 资源类型         查看某种资源可以配置的一级属性</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#   kubectl explain 资源类型。属性     查看属性的子属性</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">KIND</span><span class="token punctuation">:</span>     Pod</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">VERSION</span><span class="token punctuation">:</span>  v1</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">FIELDS</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   apiVersion   &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>   kind &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>   metadata     &lt;Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="12"></td><td><pre>   spec &lt;Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>   status       &lt;Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.metadata</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">KIND</span><span class="token punctuation">:</span>     Pod</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token key atrule">VERSION</span><span class="token punctuation">:</span>  v1</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token key atrule">RESOURCE</span><span class="token punctuation">:</span> metadata &lt;Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token key atrule">FIELDS</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   annotations  &lt;map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="21"></td><td><pre>   clusterName  &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>   creationTimestamp    &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>   deletionGracePeriodSeconds   &lt;integer<span class="token punctuation">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>   deletionTimestamp    &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="25"></td><td><pre>   finalizers   &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>   generateName &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="27"></td><td><pre>   generation   &lt;integer<span class="token punctuation">></span></pre></td></tr><tr><td data-num="28"></td><td><pre>   labels       &lt;map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="29"></td><td><pre>   managedFields        &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="30"></td><td><pre>   name &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="31"></td><td><pre>   namespace    &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="32"></td><td><pre>   ownerReferences      &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>   resourceVersion      &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="34"></td><td><pre>   selfLink     &lt;string<span class="token punctuation">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>   uid  &lt;string<span class="token punctuation">></span></pre></td></tr></table></figure><p>在 kubernetes 中基本所有资源的一级属性都是一样的，主要包含 5 部分：</p><ul><li>apiVersion &lt;string&gt; 版本，由 kubernetes 内部定义，版本号必须可以用 kubectl api-versions 查询到</li><li>kind &lt;string&gt; 类型，由 kubernetes 内部定义，版本号必须可以用 kubectl api-resources 查询到</li><li>metadata &lt;Object&gt; 元数据，主要是资源标识和说明，常用的有 name、namespace、labels 等</li><li>spec &lt;Object&gt; 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</li><li>status &lt;Object&gt; 状态信息，里面的内容不需要定义，由 kubernetes 自动生成</li></ul><p>在上面的属性中，spec 是接下来研究的重点，继续看下它的常见子属性:</p><ul><li>containers &lt;[] Object&gt; 容器列表，用于定义容器的详细信息</li><li>nodeName &lt;String&gt; 根据 nodeName 的值将 pod 调度到指定的 Node 节点上</li><li>nodeSelector &lt;map []&gt; 根据 NodeSelector 中定义的信息选择将该 Pod 调度到包含这些 label 的 Node 上</li><li>hostNetwork &lt;boolean&gt; 是否使用主机网络模式，默认为 false，如果设置为 true，表示使用宿主机网络</li><li>volumes &lt;[] Object&gt; 存储卷，用于定义 Pod 上面挂在的存储信息</li><li>restartPolicy &lt;string&gt; 重启策略，表示 Pod 在遇到故障的时候的处理策略</li></ul><h4 id="52-pod配置"><a class="anchor" href="#52-pod配置">#</a> 5.2 Pod 配置</h4><p>本小节主要来研究 <code>pod.spec.containers</code> 属性，这也是 pod 配置中最为关键的一项配置。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">KIND</span><span class="token punctuation">:</span>     Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">VERSION</span><span class="token punctuation">:</span>  v1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">RESOURCE</span><span class="token punctuation">:</span> containers &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">></span>   <span class="token comment"># 数组，代表可以有多个容器</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">FIELDS</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   name  &lt;string<span class="token punctuation">></span>     <span class="token comment"># 容器名称</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   image &lt;string<span class="token punctuation">></span>     <span class="token comment"># 容器需要的镜像地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   imagePullPolicy  &lt;string<span class="token punctuation">></span> <span class="token comment"># 镜像拉取策略 </span></pre></td></tr><tr><td data-num="9"></td><td><pre>   command  &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token punctuation">></span> <span class="token comment"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   args     &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token punctuation">></span> <span class="token comment"># 容器的启动命令需要的参数列表</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   env      &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">></span> <span class="token comment"># 容器环境变量的配置</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   ports    &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">></span>     <span class="token comment"># 容器需要暴露的端口号列表</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   resources &lt;Object<span class="token punctuation">></span>      <span class="token comment"># 资源限制和资源请求的设置</span></pre></td></tr></table></figure><h5 id="521-基本配置"><a class="anchor" href="#521-基本配置">#</a> 5.2.1 基本配置</h5><p>创建 pod-base.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>base</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">user</span><span class="token punctuation">:</span> heima</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr></table></figure><p><img data-src="http://oss.itshare.work/blog-images/image-20210617223823675-1626781695411.png" alt="image-20210617223823675"></p><p>上面定义了一个比较简单 Pod 的配置，里面有两个容器：</p><ul><li>nginx：用 1.17.1 版本的 nginx 镜像创建，（nginx 是一个轻量级 web 容器）</li><li>busybox：用 1.30 版本的 busybox 镜像创建，（busybox 是一个小巧的 linux 命令集合）</li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-base.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>base created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod 状况</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># READY 1/2 : 表示当前 Pod 中有 2 个容器，其中 1 个准备就绪，1 个未就绪</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># RESTARTS  : 重启次数，因为有 1 个容器故障了，Pod 一直在重启试图恢复它</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev</span></pre></td></tr><tr><td data-num="9"></td><td><pre>NAME       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="10"></td><td><pre>pod<span class="token punctuation">-</span>base   1/2     Running   4          95s</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 可以通过 describe 查看内部的详情</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 此时已经运行起来了一个基本的 Pod，虽然它暂时有问题</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-base -n dev</span></pre></td></tr></table></figure><h5 id="522-镜像拉取"><a class="anchor" href="#522-镜像拉取">#</a> 5.2.2 镜像拉取</h5><p>创建 pod-imagepullpolicy.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>imagepullpolicy</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 用于设置镜像拉取策略</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr></table></figure><p><img data-src="http://oss.itshare.work/blog-images/image-20210617223923659.png" alt="image-20210617223923659"></p><p>imagePullPolicy，用于设置镜像拉取策略，kubernetes 支持配置三种拉取策略：</p><ul><li>Always：总是从远程仓库拉取镜像（一直远程下载）</li><li>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像（本地有就本地 本地没远程下载）</li><li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错 （一直使用本地）</li></ul><blockquote><p>默认值说明：</p><p>如果镜像 tag 为具体版本号， 默认策略是：IfNotPresent</p><p>如果镜像 tag 为：latest（最终版本） ，默认策略是 always</p></blockquote><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-imagepullpolicy.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>imagepullpolicy created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 此时明显可以看到 nginx 镜像有一步 Pulling image "nginx:1.17.1" 的过程</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-imagepullpolicy -n dev</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">Events</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  Type     Reason     Age               From               Message</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">---</span><span class="token punctuation">-</span>     <span class="token punctuation">---</span><span class="token punctuation">---</span>     <span class="token punctuation">---</span><span class="token punctuation">-</span>              <span class="token punctuation">---</span><span class="token punctuation">-</span>               <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  Normal   Scheduled  &lt;unknown<span class="token punctuation">></span>         default<span class="token punctuation">-</span>scheduler  Successfully assigned dev/pod<span class="token punctuation">-</span>imagePullPolicy to node1</pre></td></tr><tr><td data-num="13"></td><td><pre>  Normal   Pulling    32s               kubelet<span class="token punctuation">,</span> node1     Pulling image "nginx<span class="token punctuation">:</span>1.17.1"</pre></td></tr><tr><td data-num="14"></td><td><pre>  Normal   Pulled     26s               kubelet<span class="token punctuation">,</span> node1     Successfully pulled image "nginx<span class="token punctuation">:</span>1.17.1"</pre></td></tr><tr><td data-num="15"></td><td><pre>  Normal   Created    26s               kubelet<span class="token punctuation">,</span> node1     Created container nginx</pre></td></tr><tr><td data-num="16"></td><td><pre>  Normal   Started    25s               kubelet<span class="token punctuation">,</span> node1     Started container nginx</pre></td></tr><tr><td data-num="17"></td><td><pre>  Normal   Pulled     7s (x3 over 25s)  kubelet<span class="token punctuation">,</span> node1     Container image "busybox<span class="token punctuation">:</span>1.30" already present on machine</pre></td></tr><tr><td data-num="18"></td><td><pre>  Normal   Created    7s (x3 over 25s)  kubelet<span class="token punctuation">,</span> node1     Created container busybox</pre></td></tr><tr><td data-num="19"></td><td><pre>  Normal   Started    7s (x3 over 25s)  kubelet<span class="token punctuation">,</span> node1     Started container busybox</pre></td></tr></table></figure><h5 id="523-启动命令"><a class="anchor" href="#523-启动命令">#</a> 5.2.3 启动命令</h5><p>在前面的案例中，一直有一个问题没有解决，就是的 busybox 容器一直没有成功运行，那么到底是什么原因导致这个容器的故障呢？</p><p>原来 busybox 并不是一个程序，而是类似于一个工具类的集合，kubernetes 集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了 command 配置。</p><p>创建 pod-command.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>command</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) >> /tmp/hello.txt; sleep 3; done;"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p><img data-src="http://oss.itshare.work/blog-images/image-20210617224457945.png" alt="image-20210617224457945"></p><p>command，用于在 pod 中的容器初始化完毕之后运行一个命令。</p><blockquote><p>稍微解释下上面命令的意思：</p><p>&quot;/bin/sh&quot;,&quot;-c&quot;, 使用 sh 执行命令</p><p>touch /tmp/hello.txt; 创建一个 /tmp/hello.txt 文件</p><p>while true;do /bin/echo $(date +% T) &gt;&gt; /tmp/hello.txt; sleep 3; done; 每隔 3 秒向文件中写入当前时间</p></blockquote><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl create  -f pod-command.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>command created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod 状态</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 此时发现两个 pod 都正常运行了</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-command -n dev</span></pre></td></tr><tr><td data-num="8"></td><td><pre>NAME          READY   STATUS   RESTARTS   AGE</pre></td></tr><tr><td data-num="9"></td><td><pre>pod<span class="token punctuation">-</span>command   2/2     Runing   0          2s</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 进入 pod 中的 busybox 容器，查看文件内容</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 补充一个命令: kubectl exec  pod 名称 -n 命名空间 -it -c 容器名称 /bin/sh  在容器内部执行命令</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 比如，可以查看 txt 文件的内容</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl exec pod-command -n dev -it -c busybox /bin/sh</span></pre></td></tr><tr><td data-num="16"></td><td><pre>/ <span class="token comment"># tail -f /tmp/hello.txt</span></pre></td></tr><tr><td data-num="17"></td><td><pre>14<span class="token punctuation">:</span><span class="token datetime number">44:19</span></pre></td></tr><tr><td data-num="18"></td><td><pre>14<span class="token punctuation">:</span><span class="token datetime number">44:22</span></pre></td></tr><tr><td data-num="19"></td><td><pre>14<span class="token punctuation">:</span><span class="token datetime number">44:25</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>特别说明：</pre></td></tr><tr><td data-num="2"></td><td><pre>    通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢<span class="token punctuation">?</span>这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。</pre></td></tr><tr><td data-num="3"></td><td><pre> 1 如果command和args均没有写，那么用Dockerfile的配置。</pre></td></tr><tr><td data-num="4"></td><td><pre> 2 如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</pre></td></tr><tr><td data-num="5"></td><td><pre> 3 如果command没写，但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前args的参数</pre></td></tr><tr><td data-num="6"></td><td><pre> 4 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</pre></td></tr></table></figure><h5 id="524-环境变量"><a class="anchor" href="#524-环境变量">#</a> 5.2.4 环境变量</h5><p>创建 pod-env.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>env</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do /bin/echo $(date +%T);sleep 60; done;"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">env</span><span class="token punctuation">:</span> <span class="token comment"># 设置环境变量列表</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"username"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"admin"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"password"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"123456"</span></pre></td></tr></table></figure><p>env，环境变量，用于在 pod 中的容器设置环境变量。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-env.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod-env created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 进入容器，输出环境变量</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec pod-env -n dev -c busybox -it /bin/sh</span></pre></td></tr><tr><td data-num="7"></td><td><pre>/ <span class="token comment"># echo $username</span></pre></td></tr><tr><td data-num="8"></td><td><pre>admin</pre></td></tr><tr><td data-num="9"></td><td><pre>/ <span class="token comment"># echo $password</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">123456</span></pre></td></tr></table></figure><p>这种方式不是很推荐，推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。</p><h5 id="525-端口设置"><a class="anchor" href="#525-端口设置">#</a> 5.2.5 端口设置</h5><p>本小节来介绍容器的端口设置，也就是 containers 的 ports 选项。</p><p>首先看下 ports 支持的子选项：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers.ports</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">KIND</span><span class="token punctuation">:</span>     Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">VERSION</span><span class="token punctuation">:</span>  v1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">RESOURCE</span><span class="token punctuation">:</span> ports &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">FIELDS</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   name         &lt;string<span class="token punctuation">></span>  <span class="token comment"># 端口名称，如果指定，必须保证 name 在 pod 中是唯一的		</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   containerPort&lt;integer<span class="token punctuation">></span> <span class="token comment"># 容器要监听的端口 (0&lt;x&lt;65536)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   hostPort     &lt;integer<span class="token punctuation">></span> <span class="token comment"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本 (一般省略) </span></pre></td></tr><tr><td data-num="9"></td><td><pre>   hostIP       &lt;string<span class="token punctuation">></span>  <span class="token comment"># 要将外部端口绑定到的主机 IP (一般省略)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   protocol     &lt;string<span class="token punctuation">></span>  <span class="token comment"># 端口协议。必须是 UDP、TCP 或 SCTP。默认为 “TCP”。</span></pre></td></tr></table></figure><p>接下来，编写一个测试案例，创建 pod-ports.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>ports</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 设置容器暴露的端口列表</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-ports.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod-ports created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 在下面可以明显看到配置信息</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-ports -n dev -o yaml</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="9"></td><td><pre>spec:</pre></td></tr><tr><td data-num="10"></td><td><pre>  containers:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - image: nginx:1.17.1</pre></td></tr><tr><td data-num="12"></td><td><pre>    imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num="13"></td><td><pre>    name: nginx</pre></td></tr><tr><td data-num="14"></td><td><pre>    ports:</pre></td></tr><tr><td data-num="15"></td><td><pre>    - containerPort: <span class="token number">80</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      name: nginx-port</pre></td></tr><tr><td data-num="17"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr></table></figure><p>访问容器中的程序需要使用的是 <code>Podip:containerPort</code></p><h5 id="526-资源配额"><a class="anchor" href="#526-资源配额">#</a> 5.2.6 资源配额</h5><p>容器中的程序要运行，肯定是要占用一定资源的，比如 cpu 和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其它容器无法运行。针对这种情况，kubernetes 提供了对内存和 cpu 的资源进行配额的机制，这种机制主要通过 resources 选项实现，他有两个子选项：</p><ul><li>limits：用于限制运行时容器的最大占用资源，当容器占用资源超过 limits 时会被终止，并进行重启</li><li>requests ：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动</li></ul><p>可以通过上面两个选项设置资源的上下限。</p><p>接下来，编写一个测试案例，创建 pod-resources.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>resources</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 资源配额</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment"># 限制资源（上限）</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span> <span class="token comment"># CPU 限制，单位是 core 数</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"10Gi"</span> <span class="token comment"># 内存限制</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># 请求资源（下限）</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>  <span class="token comment"># CPU 限制，单位是 core 数</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"10Mi"</span>  <span class="token comment"># 内存限制</span></pre></td></tr></table></figure><p>在这对 cpu 和 memory 的单位做一个说明：</p><ul><li>cpu：core 数，可以为整数或小数</li><li>memory： 内存大小，可以使用 Gi、Mi、G、M 等形式</li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 运行 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create  -f pod-resources.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>resources created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看发现 pod 运行正常</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-resources -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE  </pre></td></tr><tr><td data-num="8"></td><td><pre>pod<span class="token punctuation">-</span>resources   1/1     Running   0          39s   </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 接下来，停止 Pod</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete  -f pod-resources.yaml</span></pre></td></tr><tr><td data-num="12"></td><td><pre>pod "pod<span class="token punctuation">-</span>resources" deleted</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 编辑 pod，修改 resources.requests.memory 的值为 10Gi</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-resources.yaml</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 再次启动 pod</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create  -f pod-resources.yaml</span></pre></td></tr><tr><td data-num="19"></td><td><pre>pod/pod<span class="token punctuation">-</span>resources created</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 查看 Pod 状态，发现 Pod 启动失败</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-resources -n dev -o wide</span></pre></td></tr><tr><td data-num="23"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE          </pre></td></tr><tr><td data-num="24"></td><td><pre>pod<span class="token punctuation">-</span>resources   0/1     Pending   0          20s    </pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 查看 pod 详情会发现，如下提示</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-resources -n dev</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token key atrule">Warning  FailedScheduling  35s   default-scheduler  0/3 nodes are available</span><span class="token punctuation">:</span> 1 node(s) had taint <span class="token punctuation">&#123;</span><span class="token key atrule">node-role.kubernetes.io/master</span><span class="token punctuation">:</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> that the pod didn't tolerate<span class="token punctuation">,</span> 2 Insufficient memory.(内存不足)</pre></td></tr></table></figure><h4 id="53-pod生命周期"><a class="anchor" href="#53-pod生命周期">#</a> 5.3 Pod 生命周期</h4><p>我们一般将 pod 对象从创建至终的这段时间范围称为 pod 的生命周期，它主要包含下面的过程：</p><ul><li>pod 创建过程</li><li>运行初始化容器（init container）过程</li><li>运行主容器（main container）<ul><li>容器启动后钩子（post start）、容器终止前钩子（pre stop）</li><li>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</li></ul></li><li>pod 终止过程</li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200412111402706-1626782188724.png" alt="image-20200412111402706"></p><p>在整个生命周期中，Pod 会出现 5 种<strong>状态</strong>（<strong>相位</strong>），分别如下：</p><ul><li>挂起（Pending）：apiserver 已经创建了 pod 资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</li><li>运行中（Running）：pod 已经被调度至某节点，并且所有容器都已经被 kubelet 创建完成</li><li>成功（Succeeded）：pod 中的所有容器都已经成功终止并且不会被重启</li><li>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非 0 值的退出状态</li><li>未知（Unknown）：apiserver 无法正常获取到 pod 对象的状态信息，通常由网络通信失败所导致</li></ul><h5 id="531-创建和终止"><a class="anchor" href="#531-创建和终止">#</a> 5.3.1 创建和终止</h5><p><strong>pod 的创建过程</strong></p><ol><li><p>用户通过 kubectl 或其他 api 客户端提交需要创建的 pod 信息给 apiServer</p></li><li><p>apiServer 开始生成 pod 对象的信息，并将信息存入 etcd，然后返回确认信息至客户端</p></li><li><p>apiServer 开始反映 etcd 中的 pod 对象的变化，其它组件使用 watch 机制来跟踪检查 apiServer 上的变动</p></li><li><p>scheduler 发现有新的 pod 对象要创建，开始为 Pod 分配主机并将结果信息更新至 apiServer</p></li><li><p>node 节点上的 kubelet 发现有 pod 调度过来，尝试调用 docker 启动容器，并将结果回送至 apiServer</p></li><li><p>apiServer 将接收到的 pod 状态信息存入 etcd 中</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200406184656917-1626782168787.png" alt="image-20200406184656917"></p></li></ol><p><strong>pod 的终止过程</strong></p><ol><li>用户向 apiServer 发送删除 pod 对象的命令</li><li>apiServcer 中的 pod 对象信息会随着时间的推移而更新，在宽限期内（默认 30s），pod 被视为 dead</li><li>将 pod 标记为 terminating 状态</li><li>kubelet 在监控到 pod 对象转为 terminating 状态的同时启动 pod 关闭过程</li><li>端点控制器监控到 pod 对象的关闭行为时将其从所有匹配到此端点的 service 资源的端点列表中移除</li><li>如果当前 pod 对象定义了 preStop 钩子处理器，则在其标记为 terminating 后即会以同步的方式启动执行</li><li>pod 对象中的容器进程收到停止信号</li><li>宽限期结束后，若 pod 中还存在仍在运行的进程，那么 pod 对象会收到立即终止的信号</li><li>kubelet 请求 apiServer 将此 pod 资源的宽限期设置为 0 从而完成删除操作，此时 pod 对于用户已不可见</li></ol><h5 id="532-初始化容器"><a class="anchor" href="#532-初始化容器">#</a> 5.3.2 初始化容器</h5><p>初始化容器是在 pod 的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p><ol><li>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么 kubernetes 需要重启它直到成功完成</li><li>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</li></ol><p>初始化容器有很多的应用场景，下面列出的是最常见的几个：</p><ul><li>提供主容器镜像中不具备的工具程序或自定义代码</li><li>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</li></ul><p>接下来做一个案例，模拟下面这个需求：</p><p>假设要以主容器来运行 nginx，但是要求在运行 nginx 之前先要能够连接上 mysql 和 redis 所在服务器</p><p>为了简化测试，事先规定好 mysql <code>(192.168.90.14)</code> 和 redis <code>(192.168.90.15)</code> 服务器的地址</p><p>创建 pod-initcontainer.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>initcontainer</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>container</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>mysql</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'until ping 192.168.90.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>redis</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'until ping 192.168.90.15 -c 1 ; do echo waiting for reids...; sleep 2; done;'</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-initcontainer.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>initcontainer created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod 状态</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 发现 pod 卡在启动第一个初始化容器过程中，后面的容器不会运行</span></pre></td></tr><tr><td data-num="7"></td><td><pre>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod  pod-initcontainer -n dev</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span>..</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">Events</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  Type    Reason     Age   From               Message</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">---</span><span class="token punctuation">-</span>    <span class="token punctuation">---</span><span class="token punctuation">---</span>     <span class="token punctuation">---</span><span class="token punctuation">-</span>  <span class="token punctuation">---</span><span class="token punctuation">-</span>               <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  Normal  Scheduled  49s   default<span class="token punctuation">-</span>scheduler  Successfully assigned dev/pod<span class="token punctuation">-</span>initcontainer to node1</pre></td></tr><tr><td data-num="13"></td><td><pre>  Normal  Pulled     48s   kubelet<span class="token punctuation">,</span> node1     Container image "busybox<span class="token punctuation">:</span>1.30" already present on machine</pre></td></tr><tr><td data-num="14"></td><td><pre>  Normal  Created    48s   kubelet<span class="token punctuation">,</span> node1     Created container test<span class="token punctuation">-</span>mysql</pre></td></tr><tr><td data-num="15"></td><td><pre>  Normal  Started    48s   kubelet<span class="token punctuation">,</span> node1     Started container test<span class="token punctuation">-</span>mysql</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 动态查看 pod</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-initcontainer -n dev -w</span></pre></td></tr><tr><td data-num="19"></td><td><pre>NAME                             READY   STATUS     RESTARTS   AGE</pre></td></tr><tr><td data-num="20"></td><td><pre>pod<span class="token punctuation">-</span>initcontainer                0/1     Init<span class="token punctuation">:</span>0/2   0          15s</pre></td></tr><tr><td data-num="21"></td><td><pre>pod<span class="token punctuation">-</span>initcontainer                0/1     Init<span class="token punctuation">:</span>1/2   0          52s</pre></td></tr><tr><td data-num="22"></td><td><pre>pod<span class="token punctuation">-</span>initcontainer                0/1     Init<span class="token punctuation">:</span>1/2   0          53s</pre></td></tr><tr><td data-num="23"></td><td><pre>pod<span class="token punctuation">-</span>initcontainer                0/1     PodInitializing   0          89s</pre></td></tr><tr><td data-num="24"></td><td><pre>pod<span class="token punctuation">-</span>initcontainer                1/1     Running           0          90s</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 接下来新开一个 shell，为当前服务器新增两个 ip，观察 pod 的变化</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># ifconfig ens33:1 192.168.90.14 netmask 255.255.255.0 up</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># ifconfig ens33:2 192.168.90.15 netmask 255.255.255.0 up</span></pre></td></tr></table></figure><h5 id="533-钩子函数"><a class="anchor" href="#533-钩子函数">#</a> 5.3.3 钩子函数</h5><p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</p><p>kubernetes 在主容器的启动之后和停止之前提供了两个钩子函数：</p><ul><li>post start：容器创建之后执行，如果失败了会重启容器</li><li>pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</li></ul><p>钩子处理器支持使用下面三种方式定义动作：</p><ul><li><p>Exec 命令：在容器内执行一次命令</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>……</pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">postStart</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">exec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">-</span> cat</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">-</span> /tmp/healthy</pre></td></tr><tr><td data-num="8"></td><td><pre>……</pre></td></tr></table></figure></li><li><p>TCPSocket：在当前容器尝试访问指定的 socket</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>……      </pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">postStart</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></td></tr><tr><td data-num="6"></td><td><pre>……</pre></td></tr></table></figure></li><li><p>HTTPGet：在当前容器中向某 url 发起 http 请求</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>……</pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">postStart</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI 地址</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.5.3 <span class="token comment">#主机地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http 或者 https</span></pre></td></tr><tr><td data-num="9"></td><td><pre>……</pre></td></tr></table></figure></li></ul><p>接下来，以 exec 方式为例，演示下钩子函数的使用，创建 pod-hook-exec.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>exec</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>container</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">postStart</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">exec</span><span class="token punctuation">:</span> <span class="token comment"># 在容器启动的时候执行一个命令，修改掉 nginx 的默认首页内容</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo postStart... > /usr/share/nginx/html/index.html"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">preStop</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">exec</span><span class="token punctuation">:</span> <span class="token comment"># 在容器停止之前停止 nginx 服务</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/usr/sbin/nginx"</span><span class="token punctuation">,</span><span class="token string">"-s"</span><span class="token punctuation">,</span><span class="token string">"quit"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-hook-exec.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>exec created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods  pod-hook-exec -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME           READY   STATUS     RESTARTS   AGE    IP            NODE    </pre></td></tr><tr><td data-num="8"></td><td><pre>pod<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>exec  1/1     Running    0          29s    10.244.2.48   node2   </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 访问 pod</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.48</span></pre></td></tr><tr><td data-num="12"></td><td><pre>postStart<span class="token punctuation">...</span></pre></td></tr></table></figure><h5 id="534-容器探测"><a class="anchor" href="#534-容器探测">#</a> 5.3.4 容器探测</h5><p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么 kubernetes 就会把该问题实例 &quot;摘除&quot;，不承担业务流量。kubernetes 提供了两种探针来实现容器探测，分别是：</p><ul><li>liveness probes：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s 会重启容器</li><li>readiness probes：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s 不会转发流量</li></ul><blockquote><p>livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</p></blockquote><p>上面两种探针目前均支持三种探测方式：</p><ul><li><p>Exec 命令：在容器内执行一次命令，如果命令执行的退出码为 0，则认为程序正常，否则不正常</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>……</pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">exec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">command</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token punctuation">-</span> cat</pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">-</span> /tmp/healthy</pre></td></tr><tr><td data-num="7"></td><td><pre>……</pre></td></tr></table></figure></li><li><p>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>……      </pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></td></tr><tr><td data-num="5"></td><td><pre>……</pre></td></tr></table></figure></li><li><p>HTTPGet：调用容器内 Web 应用的 URL，如果返回的状态码在 200 和 399 之间，则认为程序正常，否则不正常</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre>……</pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI 地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1 <span class="token comment">#主机地址</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http 或者 https</span></pre></td></tr><tr><td data-num="8"></td><td><pre>……</pre></td></tr></table></figure></li></ul><p>下面以 liveness probes 为例，做几个演示：</p><p><strong>方式一：Exec</strong></p><p>创建 pod-liveness-exec.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>exec</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">exec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/cat"</span><span class="token punctuation">,</span><span class="token string">"/tmp/hello.txt"</span><span class="token punctuation">]</span> <span class="token comment"># 执行一个查看文件的命令</span></pre></td></tr></table></figure><p>创建 pod，观察效果</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-liveness-exec.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>exec created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-liveness-exec -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Normal   Created    20s (x2 over 50s)  kubelet<span class="token punctuation">,</span> node1     Created container nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>  Normal   Started    20s (x2 over 50s)  kubelet<span class="token punctuation">,</span> node1     Started container nginx</pre></td></tr><tr><td data-num="10"></td><td><pre>  Normal   Killing    20s                kubelet<span class="token punctuation">,</span> node1     Container nginx failed liveness probe<span class="token punctuation">,</span> will be restarted</pre></td></tr><tr><td data-num="11"></td><td><pre>  Warning  Unhealthy  0s (x5 over 40s)   kubelet<span class="token punctuation">,</span> <span class="token key atrule">node1     Liveness probe failed</span><span class="token punctuation">:</span> <span class="token key atrule">cat</span><span class="token punctuation">:</span> <span class="token key atrule">can't open '/tmp/hello11.txt'</span><span class="token punctuation">:</span> No such file or directory</pre></td></tr><tr><td data-num="12"></td><td><pre>  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 观察上面的信息就会发现 nginx 容器启动之后就进行了健康检查</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 检查失败之后，容器被 kill 掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 稍等一会之后，再观察 pod 信息，就可以看到 RESTARTS 不再是 0，而是一直增长</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-liveness-exec -n dev</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME                READY   STATUS             RESTARTS   AGE</pre></td></tr><tr><td data-num="18"></td><td><pre>pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>exec   0/1     CrashLoopBackOff   2          3m19s</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 当然接下来，可以修改成一个存在的文件，比如 /tmp/hello.txt，再试，结果就正常了......</span></pre></td></tr></table></figure><p><strong>方式二：TCPSocket</strong></p><p>创建 pod-liveness-tcpsocket.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>tcpsocket</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment"># 尝试访问 8080 端口</span></pre></td></tr></table></figure><p>创建 pod，观察效果</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-liveness-tcpsocket.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>tcpsocket created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-liveness-tcpsocket -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Normal   Scheduled  31s                            default<span class="token punctuation">-</span>scheduler  Successfully assigned dev/pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>tcpsocket to node2</pre></td></tr><tr><td data-num="9"></td><td><pre>  Normal   Pulled     &lt;invalid<span class="token punctuation">></span>                      kubelet<span class="token punctuation">,</span> node2     Container image "nginx<span class="token punctuation">:</span>1.17.1" already present on machine</pre></td></tr><tr><td data-num="10"></td><td><pre>  Normal   Created    &lt;invalid<span class="token punctuation">></span>                      kubelet<span class="token punctuation">,</span> node2     Created container nginx</pre></td></tr><tr><td data-num="11"></td><td><pre>  Normal   Started    &lt;invalid<span class="token punctuation">></span>                      kubelet<span class="token punctuation">,</span> node2     Started container nginx</pre></td></tr><tr><td data-num="12"></td><td><pre>  Warning  Unhealthy  &lt;invalid<span class="token punctuation">></span> (x2 over &lt;invalid<span class="token punctuation">></span>)  kubelet<span class="token punctuation">,</span> <span class="token key atrule">node2     Liveness probe failed</span><span class="token punctuation">:</span> <span class="token key atrule">dial tcp 10.244.2.44:8080</span><span class="token punctuation">:</span> <span class="token key atrule">connect</span><span class="token punctuation">:</span> connection refused</pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 观察上面的信息，发现尝试访问 8080 端口，但是失败了</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 稍等一会之后，再观察 pod 信息，就可以看到 RESTARTS 不再是 0，而是一直增长</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-liveness-tcpsocket  -n dev</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME                     READY   STATUS             RESTARTS   AGE</pre></td></tr><tr><td data-num="18"></td><td><pre>pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>tcpsocket   0/1     CrashLoopBackOff   2          3m19s</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 当然接下来，可以修改成一个可以访问的端口，比如 80，再试，结果就正常了......</span></pre></td></tr></table></figure><p><strong>方式三：HTTPGet</strong></p><p>创建 pod-liveness-httpget.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>httpget</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>  <span class="token comment"># 其实就是访问 http://127.0.0.1:80/hello  </span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http 或者 https</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /hello <span class="token comment">#URI 地址</span></pre></td></tr></table></figure><p>创建 pod，观察效果</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-liveness-httpget.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>httpget created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-liveness-httpget -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre>  Normal   Pulled     6s (x3 over 64s)  kubelet<span class="token punctuation">,</span> node1     Container image "nginx<span class="token punctuation">:</span>1.17.1" already present on machine</pre></td></tr><tr><td data-num="9"></td><td><pre>  Normal   Created    6s (x3 over 64s)  kubelet<span class="token punctuation">,</span> node1     Created container nginx</pre></td></tr><tr><td data-num="10"></td><td><pre>  Normal   Started    6s (x3 over 63s)  kubelet<span class="token punctuation">,</span> node1     Started container nginx</pre></td></tr><tr><td data-num="11"></td><td><pre>  Warning  Unhealthy  6s (x6 over 56s)  kubelet<span class="token punctuation">,</span> <span class="token key atrule">node1     Liveness probe failed</span><span class="token punctuation">:</span> <span class="token key atrule">HTTP probe failed with statuscode</span><span class="token punctuation">:</span> <span class="token number">404</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  Normal   Killing    6s (x2 over 36s)  kubelet<span class="token punctuation">,</span> node1     Container nginx failed liveness probe<span class="token punctuation">,</span> will be restarted</pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 观察上面信息，尝试访问路径，但是未找到，出现 404 错误</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 稍等一会之后，再观察 pod 信息，就可以看到 RESTARTS 不再是 0，而是一直增长</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-liveness-httpget -n dev</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME                   READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="18"></td><td><pre>pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>httpget   1/1     Running   5          3m17s</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 当然接下来，可以修改成一个可以访问的路径 path，比如 /，再试，结果就正常了......</span></pre></td></tr></table></figure><p>至此，已经使用 liveness Probe 演示了三种探测方式，但是查看 livenessProbe 的子属性，会发现除了这三种方式，还有一些其他的配置，在这里一并解释下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers.livenessProbe</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">FIELDS</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   exec &lt;Object<span class="token punctuation">></span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>   tcpSocket    &lt;Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>   httpGet      &lt;Object<span class="token punctuation">></span></pre></td></tr><tr><td data-num="6"></td><td><pre>   initialDelaySeconds  &lt;integer<span class="token punctuation">></span>  <span class="token comment"># 容器启动后等待多少秒执行第一次探测</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   timeoutSeconds       &lt;integer<span class="token punctuation">></span>  <span class="token comment"># 探测超时时间。默认 1 秒，最小 1 秒</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   periodSeconds        &lt;integer<span class="token punctuation">></span>  <span class="token comment"># 执行探测的频率。默认是 10 秒，最小 1 秒</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   failureThreshold     &lt;integer<span class="token punctuation">></span>  <span class="token comment"># 连续探测失败多少次才被认定为失败。默认是 3。最小值是 1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   successThreshold     &lt;integer<span class="token punctuation">></span>  <span class="token comment"># 连续探测成功多少次才被认定为成功。默认是 1</span></pre></td></tr></table></figure><p>下面稍微配置两个，演示下效果即可：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># more pod-liveness-httpget.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>httpget</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment"># 容器启动后 30s 开始探测</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 探测超时时间为 5s</span></pre></td></tr></table></figure><h5 id="535-重启策略"><a class="anchor" href="#535-重启策略">#</a> 5.3.5 重启策略</h5><p>在上一节中，一旦容器探测出现了问题，kubernetes 就会对容器所在的 Pod 进行重启，其实这是由 pod 的重启策略决定的，pod 的重启策略有 3 种，分别如下：</p><ul><li>Always ：容器失效时，自动重启该容器，这也是默认值。</li><li>OnFailure ： 容器终止运行且退出码不为 0 时重启</li><li>Never ： 不论状态为何，都不重启该容器</li></ul><p>重启策略适用于 pod 对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由 kubelet 延迟一段时间后进行，且反复的重启操作的延迟时长以此为 10s、20s、40s、80s、160s 和 300s，300s 是最大延迟时长。</p><p>创建 pod-restartpolicy.yaml：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restartpolicy</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /hello</pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 设置重启策略为 Never</span></pre></td></tr></table></figure><p>运行 Pod 测试</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-restartpolicy.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>restartpolicy created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod 详情，发现 nginx 容器失败</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  describe pods pod-restartpolicy  -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Warning  Unhealthy  15s (x3 over 35s)  kubelet<span class="token punctuation">,</span> <span class="token key atrule">node1     Liveness probe failed</span><span class="token punctuation">:</span> <span class="token key atrule">HTTP probe failed with statuscode</span><span class="token punctuation">:</span> <span class="token number">404</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  Normal   Killing    15s                kubelet<span class="token punctuation">,</span> node1     Container nginx failed liveness probe</pre></td></tr><tr><td data-num="10"></td><td><pre>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 多等一会，再观察 pod 的重启次数，发现一直是 0，并未重启   </span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get pods pod-restartpolicy -n dev</span></pre></td></tr><tr><td data-num="13"></td><td><pre>NAME                   READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="14"></td><td><pre>pod<span class="token punctuation">-</span>restartpolicy      0/1     Running   0          5min42s</pre></td></tr></table></figure><h4 id="54-pod调度"><a class="anchor" href="#54-pod调度">#</a> 5.4 Pod 调度</h4><p>在默认情况下，一个 Pod 在哪个 Node 节点上运行，是由 Scheduler 组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些 Pod 到达某些节点上，那么应该怎么做呢？这就要求了解 kubernetes 对 Pod 的调度规则，kubernetes 提供了四大类调度方式：</p><ul><li>自动调度：运行在哪个节点上完全由 Scheduler 经过一系列的算法计算得出</li><li>定向调度：NodeName、NodeSelector</li><li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li><li>污点（容忍）调度：Taints、Toleration</li></ul><h5 id="541-定向调度"><a class="anchor" href="#541-定向调度">#</a> 5.4.1 定向调度</h5><p>定向调度，指的是利用在 pod 上声明 nodeName 或者 nodeSelector，以此将 Pod 调度到期望的 node 节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标 Node 不存在，也会向上面进行调度，只不过 pod 运行失败而已。</p><p><strong>NodeName</strong></p><p>NodeName 用于强制约束将 Pod 调度到指定的 Name 的 Node 节点上。这种方式，其实是直接跳过 Scheduler 的调度逻辑，直接将 Pod 调度到指定名称的节点。</p><p>接下来，实验一下：创建一个 pod-nodename.yaml 文件</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodename</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node1 <span class="token comment"># 指定调度到 node1 节点上</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodename.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>nodename created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#查看 Pod 调度到 NODE 属性，确实是调度到了 node1 节点上</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodename -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      <span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="8"></td><td><pre>pod<span class="token punctuation">-</span>nodename   1/1     Running   0          56s   10.244.1.87   node1     <span class="token punctuation">...</span><span class="token punctuation">...</span>   </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 接下来，删除 pod，修改 nodeName 的值为 node3（并没有 node3 节点）</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pod-nodename.yaml</span></pre></td></tr><tr><td data-num="12"></td><td><pre>pod "pod<span class="token punctuation">-</span>nodename" deleted</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-nodename.yaml</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodename.yaml</span></pre></td></tr><tr><td data-num="15"></td><td><pre>pod/pod<span class="token punctuation">-</span>nodename created</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#再次查看，发现已经向 Node3 节点调度，但是由于不存在 node3 节点，所以 pod 无法正常运行</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodename -n dev -o wide</span></pre></td></tr><tr><td data-num="19"></td><td><pre>NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    <span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="20"></td><td><pre>pod<span class="token punctuation">-</span>nodename   0/1     Pending   0          6s    &lt;none<span class="token punctuation">></span>   node3   <span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr></table></figure><p><strong>NodeSelector</strong></p><p>NodeSelector 用于将 pod 调度到添加了指定标签的 node 节点上。它是通过 kubernetes 的 label-selector 机制实现的，也就是说，在 pod 创建之前，会由 scheduler 使用 MatchNodeSelector 调度策略进行 label 匹配，找出目标 node，然后将 pod 调度到目标节点，该匹配规则是强制约束。</p><p>接下来，实验一下：</p><p>1 首先分别为 node 节点添加标签</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label nodes node1 nodeenv=pro</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node/node2 labeled</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label nodes node2 nodeenv=test</span></pre></td></tr><tr><td data-num="4"></td><td><pre>node/node2 labeled</pre></td></tr></table></figure><p>2 创建一个 pod-nodeselector.yaml 文件，并使用它创建 Pod</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeselector</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">nodeenv</span><span class="token punctuation">:</span> pro <span class="token comment"># 指定调度到具有 nodeenv=pro 标签的节点上</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>nodeselector created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#查看 Pod 调度到 NODE 属性，确实是调度到了 node1 节点上</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodeselector -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    <span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="8"></td><td><pre>pod<span class="token punctuation">-</span>nodeselector   1/1     Running   0          47s   10.244.1.87   node1   <span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 接下来，删除 pod，修改 nodeSelector 的值为 nodeenv: xxxx（不存在打有此标签的节点）</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num="12"></td><td><pre>pod "pod<span class="token punctuation">-</span>nodeselector" deleted</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num="15"></td><td><pre>pod/pod<span class="token punctuation">-</span>nodeselector created</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#再次查看，发现 pod 无法正常运行，Node 的值为 none</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="19"></td><td><pre>NAME               READY   STATUS    RESTARTS   AGE     IP       NODE    </pre></td></tr><tr><td data-num="20"></td><td><pre>pod<span class="token punctuation">-</span>nodeselector   0/1     Pending   0          2m20s   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 查看详情，发现 node selector 匹配失败的提示</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-nodeselector -n dev</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span>.</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">Events</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  Type     Reason            Age        From               Message</pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">---</span><span class="token punctuation">-</span>     <span class="token punctuation">---</span><span class="token punctuation">---</span>            <span class="token punctuation">---</span><span class="token punctuation">-</span>       <span class="token punctuation">---</span><span class="token punctuation">-</span>               <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token key atrule">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class="token punctuation">:</span> 3 node(s) didn't match node selector.</pre></td></tr></table></figure><h5 id="542-亲和性调度"><a class="anchor" href="#542-亲和性调度">#</a> 5.4.2 亲和性调度</h5><p>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的 Node，那么 Pod 将不会被运行，即使在集群中还有可用 Node 列表也不行，这就限制了它的使用场景。</p><p>基于上面的问题，kubernetes 还提供了一种亲和性调度（Affinity）。它在 NodeSelector 的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的 Node 进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</p><p>Affinity 主要分为三类：</p><ul><li>nodeAffinity (node 亲和性）: 以 node 为目标，解决 pod 可以调度到哪些 node 的问题</li><li>podAffinity (pod 亲和性) : 以 pod 为目标，解决 pod 可以和哪些已存在的 pod 部署在同一个拓扑域中的问题</li><li>podAntiAffinity (pod 反亲和性) : 以 pod 为目标，解决 pod 不能和哪些已存在 pod 部署在同一个拓扑域中的问题</li></ul><blockquote><p>关于亲和性 (反亲和性) 使用场景的说明：</p><p><strong>亲和性</strong>：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</p><p><strong>反亲和性</strong>：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个 node 上，这样可以提高服务的高可用性。</p></blockquote><p><strong>NodeAffinity</strong></p><p>首先来看一下 <code>NodeAffinity</code> 的可配置项：</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>pod.spec.affinity.nodeAffinity</pre></td></tr><tr><td data-num="2"></td><td><pre>  requiredDuringSchedulingIgnoredDuringExecution  Node节点必须满足指定的所有规则才可以，相当于硬限制</pre></td></tr><tr><td data-num="3"></td><td><pre>    nodeSelectorTerms  节点选择列表</pre></td></tr><tr><td data-num="4"></td><td><pre>      matchFields   按节点字段列出的节点选择器要求列表</pre></td></tr><tr><td data-num="5"></td><td><pre>      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</pre></td></tr><tr><td data-num="6"></td><td><pre>        key    键</pre></td></tr><tr><td data-num="7"></td><td><pre>        values 值</pre></td></tr><tr><td data-num="8"></td><td><pre>        operat or 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</pre></td></tr><tr><td data-num="9"></td><td><pre>  preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 (倾向)</pre></td></tr><tr><td data-num="10"></td><td><pre>    preference   一个节点选择器项，与相应的权重相关联</pre></td></tr><tr><td data-num="11"></td><td><pre>      matchFields   按节点字段列出的节点选择器要求列表</pre></td></tr><tr><td data-num="12"></td><td><pre>      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</pre></td></tr><tr><td data-num="13"></td><td><pre>        key    键</pre></td></tr><tr><td data-num="14"></td><td><pre>        values 值</pre></td></tr><tr><td data-num="15"></td><td><pre>        operator 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt</pre></td></tr><tr><td data-num="16"></td><td><pre>	weight 倾向权重，在范围1-100。</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">关系符的使用说明</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv              <span class="token comment"># 匹配存在标签的 key 为 nodeenv 的节点</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv              <span class="token comment"># 匹配标签的 key 为 nodeenv, 且 value 是 "xxx" 或 "yyy" 的节点</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"xxx"</span><span class="token punctuation">,</span><span class="token string">"yyy"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv              <span class="token comment"># 匹配标签的 key 为 nodeenv, 且 value 大于 "xxx" 的节点</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Gt</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span></pre></td></tr></table></figure><p>接下来首先演示一下 <code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p><p>创建 pod-nodeaffinity-required.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置 node 亲和性</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配 env 的值在 ["xxx","yyy"] 中的标签</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv</pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"xxx"</span><span class="token punctuation">,</span><span class="token string">"yyy"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod 状态 （运行失败）</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    <span class="token punctuation">...</span><span class="token punctuation">...</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required   0/1     Pending   0          16s   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>  <span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 Pod 的详情</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 发现调度失败，提示 node 选择失败</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-nodeaffinity-required -n dev</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class="token punctuation">:</span> 3 node(s) didn't match node selector.</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class="token punctuation">:</span> 3 node(s) didn't match node selector.</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#接下来，停止 pod</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num="19"></td><td><pre>pod "pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required" deleted</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 修改文件，将 values: ["xxx","yyy"]------> ["pro","yyy"]</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># 再次启动</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num="26"></td><td><pre>pod/pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required created</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 此时查看，发现调度成功，已经将 pod 调度到了 node1 上</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></pre></td></tr><tr><td data-num="30"></td><td><pre>NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  <span class="token punctuation">...</span><span class="token punctuation">...</span> </pre></td></tr><tr><td data-num="31"></td><td><pre>pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required   1/1     Running   0          11s   10.244.1.89   node1 <span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr></table></figure><p>接下来再演示一下 <code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p><p>创建 pod-nodeaffinity-preferred.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>preferred</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置 node 亲和性</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 软限制</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">preference</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配 env 的值在 ["xxx","yyy"] 中的标签 (当前环境没有)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv</pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"xxx"</span><span class="token punctuation">,</span><span class="token string">"yyy"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeaffinity-preferred.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>preferred created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod 状态 （运行成功）</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodeaffinity-preferred -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                         READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>preferred   1/1     Running   0          40s</pre></td></tr></table></figure><pre><code>NodeAffinity规则设置的注意事项：
    1 如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上
    2 如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可
    3 如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功
    4 如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化
</code></pre><p><strong>PodAffinity</strong></p><p>PodAffinity 主要实现以运行的 Pod 为参照，实现让新创建的 Pod 跟参照 pod 在一个区域的功能。</p><p>首先来看一下 <code>PodAffinity</code> 的可配置项：</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>pod.spec.affinity.podAffinity</pre></td></tr><tr><td data-num="2"></td><td><pre>  requiredDuringSchedulingIgnoredDuringExecution  硬限制</pre></td></tr><tr><td data-num="3"></td><td><pre>    namespaces       指定参照pod的namespace</pre></td></tr><tr><td data-num="4"></td><td><pre>    topologyKey      指定调度作用域</pre></td></tr><tr><td data-num="5"></td><td><pre>    labelSelector    标签选择器</pre></td></tr><tr><td data-num="6"></td><td><pre>      matchExpressions  按节点标签列出的节点选择器要求列表(推荐)</pre></td></tr><tr><td data-num="7"></td><td><pre>        key    键</pre></td></tr><tr><td data-num="8"></td><td><pre>        values 值</pre></td></tr><tr><td data-num="9"></td><td><pre>        operator 关系符 支持In, NotIn, Exists, DoesNotExist.</pre></td></tr><tr><td data-num="10"></td><td><pre>      matchLabels    指多个matchExpressions映射的内容</pre></td></tr><tr><td data-num="11"></td><td><pre>  preferredDuringSchedulingIgnoredDuringExecution 软限制</pre></td></tr><tr><td data-num="12"></td><td><pre>    podAffinityTerm  选项</pre></td></tr><tr><td data-num="13"></td><td><pre>      namespaces      </pre></td></tr><tr><td data-num="14"></td><td><pre>      topologyKey</pre></td></tr><tr><td data-num="15"></td><td><pre>      labelSelector</pre></td></tr><tr><td data-num="16"></td><td><pre>        matchExpressions  </pre></td></tr><tr><td data-num="17"></td><td><pre>          key    键</pre></td></tr><tr><td data-num="18"></td><td><pre>          values 值</pre></td></tr><tr><td data-num="19"></td><td><pre>          operator</pre></td></tr><tr><td data-num="20"></td><td><pre>        matchLabels </pre></td></tr><tr><td data-num="21"></td><td><pre>    weight 倾向权重，在范围1-100</pre></td></tr></table></figure><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>topologyKey用于指定调度时作用域,例如:</pre></td></tr><tr><td data-num="2"></td><td><pre>    如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围</pre></td></tr><tr><td data-num="3"></td><td><pre>	如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</pre></td></tr></table></figure><p>接下来，演示下 <code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p><p>1）首先创建一个参照 Pod，pod-podaffinity-target.yaml：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>target</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">podenv</span><span class="token punctuation">:</span> pro <span class="token comment">#设置标签</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node1 <span class="token comment"># 将目标 pod 名确指定到 node1 上</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 启动目标 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podaffinity-target.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod-podaffinity-target created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod 状况</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods  pod-podaffinity-target -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                     READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pod-podaffinity-target   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4s</pre></td></tr></table></figure><p>2）创建 pod-podaffinity-required.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置 pod 亲和性</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配 env 的值在 ["xxx","yyy"] 中的标签</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv</pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"xxx"</span><span class="token punctuation">,</span><span class="token string">"yyy"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></td></tr></table></figure><p>上面配置表达的意思是：新 Pod 必须要与拥有标签 nodeenv=xxx 或者 nodeenv=yyy 的 pod 在同一 Node 上，显然现在没有这样 pod，接下来，运行测试一下。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 启动 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod 状态，发现未运行</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-podaffinity-required -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required   0/1     Pending   0          9s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看详细信息</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-podaffinity-required  -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">Events</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  Type     Reason            Age        From               Message</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">---</span><span class="token punctuation">-</span>     <span class="token punctuation">---</span><span class="token punctuation">---</span>            <span class="token punctuation">---</span><span class="token punctuation">-</span>       <span class="token punctuation">---</span><span class="token punctuation">-</span>               <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class="token punctuation">:</span> 2 node(s) didn't match pod affinity rules<span class="token punctuation">,</span> 1 node(s) had taints that the pod didn't tolerate.</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 接下来修改  values: ["xxx","yyy"]----->values:["pro","yyy"]</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 意思是：新 Pod 必须要与拥有标签 nodeenv=xxx 或者 nodeenv=yyy 的 pod 在同一 Node 上</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 然后重新创建 pod，查看效果</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f  pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num="24"></td><td><pre>pod "pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required" de leted</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num="26"></td><td><pre>pod/pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required created</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 发现此时 Pod 运行正常</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-podaffinity-required -n dev</span></pre></td></tr><tr><td data-num="30"></td><td><pre>NAME                       READY   STATUS    RESTARTS   AGE   LABELS</pre></td></tr><tr><td data-num="31"></td><td><pre>pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required   1/1     Running   0          6s    &lt;none<span class="token punctuation">></span></pre></td></tr></table></figure><p>关于 <code>PodAffinity</code> 的 <code>preferredDuringSchedulingIgnoredDuringExecution</code> ，这里不再演示。</p><p><strong>PodAntiAffinity</strong></p><p>PodAntiAffinity 主要实现以运行的 Pod 为参照，让新创建的 Pod 跟参照 pod 不在一个区域中的功能。</p><p>它的配置方式和选项跟 PodAffinty 是一样的，这里不再做详细解释，直接做一个测试案例。</p><p>1）继续使用上个案例中目标 pod</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide --show-labels</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS</pre></td></tr><tr><td data-num="3"></td><td><pre>pod-podaffinity-required <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m29s   <span class="token number">10.244</span>.1.38   node1   <span class="token operator">&lt;</span>none<span class="token operator">></span>     </pre></td></tr><tr><td data-num="4"></td><td><pre>pod-podaffinity-target   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m25s   <span class="token number">10.244</span>.1.37   node1   <span class="token assign-left variable">podenv</span><span class="token operator">=</span>pro</pre></td></tr></table></figure><p>2）创建 pod-podantiaffinity-required.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podantiaffinity<span class="token punctuation">-</span>required</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置 pod 亲和性</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配 podenv 的值在 ["pro"] 中的标签</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv</pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pro"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></td></tr></table></figure><p>上面配置表达的意思是：新 Pod 必须要与拥有标签 nodeenv=pro 的 pod 不在同一 Node 上，运行测试一下。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podantiaffinity-required.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod<span class="token punctuation">-</span>podantiaffinity<span class="token punctuation">-</span>required created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 发现调度到了 node2 上</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-podantiaffinity-required -n dev -o wide</span></pre></td></tr><tr><td data-num="8"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   .. </pre></td></tr><tr><td data-num="9"></td><td><pre>pod<span class="token punctuation">-</span>podantiaffinity<span class="token punctuation">-</span>required   1/1     Running   0          30s   10.244.1.96   node2  ..</pre></td></tr></table></figure><h5 id="543-污点和容忍"><a class="anchor" href="#543-污点和容忍">#</a> 5.4.3 污点和容忍</h5><p><strong>污点（Taints）</strong></p><p>前面的调度方式都是站在 Pod 的角度上，通过在 Pod 上添加属性，来确定 Pod 是否要调度到指定的 Node 上，其实我们也可以站在 Node 的角度上，通过在 Node 上添加<strong>污点</strong>属性，来决定是否允许 Pod 调度过来。</p><p>Node 被设置上污点之后就和 Pod 之间存在了一种相斥的关系，进而拒绝 Pod 调度进来，甚至可以将已经存在的 Pod 驱逐出去。</p><p>污点的格式为： <code>key=value:effect</code> , key 和 value 是污点的标签，effect 描述污点的作用，支持如下三个选项：</p><ul><li>PreferNoSchedule：kubernetes 将尽量避免把 Pod 调度到具有该污点的 Node 上，除非没有其他节点可调度</li><li>NoSchedule：kubernetes 将不会把 Pod 调度到具有该污点的 Node 上，但不会影响当前 Node 上已存在的 Pod</li><li>NoExecute：kubernetes 将不会把 Pod 调度到具有该污点的 Node 上，同时也会将 Node 上已存在的 Pod 驱离</li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200605021831545.png" alt="image-20200605021606508"></p><p>使用 kubectl 设置和去除污点的命令示例如下：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 设置污点</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl taint nodes node1 <span class="token assign-left variable">key</span><span class="token operator">=</span>value:effect</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 去除污点</span></pre></td></tr><tr><td data-num="5"></td><td><pre>kubectl taint nodes node1 key:effect-</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 去除所有污点</span></pre></td></tr><tr><td data-num="8"></td><td><pre>kubectl taint nodes node1 key-</pre></td></tr></table></figure><p>接下来，演示下污点的效果：</p><ol><li>准备节点 node1（为了演示效果更加明显，暂时停止 node2 节点）</li><li>为 node1 节点设置一个污点: <code>tag=heima:PreferNoSchedule</code> ；然后创建 pod1 (pod1 可以)</li><li>修改为 node1 节点设置一个污点: <code>tag=heima:NoSchedule</code> ；然后创建 pod2 (pod1 正常 pod2 失败)</li><li>修改为 node1 节点设置一个污点: <code>tag=heima:NoExecute</code> ；然后创建 pod3 (3 个 pod 都失败)</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 为 node1 设置污点 (PreferNoSchedule)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag=heima:PreferNoSchedule</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 创建 pod1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run taint1 --image=nginx:1.17.1 -n dev</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE   </pre></td></tr><tr><td data-num="8"></td><td><pre>taint1<span class="token punctuation">-</span>7665f7fd85<span class="token punctuation">-</span>574h4   1/1     Running   0          2m24s   10.244.1.59   node1    </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 为 node1 设置污点 (取消 PreferNoSchedule，设置 NoSchedule)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag:PreferNoSchedule-</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag=heima:NoSchedule</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 创建 pod2</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run taint2 --image=nginx:1.17.1 -n dev</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods taint2 -n dev -o wide</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE</pre></td></tr><tr><td data-num="18"></td><td><pre>taint1<span class="token punctuation">-</span>7665f7fd85<span class="token punctuation">-</span>574h4   1/1     Running   0          2m24s   10.244.1.59   node1 </pre></td></tr><tr><td data-num="19"></td><td><pre>taint2<span class="token punctuation">-</span>544694789<span class="token punctuation">-</span>6zmlf    0/1     Pending   0          21s     &lt;none<span class="token punctuation">></span>        &lt;none<span class="token punctuation">></span>   </pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 为 node1 设置污点 (取消 NoSchedule，设置 NoExecute)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag:NoSchedule-</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag=heima:NoExecute</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 创建 pod3</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run taint3 --image=nginx:1.17.1 -n dev</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="28"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED </pre></td></tr><tr><td data-num="29"></td><td><pre>taint1<span class="token punctuation">-</span>7665f7fd85<span class="token punctuation">-</span>htkmp   0/1     Pending   0          35s   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>    </pre></td></tr><tr><td data-num="30"></td><td><pre>taint2<span class="token punctuation">-</span>544694789<span class="token punctuation">-</span>bn7wb    0/1     Pending   0          35s   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>     </pre></td></tr><tr><td data-num="31"></td><td><pre>taint3<span class="token punctuation">-</span>6d78dbd749<span class="token punctuation">-</span>tktkq   0/1     Pending   0          6s    &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span></pre></td></tr></table></figure><pre><code>小提示：
    使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记,所以pod就不会调度到master节点上.
</code></pre><p><strong>容忍（Toleration）</strong></p><p>上面介绍了污点的作用，我们可以在 node 上添加污点用于拒绝 pod 调度上来，但是如果就是想将一个 pod 调度到一个有污点的 node 上去，这时候应该怎么做呢？这就要使用到<strong>容忍</strong>。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200514095913741.png" alt="image-20200514095913741"></p><blockquote><p>污点就是拒绝，容忍就是忽略，Node 通过污点拒绝 pod 调度上去，Pod 通过容忍忽略拒绝</p></blockquote><p>下面先通过一个案例看下效果：</p><ol><li>上一小节，已经在 node1 节点上打上了 <code>NoExecute</code> 的污点，此时 pod 是调度不上去的</li><li>本小节，可以通过给 pod 添加容忍，然后将其调度上去</li></ol><p>创建 pod-toleration.yaml, 内容如下</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>toleration</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token comment"># 添加容忍</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"tag"</span>        <span class="token comment"># 要容忍的污点的 key</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Equal"</span> <span class="token comment"># 操作符</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"heima"</span>    <span class="token comment"># 容忍的污点的 value</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoExecute"</span>   <span class="token comment"># 添加容忍的规则，这里必须和标记的污点规则相同</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 添加容忍之前的 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="3"></td><td><pre>NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED </pre></td></tr><tr><td data-num="4"></td><td><pre>pod<span class="token punctuation">-</span>toleration   0/1     Pending   0          3s    &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>   &lt;none<span class="token punctuation">></span>           </pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 添加容忍之后的 pod</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="8"></td><td><pre>NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED</pre></td></tr><tr><td data-num="9"></td><td><pre>pod<span class="token punctuation">-</span>toleration   1/1     Running   0          3s    10.244.1.62   node1   &lt;none<span class="token punctuation">></span></pre></td></tr></table></figure><p>下面看一下容忍的详细配置:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.tolerations</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">...</span><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">FIELDS</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   key       <span class="token comment"># 对应着要容忍的污点的键，空意味着匹配所有的键</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   value     <span class="token comment"># 对应着要容忍的污点的值</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   operator  <span class="token comment"># key-value 的运算符，支持 Equal 和 Exists（默认）</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   effect    <span class="token comment"># 对应污点的 effect，空意味着匹配所有影响</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   tolerationSeconds   <span class="token comment"># 容忍时间，当 effect 为 NoExecute 时生效，表示 pod 在 Node 上的停留时间</span></pre></td></tr></table></figure><h3 id="6-pod控制器详解"><a class="anchor" href="#6-pod控制器详解">#</a> 6. Pod 控制器详解</h3><h4 id="61-pod控制器介绍"><a class="anchor" href="#61-pod控制器介绍">#</a> 6.1 Pod 控制器介绍</h4><p>Pod 是 kubernetes 的最小管理单元，在 kubernetes 中，按照 pod 的创建方式可以将其分为两类：</p><ul><li>自主式 pod：kubernetes 直接创建出来的 Pod，这种 pod 删除后就没有了，也不会重建</li><li>控制器创建的 pod：kubernetes 通过控制器创建的 pod，这种 pod 删除了之后还会自动重建</li></ul><blockquote><p><strong><code>什么是Pod控制器</code></strong></p><p>Pod 控制器是管理 pod 的中间层，使用 Pod 控制器之后，只需要告诉 Pod 控制器，想要多少个什么样的 Pod 就可以了，它会创建出满足条件的 Pod 并确保每一个 Pod 资源处于用户期望的目标状态。如果 Pod 资源在运行中出现故障，它会基于指定策略重新编排 Pod。</p></blockquote><p>在 kubernetes 中，有很多类型的 pod 控制器，每种都有自己的适合的场景，常见的有下面这些：</p><ul><li>ReplicationController：比较原始的 pod 控制器，已经被废弃，由 ReplicaSet 替代</li><li>ReplicaSet：保证副本数量一直维持在期望值，并支持 pod 数量扩缩容，镜像版本升级</li><li>Deployment：通过控制 ReplicaSet 来控制 Pod，并支持滚动升级、回退版本</li><li>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整 Pod 的数量，实现削峰填谷</li><li>DaemonSet：在集群中的指定 Node 上运行且仅运行一个副本，一般用于守护进程类的任务</li><li>Job：它创建出来的 pod 只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</li><li>Cronjob：它创建的 Pod 负责周期性任务控制，不需要持续后台运行</li><li>StatefulSet：管理有状态应用</li></ul><h4 id="62-replicasetrs"><a class="anchor" href="#62-replicasetrs">#</a> 6.2 ReplicaSet(RS)</h4><p>ReplicaSet 的主要作用是<strong>保证一定数量的 pod 正常运行</strong>，它会持续监听这些 Pod 的运行状态，一旦 Pod 发生故障，就会重启或重建。同时它还支持对 pod 数量的扩缩容和镜像版本的升降级。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200612005334159.png" alt="img"></p><p>ReplicaSet 的资源清单文件：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet <span class="token comment"># 类型       </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs 名称 </span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> rs</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels 匹配规则</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><p>在这里面，需要新了解的配置项就是 <code>spec</code> 下面几个选项：</p><ul><li><p>replicas：指定副本数量，其实就是当前 rs 创建出来的 pod 的数量，默认为 1</p></li><li><p>selector：选择器，它的作用是建立 pod 控制器和 pod 之间的关联关系，采用的 Label Selector 机制</p><p>在 pod 模板上定义 label，在控制器上定义选择器，就可以表明当前控制器能管理哪些 pod 了</p></li><li><p>template：模板，就是当前控制器创建 pod 所使用的模板板，里面其实就是前一章学过的 pod 的定义</p></li></ul><p><strong>创建 ReplicaSet</strong></p><p>创建 pc-replicaset.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet   </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>replicaset</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 rs</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-replicaset.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>replicaset.apps/pc-replicaset created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 rs</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># DESIRED: 期望副本数量  </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># CURRENT: 当前副本数量  </span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># READY: 已经准备好提供服务的副本数量</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs pc-replicaset -n dev -o wide</span></pre></td></tr><tr><td data-num="10"></td><td><pre>NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR</pre></td></tr><tr><td data-num="11"></td><td><pre>pc-replicaset <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>     22s   nginx        nginx:1.17.1       <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 查看当前控制器创建出来的 pod</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 这里发现控制器创建出来的 pod 的名称是在控制器名称后面拼接了 - xxxxx 随机码</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev</span></pre></td></tr><tr><td data-num="16"></td><td><pre>NAME                          READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="17"></td><td><pre>pc-replicaset-6vmvt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s</pre></td></tr><tr><td data-num="18"></td><td><pre>pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s</pre></td></tr><tr><td data-num="19"></td><td><pre>pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s</pre></td></tr></table></figure><p><strong>扩缩容</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 编辑 rs 的副本数量，修改 spec:replicas: 6 即可</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit rs pc-replicaset -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>replicaset.apps/pc-replicaset edited</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                          READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-replicaset-6vmvt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m</pre></td></tr><tr><td data-num="9"></td><td><pre>pc-replicaset-cftnp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s</pre></td></tr><tr><td data-num="10"></td><td><pre>pc-replicaset-fjlm6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s</pre></td></tr><tr><td data-num="11"></td><td><pre>pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m</pre></td></tr><tr><td data-num="12"></td><td><pre>pc-replicaset-s2whj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s</pre></td></tr><tr><td data-num="13"></td><td><pre>pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 当然也可以直接使用命令实现</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 使用 scale 命令实现扩缩容， 后面 --replicas=n 直接指定目标数量即可</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span></pre></td></tr><tr><td data-num="18"></td><td><pre>replicaset.apps/pc-replicaset scaled</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 命令运行完毕，立即查看，发现已经有 4 个开始准备退出了</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="22"></td><td><pre>NAME                       READY   STATUS        RESTARTS   AGE</pre></td></tr><tr><td data-num="23"></td><td><pre>pc-replicaset-6vmvt   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          118m</pre></td></tr><tr><td data-num="24"></td><td><pre>pc-replicaset-cftnp   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s</pre></td></tr><tr><td data-num="25"></td><td><pre>pc-replicaset-fjlm6   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s</pre></td></tr><tr><td data-num="26"></td><td><pre>pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running       <span class="token number">0</span>          118m</pre></td></tr><tr><td data-num="27"></td><td><pre>pc-replicaset-s2whj   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s</pre></td></tr><tr><td data-num="28"></td><td><pre>pc-replicaset-snrk2   <span class="token number">1</span>/1     Running       <span class="token number">0</span>          118m</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#稍等片刻，就只剩下 2 个了</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="32"></td><td><pre>NAME                       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="33"></td><td><pre>pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          119m</pre></td></tr><tr><td data-num="34"></td><td><pre>pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          119m</pre></td></tr></table></figure><p><strong>镜像升级</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 编辑 rs 的容器镜像 - image: nginx:1.17.2</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit rs pc-replicaset -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>replicaset.apps/pc-replicaset edited</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 再次查看，发现镜像版本已经变更了</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        <span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-replicaset       <span class="token number">2</span>        <span class="token number">2</span>         <span class="token number">2</span>       140m   nginx         nginx:1.17.2  <span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 同样的道理，也可以使用命令完成这个工作</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># kubectl set image rs rs 名称 容器 = 镜像版本 -n namespace</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span></pre></td></tr><tr><td data-num="13"></td><td><pre>replicaset.apps/pc-replicaset image updated</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 再次查看，发现镜像版本已经变更了</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            <span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="18"></td><td><pre>pc-replicaset        <span class="token number">2</span>        <span class="token number">2</span>         <span class="token number">2</span>       145m   nginx        nginx:1.17.1 <span class="token punctuation">..</span>.</pre></td></tr></table></figure><p><strong>删除 ReplicaSet</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 使用 kubectl delete 命令会删除此 RS 以及它管理的 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 在 kubernetes 删除 RS 前，会将 RS 的 replicasclear 调整为 0，等待所有的 Pod 被删除后，在执行 RS 对象的删除</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete rs pc-replicaset -n dev</span></pre></td></tr><tr><td data-num="4"></td><td><pre>replicaset.apps <span class="token string">"pc-replicaset"</span> deleted</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev -o wide</span></pre></td></tr><tr><td data-num="6"></td><td><pre>No resources found <span class="token keyword">in</span> dev namespace.</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 如果希望仅仅删除 RS 对象（保留 Pod），可以使用 kubectl delete 命令时添加 --cascade=false 选项（不推荐）。</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete rs pc-replicaset -n dev --cascade=false</span></pre></td></tr><tr><td data-num="10"></td><td><pre>replicaset.apps <span class="token string">"pc-replicaset"</span> deleted</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="13"></td><td><pre>pc-replicaset-cl82j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          75s</pre></td></tr><tr><td data-num="14"></td><td><pre>pc-replicaset-dslhb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          75s</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 也可以使用 yaml 直接删除 (推荐)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-replicaset.yaml</span></pre></td></tr><tr><td data-num="18"></td><td><pre>replicaset.apps <span class="token string">"pc-replicaset"</span> deleted</pre></td></tr></table></figure><h4 id="63-deploymentdeploy"><a class="anchor" href="#63-deploymentdeploy">#</a> 6.3 Deployment(Deploy)</h4><p>为了更好的解决服务编排的问题，kubernetes 在 V1.2 版本开始，引入了 Deployment 控制器。值得一提的是，这种控制器并不直接管理 pod，而是通过管理 ReplicaSet 来简介管理 Pod，即：Deployment 管理 ReplicaSet，ReplicaSet 管理 Pod。所以 Deployment 比 ReplicaSet 功能更加强大。</p><p>为了更好的解决服务编排的问题，kubernetes 在 V1.2 版本开始，引入了 Deployment 控制器。值得一提的是，这种控制器并不直接管理 pod，而是通过管理 ReplicaSet 来简介管理 Pod，即：Deployment 管理 ReplicaSet，ReplicaSet 管理 Pod。所以 Deployment 比 ReplicaSet 功能更加强大。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200612005524778.png" alt="img"></p><p>Deployment 主要功能有下面几个：</p><ul><li>支持 ReplicaSet 的所有功能</li><li>支持发布的停止、继续</li><li>支持滚动升级和回滚版本</li></ul><p>Deployment 的资源清单文件：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># 类型       </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs 名称 </span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> deploy</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 保留历史版本</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">paused</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 暂停部署，默认是 false</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span> <span class="token comment"># 部署超时时间（s），默认是 600</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># 滚动更新</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">违规词汇</span><span class="token punctuation">:</span> 30% <span class="token comment"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 30% <span class="token comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels 匹配规则</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><h5 id="631-创建deployment"><a class="anchor" href="#631-创建deployment">#</a> 6.3.1 创建 deployment</h5><p>创建 pc-deployment.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment      </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr></table></figure><h5 id="632-扩缩容"><a class="anchor" href="#632-扩缩容">#</a> 6.3.2 扩缩容</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 变更副本数量为 5 个</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>deployment.apps/pc-deployment scaled</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 deployment</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME            READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-deployment   <span class="token number">5</span>/5     <span class="token number">5</span>            <span class="token number">5</span>           2m</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="13"></td><td><pre>pc-deployment-6696798b78-d2c8n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s</pre></td></tr><tr><td data-num="14"></td><td><pre>pc-deployment-6696798b78-jxmdq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          94s</pre></td></tr><tr><td data-num="15"></td><td><pre>pc-deployment-6696798b78-mktqv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93s</pre></td></tr><tr><td data-num="16"></td><td><pre>pc-deployment-6696798b78-smpvp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s</pre></td></tr><tr><td data-num="17"></td><td><pre>pc-deployment-6696798b78-wvjd8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 编辑 deployment 的副本数量，修改 spec:replicas: 4 即可</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num="21"></td><td><pre>deployment.apps/pc-deployment edited</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="25"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="26"></td><td><pre>pc-deployment-6696798b78-d2c8n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s</pre></td></tr><tr><td data-num="27"></td><td><pre>pc-deployment-6696798b78-jxmdq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m38s</pre></td></tr><tr><td data-num="28"></td><td><pre>pc-deployment-6696798b78-smpvp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s</pre></td></tr><tr><td data-num="29"></td><td><pre>pc-deployment-6696798b78-wvjd8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s</pre></td></tr></table></figure><p><strong>镜像更新</strong></p><p>deployment 支持两种更新策略: <code>重建更新</code> 和 <code>滚动更新</code> ，可以通过 <code>strategy</code> 指定策略类型，支持两个属性:</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：</pre></td></tr><tr><td data-num="2"></td><td><pre>  type：指定策略类型，支持两种策略</pre></td></tr><tr><td data-num="3"></td><td><pre>    Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod</pre></td></tr><tr><td data-num="4"></td><td><pre>    RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod</pre></td></tr><tr><td data-num="5"></td><td><pre>  rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：</pre></td></tr><tr><td data-num="6"></td><td><pre>    maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。</pre></td></tr><tr><td data-num="7"></td><td><pre>    违规词汇： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</pre></td></tr></table></figure><p>重建更新</p><ol><li>编辑 pc-deployment.yaml, 在 spec 节点下添加更新策略</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate <span class="token comment"># 重建更新</span></pre></td></tr></table></figure><ol start="2"><li>创建 deploy 进行验证</li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 变更镜像</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>deployment.apps/pc-deployment image updated</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 观察升级过程</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-deployment-5d89bdfbf9-65qcw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31s</pre></td></tr><tr><td data-num="9"></td><td><pre>pc-deployment-5d89bdfbf9-w5nzv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31s</pre></td></tr><tr><td data-num="10"></td><td><pre>pc-deployment-5d89bdfbf9-xpt7w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31s</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>pc-deployment-5d89bdfbf9-xpt7w   <span class="token number">1</span>/1     Terminating   <span class="token number">0</span>          41s</pre></td></tr><tr><td data-num="13"></td><td><pre>pc-deployment-5d89bdfbf9-65qcw   <span class="token number">1</span>/1     Terminating   <span class="token number">0</span>          41s</pre></td></tr><tr><td data-num="14"></td><td><pre>pc-deployment-5d89bdfbf9-w5nzv   <span class="token number">1</span>/1     Terminating   <span class="token number">0</span>          41s</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>pc-deployment-675d469f8b-grn8z   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="17"></td><td><pre>pc-deployment-675d469f8b-hbl4v   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="18"></td><td><pre>pc-deployment-675d469f8b-67nz2   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>pc-deployment-675d469f8b-grn8z   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="21"></td><td><pre>pc-deployment-675d469f8b-hbl4v   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="22"></td><td><pre>pc-deployment-675d469f8b-67nz2   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>pc-deployment-675d469f8b-grn8z   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s</pre></td></tr><tr><td data-num="25"></td><td><pre>pc-deployment-675d469f8b-67nz2   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s</pre></td></tr><tr><td data-num="26"></td><td><pre>pc-deployment-675d469f8b-hbl4v   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s</pre></td></tr></table></figure><p>滚动更新</p><ol><li>编辑 pc-deployment.yaml, 在 spec 节点下添加更新策略</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">违规词汇</span><span class="token punctuation">:</span> 25% </pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%</pre></td></tr></table></figure><ol start="2"><li>创建 deploy 进行验证</li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 变更镜像</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span></pre></td></tr><tr><td data-num="3"></td><td><pre>deployment.apps/pc-deployment image updated</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 观察升级过程</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-deployment-c848d767-8rbzt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m</pre></td></tr><tr><td data-num="9"></td><td><pre>pc-deployment-c848d767-h4p68   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m</pre></td></tr><tr><td data-num="10"></td><td><pre>pc-deployment-c848d767-hlmz4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m</pre></td></tr><tr><td data-num="11"></td><td><pre>pc-deployment-c848d767-rrqcn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>pc-deployment-966bf7f44-226rx   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="14"></td><td><pre>pc-deployment-966bf7f44-226rx   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="15"></td><td><pre>pc-deployment-966bf7f44-226rx   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s</pre></td></tr><tr><td data-num="16"></td><td><pre>pc-deployment-c848d767-h4p68    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>pc-deployment-966bf7f44-cnd44   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="19"></td><td><pre>pc-deployment-966bf7f44-cnd44   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="20"></td><td><pre>pc-deployment-966bf7f44-cnd44   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s</pre></td></tr><tr><td data-num="21"></td><td><pre>pc-deployment-c848d767-hlmz4    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>pc-deployment-966bf7f44-px48p   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="24"></td><td><pre>pc-deployment-966bf7f44-px48p   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="25"></td><td><pre>pc-deployment-966bf7f44-px48p   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="26"></td><td><pre>pc-deployment-c848d767-8rbzt    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>pc-deployment-966bf7f44-dkmqp   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="29"></td><td><pre>pc-deployment-966bf7f44-dkmqp   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="30"></td><td><pre>pc-deployment-966bf7f44-dkmqp   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s</pre></td></tr><tr><td data-num="31"></td><td><pre>pc-deployment-c848d767-rrqcn    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m</pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># 至此，新版本的 pod 创建完毕，就版本的 pod 销毁完毕</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># 中间过程是滚动进行的，也就是边销毁边创建</span></pre></td></tr></table></figure><p>滚动更新的过程：</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200416140251491.png" alt="img"></p><p>镜像更新中 rs 的变化</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 rs, 发现原来的 rs 的依旧存在，只是 pod 数量变为了 0，而后又新产生了一个 rs，pod 数量为 4</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 其实这就是 deployment 能够进行版本回退的奥妙所在，后面会详细解释</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev</span></pre></td></tr><tr><td data-num="4"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE</pre></td></tr><tr><td data-num="5"></td><td><pre>pc-deployment-6696798b78   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       7m37s</pre></td></tr><tr><td data-num="6"></td><td><pre>pc-deployment-6696798b11   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       5m37s</pre></td></tr><tr><td data-num="7"></td><td><pre>pc-deployment-c848d76789   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       72s</pre></td></tr></table></figure><h5 id="633-版本回退"><a class="anchor" href="#633-版本回退">#</a> 6.3.3 版本回退</h5><p>deployment 支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p><p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p><ul><li>status	显示当前升级状态</li><li>history 显示 升级历史记录</li><li>pause 暂停版本升级过程</li><li>resume 继续已经暂停的版本升级过程</li><li>restart 重启版本升级过程</li><li>undo 回滚到上一级版本（可以使用 --to-revision 回滚到指定版本）</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看当前升级版本的状态</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout status deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>deployment <span class="token string">"pc-deployment"</span> successfully rolled out</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看升级历史记录</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>deployment.apps/pc-deployment</pre></td></tr><tr><td data-num="8"></td><td><pre>REVISION  CHANGE-CAUSE</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">1</span>         kubectl create <span class="token parameter variable">--filename</span><span class="token operator">=</span>pc-deployment.yaml <span class="token parameter variable">--record</span><span class="token operator">=</span>true</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">2</span>         kubectl create <span class="token parameter variable">--filename</span><span class="token operator">=</span>pc-deployment.yaml <span class="token parameter variable">--record</span><span class="token operator">=</span>true</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">3</span>         kubectl create <span class="token parameter variable">--filename</span><span class="token operator">=</span>pc-deployment.yaml <span class="token parameter variable">--record</span><span class="token operator">=</span>true</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 可以发现有三次版本记录，说明完成过两次升级</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 版本回滚</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 这里直接使用 --to-revision=1 回滚到了 1 版本， 如果省略这个选项，就是回退到上个版本，就是 2 版本</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span></pre></td></tr><tr><td data-num="17"></td><td><pre>deployment.apps/pc-deployment rolled back</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 查看发现，通过 nginx 镜像版本可以发现到了第一版</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n dev -o wide</span></pre></td></tr><tr><td data-num="21"></td><td><pre>NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num="22"></td><td><pre>pc-deployment   <span class="token number">4</span>/4     <span class="token number">4</span>            <span class="token number">4</span>           74m   nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># 查看 rs，发现第一个 rs 中有 4 个 pod 运行，后面两个版本的 rs 中 pod 为运行</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 其实 deployment 之所以可是实现版本的回滚，就是通过记录下历史 rs 来实现的，</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 一旦想回滚到哪个版本，只需要将当前版本 pod 数量降为 0，然后将回滚版本的 pod 提升为目标数量就可以了</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev</span></pre></td></tr><tr><td data-num="28"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE</pre></td></tr><tr><td data-num="29"></td><td><pre>pc-deployment-6696798b78   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       78m</pre></td></tr><tr><td data-num="30"></td><td><pre>pc-deployment-966bf7f44    <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       37m</pre></td></tr><tr><td data-num="31"></td><td><pre>pc-deployment-c848d767     <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       71m</pre></td></tr></table></figure><h5 id="634-金丝雀发布"><a class="anchor" href="#634-金丝雀发布">#</a> 6.3.4 金丝雀发布</h5><p>Deployment 控制器支持控制更新过程中的控制，如 “暂停 (pause)” 或 “继续 (resume)” 更新操作。</p><p>比如有一批新的 Pod 资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的 Pod 应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的 Pod 资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 更新 deployment 的版本，并配置暂停 deployment</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>deployment.apps/pc-deployment image updated</pre></td></tr><tr><td data-num="4"></td><td><pre>deployment.apps/pc-deployment paused</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#观察更新状态</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout status deploy pc-deployment -n dev　</span></pre></td></tr><tr><td data-num="8"></td><td><pre>Waiting <span class="token keyword">for</span> deployment <span class="token string">"pc-deployment"</span> rollout to finish: <span class="token number">2</span> out of <span class="token number">4</span> new replicas have been updated<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了 pause 暂停命令</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num="13"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num="14"></td><td><pre>pc-deployment-5d89bdfbf9   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       19m     nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num="15"></td><td><pre>pc-deployment-675d469f8b   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       14m     nginx        nginx:1.17.2   </pre></td></tr><tr><td data-num="16"></td><td><pre>pc-deployment-6c9f56fcfb   <span class="token number">2</span>         <span class="token number">2</span>         <span class="token number">2</span>       3m16s   nginx        nginx:1.17.4   </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="18"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="19"></td><td><pre>pc-deployment-5d89bdfbf9-rj8sq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m33s</pre></td></tr><tr><td data-num="20"></td><td><pre>pc-deployment-5d89bdfbf9-ttwgg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m35s</pre></td></tr><tr><td data-num="21"></td><td><pre>pc-deployment-5d89bdfbf9-v4wvc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m34s</pre></td></tr><tr><td data-num="22"></td><td><pre>pc-deployment-6c9f56fcfb-996rt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s</pre></td></tr><tr><td data-num="23"></td><td><pre>pc-deployment-6c9f56fcfb-j2gtj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 确保更新的 pod 没问题了，继续更新</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout resume deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num="27"></td><td><pre>deployment.apps/pc-deployment resumed</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># 查看最后的更新情况</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num="31"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num="32"></td><td><pre>pc-deployment-5d89bdfbf9   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       21m     nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num="33"></td><td><pre>pc-deployment-675d469f8b   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       16m     nginx        nginx:1.17.2   </pre></td></tr><tr><td data-num="34"></td><td><pre>pc-deployment-6c9f56fcfb   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       5m11s   nginx        nginx:1.17.4   </pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="37"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="38"></td><td><pre>pc-deployment-6c9f56fcfb-7bfwh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s</pre></td></tr><tr><td data-num="39"></td><td><pre>pc-deployment-6c9f56fcfb-996rt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m27s</pre></td></tr><tr><td data-num="40"></td><td><pre>pc-deployment-6c9f56fcfb-j2gtj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m27s</pre></td></tr><tr><td data-num="41"></td><td><pre>pc-deployment-6c9f56fcfb-rf84v   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s</pre></td></tr></table></figure><p><strong>删除 Deployment</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 删除 deployment，其下的 rs 和 pod 也将被删除</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-deployment.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>deployment.apps <span class="token string">"pc-deployment"</span> deleted</pre></td></tr></table></figure><h4 id="64-horizontal-pod-autoscalerhpa"><a class="anchor" href="#64-horizontal-pod-autoscalerhpa">#</a> 6.4 Horizontal Pod Autoscaler(HPA)</h4><p>在前面的课程中，我们已经可以实现通过手工执行 <code>kubectl scale</code> 命令实现 Pod 扩容或缩容，但是这显然不符合 Kubernetes 的定位目标 -- 自动化、智能化。 Kubernetes 期望可以实现通过监测 Pod 的使用情况，实现 pod 数量的自动调整，于是就产生了 Horizontal Pod Autoscaler（HPA）这种控制器。</p><p>HPA 可以获取每个 Pod 利用率，然后和 HPA 中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现 Pod 的数量的调整。其实 HPA 与之前的 Deployment 一样，也属于一种 Kubernetes 资源对象，它通过追踪分析 RC 控制的所有目标 Pod 的负载变化情况，来确定是否需要针对性地调整目标 Pod 的副本数，这是 HPA 的实现原理。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200608155858271.png" alt="img"></p><p>接下来，我们来做一个实验</p><h5 id="641-安装metrics-server"><a class="anchor" href="#641-安装metrics-server">#</a> 6.4.1 安装 metrics-server</h5><p>metrics-server 可以用来收集集群中的资源使用情况</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 安装 git</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install git -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 获取 metrics-server, 注意使用的版本</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 修改 deployment, 注意修改的是镜像和初始化参数</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/metrics-server/deploy/1.8+/</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># vim metrics-server-deployment.yaml</span></pre></td></tr><tr><td data-num="8"></td><td><pre>按图中添加下面选项</pre></td></tr><tr><td data-num="9"></td><td><pre>hostNetwork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="10"></td><td><pre>image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</pre></td></tr><tr><td data-num="11"></td><td><pre>args:</pre></td></tr><tr><td data-num="12"></td><td><pre>- --kubelet-insecure-tls</pre></td></tr><tr><td data-num="13"></td><td><pre>- --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</pre></td></tr></table></figure><p><img data-src="http://oss.itshare.work/blog-images/image-20200608163326496.png" alt="image-20200608163326496"></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 安装 metrics-server</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ./</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查看 pod 运行情况</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span></pre></td></tr><tr><td data-num="6"></td><td><pre>metrics-server-6b976979db-2xwbj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90s</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 使用 kubectl top node 查看资源使用情况</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl top node</span></pre></td></tr><tr><td data-num="10"></td><td><pre>NAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%</pre></td></tr><tr><td data-num="11"></td><td><pre>k8s-master01   289m         <span class="token number">14</span>%    1582Mi          <span class="token number">54</span>%       </pre></td></tr><tr><td data-num="12"></td><td><pre>k8s-node01     81m          <span class="token number">4</span>%     1195Mi          <span class="token number">40</span>%       </pre></td></tr><tr><td data-num="13"></td><td><pre>k8s-node02     72m          <span class="token number">3</span>%     1211Mi          <span class="token number">41</span>%  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl top pod -n kube-system</span></pre></td></tr><tr><td data-num="15"></td><td><pre>NAME                              CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>coredns-6955765f44-7ptsb          3m           9Mi</pre></td></tr><tr><td data-num="17"></td><td><pre>coredns-6955765f44-vcwr5          3m           8Mi</pre></td></tr><tr><td data-num="18"></td><td><pre>etcd-master                       14m          145Mi</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 至此，metrics-server 安装完成</span></pre></td></tr></table></figure><h5 id="642-准备deployment和servie"><a class="anchor" href="#642-准备deployment和servie">#</a> 6.4.2 准备 deployment 和 servie</h5><p>创建 pc-hpa-pod.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 资源配额</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment"># 限制资源（上限）</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span> <span class="token comment"># CPU 限制，单位是 core 数</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># 请求资源（下限）</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"100m"</span>  <span class="token comment"># CPU 限制，单位是 core 数</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 deployment</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 创建 service</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment,pod,svc -n dev</span></pre></td></tr><tr><td data-num="3"></td><td><pre>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num="4"></td><td><pre>deployment.apps/nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           47s</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>NAME                         READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="7"></td><td><pre>pod/nginx-7df9756ccc-bh8dr   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE</pre></td></tr><tr><td data-num="10"></td><td><pre>service/nginx   NodePort   <span class="token number">10.101</span>.18.29   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:31830/TCP   35s</pre></td></tr></table></figure><h5 id="643-部署hpa"><a class="anchor" href="#643-部署hpa">#</a> 6.4.3 部署 HPA</h5><p>创建 pc-hpa.yaml 文件，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>hpa</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token comment">#最小 pod 数量</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment">#最大 pod 数量</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># CPU 使用率指标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>   <span class="token comment"># 指定要控制的 nginx 信息</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span>  apps/v1</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 hpa</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-hpa.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>horizontalpodautoscaler.autoscaling/pc-hpa created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 hpa</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-hpa   Deployment/nginx   <span class="token number">0</span>%/3%     <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">1</span>          62s</pre></td></tr></table></figure><h5 id="644-测试"><a class="anchor" href="#644-测试">#</a> 6.4.4 测试</h5><p>使用压测工具对 service 地址 <code>192.168.5.4:31830</code> 进行压测，然后通过控制台查看 hpa 和 pod 的变化</p><p>hpa 变化</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n dev -w</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      4m11s</pre></td></tr><tr><td data-num="4"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      5m19s</pre></td></tr><tr><td data-num="5"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      6m50s</pre></td></tr><tr><td data-num="6"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">4</span>      7m5s</pre></td></tr><tr><td data-num="7"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      7m21s</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">6</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      7m51s</pre></td></tr><tr><td data-num="9"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      9m6s</pre></td></tr><tr><td data-num="10"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      13m</pre></td></tr><tr><td data-num="11"></td><td><pre>pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      14m</pre></td></tr></table></figure><p>deployment 变化</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment -n dev -w</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME    READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           11m</pre></td></tr><tr><td data-num="4"></td><td><pre>nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m</pre></td></tr><tr><td data-num="5"></td><td><pre>nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m</pre></td></tr><tr><td data-num="6"></td><td><pre>nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m</pre></td></tr><tr><td data-num="7"></td><td><pre>nginx   <span class="token number">1</span>/4     <span class="token number">4</span>            <span class="token number">1</span>           13m</pre></td></tr><tr><td data-num="8"></td><td><pre>nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m</pre></td></tr><tr><td data-num="9"></td><td><pre>nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m</pre></td></tr><tr><td data-num="10"></td><td><pre>nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m</pre></td></tr><tr><td data-num="11"></td><td><pre>nginx   <span class="token number">1</span>/8     <span class="token number">8</span>            <span class="token number">1</span>           14m</pre></td></tr><tr><td data-num="12"></td><td><pre>nginx   <span class="token number">2</span>/8     <span class="token number">8</span>            <span class="token number">2</span>           14m</pre></td></tr><tr><td data-num="13"></td><td><pre>nginx   <span class="token number">3</span>/8     <span class="token number">8</span>            <span class="token number">3</span>           14m</pre></td></tr><tr><td data-num="14"></td><td><pre>nginx   <span class="token number">4</span>/8     <span class="token number">8</span>            <span class="token number">4</span>           14m</pre></td></tr><tr><td data-num="15"></td><td><pre>nginx   <span class="token number">5</span>/8     <span class="token number">8</span>            <span class="token number">5</span>           14m</pre></td></tr><tr><td data-num="16"></td><td><pre>nginx   <span class="token number">6</span>/8     <span class="token number">8</span>            <span class="token number">6</span>           14m</pre></td></tr><tr><td data-num="17"></td><td><pre>nginx   <span class="token number">7</span>/8     <span class="token number">8</span>            <span class="token number">7</span>           14m</pre></td></tr><tr><td data-num="18"></td><td><pre>nginx   <span class="token number">8</span>/8     <span class="token number">8</span>            <span class="token number">8</span>           15m</pre></td></tr><tr><td data-num="19"></td><td><pre>nginx   <span class="token number">8</span>/1     <span class="token number">8</span>            <span class="token number">8</span>           20m</pre></td></tr><tr><td data-num="20"></td><td><pre>nginx   <span class="token number">8</span>/1     <span class="token number">8</span>            <span class="token number">8</span>           20m</pre></td></tr><tr><td data-num="21"></td><td><pre>nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           20m</pre></td></tr></table></figure><p>pod 变化</p><pre><code>[root@k8s-master01 ~]# kubectl get pods -n dev -w
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7df9756ccc-bh8dr   1/1     Running   0          11m
nginx-7df9756ccc-cpgrv   0/1     Pending   0          0s
nginx-7df9756ccc-8zhwk   0/1     Pending   0          0s
nginx-7df9756ccc-rr9bn   0/1     Pending   0          0s
nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     Pending             0          0s
nginx-7df9756ccc-sl9c6   0/1     Pending             0          0s
nginx-7df9756ccc-fgst7   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   1/1     Running             0          19s
nginx-7df9756ccc-rr9bn   1/1     Running             0          30s
nginx-7df9756ccc-m9gsj   1/1     Running             0          21s
nginx-7df9756ccc-cpgrv   1/1     Running             0          47s
nginx-7df9756ccc-sl9c6   1/1     Running             0          33s
nginx-7df9756ccc-g56qb   1/1     Running             0          48s
nginx-7df9756ccc-fgst7   1/1     Running             0          66s
nginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s
nginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s
nginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s
nginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s
nginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s
nginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s
nginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s
</code></pre><h4 id="65-daemonsetds"><a class="anchor" href="#65-daemonsetds">#</a> 6.5 DaemonSet(DS)</h4><p>DaemonSet 类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个 Pod 提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类 Pod 就适合使用 DaemonSet 类型的控制器创建。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200612010223537.png" alt="img"></p><p>DaemonSet 控制器的特点：</p><ul><li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li><li>当节点从集群中移除时，Pod 也就被垃圾回收了</li></ul><p>下面先来看下 DaemonSet 的资源清单文件</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet <span class="token comment"># 类型       </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs 名称 </span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> daemonset</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 保留历史版本</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span> <span class="token comment"># 更新策略</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># 滚动更新</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels 匹配规则</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><p>创建 pc-daemonset.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet      </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>daemonset</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 daemonset</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f  pc-daemonset.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>daemonset.apps/pc-daemonset created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 daemonset</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get ds -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num="8"></td><td><pre>pc-daemonset   <span class="token number">2</span>        <span class="token number">2</span>        <span class="token number">2</span>      <span class="token number">2</span>           <span class="token number">2</span>        24s   nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 pod, 发现在每个 Node 上都运行一个 pod</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="12"></td><td><pre>NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    </pre></td></tr><tr><td data-num="13"></td><td><pre>pc-daemonset-9bck8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s   <span class="token number">10.244</span>.1.43   node1     </pre></td></tr><tr><td data-num="14"></td><td><pre>pc-daemonset-k224w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s   <span class="token number">10.244</span>.2.74   node2      </pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 删除 daemonset</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-daemonset.yaml</span></pre></td></tr><tr><td data-num="18"></td><td><pre>daemonset.apps <span class="token string">"pc-daemonset"</span> deleted</pre></td></tr></table></figure><h4 id="66-job"><a class="anchor" href="#66-job">#</a> 6.6 Job</h4><p>Job，主要用于负责 ** 批量处理 (一次要处理指定数量任务)<strong> 短暂的</strong>一次性 (每个任务仅运行一次就结束)** 任务。Job 特点如下：</p><ul><li>当 Job 创建的 pod 执行成功结束时，Job 将记录成功结束的 pod 数量</li><li>当成功结束的 pod 达到指定的数量时，Job 将完成执行</li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200618213054113.png" alt="img"></p><p>Job 的资源清单文件：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1 <span class="token comment"># 版本号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Job <span class="token comment"># 类型       </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs 名称 </span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> job</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定 job 需要成功运行 Pods 的次数。默认值: 1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定 job 在任一时刻应该并发运行 Pods 的数量。默认值: 1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment"># 指定 job 可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span> <span class="token comment"># 指定 job 失败后进行重试的次数。默认是 6</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否可以使用 selector 选择器选择 pod，默认是 false</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels 匹配规则</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>counter<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略只能设置为 Never 或者 OnFailure</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter</pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>关于重启策略设置的说明：</pre></td></tr><tr><td data-num="2"></td><td><pre>    如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变</pre></td></tr><tr><td data-num="3"></td><td><pre>    如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1</pre></td></tr><tr><td data-num="4"></td><td><pre>    如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</pre></td></tr></table></figure><p>创建 pc-job.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Job      </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>job</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 job</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-job.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>job.batch/pc-job created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 job</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get job -n dev -o wide  -w</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-job   <span class="token number">0</span>/1           21s        21s   counter      busybox:1.30   <span class="token assign-left variable">app</span><span class="token operator">=</span>counter-pod</pre></td></tr><tr><td data-num="9"></td><td><pre>pc-job   <span class="token number">1</span>/1           31s        79s   counter      busybox:1.30   <span class="token assign-left variable">app</span><span class="token operator">=</span>counter-pod</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 通过观察 pod 状态可以看到，pod 在运行完毕任务后，就会变成 Completed 状态</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num="13"></td><td><pre>NAME           READY   STATUS     RESTARTS      AGE</pre></td></tr><tr><td data-num="14"></td><td><pre>pc-job-rxg96   <span class="token number">1</span>/1     Running     <span class="token number">0</span>            29s</pre></td></tr><tr><td data-num="15"></td><td><pre>pc-job-rxg96   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>            33s</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 接下来，调整下 pod 运行的总数量和并行数量 即：在 spec 下设置下面两个选项</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#  completions: 6 # 指定 job 需要成功运行 Pods 的次数为 6</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#  parallelism: 3 # 指定 job 并发运行 Pods 的数量为 3</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#  然后重新运行 job，观察效果，此时会发现，job 会每次运行 3 个 pod，总共执行了 6 个 pod</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num="22"></td><td><pre>NAME           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="23"></td><td><pre>pc-job-684ft   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s</pre></td></tr><tr><td data-num="24"></td><td><pre>pc-job-jhj49   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s</pre></td></tr><tr><td data-num="25"></td><td><pre>pc-job-pfcvh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s</pre></td></tr><tr><td data-num="26"></td><td><pre>pc-job-684ft   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          11s</pre></td></tr><tr><td data-num="27"></td><td><pre>pc-job-v7rhr   <span class="token number">0</span>/1     Pending     <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="28"></td><td><pre>pc-job-v7rhr   <span class="token number">0</span>/1     Pending     <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="29"></td><td><pre>pc-job-v7rhr   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="30"></td><td><pre>pc-job-jhj49   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          11s</pre></td></tr><tr><td data-num="31"></td><td><pre>pc-job-fhwf7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="32"></td><td><pre>pc-job-fhwf7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="33"></td><td><pre>pc-job-pfcvh   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          11s</pre></td></tr><tr><td data-num="34"></td><td><pre>pc-job-5vg2j   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="35"></td><td><pre>pc-job-fhwf7   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="36"></td><td><pre>pc-job-5vg2j   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="37"></td><td><pre>pc-job-5vg2j   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s</pre></td></tr><tr><td data-num="38"></td><td><pre>pc-job-fhwf7   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s</pre></td></tr><tr><td data-num="39"></td><td><pre>pc-job-v7rhr   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s</pre></td></tr><tr><td data-num="40"></td><td><pre>pc-job-5vg2j   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          3s</pre></td></tr><tr><td data-num="41"></td><td><pre>pc-job-fhwf7   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s</pre></td></tr><tr><td data-num="42"></td><td><pre>pc-job-v7rhr   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s</pre></td></tr><tr><td data-num="43"></td><td><pre>pc-job-5vg2j   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s</pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># 删除 job</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-job.yaml</span></pre></td></tr><tr><td data-num="47"></td><td><pre>job.batch <span class="token string">"pc-job"</span> deleted</pre></td></tr></table></figure><h4 id="67-cronjobcj"><a class="anchor" href="#67-cronjobcj">#</a> 6.7 CronJob(CJ)</h4><p>CronJob 控制器以 Job 控制器资源为其管控对象，并借助它管理 pod 资源对象，Job 控制器定义的作业任务在其控制器资源创建之后便会立即执行，但 CronJob 可以以类似于 Linux 操作系统的周期性任务作业计划的方式控制其运行<strong>时间点</strong>及<strong>重复运行</strong>的方式。也就是说，<strong>CronJob 可以在特定的时间点 (反复的) 去运行 job 任务</strong>。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200618213149531.png" alt="img"></p><p>CronJob 的资源清单文件：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1 <span class="token comment"># 版本号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob <span class="token comment"># 类型       </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs 名称 </span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> cronjob</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token comment"># cron 格式的作业调度运行时间点，用于控制任务在什么时间执行</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">concurrencyPolicy</span><span class="token punctuation">:</span> <span class="token comment"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">failedJobHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># 为失败的任务执行保留的历史记录数，默认为 1</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">successfulJobHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># 为成功的任务执行保留的历史记录数，默认为 3</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">startingDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token comment"># 启动作业错误的超时时长</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span> <span class="token comment"># job 控制器模板，用于为 cronjob 控制器生成 job 对象；下面其实就是 job 的定义</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> 规则</pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>counter<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never </pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter</pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>需要重点解释的几个选项：</pre></td></tr><tr><td data-num="2"></td><td><pre>schedule: cron表达式，用于指定任务的执行时间</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token italic"><span class="token punctuation">*</span><span class="token content">/1    </span><span class="token punctuation">*</span></span>      <span class="token italic"><span class="token punctuation">*</span><span class="token content">    </span><span class="token punctuation">*</span></span>     *</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>分钟</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>小时</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>日</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>月份</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>星期</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token code keyword">    分钟 值从 0 到 59.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    小时 值从 0 到 23.</pre></td></tr><tr><td data-num="8"></td><td><pre>    日 值从 1 到 31.</pre></td></tr><tr><td data-num="9"></td><td><pre>    月 值从 1 到 12.</pre></td></tr><tr><td data-num="10"></td><td><pre>    星期 值从 0 到 6, 0 代表星期日</pre></td></tr><tr><td data-num="11"></td><td><pre>    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...</pre></td></tr><tr><td data-num="12"></td><td><pre>concurrencyPolicy:</pre></td></tr><tr><td data-num="13"></td><td><pre>    Allow:   允许Jobs并发运行(默认)</pre></td></tr><tr><td data-num="14"></td><td><pre>    Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行</pre></td></tr><tr><td data-num="15"></td><td><pre>    Replace: 替换，取消当前正在运行的作业并用新作业替换它</pre></td></tr></table></figure><p>创建 pc-cronjob.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>cronjob</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> cronjob</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"*/1 * * * *"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never</pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter</pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 cronjob</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-cronjob.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>cronjob.batch/pc-cronjob created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 cronjob</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cronjobs -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-cronjob   */1 * * * *   False     <span class="token number">0</span>        <span class="token operator">&lt;</span>none<span class="token operator">></span>          6s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 job</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get jobs -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre>NAME                    COMPLETIONS   DURATION   AGE</pre></td></tr><tr><td data-num="13"></td><td><pre>pc-cronjob-1592587800   <span class="token number">1</span>/1           28s        3m26s</pre></td></tr><tr><td data-num="14"></td><td><pre>pc-cronjob-1592587860   <span class="token number">1</span>/1           28s        2m26s</pre></td></tr><tr><td data-num="15"></td><td><pre>pc-cronjob-1592587920   <span class="token number">1</span>/1           28s        86s</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="19"></td><td><pre>pc-cronjob-1592587800-x4tsm   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          2m24s</pre></td></tr><tr><td data-num="20"></td><td><pre>pc-cronjob-1592587860-r5gv4   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          84s</pre></td></tr><tr><td data-num="21"></td><td><pre>pc-cronjob-1592587920-9dxxq   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          24s</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># 删除 cronjob</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  delete -f pc-cronjob.yaml</span></pre></td></tr><tr><td data-num="26"></td><td><pre>cronjob.batch <span class="token string">"pc-cronjob"</span> deleted</pre></td></tr></table></figure><h3 id="7-service详解"><a class="anchor" href="#7-service详解">#</a> 7. Service 详解</h3><h4 id="71-service介绍"><a class="anchor" href="#71-service介绍">#</a> 7.1 Service 介绍</h4><p>在 kubernetes 中，pod 是应用程序的载体，我们可以通过 pod 的 ip 来访问应用程序，但是 pod 的 ip 地址不是固定的，这也就意味着不方便直接采用 pod 的 ip 对服务进行访问。</p><p>为了解决这个问题，kubernetes 提供了 Service 资源，Service 会对提供同一个服务的多个 pod 进行聚合，并且提供一个统一的入口地址。通过访问 Service 的入口地址就能访问到后面的 pod 服务。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200408194716912-1626783758946.png" alt="img"></p><p>Service 在很多情况下只是一个概念，真正起作用的其实是 kube-proxy 服务进程，每个 Node 节点上都运行着一个 kube-proxy 服务进程。当创建 Service 的时候会通过 api-server 向 etcd 写入创建的 service 的信息，而 kube-proxy 会基于监听的机制发现这种 Service 的变动，然后<strong>它会将最新的 Service 信息转换成对应的访问规则</strong>。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200509121254425.png" alt="img"></p><pre><code># 10.97.97.97:80 是service提供的访问入口
# 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，
# kube-proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去
# 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点，访问都可以。
[root@node1 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.97.97.97:80 rr
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0
</code></pre><p>kube-proxy 目前支持三种工作模式:</p><p>kube-proxy 目前支持三种工作模式:</p><h5 id="711-userspace-模式"><a class="anchor" href="#711-userspace-模式">#</a> 7.1.1 userspace 模式</h5><p>userspace 模式下，kube-proxy 会为每一个 Service 创建一个监听端口，发向 Cluster IP 的请求被 Iptables 规则重定向到 kube-proxy 监听的端口上，kube-proxy 根据 LB 算法选择一个提供服务的 Pod 并和其建立链接，以将请求转发到 Pod 上。 该模式下，kube-proxy 充当了一个四层负责均衡器的角色。由于 kube-proxy 运行在 userspace 中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200509151424280.png" alt="img"></p><h5 id="712-iptables-模式"><a class="anchor" href="#712-iptables-模式">#</a> 7.1.2 iptables 模式</h5><p>iptables 模式下，kube-proxy 为 service 后端的每个 Pod 创建对应的 iptables 规则，直接将发向 Cluster IP 的请求重定向到一个 Pod IP。 该模式下 kube-proxy 不承担四层负责均衡器的角色，只负责创建 iptables 规则。该模式的优点是较 userspace 模式效率更高，但不能提供灵活的 LB 策略，当后端 Pod 不可用时也无法进行重试。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200509152947714.png" alt="img"></p><h5 id="713-ipvs-模式"><a class="anchor" href="#713-ipvs-模式">#</a> 7.1.3 ipvs 模式</h5><p>ipvs 模式和 iptables 类似，kube-proxy 监控 Pod 的变化并创建相应的 ipvs 规则。ipvs 相对 iptables 转发效率更高。除此以外，ipvs 支持更多的 LB 算法。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200509153731363.png" alt="img"></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 此模式必须安装 ipvs 内核模块，否则会降级为 iptables</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 开启 ipvs</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit cm kube-proxy -n kube-system</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 修改 mode: "ipvs"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num="7"></td><td><pre>IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num="9"></td><td><pre>  -<span class="token operator">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num="10"></td><td><pre>TCP  <span class="token number">10.97</span>.97.97:80 rr</pre></td></tr><tr><td data-num="11"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr></table></figure><h4 id="72-service类型"><a class="anchor" href="#72-service类型">#</a> 7.2 Service 类型</h4><p>Service 的资源清单文件：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service  <span class="token comment"># 资源类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  <span class="token comment"># 资源版本</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> service <span class="token comment"># 资源名称</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名空间</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 描述</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 标签选择器，用于确定当前 service 代理哪些 pod</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token comment"># Service 类型，指定 service 的访问方式</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span>  <span class="token comment"># 虚拟服务的 ip 地址</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> <span class="token comment"># session 亲和性，支持 ClientIP、None 两个选项</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 端口信息</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP </pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3017</span>  <span class="token comment"># service 端口</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5003</span> <span class="token comment"># pod 端口</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31122</span> <span class="token comment"># 主机端口</span></pre></td></tr></table></figure><ul><li>ClusterIP：默认值，它是 Kubernetes 系统自动分配的虚拟 IP，只能在集群内部访问</li><li>NodePort：将 Service 通过指定的 Node 上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</li><li>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</li><li>ExternalName： 把集群外部的服务引入集群内部，直接使用</li></ul><h4 id="73-service使用"><a class="anchor" href="#73-service使用">#</a> 7.3 Service 使用</h4><h5 id="731-实验环境准备"><a class="anchor" href="#731-实验环境准备">#</a> 7.3.1 实验环境准备</h5><p>在使用 service 之前，首先利用 Deployment 创建出 3 个 pod，注意要为 pod 设置 <code>app=nginx-pod</code> 的标签</p><p>创建 deployment.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment      </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f deployment.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>deployment.apps/pc-deployment created</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查看 pod 详情</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide --show-labels</span></pre></td></tr><tr><td data-num="6"></td><td><pre>NAME                             READY   STATUS     IP            NODE     LABELS</pre></td></tr><tr><td data-num="7"></td><td><pre>pc-deployment-66cb59b984-8p84h   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.1.39   node1    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="8"></td><td><pre>pc-deployment-66cb59b984-vx8vx   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.2.33   node2    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="9"></td><td><pre>pc-deployment-66cb59b984-wnncx   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.1.40   node1    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 为了方便后面的测试，修改下三台 nginx 的 index.html 页面（三台修改的 IP 地址不一致）</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># echo "10.244.1.39" > /usr/share/nginx/html/index.html</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#修改完毕之后，访问测试</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.1.39</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">10.244</span>.1.39</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.33</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token number">10.244</span>.2.33</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.1.40</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">10.244</span>.1.40</pre></td></tr></table></figure><h5 id="732-clusterip类型的service"><a class="anchor" href="#732-clusterip类型的service">#</a> 7.3.2 ClusterIP 类型的 Service</h5><p>创建 service-clusterip.yaml 文件</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>clusterip</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97 <span class="token comment"># service 的 ip 地址，如果不写，默认会生成一个</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token comment"># Service 端口       </span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># pod 端口</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-clusterip.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>service/service-clusterip created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 service</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR</pre></td></tr><tr><td data-num="8"></td><td><pre>service-clusterip   ClusterIP   <span class="token number">10.97</span>.97.97   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP    13s   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 service 的详细信息</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 在这里有一个 Endpoints 列表，里面就是当前 service 可以负载到的服务入口</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc service-clusterip -n dev</span></pre></td></tr><tr><td data-num="13"></td><td><pre>Name:              service-clusterip</pre></td></tr><tr><td data-num="14"></td><td><pre>Namespace:         dev</pre></td></tr><tr><td data-num="15"></td><td><pre>Labels:            <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="17"></td><td><pre>Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="18"></td><td><pre>Type:              ClusterIP</pre></td></tr><tr><td data-num="19"></td><td><pre>IP:                <span class="token number">10.97</span>.97.97</pre></td></tr><tr><td data-num="20"></td><td><pre>Port:              <span class="token operator">&lt;</span>unset<span class="token operator">></span>  <span class="token number">80</span>/TCP</pre></td></tr><tr><td data-num="21"></td><td><pre>TargetPort:        <span class="token number">80</span>/TCP</pre></td></tr><tr><td data-num="22"></td><td><pre>Endpoints:         <span class="token number">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80</pre></td></tr><tr><td data-num="23"></td><td><pre>Session Affinity:  None</pre></td></tr><tr><td data-num="24"></td><td><pre>Events:            <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 查看 ipvs 的映射规则</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num="28"></td><td><pre>TCP  <span class="token number">10.97</span>.97.97:80 rr</pre></td></tr><tr><td data-num="29"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># 访问 10.97.97.97:80 观察效果</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.97.97.97:80</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token number">10.244</span>.2.33</pre></td></tr></table></figure><h5 id="733-endpoint"><a class="anchor" href="#733-endpoint">#</a> 7.3.3 Endpoint</h5><p>Endpoint 是 kubernetes 中的一个资源对象，存储在 etcd 中，用来记录一个 service 对应的所有 pod 的访问地址，它是根据 service 配置文件中 selector 描述产生的。</p><p>一个 Service 由一组 Pod 组成，这些 Pod 通过 Endpoints 暴露出来，<strong>Endpoints 是实现实际服务的端点集合</strong>。换句话说，service 和 pod 之间的联系是通过 endpoints 实现的。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200509191917069.png" alt="image-20200509191917069"></p><p><strong>负载分发策略</strong></p><p>对 Service 的访问被分发到了后端的 Pod 上去，目前 kubernetes 提供了两种负载分发策略：</p><ul><li><p>如果不定义，默认使用 kube-proxy 的策略，比如随机、轮询</p></li><li><p>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个 Pod 上</p><p>此模式可以使在 spec 中添加 <code>sessionAffinity:ClientIP</code> 选项</p></li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 ipvs 的映射规则【rr 轮询】</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num="3"></td><td><pre>TCP  <span class="token number">10.97</span>.97.97:80 rr</pre></td></tr><tr><td data-num="4"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 循环访问测试</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># while true;do curl 10.97.97.97:80; sleep 5; done;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">10.244</span>.1.40</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">10.244</span>.1.39</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">10.244</span>.2.33</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">10.244</span>.1.40</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">10.244</span>.1.39</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">10.244</span>.2.33</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 修改分发策略 ----sessionAffinity:ClientIP</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 查看 ipvs 规则【persistent 代表持久】</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num="21"></td><td><pre>TCP  <span class="token number">10.97</span>.97.97:80 rr persistent <span class="token number">10800</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 循环访问测试</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># while true;do curl 10.97.97.97; sleep 5; done;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">10.244</span>.2.33</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token number">10.244</span>.2.33</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token number">10.244</span>.2.33</pre></td></tr><tr><td data-num="31"></td><td><pre>  </pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># 删除 service</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f service-clusterip.yaml</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token function">service</span> <span class="token string">"service-clusterip"</span> deleted</pre></td></tr></table></figure><h5 id="734-headliness类型的service"><a class="anchor" href="#734-headliness类型的service">#</a> 7.3.4 HeadLiness 类型的 Service</h5><p>在某些场景中，开发人员可能不想使用 Service 提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes 提供了 HeadLiness Service，这类 Service 不会分配 Cluster IP，如果想要访问 service，只能通过 service 的域名进行查询。</p><p>创建 service-headliness.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>headliness</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None <span class="token comment"># 将 clusterIP 设置为 None，即可创建 headliness Service</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-headliness.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>service/service-headliness created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 获取 service， 发现 CLUSTER-IP 未分配</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc service-headliness -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR</pre></td></tr><tr><td data-num="8"></td><td><pre>service-headliness   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP    11s   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 service 详情</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc service-headliness  -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre>Name:              service-headliness</pre></td></tr><tr><td data-num="13"></td><td><pre>Namespace:         dev</pre></td></tr><tr><td data-num="14"></td><td><pre>Labels:            <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="17"></td><td><pre>Type:              ClusterIP</pre></td></tr><tr><td data-num="18"></td><td><pre>IP:                None</pre></td></tr><tr><td data-num="19"></td><td><pre>Port:              <span class="token operator">&lt;</span>unset<span class="token operator">></span>  <span class="token number">80</span>/TCP</pre></td></tr><tr><td data-num="20"></td><td><pre>TargetPort:        <span class="token number">80</span>/TCP</pre></td></tr><tr><td data-num="21"></td><td><pre>Endpoints:         <span class="token number">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80</pre></td></tr><tr><td data-num="22"></td><td><pre>Session Affinity:  None</pre></td></tr><tr><td data-num="23"></td><td><pre>Events:            <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 查看域名的解析情况</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span></pre></td></tr><tr><td data-num="27"></td><td><pre>/ <span class="token comment"># cat /etc/resolv.conf</span></pre></td></tr><tr><td data-num="28"></td><td><pre>nameserver <span class="token number">10.96</span>.0.10</pre></td></tr><tr><td data-num="29"></td><td><pre>search dev.svc.cluster.local svc.cluster.local cluster.local</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num="32"></td><td><pre>service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.1.40</pre></td></tr><tr><td data-num="33"></td><td><pre>service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.1.39</pre></td></tr><tr><td data-num="34"></td><td><pre>service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.2.33</pre></td></tr></table></figure><h5 id="735-nodeport类型的service"><a class="anchor" href="#735-nodeport类型的service">#</a> 7.3.5 NodePort 类型的 Service</h5><p>在之前的样例中，创建的 Service 的 ip 地址只有集群内部才可以访问，如果希望将 Service 暴露给集群外部使用，那么就要使用到另外一种类型的 Service，称为 NodePort 类型。NodePort 的工作原理其实就是<strong>将 service 的端口映射到 Node 的一个端口上</strong>，然后就可以通过 <code>NodeIp:NodePort</code> 来访问 service 了。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200620175731338.png" alt="img"></p><p>创建 service-nodeport.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>nodeport</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># service 类型</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30002</span> <span class="token comment"># 指定绑定的 node 的端口 (默认的取值范围是：30000-32767), 如果不指定，会默认分配</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-nodeport.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>service/service-nodeport created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 service</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>       SELECTOR</pre></td></tr><tr><td data-num="8"></td><td><pre>service-nodeport   NodePort   <span class="token number">10.105</span>.64.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30002/TCP  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 接下来可以通过电脑主机的浏览器去访问集群中任意一个 nodeip 的 30002 端口，即可访问到 pod</span></pre></td></tr></table></figure><h5 id="736-loadbalancer类型的service"><a class="anchor" href="#736-loadbalancer类型的service">#</a> 7.3.6 LoadBalancer 类型的 Service</h5><p>LoadBalancer 和 NodePort 很相似，目的都是向外部暴露一个端口，区别在于 LoadBalancer 会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200510103945494.png" alt="img"></p><h5 id="737-externalname类型的service"><a class="anchor" href="#737-externalname类型的service">#</a> 7.3.7 ExternalName 类型的 Service</h5><p>ExternalName 类型的 Service 用于引入集群外部的服务，它通过 <code>externalName</code> 属性指定外部一个服务的地址，然后在集群内部访问此 service 就可以访问到外部的服务了。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200510113311209.png" alt="img"></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="2"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num="3"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="4"></td><td><pre>  name: service-externalname</pre></td></tr><tr><td data-num="5"></td><td><pre>  namespace: dev</pre></td></tr><tr><td data-num="6"></td><td><pre>spec:</pre></td></tr><tr><td data-num="7"></td><td><pre>  type: ExternalName <span class="token comment"># service 类型</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  externalName: www.baidu.com  <span class="token comment">#改成 ip 地址也可以</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  create -f service-externalname.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>service/service-externalname created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 域名解析</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num="7"></td><td><pre>service-externalname.dev.svc.cluster.local. <span class="token number">30</span> IN CNAME www.baidu.com.</pre></td></tr><tr><td data-num="8"></td><td><pre>www.baidu.com.          <span class="token number">30</span>      IN      CNAME   www.a.shifen.com.</pre></td></tr><tr><td data-num="9"></td><td><pre>www.a.shifen.com.       <span class="token number">30</span>      IN      A       <span class="token number">39.156</span>.66.18</pre></td></tr><tr><td data-num="10"></td><td><pre>www.a.shifen.com.       <span class="token number">30</span>      IN      A       <span class="token number">39.156</span>.66.14</pre></td></tr></table></figure><h4 id="74-ingress介绍"><a class="anchor" href="#74-ingress介绍">#</a> 7.4 Ingress 介绍</h4><p>在前面课程中已经提到，Service 对集群之外暴露服务的主要方式有两种：NotePort 和 LoadBalancer，但是这两种方式，都有一定的缺点：</p><ul><li>NodePort 方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显</li><li>LB 方式的缺点是每个 service 需要一个 LB，浪费、麻烦，并且需要 kubernetes 之外设备的支持</li></ul><p>基于这种现状，kubernetes 提供了 Ingress 资源对象，Ingress 只需要一个 NodePort 或者一个 LB 就可以满足暴露多个 Service 的需求。工作机制大致如下图表示：</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200623092808049.png" alt="img"></p><p>实际上，Ingress 相当于一个 7 层的负载均衡器，是 kubernetes 对反向代理的一个抽象，它的工作原理类似于 Nginx，可以理解成在<strong> Ingress 里建立诸多映射规则，Ingress Controller 通过监听这些配置规则并转化成 Nginx 的反向代理配置，然后对外部提供服务</strong>。在这里有两个核心概念：</p><ul><li>ingress：kubernetes 中的一个对象，作用是定义请求如何转发到 service 的规则</li><li>ingress controller：具体实现反向代理及负载均衡的程序，对 ingress 定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如 Nginx, Contour, Haproxy 等等</li></ul><p>Ingress（以 Nginx 为例）的工作原理如下：</p><ol><li>用户编写 Ingress 规则，说明哪个域名对应 kubernetes 集群中的哪个 Service</li><li>Ingress 控制器动态感知 Ingress 服务规则的变化，然后生成一段对应的 Nginx 反向代理配置</li><li>Ingress 控制器会将生成的 Nginx 配置写入到一个运行着的 Nginx 服务中，并动态更新</li><li>到此为止，其实真正在工作的就是一个 Nginx 了，内部配置了用户定义的请求转发规则</li></ol><p><img data-src="http://oss.itshare.work/blog-images/image-20200516112704764.png" alt="img"></p><h4 id="75-ingress使用"><a class="anchor" href="#75-ingress使用">#</a> 7.5 Ingress 使用</h4><h5 id="751-环境准备-搭建ingress环境"><a class="anchor" href="#751-环境准备-搭建ingress环境">#</a> 7.5.1 环境准备 搭建 ingress 环境</h5><figure class="highlight makefile"><figcaption data-lang="makefile"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建文件夹</span></pre></td></tr><tr><td data-num="2"></td><td><pre>[root<span class="token operator">@</span>k8s-master01 ~]<span class="token comment"># mkdir ingress-controller</span></pre></td></tr><tr><td data-num="3"></td><td><pre>[root<span class="token operator">@</span>k8s-master01 ~]<span class="token comment"># cd ingress-controller/</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 获取 ingress-nginx，本次案例使用的是 0.30 版本</span></pre></td></tr><tr><td data-num="6"></td><td><pre>[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span></pre></td></tr><tr><td data-num="7"></td><td><pre>[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 修改 mandatory.yaml 文件中的仓库</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 修改 quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 为 quay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 创建 ingress-nginx</span></pre></td></tr><tr><td data-num="13"></td><td><pre>[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl apply -f ./</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 查看 ingress-nginx</span></pre></td></tr><tr><td data-num="16"></td><td><pre>[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl get pod -n ingress-nginx</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME                                           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="18"></td><td><pre>pod/nginx-ingress-controller-fbf967dd5-4qpbp   1/1     Running   0          12h</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 查看 service</span></pre></td></tr><tr><td data-num="21"></td><td><pre>[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl get svc -n ingress-nginx</span></pre></td></tr><tr><td data-num="22"></td><td><pre>NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                      AGE</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token target symbol">ingress-nginx   NodePort   10.98.75.163   &lt;none>        80</span><span class="token punctuation">:</span>32240/TCP,443<span class="token punctuation">:</span>31335/TCP   11h</pre></td></tr></table></figure><h5 id="752-准备service和pod"><a class="anchor" href="#752-准备service和pod">#</a> 7.5.2 准备 service 和 pod</h5><p>为了后面的实验比较方便，创建如下图所示的模型</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200516102419998.png" alt="img"></p><p>创建 tomcat-nginx.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>deployment</pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat</pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>8.5<span class="token punctuation">-</span>jre10<span class="token punctuation">-</span>slim</pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None</pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None</pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f tomcat-nginx.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查看</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev</span></pre></td></tr><tr><td data-num="6"></td><td><pre>NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE</pre></td></tr><tr><td data-num="7"></td><td><pre>nginx-service    ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP     48s</pre></td></tr><tr><td data-num="8"></td><td><pre>tomcat-service   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8080</span>/TCP   48s</pre></td></tr></table></figure><h5 id="753-http代理"><a class="anchor" href="#753-http代理">#</a> 7.5.3 Http 代理</h5><p>创建 ingress-http.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>http</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.itheima.com</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">http</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">paths</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.itheima.com</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">http</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">paths</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f ingress-http.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>ingress.extensions/ingress-http created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ing ingress-http -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME           HOSTS                                  ADDRESS   PORTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>ingress-http   nginx.itheima.com,tomcat.itheima.com             <span class="token number">80</span>      22s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看详情</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ing ingress-http  -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="13"></td><td><pre>Rules:</pre></td></tr><tr><td data-num="14"></td><td><pre>Host                Path  Backends</pre></td></tr><tr><td data-num="15"></td><td><pre>----                ----  --------</pre></td></tr><tr><td data-num="16"></td><td><pre>nginx.itheima.com   / nginx-service:80 <span class="token punctuation">(</span><span class="token number">10.244</span>.1.96:80,10.244.1.97:80,10.244.2.112:80<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>tomcat.itheima.com  / tomcat-service:8080<span class="token punctuation">(</span><span class="token number">10.244</span>.1.94:8080,10.244.1.95:8080,10.244.2.111:8080<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 接下来，在本地电脑上配置 host 文件，解析上面的两个域名到 192.168.109.100 (master) 上</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 然后，就可以分别访问 tomcat.itheima.com:32240  和  nginx.itheima.com:32240 查看效果了</span></pre></td></tr></table></figure><h5 id="754-https代理"><a class="anchor" href="#754-https代理">#</a> 7.5.4 Https 代理</h5><p>创建证书</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 生成证书</span></pre></td></tr><tr><td data-num="2"></td><td><pre>openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-keyout</span> tls.key <span class="token parameter variable">-out</span> tls.crt <span class="token parameter variable">-subj</span> <span class="token string">"/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com"</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 创建密钥</span></pre></td></tr><tr><td data-num="5"></td><td><pre>kubectl create secret tls tls-secret <span class="token parameter variable">--key</span> tls.key <span class="token parameter variable">--cert</span> tls.crt</pre></td></tr></table></figure><p>创建 ingress-https.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>https</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">tls</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">-</span> nginx.itheima.com</pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> tomcat.itheima.com</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>secret <span class="token comment"># 指定秘钥</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.itheima.com</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">http</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">paths</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.itheima.com</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">http</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">paths</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token key atrule">backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f ingress-https.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>ingress.extensions/ingress-https created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ing ingress-https -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME            HOSTS                                  ADDRESS         PORTS     AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>ingress-https   nginx.itheima.com,tomcat.itheima.com   <span class="token number">10.104</span>.184.38   <span class="token number">80</span>, <span class="token number">443</span>   2m42s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看详情</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ing ingress-https -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="13"></td><td><pre>TLS:</pre></td></tr><tr><td data-num="14"></td><td><pre>  tls-secret terminates nginx.itheima.com,tomcat.itheima.com</pre></td></tr><tr><td data-num="15"></td><td><pre>Rules:</pre></td></tr><tr><td data-num="16"></td><td><pre>Host              Path Backends</pre></td></tr><tr><td data-num="17"></td><td><pre>----              ---- --------</pre></td></tr><tr><td data-num="18"></td><td><pre>nginx.itheima.com  /  nginx-service:80 <span class="token punctuation">(</span><span class="token number">10.244</span>.1.97:80,10.244.1.98:80,10.244.2.119:80<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>tomcat.itheima.com /  tomcat-service:8080<span class="token punctuation">(</span><span class="token number">10.244</span>.1.99:8080,10.244.2.117:8080,10.244.2.120:8080<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 下面可以通过浏览器访问 https://nginx.itheima.com:31335 和 https://tomcat.itheima.com:31335 来查看了</span></pre></td></tr></table></figure><h3 id="8-数据存储"><a class="anchor" href="#8-数据存储">#</a> 8. 数据存储</h3><p>在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes 引入了 Volume 的概念。</p><p>Volume 是 Pod 中能够被多个容器访问的共享目录，它被定义在 Pod 上，然后被一个 Pod 里的多个容器挂载到具体的文件目录下，kubernetes 通过 Volume 实现同一个 Pod 中不同容器之间的数据共享以及数据的持久化存储。Volume 的生命容器不与 Pod 中单个容器的生命周期相关，当容器终止或者重启时，Volume 中的数据也不会丢失。</p><p>kubernetes 的 Volume 支持多种类型，比较常见的有下面几个：</p><ul><li>简单存储：EmptyDir、HostPath、NFS</li><li>高级存储：PV、PVC</li><li>配置存储：ConfigMap、Secret</li></ul><h4 id="81-基本存储"><a class="anchor" href="#81-基本存储">#</a> 8.1 基本存储</h4><h5 id="811-emptydir"><a class="anchor" href="#811-emptydir">#</a> 8.1.1 EmptyDir</h5><p>EmptyDir 是最基础的 Volume 类型，一个 EmptyDir 就是 Host 上的一个空目录。</p><p>EmptyDir 是在 Pod 被分配到 Node 时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为 kubernetes 会自动分配一个目录，当 Pod 销毁时， EmptyDir 中的数据也会被永久删除。 EmptyDir 用途如下：</p><ul><li>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</li><li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</li></ul><p>接下来，通过一个容器之间文件共享的案例来使用一下 EmptyDir。</p><p>在一个 Pod 中准备两个容器 nginx 和 busybox，然后声明一个 Volume 分别挂在到两个容器的目录中，然后 nginx 容器负责向 Volume 中写日志，busybox 中通过命令将日志内容读到控制台。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200413174713773.png" alt="img"></p><p>创建一个 volume-emptydir.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>emptydir</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将 logs-volume 挂在到 nginx 容器中，对应的目录为 /var/log/nginx</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> <span class="token comment"># 初始命令，动态读取指定文件中内容</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将 logs-volume 挂在到 busybox 容器中，对应的目录为 /logs</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 声明 volume， name 为 logs-volume，类型为 emptyDir</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-emptydir.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/volume-emptydir created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-emptydir -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>volume-emptydir       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          97s   <span class="token number">10.42</span>.2.9   node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 通过 podIp 访问 nginx</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.42.2.9</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 通过 kubectl logs 命令查看指定容器的标准输出</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f volume-emptydir -n dev -c busybox</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">10.42</span>.1.0 - - <span class="token punctuation">[</span><span class="token number">27</span>/Jun/2021:15:08:54 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span></pre></td></tr></table></figure><h5 id="812-hostpath"><a class="anchor" href="#812-hostpath">#</a> 8.1.2 HostPath</h5><p>上节课提到，EmptyDir 中数据不会被持久化，它会随着 Pod 的结束而销毁，如果想简单的将数据持久化到主机中，可以选择 HostPath。</p><p>HostPath 就是将 Node 主机中一个实际目录挂在到 Pod 中，以供容器使用，这样的设计就可以保证 Pod 销毁了，但是数据依据可以存在于 Node 主机上。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200413214031331.png" alt="img"></p><p>创建一个 volume-hostpath.yaml：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>hostpath</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/logs</pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate  <span class="token comment"># 目录存在就使用，不存在就先创建后使用</span></pre></td></tr></table></figure><pre><code>关于type的值的一点说明：
    DirectoryOrCreate 目录存在就使用，不存在就先创建后使用
    Directory   目录必须存在
    FileOrCreate  文件存在就使用，不存在就先创建后使用
    File 文件必须存在 
    Socket  unix套接字必须存在
    CharDevice  字符设备必须存在
    BlockDevice 块设备必须存在
</code></pre><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-hostpath.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/volume-hostpath created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-hostpath -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="8"></td><td><pre>pod-volume-hostpath   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          16s   <span class="token number">10.42</span>.2.10     node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#访问 nginx</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.42.2.10</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f volume-emptydir -n dev -c busybox</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 接下来就可以去 host 的 /root/logs 目录下查看存储的文件了</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">###  注意：下面的操作需要到 Pod 所在的节点运行（案例中是 node1）</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ls /root/logs/</span></pre></td></tr><tr><td data-num="18"></td><td><pre>access.log  error.log</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span></pre></td></tr></table></figure><h5 id="813-nfs"><a class="anchor" href="#813-nfs">#</a> 8.1.3 NFS</h5><p>HostPath 可以解决数据持久化的问题，但是一旦 Node 节点故障了，Pod 如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用 NFS、CIFS。</p><p>NFS 是一个网络文件存储系统，可以搭建一台 NFS 服务器，然后将 Pod 中的存储直接连接到 NFS 系统上，这样的话，无论 Pod 在节点上怎么转移，只要 Node 跟 NFS 的对接没问题，数据就可以成功访问。</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200413215133559.png" alt="img"></p><p>1）首先要准备 nfs 的服务器，这里为了简单，直接是 master 节点做 nfs 服务器</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在 nfs 上安装 nfs 服务</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 准备一个共享目录</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkdir /root/data/nfs -pv</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 将共享目录以读写权限暴露给 192.168.5.0/24 网段中的所有主机</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/exports</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /etc/exports</span></pre></td></tr><tr><td data-num="10"></td><td><pre>/root/data/nfs     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 启动 nfs 服务</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart nfs</span></pre></td></tr></table></figure><p>2）接下来，要在的每个 node 节点上都安装下 nfs，这样的目的是为了 node 节点可以驱动 nfs 设备</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在 node 上安装 nfs 服务，注意不需要启动</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install nfs-utils -y</span></pre></td></tr></table></figure><p>3）接下来，就可以编写 pod 的配置文件了，创建 volume-nfs.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>nfs</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6  <span class="token comment">#nfs 服务器地址</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/nfs <span class="token comment">#共享文件路径</span></pre></td></tr></table></figure><p>4）最后，运行下 pod，观察结果</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-nfs.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/volume-nfs created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-nfs -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>volume-nfs        <span class="token number">2</span>/2     Running   <span class="token number">0</span>          2m9s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 nfs 服务器上的共享目录，发现已经有文件了</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ls /root/data/</span></pre></td></tr><tr><td data-num="12"></td><td><pre>access.log  error.log</pre></td></tr></table></figure><h4 id="82-高级存储"><a class="anchor" href="#82-高级存储">#</a> 8.2 高级存储</h4><p>前面已经学习了使用 NFS 提供存储，此时就要求用户会搭建 NFS 系统，并且会在 yaml 配置 nfs。由于 kubernetes 支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够屏蔽底层存储实现的细节，方便用户使用， kubernetes 引入 PV 和 PVC 两种资源对象。</p><ul><li><p>PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下 PV 由 kubernetes 管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p></li><li><p>PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC 其实就是用户向 kubernetes 系统发出的一种资源需求申请。</p></li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200514194111567.png" alt="img"></p><p>使用了 PV 和 PVC 之后，工作可以得到进一步的细分：</p><ul><li>存储：存储工程师维护</li><li>PV： kubernetes 管理员维护</li><li>PVC：kubernetes 用户维护</li></ul><h5 id="821-pv"><a class="anchor" href="#821-pv">#</a> 8.2.1 PV</h5><p>PV 是存储资源的抽象，下面是资源清单文件:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv2</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span> <span class="token comment"># 存储类型，与底层真正存储对应</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>  <span class="token comment"># 存储能力，目前只支持存储空间的设置</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>  <span class="token comment"># 访问模式</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> <span class="token comment"># 回收策略</span></pre></td></tr></table></figure><p>PV 的关键配置参数说明：</p><ul><li><p><strong>存储类型</strong></p><p>底层实际存储的类型，kubernetes 支持多种存储类型，每种存储类型的配置都有所差异</p></li><li><p><strong>存储能力（capacity）</strong></p></li></ul><p>目前只支持存储空间的设置 (storage=1Gi)，不过未来可能会加入 IOPS、吞吐量等指标的配置</p><ul><li><p><strong>访问模式（accessModes）</strong></p><p>用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p><ul><li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</li><li>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</li><li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></p></li><li><p><strong>回收策略（persistentVolumeReclaimPolicy）</strong></p><p>当 PV 不再被使用了之后，对其的处理方式。目前支持三种策略：</p><ul><li>Retain （保留） 保留数据，需要管理员手工清理数据</li><li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li><li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></p></li><li><p><strong>存储类别</strong></p><p>PV 可以通过 storageClassName 参数指定一个存储类别</p><ul><li>具有特定类别的 PV 只能与请求了该类别的 PVC 进行绑定</li><li>未设定类别的 PV 则只能与不请求任何类别的 PVC 进行绑定</li></ul></li><li><p><strong>状态（status）</strong></p><p>一个 PV 的生命周期中，可能会处于 4 中不同的阶段：</p><ul><li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li><li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li><li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li><li>Failed（失败）： 表示该 PV 的自动回收失败</li></ul></li></ul><p><strong>实验</strong></p><p>使用 NFS 作为存储，来演示 PV 的使用，创建 3 个 PV，对应 NFS 中的 3 个暴露的路径。</p><ol><li>准备 NFS 环境</li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建目录</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkdir /root/data/&#123;pv1,pv2,pv3&#125; -pv</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 暴露服务</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /etc/exports</span></pre></td></tr><tr><td data-num="6"></td><td><pre>/root/data/pv1     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>/root/data/pv2     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>/root/data/pv3     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 重启服务</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment">#  systemctl restart nfs</span></pre></td></tr></table></figure><ol start="2"><li>创建 pv.yaml</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv1</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv1</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv2</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain</pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv2</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6</pre></td></tr><tr><td data-num="30"></td><td><pre>    </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv3</pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 3Gi</pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain</pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv3</pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pv</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pv.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>persistentvolume/pv1 created</pre></td></tr><tr><td data-num="4"></td><td><pre>persistentvolume/pv2 created</pre></td></tr><tr><td data-num="5"></td><td><pre>persistentvolume/pv3 created</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 查看 pv</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -o wide</span></pre></td></tr><tr><td data-num="9"></td><td><pre>NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE</pre></td></tr><tr><td data-num="10"></td><td><pre>pv1    1Gi        RWX            Retain        Available    10s   Filesystem</pre></td></tr><tr><td data-num="11"></td><td><pre>pv2    2Gi        RWX            Retain        Available    10s   Filesystem</pre></td></tr><tr><td data-num="12"></td><td><pre>pv3    3Gi        RWX            Retain        Available    9s    Filesystem</pre></td></tr></table></figure><h5 id="822-pvc"><a class="anchor" href="#822-pvc">#</a> 8.2.2 PVC</h5><p>PVC 是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token comment"># 访问模式</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 采用标签对 PV 选择</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 请求空间</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi</pre></td></tr></table></figure><p>PVC 的关键配置参数说明：</p><ul><li><strong>访问模式（accessModes）</strong></li></ul><p>用于描述用户应用对存储资源的访问权限</p><ul><li><p><strong>选择条件（selector）</strong></p><p>通过 Label Selector 的设置，可使 PVC 对于系统中己存在的 PV 进行筛选</p></li><li><p><strong>存储类别（storageClassName）</strong></p><p>PVC 在定义时可以设定需要的后端存储的类别，只有设置了该 class 的 pv 才能被系统选出</p></li><li><p><strong>资源请求（Resources ）</strong></p><p>描述对存储资源的请求</p></li></ul><p><strong>实验</strong></p><ol><li>创建 pvc.yaml，申请 pv</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc1</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc2</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc3</pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pvc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pvc.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>persistentvolumeclaim/pvc1 created</pre></td></tr><tr><td data-num="4"></td><td><pre>persistentvolumeclaim/pvc2 created</pre></td></tr><tr><td data-num="5"></td><td><pre>persistentvolumeclaim/pvc3 created</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 查看 pvc</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc  -n dev -o wide</span></pre></td></tr><tr><td data-num="9"></td><td><pre>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE</pre></td></tr><tr><td data-num="10"></td><td><pre>pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num="11"></td><td><pre>pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num="12"></td><td><pre>pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 查看 pv</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -o wide</span></pre></td></tr><tr><td data-num="16"></td><td><pre>NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE</pre></td></tr><tr><td data-num="17"></td><td><pre>pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem</pre></td></tr><tr><td data-num="18"></td><td><pre>pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem</pre></td></tr><tr><td data-num="19"></td><td><pre>pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem</pre></td></tr></table></figure><ol start="2"><li>创建 pods.yaml, 使用 pv</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod1</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod1 >> /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc1</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod2</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod2 >> /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/</pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc2</pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pods.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod1 created</pre></td></tr><tr><td data-num="4"></td><td><pre>pod/pod2 created</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="8"></td><td><pre>NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   </pre></td></tr><tr><td data-num="9"></td><td><pre>pod1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.69   node1   </pre></td></tr><tr><td data-num="10"></td><td><pre>pod2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.70   node1  </pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 查看 pvc</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc -n dev -o wide</span></pre></td></tr><tr><td data-num="14"></td><td><pre>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE</pre></td></tr><tr><td data-num="15"></td><td><pre>pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num="16"></td><td><pre>pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num="17"></td><td><pre>pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 查看 pv</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -n dev -o wide</span></pre></td></tr><tr><td data-num="21"></td><td><pre>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE</pre></td></tr><tr><td data-num="22"></td><td><pre>pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem</pre></td></tr><tr><td data-num="23"></td><td><pre>pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem</pre></td></tr><tr><td data-num="24"></td><td><pre>pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 查看 nfs 中的文件存储</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /root/data/pv1/out.txt</span></pre></td></tr><tr><td data-num="28"></td><td><pre>node1</pre></td></tr><tr><td data-num="29"></td><td><pre>node1</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /root/data/pv2/out.txt</span></pre></td></tr><tr><td data-num="31"></td><td><pre>node2</pre></td></tr><tr><td data-num="32"></td><td><pre>node2</pre></td></tr></table></figure><h5 id="823-生命周期"><a class="anchor" href="#823-生命周期">#</a> 8.2.3 生命周期</h5><p>PVC 和 PV 是一一对应的，PV 和 PVC 之间的相互作用遵循以下生命周期：</p><ul><li><p><strong>资源供应</strong>：管理员手动创建底层存储和 PV</p></li><li><p><strong>资源绑定</strong>：用户创建 PVC，kubernetes 负责根据 PVC 的声明去寻找 PV，并绑定</p><p>在用户定义好 PVC 之后，系统将根据 PVC 对存储资源的请求在已存在的 PV 中选择一个满足条件的</p><ul><li>一旦找到，就将该 PV 与用户定义的 PVC 进行绑定，用户的应用就可以使用这个 PVC 了</li><li>如果找不到，PVC 则会无限期处于 Pending 状态，直到等到系统管理员创建了一个符合其要求的 PV</li></ul><p>PV 一旦绑定到某个 PVC 上，就会被这个 PVC 独占，不能再与其他 PVC 进行绑定了</p></li><li><p><strong>资源使用</strong>：用户可在 pod 中像 volume 一样使用 pvc</p><p>Pod 使用 Volume 的定义，将 PVC 挂载到容器内的某个路径进行使用。</p></li><li><p><strong>资源释放</strong>：用户删除 pvc 来释放 pv</p><p>当存储资源使用完毕后，用户可以删除 PVC，与该 PVC 绑定的 PV 将会被标记为 “已释放”，但还不能立刻与其他 PVC 进行绑定。通过之前 PVC 写入的数据可能还被留在存储设备上，只有在清除之后该 PV 才能再次使用。</p></li><li><p><strong>资源回收</strong>：kubernetes 根据 pv 设置的回收策略进行资源的回收</p><p>对于 PV，管理员可以设定回收策略，用于设置与之绑定的 PVC 释放资源之后如何处理遗留数据的问题。只有 PV 的存储空间完成回收，才能供新的 PVC 绑定和使用</p></li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200515002806726.png" alt="img"></p><h4 id="83-配置存储"><a class="anchor" href="#83-配置存储">#</a> 8.3 配置存储</h4><h5 id="831-configmap"><a class="anchor" href="#831-configmap">#</a> 8.3.1 ConfigMap</h5><p>ConfigMap 是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p><p>创建 configmap.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">info</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    username:admin</pre></td></tr><tr><td data-num="9"></td><td><pre>    password:123456</pre></td></tr></table></figure><p>接下来，使用此配置文件创建 configmap</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 configmap</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f configmap.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>configmap/configmap created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 configmap 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe cm configmap -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Name:         configmap</pre></td></tr><tr><td data-num="8"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num="9"></td><td><pre>Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>Data</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="14"></td><td><pre>info:</pre></td></tr><tr><td data-num="15"></td><td><pre>----</pre></td></tr><tr><td data-num="16"></td><td><pre>username:admin</pre></td></tr><tr><td data-num="17"></td><td><pre>password:123456</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>Events:  <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr></table></figure><p>接下来创建一个 pod-configmap.yaml，将上面创建的 configmap 挂载进去</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>configmap</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将 configmap 挂载到目录</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /configmap/config</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 引用 configmap</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">configMap</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-configmap.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod-configmap created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-configmap -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pod-configmap   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#进入容器</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pod-configmap -n dev /bin/sh</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># cd /configmap/config/</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># ls</span></pre></td></tr><tr><td data-num="14"></td><td><pre>info</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># more info</span></pre></td></tr><tr><td data-num="16"></td><td><pre>username:admin</pre></td></tr><tr><td data-num="17"></td><td><pre>password:123456</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 可以看到映射已经成功，每个 configmap 都映射成了一个目录</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># key---> 文件     value----> 文件中的内容</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 此时如果更新 configmap 的内容，容器中的值也会动态更新</span></pre></td></tr></table></figure><h5 id="832-secret"><a class="anchor" href="#832-secret">#</a> 8.3.2 Secret</h5><p>在 kubernetes 中，还存在一种和 ConfigMap 非常类似的对象，称为 Secret 对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p><ol><li>首先使用 base64 对数据进行编码</li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># echo -n 'admin' | base64 #准备 username</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token assign-left variable">YWRtaW4</span><span class="token operator">=</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># echo -n '123456' | base64 #准备 password</span></pre></td></tr><tr><td data-num="4"></td><td><pre>MTIzNDU2</pre></td></tr></table></figure><ol start="2"><li>接下来编写 secret.yaml，并创建 Secret</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">username</span><span class="token punctuation">:</span> YWRtaW4=</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">password</span><span class="token punctuation">:</span> MTIzNDU2</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 secret</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f secret.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>secret/secret created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 secret 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe secret secret -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Name:         secret</pre></td></tr><tr><td data-num="8"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num="9"></td><td><pre>Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>Type:  Opaque</pre></td></tr><tr><td data-num="12"></td><td><pre>Data</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="14"></td><td><pre>password:  <span class="token number">6</span> bytes</pre></td></tr><tr><td data-num="15"></td><td><pre>username:  <span class="token number">5</span> bytes</pre></td></tr></table></figure><ol start="3"><li>创建 pod-secret.yaml，将上面创建的 secret 挂载进去：</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>secret</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将 secret 挂载到目录</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /secret/config</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">secret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> secret</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-secret.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod-secret created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-secret -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pod-secret      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m28s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 进入容器，查看 secret 信息，发现已经自动解码了</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pod-secret /bin/sh -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre>/ <span class="token comment"># ls /secret/config/</span></pre></td></tr><tr><td data-num="13"></td><td><pre>password  username</pre></td></tr><tr><td data-num="14"></td><td><pre>/ <span class="token comment"># more /secret/config/username</span></pre></td></tr><tr><td data-num="15"></td><td><pre>admin</pre></td></tr><tr><td data-num="16"></td><td><pre>/ <span class="token comment"># more /secret/config/password</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">123456</span></pre></td></tr></table></figure><p>至此，已经实现了利用 secret 实现了信息的编码。</p><h3 id="9-安全认证"><a class="anchor" href="#9-安全认证">#</a> 9. 安全认证</h3><h4 id="91-访问控制概述"><a class="anchor" href="#91-访问控制概述">#</a> 9.1 访问控制概述</h4><p>Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对 Kubernetes 的各种<strong>客户端</strong>进行<strong>认证和鉴权</strong>操作。</p><p><strong>客户端</strong></p><p>在 Kubernetes 集群中，客户端通常有两类：</p><ul><li><strong>User Account</strong>：一般是独立于 kubernetes 之外的其他服务管理的用户账号。</li><li><strong>Service Account</strong>：kubernetes 管理的账号，用于为 Pod 中的服务进程在访问 Kubernetes 时提供身份标识。</li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200520102949189.png" alt="img"></p><p><strong>认证、授权与准入控制</strong></p><p>ApiServer 是访问及管理资源对象的唯一入口。任何一个请求访问 ApiServer，都要经过下面三个流程：</p><ul><li>Authentication（认证）：身份鉴别，只有正确的账号才能够通过认证</li><li>Authorization（授权）： 判断用户是否有权限对访问的资源执行特定的动作</li><li>Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200520103942580.png" alt="img"></p><h4 id="92-认证管理"><a class="anchor" href="#92-认证管理">#</a> 9.2 认证管理</h4><p>Kubernetes 集群安全的最关键点在于如何识别并认证客户端身份，它提供了 3 种客户端身份认证方式：</p><ul><li><p>HTTP Base 认证：通过用户名 + 密码的方式认证</p><pre><code>    这种认证方式是把“用户名:密码”用BASE64算法进行编码后的字符串放在HTTP请求中的Header Authorization域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。
</code></pre></li><li><p>HTTP Token 认证：通过一个 Token 来识别合法用户</p><pre><code>    这种认证方式是用一个很长的难以被模仿的字符串--Token来表明客户身份的一种方式。每个Token对应一个用户名，当客户端发起API调用请求时，需要在HTTP Header里放入Token，API Server接到Token后会跟服务器中保存的token进行比对，然后进行用户身份认证的过程。
</code></pre></li><li><p>HTTPS 证书认证：基于 CA 根证书签名的双向数字证书认证方式</p><pre><code>    这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。
</code></pre></li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200518211037434.png" alt="img"></p><p><strong>HTTPS 认证大体分为 3 个过程：</strong></p><ol><li><p>证书申请和下发</p><pre><code>  HTTPS通信双方的服务器向CA机构申请证书，CA机构下发根证书、服务端证书及私钥给申请者
</code></pre></li><li><p>客户端和服务端的双向认证</p><pre><code>  1&gt; 客户端向服务器端发起请求，服务端下发自己的证书给客户端，
     客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥，
     客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器
  2&gt; 客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书，
     在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法
</code></pre></li><li><p>服务器端和客户端进行通信</p><pre><code>  服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。
  服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密
</code></pre></li></ol><blockquote><p>注意: Kubernetes 允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</p></blockquote><h4 id="93-授权管理"><a class="anchor" href="#93-授权管理">#</a> 9.3 授权管理</h4><p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后 Kubernetes 会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p><p>每个发送到 ApiServer 的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p><p>API Server 目前支持以下几种授权策略：</p><ul><li>AlwaysDeny：表示拒绝所有请求，一般用于测试</li><li>AlwaysAllow：允许接收所有请求，相当于集群不需要授权流程（Kubernetes 默认的策略）</li><li>ABAC：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</li><li>Webhook：通过调用外部 REST 服务对用户进行授权</li><li>Node：是一种专用模式，用于对 kubelet 发出的请求进行访问控制</li><li>RBAC：基于角色的访问控制（kubeadm 安装方式下的默认选项）</li></ul><p>RBAC (Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情：<strong>给哪些对象授予了哪些权限</strong></p><p>其中涉及到了下面几个概念：</p><ul><li>对象：User、Groups、ServiceAccount</li><li>角色：代表着一组定义在资源上的可操作动作 (权限) 的集合</li><li>绑定：将定义好的角色跟用户绑定在一起</li></ul><p><img data-src="http://oss.itshare.work/blog-images/image-20200519181209566.png" alt="img"></p><p>RBAC 引入了 4 个顶级资源对象：</p><ul><li>Role、ClusterRole：角色，用于指定一组权限</li><li>RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</li></ul><p><strong>Role、ClusterRole</strong></p><p>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Role 只能对命名空间内的资源进行授权，需要指定 nameapce</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>  <span class="token comment"># 支持的 API 组列表，"" 空字符串，表示核心 API 群</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span> <span class="token comment"># 支持的资源对象列表</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span> <span class="token comment"># 允许的对资源对象的操作方法列表</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ClusterRole 可以对集群范围内资源、跨 namespaces 的范围资源、非资源类型进行授权</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>需要详细说明的是，rules 中的参数：</p><ul><li><p>apiGroups: 支持的 API 组列表</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token string">""</span>,<span class="token string">"apps"</span>, <span class="token string">"autoscaling"</span>, <span class="token string">"batch"</span></pre></td></tr></table></figure></li><li><p>resources：支持的资源对象列表</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token string">"services"</span>, <span class="token string">"endpoints"</span>, <span class="token string">"pods"</span>,<span class="token string">"secrets"</span>,<span class="token string">"configmaps"</span>,<span class="token string">"crontabs"</span>,<span class="token string">"deployments"</span>,<span class="token string">"jobs"</span>,</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">"nodes"</span>,<span class="token string">"rolebindings"</span>,<span class="token string">"clusterroles"</span>,<span class="token string">"daemonsets"</span>,<span class="token string">"replicasets"</span>,<span class="token string">"statefulsets"</span>,</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">"horizontalpodautoscalers"</span>,<span class="token string">"replicationcontrollers"</span>,<span class="token string">"cronjobs"</span></pre></td></tr></table></figure></li><li><p>verbs：对资源对象的操作方法列表</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"create"</span>, <span class="token string">"update"</span>, <span class="token string">"patch"</span>, <span class="token string">"delete"</span>, <span class="token string">"exec"</span></pre></td></tr></table></figure></li></ul><p><strong>RoleBinding、ClusterRoleBinding</strong></p><p>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># RoleBinding 可以将同一 namespace 中的 subject 绑定到某个 Role 下，则此 subject 即具有该 Role 定义的权限</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ClusterRoleBinding 在整个集群级别和所有 namespaces 将特定的 subject 与 ClusterRole 绑定，授予权限</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole<span class="token punctuation">-</span>binding</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><p><strong>RoleBinding 引用 ClusterRole 进行授权</strong></p><p>RoleBinding 可以引用 ClusterRole，对属于同一命名空间内 ClusterRole 定义的资源主体进行授权。</p><pre><code>    一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。
</code></pre><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 虽然 authorization-clusterrole 是一个集群角色，但是因为使用了 RoleBinding</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 所以 heima 只能读取 dev 命名空间中的资源</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding<span class="token punctuation">-</span>ns</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><p><strong>实战：创建一个只能管理 dev 空间下 Pods 资源的账号</strong></p><ol><li>创建账号</li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1) 创建证书</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cd /etc/kubernetes/pki/</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># (umask 077;openssl genrsa -out devman.key 2048)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 2) 用 apiserver 的证书去签署</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 2-1) 签名申请，申请的用户是 devman, 组是 devgroup</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl req -new -key devman.key -out devman.csr -subj "/CN=devman/O=devgroup"     </span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 2-2) 签署证书</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 3) 设置集群、用户、上下文信息</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 切换账户到 devman</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span></pre></td></tr><tr><td data-num="20"></td><td><pre>Switched to context <span class="token string">"devman@kubernetes"</span><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 查看 dev 下 pod，发现没有权限</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="24"></td><td><pre>Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: pods is forbidden: User <span class="token string">"devman"</span> cannot list resource <span class="token string">"pods"</span> <span class="token keyword">in</span> API group <span class="token string">""</span> <span class="token keyword">in</span> the namespace <span class="token string">"dev"</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 切换到 admin 账户</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span></pre></td></tr><tr><td data-num="28"></td><td><pre>Switched to context <span class="token string">"kubernetes-admin@kubernetes"</span><span class="token builtin class-name">.</span></pre></td></tr></table></figure><p>2） 创建 Role 和 RoleBinding，为 devman 用户授权</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> devman</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl create -f dev-role.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>role.rbac.authorization.k8s.io/dev-role created</pre></td></tr><tr><td data-num="3"></td><td><pre>rolebinding.rbac.authorization.k8s.io/authorization-role-binding created</pre></td></tr></table></figure><ol start="3"><li>切换账户，再次验证</li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 切换账户到 devman</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Switched to context <span class="token string">"devman@kubernetes"</span><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 再次查看</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                                 READY   STATUS             RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>nginx-deployment-66cb59b984-8wp2k    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h</pre></td></tr><tr><td data-num="9"></td><td><pre>nginx-deployment-66cb59b984-dc46j    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h</pre></td></tr><tr><td data-num="10"></td><td><pre>nginx-deployment-66cb59b984-thfck    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 为了不影响后面的学习，切回 admin 账户</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span></pre></td></tr><tr><td data-num="14"></td><td><pre>Switched to context <span class="token string">"kubernetes-admin@kubernetes"</span><span class="token builtin class-name">.</span></pre></td></tr></table></figure><h4 id="94-准入控制"><a class="anchor" href="#94-准入控制">#</a> 9.4 准入控制</h4><p>通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver 才会处理这个请求。</p><p>准入控制是一个可配置的控制器列表，可以通过在 Api-Server 上通过命令行设置选择执行哪些准入控制器：</p><pre><code>--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,
                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</code></pre><p>只有当所有的准入控制器都检查通过之后，apiserver 才执行该请求，否则返回拒绝。</p><p>当前可配置的 Admission Control 准入控制如下：</p><ul><li>AlwaysAdmit：允许所有请求</li><li>AlwaysDeny：禁止所有请求，一般用于测试</li><li>AlwaysPullImages：在启动容器之前总去下载镜像</li><li>DenyExecOnPrivileged：它会拦截所有想在 Privileged Container 上执行命令的请求</li><li>ImagePolicyWebhook：这个插件将允许后端的一个 Webhook 程序来完成 admission controller 的功能。</li><li>Service Account：实现 ServiceAccount 实现了自动化</li><li>SecurityContextDeny：这个插件将使用 SecurityContext 的 Pod 中的定义全部失效</li><li>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在 namespace 上的配额不会超标</li><li>LimitRanger：用于资源限制管理，作用于 namespace 上，确保对 Pod 进行资源限制</li><li>InitialResources：为未设置资源请求与限制的 Pod，根据其镜像的历史资源的使用情况进行设置</li><li>NamespaceLifecycle：如果尝试在一个不存在的 namespace 中创建资源对象，则该创建请求将被拒绝。当删除一个 namespace 时，系统将会删除该 namespace 中所有对象。</li><li>DefaultStorageClass：为了实现共享存储的动态供应，为未指定 StorageClass 或 PV 的 PVC 尝试匹配默认的 StorageClass，尽可能减少用户在申请 PVC 时所需了解的后端存储细节</li><li>DefaultTolerationSeconds：这个插件为那些没有设置 forgiveness tolerations 并具有 notready:NoExecute 和 unreachable:NoExecute 两种 taints 的 Pod 设置默认的 “容忍” 时间，为 5min</li><li>PodSecurityPolicy：这个插件用于在创建或修改 Pod 时决定是否根据 Pod 的 security context 和可用的 PodSecurityPolicy 对 Pod 的安全策略进行控制</li></ul><h3 id="10-dashboard"><a class="anchor" href="#10-dashboard">#</a> 10. DashBoard</h3><p>之前在 kubernetes 中完成的所有操作都是通过命令行工具 kubectl 完成的。其实，为了提供更丰富的用户体验，kubernetes 还开发了一个基于 web 的用户界面（Dashboard）。用户可以使用 Dashboard 部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理 kubernetes 中各种资源。</p><h4 id="101-部署dashboard"><a class="anchor" href="#101-部署dashboard">#</a> 10.1 部署 Dashboard</h4><ol><li>下载 yaml，并运行 Dashboard</li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载 yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 修改 kubernetes-dashboard 的 Service 类型</span></pre></td></tr><tr><td data-num="5"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num="6"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="7"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="8"></td><td><pre>  labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>    k8s-app: kubernetes-dashboard</pre></td></tr><tr><td data-num="10"></td><td><pre>  name: kubernetes-dashboard</pre></td></tr><tr><td data-num="11"></td><td><pre>  namespace: kubernetes-dashboard</pre></td></tr><tr><td data-num="12"></td><td><pre>spec:</pre></td></tr><tr><td data-num="13"></td><td><pre>  type: NodePort  <span class="token comment"># 新增</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  ports:</pre></td></tr><tr><td data-num="15"></td><td><pre>    - port: <span class="token number">443</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      targetPort: <span class="token number">8443</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      nodePort: <span class="token number">30009</span>  <span class="token comment"># 新增</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  selector:</pre></td></tr><tr><td data-num="19"></td><td><pre>    k8s-app: kubernetes-dashboard</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 部署</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f recommended.yaml</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># 查看 namespace 下的 kubernetes-dashboard 下的资源</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod,svc -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num="26"></td><td><pre>NAME                                            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="27"></td><td><pre>pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          111s</pre></td></tr><tr><td data-num="28"></td><td><pre>pod/kubernetes-dashboard-56484d4c5-z95z5        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          111s</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE</pre></td></tr><tr><td data-num="31"></td><td><pre>service/dashboard-metrics-scraper  ClusterIP  <span class="token number">10.96</span>.89.218    <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token number">8000</span>/TCP        111s</pre></td></tr><tr><td data-num="32"></td><td><pre>service/kubernetes-dashboard       NodePort   <span class="token number">10.104</span>.178.171  <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token number">443</span>:30009/TCP   111s</pre></td></tr></table></figure><p>2）创建访问账户，获取 token</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建账号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 授权</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 获取账号 token</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span></pre></td></tr><tr><td data-num="9"></td><td><pre>dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   <span class="token number">3</span>      2m35s</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num="12"></td><td><pre>Name:         dashboard-admin-token-xbqhh</pre></td></tr><tr><td data-num="13"></td><td><pre>Namespace:    kubernetes-dashboard</pre></td></tr><tr><td data-num="14"></td><td><pre>Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>Annotations:  kubernetes.io/service-account.name: dashboard-admin</pre></td></tr><tr><td data-num="16"></td><td><pre>              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>Type:  kubernetes.io/service-account-token</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>Data</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="22"></td><td><pre>namespace:  <span class="token number">20</span> bytes</pre></td></tr><tr><td data-num="23"></td><td><pre>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw</pre></td></tr><tr><td data-num="24"></td><td><pre>ca.crt:     <span class="token number">1025</span> bytes</pre></td></tr></table></figure><p>3）通过浏览器访问 Dashboard 的 UI</p><p>在登录页面上输入上面的 token</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200520144548997.png" alt="image-20200520144548997"></p><p>出现下面的页面代表成功</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200520144959353.png" alt="image-20200520144959353"></p><h4 id="102-使用dashboard"><a class="anchor" href="#102-使用dashboard">#</a> 10.2 使用 DashBoard</h4><p>本章节以 Deployment 为例演示 DashBoard 的使用</p><p><strong>查看</strong></p><p>选择指定的命名空间 <code>dev</code> ，然后点击 <code>Deployments</code> ，查看 dev 空间下的所有 deployment</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200520154628679.png" alt="img"></p><p><strong>扩缩容</strong></p><p>在 <code>Deployment</code> 上点击 <code>规模</code> ，然后指定 <code>目标副本数量</code> ，点击确定</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200520162605102.png" alt="img"></p><p><strong>编辑</strong></p><p>在 <code>Deployment</code> 上点击 <code>编辑</code> ，然后修改 <code>yaml文件</code> ，点击确定</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200520163253644.png" alt="image-20200520163253644"></p><p><strong>查看 Pod</strong></p><p>点击 <code>Pods</code> , 查看 pods 列表</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200520163552110.png" alt="img"></p><p><strong>操作 Pod</strong></p><p>选中某个 Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</p><p><img data-src="http://oss.itshare.work/blog-images/image-20200520163832827.png" alt="img"></p><blockquote><p>Dashboard 提供了 kubectl 的绝大部分功能，这里不再一一演示</p></blockquote><div class="tags"><a href="/tags/Kubernetes/" rel="tag"><i class="ic i-tag"></i> Kubernetes</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-05-16 21:07:46" itemprop="dateModified" datetime="2023-05-16T21:07:46+08:00">2023-05-16</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>yuan kun <i class="ic i-at"><em>@</em></i>Hide your thoughts</li><li class="link"><strong>本文链接：</strong> <a href="http://blog.itshare.work/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/" title="Kubernetes详细教程">http://blog.itshare.work/Kubernetes/k8s详细教程/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Kubernetes/Kubernetes%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" itemprop="url" rel="prev" data-background-image="http:&#x2F;&#x2F;oss.itshare.work&#x2F;itshare-work-images&#x2F;7.jpg" title="Kubernetes常用命令"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Kubernetes</span><h3>Kubernetes常用命令</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#kubernetes%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes 详细教程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-kubernetes%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">1. Kubernetes 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E6%BC%94%E5%8F%98"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 应用部署方式演变</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-kubernetes%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 kubernetes 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-kubernetes%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 kubernetes 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-kubernetes%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 kubernetes 概念</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-kubernetes%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">2. kubernetes 集群环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#21-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 前置知识点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-kubeadm-%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 kubeadm 部署方式介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#23-%E5%AE%89%E8%A3%85%E8%A6%81%E6%B1%82"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 安装要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#24-%E6%9C%80%E7%BB%88%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 最终目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5 准备环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#26-%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.6.</span> <span class="toc-text">2.6 环境初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#261-%E6%A3%80%E6%9F%A5%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">2.6.1 检查操作系统的版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#262-%E4%B8%BB%E6%9C%BA%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">2.6.2 主机名解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#263-%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">2.6.3 时间同步</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#264-%E7%A6%81%E7%94%A8iptable%E5%92%8Cfirewalld%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">2.6.4 禁用 iptable 和 firewalld 服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#265-%E7%A6%81%E7%94%A8selinux"><span class="toc-number">1.2.6.5.</span> <span class="toc-text">2.6.5 禁用 selinux</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#266-%E7%A6%81%E7%94%A8swap%E5%88%86%E5%8C%BA"><span class="toc-number">1.2.6.6.</span> <span class="toc-text">2.6.6 禁用 swap 分区</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#267-%E4%BF%AE%E6%94%B9linux%E7%9A%84%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.6.7.</span> <span class="toc-text">2.6.7 修改 linux 的内核参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#268-%E9%85%8D%E7%BD%AEipvs%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.6.8.</span> <span class="toc-text">2.6.8 配置 ipvs 功能</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#269-%E5%AE%89%E8%A3%85docker"><span class="toc-number">1.2.6.9.</span> <span class="toc-text">2.6.9 安装 docker</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2610-%E5%AE%89%E8%A3%85kubernetes%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.6.10.</span> <span class="toc-text">2.6.10 安装 Kubernetes 组件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2611-%E5%87%86%E5%A4%87%E9%9B%86%E7%BE%A4%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.6.11.</span> <span class="toc-text">2.6.11 准备集群镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2611-%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.6.12.</span> <span class="toc-text">2.6.11 集群初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2613-%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E5%8F%AA%E5%9C%A8master%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C%E5%8D%B3%E5%8F%AF"><span class="toc-number">1.2.6.13.</span> <span class="toc-text">2.6.13 安装网络插件，只在 master 节点操作即可</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2614-%E4%BD%BF%E7%94%A8kubeadm-reset%E9%87%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.6.14.</span> <span class="toc-text">2.6.14 使用 kubeadm reset 重置集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2615-%E9%87%8D%E5%90%AFkubelet%E5%92%8Cdocker"><span class="toc-number">1.2.6.15.</span> <span class="toc-text">2.6.15 重启 kubelet 和 docker</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2616-kubeadm%E4%B8%AD%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.6.16.</span> <span class="toc-text">2.6.16 kubeadm 中的命令</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#27-%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.7.</span> <span class="toc-text">2.7 集群测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#271-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAnginx%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">2.7.1 创建一个 nginx 服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#272-%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">2.7.2 暴露端口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#273-%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">2.7.3 查看服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#274-%E6%9F%A5%E7%9C%8Bpod"><span class="toc-number">1.2.7.4.</span> <span class="toc-text">2.7.4 查看 pod</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">3. 资源管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#31-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 资源管理介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#32-yaml%E8%AF%AD%E8%A8%80%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 YAML 语言介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#33-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 资源管理方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#331-%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">3.3.1 命令式对象管理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#332-%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">3.3.2 命令式对象配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#333-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">3.3.3 声明式对象配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8"><span class="toc-number">1.4.</span> <span class="toc-text">4. 实战入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#41-namespace"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 Namespace</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#411-%E6%9F%A5%E7%9C%8B"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">4.1.1 查看</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#412-%E5%88%9B%E5%BB%BA"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">4.1.2 创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#413-%E5%88%A0%E9%99%A4"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">4.1.3 删除</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#414-%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">4.1.4 配置方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#42-pod"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#421-%E5%88%9B%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">4.2.1 创建并运行</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#422-%E6%9F%A5%E7%9C%8Bpod%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">4.2.2 查看 pod 信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#423-%E8%AE%BF%E9%97%AEpod"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">4.2.3 访问 Pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#424-%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9Apod"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">4.2.4 删除指定 Pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#425-%E9%85%8D%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">4.2.5 配置操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#43-label"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 Label</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#431-%E5%91%BD%E4%BB%A4%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">4.3.1 命令方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#432-%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">4.3.2 配置方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#44-deployment"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#441%E5%BE%85%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">4.4.1 待操作。。。。。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#442-%E9%85%8D%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">4.4.2 配置操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#45-service"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5 Service</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#451-%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8%E5%8F%AF%E8%AE%BF%E9%97%AE%E7%9A%84service"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">4.5.1 创建集群内部可访问的 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#452-%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%A4%96%E9%83%A8%E4%B9%9F%E5%8F%AF%E8%AE%BF%E9%97%AE%E7%9A%84service"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">4.5.2 创建集群外部也可访问的 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#453-%E5%88%A0%E9%99%A4service"><span class="toc-number">1.4.5.3.</span> <span class="toc-text">4.5.3 删除 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#454-%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.5.4.</span> <span class="toc-text">4.5.4 配置方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-pod%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.5.</span> <span class="toc-text">5. Pod 详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#51-pod%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 Pod 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#511-pod%E7%BB%93%E6%9E%84"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">5.1.1 Pod 结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#512-pod%E5%AE%9A%E4%B9%89"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">5.1.2 Pod 定义</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#52-pod%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 Pod 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#521-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">5.2.1 基本配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#522-%E9%95%9C%E5%83%8F%E6%8B%89%E5%8F%96"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">5.2.2 镜像拉取</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#523-%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">5.2.3 启动命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#524-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">5.2.4 环境变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#525-%E7%AB%AF%E5%8F%A3%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">5.2.5 端口设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#526-%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">1.5.2.6.</span> <span class="toc-text">5.2.6 资源配额</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#53-pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 Pod 生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#531-%E5%88%9B%E5%BB%BA%E5%92%8C%E7%BB%88%E6%AD%A2"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">5.3.1 创建和终止</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#532-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">5.3.2 初始化容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#533-%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">5.3.3 钩子函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#534-%E5%AE%B9%E5%99%A8%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">5.3.4 容器探测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#535-%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.3.5.</span> <span class="toc-text">5.3.5 重启策略</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#54-pod%E8%B0%83%E5%BA%A6"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.4 Pod 调度</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#541-%E5%AE%9A%E5%90%91%E8%B0%83%E5%BA%A6"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">5.4.1 定向调度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#542-%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">5.4.2 亲和性调度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#543-%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">5.4.3 污点和容忍</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.6.</span> <span class="toc-text">6. Pod 控制器详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#61-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 Pod 控制器介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#62-replicasetrs"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 ReplicaSet(RS)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#63-deploymentdeploy"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 Deployment(Deploy)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#631-%E5%88%9B%E5%BB%BAdeployment"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">6.3.1 创建 deployment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#632-%E6%89%A9%E7%BC%A9%E5%AE%B9"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">6.3.2 扩缩容</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#633-%E7%89%88%E6%9C%AC%E5%9B%9E%E9%80%80"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">6.3.3 版本回退</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#634-%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83"><span class="toc-number">1.6.3.4.</span> <span class="toc-text">6.3.4 金丝雀发布</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#64-horizontal-pod-autoscalerhpa"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 Horizontal Pod Autoscaler(HPA)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#641-%E5%AE%89%E8%A3%85metrics-server"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">6.4.1 安装 metrics-server</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#642-%E5%87%86%E5%A4%87deployment%E5%92%8Cservie"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">6.4.2 准备 deployment 和 servie</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#643-%E9%83%A8%E7%BD%B2hpa"><span class="toc-number">1.6.4.3.</span> <span class="toc-text">6.4.3 部署 HPA</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#644-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.4.4.</span> <span class="toc-text">6.4.4 测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#65-daemonsetds"><span class="toc-number">1.6.5.</span> <span class="toc-text">6.5 DaemonSet(DS)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#66-job"><span class="toc-number">1.6.6.</span> <span class="toc-text">6.6 Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#67-cronjobcj"><span class="toc-number">1.6.7.</span> <span class="toc-text">6.7 CronJob(CJ)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-service%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.7.</span> <span class="toc-text">7. Service 详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#71-service%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 Service 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#711-userspace-%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">7.1.1 userspace 模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#712-iptables-%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">7.1.2 iptables 模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#713-ipvs-%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">7.1.3 ipvs 模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#72-service%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 Service 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#73-service%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 Service 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#731-%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">7.3.1 实验环境准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#732-clusterip%E7%B1%BB%E5%9E%8B%E7%9A%84service"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">7.3.2 ClusterIP 类型的 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#733-endpoint"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">7.3.3 Endpoint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#734-headliness%E7%B1%BB%E5%9E%8B%E7%9A%84service"><span class="toc-number">1.7.3.4.</span> <span class="toc-text">7.3.4 HeadLiness 类型的 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#735-nodeport%E7%B1%BB%E5%9E%8B%E7%9A%84service"><span class="toc-number">1.7.3.5.</span> <span class="toc-text">7.3.5 NodePort 类型的 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#736-loadbalancer%E7%B1%BB%E5%9E%8B%E7%9A%84service"><span class="toc-number">1.7.3.6.</span> <span class="toc-text">7.3.6 LoadBalancer 类型的 Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#737-externalname%E7%B1%BB%E5%9E%8B%E7%9A%84service"><span class="toc-number">1.7.3.7.</span> <span class="toc-text">7.3.7 ExternalName 类型的 Service</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#74-ingress%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.4.</span> <span class="toc-text">7.4 Ingress 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#75-ingress%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.5.</span> <span class="toc-text">7.5 Ingress 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#751-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-%E6%90%AD%E5%BB%BAingress%E7%8E%AF%E5%A2%83"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">7.5.1 环境准备 搭建 ingress 环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#752-%E5%87%86%E5%A4%87service%E5%92%8Cpod"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">7.5.2 准备 service 和 pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#753-http%E4%BB%A3%E7%90%86"><span class="toc-number">1.7.5.3.</span> <span class="toc-text">7.5.3 Http 代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#754-https%E4%BB%A3%E7%90%86"><span class="toc-number">1.7.5.4.</span> <span class="toc-text">7.5.4 Https 代理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">1.8.</span> <span class="toc-text">8. 数据存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#81-%E5%9F%BA%E6%9C%AC%E5%AD%98%E5%82%A8"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 基本存储</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#811-emptydir"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">8.1.1 EmptyDir</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#812-hostpath"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">8.1.2 HostPath</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#813-nfs"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">8.1.3 NFS</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#82-%E9%AB%98%E7%BA%A7%E5%AD%98%E5%82%A8"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 高级存储</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#821-pv"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">8.2.1 PV</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#822-pvc"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">8.2.2 PVC</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#823-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">8.2.3 生命周期</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#83-%E9%85%8D%E7%BD%AE%E5%AD%98%E5%82%A8"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 配置存储</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#831-configmap"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">8.3.1 ConfigMap</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#832-secret"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">8.3.2 Secret</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.9.</span> <span class="toc-text">9. 安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#91-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.1 访问控制概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#92-%E8%AE%A4%E8%AF%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.2 认证管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#93-%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86"><span class="toc-number">1.9.3.</span> <span class="toc-text">9.3 授权管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#94-%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">1.9.4.</span> <span class="toc-text">9.4 准入控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-dashboard"><span class="toc-number">1.10.</span> <span class="toc-text">10. DashBoard</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#101-%E9%83%A8%E7%BD%B2dashboard"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.1 部署 Dashboard</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#102-%E4%BD%BF%E7%94%A8dashboard"><span class="toc-number">1.10.2.</span> <span class="toc-text">10.2 使用 DashBoard</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/" rel="bookmark" title="搭建Kubernetes集群">搭建Kubernetes集群</a></li><li><a href="/Kubernetes/Kubernetes%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" rel="bookmark" title="Kubernetes常用命令">Kubernetes常用命令</a></li><li><a href="/Kubernetes/Kubernetes%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="bookmark" title="Kubernetes读书笔记">Kubernetes读书笔记</a></li><li class="active"><a href="/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/" rel="bookmark" title="Kubernetes详细教程">Kubernetes详细教程</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="yuan kun" data-src="/images/avatar.jpg"><p class="name" itemprop="name">yuan kun</p><div class="description" itemprop="description">解决各种服务器、网络、应用等技术问题，致力于保障系统稳定、高效运行</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">16</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">7</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">3</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==" title="https:&#x2F;&#x2F;github.com&#x2F;amehime&#x2F;hexo-theme-shoka"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Docker/" title="分类于 Docker">Docker</a></div><span><a href="/Docker/docker-compose%E9%83%A8%E7%BD%B2MySQL/" title="docker-compose部署MySql">docker-compose部署MySql</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Docker/" title="分类于 Docker">Docker</a></div><span><a href="/Docker/docker-install/" title="Docker安装部署">Docker安装部署</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Ansible/" title="分类于 Ansible">Ansible</a></div><span><a href="/Ansible/Ansible/" title="运维自动化工具Ansible(一)">运维自动化工具Ansible(一)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于 Kubernetes">Kubernetes</a></div><span><a href="/Kubernetes/Kubernetes%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="Kubernetes读书笔记">Kubernetes读书笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于 Kubernetes">Kubernetes</a></div><span><a href="/Kubernetes/Kubernetes%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Kubernetes常用命令">Kubernetes常用命令</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Docker/" title="分类于 Docker">Docker</a></div><span><a href="/Docker/Docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/" title="Docker镜像加速">Docker镜像加速</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a></div><span><a href="/Linux/DNS/" title="DNS服务">DNS服务</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a></div><span><a href="/Linux/centos%E7%B3%BB%E7%BB%9Fyum%E9%85%8D%E7%BD%AE/" title="Centos系统yum源配置">Centos系统yum源配置</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/MySQL/" title="分类于 MySQL">MySQL</a></div><span><a href="/MySQL/MySQL/" title="MySQL数据库基础和安装使用">MySQL数据库基础和安装使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/zabbix/" title="分类于 zabbix">zabbix</a></div><span><a href="/zabbix/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/" title="zabbix5部署安装">zabbix5部署安装</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">yuan kun @ Cookie</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">281k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:16</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Kubernetes/k8s详细教程/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->