{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hide your thoughts",
    "subtitle": "",
    "icon": "http://blog.itshare.work/images/favicon.ico",
    "description": "解决各种服务器、网络、应用等技术问题，致力于保障系统稳定、高效运行",
    "home_page_url": "http://blog.itshare.work",
    "items": [
        {
            "id": "http://blog.itshare.work/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/",
            "url": "http://blog.itshare.work/Kubernetes/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/",
            "title": "Kubernetes详细教程",
            "date_published": "2023-05-15T15:15:18.000Z",
            "content_html": "<h2 id=\"kubernetes详细教程\"><a class=\"anchor\" href=\"#kubernetes详细教程\">#</a> Kubernetes 详细教程</h2>\n<h3 id=\"1-kubernetes介绍\"><a class=\"anchor\" href=\"#1-kubernetes介绍\">#</a> 1. Kubernetes 介绍</h3>\n<h4 id=\"11-应用部署方式演变\"><a class=\"anchor\" href=\"#11-应用部署方式演变\">#</a> 1.1 应用部署方式演变</h4>\n<p>在部署应用程序的方式上，主要经历了三个时代：</p>\n<ul>\n<li>\n<p><strong>传统部署</strong>：互联网早期，会直接将应用程序部署在物理机上</p>\n<blockquote>\n<p>优点：简单，不需要其它技术的参与</p>\n<p>缺点：不能为应用程序定义资源使用边界，很难合理地分配计算资源，而且程序之间容易产生影响</p>\n</blockquote>\n</li>\n<li>\n<p><strong>虚拟化部署</strong>：可以在一台物理机上运行多个虚拟机，每个虚拟机都是独立的一个环境</p>\n<blockquote>\n<p>优点：程序环境不会相互产生影响，提供了一定程度的安全性</p>\n<p>缺点：增加了操作系统，浪费了部分资源</p>\n</blockquote>\n</li>\n<li>\n<p><strong>容器化部署</strong>：与虚拟化类似，但是共享了操作系统</p>\n<blockquote>\n<p>优点：</p>\n<p>可以保证每个容器拥有自己的文件系统、CPU、内存、进程空间等</p>\n<p>运行应用程序所需要的资源都被容器包装，并和底层基础架构解耦</p>\n<p>容器化的应用程序可以跨云服务商、跨 Linux 操作系统发行版进行部署</p>\n</blockquote>\n</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200505183738289.png\" alt=\"image-20200505183738289\" /></p>\n<p>容器化部署方式给带来很多的便利，但是也会出现一些问题，比如说：</p>\n<ul>\n<li>一个容器故障停机了，怎么样让另外一个容器立刻启动去替补停机的容器</li>\n<li>当并发访问量变大的时候，怎么样做到横向扩展容器数量</li>\n</ul>\n<p>这些容器管理的问题统称为<strong>容器编排</strong>问题，为了解决这些容器编排问题，就产生了一些容器编排的软件：</p>\n<ul>\n<li><strong>Swarm</strong>：Docker 自己的容器编排工具</li>\n<li><strong>Mesos</strong>：Apache 的一个资源统一管控的工具，需要和 Marathon 结合使用</li>\n<li><strong>Kubernetes</strong>：Google 开源的的容器编排工具</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200524150339551.png\" alt=\"image-20200524150339551\" /></p>\n<h4 id=\"12-kubernetes简介\"><a class=\"anchor\" href=\"#12-kubernetes简介\">#</a> 1.2 kubernetes 简介</h4>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200406232838722.png\" alt=\"image-20200406232838722\" /></p>\n<p>kubernetes，是一个全新的基于容器技术的分布式架构领先方案，是谷歌严格保密十几年的秘密武器 ----Borg 系统的一个开源版本，于 2014 年 9 月发布第一个版本，2015 年 7 月发布第一个正式版本。</p>\n<p>kubernetes 的本质是<strong>一组服务器集群</strong>，它可以在集群的每个节点上运行特定的程序，来对节点中的容器进行管理。目的是实现资源管理的自动化，主要提供了如下的主要功能：</p>\n<ul>\n<li><strong>自我修复</strong>：一旦某一个容器崩溃，能够在 1 秒中左右迅速启动新的容器</li>\n<li><strong>弹性伸缩</strong>：可以根据需要，自动对集群中正在运行的容器数量进行调整</li>\n<li><strong>服务发现</strong>：服务可以通过自动发现的形式找到它所依赖的服务</li>\n<li><strong>负载均衡</strong>：如果一个服务起动了多个容器，能够自动实现请求的负载均衡</li>\n<li><strong>版本回退</strong>：如果发现新发布的程序版本有问题，可以立即回退到原来的版本</li>\n<li><strong>存储编排</strong>：可以根据容器自身的需求自动创建存储卷</li>\n</ul>\n<h4 id=\"13-kubernetes组件\"><a class=\"anchor\" href=\"#13-kubernetes组件\">#</a> 1.3 kubernetes 组件</h4>\n<p>一个 kubernetes 集群主要是由<strong>控制节点 (master)</strong>、** 工作节点 (node)** 构成，每个节点上都会安装不同的组件。</p>\n<p><strong>master：集群的控制平面，负责集群的决策 (管理)</strong></p>\n<blockquote>\n<p><strong>ApiServer</strong> : 资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API 注册和发现等机制</p>\n<p><strong>Scheduler</strong> : 负责集群资源调度，按照预定的调度策略将 Pod 调度到相应的 node 节点上</p>\n<p><strong>ControllerManager</strong> : 负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等</p>\n<p><strong>Etcd</strong> ：负责存储集群中各种资源对象的信息</p>\n</blockquote>\n<p><strong>node：集群的数据平面，负责为容器提供运行环境 (干活)</strong></p>\n<blockquote>\n<p><strong>Kubelet</strong> : 负责维护容器的生命周期，即通过控制 docker，来创建、更新、销毁容器</p>\n<p><strong>KubeProxy</strong> : 负责提供集群内部的服务发现和负载均衡</p>\n<p><strong>Docker</strong> : 负责节点上容器的各种操作</p>\n</blockquote>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200406184656917.png\" alt=\"image-20200406184656917\" /></p>\n<p>下面，以部署一个 nginx 服务来说明 kubernetes 系统各个组件调用关系：</p>\n<ol>\n<li>\n<p>首先要明确，一旦 kubernetes 环境启动之后，master 和 node 都会将自身的信息存储到 etcd 数据库中</p>\n</li>\n<li>\n<p>一个 nginx 服务的安装请求会首先被发送到 master 节点的 apiServer 组件</p>\n</li>\n<li>\n<p>apiServer 组件会调用 scheduler 组件来决定到底应该把这个服务安装到哪个 node 节点上</p>\n<p>在此时，它会从 etcd 中读取各个 node 节点的信息，然后按照一定的算法进行选择，并将结果告知 apiServer</p>\n</li>\n<li>\n<p>apiServer 调用 controller-manager 去调度 Node 节点安装 nginx 服务</p>\n</li>\n<li>\n<p>kubelet 接收到指令后，会通知 docker，然后由 docker 来启动一个 nginx 的 pod</p>\n<p>pod 是 kubernetes 的最小操作单元，容器必须跑在 pod 中至此，</p>\n</li>\n<li>\n<p>一个 nginx 服务就运行了，如果需要访问 nginx，就需要通过 kube-proxy 来对 pod 产生访问的代理</p>\n</li>\n</ol>\n<p>这样，外界用户就可以访问集群中的 nginx 服务了</p>\n<h4 id=\"14-kubernetes概念\"><a class=\"anchor\" href=\"#14-kubernetes概念\">#</a> 1.4 kubernetes 概念</h4>\n<p><strong>Master</strong>：集群控制节点，每个集群需要至少一个 master 节点负责集群的管控</p>\n<p><strong>Node</strong>：工作负载节点，由 master 分配容器到这些 node 工作节点上，然后 node 节点上的 docker 负责容器的运行</p>\n<p><strong>Pod</strong>：kubernetes 的最小控制单元，容器都是运行在 pod 中的，一个 pod 中可以有 1 个或者多个容器</p>\n<p><strong>Controller</strong>：控制器，通过它来实现对 pod 的管理，比如启动 pod、停止 pod、伸缩 pod 的数量等等</p>\n<p><strong>Service</strong>：pod 对外服务的统一入口，下面可以维护者同一类的多个 pod</p>\n<p><strong>Label</strong>：标签，用于对 pod 进行分类，同一类 pod 会拥有相同的标签</p>\n<p><strong>NameSpace</strong>：命名空间，用来隔离 pod 的运行环境</p>\n<h3 id=\"2-kubernetes集群环境搭建\"><a class=\"anchor\" href=\"#2-kubernetes集群环境搭建\">#</a> 2. kubernetes 集群环境搭建</h3>\n<h4 id=\"21-前置知识点\"><a class=\"anchor\" href=\"#21-前置知识点\">#</a> 2.1 前置知识点</h4>\n<p>目前生产部署 Kubernetes 集群主要有两种方式：</p>\n<p><strong>kubeadm</strong></p>\n<p>Kubeadm 是一个 K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部署 Kubernetes 集群。</p>\n<p>官方地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvcmVmZXJlbmNlL3NldHVwLXRvb2xzL2t1YmVhZG0va3ViZWFkbS8=\">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</span></p>\n<p><strong>二进制包</strong></p>\n<p>从 github 下载发行版的二进制包，手动部署每个组件，组成 Kubernetes 集群。</p>\n<p>Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署 Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200404094800622.png\" alt=\"image-20200404094800622\" /></p>\n<h4 id=\"22-kubeadm-部署方式介绍\"><a class=\"anchor\" href=\"#22-kubeadm-部署方式介绍\">#</a> 2.2 kubeadm 部署方式介绍</h4>\n<p>kubeadm 是官方社区推出的一个用于快速部署 kubernetes 集群的工具，这个工具能通过两条指令完成一个 kubernetes 集群的部署：</p>\n<ul>\n<li>创建一个 Master 节点 kubeadm init</li>\n<li>将 Node 节点加入到当前集群中 $ kubeadm join &lt;Master 节点的 IP 和端口&gt;</li>\n</ul>\n<h4 id=\"23-安装要求\"><a class=\"anchor\" href=\"#23-安装要求\">#</a> 2.3 安装要求</h4>\n<p>在开始之前，部署 Kubernetes 集群机器需要满足以下几个条件：</p>\n<ul>\n<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>\n<li>硬件配置：2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多</li>\n<li>集群中所有机器之间网络互通</li>\n<li>可以访问外网，需要拉取镜像</li>\n<li>禁止 swap 分区</li>\n</ul>\n<h4 id=\"24-最终目标\"><a class=\"anchor\" href=\"#24-最终目标\">#</a> 2.4 最终目标</h4>\n<ul>\n<li>在所有节点上安装 Docker 和 kubeadm</li>\n<li>部署 Kubernetes Master</li>\n<li>部署容器网络插件</li>\n<li>部署 Kubernetes Node，将节点加入 Kubernetes 集群中</li>\n<li>部署 Dashboard Web 页面，可视化查看 Kubernetes 资源</li>\n</ul>\n<h4 id=\"25-准备环境\"><a class=\"anchor\" href=\"#25-准备环境\">#</a> 2.5 准备环境</h4>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20210609000002940.png\" alt=\"image-20210609000002940\" /></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">角色</th>\n<th style=\"text-align:left\">IP 地址</th>\n<th style=\"text-align:left\">组件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">master01</td>\n<td style=\"text-align:left\">192.168.90.100</td>\n<td style=\"text-align:left\">docker，kubectl，kubeadm，kubelet</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">node01</td>\n<td style=\"text-align:left\">192.168.90.101</td>\n<td style=\"text-align:left\">docker，kubectl，kubeadm，kubelet</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">node02</td>\n<td style=\"text-align:left\">192.168.90.102</td>\n<td style=\"text-align:left\">docker，kubectl，kubeadm，kubelet</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"26-环境初始化\"><a class=\"anchor\" href=\"#26-环境初始化\">#</a> 2.6 环境初始化</h4>\n<h5 id=\"261-检查操作系统的版本\"><a class=\"anchor\" href=\"#261-检查操作系统的版本\">#</a> 2.6.1 检查操作系统的版本</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 此方式下安装 kubernetes 集群要求 Centos 版本要在 7.5 或之上</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># cat /etc/redhat-release</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Centos Linux 7<span class=\"token punctuation\">.</span>5<span class=\"token punctuation\">.</span>1804 <span class=\"token punctuation\">(</span>Core<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h5 id=\"262-主机名解析\"><a class=\"anchor\" href=\"#262-主机名解析\">#</a> 2.6.2 主机名解析</h5>\n<p>为了方便集群节点间的直接调用，在这个配置一下主机名解析，企业中推荐使用内部 DNS 服务器</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 主机名成解析 编辑三台服务器的 /etc/hosts 文件，添加下面内容</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>192<span class=\"token punctuation\">.</span>168<span class=\"token punctuation\">.</span>90<span class=\"token punctuation\">.</span>100 master</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>192<span class=\"token punctuation\">.</span>168<span class=\"token punctuation\">.</span>90<span class=\"token punctuation\">.</span>101 node1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>192<span class=\"token punctuation\">.</span>168<span class=\"token punctuation\">.</span>90<span class=\"token punctuation\">.</span>102 node2</pre></td></tr></table></figure><h5 id=\"263-时间同步\"><a class=\"anchor\" href=\"#263-时间同步\">#</a> 2.6.3 时间同步</h5>\n<p>kubernetes 要求集群中的节点时间必须精确一直，这里使用 chronyd 服务从网络同步时间</p>\n<p>企业中建议配置内部的会见同步服务器</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 启动 chronyd 服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl start chronyd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl enable chronyd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># date</span></pre></td></tr></table></figure><h5 id=\"264-禁用iptable和firewalld服务\"><a class=\"anchor\" href=\"#264-禁用iptable和firewalld服务\">#</a> 2.6.4  禁用 iptable 和 firewalld 服务</h5>\n<p>kubernetes 和 docker 在运行的中会产生大量的 iptables 规则，为了不让系统规则跟它们混淆，直接关闭系统的规则</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1 关闭 firewalld 服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 2 关闭 iptables 服务</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl stop iptables</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl disable iptables</span></pre></td></tr></table></figure><h5 id=\"265-禁用selinux\"><a class=\"anchor\" href=\"#265-禁用selinux\">#</a> 2.6.5 禁用 selinux</h5>\n<p>selinux 是 linux 系统下的一个安全服务，如果不关闭它，在安装集群中会产生各种各样的奇葩问题</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 编辑 /etc/selinux/config 文件，修改 SELINUX 的值为 disable</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 注意修改完毕之后需要重启 linux 服务</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>SELINUX=disabled</pre></td></tr></table></figure><h5 id=\"266-禁用swap分区\"><a class=\"anchor\" href=\"#266-禁用swap分区\">#</a> 2.6.6 禁用 swap 分区</h5>\n<p>swap 分区指的是虚拟内存分区，它的作用是物理内存使用完，之后将磁盘空间虚拟成内存来使用，启用 swap 设备会对系统的性能产生非常负面的影响，因此 kubernetes 要求每个节点都要禁用 swap 设备，但是如果因为某些原因确实不能关闭 swap 分区，就需要在集群安装过程中通过明确的参数进行配置说明</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 编辑分区配置文件 /etc/fstab，注释掉 swap 分区一行</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 注意修改完毕之后需要重启 linux 服务</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>vim <span class=\"token operator\">/</span>etc/fstab</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>注释掉 <span class=\"token operator\">/</span>dev/mapper/centos-swap swap</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># /dev/mapper/centos-swap swap</span></pre></td></tr></table></figure><h5 id=\"267-修改linux的内核参数\"><a class=\"anchor\" href=\"#267-修改linux的内核参数\">#</a> 2.6.7 修改 linux 的内核参数</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改 linux 的内核采纳数，添加网桥过滤和地址转发功能</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 编辑 /etc/sysctl.d/kubernetes.conf 文件，添加如下配置：</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net<span class=\"token punctuation\">.</span>bridge<span class=\"token punctuation\">.</span>bridge-nf-call-ip6tables = 1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net<span class=\"token punctuation\">.</span>bridge<span class=\"token punctuation\">.</span>bridge-nf-call-iptables = 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>net<span class=\"token punctuation\">.</span>ipv4<span class=\"token punctuation\">.</span>ip_forward = 1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 重新加载配置</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># sysctl -p</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 加载网桥过滤模块</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># modprobe br_netfilter</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 查看网桥过滤模块是否加载成功</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># lsmod | grep br_netfilter</span></pre></td></tr></table></figure><h5 id=\"268-配置ipvs功能\"><a class=\"anchor\" href=\"#268-配置ipvs功能\">#</a> 2.6.8 配置 ipvs 功能</h5>\n<p>在 Kubernetes 中 Service 有两种带来模型，一种是基于 iptables 的，一种是基于 ipvs 的两者比较的话，ipvs 的性能明显要高一些，但是如果要使用它，需要手动载入 ipvs 模块</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1. 安装 ipset 和 ipvsadm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># yum install ipset ipvsadm -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 2. 添加需要加载的模块写入脚本文件</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># cat &lt;&lt;EOF> /etc/sysconfig/modules/ipvs.modules</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>modprobe <span class=\"token operator\">--</span> ip_vs</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>modprobe <span class=\"token operator\">--</span> ip_vs_rr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>modprobe <span class=\"token operator\">--</span> ip_vs_wrr</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>modprobe <span class=\"token operator\">--</span> ip_vs_sh</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>modprobe <span class=\"token operator\">--</span> nf_conntrack_ipv4</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>EOF</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 3. 为脚本添加执行权限</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># chmod +x /etc/sysconfig/modules/ipvs.modules</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 4. 执行脚本文件</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># /bin/bash /etc/sysconfig/modules/ipvs.modules</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 5. 查看对应的模块是否加载成功</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span></pre></td></tr></table></figure><h5 id=\"269-安装docker\"><a class=\"anchor\" href=\"#269-安装docker\">#</a> 2.6.9 安装 docker</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1、切换镜像源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 2、查看当前镜像源中支持的 docker 版本</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># yum list docker-ce --showduplicates</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 3、安装特定版本的 docker-ce</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 必须制定 --setopt=obsoletes=0，否则 yum 会自动安装更高版本</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># yum install --setopt=obsoletes=0 docker-ce-18.06.3.ce-3.el7 -y</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 4、添加一个配置文件</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#Docker 在默认情况下使用 Vgroup Driver 为 cgroupfs，而 Kubernetes 推荐使用 systemd 来替代 cgroupfs</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># mkdir /etc/docker</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># cat &lt;&lt;EOF> /etc/docker/daemon.json</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token string\">\"exec-opts\"</span>: <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token string\">\"registry-mirrors\"</span>: <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://kn0t2bca.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>EOF</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 5、启动 dokcer</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl restart docker</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl enable docker</span></pre></td></tr></table></figure><h5 id=\"2610-安装kubernetes组件\"><a class=\"anchor\" href=\"#2610-安装kubernetes组件\">#</a> 2.6.10 安装 Kubernetes 组件</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1、由于 kubernetes 的镜像在国外，速度比较慢，这里切换成国内的镜像源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 2、编辑 /etc/yum.repos.d/kubernetes.repo, 添加下面的配置</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token namespace\">[kubernetes]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>name=Kubernetes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>baseurl=http:<span class=\"token operator\">/</span><span class=\"token operator\">/</span>mirrors<span class=\"token punctuation\">.</span>aliyun<span class=\"token punctuation\">.</span>com/kubernetes/yum/repos/kubernetes-el7-x86_64</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>enabled=1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>gpgchech=0</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>repo_gpgcheck=0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>gpgkey=http:<span class=\"token operator\">/</span><span class=\"token operator\">/</span>mirrors<span class=\"token punctuation\">.</span>aliyun<span class=\"token punctuation\">.</span>com/kubernetes/yum/doc/yum-key<span class=\"token punctuation\">.</span>gpg</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\thttp:<span class=\"token operator\">/</span><span class=\"token operator\">/</span>mirrors<span class=\"token punctuation\">.</span>aliyun<span class=\"token punctuation\">.</span>com/kubernetes/yum/doc/rpm-package-key<span class=\"token punctuation\">.</span>gpg</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 3、安装 kubeadm、kubelet 和 kubectl</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># yum install --setopt=obsoletes=0 kubeadm-1.17.4-0 kubelet-1.17.4-0 kubectl-1.17.4-0 -y</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 4、配置 kubelet 的 cgroup</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#编辑 /etc/sysconfig/kubelet, 添加下面的配置</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>KUBELET_CGROUP_ARGS=<span class=\"token string\">\"--cgroup-driver=systemd\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>KUBE_PROXY_MODE=<span class=\"token string\">\"ipvs\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 5、设置 kubelet 开机自启</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># systemctl enable kubelet</span></pre></td></tr></table></figure><h5 id=\"2611-准备集群镜像\"><a class=\"anchor\" href=\"#2611-准备集群镜像\">#</a> 2.6.11 准备集群镜像</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在安装 kubernetes 集群之前，必须要提前准备好集群需要的镜像，所需镜像可以通过下面命令查看</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># kubeadm config images list</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 下载镜像</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 此镜像 kubernetes 的仓库中，由于网络原因，无法连接，下面提供了一种替换方案</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>images=<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tkube-apiserver:v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tkube-controller-manager:v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tkube-scheduler:v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tkube-proxy:v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tpause:3<span class=\"token punctuation\">.</span>1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tetcd:3<span class=\"token punctuation\">.</span>4<span class=\"token punctuation\">.</span>3-0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tcoredns:1<span class=\"token punctuation\">.</span>6<span class=\"token punctuation\">.</span>5</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">for</span> imageName in $<span class=\"token punctuation\">&#123;</span>images<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tdocker pull registry<span class=\"token punctuation\">.</span>cn-hangzhou<span class=\"token punctuation\">.</span>aliyuncs<span class=\"token punctuation\">.</span>com/google_containers/<span class=\"token variable\">$imageName</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tdocker tag registry<span class=\"token punctuation\">.</span>cn-hangzhou<span class=\"token punctuation\">.</span>aliyuncs<span class=\"token punctuation\">.</span>com/google_containers/<span class=\"token variable\">$imageName</span> k8s<span class=\"token punctuation\">.</span>gcr<span class=\"token punctuation\">.</span>io/<span class=\"token variable\">$imageName</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tdocker rmi registry<span class=\"token punctuation\">.</span>cn-hangzhou<span class=\"token punctuation\">.</span>aliyuncs<span class=\"token punctuation\">.</span>com/google_containers/<span class=\"token variable\">$imageName</span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>done</pre></td></tr></table></figure><h5 id=\"2611-集群初始化\"><a class=\"anchor\" href=\"#2611-集群初始化\">#</a> 2.6.11 集群初始化</h5>\n<blockquote>\n<p>下面的操作只需要在 master 节点上执行即可</p>\n</blockquote>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建集群</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># kubeadm init \\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token operator\">--</span>apiserver-advertise-address=192<span class=\"token punctuation\">.</span>168<span class=\"token punctuation\">.</span>90<span class=\"token punctuation\">.</span>100 \\</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token operator\">--</span>image-repository registry<span class=\"token punctuation\">.</span>aliyuncs<span class=\"token punctuation\">.</span>com/google_containers \\</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token operator\">--</span>kubernetes-version=v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4 \\</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token operator\">--</span>service-cidr=10<span class=\"token punctuation\">.</span>96<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>0/12 \\</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token operator\">--</span>pod-network-cidr=10<span class=\"token punctuation\">.</span>244<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>0/16</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 创建必要文件</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># mkdir -p $HOME/.kube</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></pre></td></tr></table></figure><blockquote>\n<p>下面的操作只需要在 node 节点上执行即可</p>\n</blockquote>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm join 192<span class=\"token punctuation\">.</span>168<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>100:6443 <span class=\"token operator\">--</span>token awk15p<span class=\"token punctuation\">.</span>t6bamck54w69u4s8 \\</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token operator\">--</span>discovery-token-ca-cert-hash sha256:a94fa09562466d32d29523ab6cff122186f1127599fa4dcd5fa0152694f17117</pre></td></tr></table></figure><p>在 master 上查看节点信息</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME    STATUS   ROLES     AGE   VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>master  NotReady  master   6m    v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>node1   NotReady   &lt;none>  22s   v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>node2   NotReady   &lt;none>  19s   v1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>4</pre></td></tr></table></figure><h5 id=\"2613-安装网络插件只在master节点操作即可\"><a class=\"anchor\" href=\"#2613-安装网络插件只在master节点操作即可\">#</a> 2.6.13 安装网络插件，只在 master 节点操作即可</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>wget https:<span class=\"token operator\">/</span><span class=\"token operator\">/</span>raw<span class=\"token punctuation\">.</span>githubusercontent<span class=\"token punctuation\">.</span>com/coreos/flannel/master/Documentation/kube-flannel<span class=\"token punctuation\">.</span>yml</pre></td></tr></table></figure><p>由于外网不好访问，如果出现无法访问的情况，可以直接用下面的 记得文件名是 kube-flannel.yml，位置：/root/kube-flannel.yml 内容：</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>https:<span class=\"token operator\">/</span><span class=\"token operator\">/</span>github<span class=\"token punctuation\">.</span>com/flannel-io/flannel/tree/master/Documentation/kube-flannel<span class=\"token punctuation\">.</span>yml</pre></td></tr></table></figure><p>也可手动拉取指定版本<br />\n docker pull <span class=\"exturl\" data-url=\"aHR0cDovL3F1YXkuaW8vY29yZW9zL2ZsYW5uZWw6djAuMTQuMA==\">quay.io/coreos/flannel:v0.14.0</span>              #拉取 flannel 网络，三台主机<br />\n docker images                  #查看仓库是否拉去下来</p>\n<p><code>个人笔记</code> <br />\n若是集群状态一直是 notready, 用下面语句查看原因，<br />\njournalctl -f -u kubelet.service<br />\n 若原因是： cni.go:237] Unable to update cni config: no networks found in /etc/cni/net.d<br />\nmkdir -p /etc/cni/net.d                    #创建目录给 flannel 做配置文件<br />\n vim /etc/cni/net.d/10-flannel.conf         #编写配置文件</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token string\">\"name\"</span>:<span class=\"token string\">\"cbr0\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token string\">\"cniVersion\"</span>:<span class=\"token string\">\"0.3.1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token string\">\"type\"</span>:<span class=\"token string\">\"flannel\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token string\">\"deledate\"</span>:<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"hairpinMode\"</span>:true<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"isDefaultGateway\"</span>:true</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"2614-使用kubeadm-reset重置集群\"><a class=\"anchor\" href=\"#2614-使用kubeadm-reset重置集群\">#</a> 2.6.14 使用 kubeadm reset 重置集群</h5>\n<pre><code>#在master节点之外的节点进行操作\nkubeadm reset\nsystemctl stop kubelet\nsystemctl stop docker\nrm -rf /var/lib/cni/\nrm -rf /var/lib/kubelet/*\nrm -rf /etc/cni/\nifconfig cni0 down\nifconfig flannel.1 down\nifconfig docker0 down\nip link delete cni0\nip link delete flannel.1\n##重启kubelet\nsystemctl restart kubelet\n##重启docker\nsystemctl restart docker\n</code></pre>\n<h5 id=\"2615-重启kubelet和docker\"><a class=\"anchor\" href=\"#2615-重启kubelet和docker\">#</a> 2.6.15 重启 kubelet 和 docker</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 重启 kubelet</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl restart kubelet</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 重启 docker</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>systemctl restart docker</pre></td></tr></table></figure><p>使用配置文件启动 fannel</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl apply <span class=\"token operator\">-</span>f kube-flannel<span class=\"token punctuation\">.</span>yml</pre></td></tr></table></figure><p>等待它安装完毕 发现已经是 集群的状态已经是 Ready</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/2232696-20210621233106024-1676033717.png\" alt=\"img\" /></p>\n<h5 id=\"2616-kubeadm中的命令\"><a class=\"anchor\" href=\"#2616-kubeadm中的命令\">#</a> 2.6.16 kubeadm 中的命令</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 生成 新的 token</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># kubeadm token create --print-join-command</span></pre></td></tr></table></figure><h4 id=\"27-集群测试\"><a class=\"anchor\" href=\"#27-集群测试\">#</a> 2.7 集群测试</h4>\n<h5 id=\"271-创建一个nginx服务\"><a class=\"anchor\" href=\"#271-创建一个nginx服务\">#</a> 2.7.1 创建一个 nginx 服务</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create deployment nginx  <span class=\"token operator\">--</span>image=nginx:1<span class=\"token punctuation\">.</span>14-alpine</pre></td></tr></table></figure><h5 id=\"272-暴露端口\"><a class=\"anchor\" href=\"#272-暴露端口\">#</a> 2.7.2 暴露端口</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl expose deploy nginx  <span class=\"token operator\">--</span>port=80 <span class=\"token operator\">--</span>target-port=80  <span class=\"token operator\">--</span><span class=\"token function\">type</span>=NodePort</pre></td></tr></table></figure><h5 id=\"273-查看服务\"><a class=\"anchor\" href=\"#273-查看服务\">#</a> 2.7.3 查看服务</h5>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl get pod<span class=\"token punctuation\">,</span>svc</pre></td></tr></table></figure><h5 id=\"274-查看pod\"><a class=\"anchor\" href=\"#274-查看pod\">#</a> 2.7.4 查看 pod</h5>\n<p><img data-src=\"http://oss.itshare.work/blog-images/2232696-20210621233130477-111035427.png\" alt=\"img\" /></p>\n<p>浏览器测试结果：</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/2232696-20210621233157075-1117518703.png\" alt=\"img\" /></p>\n<h3 id=\"3-资源管理\"><a class=\"anchor\" href=\"#3-资源管理\">#</a> 3. 资源管理</h3>\n<h4 id=\"31-资源管理介绍\"><a class=\"anchor\" href=\"#31-资源管理介绍\">#</a> 3.1 资源管理介绍</h4>\n<p>在 kubernetes 中，所有的内容都抽象为资源，用户需要通过操作资源来管理 kubernetes。</p>\n<blockquote>\n<p>kubernetes 的本质上就是一个集群系统，用户可以在集群中部署各种服务，所谓的部署服务，其实就是在 kubernetes 集群中运行一个个的容器，并将指定的程序跑在容器中。</p>\n<p>kubernetes 的最小管理单元是 pod 而不是容器，所以只能将容器放在 <code>Pod</code>  中，而 kubernetes 一般也不会直接管理 Pod，而是通过 <code>Pod控制器</code> 来管理 Pod 的。</p>\n<p>Pod 可以提供服务之后，就要考虑如何访问 Pod 中服务，kubernetes 提供了 <code>Service</code>  资源实现这个功能。</p>\n<p>当然，如果 Pod 中程序的数据需要持久化，kubernetes 还提供了各种 <code>存储</code> 系统。</p>\n</blockquote>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200406225334627.png\" alt=\"image-20200406225334627\" /></p>\n<blockquote>\n<p>学习 kubernetes 的核心，就是学习如何对集群上的 <code>Pod、Pod控制器、Service、存储</code> 等各种资源进行操作</p>\n</blockquote>\n<h4 id=\"32-yaml语言介绍\"><a class=\"anchor\" href=\"#32-yaml语言介绍\">#</a> 3.2 YAML 语言介绍</h4>\n<p>YAML 是一个类似 XML、JSON 的标记性语言。它强调以<strong>数据</strong>为中心，并不是以标识语言为重点。因而 YAML 本身的定义比较简单，号称 &quot;一种人性化的数据格式语言&quot;。</p>\n<pre><code>&lt;heima&gt;\n    &lt;age&gt;15&lt;/age&gt;\n    &lt;address&gt;Beijing&lt;/address&gt;\n&lt;/heima&gt;\n</code></pre>\n<pre><code>heima:\n  age: 15\n  address: Beijing\n</code></pre>\n<p>YAML 的语法比较简单，主要有下面几个：</p>\n<ul>\n<li>大小写敏感</li>\n<li>使用缩进表示层级关系</li>\n<li>缩进不允许使用 tab，只允许空格 (低版本限制)</li>\n<li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li>\n<li>'#' 表示注释</li>\n</ul>\n<p>YAML 支持以下几种数据类型：</p>\n<ul>\n<li>纯量：单个的、不可再分的值</li>\n<li>对象：键值对的集合，又称为映射（mapping）/ 哈希（hash） / 字典（dictionary）</li>\n<li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li>\n</ul>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 纯量，就是指的一个简单的值，字符串、布尔值、整数、浮点数、Null、时间、日期</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 1 布尔类型</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">c1</span><span class=\"token punctuation\">:</span> true (或者True)</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 2 整型</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">c2</span><span class=\"token punctuation\">:</span> <span class=\"token number\">234</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 3 浮点型</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">c3</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3.14</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 4 null 类型 </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">c4</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">~</span>  <span class=\"token comment\"># 使用～表示 null</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 5 日期类型</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key atrule\">c5</span><span class=\"token punctuation\">:</span> <span class=\"token datetime number\">2018-02-17</span>    <span class=\"token comment\"># 日期必须使用 ISO 8601 格式，即 yyyy-MM-dd</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 6 时间类型</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key atrule\">c6</span><span class=\"token punctuation\">:</span> <span class=\"token datetime number\">2018-02-17T15:02:31+08:00</span>  <span class=\"token comment\"># 时间使用 ISO 8601 格式，时间和日期之间使用 T 连接，最后使用 + 代表时区</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 7 字符串类型</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key atrule\">c7</span><span class=\"token punctuation\">:</span> heima     <span class=\"token comment\"># 简单写法，直接写值，如果字符串中间有特殊字符，必须使用双引号或者单引号包裹 </span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key atrule\">c8</span><span class=\"token punctuation\">:</span> line1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    line2     <span class=\"token comment\"># 字符串过多的情况可以拆成多行，每一行会被转化成一个空格</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 对象</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 形式一 (推荐):</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">heima</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">age</span><span class=\"token punctuation\">:</span> <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> Beijing</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 形式二 (了解):</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">heima</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token key atrule\">age</span><span class=\"token punctuation\">:</span> <span class=\"token number\">15</span><span class=\"token punctuation\">,</span><span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> Beijing<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 数组</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 形式一 (推荐):</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">-</span> 顺义</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">-</span> 昌平  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 形式二 (了解):</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>顺义<span class=\"token punctuation\">,</span>昌平<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><blockquote>\n<p>小提示：</p>\n<p>1 书写 yaml 切记 <code>:</code>  后面要加一个空格</p>\n<p>2 如果需要将多段 yaml 配置放在一个文件中，中间要使用 <code>---</code>  分隔</p>\n<p>3 下面是一个 yaml 转 json 的网站，可以通过它验证 yaml 是否书写正确</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuanNvbjJ5YW1sLmNvbS9jb252ZXJ0LXlhbWwtdG8tanNvbg==\">https://www.json2yaml.com/convert-yaml-to-json</span></p>\n</blockquote>\n<h4 id=\"33-资源管理方式\"><a class=\"anchor\" href=\"#33-资源管理方式\">#</a> 3.3 资源管理方式</h4>\n<ul>\n<li>\n<p>命令式对象管理：直接使用命令去操作 kubernetes 资源</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"><span>l</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl run nginx-pod <span class=\"token operator\">--</span>image=nginx:1<span class=\"token punctuation\">.</span>17<span class=\"token punctuation\">.</span>1 <span class=\"token operator\">--</span>port=80</pre></td></tr></table></figure></li>\n<li>\n<p>命令式对象配置：通过命令配置和配置文件去操作 kubernetes 资源</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create/patch <span class=\"token operator\">-</span>f nginx-pod<span class=\"token punctuation\">.</span>yaml</pre></td></tr></table></figure></li>\n<li>\n<p>声明式对象配置：通过 apply 命令和配置文件去操作 kubernetes 资源</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl apply <span class=\"token operator\">-</span>f nginx-pod<span class=\"token punctuation\">.</span>yaml</pre></td></tr></table></figure></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">类型</th>\n<th style=\"text-align:left\">操作对象</th>\n<th style=\"text-align:left\">适用环境</th>\n<th style=\"text-align:left\">优点</th>\n<th style=\"text-align:left\">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">命令式对象管理</td>\n<td style=\"text-align:left\">对象</td>\n<td style=\"text-align:left\">测试</td>\n<td style=\"text-align:left\">简单</td>\n<td style=\"text-align:left\">只能操作活动对象，无法审计、跟踪</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">命令式对象配置</td>\n<td style=\"text-align:left\">文件</td>\n<td style=\"text-align:left\">开发</td>\n<td style=\"text-align:left\">可以审计、跟踪</td>\n<td style=\"text-align:left\">项目大时，配置文件多，操作麻烦</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">声明式对象配置</td>\n<td style=\"text-align:left\">目录</td>\n<td style=\"text-align:left\">开发</td>\n<td style=\"text-align:left\">支持目录操作</td>\n<td style=\"text-align:left\">意外情况下难以调试</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"331-命令式对象管理\"><a class=\"anchor\" href=\"#331-命令式对象管理\">#</a> 3.3.1 命令式对象管理</h5>\n<p><strong>kubectl 命令</strong></p>\n<p>kubectl 是 kubernetes 集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。kubectl 命令的语法如下：</p>\n<pre><code>kubectl [command] [type] [name] [flags]\n</code></pre>\n<p><strong>comand</strong>：指定要对资源执行的操作，例如 create、get、delete</p>\n<p><strong>type</strong>：指定资源类型，比如 deployment、pod、service</p>\n<p><strong>name</strong>：指定资源的名称，名称大小写敏感</p>\n<p><strong>flags</strong>：指定额外的可选参数</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看所有 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl get pod </pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 查看某个 pod</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kubectl get pod pod_name</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 查看某个 pod, 以 yaml 格式展示结果</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kubectl get pod pod_name <span class=\"token parameter variable\">-o</span> yaml</pre></td></tr></table></figure><p><strong>资源类型</strong></p>\n<p>kubernetes 中所有的内容都抽象为资源，可以通过下面的命令进行查看:</p>\n<pre><code>kubectl api-resources\n</code></pre>\n<p>经常使用的资源有下面这些：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">资源分类</th>\n<th style=\"text-align:left\">资源名称</th>\n<th style=\"text-align:left\">缩写</th>\n<th style=\"text-align:left\">资源作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">集群级别资源</td>\n<td style=\"text-align:left\">nodes</td>\n<td style=\"text-align:left\">no</td>\n<td style=\"text-align:left\">集群组成部分</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">namespaces</td>\n<td style=\"text-align:left\">ns</td>\n<td style=\"text-align:left\">隔离 Pod</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">pod 资源</td>\n<td style=\"text-align:left\">pods</td>\n<td style=\"text-align:left\">po</td>\n<td style=\"text-align:left\">装载容器</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">pod 资源控制器</td>\n<td style=\"text-align:left\">replicationcontrollers</td>\n<td style=\"text-align:left\">rc</td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">replicasets</td>\n<td style=\"text-align:left\">rs</td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">deployments</td>\n<td style=\"text-align:left\">deploy</td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">daemonsets</td>\n<td style=\"text-align:left\">ds</td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">jobs</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">cronjobs</td>\n<td style=\"text-align:left\">cj</td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">horizontalpodautoscalers</td>\n<td style=\"text-align:left\">hpa</td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">statefulsets</td>\n<td style=\"text-align:left\">sts</td>\n<td style=\"text-align:left\">控制 pod 资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">服务发现资源</td>\n<td style=\"text-align:left\">services</td>\n<td style=\"text-align:left\">svc</td>\n<td style=\"text-align:left\">统一 pod 对外接口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">ingress</td>\n<td style=\"text-align:left\">ing</td>\n<td style=\"text-align:left\">统一 pod 对外接口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">存储资源</td>\n<td style=\"text-align:left\">volumeattachments</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">存储</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">persistentvolumes</td>\n<td style=\"text-align:left\">pv</td>\n<td style=\"text-align:left\">存储</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">persistentvolumeclaims</td>\n<td style=\"text-align:left\">pvc</td>\n<td style=\"text-align:left\">存储</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">配置资源</td>\n<td style=\"text-align:left\">configmaps</td>\n<td style=\"text-align:left\">cm</td>\n<td style=\"text-align:left\">配置</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">secrets</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">配置</td>\n</tr>\n</tbody>\n</table>\n<p><strong>操作</strong></p>\n<p>kubernetes 允许对资源进行多种操作，可以通过 --help 查看详细的操作命令</p>\n<pre><code>kubectl --help\n</code></pre>\n<p>经常使用的操作有下面这些：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">命令分类</th>\n<th style=\"text-align:left\">命令</th>\n<th style=\"text-align:left\">翻译</th>\n<th style=\"text-align:left\">命令作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">基本命令</td>\n<td style=\"text-align:left\">create</td>\n<td style=\"text-align:left\">创建</td>\n<td style=\"text-align:left\">创建一个资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">edit</td>\n<td style=\"text-align:left\">编辑</td>\n<td style=\"text-align:left\">编辑一个资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">get</td>\n<td style=\"text-align:left\">获取</td>\n<td style=\"text-align:left\">获取一个资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">patch</td>\n<td style=\"text-align:left\">更新</td>\n<td style=\"text-align:left\">更新一个资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">delete</td>\n<td style=\"text-align:left\">删除</td>\n<td style=\"text-align:left\">删除一个资源</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">explain</td>\n<td style=\"text-align:left\">解释</td>\n<td style=\"text-align:left\">展示资源文档</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">运行和调试</td>\n<td style=\"text-align:left\">run</td>\n<td style=\"text-align:left\">运行</td>\n<td style=\"text-align:left\">在集群中运行一个指定的镜像</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">expose</td>\n<td style=\"text-align:left\">暴露</td>\n<td style=\"text-align:left\">暴露资源为 Service</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">describe</td>\n<td style=\"text-align:left\">描述</td>\n<td style=\"text-align:left\">显示资源内部信息</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">logs</td>\n<td style=\"text-align:left\">日志输出容器在 pod 中的日志</td>\n<td style=\"text-align:left\">输出容器在 pod 中的日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">attach</td>\n<td style=\"text-align:left\">缠绕进入运行中的容器</td>\n<td style=\"text-align:left\">进入运行中的容器</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">exec</td>\n<td style=\"text-align:left\">执行容器中的一个命令</td>\n<td style=\"text-align:left\">执行容器中的一个命令</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">cp</td>\n<td style=\"text-align:left\">复制</td>\n<td style=\"text-align:left\">在 Pod 内外复制文件</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">rollout</td>\n<td style=\"text-align:left\">首次展示</td>\n<td style=\"text-align:left\">管理资源的发布</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">scale</td>\n<td style=\"text-align:left\">规模</td>\n<td style=\"text-align:left\">扩 (缩) 容 Pod 的数量</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">autoscale</td>\n<td style=\"text-align:left\">自动调整</td>\n<td style=\"text-align:left\">自动调整 Pod 的数量</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">高级命令</td>\n<td style=\"text-align:left\">apply</td>\n<td style=\"text-align:left\">rc</td>\n<td style=\"text-align:left\">通过文件对资源进行配置</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">label</td>\n<td style=\"text-align:left\">标签</td>\n<td style=\"text-align:left\">更新资源上的标签</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">其他命令</td>\n<td style=\"text-align:left\">cluster-info</td>\n<td style=\"text-align:left\">集群信息</td>\n<td style=\"text-align:left\">显示集群信息</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">version</td>\n<td style=\"text-align:left\">版本</td>\n<td style=\"text-align:left\">显示当前 Server 和 Client 的版本</td>\n</tr>\n</tbody>\n</table>\n<p>下面以一个 namespace /pod 的创建和删除简单演示下命令的使用：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建一个 namespace</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create namespace dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>namespace/dev created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 获取 namespace</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get ns</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME              STATUS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>default           Active   21h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>dev               Active   21s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kube-node-lease   Active   21h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kube-public       Active   21h</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kube-system       Active   21h</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 在此 namespace 下创建并运行一个 nginx 的 Pod</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl run pod --image=nginx:latest -n dev</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kubectl run <span class=\"token parameter variable\">--generator</span><span class=\"token operator\">=</span>deployment/apps.v1 is DEPRECATED and will be removed <span class=\"token keyword\">in</span> a future version. Use kubectl run <span class=\"token parameter variable\">--generator</span><span class=\"token operator\">=</span>run-pod/v1 or kubectl create instead.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>deployment.apps/pod created</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 查看新创建的 pod</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n dev</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>NAME  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pod   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21s</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># 删除指定的 pod</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete pod pod-864f9875b9-pcw7x</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pod <span class=\"token string\">\"pod\"</span> deleted</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 删除指定的 namespace</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete ns dev</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>namespace <span class=\"token string\">\"dev\"</span> deleted</pre></td></tr></table></figure><h5 id=\"332-命令式对象配置\"><a class=\"anchor\" href=\"#332-命令式对象配置\">#</a> 3.3.2 命令式对象配置</h5>\n<p>命令式对象配置就是使用命令配合配置文件一起来操作 kubernetes 资源。</p>\n<p>1） 创建一个 nginxpod.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Namespace</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginxpod</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>containers</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>latest</pre></td></tr></table></figure><p>2）执行 create 命令，创建资源：</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token namespace\">[root@master ~]</span><span class=\"token comment\"># kubectl create -f nginxpod.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>namespace/dev created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/nginxpod created</pre></td></tr></table></figure><p>此时发现创建了两个资源对象，分别是 namespace 和 pod</p>\n<p>3）执行 get 命令，查看资源：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl get -f nginxpod.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME            STATUS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>namespace/dev   Active   18s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>pod/nginxpod    <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17s</pre></td></tr></table></figure><p>这样就显示了两个资源对象的信息</p>\n<p>4）执行 delete 命令，删除资源：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f nginxpod.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>namespace <span class=\"token string\">\"dev\"</span> deleted</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod <span class=\"token string\">\"nginxpod\"</span> deleted</pre></td></tr></table></figure><p>此时发现两个资源对象被删除了</p>\n<pre><code>总结:\n    命令式对象配置的方式操作资源，可以简单的认为：命令  +  yaml配置文件（里面是命令需要的各种参数）\n</code></pre>\n<h5 id=\"333-声明式对象配置\"><a class=\"anchor\" href=\"#333-声明式对象配置\">#</a> 3.3.3 声明式对象配置</h5>\n<p>声明式对象配置跟命令式对象配置很相似，但是它只有一个命令 apply。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 首先执行一次 kubectl apply -f yaml 文件，发现创建了资源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl apply -f nginxpod.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>namespace/dev created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pod/nginxpod created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 再次执行一次 kubectl apply -f yaml 文件，发现说资源没有变动</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl apply -f nginxpod.yaml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>namespace/dev unchanged</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pod/nginxpod unchanged</pre></td></tr></table></figure><figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>总结:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    其实声明式对象配置就是使用apply描述一个资源最终的状态（在yaml中定义状态）</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    使用apply操作资源：</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        如果资源不存在，就创建，相当于 kubectl create</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        如果资源已存在，就更新，相当于 kubectl patch</pre></td></tr></table></figure><blockquote>\n<p>扩展：kubectl 可以在 node 节点上运行吗？</p>\n</blockquote>\n<p>kubectl 的运行是需要进行配置的，它的配置文件是 $HOME/.kube，如果想要在 node 节点运行此命令，需要将 master 上的.kube 文件复制到 node 节点上，即在 master 节点上执行下面操作：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">scp</span>  <span class=\"token parameter variable\">-r</span>  <span class=\"token environment constant\">HOME</span>/.kube   node1: <span class=\"token environment constant\">HOME</span>/</pre></td></tr></table></figure><blockquote>\n<p>使用推荐：三种方式应该怎么用？</p>\n</blockquote>\n<p>创建 / 更新资源 使用声明式对象配置 kubectl apply -f XXX.yaml</p>\n<p>删除资源 使用命令式对象配置 kubectl delete -f XXX.yaml</p>\n<p>查询资源 使用命令式对象管理 kubectl get (describe) 资源名称</p>\n<h3 id=\"4-实战入门\"><a class=\"anchor\" href=\"#4-实战入门\">#</a> 4. 实战入门</h3>\n<p>本章节将介绍如何在 kubernetes 集群中部署一个 nginx 服务，并且能够对其进行访问。</p>\n<h4 id=\"41-namespace\"><a class=\"anchor\" href=\"#41-namespace\">#</a> 4.1 Namespace</h4>\n<p>Namespace 是 kubernetes 系统中的一种非常重要资源，它的主要作用是用来实现<strong>多套环境的资源隔离</strong>或者<strong>多租户的资源隔离</strong>。</p>\n<p>默认情况下，kubernetes 集群中的所有的 Pod 都是可以相互访问的。但是在实际中，可能不想让两个 Pod 之间进行互相的访问，那此时就可以将两个 Pod 划分到不同的 namespace 下。kubernetes 通过将集群内部的资源分配到不同的 Namespace 中，可以形成逻辑上的 &quot;组&quot;，以方便不同的组的资源进行隔离使用和管理。</p>\n<p>可以通过 kubernetes 的授权机制，将不同的 namespace 交给不同租户进行管理，这样就实现了多租户的资源隔离。此时还能结合 kubernetes 的资源配额机制，限定不同租户能占用的资源，例如 CPU 使用量、内存使用量等等，来实现租户可用资源的管理。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200407100850484.png\" alt=\"image-20200407100850484\" /></p>\n<p>kubernetes 在集群启动之后，会默认创建几个 namespace</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  get namespace</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME              STATUS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>default           Active   45h     <span class=\"token comment\">#  所有未指定 Namespace 的对象都会被分配在 default 命名空间</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kube-node-lease   Active   45h     <span class=\"token comment\">#  集群节点之间的心跳维护，v1.13 开始引入</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kube-public       Active   45h     <span class=\"token comment\">#  此命名空间下的资源可以被所有人访问（包括未认证用户）</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kube-system       Active   45h     <span class=\"token comment\">#  所有由 Kubernetes 系统创建的资源都处于这个命名空间</span></pre></td></tr></table></figure><p>下面来看 namespace 资源的具体操作：</p>\n<h5 id=\"411-查看\"><a class=\"anchor\" href=\"#411-查看\">#</a> 4.1.1 <strong>查看</strong></h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1 查看所有的 ns  命令：kubectl get ns</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get ns</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME              STATUS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>default           Active   45h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kube-node-lease   Active   45h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kube-public       Active   45h     </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kube-system       Active   45h     </pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 2 查看指定的 ns   命令：kubectl get ns ns 名称</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get ns default</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>NAME      STATUS   AGE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>default   Active   45h</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 3 指定输出格式  命令：kubectl get ns ns 名称  -o 格式参数</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># kubernetes 支持的格式有很多，比较常见的是 wide、json、yaml</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get ns default -o yaml</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: Namespace</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  creationTimestamp: <span class=\"token string\">\"2021-05-08T04:44:16Z\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: default</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  resourceVersion: <span class=\"token string\">\"151\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  selfLink: /api/v1/namespaces/default</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  uid: 7405f73a-e486-43d4-9db6-145f1409f090</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  finalizers:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  - kubernetes</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>status:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  phase: Active</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># 4 查看 ns 详情  命令：kubectl describe ns ns 名称</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe ns default</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Name:         default</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>Labels:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Annotations:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>Status:       Active  <span class=\"token comment\"># Active 命名空间正在使用中  Terminating 正在删除命名空间</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\"># ResourceQuota 针对 namespace 做的资源限制</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\"># LimitRange 针对 namespace 中的每个组件做的资源限制</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>No resource quota.</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>No LimitRange resource.</pre></td></tr></table></figure><h5 id=\"412-创建\"><a class=\"anchor\" href=\"#412-创建\">#</a> 4.1.2 <strong>创建</strong></h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 namespace</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>namespace/dev created</pre></td></tr></table></figure><h5 id=\"413-删除\"><a class=\"anchor\" href=\"#413-删除\">#</a> 4.1.3 <strong>删除</strong></h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 删除 namespace</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete ns dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>namespace <span class=\"token string\">\"dev\"</span> deleted</pre></td></tr></table></figure><h5 id=\"414-配置方式\"><a class=\"anchor\" href=\"#414-配置方式\">#</a> 4.1.4 <strong>配置方式</strong></h5>\n<p>首先准备一个 yaml 文件：ns-dev.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Namespace</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dev</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p>\n<p>创建：kubectl create -f ns-dev.yaml</p>\n<p>删除：kubectl delete -f ns-dev.yaml</p>\n<h4 id=\"42-pod\"><a class=\"anchor\" href=\"#42-pod\">#</a> 4.2 Pod</h4>\n<p>Pod 是 kubernetes 集群进行管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于 Pod 中。</p>\n<p>Pod 可以认为是容器的封装，一个 Pod 中可以存在一个或者多个容器。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200407121501907.png\" alt=\"image-20200407121501907\" /></p>\n<p>kubernetes 在集群启动之后，集群中的各个组件也都是以 Pod 方式运行的。可以通过下面命令查看：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kube-system   coredns-6955765f44-68g6v         <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kube-system   coredns-6955765f44-cs5r8         <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kube-system   etcd-master                      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kube-system   kube-apiserver-master            <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kube-system   kube-controller-manager-master   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kube-system   kube-flannel-ds-amd64-47r25      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kube-system   kube-flannel-ds-amd64-ls5lh      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kube-system   kube-proxy-685tk                 <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kube-system   kube-proxy-87spt                 <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kube-system   kube-scheduler-master            <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2d1h</pre></td></tr></table></figure><h5 id=\"421-创建并运行\"><a class=\"anchor\" href=\"#421-创建并运行\">#</a> 4.2.1 创建并运行</h5>\n<p>kubernetes 没有提供单独运行 Pod 的命令，都是通过 Pod 控制器来实现的</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 命令格式： kubectl run (pod 控制器名称) [参数] </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># --image  指定 Pod 的镜像</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># --port   指定端口</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># --namespace  指定 namespace</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl run nginx --image=nginx:latest --port=80 --namespace dev </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>deployment.apps/nginx created</pre></td></tr></table></figure><h5 id=\"422-查看pod信息\"><a class=\"anchor\" href=\"#422-查看pod信息\">#</a> 4.2.2 查看 pod 信息</h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看 Pod 基本信息</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          43s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 查看 Pod 的详细信息</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pod nginx -n dev</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Name:         nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Priority:     <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Node:         node1/192.168.5.4</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Start Time:   Wed, 08 May <span class=\"token number\">2021</span> 09:29:24 +0800</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Labels:       pod-template-hash<span class=\"token operator\">=</span>5ff7956ff6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              <span class=\"token assign-left variable\">run</span><span class=\"token operator\">=</span>nginx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Annotations:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Status:       Running</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>IP:           <span class=\"token number\">10.244</span>.1.23</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>IPs:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  IP:           <span class=\"token number\">10.244</span>.1.23</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Controlled By:  ReplicaSet/nginx</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  nginx:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    Container ID:   docker://4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Image:          nginx:latest</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    Image ID:       docker-pullable://nginx@sha256:485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    Port:           <span class=\"token number\">80</span>/TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    Host Port:      <span class=\"token number\">0</span>/TCP</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    State:          Running</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      Started:      Wed, 08 May <span class=\"token number\">2021</span> 09:30:01 +0800</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    Ready:          True</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    Restart Count:  <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    Environment:    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    Mounts:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hwvvw <span class=\"token punctuation\">(</span>ro<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Conditions:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  Type              Status</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  Initialized       True</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  Ready             True</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  ContainersReady   True</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  PodScheduled      True</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Volumes:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  default-token-hwvvw:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    Type:        Secret <span class=\"token punctuation\">(</span>a volume populated by a Secret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    SecretName:  default-token-hwvvw</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    Optional:    <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>QoS Class:       BestEffort</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Node-Selectors:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class=\"token keyword\">for</span> 300s</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                 node.kubernetes.io/unreachable:NoExecute <span class=\"token keyword\">for</span> 300s</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>Events:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  Type    Reason     Age        From               Message</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  ----    ------     ----       ----               -------</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  Normal  Scheduled  <span class=\"token operator\">&lt;</span>unknown<span class=\"token operator\">></span>  default-scheduler  Successfully assigned dev/nginx-5ff7956ff6-fg2db to node1</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  Normal  Pulling    4m11s      kubelet, node1     Pulling image <span class=\"token string\">\"nginx:latest\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  Normal  Pulled     3m36s      kubelet, node1     Successfully pulled image <span class=\"token string\">\"nginx:latest\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  Normal  Created    3m36s      kubelet, node1     Created container nginx</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  Normal  Started    3m36s      kubelet, node1     Started container nginx</pre></td></tr></table></figure><h5 id=\"423-访问pod\"><a class=\"anchor\" href=\"#423-访问pod\">#</a> 4.2.3 访问 Pod</h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 获取 podIP</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME    READY   STATUS    RESTARTS   AGE    IP             NODE    <span class=\"token punctuation\">..</span>. </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          190s   <span class=\"token number\">10.244</span>.1.23   node1   <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#访问 POD</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl http://10.244.1.23:80</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>em<span class=\"token operator\">></span>Thank you <span class=\"token keyword\">for</span> using nginx.<span class=\"token operator\">&lt;</span>/em<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"424-删除指定pod\"><a class=\"anchor\" href=\"#424-删除指定pod\">#</a> 4.2.4 删除指定 Pod</h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 删除指定 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete pod nginx -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod <span class=\"token string\">\"nginx\"</span> deleted</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 此时，显示删除 Pod 成功，但是再查询，发现又新产生了一个 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nginx   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 这是因为当前 Pod 是由 Pod 控制器创建的，控制器会监控 Pod 状况，一旦发现 Pod 死亡，会立即重建</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 此时要想删除 Pod，必须删除 Pod 控制器</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 先来查询一下当前 namespace 下的 Pod 控制器</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deploy -n  dev</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>NAME    READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>nginx   <span class=\"token number\">1</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           9m7s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 接下来，删除此 PodPod 控制器</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete deploy nginx -n dev</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>deployment.apps <span class=\"token string\">\"nginx\"</span> deleted</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 稍等片刻，再查询 Pod，发现 Pod 被删除了</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>No resources found <span class=\"token keyword\">in</span> dev namespace.</pre></td></tr></table></figure><h5 id=\"425-配置操作\"><a class=\"anchor\" href=\"#425-配置操作\">#</a> 4.2.5 配置操作</h5>\n<p>创建一个 pod-nginx.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p>\n<p>创建：kubectl create -f pod-nginx.yaml</p>\n<p>删除：kubectl delete -f pod-nginx.yaml</p>\n<h4 id=\"43-label\"><a class=\"anchor\" href=\"#43-label\">#</a> 4.3 Label</h4>\n<p>Label 是 kubernetes 系统中的一个重要概念。它的作用就是在资源上添加标识，用来对它们进行区分和选择。</p>\n<p>Label 的特点：</p>\n<ul>\n<li>一个 Label 会以 key/value 键值对的形式附加到各种对象上，如 Node、Pod、Service 等等</li>\n<li>一个资源对象可以定义任意数量的 Label ，同一个 Label 也可以被添加到任意数量的资源对象上去</li>\n<li>Label 通常在资源对象定义时确定，当然也可以在对象创建后动态添加或者删除</li>\n</ul>\n<p>可以通过 Label 实现资源的多维度分组，以便灵活、方便地进行资源分配、调度、配置、部署等管理工作。</p>\n<blockquote>\n<p>一些常用的 Label 示例如下：</p>\n<ul>\n<li>版本标签：&quot;version&quot;:&quot;release&quot;, &quot;version&quot;:&quot;stable&quot;......</li>\n<li>环境标签：&quot;environment&quot;:&quot;dev&quot;，&quot;environment&quot;:&quot;test&quot;，&quot;environment&quot;:&quot;pro&quot;</li>\n<li>架构标签：&quot;tier&quot;:&quot;frontend&quot;，&quot;tier&quot;:&quot;backend&quot;</li>\n</ul>\n</blockquote>\n<p>标签定义完毕之后，还要考虑到标签的选择，这就要使用到 Label Selector，即：</p>\n<p>Label 用于给某个资源对象定义标识</p>\n<p>Label Selector 用于查询和筛选拥有某些标签的资源对象</p>\n<p>当前有两种 Label Selector：</p>\n<ul>\n<li>\n<p>基于等式的 Label Selector</p>\n<p>name = slave: 选择所有包含 Label 中 key=&quot;name&quot; 且 value=&quot;slave&quot; 的对象</p>\n<p>env != production: 选择所有包括 Label 中的 key=&quot;env&quot; 且 value 不等于 &quot;production&quot; 的对象</p>\n</li>\n<li>\n<p>基于集合的 Label Selector</p>\n<p>name in (master, slave): 选择所有包含 Label 中的 key=&quot;name&quot; 且 value=&quot;master&quot; 或 &quot;slave&quot; 的对象</p>\n<p>name not in (frontend): 选择所有包含 Label 中的 key=&quot;name&quot; 且 value 不等于 &quot;frontend&quot; 的对象</p>\n</li>\n</ul>\n<p>标签的选择条件可以使用多个，此时将多个 Label Selector 进行组合，使用逗号 &quot;,&quot; 进行分隔即可。例如：</p>\n<p>name=slave，env!=production</p>\n<p>name not in (frontend)，env!=production</p>\n<h5 id=\"431-命令方式\"><a class=\"anchor\" href=\"#431-命令方式\">#</a> 4.3.1 命令方式</h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 为 pod 资源打标签</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label pod nginx-pod version=1.0 -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/nginx-pod labeled</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 为 pod 资源更新标签</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label pod nginx-pod version=2.0 -n dev --overwrite</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pod/nginx-pod labeled</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 查看标签</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod nginx-pod  -n dev --show-labels</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>NAME        READY   STATUS    RESTARTS   AGE   LABELS</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nginx-pod   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10m   <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token number\">2.0</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 筛选标签</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n dev -l version=2.0  --show-labels</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>NAME        READY   STATUS    RESTARTS   AGE   LABELS</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nginx-pod   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17m   <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token number\">2.0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n dev -l version!=2.0 --show-labels</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>No resources found <span class=\"token keyword\">in</span> dev namespace.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#删除标签</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label pod nginx-pod version- -n dev</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pod/nginx-pod labeled</pre></td></tr></table></figure><h5 id=\"432-配置方式\"><a class=\"anchor\" href=\"#432-配置方式\">#</a> 4.3.2 配置方式</h5>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.0\"</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"test\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP</pre></td></tr></table></figure><p>然后就可以执行对应的更新命令了：kubectl apply -f pod-nginx.yaml</p>\n<h4 id=\"44-deployment\"><a class=\"anchor\" href=\"#44-deployment\">#</a> 4.4 Deployment</h4>\n<p>在 kubernetes 中，Pod 是最小的控制单元，但是 kubernetes 很少直接控制 Pod，一般都是通过 Pod 控制器来完成的。Pod 控制器用于 pod 的管理，确保 pod 资源符合预期的状态，当 pod 的资源出现故障时，会尝试进行重启或重建 pod。</p>\n<p>在 kubernetes 中 Pod 控制器的种类有很多，本章节只介绍一种：Deployment。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200408193950807.png\" alt=\"image-20200408193950807\" /></p>\n<h5 id=\"441待操作\"><a class=\"anchor\" href=\"#441待操作\">#</a> 4.4.1 待操作。。。。。</h5>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 命令格式: kubectl create deployment 名称  [参数] </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># --image  指定 pod 的镜像</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># --port   指定端口</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># --replicas  指定创建 pod 数量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># --namespace  指定 namespace</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl run nginx --image=nginx:latest --port=80 --replicas=3 -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>deployment.apps/nginx created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 查看创建的 Pod</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>NAME                     READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nginx<span class=\"token punctuation\">-</span>5ff7956ff6<span class=\"token punctuation\">-</span>6k8cb   1/1     Running   0          19s</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>nginx<span class=\"token punctuation\">-</span>5ff7956ff6<span class=\"token punctuation\">-</span>jxfjt   1/1     Running   0          19s</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>nginx<span class=\"token punctuation\">-</span>5ff7956ff6<span class=\"token punctuation\">-</span>v6jqw   1/1     Running   0          19s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 查看 deployment 的信息</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deploy -n dev</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>NAME    READY   UP<span class=\"token punctuation\">-</span>TO<span class=\"token punctuation\">-</span>DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>nginx   3/3     3            3           2m42s</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># UP-TO-DATE：成功升级的副本数量</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># AVAILABLE：可用副本的数量</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deploy -n dev -o wide</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>NAME    READY UP<span class=\"token punctuation\">-</span>TO<span class=\"token punctuation\">-</span>DATE  AVAILABLE   AGE     CONTAINERS   IMAGES              SELECTOR</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>nginx   3/3     3         3           2m51s   nginx        nginx<span class=\"token punctuation\">:</span>latest        run=nginx</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 查看 deployment 的详细信息</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe deploy nginx -n dev</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token key atrule\">Name</span><span class=\"token punctuation\">:</span>                   nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token key atrule\">Namespace</span><span class=\"token punctuation\">:</span>              dev</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token key atrule\">CreationTimestamp</span><span class=\"token punctuation\">:</span>      Wed<span class=\"token punctuation\">,</span> 08 May 2021 11<span class=\"token punctuation\">:</span>14<span class=\"token punctuation\">:</span>14 +0800</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token key atrule\">Labels</span><span class=\"token punctuation\">:</span>                 run=nginx</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token key atrule\">Annotations</span><span class=\"token punctuation\">:</span>            <span class=\"token key atrule\">deployment.kubernetes.io/revision</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token key atrule\">Selector</span><span class=\"token punctuation\">:</span>               run=nginx</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token key atrule\">Replicas</span><span class=\"token punctuation\">:</span>               3 desired <span class=\"token punctuation\">|</span> 3 updated <span class=\"token punctuation\">|</span> 3 total <span class=\"token punctuation\">|</span> 3 available <span class=\"token punctuation\">|</span> 0 unavailable</pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token key atrule\">StrategyType</span><span class=\"token punctuation\">:</span>           RollingUpdate</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token key atrule\">MinReadySeconds</span><span class=\"token punctuation\">:</span>        <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token key atrule\">RollingUpdateStrategy</span><span class=\"token punctuation\">:</span>  25% max unavailable<span class=\"token punctuation\">,</span> 25% max 违规词汇</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token key atrule\">Pod Template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token key atrule\">Labels</span><span class=\"token punctuation\">:</span>  run=nginx</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token key atrule\">Containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   <span class=\"token key atrule\">nginx</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token key atrule\">Image</span><span class=\"token punctuation\">:</span>        nginx<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token key atrule\">Port</span><span class=\"token punctuation\">:</span>         80/TCP</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token key atrule\">Host Port</span><span class=\"token punctuation\">:</span>    0/TCP</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token key atrule\">Environment</span><span class=\"token punctuation\">:</span>  &lt;none<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token key atrule\">Mounts</span><span class=\"token punctuation\">:</span>       &lt;none<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token key atrule\">Volumes</span><span class=\"token punctuation\">:</span>        &lt;none<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token key atrule\">Conditions</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  Type           Status  Reason</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>           <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  Available      True    MinimumReplicasAvailable</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  Progressing    True    NewReplicaSetAvailable</pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token key atrule\">OldReplicaSets</span><span class=\"token punctuation\">:</span>  &lt;none<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token key atrule\">NewReplicaSet</span><span class=\"token punctuation\">:</span>   nginx<span class=\"token punctuation\">-</span>5ff7956ff6 (3/3 replicas created)</pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token key atrule\">Events</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  Type    Reason             Age    From                   Message</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>    <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span>             <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>   <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>                   <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  Normal  ScalingReplicaSet  5m43s  deployment<span class=\"token punctuation\">-</span>controller  Scaled up replicaset nginx<span class=\"token punctuation\">-</span>5ff7956ff6 to 3</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\"># 删除 </span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete deploy nginx -n dev</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>deployment.apps \"nginx\" deleted</pre></td></tr></table></figure><h5 id=\"442-配置操作\"><a class=\"anchor\" href=\"#442-配置操作\">#</a> 4.4.2 配置操作</h5>\n<p>创建一个 deploy-nginx.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p>\n<p>创建：kubectl create -f deploy-nginx.yaml</p>\n<p>删除：kubectl delete -f deploy-nginx.yaml</p>\n<h4 id=\"45-service\"><a class=\"anchor\" href=\"#45-service\">#</a> 4.5 Service</h4>\n<p>通过上节课的学习，已经能够利用 Deployment 来创建一组 Pod 来提供具有高可用性的服务。</p>\n<p>虽然每个 Pod 都会分配一个单独的 Pod IP，然而却存在如下两问题：</p>\n<ul>\n<li>Pod IP 会随着 Pod 的重建产生变化</li>\n<li>Pod IP 仅仅是集群内可见的虚拟 IP，外部无法访问</li>\n</ul>\n<p>这样对于访问这个服务带来了难度。因此，kubernetes 设计了 Service 来解决这个问题。</p>\n<p>Service 可以看作是一组同类 Pod<strong> 对外的访问接口</strong>。借助 Service，应用可以方便地实现服务发现和负载均衡。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200408194716912.png\" alt=\"image-20200408194716912\" /></p>\n<h5 id=\"451-创建集群内部可访问的service\"><a class=\"anchor\" href=\"#451-创建集群内部可访问的service\">#</a> 4.5.1 创建集群内部可访问的 Service</h5>\n<pre><code class=\"language-yacas\"># 暴露Service\n[root@master ~]# kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev\nservice/svc-nginx1 exposed\n\n# 查看service\n[root@master ~]# kubectl get svc svc-nginx1 -n dev -o wide\nNAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE     SELECTOR\nsvc-nginx1   ClusterIP   10.109.179.231   &lt;none&gt;        80/TCP    3m51s   run=nginx\n\n# 这里产生了一个CLUSTER-IP，这就是service的IP，在Service的生命周期中，这个地址是不会变动的\n# 可以通过这个IP访问当前service对应的POD\n[root@master ~]# curl 10.109.179.231:80\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n.......\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n<h5 id=\"452-创建集群外部也可访问的service\"><a class=\"anchor\" href=\"#452-创建集群外部也可访问的service\">#</a> 4.5.2 创建集群外部也可访问的 Service</h5>\n<pre><code class=\"language-yacas\"># 上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问\n# 如果需要创建外部也可以访问的Service，需要修改type为NodePort\n[root@master ~]# kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev\nservice/svc-nginx2 exposed\n\n# 此时查看，会发现出现了NodePort类型的Service，而且有一对Port（80:31928/TC）\n[root@master ~]# kubectl get svc  svc-nginx2  -n dev -o wide\nNAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE    SELECTOR\nsvc-nginx2    NodePort    10.100.94.0      &lt;none&gt;        80:31928/TCP   9s     run=nginx\n\n# 接下来就可以通过集群外的主机访问 节点IP:31928访问服务了\n# 例如在的电脑主机上通过浏览器访问下面的地址\nhttp://192.168.90.100:31928/\n</code></pre>\n<h5 id=\"453-删除service\"><a class=\"anchor\" href=\"#453-删除service\">#</a> 4.5.3 删除 Service</h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete svc svc-nginx-1 -n dev </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">service</span> <span class=\"token string\">\"svc-nginx-1\"</span> deleted</pre></td></tr></table></figure><h5 id=\"454-配置方式\"><a class=\"anchor\" href=\"#454-配置方式\">#</a> 4.5.4 配置方式</h5>\n<p>创建一个 svc-nginx.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> svc<span class=\"token punctuation\">-</span>nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">clusterIP</span><span class=\"token punctuation\">:</span> 10.109.179.231 <span class=\"token comment\">#固定 svc 的内网 ip</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP</pre></td></tr></table></figure><p>然后就可以执行对应的创建和删除命令了：</p>\n<p>创建：kubectl create -f svc-nginx.yaml</p>\n<p>删除：kubectl delete -f svc-nginx.yaml</p>\n<blockquote>\n<p><strong>小结</strong></p>\n<p>至此，已经掌握了 Namespace、Pod、Deployment、Service 资源的基本操作，有了这些操作，就可以在 kubernetes 集群中实现一个服务的简单部署和访问了，但是如果想要更好的使用 kubernetes，就需要深入学习这几种资源的细节和原理。</p>\n</blockquote>\n<h3 id=\"5-pod详解\"><a class=\"anchor\" href=\"#5-pod详解\">#</a> 5. Pod 详解</h3>\n<h4 id=\"51-pod介绍\"><a class=\"anchor\" href=\"#51-pod介绍\">#</a> 5.1 Pod 介绍</h4>\n<h5 id=\"511-pod结构\"><a class=\"anchor\" href=\"#511-pod结构\">#</a> 5.1.1 Pod 结构</h5>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200407121501907-1626781151898.png\" alt=\"image-20200407121501907\" /></p>\n<p>每个 Pod 中都可以包含一个或者多个容器，这些容器可以分为两类：</p>\n<ul>\n<li>\n<p>用户程序所在的容器，数量可多可少</p>\n</li>\n<li>\n<p>Pause 容器，这是每个 Pod 都会有的一个<strong>根容器</strong>，它的作用有两个：</p>\n<ul>\n<li>\n<p>可以以它为依据，评估整个 Pod 的健康状态</p>\n</li>\n<li>\n<p>可以在根容器上设置 Ip 地址，其它容器都此 Ip（Pod IP），以实现 Pod 内部的网路通信</p>\n<pre><code>这里是Pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术来实现，我们当前环境用的是Flannel\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"512-pod定义\"><a class=\"anchor\" href=\"#512-pod定义\">#</a> 5.1.2 Pod 定义</h5>\n<p>下面是 Pod 的资源清单：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1     <span class=\"token comment\">#必选，版本号，例如 v1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod       　 <span class=\"token comment\">#必选，资源类型，例如 Pod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>       　 <span class=\"token comment\">#必选，元数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string     <span class=\"token comment\">#必选，Pod 名称</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> string  <span class=\"token comment\">#Pod 所属的命名空间，默认为 \"default\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>       　　  <span class=\"token comment\">#自定义标签列表</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string      　          </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#必选，Pod 中容器的详细定义</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#必选，Pod 中容器列表</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string   <span class=\"token comment\">#必选，容器名称</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> string  <span class=\"token comment\">#必选，容器的镜像名称</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> Always<span class=\"token punctuation\">|</span>Never<span class=\"token punctuation\">|</span>IfNotPresent <span class=\"token punctuation\">]</span>  <span class=\"token comment\">#获取镜像的策略 </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>string<span class=\"token punctuation\">]</span>   <span class=\"token comment\">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>string<span class=\"token punctuation\">]</span>      <span class=\"token comment\">#容器的启动命令参数列表</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">workingDir</span><span class=\"token punctuation\">:</span> string  <span class=\"token comment\">#容器的工作目录</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>       <span class=\"token comment\">#挂载到容器内部的存储卷配置</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string      <span class=\"token comment\">#引用 pod 定义的共享存储卷的名称，需用 volumes [] 部分定义的的卷名</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> string <span class=\"token comment\">#存储卷在容器内 mount 的绝对路径，应少于 512 字符</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token key atrule\">readOnly</span><span class=\"token punctuation\">:</span> boolean <span class=\"token comment\">#是否为只读模式</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#需要暴露的端口库号列表</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string        <span class=\"token comment\">#端口的名称</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> int  <span class=\"token comment\">#容器需要监听的端口号</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token key atrule\">hostPort</span><span class=\"token punctuation\">:</span> int       <span class=\"token comment\">#容器所在主机需要监听的端口号，默认与 Container 相同</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> string    <span class=\"token comment\">#端口协议，支持 TCP 和 UDP，默认 TCP</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>   <span class=\"token comment\">#容器运行前需设置的环境变量列表</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string  <span class=\"token comment\">#环境变量名称</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> string <span class=\"token comment\">#环境变量的值</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#资源限制和请求的设置</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#资源限制的设置</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> string     <span class=\"token comment\">#Cpu 的限制，单位为 core 数，将用于 docker run --cpu-shares 参数</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> string  <span class=\"token comment\">#内存限制，单位可以为 Mib/Gib，将用于 docker run --memory 参数</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#资源请求的设置</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> string    <span class=\"token comment\">#Cpu 请求，容器启动的初始可用数量</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> string <span class=\"token comment\">#内存请求，容器启动的初始可用数量</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token key atrule\">lifecycle</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#生命周期钩子</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token key atrule\">postStart</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#容器启动后立即执行此钩子，如果执行失败，会根据重启策略进行重启</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token key atrule\">preStop</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#容器终止前执行此钩子，无论结果如何，容器都会终止</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#对 Pod 内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>       　 <span class=\"token comment\">#对 Pod 容器内检查方式设置为 exec 方式</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>string<span class=\"token punctuation\">]</span>  <span class=\"token comment\">#exec 方式需要制定的命令或脚本</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>       <span class=\"token comment\">#对 Pod 内个容器健康检查方法设置为 HttpGet，需要制定 Path、port</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> number</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token key atrule\">HttpHeaders</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span>     <span class=\"token comment\">#对 Pod 内个容器健康检查方式设置为 tcpSocket 方式</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>         <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> number</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>       <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>       <span class=\"token comment\">#容器启动完成后首次探测的时间，单位为秒</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>       <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> 0    　　    <span class=\"token comment\">#对容器健康检查探测等待响应的超时时间，单位秒，默认 1 秒</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>       <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> 0     　　    <span class=\"token comment\">#对容器监控检查的定期探测时间设置，单位秒，默认 10 秒一次</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>       <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>       <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>       <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>         <span class=\"token key atrule\">privileged</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Always <span class=\"token punctuation\">|</span> Never <span class=\"token punctuation\">|</span> OnFailure<span class=\"token punctuation\">]</span>  <span class=\"token comment\">#Pod 的重启策略</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token key atrule\">nodeName</span><span class=\"token punctuation\">:</span> &lt;string<span class=\"token punctuation\">></span> <span class=\"token comment\">#设置 NodeName 表示将该 Pod 调度到指定到名称的 node 节点上</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span> obeject <span class=\"token comment\">#设置 NodeSelector 表示将该 Pod 调度到包含这个 label 的 node 上</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token key atrule\">imagePullSecrets</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#Pull 镜像时使用的 secret 名称，以 key：secretkey 格式指定</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token key atrule\">hostNetwork</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>   <span class=\"token comment\">#是否使用主机网络模式，默认为 false，如果设置为 true，表示使用宿主机网络</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>   <span class=\"token comment\">#在该 pod 上定义共享存储卷列表</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string    <span class=\"token comment\">#共享存储卷名称 （volumes 类型有很多种）</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token key atrule\">emptyDir</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>       <span class=\"token comment\">#类型为 emtyDir 的存储卷，与 Pod 同生命周期的一个临时目录。为空值</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span> string   <span class=\"token comment\">#类型为 hostPath 的存储卷，表示挂载 Pod 所在宿主机的目录</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> string      　　        <span class=\"token comment\">#Pod 所在宿主机的目录，将被用于同期中 mount 的目录</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span>       　　　<span class=\"token comment\">#类型为 secret 的存储卷，挂载集群与定义的 secret 对象到容器内部</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token key atrule\">scretname</span><span class=\"token punctuation\">:</span> string  </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>     </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>         <span class=\"token comment\">#类型为 configMap 的存储卷，挂载预定义的 configMap 对象到容器内部</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>      <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> string</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> string</pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#小提示：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#   在这里，可通过一个命令来查看每种资源的可配置项</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#   kubectl explain 资源类型         查看某种资源可以配置的一级属性</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#   kubectl explain 资源类型。属性     查看属性的子属性</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl explain pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">KIND</span><span class=\"token punctuation\">:</span>     Pod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">VERSION</span><span class=\"token punctuation\">:</span>  v1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">FIELDS</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   apiVersion   &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   kind &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   metadata     &lt;Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   spec &lt;Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   status       &lt;Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl explain pod.metadata</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key atrule\">KIND</span><span class=\"token punctuation\">:</span>     Pod</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token key atrule\">VERSION</span><span class=\"token punctuation\">:</span>  v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token key atrule\">RESOURCE</span><span class=\"token punctuation\">:</span> metadata &lt;Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key atrule\">FIELDS</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   annotations  &lt;map<span class=\"token punctuation\">[</span>string<span class=\"token punctuation\">]</span>string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   clusterName  &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   creationTimestamp    &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   deletionGracePeriodSeconds   &lt;integer<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   deletionTimestamp    &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   finalizers   &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   generateName &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   generation   &lt;integer<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   labels       &lt;map<span class=\"token punctuation\">[</span>string<span class=\"token punctuation\">]</span>string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   managedFields        &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   name &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   namespace    &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   ownerReferences      &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   resourceVersion      &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   selfLink     &lt;string<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   uid  &lt;string<span class=\"token punctuation\">></span></pre></td></tr></table></figure><p>在 kubernetes 中基本所有资源的一级属性都是一样的，主要包含 5 部分：</p>\n<ul>\n<li>apiVersion &lt;string&gt; 版本，由 kubernetes 内部定义，版本号必须可以用 kubectl api-versions 查询到</li>\n<li>kind &lt;string&gt; 类型，由 kubernetes 内部定义，版本号必须可以用 kubectl api-resources 查询到</li>\n<li>metadata &lt;Object&gt; 元数据，主要是资源标识和说明，常用的有 name、namespace、labels 等</li>\n<li>spec &lt;Object&gt; 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</li>\n<li>status &lt;Object&gt; 状态信息，里面的内容不需要定义，由 kubernetes 自动生成</li>\n</ul>\n<p>在上面的属性中，spec 是接下来研究的重点，继续看下它的常见子属性:</p>\n<ul>\n<li>containers &lt;[] Object&gt; 容器列表，用于定义容器的详细信息</li>\n<li>nodeName &lt;String&gt; 根据 nodeName 的值将 pod 调度到指定的 Node 节点上</li>\n<li>nodeSelector &lt;map []&gt; 根据 NodeSelector 中定义的信息选择将该 Pod 调度到包含这些 label 的 Node 上</li>\n<li>hostNetwork &lt;boolean&gt; 是否使用主机网络模式，默认为 false，如果设置为 true，表示使用宿主机网络</li>\n<li>volumes &lt;[] Object&gt; 存储卷，用于定义 Pod 上面挂在的存储信息</li>\n<li>restartPolicy &lt;string&gt; 重启策略，表示 Pod 在遇到故障的时候的处理策略</li>\n</ul>\n<h4 id=\"52-pod配置\"><a class=\"anchor\" href=\"#52-pod配置\">#</a> 5.2 Pod 配置</h4>\n<p>本小节主要来研究 <code>pod.spec.containers</code>  属性，这也是 pod 配置中最为关键的一项配置。</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl explain pod.spec.containers</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">KIND</span><span class=\"token punctuation\">:</span>     Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">VERSION</span><span class=\"token punctuation\">:</span>  v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">RESOURCE</span><span class=\"token punctuation\">:</span> containers &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>Object<span class=\"token punctuation\">></span>   <span class=\"token comment\"># 数组，代表可以有多个容器</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">FIELDS</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   name  &lt;string<span class=\"token punctuation\">></span>     <span class=\"token comment\"># 容器名称</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   image &lt;string<span class=\"token punctuation\">></span>     <span class=\"token comment\"># 容器需要的镜像地址</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   imagePullPolicy  &lt;string<span class=\"token punctuation\">></span> <span class=\"token comment\"># 镜像拉取策略 </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   command  &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>string<span class=\"token punctuation\">></span> <span class=\"token comment\"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   args     &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>string<span class=\"token punctuation\">></span> <span class=\"token comment\"># 容器的启动命令需要的参数列表</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   env      &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>Object<span class=\"token punctuation\">></span> <span class=\"token comment\"># 容器环境变量的配置</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   ports    &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>Object<span class=\"token punctuation\">></span>     <span class=\"token comment\"># 容器需要暴露的端口号列表</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   resources &lt;Object<span class=\"token punctuation\">></span>      <span class=\"token comment\"># 资源限制和资源请求的设置</span></pre></td></tr></table></figure><h5 id=\"521-基本配置\"><a class=\"anchor\" href=\"#521-基本配置\">#</a> 5.2.1 基本配置</h5>\n<p>创建 pod-base.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>base</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> heima</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr></table></figure><p><img data-src=\"http://oss.itshare.work/blog-images/image-20210617223823675-1626781695411.png\" alt=\"image-20210617223823675\" /></p>\n<p>上面定义了一个比较简单 Pod 的配置，里面有两个容器：</p>\n<ul>\n<li>nginx：用 1.17.1 版本的 nginx 镜像创建，（nginx 是一个轻量级 web 容器）</li>\n<li>busybox：用 1.30 版本的 busybox 镜像创建，（busybox 是一个小巧的 linux 命令集合）</li>\n</ul>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f pod-base.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>base created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod 状况</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># READY 1/2 : 表示当前 Pod 中有 2 个容器，其中 1 个准备就绪，1 个未就绪</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># RESTARTS  : 重启次数，因为有 1 个容器故障了，Pod 一直在重启试图恢复它</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n dev</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NAME       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pod<span class=\"token punctuation\">-</span>base   1/2     Running   4          95s</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 可以通过 describe 查看内部的详情</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 此时已经运行起来了一个基本的 Pod，虽然它暂时有问题</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pod pod-base -n dev</span></pre></td></tr></table></figure><h5 id=\"522-镜像拉取\"><a class=\"anchor\" href=\"#522-镜像拉取\">#</a> 5.2.2 镜像拉取</h5>\n<p>创建 pod-imagepullpolicy.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>imagepullpolicy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> Never <span class=\"token comment\"># 用于设置镜像拉取策略</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr></table></figure><p><img data-src=\"http://oss.itshare.work/blog-images/image-20210617223923659.png\" alt=\"image-20210617223923659\" /></p>\n<p>imagePullPolicy，用于设置镜像拉取策略，kubernetes 支持配置三种拉取策略：</p>\n<ul>\n<li>Always：总是从远程仓库拉取镜像（一直远程下载）</li>\n<li>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像（本地有就本地 本地没远程下载）</li>\n<li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错 （一直使用本地）</li>\n</ul>\n<blockquote>\n<p>默认值说明：</p>\n<p>如果镜像 tag 为具体版本号， 默认策略是：IfNotPresent</p>\n<p>如果镜像 tag 为：latest（最终版本） ，默认策略是 always</p>\n</blockquote>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-imagepullpolicy.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>imagepullpolicy created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 此时明显可以看到 nginx 镜像有一步 Pulling image \"nginx:1.17.1\" 的过程</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pod pod-imagepullpolicy -n dev</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">Events</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Type     Reason     Age               From               Message</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>     <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span>     <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>              <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>               <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Normal   Scheduled  &lt;unknown<span class=\"token punctuation\">></span>         default<span class=\"token punctuation\">-</span>scheduler  Successfully assigned dev/pod<span class=\"token punctuation\">-</span>imagePullPolicy to node1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  Normal   Pulling    32s               kubelet<span class=\"token punctuation\">,</span> node1     Pulling image \"nginx<span class=\"token punctuation\">:</span>1.17.1\"</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  Normal   Pulled     26s               kubelet<span class=\"token punctuation\">,</span> node1     Successfully pulled image \"nginx<span class=\"token punctuation\">:</span>1.17.1\"</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Normal   Created    26s               kubelet<span class=\"token punctuation\">,</span> node1     Created container nginx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Normal   Started    25s               kubelet<span class=\"token punctuation\">,</span> node1     Started container nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  Normal   Pulled     7s (x3 over 25s)  kubelet<span class=\"token punctuation\">,</span> node1     Container image \"busybox<span class=\"token punctuation\">:</span>1.30\" already present on machine</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  Normal   Created    7s (x3 over 25s)  kubelet<span class=\"token punctuation\">,</span> node1     Created container busybox</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  Normal   Started    7s (x3 over 25s)  kubelet<span class=\"token punctuation\">,</span> node1     Started container busybox</pre></td></tr></table></figure><h5 id=\"523-启动命令\"><a class=\"anchor\" href=\"#523-启动命令\">#</a> 5.2.3 启动命令</h5>\n<p>在前面的案例中，一直有一个问题没有解决，就是的 busybox 容器一直没有成功运行，那么到底是什么原因导致这个容器的故障呢？</p>\n<p>原来 busybox 并不是一个程序，而是类似于一个工具类的集合，kubernetes 集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了 command 配置。</p>\n<p>创建 pod-command.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>command</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) >> /tmp/hello.txt; sleep 3; done;\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p><img data-src=\"http://oss.itshare.work/blog-images/image-20210617224457945.png\" alt=\"image-20210617224457945\" /></p>\n<p>command，用于在 pod 中的容器初始化完毕之后运行一个命令。</p>\n<blockquote>\n<p>稍微解释下上面命令的意思：</p>\n<p>&quot;/bin/sh&quot;,&quot;-c&quot;, 使用 sh 执行命令</p>\n<p>touch /tmp/hello.txt; 创建一个 /tmp/hello.txt 文件</p>\n<p>while true;do /bin/echo $(date +% T) &gt;&gt; /tmp/hello.txt; sleep 3; done; 每隔 3 秒向文件中写入当前时间</p>\n</blockquote>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create  -f pod-command.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>command created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod 状态</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 此时发现两个 pod 都正常运行了</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-command -n dev</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME          READY   STATUS   RESTARTS   AGE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pod<span class=\"token punctuation\">-</span>command   2/2     Runing   0          2s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 进入 pod 中的 busybox 容器，查看文件内容</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 补充一个命令: kubectl exec  pod 名称 -n 命名空间 -it -c 容器名称 /bin/sh  在容器内部执行命令</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 比如，可以查看 txt 文件的内容</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 pod<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec pod-command -n dev -it -c busybox /bin/sh</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>/ <span class=\"token comment\"># tail -f /tmp/hello.txt</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>14<span class=\"token punctuation\">:</span><span class=\"token datetime number\">44:19</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>14<span class=\"token punctuation\">:</span><span class=\"token datetime number\">44:22</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>14<span class=\"token punctuation\">:</span><span class=\"token datetime number\">44:25</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>特别说明：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢<span class=\"token punctuation\">?</span>这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> 1 如果command和args均没有写，那么用Dockerfile的配置。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> 2 如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> 3 如果command没写，但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前args的参数</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> 4 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</pre></td></tr></table></figure><h5 id=\"524-环境变量\"><a class=\"anchor\" href=\"#524-环境变量\">#</a> 5.2.4 环境变量</h5>\n<p>创建 pod-env.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>env</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"while true;do /bin/echo $(date +%T);sleep 60; done;\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 设置环境变量列表</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"username\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"password\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"123456\"</span></pre></td></tr></table></figure><p>env，环境变量，用于在 pod 中的容器设置环境变量。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-env.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod-env created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 进入容器，输出环境变量</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec pod-env -n dev -c busybox -it /bin/sh</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>/ <span class=\"token comment\"># echo $username</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>admin</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/ <span class=\"token comment\"># echo $password</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">123456</span></pre></td></tr></table></figure><p>这种方式不是很推荐，推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。</p>\n<h5 id=\"525-端口设置\"><a class=\"anchor\" href=\"#525-端口设置\">#</a> 5.2.5 端口设置</h5>\n<p>本小节来介绍容器的端口设置，也就是 containers 的 ports 选项。</p>\n<p>首先看下 ports 支持的子选项：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl explain pod.spec.containers.ports</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">KIND</span><span class=\"token punctuation\">:</span>     Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">VERSION</span><span class=\"token punctuation\">:</span>  v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">RESOURCE</span><span class=\"token punctuation\">:</span> ports &lt;<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">FIELDS</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   name         &lt;string<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 端口名称，如果指定，必须保证 name 在 pod 中是唯一的\t\t</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   containerPort&lt;integer<span class=\"token punctuation\">></span> <span class=\"token comment\"># 容器要监听的端口 (0&lt;x&lt;65536)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   hostPort     &lt;integer<span class=\"token punctuation\">></span> <span class=\"token comment\"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本 (一般省略) </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   hostIP       &lt;string<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 要将外部端口绑定到的主机 IP (一般省略)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   protocol     &lt;string<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 端口协议。必须是 UDP、TCP 或 SCTP。默认为 “TCP”。</span></pre></td></tr></table></figure><p>接下来，编写一个测试案例，创建 pod-ports.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>ports</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 设置容器暴露的端口列表</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-ports.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod-ports created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 在下面可以明显看到配置信息</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod pod-ports -n dev -o yaml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - image: nginx:1.17.1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    name: nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ports:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      name: nginx-port</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr></table></figure><p>访问容器中的程序需要使用的是 <code>Podip:containerPort</code></p>\n<h5 id=\"526-资源配额\"><a class=\"anchor\" href=\"#526-资源配额\">#</a> 5.2.6 资源配额</h5>\n<p>容器中的程序要运行，肯定是要占用一定资源的，比如 cpu 和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其它容器无法运行。针对这种情况，kubernetes 提供了对内存和 cpu 的资源进行配额的机制，这种机制主要通过 resources 选项实现，他有两个子选项：</p>\n<ul>\n<li>limits：用于限制运行时容器的最大占用资源，当容器占用资源超过 limits 时会被终止，并进行重启</li>\n<li>requests ：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动</li>\n</ul>\n<p>可以通过上面两个选项设置资源的上下限。</p>\n<p>接下来，编写一个测试案例，创建 pod-resources.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>resources</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 资源配额</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 限制资源（上限）</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span> <span class=\"token comment\"># CPU 限制，单位是 core 数</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10Gi\"</span> <span class=\"token comment\"># 内存限制</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 请求资源（下限）</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span>  <span class=\"token comment\"># CPU 限制，单位是 core 数</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10Mi\"</span>  <span class=\"token comment\"># 内存限制</span></pre></td></tr></table></figure><p>在这对 cpu 和 memory 的单位做一个说明：</p>\n<ul>\n<li>cpu：core 数，可以为整数或小数</li>\n<li>memory： 内存大小，可以使用 Gi、Mi、G、M 等形式</li>\n</ul>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 运行 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create  -f pod-resources.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>resources created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看发现 pod 运行正常</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod pod-resources -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod<span class=\"token punctuation\">-</span>resources   1/1     Running   0          39s   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 接下来，停止 Pod</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete  -f pod-resources.yaml</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pod \"pod<span class=\"token punctuation\">-</span>resources\" deleted</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 编辑 pod，修改 resources.requests.memory 的值为 10Gi</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim pod-resources.yaml</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 再次启动 pod</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create  -f pod-resources.yaml</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>resources created</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 查看 Pod 状态，发现 Pod 启动失败</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod pod-resources -n dev -o wide</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE          </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pod<span class=\"token punctuation\">-</span>resources   0/1     Pending   0          20s    </pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 查看 pod 详情会发现，如下提示</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pod pod-resources -n dev</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token key atrule\">Warning  FailedScheduling  35s   default-scheduler  0/3 nodes are available</span><span class=\"token punctuation\">:</span> 1 node(s) had taint <span class=\"token punctuation\">&#123;</span><span class=\"token key atrule\">node-role.kubernetes.io/master</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> that the pod didn't tolerate<span class=\"token punctuation\">,</span> 2 Insufficient memory.(内存不足)</pre></td></tr></table></figure><h4 id=\"53-pod生命周期\"><a class=\"anchor\" href=\"#53-pod生命周期\">#</a> 5.3 Pod 生命周期</h4>\n<p>我们一般将 pod 对象从创建至终的这段时间范围称为 pod 的生命周期，它主要包含下面的过程：</p>\n<ul>\n<li>pod 创建过程</li>\n<li>运行初始化容器（init container）过程</li>\n<li>运行主容器（main container）\n<ul>\n<li>容器启动后钩子（post start）、容器终止前钩子（pre stop）</li>\n<li>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</li>\n</ul>\n</li>\n<li>pod 终止过程</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200412111402706-1626782188724.png\" alt=\"image-20200412111402706\" /></p>\n<p>在整个生命周期中，Pod 会出现 5 种<strong>状态</strong>（<strong>相位</strong>），分别如下：</p>\n<ul>\n<li>挂起（Pending）：apiserver 已经创建了 pod 资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</li>\n<li>运行中（Running）：pod 已经被调度至某节点，并且所有容器都已经被 kubelet 创建完成</li>\n<li>成功（Succeeded）：pod 中的所有容器都已经成功终止并且不会被重启</li>\n<li>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非 0 值的退出状态</li>\n<li>未知（Unknown）：apiserver 无法正常获取到 pod 对象的状态信息，通常由网络通信失败所导致</li>\n</ul>\n<h5 id=\"531-创建和终止\"><a class=\"anchor\" href=\"#531-创建和终止\">#</a> 5.3.1 创建和终止</h5>\n<p><strong>pod 的创建过程</strong></p>\n<ol>\n<li>\n<p>用户通过 kubectl 或其他 api 客户端提交需要创建的 pod 信息给 apiServer</p>\n</li>\n<li>\n<p>apiServer 开始生成 pod 对象的信息，并将信息存入 etcd，然后返回确认信息至客户端</p>\n</li>\n<li>\n<p>apiServer 开始反映 etcd 中的 pod 对象的变化，其它组件使用 watch 机制来跟踪检查 apiServer 上的变动</p>\n</li>\n<li>\n<p>scheduler 发现有新的 pod 对象要创建，开始为 Pod 分配主机并将结果信息更新至 apiServer</p>\n</li>\n<li>\n<p>node 节点上的 kubelet 发现有 pod 调度过来，尝试调用 docker 启动容器，并将结果回送至 apiServer</p>\n</li>\n<li>\n<p>apiServer 将接收到的 pod 状态信息存入 etcd 中</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200406184656917-1626782168787.png\" alt=\"image-20200406184656917\" /></p>\n</li>\n</ol>\n<p><strong>pod 的终止过程</strong></p>\n<ol>\n<li>用户向 apiServer 发送删除 pod 对象的命令</li>\n<li>apiServcer 中的 pod 对象信息会随着时间的推移而更新，在宽限期内（默认 30s），pod 被视为 dead</li>\n<li>将 pod 标记为 terminating 状态</li>\n<li>kubelet 在监控到 pod 对象转为 terminating 状态的同时启动 pod 关闭过程</li>\n<li>端点控制器监控到 pod 对象的关闭行为时将其从所有匹配到此端点的 service 资源的端点列表中移除</li>\n<li>如果当前 pod 对象定义了 preStop 钩子处理器，则在其标记为 terminating 后即会以同步的方式启动执行</li>\n<li>pod 对象中的容器进程收到停止信号</li>\n<li>宽限期结束后，若 pod 中还存在仍在运行的进程，那么 pod 对象会收到立即终止的信号</li>\n<li>kubelet 请求 apiServer 将此 pod 资源的宽限期设置为 0 从而完成删除操作，此时 pod 对于用户已不可见</li>\n</ol>\n<h5 id=\"532-初始化容器\"><a class=\"anchor\" href=\"#532-初始化容器\">#</a> 5.3.2 初始化容器</h5>\n<p>初始化容器是在 pod 的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p>\n<ol>\n<li>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么 kubernetes 需要重启它直到成功完成</li>\n<li>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</li>\n</ol>\n<p>初始化容器有很多的应用场景，下面列出的是最常见的几个：</p>\n<ul>\n<li>提供主容器镜像中不具备的工具程序或自定义代码</li>\n<li>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</li>\n</ul>\n<p>接下来做一个案例，模拟下面这个需求：</p>\n<p>假设要以主容器来运行 nginx，但是要求在运行 nginx 之前先要能够连接上 mysql 和 redis 所在服务器</p>\n<p>为了简化测试，事先规定好 mysql <code>(192.168.90.14)</code>  和 redis <code>(192.168.90.15)</code>  服务器的地址</p>\n<p>创建 pod-initcontainer.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>initcontainer</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main<span class=\"token punctuation\">-</span>container</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">initContainers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>mysql</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sh'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-c'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'until ping 192.168.90.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test<span class=\"token punctuation\">-</span>redis</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sh'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-c'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'until ping 192.168.90.15 -c 1 ; do echo waiting for reids...; sleep 2; done;'</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-initcontainer.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>initcontainer created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod 状态</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 发现 pod 卡在启动第一个初始化容器过程中，后面的容器不会运行</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pod  pod-initcontainer -n dev</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span>..</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">Events</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Type    Reason     Age   From               Message</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>    <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span>     <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>               <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Normal  Scheduled  49s   default<span class=\"token punctuation\">-</span>scheduler  Successfully assigned dev/pod<span class=\"token punctuation\">-</span>initcontainer to node1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  Normal  Pulled     48s   kubelet<span class=\"token punctuation\">,</span> node1     Container image \"busybox<span class=\"token punctuation\">:</span>1.30\" already present on machine</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  Normal  Created    48s   kubelet<span class=\"token punctuation\">,</span> node1     Created container test<span class=\"token punctuation\">-</span>mysql</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Normal  Started    48s   kubelet<span class=\"token punctuation\">,</span> node1     Started container test<span class=\"token punctuation\">-</span>mysql</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 动态查看 pod</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-initcontainer -n dev -w</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>NAME                             READY   STATUS     RESTARTS   AGE</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pod<span class=\"token punctuation\">-</span>initcontainer                0/1     Init<span class=\"token punctuation\">:</span>0/2   0          15s</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pod<span class=\"token punctuation\">-</span>initcontainer                0/1     Init<span class=\"token punctuation\">:</span>1/2   0          52s</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pod<span class=\"token punctuation\">-</span>initcontainer                0/1     Init<span class=\"token punctuation\">:</span>1/2   0          53s</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pod<span class=\"token punctuation\">-</span>initcontainer                0/1     PodInitializing   0          89s</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pod<span class=\"token punctuation\">-</span>initcontainer                1/1     Running           0          90s</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 接下来新开一个 shell，为当前服务器新增两个 ip，观察 pod 的变化</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig ens33:1 192.168.90.14 netmask 255.255.255.0 up</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig ens33:2 192.168.90.15 netmask 255.255.255.0 up</span></pre></td></tr></table></figure><h5 id=\"533-钩子函数\"><a class=\"anchor\" href=\"#533-钩子函数\">#</a> 5.3.3 钩子函数</h5>\n<p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</p>\n<p>kubernetes 在主容器的启动之后和停止之前提供了两个钩子函数：</p>\n<ul>\n<li>post start：容器创建之后执行，如果失败了会重启容器</li>\n<li>pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</li>\n</ul>\n<p>钩子处理器支持使用下面三种方式定义动作：</p>\n<ul>\n<li>\n<p>Exec 命令：在容器内执行一次命令</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">lifecycle</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">postStart</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">-</span> cat</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">-</span> /tmp/healthy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>……</pre></td></tr></table></figure></li>\n<li>\n<p>TCPSocket：在当前容器尝试访问指定的 socket</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>……      </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">lifecycle</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">postStart</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>……</pre></td></tr></table></figure></li>\n<li>\n<p>HTTPGet：在当前容器中向某 url 发起 http 请求</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">lifecycle</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">postStart</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> / <span class=\"token comment\">#URI 地址</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span> <span class=\"token comment\">#端口号</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 192.168.5.3 <span class=\"token comment\">#主机地址</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP <span class=\"token comment\">#支持的协议，http 或者 https</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>……</pre></td></tr></table></figure></li>\n</ul>\n<p>接下来，以 exec 方式为例，演示下钩子函数的使用，创建 pod-hook-exec.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>hook<span class=\"token punctuation\">-</span>exec</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main<span class=\"token punctuation\">-</span>container</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">lifecycle</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">postStart</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 在容器启动的时候执行一个命令，修改掉 nginx 的默认首页内容</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"echo postStart... > /usr/share/nginx/html/index.html\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">preStop</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 在容器停止之前停止 nginx 服务</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/sbin/nginx\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-s\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"quit\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-hook-exec.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>hook<span class=\"token punctuation\">-</span>exec created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods  pod-hook-exec -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME           READY   STATUS     RESTARTS   AGE    IP            NODE    </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod<span class=\"token punctuation\">-</span>hook<span class=\"token punctuation\">-</span>exec  1/1     Running    0          29s    10.244.2.48   node2   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 访问 pod</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.244.2.48</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>postStart<span class=\"token punctuation\">...</span></pre></td></tr></table></figure><h5 id=\"534-容器探测\"><a class=\"anchor\" href=\"#534-容器探测\">#</a> 5.3.4 容器探测</h5>\n<p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么 kubernetes 就会把该问题实例 &quot;摘除&quot;，不承担业务流量。kubernetes 提供了两种探针来实现容器探测，分别是：</p>\n<ul>\n<li>liveness probes：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s 会重启容器</li>\n<li>readiness probes：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s 不会转发流量</li>\n</ul>\n<blockquote>\n<p>livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</p>\n</blockquote>\n<p>上面两种探针目前均支持三种探测方式：</p>\n<ul>\n<li>\n<p>Exec 命令：在容器内执行一次命令，如果命令执行的退出码为 0，则认为程序正常，否则不正常</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token punctuation\">-</span> cat</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">-</span> /tmp/healthy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>……</pre></td></tr></table></figure></li>\n<li>\n<p>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>……      </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>……</pre></td></tr></table></figure></li>\n<li>\n<p>HTTPGet：调用容器内 Web 应用的 URL，如果返回的状态码在 200 和 399 之间，则认为程序正常，否则不正常</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> / <span class=\"token comment\">#URI 地址</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span> <span class=\"token comment\">#端口号</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 127.0.0.1 <span class=\"token comment\">#主机地址</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP <span class=\"token comment\">#支持的协议，http 或者 https</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>……</pre></td></tr></table></figure></li>\n</ul>\n<p>下面以 liveness probes 为例，做几个演示：</p>\n<p><strong>方式一：Exec</strong></p>\n<p>创建 pod-liveness-exec.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>exec</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/cat\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"/tmp/hello.txt\"</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 执行一个查看文件的命令</span></pre></td></tr></table></figure><p>创建 pod，观察效果</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-liveness-exec.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>exec created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pods pod-liveness-exec -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Normal   Created    20s (x2 over 50s)  kubelet<span class=\"token punctuation\">,</span> node1     Created container nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Normal   Started    20s (x2 over 50s)  kubelet<span class=\"token punctuation\">,</span> node1     Started container nginx</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Normal   Killing    20s                kubelet<span class=\"token punctuation\">,</span> node1     Container nginx failed liveness probe<span class=\"token punctuation\">,</span> will be restarted</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Warning  Unhealthy  0s (x5 over 40s)   kubelet<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">node1     Liveness probe failed</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">cat</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">can't open '/tmp/hello11.txt'</span><span class=\"token punctuation\">:</span> No such file or directory</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 观察上面的信息就会发现 nginx 容器启动之后就进行了健康检查</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 检查失败之后，容器被 kill 掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 稍等一会之后，再观察 pod 信息，就可以看到 RESTARTS 不再是 0，而是一直增长</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-liveness-exec -n dev</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME                READY   STATUS             RESTARTS   AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>exec   0/1     CrashLoopBackOff   2          3m19s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 当然接下来，可以修改成一个存在的文件，比如 /tmp/hello.txt，再试，结果就正常了......</span></pre></td></tr></table></figure><p><strong>方式二：TCPSocket</strong></p>\n<p>创建 pod-liveness-tcpsocket.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>tcpsocket</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span> <span class=\"token comment\"># 尝试访问 8080 端口</span></pre></td></tr></table></figure><p>创建 pod，观察效果</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-liveness-tcpsocket.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>tcpsocket created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pods pod-liveness-tcpsocket -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Normal   Scheduled  31s                            default<span class=\"token punctuation\">-</span>scheduler  Successfully assigned dev/pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>tcpsocket to node2</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Normal   Pulled     &lt;invalid<span class=\"token punctuation\">></span>                      kubelet<span class=\"token punctuation\">,</span> node2     Container image \"nginx<span class=\"token punctuation\">:</span>1.17.1\" already present on machine</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Normal   Created    &lt;invalid<span class=\"token punctuation\">></span>                      kubelet<span class=\"token punctuation\">,</span> node2     Created container nginx</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Normal   Started    &lt;invalid<span class=\"token punctuation\">></span>                      kubelet<span class=\"token punctuation\">,</span> node2     Started container nginx</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Warning  Unhealthy  &lt;invalid<span class=\"token punctuation\">></span> (x2 over &lt;invalid<span class=\"token punctuation\">></span>)  kubelet<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">node2     Liveness probe failed</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">dial tcp 10.244.2.44:8080</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">connect</span><span class=\"token punctuation\">:</span> connection refused</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 观察上面的信息，发现尝试访问 8080 端口，但是失败了</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 稍等一会之后，再观察 pod 信息，就可以看到 RESTARTS 不再是 0，而是一直增长</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-liveness-tcpsocket  -n dev</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME                     READY   STATUS             RESTARTS   AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>tcpsocket   0/1     CrashLoopBackOff   2          3m19s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 当然接下来，可以修改成一个可以访问的端口，比如 80，再试，结果就正常了......</span></pre></td></tr></table></figure><p><strong>方式三：HTTPGet</strong></p>\n<p>创建 pod-liveness-httpget.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>httpget</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 其实就是访问 http://127.0.0.1:80/hello  </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP <span class=\"token comment\">#支持的协议，http 或者 https</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span> <span class=\"token comment\">#端口号</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /hello <span class=\"token comment\">#URI 地址</span></pre></td></tr></table></figure><p>创建 pod，观察效果</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-liveness-httpget.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>httpget created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod 详情</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pod pod-liveness-httpget -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Normal   Pulled     6s (x3 over 64s)  kubelet<span class=\"token punctuation\">,</span> node1     Container image \"nginx<span class=\"token punctuation\">:</span>1.17.1\" already present on machine</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Normal   Created    6s (x3 over 64s)  kubelet<span class=\"token punctuation\">,</span> node1     Created container nginx</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Normal   Started    6s (x3 over 63s)  kubelet<span class=\"token punctuation\">,</span> node1     Started container nginx</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Warning  Unhealthy  6s (x6 over 56s)  kubelet<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">node1     Liveness probe failed</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">HTTP probe failed with statuscode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">404</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Normal   Killing    6s (x2 over 36s)  kubelet<span class=\"token punctuation\">,</span> node1     Container nginx failed liveness probe<span class=\"token punctuation\">,</span> will be restarted</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 观察上面信息，尝试访问路径，但是未找到，出现 404 错误</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 稍等一会之后，再观察 pod 信息，就可以看到 RESTARTS 不再是 0，而是一直增长</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod pod-liveness-httpget -n dev</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME                   READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>httpget   1/1     Running   5          3m17s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 当然接下来，可以修改成一个可以访问的路径 path，比如 /，再试，结果就正常了......</span></pre></td></tr></table></figure><p>至此，已经使用 liveness Probe 演示了三种探测方式，但是查看 livenessProbe 的子属性，会发现除了这三种方式，还有一些其他的配置，在这里一并解释下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl explain pod.spec.containers.livenessProbe</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">FIELDS</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   exec &lt;Object<span class=\"token punctuation\">></span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   tcpSocket    &lt;Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   httpGet      &lt;Object<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   initialDelaySeconds  &lt;integer<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 容器启动后等待多少秒执行第一次探测</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   timeoutSeconds       &lt;integer<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 探测超时时间。默认 1 秒，最小 1 秒</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   periodSeconds        &lt;integer<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 执行探测的频率。默认是 10 秒，最小 1 秒</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   failureThreshold     &lt;integer<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 连续探测失败多少次才被认定为失败。默认是 3。最小值是 1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   successThreshold     &lt;integer<span class=\"token punctuation\">></span>  <span class=\"token comment\"># 连续探测成功多少次才被认定为成功。默认是 1</span></pre></td></tr></table></figure><p>下面稍微配置两个，演示下效果即可：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># more pod-liveness-httpget.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>liveness<span class=\"token punctuation\">-</span>httpget</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span> <span class=\"token comment\"># 容器启动后 30s 开始探测</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># 探测超时时间为 5s</span></pre></td></tr></table></figure><h5 id=\"535-重启策略\"><a class=\"anchor\" href=\"#535-重启策略\">#</a> 5.3.5 重启策略</h5>\n<p>在上一节中，一旦容器探测出现了问题，kubernetes 就会对容器所在的 Pod 进行重启，其实这是由 pod 的重启策略决定的，pod 的重启策略有 3 种，分别如下：</p>\n<ul>\n<li>Always ：容器失效时，自动重启该容器，这也是默认值。</li>\n<li>OnFailure ： 容器终止运行且退出码不为 0 时重启</li>\n<li>Never ： 不论状态为何，都不重启该容器</li>\n</ul>\n<p>重启策略适用于 pod 对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由 kubelet 延迟一段时间后进行，且反复的重启操作的延迟时长以此为 10s、20s、40s、80s、160s 和 300s，300s 是最大延迟时长。</p>\n<p>创建 pod-restartpolicy.yaml：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>restartpolicy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>port</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /hello</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never <span class=\"token comment\"># 设置重启策略为 Never</span></pre></td></tr></table></figure><p>运行 Pod 测试</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-restartpolicy.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>restartpolicy created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod 详情，发现 nginx 容器失败</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  describe pods pod-restartpolicy  -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Warning  Unhealthy  15s (x3 over 35s)  kubelet<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">node1     Liveness probe failed</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">HTTP probe failed with statuscode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">404</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Normal   Killing    15s                kubelet<span class=\"token punctuation\">,</span> node1     Container nginx failed liveness probe</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 多等一会，再观察 pod 的重启次数，发现一直是 0，并未重启   </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  get pods pod-restartpolicy -n dev</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>NAME                   READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pod<span class=\"token punctuation\">-</span>restartpolicy      0/1     Running   0          5min42s</pre></td></tr></table></figure><h4 id=\"54-pod调度\"><a class=\"anchor\" href=\"#54-pod调度\">#</a> 5.4 Pod 调度</h4>\n<p>在默认情况下，一个 Pod 在哪个 Node 节点上运行，是由 Scheduler 组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些 Pod 到达某些节点上，那么应该怎么做呢？这就要求了解 kubernetes 对 Pod 的调度规则，kubernetes 提供了四大类调度方式：</p>\n<ul>\n<li>自动调度：运行在哪个节点上完全由 Scheduler 经过一系列的算法计算得出</li>\n<li>定向调度：NodeName、NodeSelector</li>\n<li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li>\n<li>污点（容忍）调度：Taints、Toleration</li>\n</ul>\n<h5 id=\"541-定向调度\"><a class=\"anchor\" href=\"#541-定向调度\">#</a> 5.4.1 定向调度</h5>\n<p>定向调度，指的是利用在 pod 上声明 nodeName 或者 nodeSelector，以此将 Pod 调度到期望的 node 节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标 Node 不存在，也会向上面进行调度，只不过 pod 运行失败而已。</p>\n<p><strong>NodeName</strong></p>\n<p>NodeName 用于强制约束将 Pod 调度到指定的 Name 的 Node 节点上。这种方式，其实是直接跳过 Scheduler 的调度逻辑，直接将 Pod 调度到指定名称的节点。</p>\n<p>接下来，实验一下：创建一个 pod-nodename.yaml 文件</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>nodename</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">nodeName</span><span class=\"token punctuation\">:</span> node1 <span class=\"token comment\"># 指定调度到 node1 节点上</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-nodename.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>nodename created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#查看 Pod 调度到 NODE 属性，确实是调度到了 node1 节点上</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-nodename -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod<span class=\"token punctuation\">-</span>nodename   1/1     Running   0          56s   10.244.1.87   node1     <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span>   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 接下来，删除 pod，修改 nodeName 的值为 node3（并没有 node3 节点）</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f pod-nodename.yaml</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pod \"pod<span class=\"token punctuation\">-</span>nodename\" deleted</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim pod-nodename.yaml</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-nodename.yaml</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>nodename created</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#再次查看，发现已经向 Node3 节点调度，但是由于不存在 node3 节点，所以 pod 无法正常运行</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-nodename -n dev -o wide</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pod<span class=\"token punctuation\">-</span>nodename   0/1     Pending   0          6s    &lt;none<span class=\"token punctuation\">></span>   node3   <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr></table></figure><p><strong>NodeSelector</strong></p>\n<p>NodeSelector 用于将 pod 调度到添加了指定标签的 node 节点上。它是通过 kubernetes 的 label-selector 机制实现的，也就是说，在 pod 创建之前，会由 scheduler 使用 MatchNodeSelector 调度策略进行 label 匹配，找出目标 node，然后将 pod 调度到目标节点，该匹配规则是强制约束。</p>\n<p>接下来，实验一下：</p>\n<p>1 首先分别为 node 节点添加标签</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes node1 nodeenv=pro</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>node/node2 labeled</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes node2 nodeenv=test</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>node/node2 labeled</pre></td></tr></table></figure><p>2 创建一个 pod-nodeselector.yaml 文件，并使用它创建 Pod</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>nodeselector</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">nodeenv</span><span class=\"token punctuation\">:</span> pro <span class=\"token comment\"># 指定调度到具有 nodeenv=pro 标签的节点上</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>nodeselector created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#查看 Pod 调度到 NODE 属性，确实是调度到了 node1 节点上</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-nodeselector -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod<span class=\"token punctuation\">-</span>nodeselector   1/1     Running   0          47s   10.244.1.87   node1   <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 接下来，删除 pod，修改 nodeSelector 的值为 nodeenv: xxxx（不存在打有此标签的节点）</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pod \"pod<span class=\"token punctuation\">-</span>nodeselector\" deleted</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-nodeselector.yaml</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>nodeselector created</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#再次查看，发现 pod 无法正常运行，Node 的值为 none</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>NAME               READY   STATUS    RESTARTS   AGE     IP       NODE    </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pod<span class=\"token punctuation\">-</span>nodeselector   0/1     Pending   0          2m20s   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 查看详情，发现 node selector 匹配失败的提示</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pods pod-nodeselector -n dev</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span>.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key atrule\">Events</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  Type     Reason            Age        From               Message</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>     <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span>            <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>       <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>               <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token key atrule\">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class=\"token punctuation\">:</span> 3 node(s) didn't match node selector.</pre></td></tr></table></figure><h5 id=\"542-亲和性调度\"><a class=\"anchor\" href=\"#542-亲和性调度\">#</a> 5.4.2 亲和性调度</h5>\n<p>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的 Node，那么 Pod 将不会被运行，即使在集群中还有可用 Node 列表也不行，这就限制了它的使用场景。</p>\n<p>基于上面的问题，kubernetes 还提供了一种亲和性调度（Affinity）。它在 NodeSelector 的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的 Node 进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</p>\n<p>Affinity 主要分为三类：</p>\n<ul>\n<li>nodeAffinity (node 亲和性）: 以 node 为目标，解决 pod 可以调度到哪些 node 的问题</li>\n<li>podAffinity (pod 亲和性) : 以 pod 为目标，解决 pod 可以和哪些已存在的 pod 部署在同一个拓扑域中的问题</li>\n<li>podAntiAffinity (pod 反亲和性) : 以 pod 为目标，解决 pod 不能和哪些已存在 pod 部署在同一个拓扑域中的问题</li>\n</ul>\n<blockquote>\n<p>关于亲和性 (反亲和性) 使用场景的说明：</p>\n<p><strong>亲和性</strong>：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</p>\n<p><strong>反亲和性</strong>：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个 node 上，这样可以提高服务的高可用性。</p>\n</blockquote>\n<p><strong>NodeAffinity</strong></p>\n<p>首先来看一下 <code>NodeAffinity</code>  的可配置项：</p>\n<figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pod.spec.affinity.nodeAffinity</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  requiredDuringSchedulingIgnoredDuringExecution  Node节点必须满足指定的所有规则才可以，相当于硬限制</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    nodeSelectorTerms  节点选择列表</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      matchFields   按节点字段列出的节点选择器要求列表</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        key    键</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        values 值</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        operat or 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 (倾向)</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    preference   一个节点选择器项，与相应的权重相关联</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      matchFields   按节点字段列出的节点选择器要求列表</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        key    键</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        values 值</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        operator 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tweight 倾向权重，在范围1-100。</pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">关系符的使用说明</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> nodeenv              <span class=\"token comment\"># 匹配存在标签的 key 为 nodeenv 的节点</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> Exists</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> nodeenv              <span class=\"token comment\"># 匹配标签的 key 为 nodeenv, 且 value 是 \"xxx\" 或 \"yyy\" 的节点</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"xxx\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"yyy\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> nodeenv              <span class=\"token comment\"># 匹配标签的 key 为 nodeenv, 且 value 大于 \"xxx\" 的节点</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> Gt</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"xxx\"</span></pre></td></tr></table></figure><p>接下来首先演示一下 <code>requiredDuringSchedulingIgnoredDuringExecution</code>  ,</p>\n<p>创建 pod-nodeaffinity-required.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>required</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#亲和性设置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">nodeAffinity</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#设置 node 亲和性</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 硬限制</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token key atrule\">nodeSelectorTerms</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 匹配 env 的值在 [\"xxx\",\"yyy\"] 中的标签</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> nodeenv</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"xxx\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"yyy\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>required created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod 状态 （运行失败）</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>required   0/1     Pending   0          16s   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>  <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看 Pod 的详情</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 发现调度失败，提示 node 选择失败</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pod pod-nodeaffinity-required -n dev</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class=\"token punctuation\">:</span> 3 node(s) didn't match node selector.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class=\"token punctuation\">:</span> 3 node(s) didn't match node selector.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#接下来，停止 pod</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pod \"pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>required\" deleted</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 修改文件，将 values: [\"xxx\",\"yyy\"]------> [\"pro\",\"yyy\"]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># 再次启动</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-nodeaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>required created</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 此时查看，发现调度成功，已经将 pod 调度到了 node1 上</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>required   1/1     Running   0          11s   10.244.1.89   node1 <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr></table></figure><p>接下来再演示一下 <code>requiredDuringSchedulingIgnoredDuringExecution</code>  ,</p>\n<p>创建 pod-nodeaffinity-preferred.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>preferred</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#亲和性设置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">nodeAffinity</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#设置 node 亲和性</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">preferredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 软限制</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">preference</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 匹配 env 的值在 [\"xxx\",\"yyy\"] 中的标签 (当前环境没有)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> nodeenv</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"xxx\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"yyy\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-nodeaffinity-preferred.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>preferred created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod 状态 （运行成功）</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod pod-nodeaffinity-preferred -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                         READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod<span class=\"token punctuation\">-</span>nodeaffinity<span class=\"token punctuation\">-</span>preferred   1/1     Running   0          40s</pre></td></tr></table></figure><pre><code>NodeAffinity规则设置的注意事项：\n    1 如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上\n    2 如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可\n    3 如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功\n    4 如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化\n</code></pre>\n<p><strong>PodAffinity</strong></p>\n<p>PodAffinity 主要实现以运行的 Pod 为参照，实现让新创建的 Pod 跟参照 pod 在一个区域的功能。</p>\n<p>首先来看一下 <code>PodAffinity</code>  的可配置项：</p>\n<figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pod.spec.affinity.podAffinity</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  requiredDuringSchedulingIgnoredDuringExecution  硬限制</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    namespaces       指定参照pod的namespace</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    topologyKey      指定调度作用域</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    labelSelector    标签选择器</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      matchExpressions  按节点标签列出的节点选择器要求列表(推荐)</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        key    键</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        values 值</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        operator 关系符 支持In, NotIn, Exists, DoesNotExist.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      matchLabels    指多个matchExpressions映射的内容</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  preferredDuringSchedulingIgnoredDuringExecution 软限制</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    podAffinityTerm  选项</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      namespaces      </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      topologyKey</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labelSelector</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        matchExpressions  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          key    键</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          values 值</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          operator</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        matchLabels </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    weight 倾向权重，在范围1-100</pre></td></tr></table></figure><figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>topologyKey用于指定调度时作用域,例如:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</pre></td></tr></table></figure><p>接下来，演示下 <code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p>\n<p>1）首先创建一个参照 Pod，pod-podaffinity-target.yaml：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>podaffinity<span class=\"token punctuation\">-</span>target</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">podenv</span><span class=\"token punctuation\">:</span> pro <span class=\"token comment\">#设置标签</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">nodeName</span><span class=\"token punctuation\">:</span> node1 <span class=\"token comment\"># 将目标 pod 名确指定到 node1 上</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 启动目标 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-podaffinity-target.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod-podaffinity-target created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod 状况</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods  pod-podaffinity-target -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                     READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod-podaffinity-target   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s</pre></td></tr></table></figure><p>2）创建 pod-podaffinity-required.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>podaffinity<span class=\"token punctuation\">-</span>required</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#亲和性设置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">podAffinity</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#设置 pod 亲和性</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 硬限制</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 匹配 env 的值在 [\"xxx\",\"yyy\"] 中的标签</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> podenv</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"xxx\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"yyy\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> kubernetes.io/hostname</pre></td></tr></table></figure><p>上面配置表达的意思是：新 Pod 必须要与拥有标签 nodeenv=xxx 或者 nodeenv=yyy 的 pod 在同一 Node 上，显然现在没有这样 pod，接下来，运行测试一下。</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 启动 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>podaffinity<span class=\"token punctuation\">-</span>required created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod 状态，发现未运行</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-podaffinity-required -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod<span class=\"token punctuation\">-</span>podaffinity<span class=\"token punctuation\">-</span>required   0/1     Pending   0          9s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看详细信息</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pods pod-podaffinity-required  -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key atrule\">Events</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  Type     Reason            Age        From               Message</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>     <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span>            <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>       <span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span>               <span class=\"token punctuation\">---</span><span class=\"token punctuation\">---</span><span class=\"token punctuation\">-</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token key atrule\">Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available</span><span class=\"token punctuation\">:</span> 2 node(s) didn't match pod affinity rules<span class=\"token punctuation\">,</span> 1 node(s) had taints that the pod didn't tolerate.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 接下来修改  values: [\"xxx\",\"yyy\"]----->values:[\"pro\",\"yyy\"]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 意思是：新 Pod 必须要与拥有标签 nodeenv=xxx 或者 nodeenv=yyy 的 pod 在同一 Node 上</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 然后重新创建 pod，查看效果</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f  pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pod \"pod<span class=\"token punctuation\">-</span>podaffinity<span class=\"token punctuation\">-</span>required\" de leted</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-podaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>podaffinity<span class=\"token punctuation\">-</span>required created</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 发现此时 Pod 运行正常</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-podaffinity-required -n dev</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>NAME                       READY   STATUS    RESTARTS   AGE   LABELS</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pod<span class=\"token punctuation\">-</span>podaffinity<span class=\"token punctuation\">-</span>required   1/1     Running   0          6s    &lt;none<span class=\"token punctuation\">></span></pre></td></tr></table></figure><p>关于 <code>PodAffinity</code>  的  <code>preferredDuringSchedulingIgnoredDuringExecution</code> ，这里不再演示。</p>\n<p><strong>PodAntiAffinity</strong></p>\n<p>PodAntiAffinity 主要实现以运行的 Pod 为参照，让新创建的 Pod 跟参照 pod 不在一个区域中的功能。</p>\n<p>它的配置方式和选项跟 PodAffinty 是一样的，这里不再做详细解释，直接做一个测试案例。</p>\n<p>1）继续使用上个案例中目标 pod</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide --show-labels</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod-podaffinity-required <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m29s   <span class=\"token number\">10.244</span>.1.38   node1   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>     </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pod-podaffinity-target   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m25s   <span class=\"token number\">10.244</span>.1.37   node1   <span class=\"token assign-left variable\">podenv</span><span class=\"token operator\">=</span>pro</pre></td></tr></table></figure><p>2）创建 pod-podantiaffinity-required.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>podantiaffinity<span class=\"token punctuation\">-</span>required</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#亲和性设置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">podAntiAffinity</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#设置 pod 亲和性</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 硬限制</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 匹配 podenv 的值在 [\"pro\"] 中的标签</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> podenv</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"pro\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> kubernetes.io/hostname</pre></td></tr></table></figure><p>上面配置表达的意思是：新 Pod 必须要与拥有标签 nodeenv=pro 的 pod 不在同一 Node 上，运行测试一下。</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-podantiaffinity-required.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod<span class=\"token punctuation\">-</span>podantiaffinity<span class=\"token punctuation\">-</span>required created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 发现调度到了 node2 上</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods pod-podantiaffinity-required -n dev -o wide</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   .. </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pod<span class=\"token punctuation\">-</span>podantiaffinity<span class=\"token punctuation\">-</span>required   1/1     Running   0          30s   10.244.1.96   node2  ..</pre></td></tr></table></figure><h5 id=\"543-污点和容忍\"><a class=\"anchor\" href=\"#543-污点和容忍\">#</a> 5.4.3 污点和容忍</h5>\n<p><strong>污点（Taints）</strong></p>\n<p>前面的调度方式都是站在 Pod 的角度上，通过在 Pod 上添加属性，来确定 Pod 是否要调度到指定的 Node 上，其实我们也可以站在 Node 的角度上，通过在 Node 上添加<strong>污点</strong>属性，来决定是否允许 Pod 调度过来。</p>\n<p>Node 被设置上污点之后就和 Pod 之间存在了一种相斥的关系，进而拒绝 Pod 调度进来，甚至可以将已经存在的 Pod 驱逐出去。</p>\n<p>污点的格式为： <code>key=value:effect</code> , key 和 value 是污点的标签，effect 描述污点的作用，支持如下三个选项：</p>\n<ul>\n<li>PreferNoSchedule：kubernetes 将尽量避免把 Pod 调度到具有该污点的 Node 上，除非没有其他节点可调度</li>\n<li>NoSchedule：kubernetes 将不会把 Pod 调度到具有该污点的 Node 上，但不会影响当前 Node 上已存在的 Pod</li>\n<li>NoExecute：kubernetes 将不会把 Pod 调度到具有该污点的 Node 上，同时也会将 Node 上已存在的 Pod 驱离</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200605021831545.png\" alt=\"image-20200605021606508\" /></p>\n<p>使用 kubectl 设置和去除污点的命令示例如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 设置污点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl taint nodes node1 <span class=\"token assign-left variable\">key</span><span class=\"token operator\">=</span>value:effect</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 去除污点</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kubectl taint nodes node1 key:effect-</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 去除所有污点</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kubectl taint nodes node1 key-</pre></td></tr></table></figure><p>接下来，演示下污点的效果：</p>\n<ol>\n<li>准备节点 node1（为了演示效果更加明显，暂时停止 node2 节点）</li>\n<li>为 node1 节点设置一个污点:  <code>tag=heima:PreferNoSchedule</code> ；然后创建 pod1 (pod1 可以)</li>\n<li>修改为 node1 节点设置一个污点:  <code>tag=heima:NoSchedule</code> ；然后创建 pod2 (pod1 正常 pod2 失败)</li>\n<li>修改为 node1 节点设置一个污点:  <code>tag=heima:NoExecute</code> ；然后创建 pod3 (3 个 pod 都失败)</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 为 node1 设置污点 (PreferNoSchedule)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl taint nodes node1 tag=heima:PreferNoSchedule</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 创建 pod1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl run taint1 --image=nginx:1.17.1 -n dev</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE   </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>taint1<span class=\"token punctuation\">-</span>7665f7fd85<span class=\"token punctuation\">-</span>574h4   1/1     Running   0          2m24s   10.244.1.59   node1    </pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 为 node1 设置污点 (取消 PreferNoSchedule，设置 NoSchedule)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl taint nodes node1 tag:PreferNoSchedule-</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl taint nodes node1 tag=heima:NoSchedule</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 创建 pod2</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl run taint2 --image=nginx:1.17.1 -n dev</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods taint2 -n dev -o wide</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>taint1<span class=\"token punctuation\">-</span>7665f7fd85<span class=\"token punctuation\">-</span>574h4   1/1     Running   0          2m24s   10.244.1.59   node1 </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>taint2<span class=\"token punctuation\">-</span>544694789<span class=\"token punctuation\">-</span>6zmlf    0/1     Pending   0          21s     &lt;none<span class=\"token punctuation\">></span>        &lt;none<span class=\"token punctuation\">></span>   </pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 为 node1 设置污点 (取消 NoSchedule，设置 NoExecute)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl taint nodes node1 tag:NoSchedule-</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl taint nodes node1 tag=heima:NoExecute</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># 创建 pod3</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl run taint3 --image=nginx:1.17.1 -n dev</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>taint1<span class=\"token punctuation\">-</span>7665f7fd85<span class=\"token punctuation\">-</span>htkmp   0/1     Pending   0          35s   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>    </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>taint2<span class=\"token punctuation\">-</span>544694789<span class=\"token punctuation\">-</span>bn7wb    0/1     Pending   0          35s   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>     </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>taint3<span class=\"token punctuation\">-</span>6d78dbd749<span class=\"token punctuation\">-</span>tktkq   0/1     Pending   0          6s    &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span></pre></td></tr></table></figure><pre><code>小提示：\n    使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记,所以pod就不会调度到master节点上.\n</code></pre>\n<p><strong>容忍（Toleration）</strong></p>\n<p>上面介绍了污点的作用，我们可以在 node 上添加污点用于拒绝 pod 调度上来，但是如果就是想将一个 pod 调度到一个有污点的 node 上去，这时候应该怎么做呢？这就要使用到<strong>容忍</strong>。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200514095913741.png\" alt=\"image-20200514095913741\" /></p>\n<blockquote>\n<p>污点就是拒绝，容忍就是忽略，Node 通过污点拒绝 pod 调度上去，Pod 通过容忍忽略拒绝</p>\n</blockquote>\n<p>下面先通过一个案例看下效果：</p>\n<ol>\n<li>上一小节，已经在 node1 节点上打上了 <code>NoExecute</code>  的污点，此时 pod 是调度不上去的</li>\n<li>本小节，可以通过给 pod 添加容忍，然后将其调度上去</li>\n</ol>\n<p>创建 pod-toleration.yaml, 内容如下</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>toleration</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">tolerations</span><span class=\"token punctuation\">:</span>      <span class=\"token comment\"># 添加容忍</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"tag\"</span>        <span class=\"token comment\"># 要容忍的污点的 key</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Equal\"</span> <span class=\"token comment\"># 操作符</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"heima\"</span>    <span class=\"token comment\"># 容忍的污点的 value</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">effect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"NoExecute\"</span>   <span class=\"token comment\"># 添加容忍的规则，这里必须和标记的污点规则相同</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加容忍之前的 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pod<span class=\"token punctuation\">-</span>toleration   0/1     Pending   0          3s    &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>   &lt;none<span class=\"token punctuation\">></span>           </pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 添加容忍之后的 pod</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pod<span class=\"token punctuation\">-</span>toleration   1/1     Running   0          3s    10.244.1.62   node1   &lt;none<span class=\"token punctuation\">></span></pre></td></tr></table></figure><p>下面看一下容忍的详细配置:</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s<span class=\"token punctuation\">-</span>master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl explain pod.spec.tolerations</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">FIELDS</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   key       <span class=\"token comment\"># 对应着要容忍的污点的键，空意味着匹配所有的键</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   value     <span class=\"token comment\"># 对应着要容忍的污点的值</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   operator  <span class=\"token comment\"># key-value 的运算符，支持 Equal 和 Exists（默认）</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   effect    <span class=\"token comment\"># 对应污点的 effect，空意味着匹配所有影响</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   tolerationSeconds   <span class=\"token comment\"># 容忍时间，当 effect 为 NoExecute 时生效，表示 pod 在 Node 上的停留时间</span></pre></td></tr></table></figure><h3 id=\"6-pod控制器详解\"><a class=\"anchor\" href=\"#6-pod控制器详解\">#</a> 6. Pod 控制器详解</h3>\n<h4 id=\"61-pod控制器介绍\"><a class=\"anchor\" href=\"#61-pod控制器介绍\">#</a> 6.1 Pod 控制器介绍</h4>\n<p>Pod 是 kubernetes 的最小管理单元，在 kubernetes 中，按照 pod 的创建方式可以将其分为两类：</p>\n<ul>\n<li>自主式 pod：kubernetes 直接创建出来的 Pod，这种 pod 删除后就没有了，也不会重建</li>\n<li>控制器创建的 pod：kubernetes 通过控制器创建的 pod，这种 pod 删除了之后还会自动重建</li>\n</ul>\n<blockquote>\n<p><strong> <code>什么是Pod控制器</code> </strong></p>\n<p>Pod 控制器是管理 pod 的中间层，使用 Pod 控制器之后，只需要告诉 Pod 控制器，想要多少个什么样的 Pod 就可以了，它会创建出满足条件的 Pod 并确保每一个 Pod 资源处于用户期望的目标状态。如果 Pod 资源在运行中出现故障，它会基于指定策略重新编排 Pod。</p>\n</blockquote>\n<p>在 kubernetes 中，有很多类型的 pod 控制器，每种都有自己的适合的场景，常见的有下面这些：</p>\n<ul>\n<li>ReplicationController：比较原始的 pod 控制器，已经被废弃，由 ReplicaSet 替代</li>\n<li>ReplicaSet：保证副本数量一直维持在期望值，并支持 pod 数量扩缩容，镜像版本升级</li>\n<li>Deployment：通过控制 ReplicaSet 来控制 Pod，并支持滚动升级、回退版本</li>\n<li>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整 Pod 的数量，实现削峰填谷</li>\n<li>DaemonSet：在集群中的指定 Node 上运行且仅运行一个副本，一般用于守护进程类的任务</li>\n<li>Job：它创建出来的 pod 只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</li>\n<li>Cronjob：它创建的 Pod 负责周期性任务控制，不需要持续后台运行</li>\n<li>StatefulSet：管理有状态应用</li>\n</ul>\n<h4 id=\"62-replicasetrs\"><a class=\"anchor\" href=\"#62-replicasetrs\">#</a> 6.2 ReplicaSet(RS)</h4>\n<p>ReplicaSet 的主要作用是<strong>保证一定数量的 pod 正常运行</strong>，它会持续监听这些 Pod 的运行状态，一旦 Pod 发生故障，就会重启或重建。同时它还支持对 pod 数量的扩缩容和镜像版本的升降级。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200612005334159.png\" alt=\"img\" /></p>\n<p>ReplicaSet 的资源清单文件：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1 <span class=\"token comment\"># 版本号</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ReplicaSet <span class=\"token comment\"># 类型       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 元数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># rs 名称 </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 所属命名空间 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#标签</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span> rs</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 详情描述</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\"># 副本数量</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>      <span class=\"token comment\"># Labels 匹配规则</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">&#123;</span><span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>nginx<span class=\"token punctuation\">-</span>pod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr></table></figure><p>在这里面，需要新了解的配置项就是 <code>spec</code>  下面几个选项：</p>\n<ul>\n<li>\n<p>replicas：指定副本数量，其实就是当前 rs 创建出来的 pod 的数量，默认为 1</p>\n</li>\n<li>\n<p>selector：选择器，它的作用是建立 pod 控制器和 pod 之间的关联关系，采用的 Label Selector 机制</p>\n<p>在 pod 模板上定义 label，在控制器上定义选择器，就可以表明当前控制器能管理哪些 pod 了</p>\n</li>\n<li>\n<p>template：模板，就是当前控制器创建 pod 所使用的模板板，里面其实就是前一章学过的 pod 的定义</p>\n</li>\n</ul>\n<p><strong>创建 ReplicaSet</strong></p>\n<p>创建 pc-replicaset.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ReplicaSet   </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pc<span class=\"token punctuation\">-</span>replicaset</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 rs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pc-replicaset.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>replicaset.apps/pc-replicaset created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 rs</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># DESIRED: 期望副本数量  </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># CURRENT: 当前副本数量  </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># READY: 已经准备好提供服务的副本数量</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs pc-replicaset -n dev -o wide</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>pc-replicaset <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       <span class=\"token number\">3</span>     22s   nginx        nginx:1.17.1       <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 查看当前控制器创建出来的 pod</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 这里发现控制器创建出来的 pod 的名称是在控制器名称后面拼接了 - xxxxx 随机码</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n dev</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>NAME                          READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>pc-replicaset-6vmvt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          54s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pc-replicaset-fmb8f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          54s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pc-replicaset-snrk2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          54s</pre></td></tr></table></figure><p><strong>扩缩容</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 编辑 rs 的副本数量，修改 spec:replicas: 6 即可</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit rs pc-replicaset -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>replicaset.apps/pc-replicaset edited</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                          READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-replicaset-6vmvt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          114m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pc-replicaset-cftnp   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pc-replicaset-fjlm6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10s</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>pc-replicaset-fmb8f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          114m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pc-replicaset-s2whj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10s</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pc-replicaset-snrk2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          114m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 当然也可以直接使用命令实现</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 使用 scale 命令实现扩缩容， 后面 --replicas=n 直接指定目标数量即可</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>replicaset.apps/pc-replicaset scaled</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 命令运行完毕，立即查看，发现已经有 4 个开始准备退出了</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>NAME                       READY   STATUS        RESTARTS   AGE</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pc-replicaset-6vmvt   <span class=\"token number\">0</span>/1     Terminating   <span class=\"token number\">0</span>          118m</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pc-replicaset-cftnp   <span class=\"token number\">0</span>/1     Terminating   <span class=\"token number\">0</span>          4m17s</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>pc-replicaset-fjlm6   <span class=\"token number\">0</span>/1     Terminating   <span class=\"token number\">0</span>          4m17s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pc-replicaset-fmb8f   <span class=\"token number\">1</span>/1     Running       <span class=\"token number\">0</span>          118m</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pc-replicaset-s2whj   <span class=\"token number\">0</span>/1     Terminating   <span class=\"token number\">0</span>          4m17s</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>pc-replicaset-snrk2   <span class=\"token number\">1</span>/1     Running       <span class=\"token number\">0</span>          118m</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#稍等片刻，就只剩下 2 个了</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NAME                       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>pc-replicaset-fmb8f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          119m</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>pc-replicaset-snrk2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          119m</pre></td></tr></table></figure><p><strong>镜像升级</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 编辑 rs 的容器镜像 - image: nginx:1.17.2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit rs pc-replicaset -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>replicaset.apps/pc-replicaset edited</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 再次查看，发现镜像版本已经变更了</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-replicaset       <span class=\"token number\">2</span>        <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       140m   nginx         nginx:1.17.2  <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 同样的道理，也可以使用命令完成这个工作</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># kubectl set image rs rs 名称 容器 = 镜像版本 -n namespace</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>replicaset.apps/pc-replicaset image updated</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 再次查看，发现镜像版本已经变更了</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pc-replicaset        <span class=\"token number\">2</span>        <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       145m   nginx        nginx:1.17.1 <span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p><strong>删除 ReplicaSet</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 使用 kubectl delete 命令会删除此 RS 以及它管理的 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 在 kubernetes 删除 RS 前，会将 RS 的 replicasclear 调整为 0，等待所有的 Pod 被删除后，在执行 RS 对象的删除</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete rs pc-replicaset -n dev</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>replicaset.apps <span class=\"token string\">\"pc-replicaset\"</span> deleted</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n dev -o wide</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>No resources found <span class=\"token keyword\">in</span> dev namespace.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 如果希望仅仅删除 RS 对象（保留 Pod），可以使用 kubectl delete 命令时添加 --cascade=false 选项（不推荐）。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete rs pc-replicaset -n dev --cascade=false</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>replicaset.apps <span class=\"token string\">\"pc-replicaset\"</span> deleted</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pc-replicaset-cl82j   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          75s</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-replicaset-dslhb   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          75s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 也可以使用 yaml 直接删除 (推荐)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f pc-replicaset.yaml</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>replicaset.apps <span class=\"token string\">\"pc-replicaset\"</span> deleted</pre></td></tr></table></figure><h4 id=\"63-deploymentdeploy\"><a class=\"anchor\" href=\"#63-deploymentdeploy\">#</a> 6.3 Deployment(Deploy)</h4>\n<p>为了更好的解决服务编排的问题，kubernetes 在 V1.2 版本开始，引入了 Deployment 控制器。值得一提的是，这种控制器并不直接管理 pod，而是通过管理 ReplicaSet 来简介管理 Pod，即：Deployment 管理 ReplicaSet，ReplicaSet 管理 Pod。所以 Deployment 比 ReplicaSet 功能更加强大。</p>\n<p>为了更好的解决服务编排的问题，kubernetes 在 V1.2 版本开始，引入了 Deployment 控制器。值得一提的是，这种控制器并不直接管理 pod，而是通过管理 ReplicaSet 来简介管理 Pod，即：Deployment 管理 ReplicaSet，ReplicaSet 管理 Pod。所以 Deployment 比 ReplicaSet 功能更加强大。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200612005524778.png\" alt=\"img\" /></p>\n<p>Deployment 主要功能有下面几个：</p>\n<ul>\n<li>支持 ReplicaSet 的所有功能</li>\n<li>支持发布的停止、继续</li>\n<li>支持滚动升级和回滚版本</li>\n</ul>\n<p>Deployment 的资源清单文件：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1 <span class=\"token comment\"># 版本号</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment <span class=\"token comment\"># 类型       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 元数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># rs 名称 </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 所属命名空间 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#标签</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span> deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 详情描述</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\"># 副本数量</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">revisionHistoryLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\"># 保留历史版本</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">paused</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span> <span class=\"token comment\"># 暂停部署，默认是 false</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">progressDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">600</span> <span class=\"token comment\"># 部署超时时间（s），默认是 600</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 策略</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate <span class=\"token comment\"># 滚动更新策略</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">rollingUpdate</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 滚动更新</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">违规词汇</span><span class=\"token punctuation\">:</span> 30% <span class=\"token comment\"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">maxUnavailable</span><span class=\"token punctuation\">:</span> 30% <span class=\"token comment\"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>      <span class=\"token comment\"># Labels 匹配规则</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">&#123;</span><span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>nginx<span class=\"token punctuation\">-</span>pod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr></table></figure><h5 id=\"631-创建deployment\"><a class=\"anchor\" href=\"#631-创建deployment\">#</a> 6.3.1 创建 deployment</h5>\n<p>创建 pc-deployment.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment      </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pc<span class=\"token punctuation\">-</span>deployment</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr></table></figure><h5 id=\"632-扩缩容\"><a class=\"anchor\" href=\"#632-扩缩容\">#</a> 6.3.2 扩缩容</h5>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 变更副本数量为 5 个</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deployment.apps/pc-deployment scaled</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 deployment</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME            READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-deployment   <span class=\"token number\">5</span>/5     <span class=\"token number\">5</span>            <span class=\"token number\">5</span>           2m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pc-deployment-6696798b78-d2c8n   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m19s</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-deployment-6696798b78-jxmdq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          94s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pc-deployment-6696798b78-mktqv   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          93s</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>pc-deployment-6696798b78-smpvp   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m19s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>pc-deployment-6696798b78-wvjd8   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m19s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 编辑 deployment 的副本数量，修改 spec:replicas: 4 即可</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>deployment.apps/pc-deployment edited</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pc-deployment-6696798b78-d2c8n   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5m23s</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pc-deployment-6696798b78-jxmdq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m38s</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>pc-deployment-6696798b78-smpvp   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5m23s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>pc-deployment-6696798b78-wvjd8   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5m23s</pre></td></tr></table></figure><p><strong>镜像更新</strong></p>\n<p>deployment 支持两种更新策略: <code>重建更新</code> 和 <code>滚动更新</code> ，可以通过 <code>strategy</code>  指定策略类型，支持两个属性:</p>\n<figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  type：指定策略类型，支持两种策略</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    违规词汇： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</pre></td></tr></table></figure><p>重建更新</p>\n<ol>\n<li>编辑 pc-deployment.yaml, 在 spec 节点下添加更新策略</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 策略</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Recreate <span class=\"token comment\"># 重建更新</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>创建 deploy 进行验证</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 变更镜像</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deployment.apps/pc-deployment image updated</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 观察升级过程</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-deployment-5d89bdfbf9-65qcw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pc-deployment-5d89bdfbf9-w5nzv   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pc-deployment-5d89bdfbf9-xpt7w   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31s</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pc-deployment-5d89bdfbf9-xpt7w   <span class=\"token number\">1</span>/1     Terminating   <span class=\"token number\">0</span>          41s</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pc-deployment-5d89bdfbf9-65qcw   <span class=\"token number\">1</span>/1     Terminating   <span class=\"token number\">0</span>          41s</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-deployment-5d89bdfbf9-w5nzv   <span class=\"token number\">1</span>/1     Terminating   <span class=\"token number\">0</span>          41s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>pc-deployment-675d469f8b-grn8z   <span class=\"token number\">0</span>/1     Pending       <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>pc-deployment-675d469f8b-hbl4v   <span class=\"token number\">0</span>/1     Pending       <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pc-deployment-675d469f8b-67nz2   <span class=\"token number\">0</span>/1     Pending       <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pc-deployment-675d469f8b-grn8z   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pc-deployment-675d469f8b-hbl4v   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pc-deployment-675d469f8b-67nz2   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pc-deployment-675d469f8b-grn8z   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          1s</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>pc-deployment-675d469f8b-67nz2   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          1s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pc-deployment-675d469f8b-hbl4v   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          2s</pre></td></tr></table></figure><p>滚动更新</p>\n<ol>\n<li>编辑 pc-deployment.yaml, 在 spec 节点下添加更新策略</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 策略</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate <span class=\"token comment\"># 滚动更新策略</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">rollingUpdate</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token key atrule\">违规词汇</span><span class=\"token punctuation\">:</span> 25% </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">maxUnavailable</span><span class=\"token punctuation\">:</span> 25%</pre></td></tr></table></figure><ol start=\"2\">\n<li>创建 deploy 进行验证</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 变更镜像</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deployment.apps/pc-deployment image updated</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 观察升级过程</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-deployment-c848d767-8rbzt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pc-deployment-c848d767-h4p68   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pc-deployment-c848d767-hlmz4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31m</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>pc-deployment-c848d767-rrqcn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pc-deployment-966bf7f44-226rx   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-deployment-966bf7f44-226rx   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pc-deployment-966bf7f44-226rx   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          1s</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>pc-deployment-c848d767-h4p68    <span class=\"token number\">0</span>/1     Terminating         <span class=\"token number\">0</span>          34m</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pc-deployment-966bf7f44-cnd44   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pc-deployment-966bf7f44-cnd44   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pc-deployment-966bf7f44-cnd44   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          2s</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pc-deployment-c848d767-hlmz4    <span class=\"token number\">0</span>/1     Terminating         <span class=\"token number\">0</span>          34m</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pc-deployment-966bf7f44-px48p   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pc-deployment-966bf7f44-px48p   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>pc-deployment-966bf7f44-px48p   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pc-deployment-c848d767-8rbzt    <span class=\"token number\">0</span>/1     Terminating         <span class=\"token number\">0</span>          34m</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>pc-deployment-966bf7f44-dkmqp   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>pc-deployment-966bf7f44-dkmqp   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>pc-deployment-966bf7f44-dkmqp   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          2s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pc-deployment-c848d767-rrqcn    <span class=\"token number\">0</span>/1     Terminating         <span class=\"token number\">0</span>          34m</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\"># 至此，新版本的 pod 创建完毕，就版本的 pod 销毁完毕</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># 中间过程是滚动进行的，也就是边销毁边创建</span></pre></td></tr></table></figure><p>滚动更新的过程：</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200416140251491.png\" alt=\"img\" /></p>\n<p>镜像更新中 rs 的变化</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看 rs, 发现原来的 rs 的依旧存在，只是 pod 数量变为了 0，而后又新产生了一个 rs，pod 数量为 4</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 其实这就是 deployment 能够进行版本回退的奥妙所在，后面会详细解释</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs -n dev</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pc-deployment-6696798b78   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       7m37s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>pc-deployment-6696798b11   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       5m37s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pc-deployment-c848d76789   <span class=\"token number\">4</span>         <span class=\"token number\">4</span>         <span class=\"token number\">4</span>       72s</pre></td></tr></table></figure><h5 id=\"633-版本回退\"><a class=\"anchor\" href=\"#633-版本回退\">#</a> 6.3.3 版本回退</h5>\n<p>deployment 支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p>\n<p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p>\n<ul>\n<li>status\t显示当前升级状态</li>\n<li>history   显示 升级历史记录</li>\n<li>pause    暂停版本升级过程</li>\n<li>resume   继续已经暂停的版本升级过程</li>\n<li>restart    重启版本升级过程</li>\n<li>undo 回滚到上一级版本（可以使用 --to-revision 回滚到指定版本）</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看当前升级版本的状态</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl rollout status deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deployment <span class=\"token string\">\"pc-deployment\"</span> successfully rolled out</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看升级历史记录</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl rollout history deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>deployment.apps/pc-deployment</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>REVISION  CHANGE-CAUSE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">1</span>         kubectl create <span class=\"token parameter variable\">--filename</span><span class=\"token operator\">=</span>pc-deployment.yaml <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">2</span>         kubectl create <span class=\"token parameter variable\">--filename</span><span class=\"token operator\">=</span>pc-deployment.yaml <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">3</span>         kubectl create <span class=\"token parameter variable\">--filename</span><span class=\"token operator\">=</span>pc-deployment.yaml <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 可以发现有三次版本记录，说明完成过两次升级</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 版本回滚</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 这里直接使用 --to-revision=1 回滚到了 1 版本， 如果省略这个选项，就是回退到上个版本，就是 2 版本</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>deployment.apps/pc-deployment rolled back</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 查看发现，通过 nginx 镜像版本可以发现到了第一版</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deploy -n dev -o wide</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pc-deployment   <span class=\"token number\">4</span>/4     <span class=\"token number\">4</span>            <span class=\"token number\">4</span>           74m   nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># 查看 rs，发现第一个 rs 中有 4 个 pod 运行，后面两个版本的 rs 中 pod 为运行</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># 其实 deployment 之所以可是实现版本的回滚，就是通过记录下历史 rs 来实现的，</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 一旦想回滚到哪个版本，只需要将当前版本 pod 数量降为 0，然后将回滚版本的 pod 提升为目标数量就可以了</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs -n dev</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>pc-deployment-6696798b78   <span class=\"token number\">4</span>         <span class=\"token number\">4</span>         <span class=\"token number\">4</span>       78m</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>pc-deployment-966bf7f44    <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       37m</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pc-deployment-c848d767     <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       71m</pre></td></tr></table></figure><h5 id=\"634-金丝雀发布\"><a class=\"anchor\" href=\"#634-金丝雀发布\">#</a> 6.3.4 金丝雀发布</h5>\n<p>Deployment 控制器支持控制更新过程中的控制，如 “暂停 (pause)” 或 “继续 (resume)” 更新操作。</p>\n<p>比如有一批新的 Pod 资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的 Pod 应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的 Pod 资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 更新 deployment 的版本，并配置暂停 deployment</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deployment.apps/pc-deployment image updated</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>deployment.apps/pc-deployment paused</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#观察更新状态</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl rollout status deploy pc-deployment -n dev　</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Waiting <span class=\"token keyword\">for</span> deployment <span class=\"token string\">\"pc-deployment\"</span> rollout to finish: <span class=\"token number\">2</span> out of <span class=\"token number\">4</span> new replicas have been updated<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了 pause 暂停命令</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-deployment-5d89bdfbf9   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       19m     nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pc-deployment-675d469f8b   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       14m     nginx        nginx:1.17.2   </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>pc-deployment-6c9f56fcfb   <span class=\"token number\">2</span>         <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       3m16s   nginx        nginx:1.17.4   </pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pc-deployment-5d89bdfbf9-rj8sq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m33s</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pc-deployment-5d89bdfbf9-ttwgg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m35s</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pc-deployment-5d89bdfbf9-v4wvc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m34s</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pc-deployment-6c9f56fcfb-996rt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m31s</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pc-deployment-6c9f56fcfb-j2gtj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m31s</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># 确保更新的 pod 没问题了，继续更新</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl rollout resume deploy pc-deployment -n dev</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>deployment.apps/pc-deployment resumed</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 查看最后的更新情况</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs -n dev -o wide</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>pc-deployment-5d89bdfbf9   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       21m     nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>pc-deployment-675d469f8b   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       16m     nginx        nginx:1.17.2   </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>pc-deployment-6c9f56fcfb   <span class=\"token number\">4</span>         <span class=\"token number\">4</span>         <span class=\"token number\">4</span>       5m11s   nginx        nginx:1.17.4   </pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>pc-deployment-6c9f56fcfb-7bfwh   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          37s</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>pc-deployment-6c9f56fcfb-996rt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5m27s</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>pc-deployment-6c9f56fcfb-j2gtj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5m27s</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>pc-deployment-6c9f56fcfb-rf84v   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          37s</pre></td></tr></table></figure><p><strong>删除 Deployment</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 删除 deployment，其下的 rs 和 pod 也将被删除</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f pc-deployment.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deployment.apps <span class=\"token string\">\"pc-deployment\"</span> deleted</pre></td></tr></table></figure><h4 id=\"64-horizontal-pod-autoscalerhpa\"><a class=\"anchor\" href=\"#64-horizontal-pod-autoscalerhpa\">#</a> 6.4 Horizontal Pod Autoscaler(HPA)</h4>\n<p>在前面的课程中，我们已经可以实现通过手工执行 <code>kubectl scale</code>  命令实现 Pod 扩容或缩容，但是这显然不符合 Kubernetes 的定位目标 -- 自动化、智能化。 Kubernetes 期望可以实现通过监测 Pod 的使用情况，实现 pod 数量的自动调整，于是就产生了 Horizontal Pod Autoscaler（HPA）这种控制器。</p>\n<p>HPA 可以获取每个 Pod 利用率，然后和 HPA 中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现 Pod 的数量的调整。其实 HPA 与之前的 Deployment 一样，也属于一种 Kubernetes 资源对象，它通过追踪分析 RC 控制的所有目标 Pod 的负载变化情况，来确定是否需要针对性地调整目标 Pod 的副本数，这是 HPA 的实现原理。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200608155858271.png\" alt=\"img\" /></p>\n<p>接下来，我们来做一个实验</p>\n<h5 id=\"641-安装metrics-server\"><a class=\"anchor\" href=\"#641-安装metrics-server\">#</a> 6.4.1 安装 metrics-server</h5>\n<p>metrics-server 可以用来收集集群中的资源使用情况</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 安装 git</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install git -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 获取 metrics-server, 注意使用的版本</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 修改 deployment, 注意修改的是镜像和初始化参数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/metrics-server/deploy/1.8+/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim metrics-server-deployment.yaml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>按图中添加下面选项</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>hostNetwork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>args:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>- --kubelet-insecure-tls</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>- --kubelet-preferred-address-types<span class=\"token operator\">=</span>InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</pre></td></tr></table></figure><p><img data-src=\"http://oss.itshare.work/blog-images/image-20200608163326496.png\" alt=\"image-20200608163326496\" /></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 安装 metrics-server</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f ./</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 查看 pod 运行情况</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n kube-system</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>metrics-server-6b976979db-2xwbj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          90s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 使用 kubectl top node 查看资源使用情况</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl top node</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>NAME           CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   CPU%   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span>   MEMORY%</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>k8s-master01   289m         <span class=\"token number\">14</span>%    1582Mi          <span class=\"token number\">54</span>%       </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>k8s-node01     81m          <span class=\"token number\">4</span>%     1195Mi          <span class=\"token number\">40</span>%       </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>k8s-node02     72m          <span class=\"token number\">3</span>%     1211Mi          <span class=\"token number\">41</span>%  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl top pod -n kube-system</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>NAME                              CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>coredns-6955765f44-7ptsb          3m           9Mi</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>coredns-6955765f44-vcwr5          3m           8Mi</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>etcd-master                       14m          145Mi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 至此，metrics-server 安装完成</span></pre></td></tr></table></figure><h5 id=\"642-准备deployment和servie\"><a class=\"anchor\" href=\"#642-准备deployment和servie\">#</a> 6.4.2 准备 deployment 和 servie</h5>\n<p>创建 pc-hpa-pod.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 策略</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate <span class=\"token comment\"># 滚动更新策略</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 资源配额</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 限制资源（上限）</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span> <span class=\"token comment\"># CPU 限制，单位是 core 数</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 请求资源（下限）</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"100m\"</span>  <span class=\"token comment\"># CPU 限制，单位是 core 数</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 deployment</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 创建 service</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deployment,pod,svc -n dev</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>deployment.apps/nginx   <span class=\"token number\">1</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           47s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>NAME                         READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pod/nginx-7df9756ccc-bh8dr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          47s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>        AGE</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>service/nginx   NodePort   <span class=\"token number\">10.101</span>.18.29   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>:31830/TCP   35s</pre></td></tr></table></figure><h5 id=\"643-部署hpa\"><a class=\"anchor\" href=\"#643-部署hpa\">#</a> 6.4.3 部署 HPA</h5>\n<p>创建 pc-hpa.yaml 文件，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> autoscaling/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HorizontalPodAutoscaler</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pc<span class=\"token punctuation\">-</span>hpa</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">minReplicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>  <span class=\"token comment\">#最小 pod 数量</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">maxReplicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\">#最大 pod 数量</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">targetCPUUtilizationPercentage</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\"># CPU 使用率指标</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">scaleTargetRef</span><span class=\"token punctuation\">:</span>   <span class=\"token comment\"># 指定要控制的 nginx 信息</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span>  apps/v1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 hpa</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pc-hpa.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>horizontalpodautoscaler.autoscaling/pc-hpa created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 hpa</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">[</span>root@k8s-master01 <span class=\"token number\">1.8</span>+<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get hpa -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-hpa   Deployment/nginx   <span class=\"token number\">0</span>%/3%     <span class=\"token number\">1</span>         <span class=\"token number\">10</span>        <span class=\"token number\">1</span>          62s</pre></td></tr></table></figure><h5 id=\"644-测试\"><a class=\"anchor\" href=\"#644-测试\">#</a> 6.4.4 测试</h5>\n<p>使用压测工具对 service 地址 <code>192.168.5.4:31830</code>  进行压测，然后通过控制台查看 hpa 和 pod 的变化</p>\n<p>hpa 变化</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get hpa -n dev -w</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">0</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">1</span>      4m11s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">0</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">1</span>      5m19s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">22</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">1</span>      6m50s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">22</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">4</span>      7m5s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">22</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">8</span>      7m21s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">6</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">8</span>      7m51s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">0</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">8</span>      9m6s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">0</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">8</span>      13m</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>pc-hpa  Deployment/nginx  <span class=\"token number\">0</span>%/3%   <span class=\"token number\">1</span>     <span class=\"token number\">10</span>     <span class=\"token number\">1</span>      14m</pre></td></tr></table></figure><p>deployment 变化</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deployment -n dev -w</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME    READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx   <span class=\"token number\">1</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           11m</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx   <span class=\"token number\">1</span>/4     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           13m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx   <span class=\"token number\">1</span>/4     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           13m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx   <span class=\"token number\">1</span>/4     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           13m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx   <span class=\"token number\">1</span>/4     <span class=\"token number\">4</span>            <span class=\"token number\">1</span>           13m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nginx   <span class=\"token number\">1</span>/8     <span class=\"token number\">4</span>            <span class=\"token number\">1</span>           14m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nginx   <span class=\"token number\">1</span>/8     <span class=\"token number\">4</span>            <span class=\"token number\">1</span>           14m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nginx   <span class=\"token number\">1</span>/8     <span class=\"token number\">4</span>            <span class=\"token number\">1</span>           14m</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>nginx   <span class=\"token number\">1</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">1</span>           14m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nginx   <span class=\"token number\">2</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">2</span>           14m</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>nginx   <span class=\"token number\">3</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">3</span>           14m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>nginx   <span class=\"token number\">4</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">4</span>           14m</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nginx   <span class=\"token number\">5</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">5</span>           14m</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>nginx   <span class=\"token number\">6</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">6</span>           14m</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nginx   <span class=\"token number\">7</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">7</span>           14m</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nginx   <span class=\"token number\">8</span>/8     <span class=\"token number\">8</span>            <span class=\"token number\">8</span>           15m</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>nginx   <span class=\"token number\">8</span>/1     <span class=\"token number\">8</span>            <span class=\"token number\">8</span>           20m</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>nginx   <span class=\"token number\">8</span>/1     <span class=\"token number\">8</span>            <span class=\"token number\">8</span>           20m</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>nginx   <span class=\"token number\">1</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">1</span>           20m</pre></td></tr></table></figure><p>pod 变化</p>\n<pre><code>[root@k8s-master01 ~]# kubectl get pods -n dev -w\nNAME                     READY   STATUS    RESTARTS   AGE\nnginx-7df9756ccc-bh8dr   1/1     Running   0          11m\nnginx-7df9756ccc-cpgrv   0/1     Pending   0          0s\nnginx-7df9756ccc-8zhwk   0/1     Pending   0          0s\nnginx-7df9756ccc-rr9bn   0/1     Pending   0          0s\nnginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s\nnginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s\nnginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s\nnginx-7df9756ccc-m9gsj   0/1     Pending             0          0s\nnginx-7df9756ccc-g56qb   0/1     Pending             0          0s\nnginx-7df9756ccc-sl9c6   0/1     Pending             0          0s\nnginx-7df9756ccc-fgst7   0/1     Pending             0          0s\nnginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s\nnginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s\nnginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s\nnginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s\nnginx-7df9756ccc-8zhwk   1/1     Running             0          19s\nnginx-7df9756ccc-rr9bn   1/1     Running             0          30s\nnginx-7df9756ccc-m9gsj   1/1     Running             0          21s\nnginx-7df9756ccc-cpgrv   1/1     Running             0          47s\nnginx-7df9756ccc-sl9c6   1/1     Running             0          33s\nnginx-7df9756ccc-g56qb   1/1     Running             0          48s\nnginx-7df9756ccc-fgst7   1/1     Running             0          66s\nnginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s\nnginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s\nnginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s\nnginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s\nnginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s\nnginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s\nnginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s\n</code></pre>\n<h4 id=\"65-daemonsetds\"><a class=\"anchor\" href=\"#65-daemonsetds\">#</a> 6.5 DaemonSet(DS)</h4>\n<p>DaemonSet 类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个 Pod 提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类 Pod 就适合使用 DaemonSet 类型的控制器创建。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200612010223537.png\" alt=\"img\" /></p>\n<p>DaemonSet 控制器的特点：</p>\n<ul>\n<li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li>\n<li>当节点从集群中移除时，Pod 也就被垃圾回收了</li>\n</ul>\n<p>下面先来看下 DaemonSet 的资源清单文件</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1 <span class=\"token comment\"># 版本号</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> DaemonSet <span class=\"token comment\"># 类型       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 元数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># rs 名称 </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 所属命名空间 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#标签</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span> daemonset</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 详情描述</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">revisionHistoryLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\"># 保留历史版本</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">updateStrategy</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 更新策略</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate <span class=\"token comment\"># 滚动更新策略</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">rollingUpdate</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 滚动更新</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">maxUnavailable</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token comment\"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>      <span class=\"token comment\"># Labels 匹配规则</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">&#123;</span><span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>nginx<span class=\"token punctuation\">-</span>pod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr></table></figure><p>创建 pc-daemonset.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> DaemonSet      </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pc<span class=\"token punctuation\">-</span>daemonset</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 daemonset</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f  pc-daemonset.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>daemonset.apps/pc-daemonset created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 daemonset</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl get ds -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-daemonset   <span class=\"token number\">2</span>        <span class=\"token number\">2</span>        <span class=\"token number\">2</span>      <span class=\"token number\">2</span>           <span class=\"token number\">2</span>        24s   nginx        nginx:1.17.1   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看 pod, 发现在每个 Node 上都运行一个 pod</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pc-daemonset-9bck8   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          37s   <span class=\"token number\">10.244</span>.1.43   node1     </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-daemonset-k224w   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          37s   <span class=\"token number\">10.244</span>.2.74   node2      </pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 删除 daemonset</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f pc-daemonset.yaml</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>daemonset.apps <span class=\"token string\">\"pc-daemonset\"</span> deleted</pre></td></tr></table></figure><h4 id=\"66-job\"><a class=\"anchor\" href=\"#66-job\">#</a> 6.6 Job</h4>\n<p>Job，主要用于负责 ** 批量处理 (一次要处理指定数量任务)<strong> 短暂的</strong>一次性 (每个任务仅运行一次就结束)** 任务。Job 特点如下：</p>\n<ul>\n<li>当 Job 创建的 pod 执行成功结束时，Job 将记录成功结束的 pod 数量</li>\n<li>当成功结束的 pod 达到指定的数量时，Job 将完成执行</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200618213054113.png\" alt=\"img\" /></p>\n<p>Job 的资源清单文件：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> batch/v1 <span class=\"token comment\"># 版本号</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Job <span class=\"token comment\"># 类型       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 元数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># rs 名称 </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 所属命名空间 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#标签</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span> job</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 详情描述</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">completions</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token comment\"># 指定 job 需要成功运行 Pods 的次数。默认值: 1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">parallelism</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token comment\"># 指定 job 在任一时刻应该并发运行 Pods 的数量。默认值: 1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">activeDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span> <span class=\"token comment\"># 指定 job 可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">backoffLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span> <span class=\"token comment\"># 指定 job 失败后进行重试的次数。默认是 6</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">manualSelector</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># 是否可以使用 selector 选择器选择 pod，默认是 false</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 选择器，通过它指定该控制器管理哪些 pod</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>      <span class=\"token comment\"># Labels 匹配规则</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> counter<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Expressions 匹配规则</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">&#123;</span><span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>counter<span class=\"token punctuation\">-</span>pod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 模板，当副本数量不足时，会根据下面的模板创建 pod 副本</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> counter<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never <span class=\"token comment\"># 重启策略只能设置为 Never 或者 OnFailure</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> counter</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>关于重启策略设置的说明：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</pre></td></tr></table></figure><p>创建 pc-job.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> batch/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Job      </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pc<span class=\"token punctuation\">-</span>job</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">manualSelector</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> counter<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> counter<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> counter</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 job</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pc-job.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>job.batch/pc-job created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 job</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get job -n dev -o wide  -w</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-job   <span class=\"token number\">0</span>/1           21s        21s   counter      busybox:1.30   <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>counter-pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pc-job   <span class=\"token number\">1</span>/1           31s        79s   counter      busybox:1.30   <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>counter-pod</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 通过观察 pod 状态可以看到，pod 在运行完毕任务后，就会变成 Completed 状态</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>NAME           READY   STATUS     RESTARTS      AGE</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-job-rxg96   <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>            29s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pc-job-rxg96   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>            33s</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 接下来，调整下 pod 运行的总数量和并行数量 即：在 spec 下设置下面两个选项</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#  completions: 6 # 指定 job 需要成功运行 Pods 的次数为 6</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#  parallelism: 3 # 指定 job 并发运行 Pods 的数量为 3</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#  然后重新运行 job，观察效果，此时会发现，job 会每次运行 3 个 pod，总共执行了 6 个 pod</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -w</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>NAME           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pc-job-684ft   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pc-job-jhj49   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>pc-job-pfcvh   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pc-job-684ft   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          11s</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pc-job-v7rhr   <span class=\"token number\">0</span>/1     Pending     <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>pc-job-v7rhr   <span class=\"token number\">0</span>/1     Pending     <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>pc-job-v7rhr   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>pc-job-jhj49   <span class=\"token number\">0</span>/1     Completed           <span class=\"token number\">0</span>          11s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>pc-job-fhwf7   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>pc-job-fhwf7   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>pc-job-pfcvh   <span class=\"token number\">0</span>/1     Completed           <span class=\"token number\">0</span>          11s</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>pc-job-5vg2j   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>pc-job-fhwf7   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>pc-job-5vg2j   <span class=\"token number\">0</span>/1     Pending             <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>pc-job-5vg2j   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          0s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>pc-job-fhwf7   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          2s</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>pc-job-v7rhr   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          2s</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>pc-job-5vg2j   <span class=\"token number\">1</span>/1     Running             <span class=\"token number\">0</span>          3s</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>pc-job-fhwf7   <span class=\"token number\">0</span>/1     Completed           <span class=\"token number\">0</span>          12s</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>pc-job-v7rhr   <span class=\"token number\">0</span>/1     Completed           <span class=\"token number\">0</span>          12s</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>pc-job-5vg2j   <span class=\"token number\">0</span>/1     Completed           <span class=\"token number\">0</span>          12s</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># 删除 job</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f pc-job.yaml</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>job.batch <span class=\"token string\">\"pc-job\"</span> deleted</pre></td></tr></table></figure><h4 id=\"67-cronjobcj\"><a class=\"anchor\" href=\"#67-cronjobcj\">#</a> 6.7 CronJob(CJ)</h4>\n<p>CronJob 控制器以 Job 控制器资源为其管控对象，并借助它管理 pod 资源对象，Job 控制器定义的作业任务在其控制器资源创建之后便会立即执行，但 CronJob 可以以类似于 Linux 操作系统的周期性任务作业计划的方式控制其运行<strong>时间点</strong>及<strong>重复运行</strong>的方式。也就是说，<strong>CronJob 可以在特定的时间点 (反复的) 去运行 job 任务</strong>。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200618213149531.png\" alt=\"img\" /></p>\n<p>CronJob 的资源清单文件：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> batch/v1beta1 <span class=\"token comment\"># 版本号</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> CronJob <span class=\"token comment\"># 类型       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 元数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># rs 名称 </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 所属命名空间 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#标签</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span> cronjob</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 详情描述</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># cron 格式的作业调度运行时间点，用于控制任务在什么时间执行</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">concurrencyPolicy</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">failedJobHistoryLimit</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 为失败的任务执行保留的历史记录数，默认为 1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">successfulJobHistoryLimit</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 为成功的任务执行保留的历史记录数，默认为 3</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">startingDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 启动作业错误的超时时长</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">jobTemplate</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># job 控制器模板，用于为 cronjob 控制器生成 job 对象；下面其实就是 job 的定义</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">completions</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token key atrule\">parallelism</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token key atrule\">activeDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">backoffLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token key atrule\">manualSelector</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> counter<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span> 规则</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">&#123;</span><span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In<span class=\"token punctuation\">,</span> <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>counter<span class=\"token punctuation\">-</span>pod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> counter<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> counter</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>需要重点解释的几个选项：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>schedule: cron表达式，用于指定任务的执行时间</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token italic\"><span class=\"token punctuation\">*</span><span class=\"token content\">/1    </span><span class=\"token punctuation\">*</span></span>      <span class=\"token italic\"><span class=\"token punctuation\">*</span><span class=\"token content\">    </span><span class=\"token punctuation\">*</span></span>     *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>分钟</span><span class=\"token punctuation\">></span></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>小时</span><span class=\"token punctuation\">></span></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>日</span><span class=\"token punctuation\">></span></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>月份</span><span class=\"token punctuation\">></span></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>星期</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token code keyword\">    分钟 值从 0 到 59.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    小时 值从 0 到 23.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    日 值从 1 到 31.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    月 值从 1 到 12.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    星期 值从 0 到 6, 0 代表星期日</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>concurrencyPolicy:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    Allow:   允许Jobs并发运行(默认)</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    Replace: 替换，取消当前正在运行的作业并用新作业替换它</pre></td></tr></table></figure><p>创建 pc-cronjob.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> batch/v1beta1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> CronJob</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pc<span class=\"token punctuation\">-</span>cronjob</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">controller</span><span class=\"token punctuation\">:</span> cronjob</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*/1 * * * *\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">jobTemplate</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> counter</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 cronjob</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pc-cronjob.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cronjob.batch/pc-cronjob created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 cronjob</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get cronjobs -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-cronjob   */1 * * * *   False     <span class=\"token number\">0</span>        <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          6s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看 job</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get jobs -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NAME                    COMPLETIONS   DURATION   AGE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pc-cronjob-1592587800   <span class=\"token number\">1</span>/1           28s        3m26s</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pc-cronjob-1592587860   <span class=\"token number\">1</span>/1           28s        2m26s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pc-cronjob-1592587920   <span class=\"token number\">1</span>/1           28s        86s</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pc-cronjob-1592587800-x4tsm   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          2m24s</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pc-cronjob-1592587860-r5gv4   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          84s</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>pc-cronjob-1592587920-9dxxq   <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>          24s</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># 删除 cronjob</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  delete -f pc-cronjob.yaml</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>cronjob.batch <span class=\"token string\">\"pc-cronjob\"</span> deleted</pre></td></tr></table></figure><h3 id=\"7-service详解\"><a class=\"anchor\" href=\"#7-service详解\">#</a> 7. Service 详解</h3>\n<h4 id=\"71-service介绍\"><a class=\"anchor\" href=\"#71-service介绍\">#</a> 7.1 Service 介绍</h4>\n<p>在 kubernetes 中，pod 是应用程序的载体，我们可以通过 pod 的 ip 来访问应用程序，但是 pod 的 ip 地址不是固定的，这也就意味着不方便直接采用 pod 的 ip 对服务进行访问。</p>\n<p>为了解决这个问题，kubernetes 提供了 Service 资源，Service 会对提供同一个服务的多个 pod 进行聚合，并且提供一个统一的入口地址。通过访问 Service 的入口地址就能访问到后面的 pod 服务。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200408194716912-1626783758946.png\" alt=\"img\" /></p>\n<p>Service 在很多情况下只是一个概念，真正起作用的其实是 kube-proxy 服务进程，每个 Node 节点上都运行着一个 kube-proxy 服务进程。当创建 Service 的时候会通过 api-server 向 etcd 写入创建的 service 的信息，而 kube-proxy 会基于监听的机制发现这种 Service 的变动，然后<strong>它会将最新的 Service 信息转换成对应的访问规则</strong>。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200509121254425.png\" alt=\"img\" /></p>\n<pre><code># 10.97.97.97:80 是service提供的访问入口\n# 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，\n# kube-proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去\n# 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点，访问都可以。\n[root@node1 ~]# ipvsadm -Ln\nIP Virtual Server version 1.2.1 (size=4096)\nProt LocalAddress:Port Scheduler Flags\n  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn\nTCP  10.97.97.97:80 rr\n  -&gt; 10.244.1.39:80               Masq    1      0          0\n  -&gt; 10.244.1.40:80               Masq    1      0          0\n  -&gt; 10.244.2.33:80               Masq    1      0          0\n</code></pre>\n<p>kube-proxy 目前支持三种工作模式:</p>\n<p>kube-proxy 目前支持三种工作模式:</p>\n<h5 id=\"711-userspace-模式\"><a class=\"anchor\" href=\"#711-userspace-模式\">#</a> 7.1.1 userspace 模式</h5>\n<p>userspace 模式下，kube-proxy 会为每一个 Service 创建一个监听端口，发向 Cluster IP 的请求被 Iptables 规则重定向到 kube-proxy 监听的端口上，kube-proxy 根据 LB 算法选择一个提供服务的 Pod 并和其建立链接，以将请求转发到 Pod 上。  该模式下，kube-proxy 充当了一个四层负责均衡器的角色。由于 kube-proxy 运行在 userspace 中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200509151424280.png\" alt=\"img\" /></p>\n<h5 id=\"712-iptables-模式\"><a class=\"anchor\" href=\"#712-iptables-模式\">#</a> 7.1.2 iptables 模式</h5>\n<p>iptables 模式下，kube-proxy 为 service 后端的每个 Pod 创建对应的 iptables 规则，直接将发向 Cluster IP 的请求重定向到一个 Pod IP。  该模式下 kube-proxy 不承担四层负责均衡器的角色，只负责创建 iptables 规则。该模式的优点是较 userspace 模式效率更高，但不能提供灵活的 LB 策略，当后端 Pod 不可用时也无法进行重试。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200509152947714.png\" alt=\"img\" /></p>\n<h5 id=\"713-ipvs-模式\"><a class=\"anchor\" href=\"#713-ipvs-模式\">#</a> 7.1.3 ipvs 模式</h5>\n<p>ipvs 模式和 iptables 类似，kube-proxy 监控 Pod 的变化并创建相应的 ipvs 规则。ipvs 相对 iptables 转发效率更高。除此以外，ipvs 支持更多的 LB 算法。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200509153731363.png\" alt=\"img\" /></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 此模式必须安装 ipvs 内核模块，否则会降级为 iptables</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 开启 ipvs</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm kube-proxy -n kube-system</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 修改 mode: \"ipvs\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@node1 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>TCP  <span class=\"token number\">10.97</span>.97.97:80 rr</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.39:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.40:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.2.33:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"72-service类型\"><a class=\"anchor\" href=\"#72-service类型\">#</a> 7.2 Service 类型</h4>\n<p>Service 的资源清单文件：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service  <span class=\"token comment\"># 资源类型</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1  <span class=\"token comment\"># 资源版本</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 元数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> service <span class=\"token comment\"># 资源名称</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev <span class=\"token comment\"># 命名空间</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 描述</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 标签选择器，用于确定当前 service 代理哪些 pod</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># Service 类型，指定 service 的访问方式</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">clusterIP</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 虚拟服务的 ip 地址</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">sessionAffinity</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># session 亲和性，支持 ClientIP、None 两个选项</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 端口信息</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3017</span>  <span class=\"token comment\"># service 端口</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5003</span> <span class=\"token comment\"># pod 端口</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">31122</span> <span class=\"token comment\"># 主机端口</span></pre></td></tr></table></figure><ul>\n<li>ClusterIP：默认值，它是 Kubernetes 系统自动分配的虚拟 IP，只能在集群内部访问</li>\n<li>NodePort：将 Service 通过指定的 Node 上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</li>\n<li>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</li>\n<li>ExternalName： 把集群外部的服务引入集群内部，直接使用</li>\n</ul>\n<h4 id=\"73-service使用\"><a class=\"anchor\" href=\"#73-service使用\">#</a> 7.3 Service 使用</h4>\n<h5 id=\"731-实验环境准备\"><a class=\"anchor\" href=\"#731-实验环境准备\">#</a> 7.3.1 实验环境准备</h5>\n<p>在使用 service 之前，首先利用 Deployment 创建出 3 个 pod，注意要为 pod 设置 <code>app=nginx-pod</code>  的标签</p>\n<p>创建 deployment.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment      </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pc<span class=\"token punctuation\">-</span>deployment</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f deployment.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/pc-deployment created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 查看 pod 详情</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide --show-labels</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>NAME                             READY   STATUS     IP            NODE     LABELS</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pc-deployment-66cb59b984-8p84h   <span class=\"token number\">1</span>/1     Running    <span class=\"token number\">10.244</span>.1.39   node1    <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pc-deployment-66cb59b984-vx8vx   <span class=\"token number\">1</span>/1     Running    <span class=\"token number\">10.244</span>.2.33   node2    <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pc-deployment-66cb59b984-wnncx   <span class=\"token number\">1</span>/1     Running    <span class=\"token number\">10.244</span>.1.40   node1    <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 为了方便后面的测试，修改下三台 nginx 的 index.html 页面（三台修改的 IP 地址不一致）</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># echo \"10.244.1.39\" > /usr/share/nginx/html/index.html</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#修改完毕之后，访问测试</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.244.1.39</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">10.244</span>.1.39</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.244.2.33</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">10.244</span>.2.33</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.244.1.40</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">10.244</span>.1.40</pre></td></tr></table></figure><h5 id=\"732-clusterip类型的service\"><a class=\"anchor\" href=\"#732-clusterip类型的service\">#</a> 7.3.2 ClusterIP 类型的 Service</h5>\n<p>创建 service-clusterip.yaml 文件</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">-</span>clusterip</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">clusterIP</span><span class=\"token punctuation\">:</span> 10.97.97.97 <span class=\"token comment\"># service 的 ip 地址，如果不写，默认会生成一个</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>  <span class=\"token comment\"># Service 端口       </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span> <span class=\"token comment\"># pod 端口</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f service-clusterip.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>service/service-clusterip created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 service</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>   AGE   SELECTOR</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>service-clusterip   ClusterIP   <span class=\"token number\">10.97</span>.97.97   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP    13s   <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看 service 的详细信息</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 在这里有一个 Endpoints 列表，里面就是当前 service 可以负载到的服务入口</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe svc service-clusterip -n dev</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Name:              service-clusterip</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Namespace:         dev</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Labels:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Annotations:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Selector:          <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Type:              ClusterIP</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>IP:                <span class=\"token number\">10.97</span>.97.97</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Port:              <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>  <span class=\"token number\">80</span>/TCP</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>TargetPort:        <span class=\"token number\">80</span>/TCP</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Endpoints:         <span class=\"token number\">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Session Affinity:  None</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Events:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 查看 ipvs 的映射规则</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>TCP  <span class=\"token number\">10.97</span>.97.97:80 rr</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.39:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.40:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.2.33:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\"># 访问 10.97.97.97:80 观察效果</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.97.97.97:80</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">10.244</span>.2.33</pre></td></tr></table></figure><h5 id=\"733-endpoint\"><a class=\"anchor\" href=\"#733-endpoint\">#</a> 7.3.3 Endpoint</h5>\n<p>Endpoint 是 kubernetes 中的一个资源对象，存储在 etcd 中，用来记录一个 service 对应的所有 pod 的访问地址，它是根据 service 配置文件中 selector 描述产生的。</p>\n<p>一个 Service 由一组 Pod 组成，这些 Pod 通过 Endpoints 暴露出来，<strong>Endpoints 是实现实际服务的端点集合</strong>。换句话说，service 和 pod 之间的联系是通过 endpoints 实现的。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200509191917069.png\" alt=\"image-20200509191917069\" /></p>\n<p><strong>负载分发策略</strong></p>\n<p>对 Service 的访问被分发到了后端的 Pod 上去，目前 kubernetes 提供了两种负载分发策略：</p>\n<ul>\n<li>\n<p>如果不定义，默认使用 kube-proxy 的策略，比如随机、轮询</p>\n</li>\n<li>\n<p>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个 Pod 上</p>\n<p>此模式可以使在 spec 中添加 <code>sessionAffinity:ClientIP</code>  选项</p>\n</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看 ipvs 的映射规则【rr 轮询】</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>TCP  <span class=\"token number\">10.97</span>.97.97:80 rr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.39:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.40:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.2.33:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 循环访问测试</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># while true;do curl 10.97.97.97:80; sleep 5; done;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">10.244</span>.1.40</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">10.244</span>.1.39</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">10.244</span>.2.33</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">10.244</span>.1.40</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">10.244</span>.1.39</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">10.244</span>.2.33</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 修改分发策略 ----sessionAffinity:ClientIP</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 查看 ipvs 规则【persistent 代表持久】</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -Ln</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>TCP  <span class=\"token number\">10.97</span>.97.97:80 rr persistent <span class=\"token number\">10800</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.39:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.1.40:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">10.244</span>.2.33:80               Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 循环访问测试</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># while true;do curl 10.97.97.97; sleep 5; done;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">10.244</span>.2.33</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token number\">10.244</span>.2.33</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token number\">10.244</span>.2.33</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 删除 service</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete -f service-clusterip.yaml</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token function\">service</span> <span class=\"token string\">\"service-clusterip\"</span> deleted</pre></td></tr></table></figure><h5 id=\"734-headliness类型的service\"><a class=\"anchor\" href=\"#734-headliness类型的service\">#</a> 7.3.4 HeadLiness 类型的 Service</h5>\n<p>在某些场景中，开发人员可能不想使用 Service 提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes 提供了 HeadLiness Service，这类 Service 不会分配 Cluster IP，如果想要访问 service，只能通过 service 的域名进行查询。</p>\n<p>创建 service-headliness.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">-</span>headliness</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">clusterIP</span><span class=\"token punctuation\">:</span> None <span class=\"token comment\"># 将 clusterIP 设置为 None，即可创建 headliness Service</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f service-headliness.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>service/service-headliness created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 获取 service， 发现 CLUSTER-IP 未分配</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc service-headliness -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>   AGE   SELECTOR</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>service-headliness   ClusterIP   None         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP    11s   <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看 service 详情</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe svc service-headliness  -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Name:              service-headliness</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Namespace:         dev</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Labels:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Annotations:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Selector:          <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Type:              ClusterIP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>IP:                None</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Port:              <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>  <span class=\"token number\">80</span>/TCP</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>TargetPort:        <span class=\"token number\">80</span>/TCP</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Endpoints:         <span class=\"token number\">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Session Affinity:  None</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Events:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># 查看域名的解析情况</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>/ <span class=\"token comment\"># cat /etc/resolv.conf</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>nameserver <span class=\"token number\">10.96</span>.0.10</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>search dev.svc.cluster.local svc.cluster.local cluster.local</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>service-headliness.dev.svc.cluster.local. <span class=\"token number\">30</span> IN A <span class=\"token number\">10.244</span>.1.40</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>service-headliness.dev.svc.cluster.local. <span class=\"token number\">30</span> IN A <span class=\"token number\">10.244</span>.1.39</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>service-headliness.dev.svc.cluster.local. <span class=\"token number\">30</span> IN A <span class=\"token number\">10.244</span>.2.33</pre></td></tr></table></figure><h5 id=\"735-nodeport类型的service\"><a class=\"anchor\" href=\"#735-nodeport类型的service\">#</a> 7.3.5 NodePort 类型的 Service</h5>\n<p>在之前的样例中，创建的 Service 的 ip 地址只有集群内部才可以访问，如果希望将 Service 暴露给集群外部使用，那么就要使用到另外一种类型的 Service，称为 NodePort 类型。NodePort 的工作原理其实就是<strong>将 service 的端口映射到 Node 的一个端口上</strong>，然后就可以通过 <code>NodeIp:NodePort</code>  来访问 service 了。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200620175731338.png\" alt=\"img\" /></p>\n<p>创建 service-nodeport.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">-</span>nodeport</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort <span class=\"token comment\"># service 类型</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30002</span> <span class=\"token comment\"># 指定绑定的 node 的端口 (默认的取值范围是：30000-32767), 如果不指定，会默认分配</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f service-nodeport.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>service/service-nodeport created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 service</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>       SELECTOR</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>service-nodeport   NodePort   <span class=\"token number\">10.105</span>.64.191   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>:30002/TCP  <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-pod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 接下来可以通过电脑主机的浏览器去访问集群中任意一个 nodeip 的 30002 端口，即可访问到 pod</span></pre></td></tr></table></figure><h5 id=\"736-loadbalancer类型的service\"><a class=\"anchor\" href=\"#736-loadbalancer类型的service\">#</a> 7.3.6 LoadBalancer 类型的 Service</h5>\n<p>LoadBalancer 和 NodePort 很相似，目的都是向外部暴露一个端口，区别在于 LoadBalancer 会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200510103945494.png\" alt=\"img\" /></p>\n<h5 id=\"737-externalname类型的service\"><a class=\"anchor\" href=\"#737-externalname类型的service\">#</a> 7.3.7 ExternalName 类型的 Service</h5>\n<p>ExternalName 类型的 Service 用于引入集群外部的服务，它通过 <code>externalName</code>  属性指定外部一个服务的地址，然后在集群内部访问此 service 就可以访问到外部的服务了。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200510113311209.png\" alt=\"img\" /></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: service-externalname</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  type: ExternalName <span class=\"token comment\"># service 类型</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  externalName: www.baidu.com  <span class=\"token comment\">#改成 ip 地址也可以</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  create -f service-externalname.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>service/service-externalname created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 域名解析</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>service-externalname.dev.svc.cluster.local. <span class=\"token number\">30</span> IN CNAME www.baidu.com.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>www.baidu.com.          <span class=\"token number\">30</span>      IN      CNAME   www.a.shifen.com.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>www.a.shifen.com.       <span class=\"token number\">30</span>      IN      A       <span class=\"token number\">39.156</span>.66.18</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>www.a.shifen.com.       <span class=\"token number\">30</span>      IN      A       <span class=\"token number\">39.156</span>.66.14</pre></td></tr></table></figure><h4 id=\"74-ingress介绍\"><a class=\"anchor\" href=\"#74-ingress介绍\">#</a> 7.4 Ingress 介绍</h4>\n<p>在前面课程中已经提到，Service 对集群之外暴露服务的主要方式有两种：NotePort 和 LoadBalancer，但是这两种方式，都有一定的缺点：</p>\n<ul>\n<li>NodePort 方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显</li>\n<li>LB 方式的缺点是每个 service 需要一个 LB，浪费、麻烦，并且需要 kubernetes 之外设备的支持</li>\n</ul>\n<p>基于这种现状，kubernetes 提供了 Ingress 资源对象，Ingress 只需要一个 NodePort 或者一个 LB 就可以满足暴露多个 Service 的需求。工作机制大致如下图表示：</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200623092808049.png\" alt=\"img\" /></p>\n<p>实际上，Ingress 相当于一个 7 层的负载均衡器，是 kubernetes 对反向代理的一个抽象，它的工作原理类似于 Nginx，可以理解成在<strong> Ingress 里建立诸多映射规则，Ingress Controller 通过监听这些配置规则并转化成 Nginx 的反向代理配置，然后对外部提供服务</strong>。在这里有两个核心概念：</p>\n<ul>\n<li>ingress：kubernetes 中的一个对象，作用是定义请求如何转发到 service 的规则</li>\n<li>ingress controller：具体实现反向代理及负载均衡的程序，对 ingress 定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如 Nginx, Contour, Haproxy 等等</li>\n</ul>\n<p>Ingress（以 Nginx 为例）的工作原理如下：</p>\n<ol>\n<li>用户编写 Ingress 规则，说明哪个域名对应 kubernetes 集群中的哪个 Service</li>\n<li>Ingress 控制器动态感知 Ingress 服务规则的变化，然后生成一段对应的 Nginx 反向代理配置</li>\n<li>Ingress 控制器会将生成的 Nginx 配置写入到一个运行着的 Nginx 服务中，并动态更新</li>\n<li>到此为止，其实真正在工作的就是一个 Nginx 了，内部配置了用户定义的请求转发规则</li>\n</ol>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200516112704764.png\" alt=\"img\" /></p>\n<h4 id=\"75-ingress使用\"><a class=\"anchor\" href=\"#75-ingress使用\">#</a> 7.5 Ingress 使用</h4>\n<h5 id=\"751-环境准备-搭建ingress环境\"><a class=\"anchor\" href=\"#751-环境准备-搭建ingress环境\">#</a> 7.5.1 环境准备 搭建 ingress 环境</h5>\n<figure class=\"highlight makefile\"><figcaption data-lang=\"makefile\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建文件夹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root<span class=\"token operator\">@</span>k8s-master01 ~]<span class=\"token comment\"># mkdir ingress-controller</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[root<span class=\"token operator\">@</span>k8s-master01 ~]<span class=\"token comment\"># cd ingress-controller/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 获取 ingress-nginx，本次案例使用的是 0.30 版本</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>[root<span class=\"token operator\">@</span>k8s-master01 ingress-controller]<span class=\"token comment\"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>[root<span class=\"token operator\">@</span>k8s-master01 ingress-controller]<span class=\"token comment\"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 修改 mandatory.yaml 文件中的仓库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 修改 quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 为 quay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 创建 ingress-nginx</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>[root<span class=\"token operator\">@</span>k8s-master01 ingress-controller]<span class=\"token comment\"># kubectl apply -f ./</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 查看 ingress-nginx</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>[root<span class=\"token operator\">@</span>k8s-master01 ingress-controller]<span class=\"token comment\"># kubectl get pod -n ingress-nginx</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME                                           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pod/nginx-ingress-controller-fbf967dd5-4qpbp   1/1     Running   0          12h</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 查看 service</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>[root<span class=\"token operator\">@</span>k8s-master01 ingress-controller]<span class=\"token comment\"># kubectl get svc -n ingress-nginx</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>                      AGE</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token target symbol\">ingress-nginx   NodePort   10.98.75.163   &lt;none>        80</span><span class=\"token punctuation\">:</span>32240/TCP,443<span class=\"token punctuation\">:</span>31335/TCP   11h</pre></td></tr></table></figure><h5 id=\"752-准备service和pod\"><a class=\"anchor\" href=\"#752-准备service和pod\">#</a> 7.5.2 准备 service 和 pod</h5>\n<p>为了后面的实验比较方便，创建如下图所示的模型</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200516102419998.png\" alt=\"img\" /></p>\n<p>创建 tomcat-nginx.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>deployment</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">-</span>deployment</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> tomcat</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">:</span>8.5<span class=\"token punctuation\">-</span>jre10<span class=\"token punctuation\">-</span>slim</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service</pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>service</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token key atrule\">clusterIP</span><span class=\"token punctuation\">:</span> None</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service</pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">-</span>service</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">-</span>pod</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token key atrule\">clusterIP</span><span class=\"token punctuation\">:</span> None</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f tomcat-nginx.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 查看</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc -n dev</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>    AGE</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx-service    ClusterIP   None         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP     48s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tomcat-service   ClusterIP   None         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">8080</span>/TCP   48s</pre></td></tr></table></figure><h5 id=\"753-http代理\"><a class=\"anchor\" href=\"#753-http代理\">#</a> 7.5.3 Http 代理</h5>\n<p>创建 ingress-http.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> extensions/v1beta1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ingress<span class=\"token punctuation\">-</span>http</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> nginx.itheima.com</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>service</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> tomcat.itheima.com</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">-</span>service</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f ingress-http.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ingress.extensions/ingress-http created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get ing ingress-http -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME           HOSTS                                  ADDRESS   PORTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ingress-http   nginx.itheima.com,tomcat.itheima.com             <span class=\"token number\">80</span>      22s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看详情</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe ing ingress-http  -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Rules:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Host                Path  Backends</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>----                ----  --------</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>nginx.itheima.com   / nginx-service:80 <span class=\"token punctuation\">(</span><span class=\"token number\">10.244</span>.1.96:80,10.244.1.97:80,10.244.2.112:80<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>tomcat.itheima.com  / tomcat-service:8080<span class=\"token punctuation\">(</span><span class=\"token number\">10.244</span>.1.94:8080,10.244.1.95:8080,10.244.2.111:8080<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 接下来，在本地电脑上配置 host 文件，解析上面的两个域名到 192.168.109.100 (master) 上</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 然后，就可以分别访问 tomcat.itheima.com:32240  和  nginx.itheima.com:32240 查看效果了</span></pre></td></tr></table></figure><h5 id=\"754-https代理\"><a class=\"anchor\" href=\"#754-https代理\">#</a> 7.5.4 Https 代理</h5>\n<p>创建证书</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 生成证书</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>openssl req <span class=\"token parameter variable\">-x509</span> <span class=\"token parameter variable\">-sha256</span> <span class=\"token parameter variable\">-nodes</span> <span class=\"token parameter variable\">-days</span> <span class=\"token number\">365</span> <span class=\"token parameter variable\">-newkey</span> rsa:2048 <span class=\"token parameter variable\">-keyout</span> tls.key <span class=\"token parameter variable\">-out</span> tls.crt <span class=\"token parameter variable\">-subj</span> <span class=\"token string\">\"/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 创建密钥</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kubectl create secret tls tls-secret <span class=\"token parameter variable\">--key</span> tls.key <span class=\"token parameter variable\">--cert</span> tls.crt</pre></td></tr></table></figure><p>创建 ingress-https.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> extensions/v1beta1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ingress<span class=\"token punctuation\">-</span>https</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token punctuation\">-</span> nginx.itheima.com</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">-</span> tomcat.itheima.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> tls<span class=\"token punctuation\">-</span>secret <span class=\"token comment\"># 指定秘钥</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> nginx.itheima.com</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>service</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> tomcat.itheima.com</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> tomcat<span class=\"token punctuation\">-</span>service</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f ingress-https.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ingress.extensions/ingress-https created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get ing ingress-https -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME            HOSTS                                  ADDRESS         PORTS     AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ingress-https   nginx.itheima.com,tomcat.itheima.com   <span class=\"token number\">10.104</span>.184.38   <span class=\"token number\">80</span>, <span class=\"token number\">443</span>   2m42s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看详情</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe ing ingress-https -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>TLS:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  tls-secret terminates nginx.itheima.com,tomcat.itheima.com</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Rules:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Host              Path Backends</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>----              ---- --------</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nginx.itheima.com  /  nginx-service:80 <span class=\"token punctuation\">(</span><span class=\"token number\">10.244</span>.1.97:80,10.244.1.98:80,10.244.2.119:80<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>tomcat.itheima.com /  tomcat-service:8080<span class=\"token punctuation\">(</span><span class=\"token number\">10.244</span>.1.99:8080,10.244.2.117:8080,10.244.2.120:8080<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 下面可以通过浏览器访问 https://nginx.itheima.com:31335 和 https://tomcat.itheima.com:31335 来查看了</span></pre></td></tr></table></figure><h3 id=\"8-数据存储\"><a class=\"anchor\" href=\"#8-数据存储\">#</a> 8. 数据存储</h3>\n<p>在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes 引入了 Volume 的概念。</p>\n<p>Volume 是 Pod 中能够被多个容器访问的共享目录，它被定义在 Pod 上，然后被一个 Pod 里的多个容器挂载到具体的文件目录下，kubernetes 通过 Volume 实现同一个 Pod 中不同容器之间的数据共享以及数据的持久化存储。Volume 的生命容器不与 Pod 中单个容器的生命周期相关，当容器终止或者重启时，Volume 中的数据也不会丢失。</p>\n<p>kubernetes 的 Volume 支持多种类型，比较常见的有下面几个：</p>\n<ul>\n<li>简单存储：EmptyDir、HostPath、NFS</li>\n<li>高级存储：PV、PVC</li>\n<li>配置存储：ConfigMap、Secret</li>\n</ul>\n<h4 id=\"81-基本存储\"><a class=\"anchor\" href=\"#81-基本存储\">#</a> 8.1 基本存储</h4>\n<h5 id=\"811-emptydir\"><a class=\"anchor\" href=\"#811-emptydir\">#</a> 8.1.1 EmptyDir</h5>\n<p>EmptyDir 是最基础的 Volume 类型，一个 EmptyDir 就是 Host 上的一个空目录。</p>\n<p>EmptyDir 是在 Pod 被分配到 Node 时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为 kubernetes 会自动分配一个目录，当 Pod 销毁时， EmptyDir 中的数据也会被永久删除。 EmptyDir 用途如下：</p>\n<ul>\n<li>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</li>\n<li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</li>\n</ul>\n<p>接下来，通过一个容器之间文件共享的案例来使用一下 EmptyDir。</p>\n<p>在一个 Pod 中准备两个容器 nginx 和 busybox，然后声明一个 Volume 分别挂在到两个容器的目录中，然后 nginx 容器负责向 Volume 中写日志，busybox 中通过命令将日志内容读到控制台。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200413174713773.png\" alt=\"img\" /></p>\n<p>创建一个 volume-emptydir.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> volume<span class=\"token punctuation\">-</span>emptydir</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 将 logs-volume 挂在到 nginx 容器中，对应的目录为 /var/log/nginx</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /var/log/nginx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"tail -f /logs/access.log\"</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 初始命令，动态读取指定文件中内容</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 将 logs-volume 挂在到 busybox 容器中，对应的目录为 /logs</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /logs</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 声明 volume， name 为 logs-volume，类型为 emptyDir</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">emptyDir</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f volume-emptydir.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/volume-emptydir created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods volume-emptydir -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>volume-emptydir       <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          97s   <span class=\"token number\">10.42</span>.2.9   node1  <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 通过 podIp 访问 nginx</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.42.2.9</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 通过 kubectl logs 命令查看指定容器的标准输出</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl logs -f volume-emptydir -n dev -c busybox</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">10.42</span>.1.0 - - <span class=\"token punctuation\">[</span><span class=\"token number\">27</span>/Jun/2021:15:08:54 +0000<span class=\"token punctuation\">]</span> <span class=\"token string\">\"GET / HTTP/1.1\"</span> <span class=\"token number\">200</span> <span class=\"token number\">612</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"curl/7.29.0\"</span> <span class=\"token string\">\"-\"</span></pre></td></tr></table></figure><h5 id=\"812-hostpath\"><a class=\"anchor\" href=\"#812-hostpath\">#</a> 8.1.2 HostPath</h5>\n<p>上节课提到，EmptyDir 中数据不会被持久化，它会随着 Pod 的结束而销毁，如果想简单的将数据持久化到主机中，可以选择 HostPath。</p>\n<p>HostPath 就是将 Node 主机中一个实际目录挂在到 Pod 中，以供容器使用，这样的设计就可以保证 Pod 销毁了，但是数据依据可以存在于 Node 主机上。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200413214031331.png\" alt=\"img\" /></p>\n<p>创建一个 volume-hostpath.yaml：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> volume<span class=\"token punctuation\">-</span>hostpath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /var/log/nginx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"tail -f /logs/access.log\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /logs</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /root/logs</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> DirectoryOrCreate  <span class=\"token comment\"># 目录存在就使用，不存在就先创建后使用</span></pre></td></tr></table></figure><pre><code>关于type的值的一点说明：\n    DirectoryOrCreate 目录存在就使用，不存在就先创建后使用\n    Directory   目录必须存在\n    FileOrCreate  文件存在就使用，不存在就先创建后使用\n    File 文件必须存在 \n    Socket  unix套接字必须存在\n    CharDevice  字符设备必须存在\n    BlockDevice 块设备必须存在\n</code></pre>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f volume-hostpath.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/volume-hostpath created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 Pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods volume-hostpath -n dev -o wide</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod-volume-hostpath   <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          16s   <span class=\"token number\">10.42</span>.2.10     node1  <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#访问 nginx</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.42.2.10</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl logs -f volume-emptydir -n dev -c busybox</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 接下来就可以去 host 的 /root/logs 目录下查看存储的文件了</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">###  注意：下面的操作需要到 Pod 所在的节点运行（案例中是 node1）</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@node1 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /root/logs/</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>access.log  error.log</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span></pre></td></tr></table></figure><h5 id=\"813-nfs\"><a class=\"anchor\" href=\"#813-nfs\">#</a> 8.1.3 NFS</h5>\n<p>HostPath 可以解决数据持久化的问题，但是一旦 Node 节点故障了，Pod 如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用 NFS、CIFS。</p>\n<p>NFS 是一个网络文件存储系统，可以搭建一台 NFS 服务器，然后将 Pod 中的存储直接连接到 NFS 系统上，这样的话，无论 Pod 在节点上怎么转移，只要 Node 跟 NFS 的对接没问题，数据就可以成功访问。</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200413215133559.png\" alt=\"img\" /></p>\n<p>1）首先要准备 nfs 的服务器，这里为了简单，直接是 master 节点做 nfs 服务器</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在 nfs 上安装 nfs 服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 准备一个共享目录</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /root/data/nfs -pv</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 将共享目录以读写权限暴露给 192.168.5.0/24 网段中的所有主机</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/exports</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># more /etc/exports</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/root/data/nfs     <span class=\"token number\">192.168</span>.5.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 启动 nfs 服务</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nfs</span></pre></td></tr></table></figure><p>2）接下来，要在的每个 node 节点上都安装下 nfs，这样的目的是为了 node 节点可以驱动 nfs 设备</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在 node 上安装 nfs 服务，注意不需要启动</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr></table></figure><p>3）接下来，就可以编写 pod 的配置文件了，创建 volume-nfs.yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> volume<span class=\"token punctuation\">-</span>nfs</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /var/log/nginx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"tail -f /logs/access.log\"</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /logs</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> logs<span class=\"token punctuation\">-</span>volume</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">nfs</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> 192.168.5.6  <span class=\"token comment\">#nfs 服务器地址</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /root/data/nfs <span class=\"token comment\">#共享文件路径</span></pre></td></tr></table></figure><p>4）最后，运行下 pod，观察结果</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f volume-nfs.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/volume-nfs created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods volume-nfs -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>volume-nfs        <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          2m9s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看 nfs 服务器上的共享目录，发现已经有文件了</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /root/data/</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>access.log  error.log</pre></td></tr></table></figure><h4 id=\"82-高级存储\"><a class=\"anchor\" href=\"#82-高级存储\">#</a> 8.2 高级存储</h4>\n<p>前面已经学习了使用 NFS 提供存储，此时就要求用户会搭建 NFS 系统，并且会在 yaml 配置 nfs。由于 kubernetes 支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够屏蔽底层存储实现的细节，方便用户使用， kubernetes 引入 PV 和 PVC 两种资源对象。</p>\n<ul>\n<li>\n<p>PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下 PV 由 kubernetes 管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p>\n</li>\n<li>\n<p>PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC 其实就是用户向 kubernetes 系统发出的一种资源需求申请。</p>\n</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200514194111567.png\" alt=\"img\" /></p>\n<p>使用了 PV 和 PVC 之后，工作可以得到进一步的细分：</p>\n<ul>\n<li>存储：存储工程师维护</li>\n<li>PV： kubernetes 管理员维护</li>\n<li>PVC：kubernetes 用户维护</li>\n</ul>\n<h5 id=\"821-pv\"><a class=\"anchor\" href=\"#821-pv\">#</a> 8.2.1 PV</h5>\n<p>PV 是存储资源的抽象，下面是资源清单文件:</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pv2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">nfs</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 存储类型，与底层真正存储对应</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 存储能力，目前只支持存储空间的设置</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 2Gi</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 访问模式</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 存储类别</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">persistentVolumeReclaimPolicy</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 回收策略</span></pre></td></tr></table></figure><p>PV 的关键配置参数说明：</p>\n<ul>\n<li>\n<p><strong>存储类型</strong></p>\n<p>底层实际存储的类型，kubernetes 支持多种存储类型，每种存储类型的配置都有所差异</p>\n</li>\n<li>\n<p><strong>存储能力（capacity）</strong></p>\n</li>\n</ul>\n<p>目前只支持存储空间的设置 (storage=1Gi)，不过未来可能会加入 IOPS、吞吐量等指标的配置</p>\n<ul>\n<li>\n<p><strong>访问模式（accessModes）</strong></p>\n<p>用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p>\n<ul>\n<li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</li>\n<li>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</li>\n<li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</li>\n</ul>\n<p><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></p>\n</li>\n<li>\n<p><strong>回收策略（persistentVolumeReclaimPolicy）</strong></p>\n<p>当 PV 不再被使用了之后，对其的处理方式。目前支持三种策略：</p>\n<ul>\n<li>Retain （保留） 保留数据，需要管理员手工清理数据</li>\n<li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li>\n<li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li>\n</ul>\n<p><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></p>\n</li>\n<li>\n<p><strong>存储类别</strong></p>\n<p>PV 可以通过 storageClassName 参数指定一个存储类别</p>\n<ul>\n<li>具有特定类别的 PV 只能与请求了该类别的 PVC 进行绑定</li>\n<li>未设定类别的 PV 则只能与不请求任何类别的 PVC 进行绑定</li>\n</ul>\n</li>\n<li>\n<p><strong>状态（status）</strong></p>\n<p>一个 PV 的生命周期中，可能会处于 4 中不同的阶段：</p>\n<ul>\n<li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li>\n<li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li>\n<li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li>\n<li>Failed（失败）： 表示该 PV 的自动回收失败</li>\n</ul>\n</li>\n</ul>\n<p><strong>实验</strong></p>\n<p>使用 NFS 作为存储，来演示 PV 的使用，创建 3 个 PV，对应 NFS 中的 3 个暴露的路径。</p>\n<ol>\n<li>准备 NFS 环境</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建目录</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /root/data/&#123;pv1,pv2,pv3&#125; -pv</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 暴露服务</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># more /etc/exports</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/root/data/pv1     <span class=\"token number\">192.168</span>.5.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>/root/data/pv2     <span class=\"token number\">192.168</span>.5.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/root/data/pv3     <span class=\"token number\">192.168</span>.5.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 重启服务</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  systemctl restart nfs</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>创建 pv.yaml</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span>  pv1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 1Gi</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">-</span> ReadWriteMany</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">persistentVolumeReclaimPolicy</span><span class=\"token punctuation\">:</span> Retain</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">nfs</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /root/data/pv1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> 192.168.5.6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span>  pv2</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 2Gi</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token punctuation\">-</span> ReadWriteMany</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token key atrule\">persistentVolumeReclaimPolicy</span><span class=\"token punctuation\">:</span> Retain</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token key atrule\">nfs</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /root/data/pv2</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> 192.168.5.6</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span>  pv3</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 3Gi</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token punctuation\">-</span> ReadWriteMany</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token key atrule\">persistentVolumeReclaimPolicy</span><span class=\"token punctuation\">:</span> Retain</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token key atrule\">nfs</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /root/data/pv3</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> 192.168.5.6</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pv</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pv.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>persistentvolume/pv1 created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>persistentvolume/pv2 created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>persistentvolume/pv3 created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 查看 pv</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv -o wide</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pv1    1Gi        RWX            Retain        Available    10s   Filesystem</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>pv2    2Gi        RWX            Retain        Available    10s   Filesystem</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pv3    3Gi        RWX            Retain        Available    9s    Filesystem</pre></td></tr></table></figure><h5 id=\"822-pvc\"><a class=\"anchor\" href=\"#822-pvc\">#</a> 8.2.2 PVC</h5>\n<p>PVC 是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pvc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 访问模式</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 采用标签对 PV 选择</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 存储类别</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 请求空间</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 5Gi</pre></td></tr></table></figure><p>PVC 的关键配置参数说明：</p>\n<ul>\n<li><strong>访问模式（accessModes）</strong></li>\n</ul>\n<p>用于描述用户应用对存储资源的访问权限</p>\n<ul>\n<li>\n<p><strong>选择条件（selector）</strong></p>\n<p>通过 Label Selector 的设置，可使 PVC 对于系统中己存在的 PV 进行筛选</p>\n</li>\n<li>\n<p><strong>存储类别（storageClassName）</strong></p>\n<p>PVC 在定义时可以设定需要的后端存储的类别，只有设置了该 class 的 pv 才能被系统选出</p>\n</li>\n<li>\n<p><strong>资源请求（Resources ）</strong></p>\n<p>描述对存储资源的请求</p>\n</li>\n</ul>\n<p><strong>实验</strong></p>\n<ol>\n<li>创建 pvc.yaml，申请 pv</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pvc1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> ReadWriteMany</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 1Gi</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pvc2</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">-</span> ReadWriteMany</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 1Gi</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pvc3</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">-</span> ReadWriteMany</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 1Gi</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pvc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pvc.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>persistentvolumeclaim/pvc1 created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>persistentvolumeclaim/pvc2 created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>persistentvolumeclaim/pvc3 created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 查看 pvc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc  -n dev -o wide</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 查看 pv</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv -o wide</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem</pre></td></tr></table></figure><ol start=\"2\">\n<li>创建 pods.yaml, 使用 pv</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"while true;do echo pod1 >> /root/out.txt; sleep 10; done;\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> volume</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /root/</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> volume</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> pvc1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">readOnly</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod2</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> busybox</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> busybox<span class=\"token punctuation\">:</span><span class=\"token number\">1.30</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"while true;do echo pod2 >> /root/out.txt; sleep 10; done;\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> volume</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /root/</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> volume</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> pvc2</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token key atrule\">readOnly</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pods.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod1 created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pod/pod2 created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pod1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14s   <span class=\"token number\">10.244</span>.1.69   node1   </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pod2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14s   <span class=\"token number\">10.244</span>.1.70   node1  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 查看 pvc</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc -n dev -o wide</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 查看 pv</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv -n dev -o wide</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 查看 nfs 中的文件存储</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># more /root/data/pv1/out.txt</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>node1</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>node1</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># more /root/data/pv2/out.txt</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>node2</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>node2</pre></td></tr></table></figure><h5 id=\"823-生命周期\"><a class=\"anchor\" href=\"#823-生命周期\">#</a> 8.2.3 生命周期</h5>\n<p>PVC 和 PV 是一一对应的，PV 和 PVC 之间的相互作用遵循以下生命周期：</p>\n<ul>\n<li>\n<p><strong>资源供应</strong>：管理员手动创建底层存储和 PV</p>\n</li>\n<li>\n<p><strong>资源绑定</strong>：用户创建 PVC，kubernetes 负责根据 PVC 的声明去寻找 PV，并绑定</p>\n<p>在用户定义好 PVC 之后，系统将根据 PVC 对存储资源的请求在已存在的 PV 中选择一个满足条件的</p>\n<ul>\n<li>一旦找到，就将该 PV 与用户定义的 PVC 进行绑定，用户的应用就可以使用这个 PVC 了</li>\n<li>如果找不到，PVC 则会无限期处于 Pending 状态，直到等到系统管理员创建了一个符合其要求的 PV</li>\n</ul>\n<p>PV 一旦绑定到某个 PVC 上，就会被这个 PVC 独占，不能再与其他 PVC 进行绑定了</p>\n</li>\n<li>\n<p><strong>资源使用</strong>：用户可在 pod 中像 volume 一样使用 pvc</p>\n<p>Pod 使用 Volume 的定义，将 PVC 挂载到容器内的某个路径进行使用。</p>\n</li>\n<li>\n<p><strong>资源释放</strong>：用户删除 pvc 来释放 pv</p>\n<p>当存储资源使用完毕后，用户可以删除 PVC，与该 PVC 绑定的 PV 将会被标记为 “已释放”，但还不能立刻与其他 PVC 进行绑定。通过之前 PVC 写入的数据可能还被留在存储设备上，只有在清除之后该 PV 才能再次使用。</p>\n</li>\n<li>\n<p><strong>资源回收</strong>：kubernetes 根据 pv 设置的回收策略进行资源的回收</p>\n<p>对于 PV，管理员可以设定回收策略，用于设置与之绑定的 PVC 释放资源之后如何处理遗留数据的问题。只有 PV 的存储空间完成回收，才能供新的 PVC 绑定和使用</p>\n</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200515002806726.png\" alt=\"img\" /></p>\n<h4 id=\"83-配置存储\"><a class=\"anchor\" href=\"#83-配置存储\">#</a> 8.3 配置存储</h4>\n<h5 id=\"831-configmap\"><a class=\"anchor\" href=\"#831-configmap\">#</a> 8.3.1 ConfigMap</h5>\n<p>ConfigMap 是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p>\n<p>创建 configmap.yaml，内容如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> configmap</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">info</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    username:admin</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    password:123456</span></pre></td></tr></table></figure><p>接下来，使用此配置文件创建 configmap</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 configmap</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f configmap.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>configmap/configmap created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 configmap 详情</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe cm configmap -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Name:         configmap</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Labels:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Annotations:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>info:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>----</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>username:admin</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>password:123456</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Events:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><p>接下来创建一个 pod-configmap.yaml，将上面创建的 configmap 挂载进去</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>configmap</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 将 configmap 挂载到目录</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> config</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /configmap/config</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 引用 configmap</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> config</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> configmap</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-configmap.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod-configmap created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod pod-configmap -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod-configmap   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#进入容器</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it pod-configmap -n dev /bin/sh</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># cd /configmap/config/</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>info</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># more info</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>username:admin</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>password:123456</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 可以看到映射已经成功，每个 configmap 都映射成了一个目录</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># key---> 文件     value----> 文件中的内容</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 此时如果更新 configmap 的内容，容器中的值也会动态更新</span></pre></td></tr></table></figure><h5 id=\"832-secret\"><a class=\"anchor\" href=\"#832-secret\">#</a> 8.3.2 Secret</h5>\n<p>在 kubernetes 中，还存在一种和 ConfigMap 非常类似的对象，称为 Secret 对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p>\n<ol>\n<li>首先使用 base64 对数据进行编码</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo -n 'admin' | base64 #准备 username</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">YWRtaW4</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo -n '123456' | base64 #准备 password</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>MTIzNDU2</pre></td></tr></table></figure><ol start=\"2\">\n<li>接下来编写 secret.yaml，并创建 Secret</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> secret</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Opaque</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> YWRtaW4=</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> MTIzNDU2</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 secret</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f secret.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>secret/secret created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 secret 详情</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe secret secret -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Name:         secret</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Labels:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Annotations:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Type:  Opaque</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>password:  <span class=\"token number\">6</span> bytes</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>username:  <span class=\"token number\">5</span> bytes</pre></td></tr></table></figure><ol start=\"3\">\n<li>创建 pod-secret.yaml，将上面创建的 secret 挂载进去：</li>\n</ol>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pod<span class=\"token punctuation\">-</span>secret</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.17.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 将 secret 挂载到目录</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> config</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /secret/config</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> config</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> secret</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pod-secret.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pod/pod-secret created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 查看 pod</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod pod-secret -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pod-secret      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m28s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 进入容器，查看 secret 信息，发现已经自动解码了</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it pod-secret /bin/sh -n dev</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>/ <span class=\"token comment\"># ls /secret/config/</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>password  username</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>/ <span class=\"token comment\"># more /secret/config/username</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>admin</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>/ <span class=\"token comment\"># more /secret/config/password</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">123456</span></pre></td></tr></table></figure><p>至此，已经实现了利用 secret 实现了信息的编码。</p>\n<h3 id=\"9-安全认证\"><a class=\"anchor\" href=\"#9-安全认证\">#</a> 9. 安全认证</h3>\n<h4 id=\"91-访问控制概述\"><a class=\"anchor\" href=\"#91-访问控制概述\">#</a> 9.1 访问控制概述</h4>\n<p>Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对 Kubernetes 的各种<strong>客户端</strong>进行<strong>认证和鉴权</strong>操作。</p>\n<p><strong>客户端</strong></p>\n<p>在 Kubernetes 集群中，客户端通常有两类：</p>\n<ul>\n<li><strong>User Account</strong>：一般是独立于 kubernetes 之外的其他服务管理的用户账号。</li>\n<li><strong>Service Account</strong>：kubernetes 管理的账号，用于为 Pod 中的服务进程在访问 Kubernetes 时提供身份标识。</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520102949189.png\" alt=\"img\" /></p>\n<p><strong>认证、授权与准入控制</strong></p>\n<p>ApiServer 是访问及管理资源对象的唯一入口。任何一个请求访问 ApiServer，都要经过下面三个流程：</p>\n<ul>\n<li>Authentication（认证）：身份鉴别，只有正确的账号才能够通过认证</li>\n<li>Authorization（授权）： 判断用户是否有权限对访问的资源执行特定的动作</li>\n<li>Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520103942580.png\" alt=\"img\" /></p>\n<h4 id=\"92-认证管理\"><a class=\"anchor\" href=\"#92-认证管理\">#</a> 9.2 认证管理</h4>\n<p>Kubernetes 集群安全的最关键点在于如何识别并认证客户端身份，它提供了 3 种客户端身份认证方式：</p>\n<ul>\n<li>\n<p>HTTP Base 认证：通过用户名 + 密码的方式认证</p>\n<pre><code>    这种认证方式是把“用户名:密码”用BASE64算法进行编码后的字符串放在HTTP请求中的Header Authorization域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。\n</code></pre>\n</li>\n<li>\n<p>HTTP Token 认证：通过一个 Token 来识别合法用户</p>\n<pre><code>    这种认证方式是用一个很长的难以被模仿的字符串--Token来表明客户身份的一种方式。每个Token对应一个用户名，当客户端发起API调用请求时，需要在HTTP Header里放入Token，API Server接到Token后会跟服务器中保存的token进行比对，然后进行用户身份认证的过程。\n</code></pre>\n</li>\n<li>\n<p>HTTPS 证书认证：基于 CA 根证书签名的双向数字证书认证方式</p>\n<pre><code>    这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。\n</code></pre>\n</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200518211037434.png\" alt=\"img\" /></p>\n<p><strong>HTTPS 认证大体分为 3 个过程：</strong></p>\n<ol>\n<li>\n<p>证书申请和下发</p>\n<pre><code>  HTTPS通信双方的服务器向CA机构申请证书，CA机构下发根证书、服务端证书及私钥给申请者\n</code></pre>\n</li>\n<li>\n<p>客户端和服务端的双向认证</p>\n<pre><code>  1&gt; 客户端向服务器端发起请求，服务端下发自己的证书给客户端，\n     客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥，\n     客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器\n  2&gt; 客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书，\n     在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法\n</code></pre>\n</li>\n<li>\n<p>服务器端和客户端进行通信</p>\n<pre><code>  服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。\n  服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密\n</code></pre>\n</li>\n</ol>\n<blockquote>\n<p>注意: Kubernetes 允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</p>\n</blockquote>\n<h4 id=\"93-授权管理\"><a class=\"anchor\" href=\"#93-授权管理\">#</a> 9.3 授权管理</h4>\n<p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后 Kubernetes 会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p>\n<p>每个发送到 ApiServer 的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p>\n<p>API Server 目前支持以下几种授权策略：</p>\n<ul>\n<li>AlwaysDeny：表示拒绝所有请求，一般用于测试</li>\n<li>AlwaysAllow：允许接收所有请求，相当于集群不需要授权流程（Kubernetes 默认的策略）</li>\n<li>ABAC：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</li>\n<li>Webhook：通过调用外部 REST 服务对用户进行授权</li>\n<li>Node：是一种专用模式，用于对 kubelet 发出的请求进行访问控制</li>\n<li>RBAC：基于角色的访问控制（kubeadm 安装方式下的默认选项）</li>\n</ul>\n<p>RBAC (Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情：<strong>给哪些对象授予了哪些权限</strong></p>\n<p>其中涉及到了下面几个概念：</p>\n<ul>\n<li>对象：User、Groups、ServiceAccount</li>\n<li>角色：代表着一组定义在资源上的可操作动作 (权限) 的集合</li>\n<li>绑定：将定义好的角色跟用户绑定在一起</li>\n</ul>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200519181209566.png\" alt=\"img\" /></p>\n<p>RBAC 引入了 4 个顶级资源对象：</p>\n<ul>\n<li>Role、ClusterRole：角色，用于指定一组权限</li>\n<li>RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</li>\n</ul>\n<p><strong>Role、ClusterRole</strong></p>\n<p>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Role 只能对命名空间内的资源进行授权，需要指定 nameapce</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Role</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>role</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 支持的 API 组列表，\"\" 空字符串，表示核心 API 群</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"pods\"</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 支持的资源对象列表</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 允许的对资源对象的操作方法列表</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># ClusterRole 可以对集群范围内资源、跨 namespaces 的范围资源、非资源类型进行授权</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>clusterrole</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"pods\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>需要详细说明的是，rules 中的参数：</p>\n<ul>\n<li>\n<p>apiGroups: 支持的 API 组列表</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"apps\"</span>, <span class=\"token string\">\"autoscaling\"</span>, <span class=\"token string\">\"batch\"</span></pre></td></tr></table></figure></li>\n<li>\n<p>resources：支持的资源对象列表</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token string\">\"services\"</span>, <span class=\"token string\">\"endpoints\"</span>, <span class=\"token string\">\"pods\"</span>,<span class=\"token string\">\"secrets\"</span>,<span class=\"token string\">\"configmaps\"</span>,<span class=\"token string\">\"crontabs\"</span>,<span class=\"token string\">\"deployments\"</span>,<span class=\"token string\">\"jobs\"</span>,</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token string\">\"nodes\"</span>,<span class=\"token string\">\"rolebindings\"</span>,<span class=\"token string\">\"clusterroles\"</span>,<span class=\"token string\">\"daemonsets\"</span>,<span class=\"token string\">\"replicasets\"</span>,<span class=\"token string\">\"statefulsets\"</span>,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token string\">\"horizontalpodautoscalers\"</span>,<span class=\"token string\">\"replicationcontrollers\"</span>,<span class=\"token string\">\"cronjobs\"</span></pre></td></tr></table></figure></li>\n<li>\n<p>verbs：对资源对象的操作方法列表</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"update\"</span>, <span class=\"token string\">\"patch\"</span>, <span class=\"token string\">\"delete\"</span>, <span class=\"token string\">\"exec\"</span></pre></td></tr></table></figure></li>\n</ul>\n<p><strong>RoleBinding、ClusterRoleBinding</strong></p>\n<p>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount。</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># RoleBinding 可以将同一 namespace 中的 subject 绑定到某个 Role 下，则此 subject 即具有该 Role 定义的权限</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> RoleBinding</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>role<span class=\"token punctuation\">-</span>binding</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> User</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> heima</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Role</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>role</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># ClusterRoleBinding 在整个集群级别和所有 namespaces 将特定的 subject 与 ClusterRole 绑定，授予权限</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRoleBinding</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>clusterrole<span class=\"token punctuation\">-</span>binding</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> User</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> heima</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>clusterrole</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><p><strong>RoleBinding 引用 ClusterRole 进行授权</strong></p>\n<p>RoleBinding 可以引用 ClusterRole，对属于同一命名空间内 ClusterRole 定义的资源主体进行授权。</p>\n<pre><code>    一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。\n</code></pre>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 虽然 authorization-clusterrole 是一个集群角色，但是因为使用了 RoleBinding</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 所以 heima 只能读取 dev 命名空间中的资源</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> RoleBinding</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>role<span class=\"token punctuation\">-</span>binding<span class=\"token punctuation\">-</span>ns</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> User</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> heima</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>clusterrole</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><p><strong>实战：创建一个只能管理 dev 空间下 Pods 资源的账号</strong></p>\n<ol>\n<li>创建账号</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1) 创建证书</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/kubernetes/pki/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># (umask 077;openssl genrsa -out devman.key 2048)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 2) 用 apiserver 的证书去签署</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 2-1) 签名申请，申请的用户是 devman, 组是 devgroup</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># openssl req -new -key devman.key -out devman.csr -subj \"/CN=devman/O=devgroup\"     </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 2-2) 签署证书</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 3) 设置集群、用户、上下文信息</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 切换账户到 devman</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl config use-context devman@kubernetes</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Switched to context <span class=\"token string\">\"devman@kubernetes\"</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 查看 dev 下 pod，发现没有权限</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Error from server <span class=\"token punctuation\">(</span>Forbidden<span class=\"token punctuation\">)</span>: pods is forbidden: User <span class=\"token string\">\"devman\"</span> cannot list resource <span class=\"token string\">\"pods\"</span> <span class=\"token keyword\">in</span> API group <span class=\"token string\">\"\"</span> <span class=\"token keyword\">in</span> the namespace <span class=\"token string\">\"dev\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 切换到 admin 账户</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl config use-context kubernetes-admin@kubernetes</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Switched to context <span class=\"token string\">\"kubernetes-admin@kubernetes\"</span><span class=\"token builtin class-name\">.</span></pre></td></tr></table></figure><p>2） 创建 Role 和 RoleBinding，为 devman 用户授权</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Role</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>role</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"pods\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> RoleBinding</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> authorization<span class=\"token punctuation\">-</span>role<span class=\"token punctuation\">-</span>binding</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> User</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> devman</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Role</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>role</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f dev-role.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>role.rbac.authorization.k8s.io/dev-role created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/authorization-role-binding created</pre></td></tr></table></figure><ol start=\"3\">\n<li>切换账户，再次验证</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 切换账户到 devman</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl config use-context devman@kubernetes</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Switched to context <span class=\"token string\">\"devman@kubernetes\"</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 再次查看</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                                 READY   STATUS             RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nginx-deployment-66cb59b984-8wp2k    <span class=\"token number\">1</span>/1     Running            <span class=\"token number\">0</span>          4d1h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nginx-deployment-66cb59b984-dc46j    <span class=\"token number\">1</span>/1     Running            <span class=\"token number\">0</span>          4d1h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nginx-deployment-66cb59b984-thfck    <span class=\"token number\">1</span>/1     Running            <span class=\"token number\">0</span>          4d1h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 为了不影响后面的学习，切回 admin 账户</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl config use-context kubernetes-admin@kubernetes</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Switched to context <span class=\"token string\">\"kubernetes-admin@kubernetes\"</span><span class=\"token builtin class-name\">.</span></pre></td></tr></table></figure><h4 id=\"94-准入控制\"><a class=\"anchor\" href=\"#94-准入控制\">#</a> 9.4 准入控制</h4>\n<p>通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver 才会处理这个请求。</p>\n<p>准入控制是一个可配置的控制器列表，可以通过在 Api-Server 上通过命令行设置选择执行哪些准入控制器：</p>\n<pre><code>--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,\n                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds\n</code></pre>\n<p>只有当所有的准入控制器都检查通过之后，apiserver 才执行该请求，否则返回拒绝。</p>\n<p>当前可配置的 Admission Control 准入控制如下：</p>\n<ul>\n<li>AlwaysAdmit：允许所有请求</li>\n<li>AlwaysDeny：禁止所有请求，一般用于测试</li>\n<li>AlwaysPullImages：在启动容器之前总去下载镜像</li>\n<li>DenyExecOnPrivileged：它会拦截所有想在 Privileged Container 上执行命令的请求</li>\n<li>ImagePolicyWebhook：这个插件将允许后端的一个 Webhook 程序来完成 admission controller 的功能。</li>\n<li>Service Account：实现 ServiceAccount 实现了自动化</li>\n<li>SecurityContextDeny：这个插件将使用 SecurityContext 的 Pod 中的定义全部失效</li>\n<li>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在 namespace 上的配额不会超标</li>\n<li>LimitRanger：用于资源限制管理，作用于 namespace 上，确保对 Pod 进行资源限制</li>\n<li>InitialResources：为未设置资源请求与限制的 Pod，根据其镜像的历史资源的使用情况进行设置</li>\n<li>NamespaceLifecycle：如果尝试在一个不存在的 namespace 中创建资源对象，则该创建请求将被拒绝。当删除一个 namespace 时，系统将会删除该 namespace 中所有对象。</li>\n<li>DefaultStorageClass：为了实现共享存储的动态供应，为未指定 StorageClass 或 PV 的 PVC 尝试匹配默认的 StorageClass，尽可能减少用户在申请 PVC 时所需了解的后端存储细节</li>\n<li>DefaultTolerationSeconds：这个插件为那些没有设置 forgiveness tolerations 并具有 notready:NoExecute 和 unreachable:NoExecute 两种 taints 的 Pod 设置默认的 “容忍” 时间，为 5min</li>\n<li>PodSecurityPolicy：这个插件用于在创建或修改 Pod 时决定是否根据 Pod 的 security context 和可用的 PodSecurityPolicy 对 Pod 的安全策略进行控制</li>\n</ul>\n<h3 id=\"10-dashboard\"><a class=\"anchor\" href=\"#10-dashboard\">#</a> 10. DashBoard</h3>\n<p>之前在 kubernetes 中完成的所有操作都是通过命令行工具 kubectl 完成的。其实，为了提供更丰富的用户体验，kubernetes 还开发了一个基于 web 的用户界面（Dashboard）。用户可以使用 Dashboard 部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理 kubernetes 中各种资源。</p>\n<h4 id=\"101-部署dashboard\"><a class=\"anchor\" href=\"#101-部署dashboard\">#</a> 10.1 部署 Dashboard</h4>\n<ol>\n<li>下载 yaml，并运行 Dashboard</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 下载 yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 修改 kubernetes-dashboard 的 Service 类型</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    k8s-app: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  name: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  namespace: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  type: NodePort  <span class=\"token comment\"># 新增</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    - port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      targetPort: <span class=\"token number\">8443</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      nodePort: <span class=\"token number\">30009</span>  <span class=\"token comment\"># 新增</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    k8s-app: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 部署</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f recommended.yaml</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># 查看 namespace 下的 kubernetes-dashboard 下的资源</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod,svc -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>NAME                                            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          111s</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>pod/kubernetes-dashboard-56484d4c5-z95z5        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          111s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>         AGE</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>service/dashboard-metrics-scraper  ClusterIP  <span class=\"token number\">10.96</span>.89.218    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>       <span class=\"token number\">8000</span>/TCP        111s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>service/kubernetes-dashboard       NodePort   <span class=\"token number\">10.104</span>.178.171  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>       <span class=\"token number\">443</span>:30009/TCP   111s</pre></td></tr></table></figure><p>2）创建访问账户，获取 token</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建账号</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01-1 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 授权</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01-1 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 获取账号 token</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   <span class=\"token number\">3</span>      2m35s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Name:         dashboard-admin-token-xbqhh</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Namespace:    kubernetes-dashboard</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Labels:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Annotations:  kubernetes.io/service-account.name: dashboard-admin</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Type:  kubernetes.io/service-account-token</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Data</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>namespace:  <span class=\"token number\">20</span> bytes</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>ca.crt:     <span class=\"token number\">1025</span> bytes</pre></td></tr></table></figure><p>3）通过浏览器访问 Dashboard 的 UI</p>\n<p>在登录页面上输入上面的 token</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520144548997.png\" alt=\"image-20200520144548997\" /></p>\n<p>出现下面的页面代表成功</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520144959353.png\" alt=\"image-20200520144959353\" /></p>\n<h4 id=\"102-使用dashboard\"><a class=\"anchor\" href=\"#102-使用dashboard\">#</a> 10.2 使用 DashBoard</h4>\n<p>本章节以 Deployment 为例演示 DashBoard 的使用</p>\n<p><strong>查看</strong></p>\n<p>选择指定的命名空间 <code>dev</code> ，然后点击 <code>Deployments</code> ，查看 dev 空间下的所有 deployment</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520154628679.png\" alt=\"img\" /></p>\n<p><strong>扩缩容</strong></p>\n<p>在 <code>Deployment</code>  上点击 <code>规模</code> ，然后指定 <code>目标副本数量</code> ，点击确定</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520162605102.png\" alt=\"img\" /></p>\n<p><strong>编辑</strong></p>\n<p>在 <code>Deployment</code>  上点击 <code>编辑</code> ，然后修改 <code>yaml文件</code> ，点击确定</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520163253644.png\" alt=\"image-20200520163253644\" /></p>\n<p><strong>查看 Pod</strong></p>\n<p>点击 <code>Pods</code> , 查看 pods 列表</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520163552110.png\" alt=\"img\" /></p>\n<p><strong>操作 Pod</strong></p>\n<p>选中某个 Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</p>\n<p><img data-src=\"http://oss.itshare.work/blog-images/image-20200520163832827.png\" alt=\"img\" /></p>\n<blockquote>\n<p>Dashboard 提供了 kubectl 的绝大部分功能，这里不再一一演示</p>\n</blockquote>\n",
            "tags": [
                "Kubernetes",
                "Kubernetes"
            ]
        },
        {
            "id": "http://blog.itshare.work/Kubernetes/Kubernetes%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/",
            "url": "http://blog.itshare.work/Kubernetes/Kubernetes%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/",
            "title": "Kubernetes读书笔记",
            "date_published": "2023-05-12T13:42:08.000Z",
            "content_html": "<h1 id=\"kubernetes-读书笔记\"><a class=\"anchor\" href=\"#kubernetes-读书笔记\">#</a> Kubernetes 读书笔记</h1>\n<h2 id=\"service\"><a class=\"anchor\" href=\"#service\">#</a> Service</h2>\n<p>Kubernetes 中， Service 是分布式集群架构的核心 。一个 Service 对象拥有如下关键特征:</p>\n<ul>\n<li>拥有唯一指定的名称 (比如 mysql- serve)</li>\n<li>拥有一个虚拟 IP 地址 (ClusterI 地址) 和端口号</li>\n<li>能够提供某种远程服务能力</li>\n<li>能够将客户端对服务的访问请求转发到一组容器应用上</li>\n</ul>\n<h2 id=\"pod\"><a class=\"anchor\" href=\"#pod\">#</a> Pod</h2>\n<p>为什么 Kubernetes 会设计出一个全新的 Pod 概念并且 Pod 有这样特殊的组成结构？原因如下:</p>\n<ul>\n<li>为多进程之间的协作提供一个抽象模型，使用 Pod 作为基本的调度、复制等管理工作的最小单位，让多个应用进程能一起有效地调度和伸缩。</li>\n<li>Pod 里的多个业务容器共享 Pause 容器的 IP, 共享 Pause 容器挂接的 Volume, 这样既简化了密切关联的业务容器之间的通信问题，也很好地解决了它们之间的文件共享问题</li>\n</ul>\n<h3 id=\"查看pod描述信息\"><a class=\"anchor\" href=\"#查看pod描述信息\">#</a> 查看 Pod 描述信息</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看所有的 Pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl get pods</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 查看 Pod 描述信息</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kubectl describe pod xxx</pre></td></tr></table></figure><h2 id=\"clusterip\"><a class=\"anchor\" href=\"#clusterip\">#</a> ClusterIP</h2>\n<p>ClusterIP 地址是一种虚拟 IP 地址，原因有以下几点：</p>\n<ul>\n<li>\n<p>ClusterIP 地址仅仅作用于 Kubernetes Service 这个对象，并由 Kubernetes 管理和分配 IP 地址（来源于 ClusterIP 地址池），与 Node 和 Master 所在的物理网络完全无关</p>\n</li>\n<li>\n<p>因为没有一个 “实体网络对象” 来响应，所以 ClusterIP 地址无法被 Ping 通。ClusterIP 地址只能与 Service Port 组成一个具体的服务访问端点，单独的 ClusterIP<br />\n 不具备 TCP/IP 通信的基础</p>\n</li>\n<li>\n<p>ClusterIP 属于 Kubernetes 集群这个封闭的空间，集群外的节点要访问这个通信端口，则需要做一些额外的工作</p>\n</li>\n</ul>\n<h2 id=\"kubernetes的三种ip\"><a class=\"anchor\" href=\"#kubernetes的三种ip\">#</a> Kubernetes 的三种 IP</h2>\n<ul>\n<li>Node IP:Node 的 IP 地址</li>\n<li>Pod IP:Pod 的 P 地址</li>\n<li>Service IP:Service 的 IP 地址</li>\n</ul>\n",
            "tags": [
                "Kubernetes",
                "Kubernetes"
            ]
        },
        {
            "id": "http://blog.itshare.work/Linux/tomcat/tomcat/",
            "url": "http://blog.itshare.work/Linux/tomcat/tomcat/",
            "title": "tomcat",
            "date_published": "2023-05-07T05:03:38.000Z",
            "content_html": "<h1 id=\"正在创作中请稍等\"><a class=\"anchor\" href=\"#正在创作中请稍等\">#</a> 正在创作中请稍等</h1>\n",
            "tags": [
                "Linux",
                "tomcat",
                "Linux从入门到放弃"
            ]
        },
        {
            "id": "http://blog.itshare.work/zabbix/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/",
            "url": "http://blog.itshare.work/zabbix/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/",
            "title": "zabbix5部署安装",
            "date_published": "2023-05-02T13:33:16.000Z",
            "content_html": "<h1 id=\"选择服务器平台\"><a class=\"anchor\" href=\"#选择服务器平台\">#</a> 选择服务器平台</h1>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">zabbix 版本</th>\n<th style=\"text-align:center\">OS 分布</th>\n<th style=\"text-align:center\">OS 版本</th>\n<th style=\"text-align:center\">zabbix component</th>\n<th style=\"text-align:center\">数据库</th>\n<th style=\"text-align:center\">web server</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">5.0LTS</td>\n<td style=\"text-align:center\">CentOS</td>\n<td style=\"text-align:center\">7</td>\n<td style=\"text-align:center\">Server,Forontend,Agent</td>\n<td style=\"text-align:center\">MySQL</td>\n<td style=\"text-align:center\">Nginx</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"安装和配置zabbix\"><a class=\"anchor\" href=\"#安装和配置zabbix\">#</a> 安装和配置 zabbix</h1>\n<h2 id=\"安装zabbix仓库\"><a class=\"anchor\" href=\"#安装zabbix仓库\">#</a> 安装 zabbix 仓库</h2>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># yum clean all</span></pre></td></tr></table></figure><h2 id=\"安装zabbix\"><a class=\"anchor\" href=\"#安装zabbix\">#</a> 安装 zabbix</h2>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 安装 Zabbix server，Web 前端，agent</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># yum install zabbix-server-mysql zabbix-agent</span></pre></td></tr></table></figure><h2 id=\"安装zabbix-frontend\"><a class=\"anchor\" href=\"#安装zabbix-frontend\">#</a> 安装 Zabbix frontend</h2>\n<p>启用红帽软件集合</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install centos-release-scl</span></pre></td></tr></table></figure><p>编辑配置文件</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/etc/yum.repos.d/zabbix.repo and <span class=\"token builtin class-name\">enable</span> zabbix-frontend repository.</pre></td></tr></table></figure><figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改 enable 的值为 1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>zabbix-frontend<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>安装 Zabbix frontend 包</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install zabbix-web-mysql-scl zabbix-nginx-conf-scl</span></pre></td></tr></table></figure><h2 id=\"创建初始数据库\"><a class=\"anchor\" href=\"#创建初始数据库\">#</a> 创建初始数据库</h2>\n<ul>\n<li>注意：MySQL 数据库的安装这里不做说明</li>\n</ul>\n<p>在数据库主机上运行以下代码</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># mysql -uroot -p</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>password</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mysql<span class=\"token operator\">></span> create database zabbix character <span class=\"token builtin class-name\">set</span> utf8 collate utf8_bin<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mysql<span class=\"token operator\">></span> create user zabbix@localhost identified by <span class=\"token string\">'password'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all privileges on zabbix.* to zabbix@localhost<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> global log_bin_trust_function_creators <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mysql<span class=\"token operator\">></span> quit<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>导入初始架构和数据</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix</span></pre></td></tr></table></figure><p>在导入数据库后禁用 log_bin_trust_function_creators 选项</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># mysql -uroot -p</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>password</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> global log_bin_trust_function_creators <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mysql<span class=\"token operator\">></span> quit<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"zabbix-server配置数据库\"><a class=\"anchor\" href=\"#zabbix-server配置数据库\">#</a> zabbix server 配置数据库</h2>\n<p>编辑配置文件 /etc/zabbix/zabbix_server.conf</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">DBPassword</span><span class=\"token operator\">=</span>password</pre></td></tr></table></figure><h2 id=\"zabbix前端配置php\"><a class=\"anchor\" href=\"#zabbix前端配置php\">#</a> zabbix 前端配置 PHP</h2>\n<p>编辑配置文件 /etc/opt/rh/rh-nginx116/nginx/conf.d/zabbix.conf uncomment and set 'listen' and'server_name' directives.</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># listen 80;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># server_name example.com;</span></pre></td></tr></table></figure><p>编辑配置文件 /etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf add nginx to listen.acl_users directive.</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>listen.acl_users <span class=\"token operator\">=</span> apache,nginx</pre></td></tr></table></figure><p>取消注释，设置正确的时区。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>php_value<span class=\"token punctuation\">[</span>date.timezone<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Asia/Shanghai</pre></td></tr></table></figure><h2 id=\"启动zabbix-server和agent进程\"><a class=\"anchor\" href=\"#启动zabbix-server和agent进程\">#</a> 启动 Zabbix server 和 agent 进程</h2>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl restart zabbix-server zabbix-agent rh-nginx116-nginx rh-php72-php-fpm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable zabbix-server zabbix-agent rh-nginx116-nginx rh-php72-php-fpm</span></pre></td></tr></table></figure><h1 id=\"开始使用zabbix\"><a class=\"anchor\" href=\"#开始使用zabbix\">#</a> 开始使用 zabbix</h1>\n<p>浏览器中输入 http://example.com/zabbix （即解析的域名或者 IP）</p>\n<ul>\n<li>注意：使用过程这里不叙述</li>\n</ul>\n",
            "tags": [
                "zabbix",
                "Linux从入门到放弃"
            ]
        },
        {
            "id": "http://blog.itshare.work/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/",
            "url": "http://blog.itshare.work/Kubernetes/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/",
            "title": "搭建Kubernetes集群",
            "date_published": "2023-03-20T16:14:18.000Z",
            "content_html": "<h1 id=\"搭建kubernetes集群\"><a class=\"anchor\" href=\"#搭建kubernetes集群\">#</a> 搭建 Kubernetes 集群</h1>\n<h2 id=\"部署前提\"><a class=\"anchor\" href=\"#部署前提\">#</a> 部署前提</h2>\n<ul>\n<li>使用 kubeadm 部署 Kubernetes 集群的前提条件</li>\n<li>支持 Kubernetes 运行的 Linux 主机，例如 Debian、RedHat 及其变体等</li>\n<li>每主机 2GB 以上的内存，以及 2 颗以上的 CPU</li>\n<li>各主机间能够通过网络无障碍通信</li>\n<li>独占的 hostname、MAC 地址以及 product_uuid，主机名能够正常解析</li>\n<li>放行由 Kubernetes 使用到的各端口，或直接禁用 iptables</li>\n<li>禁用各主机的上的 Swap 设备</li>\n<li>各主机时间同步</li>\n</ul>\n<h2 id=\"部署环境\"><a class=\"anchor\" href=\"#部署环境\">#</a> 部署环境</h2>\n<ul>\n<li>OS: Ubuntu 20.04.2 LTS</li>\n<li>Docker：20.10.10，CGroup Driver: systemd</li>\n<li>Kubernetes：v1.26.3, CRI: containerd, CNI: Flannel</li>\n<li>主机</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>主机 IP</th>\n<th>主机名称</th>\n<th>角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.32.200</td>\n<td><span class=\"exturl\" data-url=\"aHR0cDovL2s4cy1tYXN0ZXIwMS5vcmc=\">k8s-master01.org</span></td>\n<td>master</td>\n</tr>\n<tr>\n<td>192.168.32.203</td>\n<td><span class=\"exturl\" data-url=\"aHR0cDovL2s4cy1ub2RlMDEub3Jn\">k8s-node01.org</span></td>\n<td>node01</td>\n</tr>\n<tr>\n<td>192.168.32.204</td>\n<td><span class=\"exturl\" data-url=\"aHR0cDovL2s4cy1ub2RlMDIub3Jn\">k8s-node02.org</span></td>\n<td>node02</td>\n</tr>\n<tr>\n<td>192.168.32.205</td>\n<td><span class=\"exturl\" data-url=\"aHR0cDovL2s4cy1ub2RlMDMub3Jn\">k8s-node03.org</span></td>\n<td>node03</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"修改主机名称\"><a class=\"anchor\" href=\"#修改主机名称\">#</a> 修改主机名称</h2>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改 192.168.32.200 的主机名称为 k8s-master01.org</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 修改 192.168.32.203 的主机名称为 k8s-node01.org</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 修改 192.168.32.204 的主机名称为 k8s-node02.org</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 修改 192.168.32.205 的主机名称为 k8s-node03.org</span></pre></td></tr></table></figure><h2 id=\"主机时间同步\"><a class=\"anchor\" href=\"#主机时间同步\">#</a> 主机时间同步</h2>\n<p>在所有主机上安装 chrony</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">## 所有主机上执行</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># apt install -y chrony</span></pre></td></tr></table></figure><p>建议用户配置使用本地的的时间服务器，在节点数量众多时尤其如此。存在可用的本地时间服务器时，修改节点的 /etc/chrony/chrony.conf 配置文件，并将时间服务器指向相应的主机即可，配置格式如下：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>server CHRONY-SERVER-NAME-OR-IP iburst</pre></td></tr></table></figure><h2 id=\"主机名称解析\"><a class=\"anchor\" href=\"#主机名称解析\">#</a> 主机名称解析</h2>\n<p>出于简化配置步骤的目的，本测试环境使用 hosts 文件进行各节点名称解析，文件内容如下所示。其中，我们使用 kubeapi 主机名作为 API Server 在高可用环境中的专用接入名称，也为控制平面的高可用配置留下便于配置的余地。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 编辑 /etc/hosts 文件加入如下内容</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># vim /etc/hosts</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.32.200 k8s-master01.org</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.32.203 k8s-node01.org</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.32.204 k8s-node02.org</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">192.168</span>.32.205 k8s-node03.org</pre></td></tr></table></figure><h2 id=\"禁用swap设备\"><a class=\"anchor\" href=\"#禁用swap设备\">#</a> 禁用 Swap 设备</h2>\n<p>部署集群时，kubeadm 默认会预先检查当前主机是否禁用了 Swap 设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的 Swap 设备，否则，就需要在后文的 kubeadm init 及 kubeadm join 命令执行时额外使用相关的选项忽略检查错误。</p>\n<p>关闭 Swap 设备，需要分两步完成。首先是关闭当前已启用的所有 Swap 设备：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 临时关闭，所有机器执行</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># swapoff -a</span></pre></td></tr></table></figure><p>而后编辑 /etc/fstab 配置文件，注释用于挂载 Swap 设备的所有行</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 所有机器执行</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#vim /etc/fstab</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 注释如下一行</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#/swap.img      none    swap    sw      0       0</span></pre></td></tr></table></figure><h2 id=\"禁用默认的防火墙服务\"><a class=\"anchor\" href=\"#禁用默认的防火墙服务\">#</a> 禁用默认的防火墙服务</h2>\n<p>Ubuntu 和 Debian 等 Linux 发行版默认使用 ufw（Uncomplicated FireWall）作为前端来简化 iptables 的使用，处于启用状态时，它默认会生成一些规则以加强系统安全。出于降低配置复杂度之目的，本文选择直接将其禁用。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># ufw disable</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Firewall stopped and disabled on system startup</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># ufw status</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Status: inactive</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#</span></pre></td></tr></table></figure><h2 id=\"安装程序包\"><a class=\"anchor\" href=\"#安装程序包\">#</a> 安装程序包</h2>\n<p>提示：以下操作需要在本示例中的所有四台主机上分别进行</p>\n<h3 id=\"安装并启动docker\"><a class=\"anchor\" href=\"#安装并启动docker\">#</a> 安装并启动 docker</h3>\n<p>首先，生成 docker-ce 相关程序包的仓库，这里以阿里云的镜像服务器为例进行说明<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9taXJyb3IvZG9ja2VyLWNlP3NwbT1hMmM2aC4xMzY1MTEwMi4wLjAuM2UyMjFiMTFld0FsMnI=\"> docker-ce 镜像_docker-ce 下载地址_docker-ce 安装教程 - 阿里巴巴开源镜像站 (aliyun.com)</span></p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># step 1: 安装必要的一些系统工具</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token parameter variable\">-y</span> <span class=\"token function\">install</span> apt-transport-https ca-certificates <span class=\"token function\">curl</span> software-properties-common</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># step 2: 安装 GPG 证书</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> apt-key <span class=\"token function\">add</span> -</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># Step 3: 写入软件源信息</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sudo</span> add-apt-repository <span class=\"token string\">\"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class=\"token variable\"><span class=\"token variable\">$(</span>lsb_release <span class=\"token parameter variable\">-cs</span><span class=\"token variable\">)</span></span> stable\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># Step 4: 更新并安装 Docker-CE</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token parameter variable\">-y</span> update</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token parameter variable\">-y</span> <span class=\"token function\">install</span> docker-ce</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 安装指定版本的 Docker-CE:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># Step 1: 查找 Docker-CE 的版本:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># apt-cache madison docker-ce</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># Step 2: 安装指定版本的 Docker-CE: (VERSION 例如上面的 17.03.1~ce-0~ubuntu-xenial)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># sudo apt-get -y install docker-ce=[VERSION]</span></pre></td></tr></table></figure><p>本文以为 20.10.10 版本为例</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-node3:~<span class=\"token comment\"># apt install docker-ce=5:20.10.10~3-0~ubuntu-focal docker-ce-cli=5:20.10.10~3-0~ubuntu-focal</span></pre></td></tr></table></figure><p>kubelet 需要让 docker 容器引擎使用 systemd 作为 CGroup 的驱动，其默认值为 cgroupfs，因而，我们还需要编辑 docker 的配置文件 /etc/docker/daemon.json，添加如下内容，其中的 registry-mirrors 用于指明使用的镜像加速服务。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/docker/daemon.json</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"https://ung2thfc.mirror.aliyuncs.com\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token string\">\"https://mirror.ccs.tencentyun.com\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token string\">\"https://registry.docker-cn.com\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token string\">\"http://hub-mirror.c.163.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span><span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>systemctl daemon-reload <span class=\"token operator\">&amp;&amp;</span> systemctl restart <span class=\"token function\">docker</span></pre></td></tr></table></figure><h2 id=\"安装cri-dockerd\"><a class=\"anchor\" href=\"#安装cri-dockerd\">#</a> 安装 cri-dockerd</h2>\n<p>Kubernetes 自 v1.24 移除了对 docker-shim 的支持，而 Docker Engine 默认又不支持 CRI 规范，因而二者将无法直接完成整合。为此，Mirantis 和 Docker 联合创建了 cri-dockerd 项目，用于为 Docker Engine 提供一个能够支持到 CRI 规范的垫片，从而能够让 Kubernetes 基于 CRI 控制 Docker 。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL01pcmFudGlzL2NyaS1kb2NrZXJk\">项目地址</span></p>\n<p>cri-dockerd 项目提供了预制的二进制格式的程序包，用户按需下载相应的系统和对应平台的版本即可完成安装，这里以 Ubuntu 2004 64bits 系统环境，以及 cri-dockerd 目前最新的程序版本 v0.3.0 为例。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.0/cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dpkg <span class=\"token parameter variable\">-i</span> cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb</pre></td></tr></table></figure><p>完成安装后，相应的服务 cri-dockerd.service 便会自动启动。我们也可以使用如下命令进行验证，若服务处于 Running 状态即可进行后续步骤 。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># systemctl status cri-docker.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>● cri-docker.service - CRI Interface <span class=\"token keyword\">for</span> Docker Application Container Engine</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     Loaded: loaded <span class=\"token punctuation\">(</span>/lib/systemd/system/cri-docker.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: enabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Tue <span class=\"token number\">2023</span>-03-21 <span class=\"token number\">10</span>:59:57 CST<span class=\"token punctuation\">;</span> 1min 20s ago</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>TriggeredBy: ● cri-docker.socket</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>       Docs: https://docs.mirantis.com</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   Main PID: <span class=\"token number\">17591</span> <span class=\"token punctuation\">(</span>cri-dockerd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      Tasks: <span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     Memory: <span class=\"token number\">11</span>.9M</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     CGroup: /system.slice/cri-docker.service</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>             └─17591 /usr/bin/cri-dockerd --container-runtime-endpoint fd://</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:57 k8s-master01.org cri-dockerd<span class=\"token punctuation\">[</span><span class=\"token number\">17591</span><span class=\"token punctuation\">]</span>: <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-03-21T10:59:57+08:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Start docker client with request timeout 0s\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:57 k8s-master01.org cri-dockerd<span class=\"token punctuation\">[</span><span class=\"token number\">17591</span><span class=\"token punctuation\">]</span>: <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-03-21T10:59:57+08:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Hairpin mode is set to none\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:57 k8s-master01.org cri-dockerd<span class=\"token punctuation\">[</span><span class=\"token number\">17591</span><span class=\"token punctuation\">]</span>: <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-03-21T10:59:57+08:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Loaded network plugin cni\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:57 k8s-master01.org cri-dockerd<span class=\"token punctuation\">[</span><span class=\"token number\">17591</span><span class=\"token punctuation\">]</span>: <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-03-21T10:59:57+08:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Docker cri networking managed by network plugin cni\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:57 k8s-master01.org systemd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>: Started CRI Interface <span class=\"token keyword\">for</span> Docker Application Container Engine.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:58 k8s-master01.org cri-dockerd<span class=\"token punctuation\">[</span><span class=\"token number\">17591</span><span class=\"token punctuation\">]</span>: <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-03-21T10:59:57+08:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Docker Info: &amp;&#123;ID:WQBA:P7R2:H6ZI:KWU3:FVFW:MHLC:QTT7:CJCX></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=\"</span><span class=\"token number\">2023</span>-03-21T10:59:57+08:00<span class=\"token string\">\" level=info msg=\"</span>Setting cgroupDriver cgroupfs<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=\"</span><span class=\"token number\">2023</span>-03-21T10:59:57+08:00<span class=\"token string\">\" level=info msg=\"</span>Docker cri received runtime config <span class=\"token operator\">&amp;</span>RuntimeConfig<span class=\"token punctuation\">&#123;</span>Network<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:58 k8s-master01.org cri-dockerd<span class=\"token punctuation\">[</span><span class=\"token number\">17591</span><span class=\"token punctuation\">]</span>: <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-03-21T10:59:57+08:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Starting the GRPC backend for the Docker CRI interface.\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Mar <span class=\"token number\">21</span> <span class=\"token number\">10</span>:59:58 k8s-master01.org cri-dockerd<span class=\"token punctuation\">[</span><span class=\"token number\">17591</span><span class=\"token punctuation\">]</span>: <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token string\">\"2023-03-21T10:59:57+08:00\"</span> <span class=\"token assign-left variable\">level</span><span class=\"token operator\">=</span>info <span class=\"token assign-left variable\">msg</span><span class=\"token operator\">=</span><span class=\"token string\">\"Start cri-dockerd grpc backend\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>lines <span class=\"token number\">1</span>-21/21 <span class=\"token punctuation\">(</span>END<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"安装kubelet-kubeadm和kubectl\"><a class=\"anchor\" href=\"#安装kubelet-kubeadm和kubectl\">#</a> 安装 kubelet、kubeadm 和 kubectl</h2>\n<p>首先，在各主机上生成 kubelet 和 kubeadm 等相关程序包的仓库，这里以阿里云的镜像服务为例</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> apt-transport-https</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class=\"token operator\">|</span> apt-key <span class=\"token function\">add</span> - </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span>/etc/apt/sources.list.d/kubernetes.list</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> kubelet kubeadm kubectl</pre></td></tr></table></figure><p>安装完成后，要确保 kubeadm 等程序文件的版本，这将也是后面初始化 Kubernetes 集群时需要明确指定的版本号</p>\n<h3 id=\"整合kubelet和cri-dockerd\"><a class=\"anchor\" href=\"#整合kubelet和cri-dockerd\">#</a> 整合 kubelet 和 cri-dockerd</h3>\n<p>仅支持 CRI 规范的 kubelet 需要经由遵循该规范的 cri-dockerd 完成与 docker-ce 的整合。</p>\n<h3 id=\"配置cri-dockerd\"><a class=\"anchor\" href=\"#配置cri-dockerd\">#</a> 配置 cri-dockerd</h3>\n<p>配置 cri-dockerd，确保其能够正确加载到 CNI 插件。编辑 /usr/lib/systemd/system/cri-docker.service 文件，确保其 [Service] 配置段中的 ExecStart 的值类似如下内容</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --network-plugin<span class=\"token operator\">=</span>cni --pod-infra-container-image<span class=\"token operator\">=</span>registry.aliyuncs.com/google_containers/pause:3.7 --cni-bin-dir<span class=\"token operator\">=</span>/opt/cni/bin --cni-cache-dir<span class=\"token operator\">=</span>/var/lib/cni/cache --cni-conf-dir<span class=\"token operator\">=</span>/etc/cni/net.d</pre></td></tr></table></figure><p>需要添加的各配置参数（各参数的值要与系统部署的 CNI 插件的实际路径相对应）：</p>\n<ul>\n<li>--network-plugin：指定网络插件规范的类型，这里要使用 CNI；</li>\n<li>--cni-bin-dir：指定 CNI 插件二进制程序文件的搜索目录；</li>\n<li>--cni-cache-dir：CNI 插件使用的缓存目录；</li>\n<li>--cni-conf-dir：CNI 插件加载配置文件的目录；</li>\n</ul>\n<p>配置完成后，重载并重启 cri-docker.service 服务。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># systemctl daemon-reload;systemctl restart cri-docker</span></pre></td></tr></table></figure><h2 id=\"配置kubelet\"><a class=\"anchor\" href=\"#配置kubelet\">#</a> 配置 kubelet</h2>\n<p>配置 kubelet，为其指定 cri-dockerd 在本地打开的 Unix Sock 文件的路径，该路径一般默认为 “/run/cri-dockerd.sock“。编辑文件 /etc/sysconfig/kubelet，为其添加 如下指定参数。</p>\n<blockquote>\n<p>提示：若 /etc/sysconfig 目录不存在，则需要先创建该目录。</p>\n</blockquote>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">KUBELET_KUBEADM_ARGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock\"</span></pre></td></tr></table></figure><p>需要说明的是，该配置也可不进行，而是直接在后面的各 kubeadm 命令上使用 “--cri-socket unix:///run/cri-dockerd.sock” 选项。</p>\n<h3 id=\"初始化第一个主节点\"><a class=\"anchor\" href=\"#初始化第一个主节点\">#</a> 初始化第一个主节点</h3>\n<p>该步骤开始尝试构建 Kubernetes 集群的 master 节点，配置完成后，各 worker 节点直接加入到集群中的即可。需要特别说明的是，由 kubeadm 部署的 Kubernetes 集群上，集群核心组件 kube-apiserver、kube-controller-manager、kube-scheduler 和 etcd 等均会以静态 Pod 的形式运行，它们所依赖的镜像文件默认来自于 registry.k8s.io 这一 Registry 服务之上。但我们无法直接访问该服务，常用的解决办法有如下两种</p>\n<ul>\n<li>使用能够到达该服务的代理服务；</li>\n<li>使用国内的镜像服务器上的服务，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1yZWdpc3RyeS1reDJtMjYzZi5hbGl5dW5jcy5jb20vZ29vZ2xlX2NvbnRhaW5lcnMlRTclQUQlODklRTMlODAlODI=\">例如 registry.aliyuncs.com/google_containers 等。</span></li>\n</ul>\n<h3 id=\"初始化master节点在k8s-master01上完成如下操作\"><a class=\"anchor\" href=\"#初始化master节点在k8s-master01上完成如下操作\">#</a> 初始化 master 节点（在 k8s-master01 上完成如下操作）</h3>\n<p>运行如下命令完成 k8s-master01 节点的初始化：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version<span class=\"token operator\">=</span>v1.26.3 --pod-network-cidr<span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.0.0/16 --service-cidr<span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.0/12 --token-ttl<span class=\"token operator\">=</span><span class=\"token number\">0</span> --cri-socket unix:///run/cri-dockerd.sock</pre></td></tr></table></figure><p>命令中的各选项简单说明如下：</p>\n<ul>\n<li>--image-repository：指定要使用的镜像仓库，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1yZWdpc3RyeS13ZzBtczU4MWM5ZXZiLms4cy5pbw==\">默认为 registry.k8s.io</span>；</li>\n<li>--kubernetes-version：kubernetes 程序组件的版本号，它必须要与安装的 kubelet 程序包的版本号相同；</li>\n<li>--control-plane-endpoint：控制平面的固定访问端点，可以是 IP 地址或 DNS 名称，会被用于集群管理员及集群组件的 kubeconfig 配置文件的 API Server 的访问地址；单控制平面部署时可以不使用该选项；</li>\n<li>--pod-network-cidr：Pod 网络的地址范围，其值为 CIDR 格式的网络地址，通常，Flannel 网络插件的默认为 10.244.0.0/16，Project Calico 插件的默认值为 192.168.0.0/16；</li>\n<li>--service-cidr：Service 的网络地址范围，其值为 CIDR 格式的网络地址，默认为 10.96.0.0/12；通常，仅 Flannel 一类的网络插件需要手动指定该地址；</li>\n<li>--apiserver-advertise-address：apiserver 通告给其他组件的 IP 地址，一般应该为 Master 节点的用于集群内部通信的 IP 地址，0.0.0.0 表示节点上所有可用地址；</li>\n<li>--token-ttl：共享令牌（token）的过期时长，默认为 24 小时，0 表示永不过期；为防止不安全存储等原因导致的令牌泄露危及集群安全，建议为其设定过期时长。未设定该选项时，在 token 过期后，若期望再向集群中加入其它节点，可以使用如下命令重新创建 token，并生成节点加入命令。</li>\n</ul>\n<h4 id=\"初始化完成后的操作步骤\"><a class=\"anchor\" href=\"#初始化完成后的操作步骤\">#</a> 初始化完成后的操作步骤</h4>\n<p>对于 Kubernetes 系统的新用户来说，无论使用上述哪种方法，命令运行结束后，请记录最后的 kubeadm join 命令输出的最后提示的操作步骤。下面的内容是需要用户记录的一个命令输出示例，它提示了后续需要的操作步骤。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 下面是成功完成第一个控制平面节点初始化的提示信息及后续需要完成的步骤</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Your Kubernetes control-plane has initialized successfully<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 为了完成初始化操作，管理员需要额外手动完成几个必要的步骤</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>To start using your cluster, you need to run the following as a regular user:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 第 1 个步骤提示， Kubernetes 集群管理员认证到 Kubernetes 集群时使用的 kubeconfig 配置文件</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> <span class=\"token environment constant\">$HOME</span>/.kube</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-i</span> /etc/kubernetes/admin.conf <span class=\"token environment constant\">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-u</span><span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-g</span><span class=\"token variable\">)</span></span> <span class=\"token environment constant\">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 我们也可以不做上述设定，而使用环境变量 KUBECONFIG 为 kubectl 等指定默认使用的 kubeconfig；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Alternatively, <span class=\"token keyword\">if</span> you are the root user, you can run:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">KUBECONFIG</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 第 2 个步骤提示，为 Kubernetes 集群部署一个网络插件，具体选用的插件则取决于管理员；</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>You should now deploy a pod network to the cluster.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Run <span class=\"token string\">\"kubectl apply -f [podnetwork].yaml\"</span> with one of the options listed at:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>https://kubernetes.io/docs/concepts/cluster-administration/addons/</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 第 3 个步骤提示，向集群添加额外的控制平面节点，但本文会略过该步骤，并将在其它文章介绍其实现方式。</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>You can now <span class=\"token function\">join</span> any number of the control-plane <span class=\"token function\">node</span> running the following <span class=\"token builtin class-name\">command</span> on each as root:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># 第 4 个步骤提示，向集群添加工作节点</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Then you can <span class=\"token function\">join</span> any number of worker nodes by running the following on each as root:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 在部署好 kubeadm 等程序包的各工作节点上以 root 用户运行类似如下命令；</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 提示：与 cri-dockerd 结合使用 docker-ce 作为 container runtime 时，通常需要为下面的命令</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#     额外附加 “--cri-socket unix:///run/cri-dockerd.sock” 选项；</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.32.200:6443 <span class=\"token parameter variable\">--token</span> ivu3t7.pogk70dd5pualoz2 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>--discovery-token-ca-cert-hash</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d</pre></td></tr></table></figure><h3 id=\"设定kubectl\"><a class=\"anchor\" href=\"#设定kubectl\">#</a> 设定 kubectl</h3>\n<p>kubectl 是 kube-apiserver 的命令行客户端程序，实现了除系统部署之外的几乎全部的管理操作，是 kubernetes 管理员使用最多的命令之一。kubectl 需经由 API server 认证及授权后方能执行相应的管理操作，kubeadm 部署的集群为其生成了一个具有管理员权限的认证配置文件 /etc/kubernetes/admin.conf，它可由 kubectl 通过默认的 “$HOME/.kube/config” 的路径进行加载。当然，用户也可在 kubectl 命令上使用 --kubeconfig 选项指定一个别的位置。</p>\n<p>下面复制认证为 Kubernetes 系统管理员的配置文件至目标用户（例如当前用户 root）的家目录下：</p>\n<p>~# mkdir ~/.kube</p>\n<p>~# cp /etc/kubernetes/admin.conf  ~/.kube/config</p>\n<h3 id=\"部署网络插件\"><a class=\"anchor\" href=\"#部署网络插件\">#</a> 部署网络插件</h3>\n<p>Kubernetes 系统上 Pod 网络的实现依赖于第三方插件进行，这类插件有近数十种之多，较为著名的有 flannel、calico、canal 和 kube-router 等，简单易用的实现是为 CoreOS 提供的 flannel 项目。下面的命令用于在线部署 flannel 至 Kubernetes 系统之上：</p>\n<p>首先，下载适配系统及硬件平台环境的 flanneld 至每个节点，并放置于 /opt/bin/ 目录下。我们这里选用 flanneld-amd64，目前最新的版本为 v0.21.3，因而，我们需要在集群的每个节点上执行如下命令：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>~<span class=\"token comment\"># mkdir /opt/cni/bin/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>~<span class=\"token comment\"># curl -L https://github.com/flannel-io/flannel/releases/download/v0.20.2/flanneld-amd64  -o /opt/cni/bin/flanneld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>~<span class=\"token comment\"># chmod +x /opt/cni/bin/flanneld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>提示：下载flanneld的地址为 https://github.com/flannel-io/flannel/releases</pre></td></tr></table></figure><p>随后，在初始化的第一个 master 节点 k8s-master01 上运行如下命令，向 Kubernetes 部署 kube-flannel</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl apply <span class=\"token parameter variable\">-f</span> https://raw.githubusercontent.com/flannel-io/flannel/v0.21.3/Documentation/kube-flannel.yml</pre></td></tr></table></figure><p>而后使用如下命令确认其输出结果中 Pod 的状态为 “Running”，类似如下命令及其输入的结果所示：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#  kubectl get pods -n kube-flannel</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kube-flannel-ds-jgkxd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m59s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#</span></pre></td></tr></table></figure><h3 id=\"验证master节点已经就绪\"><a class=\"anchor\" href=\"#验证master节点已经就绪\">#</a> 验证 master 节点已经就绪</h3>\n<p>kubectl get nodes</p>\n<p>上述命令应该会得到类似如下输出，这表示 k8s-master01 节点已经就绪</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME               STATUS   ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01.org   Ready    control-plane   62m   v1.26.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#</span></pre></td></tr></table></figure><h3 id=\"添加节点到集群中\"><a class=\"anchor\" href=\"#添加节点到集群中\">#</a> 添加节点到集群中</h3>\n<p>下面的两个步骤，需要分别在 k8s-node01、k8s-node02 和 k8s-node03 上各自完成。</p>\n<p>1、若未禁用 Swap 设备，编辑 kubelet 的配置文件 /etc/default/kubelet，设置其忽略 Swap 启用的状态错误，内容如下：KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</p>\n<p>2、将节点加入第二步中创建的 master 的集群中，要使用主节点初始化过程中记录的 kubeadm join 命令；</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-node01:/opt/cni/bin<span class=\"token comment\"># kubeadm join 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 --discovery-token-ca-cert-hash sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d --cri-socket unix:///run/cri-dockerd.sock</span></pre></td></tr></table></figure><h3 id=\"验证节点添加结果\"><a class=\"anchor\" href=\"#验证节点添加结果\">#</a> 验证节点添加结果</h3>\n<p>在每个节点添加完成后，即可通过 kubectl 验证添加结果。下面的命令及其输出是在所有的三个节点均添加完成后运行的，其输出结果表明三个 Worker Node 已经准备就绪。</p>\n<p>~# kubectl get nodes</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME               STATUS   ROLES           AGE    VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01.org   Ready    control-plane   80m    v1.26.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-node01.org     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          15m    v1.26.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-node2.org      Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          114s   v1.26.3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node3.org      Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          11m    v1.26.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#</span></pre></td></tr></table></figure><h3 id=\"测试应用编排及服务访问\"><a class=\"anchor\" href=\"#测试应用编排及服务访问\">#</a> 测试应用编排及服务访问</h3>\n<p>到此为止，一个 master，并附带有三个 worker 的 kubernetes 集群基础设施已经部署完成，用户随后即可测试其核心功能。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># kubectl create deployment test-nginx --image=nginx:latest --replicas=3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/test-nginx created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># kubectl create service nodeport test-nginx --tcp=80:80</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>service/test-nginx created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#</span></pre></td></tr></table></figure><p>而后，使用如下命令了解 Service 对象 test-nginx 使用的 NodePort，以便于在集群外部进行访问：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\"># kubectl get svc -l app=test-nginx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>        AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>test-nginx   NodePort   <span class=\"token number\">10.100</span>.229.239   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>:31888/TCP   50s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>root@k8s-master01:~<span class=\"token comment\">#</span></pre></td></tr></table></figure><figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>因此，用户可以于集群外部通过\"http://NodeIP:31888\"这个URL访问we应用，例如于集群外通过浏览器访问\"http://192.168.32.203:31888\"</pre></td></tr></table></figure><p><img data-src=\"../image.assets/1679388005874.png\" alt=\"1679388005874\" /></p>\n<h2 id=\"小结\"><a class=\"anchor\" href=\"#小结\">#</a> 小结</h2>\n<p>本文给出了部署 Kubernetes 分布式集群的具体步骤，并在最后测试了将应用部署并运行于 Kubernetes 系统上的结果。在读者朋友们自行测试时，cri-dockerd、docker-ce、flannel、kubeadm、kubectl 和 kubelet 的版本均可能存在版本上的不同，也因此可能会存在一定程度上的配置差异，具体调整方式请大家自行参考相关的文档进行</p>\n",
            "tags": [
                "Kubernetes",
                "Kubernetes"
            ]
        },
        {
            "id": "http://blog.itshare.work/Docker/Docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/",
            "url": "http://blog.itshare.work/Docker/Docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/",
            "title": "Docker镜像加速",
            "date_published": "2023-03-07T10:45:45.000Z",
            "content_html": "<h1 id=\"docker-镜像加速配置\"><a class=\"anchor\" href=\"#docker-镜像加速配置\">#</a> Docker 镜像加速配置</h1>\n<p>国内从 DockerHub 拉取镜像有时会遇到困难，此时可以配置镜像加速器。</p>\n<p>Docker 官方和国内很多云服务商都提供了国内加速器服务，建议根据运行 docker 的云平台选择对应的镜像加速服务。</p>\n<p>下面列出国内常用的加速站点，排名不分先后，总体来说阿里云速度较稳定。</p>\n<p>docker 中国区官方镜像加速：</p>\n<figure class=\"highlight url\"><figcaption data-lang=\"url\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token scheme\">https<span class=\"token scheme-delimiter\">:</span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">registry.docker-cn.com</span></span></pre></td></tr></table></figure><p>网易镜像加速：</p>\n<figure class=\"highlight url\"><figcaption data-lang=\"url\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token scheme\">http<span class=\"token scheme-delimiter\">:</span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">hub-mirror.c.163.com</span></span></pre></td></tr></table></figure><p>中国科技大学镜像加速：</p>\n<figure class=\"highlight url\"><figcaption data-lang=\"url\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token scheme\">https<span class=\"token scheme-delimiter\">:</span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">docker.mirrors.ustc.edu.cn</span></span></pre></td></tr></table></figure><p>腾讯云镜像加速：</p>\n<figure class=\"highlight url\"><figcaption data-lang=\"url\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token scheme\">https<span class=\"token scheme-delimiter\">:</span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">mirror.ccs.tencentyun.com</span></span></pre></td></tr></table></figure><p>阿里云镜像加速：</p>\n<figure class=\"highlight url\"><figcaption data-lang=\"url\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token scheme\">https<span class=\"token scheme-delimiter\">:</span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">ung2thfc.mirror.aliyuncs.com</span></span></pre></td></tr></table></figure><p>修改 daemon 配置文件 /etc/docker/daemon.json 来使用加速器</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/etc/docker/daemon.json</pre></td></tr></table></figure><p>加入如下内容</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token property\">\"registry-mirrors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token string\">\"https://ung2thfc.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"https://mirror.ccs.tencentyun.com\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token string\">\"https://registry.docker-cn.com\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token string\">\"http://hub-mirror.c.163.com\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>加载重启 docker</p>\n<p>在终端输入以下命令</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl restart <span class=\"token function\">docker</span></pre></td></tr></table></figure><p>打开终端执行 docker info 命令，可见下面信息</p>\n<pre><code> ....\n Labels:\n Experimental: false\n Insecure Registries:\n  127.0.0.0/8\n Registry Mirrors:\n  https://ung2thfc.mirror.aliyuncs.com/\n  https://mirror.ccs.tencentyun.com/\n  https://registry.docker-cn.com/\n  http://hub-mirror.c.163.com/\n  https://docker.mirrors.ustc.edu.cn/\n Live Restore Enabled: false\n</code></pre>\n<p>还可以使用如下脚本进行设置，执行前检查自己的环境，下列脚本可以用于新装 Docker 环境的机器</p>\n<pre><code>#!/bin/bash\ntee /etc/docker/daemon.json &lt;&lt;-'EOF'\n&#123;\n&quot;registry-mirrors&quot;: [\n  &quot;https://ung2thfc.mirror.aliyuncs.com&quot;,\n  &quot;https://mirror.ccs.tencentyun.com&quot;,\n  &quot;https://registry.docker-cn.com&quot;,\n  &quot;http://hub-mirror.c.163.com&quot;,\n  &quot;https://docker.mirrors.ustc.edu.cn&quot;]\n&#125;\nEOF\nsystemctl daemon-reload &amp;&amp; systemctl restart docker\n</code></pre>\n",
            "tags": [
                "Docker"
            ]
        },
        {
            "id": "http://blog.itshare.work/Docker/docker-install/",
            "url": "http://blog.itshare.work/Docker/docker-install/",
            "title": "Docker安装部署",
            "date_published": "2023-03-07T06:36:10.000Z",
            "content_html": "<h1 id=\"安装和删除方法\"><a class=\"anchor\" href=\"#安装和删除方法\">#</a> 安装和删除方法</h1>\n<p>官方文档 : <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL2luc3RhbGwv\">https://docs.docker.com/engine/install/</span><br />\n 阿里云文档: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9taXJyb3IvZG9ja2VyLWNlP3NwbT1hMmM2aC4xMzY1MTEwMi4wLjAuM2UyMjFiMTFndQ==\">https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11gu</span></p>\n<h2 id=\"ubuntu-安装和删除docker\"><a class=\"anchor\" href=\"#ubuntu-安装和删除docker\">#</a> Ubuntu 安装和删除 Docker</h2>\n<p>官方文档: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vaW5zdGFsbC9saW51eC9kb2NrZXItY2UvdWJ1bnR1Lw==\">https://docs.docker.com/install/linux/docker-ce/ubuntu/</span></p>\n<h2 id=\"centos-安装和删除docker\"><a class=\"anchor\" href=\"#centos-安装和删除docker\">#</a> CentOS 安装和删除 Docker</h2>\n<p>官方文档: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vaW5zdGFsbC9saW51eC9kb2NrZXItY2UvY2VudG9zLw==\">https://docs.docker.com/install/linux/docker-ce/centos/</span><br />\nCentOS 6 因内核太旧，即使支持安装 docker，但会有各种问题，不建议安装<br />\n CentOS 7 的 extras 源虽然可以安装 docker，但包比较旧，建议从官方源或镜像源站点下载安装 docker<br />\nCentOS 8 有新技术 podman 代替 docker<br />\n 因此建议在 CentOS 7 上安装 docker<br />\n 参考阿里云文档: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9taXJyb3IvZG9ja2VyLWNlP3NwbT1hMmM2aC4xMzY1MTEwMi4wLjAuM2UyMjFiMTFndQ==\">https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11gu</span></p>\n<h2 id=\"二进制安装\"><a class=\"anchor\" href=\"#二进制安装\">#</a> 二进制安装</h2>\n<p>本方法适用于无法上网或无法通过包安装方式安装的主机上安装 docker<br />\n 安装文档: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vaW5zdGFsbC9saW51eC9kb2NrZXItY2UvYmluYXJpZXMv\">https://docs.docker.com/install/linux/docker-ce/binaries/</span></p>\n<h3 id=\"二进制安装下载路径\"><a class=\"anchor\" href=\"#二进制安装下载路径\">#</a> 二进制安装下载路径</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb3dubG9hZC5kb2NrZXIuY29tL2xpbnV4Lw==\">https://download.docker.com/linux/</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXJyb3JzLmFsaXl1bi5jb20vZG9ja2VyLWNlL2xpbnV4L3N0YXRpYy9zdGFibGUveDg2XzY0Lw==\">https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/</span></p>\n<p>范例：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/docker-20.10.10.tgz?spm<span class=\"token operator\">=</span>a2c6h.25603864.0.0.1caf15acK1B2NZ</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 解压</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 src<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf docker-20.10.10.tgz</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># tree</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 src<span class=\"token punctuation\">]</span><span class=\"token comment\"># tree</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>├── <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>│   ├── containerd</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>│   ├── containerd-shim</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>│   ├── containerd-shim-runc-v2</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>│   ├── ctr</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>│   ├── <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>│   ├── dockerd</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>│   ├── docker-init</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>│   ├── docker-proxy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>│   └── runc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>└── docker-20.10.10.tgz</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">1</span> directory, <span class=\"token number\">10</span> files</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 src<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># 添加环境变量</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 src<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/src/docker/* /usr/bin/</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#启动 dockerd 服务</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 src<span class=\"token punctuation\">]</span><span class=\"token comment\">#dockerd &amp;>/dev/null &amp;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 编写 service 文件</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /lib/systemd/system/docker.service</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Docker Application Container Engine</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://docs.docker.com</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network-online.target docker.socket firewalld.service containerd.service time-set.target</pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">Wants</span><span class=\"token operator\">=</span>network-online.target containerd.service</pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>notify</pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/bin/dockerd <span class=\"token parameter variable\">-H</span> unix://var/run/docker.sock</pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token assign-left variable\">ExecReload</span><span class=\"token operator\">=</span>/bin/kill <span class=\"token parameter variable\">-s</span> HUP <span class=\"token variable\">$MAINPID</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">TimeoutStartSec</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token assign-left variable\">StartLimitBurst</span><span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token assign-left variable\">StartLimitInterval</span><span class=\"token operator\">=</span>60s</pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\"># in the kernel. We recommend using cgroups to do container-local accounting.</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span>infinity</pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token assign-left variable\">LimitNPROC</span><span class=\"token operator\">=</span>infinity</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token assign-left variable\">LimitCORE</span><span class=\"token operator\">=</span>infinity</pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\"># Comment TasksMax if your systemd version does not support it.</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\"># Only systemd 226 and above support this option.</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token assign-left variable\">TasksMax</span><span class=\"token operator\">=</span>infinity</pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token comment\"># set delegate yes so that systemd does not reset the cgroups of docker containers</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token assign-left variable\">Delegate</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\"># kill only the docker process, not all processes in the cgroup</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token assign-left variable\">KillMode</span><span class=\"token operator\">=</span>process</pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token assign-left variable\">OOMScoreAdjust</span><span class=\"token operator\">=</span>-500</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure>",
            "tags": [
                "Docker"
            ]
        },
        {
            "id": "http://blog.itshare.work/Ansible/Ansible2/",
            "url": "http://blog.itshare.work/Ansible/Ansible2/",
            "title": "运维自动化工具Ansible(二)",
            "date_published": "2023-02-25T04:21:17.000Z",
            "content_html": "<h1 id=\"playbook\"><a class=\"anchor\" href=\"#playbook\">#</a> Playbook</h1>\n<h2 id=\"playbook介绍\"><a class=\"anchor\" href=\"#playbook介绍\">#</a> playbook 介绍</h2>\n<p>官方链接</p>\n<pre><code>https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html\n</code></pre>\n<h3 id=\"playbook-组成\"><a class=\"anchor\" href=\"#playbook-组成\">#</a> Playbook 组成</h3>\n<p><img data-src=\"../image.assets/1677299110747.png\" alt=\"1677299110747\" /></p>\n<ul>\n<li>一个 playbook (剧本) 文件是一个 YAML 语言编写的文本文件</li>\n<li>通常一个 playbook 只包括一个 play</li>\n<li>一个 play 的主要包括两部分：主机和 tasks. 即实现在指定一组主机上执行一个 tasks 定义好的任务列表。</li>\n<li>一个 tasks 中可以有一个或多个 task 任务</li>\n<li>每一个 Task 本质上就是调用 ansible 的一个 module</li>\n<li>在复杂场景中，一个 playbook 中也可以包括多个 play，实现对多组不同的主机执行不同的任务</li>\n</ul>\n<h3 id=\"playbook-与-ad-hoc-对比\"><a class=\"anchor\" href=\"#playbook-与-ad-hoc-对比\">#</a> Playbook 与 Ad-Hoc 对比</h3>\n<ul>\n<li>Playbook 是对多个 AD-Hoc 的一种编排组合的实现方式</li>\n<li>Playbook 能控制任务执行的先后顺序</li>\n<li>Playbook 可以持久保存到文件中从而方便多次调用运行，而 Ad-Hoc 只能临时运行。</li>\n<li>Playbook 适合复杂的重复性的任务，而 Ad-Hoc 适合做快速简单的一次性任务</li>\n</ul>\n<h2 id=\"yaml-语言\"><a class=\"anchor\" href=\"#yaml-语言\">#</a> YAML 语言</h2>\n<h3 id=\"yaml-语言介绍\"><a class=\"anchor\" href=\"#yaml-语言介绍\">#</a> YAML 语言介绍</h3>\n<p>YAML：YAML Ain't Markup Language，即 YAML 不是标记语言。不过，在开发的这种语言时，YAML 的<br />\n意思其实是：&quot;Yet Another Markup Language&quot;（仍是一种标记语言）<br />\nYAML 是一个可读性高的用来表达资料序列的格式。<br />\nYAML 参考了其他多种语言，包括：XML、C 语言、Python、Perl 以及电子邮件格式 RFC2822 等。<br />\nClark Evans 在 2001 年在首次发表了这种语言，另外 Ingy döt Net 与 Oren Ben-Kiki 也是这语言的共同设计者<br />\n目前很多最新的软件比较流行采用此格式的文件存放配置信息，如:ubuntu，anisble，docker，kubernetes 等<br />\n YAML 官方网站：</p>\n<pre><code>http://www.yaml.org\n</code></pre>\n<p>ansible 官网:</p>\n<pre><code>https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html\n</code></pre>\n<p>###　YAML 语言特性</p>\n<ul>\n<li>YAML 的可读性好</li>\n<li>YAML 和脚本语言的交互性好</li>\n<li>YAML 使用实现语言的数据类型</li>\n<li>YAML 有一个一致的信息模型</li>\n<li>YAML 易于实现</li>\n<li>YAML 可以基于流来处理</li>\n<li>YAML 表达能力强，扩展性好</li>\n</ul>\n<h3 id=\"yaml语法简介\"><a class=\"anchor\" href=\"#yaml语法简介\">#</a> YAML 语法简介</h3>\n<ul>\n<li>在单一文件第一行，用连续三个连字号 &quot;-&quot; 开始，还有选择性的连续三个点号 (...) 用来表示文件结尾</li>\n<li>次行开始正常写 Playbook 的内容，一般建议写明该 Playbook 的功能</li>\n<li>使用 #号注释代码</li>\n<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结行来实现的</li>\n<li>缩进不支持 tab, 必须使用空格进行缩进</li>\n<li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li>\n<li>YAML 文件内容是区别大小写的，key/value 的值均需大小写敏感</li>\n<li>多个 key/value 可同行写也可换行写，同行使用，分隔</li>\n<li>key 后面冒号要加一个空格 比如: key: value</li>\n<li>value 可是个字符串，也可是另一个列表</li>\n<li>YAML 文件扩展名通常为 yml 或 yaml</li>\n</ul>\n<h3 id=\"支持的数据类型\"><a class=\"anchor\" href=\"#支持的数据类型\">#</a> 支持的数据类型</h3>\n<p>YAML 支持以下常用几种数据类型：</p>\n<ul>\n<li>标量：单个的、不可再分的值</li>\n<li>对象：键值对的集合，又称为：字典（dictionary）/ 哈希（hashes） / 映射（mapping）</li>\n<li>数组：一组按次序排列的值，又称为：列表（list）/ 序列（sequence）</li>\n</ul>\n<h4 id=\"scalar-标量\"><a class=\"anchor\" href=\"#scalar-标量\">#</a> scalar 标量</h4>\n<p>key 对应 value</p>\n<pre><code>name: wang\nage: 18\n</code></pre>\n<p>使用缩进的方式</p>\n<pre><code>name:\nwang\nage:\n18\n</code></pre>\n<p>标量是最基本的，不可再分的值，包括：</p>\n<ul>\n<li>字符串</li>\n<li>布尔值</li>\n<li>整数</li>\n<li>浮点数</li>\n<li>Null</li>\n<li>时间</li>\n<li>日期</li>\n</ul>\n<p>####　Dictionary 字典<br />\n一个字典是由一个或多个 key 与 value 构成<br />\n key 和 value 之间用冒号 ：分隔<br />\n冒号：后面有一个空格<br />\n所有 k/v 可以放在一行，, 每个 k/v 之间用逗号分隔<br />\n所有每个 k/v 也可以分别放在不同行，一对 k/v 放在独立的一行<br />\n格式</p>\n<pre><code>account: &#123; name: wang, age: 30 &#125;\n</code></pre>\n<p>使用缩进方式</p>\n<pre><code>account:\nname: wang\nage: 18\n</code></pre>\n<p>范例：</p>\n<pre><code>#不同行\n# An employee record\nname: Example Developer\njob: Developer\nskill: Elite(社会精英)\n#同一行,也可以将key:value放置于&#123;&#125;中进行表示，用,分隔多个key:value\n# An employee record\n&#123;name: &quot;Example Developer&quot;, job: &quot;Developer&quot;, skill: &quot;Elite&quot;&#125;\n</code></pre>\n<h4 id=\"list-列表\"><a class=\"anchor\" href=\"#list-列表\">#</a> List 列表</h4>\n<p>列表由多个元素组成<br />\n每个元素放在不同行，每个元素一行，且元素前均使用中横线 - 开头，并且中横线 - 和元素之间有一个空格<br />\n也可以将所有元素用 [ ] 括起来放在同一行，每个元素之间用逗号分隔<br />\n格式</p>\n<pre><code>course: [ linux , golang , python ]\n</code></pre>\n<p>也可以写成以 - 开头的多行</p>\n<pre><code>course:\n\t- linux\n\t- golang\n\t- python\ncourse:\n\t- linux: manjaro\n\t- golang: gin\n\t- python: django\n</code></pre>\n<p>范例：</p>\n<pre><code>#不同行,行以-开头,后面有一个空格\n# A list of tasty fruits\n- Apple\n- Orange\n- Strawberry\n- Mango\n#同一行\n[Apple,Orange,Strawberry,Mango]\n</code></pre>\n<p>范例：YAML 表示一个家庭</p>\n<pre><code>name: John Smith\nage: 41\ngender: Male\nspouse: &#123; name: Jane Smith, age: 37, gender: Female &#125; # 写在一行里\n\tname: Jane Smith #也可以写成多行\n\tage: 37\n\tgender: Female\n\tchildren: [ &#123;name: Jimmy Smith,age: 17, gender: Male&#125;, &#123;name: Jenny Smith, \t\tage:13, gender: Female&#125;, &#123;name: hao Smith, age: 20, gender: Male &#125; ] #写在一行\n\t- name: Jimmy Smith #写在多行,更为推荐的写法\n\t\tage: 17\n\t\tgender: Male\n\t- &#123;name: Jenny Smith, age: 13, gender: Female&#125;\n\t- &#123;name: hao Smith, age: 20, gender: Male &#125;\n</code></pre>\n<h3 id=\"三种常见的数据格式\"><a class=\"anchor\" href=\"#三种常见的数据格式\">#</a> 三种常见的数据格式</h3>\n<ul>\n<li>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</li>\n<li>JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释</li>\n<li>YAML：YAML Ain't Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持 tab</li>\n</ul>\n<p><img data-src=\"../image.assets/1677310138888.png\" alt=\"1677310138888\" /></p>\n<p>可以用工具互相转换，参考网站：<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuanNvbjJ5YW1sLmNvbS8=\">https://www.json2yaml.com/</span><br />\n<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5iZWpzb24uY29tL2pzb24vanNvbjJ5YW1sLw==\">http://www.bejson.com/json/json2yaml/</span></p>\n<h2 id=\"playbook-核心组件\"><a class=\"anchor\" href=\"#playbook-核心组件\">#</a> Playbook 核心组件</h2>\n<p>官方文档</p>\n<pre><code>https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#playbook-keywords\n</code></pre>\n<p>一个 playbook 中由多个组件组成，其中所用到的常见组件类型如下:</p>\n<ul>\n<li>Hosts 执行的远程主机列表</li>\n<li>Tasks 任务集，由多个 task 的元素组成的列表实现，每个 task 是一个字典，一个完整的代码块功能需少元素需包括 name 和 task, 一个 name 只能包括一个 task</li>\n<li>Variables 内置变量或自定义变量在 playbook 中调用</li>\n<li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li>\n<li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>\n<li>tags 标签 指定某条任务执行，用于选择运行 playbook 中的部分代码。ansible 具有幂等性，因此 会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过 tags 跳过此些代码片断</li>\n</ul>\n<h3 id=\"hosts-组件\"><a class=\"anchor\" href=\"#hosts-组件\">#</a> hosts 组件</h3>\n<p>Hosts：playbook 中的每一个 play 的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts 用于指定要执行指定任务的主机，须事先定义在主机清单中</p>\n<pre><code>one.example.com\none.example.com:two.example.com\n192.168.1.50\n192.168.1.*\nWebsrvs:dbsrvs #或者，两个组的并集\nWebsrvs:&amp;dbsrvs #与，两个组的交集\nwebservers:!dbsrvs #在websrvs组，但不在dbsrvs组\n</code></pre>\n<p>案例：</p>\n<pre><code>- hosts: websrvs:appsrvs\n</code></pre>\n<h3 id=\"remote_user-组件\"><a class=\"anchor\" href=\"#remote_user-组件\">#</a> remote_user 组件</h3>\n<p>remote_user: 可用于 Host 和 task 中。也可以通过指定其通过 sudo 的方式在远程主机上执行任务，其可用于 play 全局或某任务；此外，甚至可以在 sudo 时使用 sudo_user 指定 sudo 时切换的用户</p>\n<pre><code>- hosts: websrvs\n  remote_user: root\n  tasks:\n    - name: test connection\n    ping:\n    remote_user: magedu\n    sudo: yes #默认sudo为root\n    sudo_user:wang #sudo为wang\n</code></pre>\n<h3 id=\"task列表和action组件\"><a class=\"anchor\" href=\"#task列表和action组件\">#</a> task 列表和 action 组件</h3>\n<p>play 的主体部分是 task list，task list 中有一个或多个 task, 各个 task 按次序逐个在 hosts 中指定的所有主机上执行，即在所有主机上完成第一个 task 后，再开始第二个 task<br />\ntask 的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致<br />\n每个 task 都应该有其 name，用于 playbook 的执行结果输出，建议其内容能清晰地描述任务执行步骤。<br />\n如果未提供 name，则 action 的结果将用于输出<br />\n task 两种格式：</p>\n<pre><code>action: module arguments #示例: action: shell wall hello\nmodule: arguments #建议使用 #示例: shell: wall hello\n</code></pre>\n<p>注意：shell 和 command 模块后面跟命令，而非 key=value<br />\n 范例:</p>\n<pre><code>[root@ansible ansible]#cat hello.yml\n---\n#first yaml文件\n#\n- hosts: websrvs\n  remote_user: root\n  gather_facts: no\n  tasks:\n    - name: task1\n      debug: msg=&quot;task1 running&quot;\n    - name: task2\n      debug: msg=&quot;task2 running&quot;\n- hosts: appsrvs\n  remote_user: root\n  gather_facts: no\n  tasks:\n    - name: task3\n      debug: msg=&quot;task3 running&quot;\n    - name: task4\n      debug: msg=&quot;task4 running&quot;\n</code></pre>\n<h3 id=\"其它组件说明\"><a class=\"anchor\" href=\"#其它组件说明\">#</a> 其它组件说明</h3>\n<p>某任务的状态在运行后为 changed 时，可通过 &quot;notify&quot; 通知给相应的 handlers 任务<br />\n还可以通过 &quot;tags&quot; 给 task 打标签，可在 ansible-playbook 命令上使用 - t 指定进行调用</p>\n<h3 id=\"shellscripts-vs-playbook-案例\"><a class=\"anchor\" href=\"#shellscripts-vs-playbook-案例\">#</a> ShellScripts VS Playbook 案例</h3>\n<pre><code>#SHELL脚本实现\n#!/bin/bash\n# 安装Apache\nyum install --quiet -y httpd\n# 复制配置文件\ncp /tmp/httpd.conf /etc/httpd/conf/httpd.conf\ncp/tmp/vhosts.conf /etc/httpd/conf.d/\n# 启动Apache，并设置开机启动\nsystemctl enable --now httpd\n#Playbook实现\n---\n- hosts: websrvs\n  remote_user: root\n  gather_facts: no\n  tasks:\n  - name: &quot;安装Apache&quot;\n    yum: name=httpd\n  - name: &quot;复制配置文件&quot;\n\tcopy: src=/tmp/httpd.conf dest=/etc/httpd/conf/\n  - name: &quot;复制配置文件&quot;\n\tcopy: src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/\n  - name: &quot;启动Apache，并设置开机启动&quot;\n\tservice: name=httpd state=started enabled=yes\n</code></pre>\n<h2 id=\"playbook-命令\"><a class=\"anchor\" href=\"#playbook-命令\">#</a> playbook 命令</h2>\n<p>格式</p>\n<pre><code>ansible-playbook &lt;filename.yml&gt; ... [options]\n</code></pre>\n<p>选项</p>\n<pre><code>--syntax,--syntax-check #语法检查,功能相当于bash -n\n-C --check #模拟执行dry run ,只检测可能会发生的改变，但不真正执行操作\n--list-hosts #列出运行任务的主机\n--list-tags #列出tag\n--list-tasks #列出task\n--limit 主机列表 #只针对主机列表中的特定主机执行\n-i INVENTORY, --inventory INVENTORY #指定主机清单文件,通常一个项对应一个主机清单文件\n--start-at-task START_AT_TASK #从指定task开始执行,而非从头开始,START_AT_TASK为任务的name\n-v -vv -vvv #显示过程\n</code></pre>\n<p>范例：一个简单的 playbook</p>\n<pre><code>[root@ansible ansible]#cat hello.yml\n---\n- hosts: websrvs\n  tasks:\n    - name: hello\n      command: echo &quot;hello ansible&quot;\n[root@ansible ansible]#ansible-playbook hello.yml\n[root@ansible ansible]#ansible-playbook -v hello.yml\n</code></pre>\n<p>范例：检查和限制主机</p>\n<pre><code>ansible-playbook file.yml --check #只检测\nansible-playbook file.yml\nansible-playbook file.yml --limit websrvs\n</code></pre>\n<p>范例：一个 playbook 多个 play</p>\n<pre><code>cat test_plays.yaml\n---\n- hosts: localhost\n  remote_user: root\n  gather_facts: no\n  tasks:\n    - name: play1\n      command: echo &quot;play1&quot;\n- hosts: centos7\n  remote_user: root\n  gather_facts: no\n  tasks:\n    - name: play2\n      command: echo &quot;play2&quot;\n</code></pre>\n<h2 id=\"忽略错误-ignore_errors\"><a class=\"anchor\" href=\"#忽略错误-ignore_errors\">#</a> 忽略错误 ignore_errors</h2>\n<p>如果一个 task 出错，默认将不会继续执行后续的其它 task<br />\n 利用 ignore_errors: yes 可以忽略此 task 的错误，继续向下执行 playbook 其它 task</p>\n<pre><code>[root@ansible ansible]#cat test_ignore.yml\n---\n- hosts: centos7\n  tasks:\n    - name: error\n      command: /bin/false\n      ignore_errors: yes\n    - name: continue\n      command: wall continue\n</code></pre>\n<h2 id=\"ansible-playbook案例\"><a class=\"anchor\" href=\"#ansible-playbook案例\">#</a> ansible-playbook 案例</h2>\n<h3 id=\"安装nginx\"><a class=\"anchor\" href=\"#安装nginx\">#</a> 安装 nginx</h3>\n<pre><code class=\"language-ymal\">---\n- hosts: centos7\n# yum install nginx\n  remote_user: root\n  gather_facts: no\n  tasks:\n    - name: install nginx\n      yum: name=nginx state=present\n    - name:\n      service: name=nginx state=started enabled=yes\n</code></pre>\n<h3 id=\"卸载httpd\"><a class=\"anchor\" href=\"#卸载httpd\">#</a> 卸载 httpd</h3>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#remove_httpd.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">---</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> webservers</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">remote_user</span><span class=\"token punctuation\">:</span> root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">gather_facts</span><span class=\"token punctuation\">:</span> no</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> remove httpd package</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">yum</span><span class=\"token punctuation\">:</span> name=httpd state=absent</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> remove apache user</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> name=apache state=absent</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> remove config file</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> name=/etc/httpd state=absent</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> remove web html</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> name=/data/html/ state=absent</pre></td></tr></table></figure><h2 id=\"playbook中使用handlers和notify\"><a class=\"anchor\" href=\"#playbook中使用handlers和notify\">#</a> Playbook 中使用 handlers 和 notify</h2>\n<h3 id=\"handlers和notify\"><a class=\"anchor\" href=\"#handlers和notify\">#</a> handlers 和 notify</h3>\n<p>Handlers 本质是 task list ，类似于 MySQL 中的触发器触发的行为，其中的 task 与前述的 task 并没有本质上的不同，只有在关注的资源发生变化时，才会采取一定的操作。<br />\nNotify 对应的 action 在所有 task 都执行完才会最后被触发，这样可避免多个 task 多次改变发生时每次都触发执行指定的操作，Handlers 仅在所有的变化发生完成后一次性地执行指定操作。<br />\n在 notify 中列出的操作称为 handler，也即 notify 中调用 handler 中定义的操作<br />\n注意:</p>\n<ul>\n<li>如果多个 task 通知了相同的 handlers， 此 handlers 仅会在所有 task 结束后运行一 次。</li>\n<li>只有 notify 对应的 task 发生改变了才会通知 handlers， 没有改变则不会触发 handlers</li>\n<li>handlers 是在所有前面的 tasks 都成功执行才会执行，如果前面任何一个 task 失败，会导致 handle 跳过执行</li>\n</ul>\n<p>案例:</p>\n<p><img data-src=\"../image.assets/1677315798458.png\" alt=\"1677315798458\" /></p>\n<p><img data-src=\"../image.assets/1677315812687.png\" alt=\"1677315812687\" /></p>\n<p>案例：</p>\n<p><img data-src=\"../image.assets/1677315839869.png\" alt=\"1677315839869\" /></p>\n<p>案例：</p>\n<p><img data-src=\"../image.assets/1677315862982.png\" alt=\"1677315862982\" /></p>\n<p><img data-src=\"../image.assets/1677315872464.png\" alt=\"1677315872464\" /></p>\n<p>范例：部署 haproxy</p>\n<p><img data-src=\"../image.assets/1677315902745.png\" alt=\"1677315902745\" /></p>\n<h3 id=\"force_handlers\"><a class=\"anchor\" href=\"#force_handlers\">#</a> force_handlers</h3>\n<p>如果不论前面的 task 成功与否，都希望 handlers 能执行，可以使用 force_handlers: yes 强制执行 handler<br />\n 范例：强制调用 handlers</p>\n<p><img data-src=\"../image.assets/1677315975960.png\" alt=\"1677315975960\" /></p>\n<h2 id=\"playbook中使用tags组件\"><a class=\"anchor\" href=\"#playbook中使用tags组件\">#</a> Playbook 中使用 tags 组件</h2>\n<p>官方文档:</p>\n<pre><code>https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html\n</code></pre>\n<p>默认情况下， Ansible 在执行一个 playbook 时，会执行 playbook 中所有的任务，在 playbook 文件中，可以利用 tags 组件，为特定 task 指定标签，当在执行 playbook 时，可以只执行特定 tags 的 task, 而非整个 playbook 文件<br />\n可以一个 task 对应多个 tag, 也可以多个 task 对应同一个 tag<br />\n 还有另外 3 个特殊关键字用于标签，tagged, untagged 和 all, 它们分别是仅运行已标记，只有未标记和所有任务。<br />\ntags 主要用于调试环境<br />\n范例： tag 标签</p>\n<p><img data-src=\"../image.assets/1677316033321.png\" alt=\"1677316033321\" /></p>\n<h2 id=\"playbook中使用变量\"><a class=\"anchor\" href=\"#playbook中使用变量\">#</a> Playbook 中使用变量</h2>\n<p>Playbook 中同样也支持变量<br />\n变量名：仅能由字母、数字和下划线组成，且只能以字母开头<br />\n变量定义：</p>\n<pre><code>variable=value\nvariable: value\n</code></pre>\n<p>范例：</p>\n<pre><code>http_port=80\nhttp_port: 80\n</code></pre>\n<p>通过  调用变量，且变量名前后建议加空格，有时用 &quot;&quot; 才生效<br />\n变量来源：</p>\n<ol>\n<li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li>\n<li>通过命令行指定变量，优先级最高</li>\n</ol>\n<pre><code>ansible-playbook -e varname=value test.yml\n</code></pre>\n<p>3. 在 playbook 文件中定义</p>\n<pre><code>vars:\nvar1: value1\nvar2: value2\n</code></pre>\n<p>4. 在独立的变量 YAML 文件中定义</p>\n<pre><code>- hosts: all\nvars_files:\n- vars.yml\n</code></pre>\n<ol start=\"5\">\n<li>在主机清单文件中定义<br />\n主机（普通）变量：主机组中主机单独定义，优先级高于公共变量<br />\n组（公共）变量：针对主机组中所有主机定义统一变量</li>\n<li>在项目中针对主机和主机组定义<br />\n在项目目录中创建 host_vars 和 group_vars 目录</li>\n<li>在 role 中定义</li>\n</ol>\n<p>变量的优先级从高到低如下</p>\n<pre><code>-e 选项定义变量 --&gt;playbook中vars_files --&gt; playbook中vars变量定义 --&gt;host_vars/主机名文件 --&gt;主机清单中主机变量--&gt; group_vars/主机组名文件--&gt;group_vars/all文件--&gt; 主机清单组变量\n</code></pre>\n<h3 id=\"使用-setup-模块中变量\"><a class=\"anchor\" href=\"#使用-setup-模块中变量\">#</a> 使用 setup 模块中变量</h3>\n<h4 id=\"使用-facts-变量\"><a class=\"anchor\" href=\"#使用-facts-变量\">#</a> 使用 facts 变量</h4>\n<p>本模块自动在 playbook 调用，生成的系统状态信息，并将之存放在 facts 变量中<br />\n facts 包括的信息很多，如：主机名，IP,CPU, 内存，网卡等<br />\n facts 变量的实际使用场景案例</p>\n<ul>\n<li>通过 facts 变量获取被控端 CPU 的个数信息，从而生成不同的 Nginx 配置文件</li>\n<li>通过 facts 变量获取被控端内存大小信息，从而生成不同的 memcached 的配置文件</li>\n<li>通过 facts 变量获取被控端主机名称信息，从而生成不同的 Zabbix 配置文件</li>\n<li>通过 facts 变量获取被控端网卡信息，从而生成不同的主机名</li>\n</ul>\n<p>案例：使用 setup 变量</p>\n<pre><code>[root@ansible ~]# ansible localhost -m setup -a 'filter=&quot;ansible_default_ipv4&quot;'\nlocalhost | SUCCESS =&gt; &#123;\n    &quot;ansible_facts&quot;: &#123;\n        &quot;ansible_default_ipv4&quot;: &#123;\n            &quot;address&quot;: &quot;192.168.32.133&quot;,\n            &quot;alias&quot;: &quot;ens160&quot;,\n            &quot;broadcast&quot;: &quot;192.168.32.255&quot;,\n            &quot;gateway&quot;: &quot;192.168.32.2&quot;,\n            &quot;interface&quot;: &quot;ens160&quot;,\n            &quot;macaddress&quot;: &quot;00:0c:29:7c:80:cd&quot;,\n            &quot;mtu&quot;: 1500,\n            &quot;netmask&quot;: &quot;255.255.255.0&quot;,\n            &quot;network&quot;: &quot;192.168.32.0&quot;,\n            &quot;prefix&quot;: &quot;24&quot;,\n            &quot;type&quot;: &quot;ether&quot;\n        &#125;\n    &#125;,\n    &quot;changed&quot;: false\n&#125;\n[root@ansible ~]# \n</code></pre>\n<p>范例：显示 ens33 的网卡的 IP 地址</p>\n<pre><code>---\n- hosts: centos7\n  tasks:\n    - name: show ens33 ip\n      debug:\n        msg: IP address &#123;&#123; ansible_ens33.ipv4.address &#125;&#125;\n        #msg: IP address &#123;&#123; ansible_facts[\"ens33\"][\"ipv4\"][\"address\"] &#125;&#125;\n        #msg: IP address &#123;&#123; ansible_facts.ens33.ipv4.address &#125;&#125;\n        #msg: IP address &#123;&#123; ansible_default_ipv4.address &#125;&#125;\n        #msg: IP address &#123;&#123; ansible_ens33.ipv4.address &#125;&#125;\n        #msg: IP address &#123;&#123; ansible_ens33.ipv4.address.split('.')[-1] &#125;&#125;  #取IP中的最后一个数字\n</code></pre>\n<pre><code>[root@ansible ansible]# ansible-playbook -v show_ip.yml \nUsing /etc/ansible/ansible.cfg as config file\n\nPLAY [centos7] *************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************\nok: [192.168.32.179]\nok: [192.168.32.178]\n\nTASK [show ens33 ip] *******************************************************************************************************************\nok: [192.168.32.178] =&gt; &#123;\n    &quot;msg&quot;: &quot;IP address 192.168.32.178&quot;\n&#125;\nok: [192.168.32.179] =&gt; &#123;\n    &quot;msg&quot;: &quot;IP address 192.168.32.179&quot;\n&#125;\n\nPLAY RECAP *****************************************************************************************************************************\n192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n[root@ansible ansible]# \n</code></pre>\n<p>范例：修改主机名称为 web-IP</p>\n<pre><code>- hosts: centos7\n  tasks:\n  - name: 打印facts变量\n    debug: msg=&#123;&#123; ansible_ens33.ipv4.address &#125;&#125;\n  - name: 修改主机名\n    hostname: name=web-&#123;&#123; ansible_ens33.ipv4.address &#125;&#125;\n  #- name: 获取facts变量提取IP地址，以.结尾的最后一列,修改主机名为web-hostid\n    #hostname: name=web-&#123;&#123; ansible_ens33.ipv4.address.split('.')[-1] &#125;&#125;\n</code></pre>\n<pre><code>[root@ansible ansible]# ansible-playbook change_hostname.yml \n\nPLAY [centos7] *************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************\nok: [192.168.32.178]\nok: [192.168.32.179]\n\nTASK [打印facts变量] *******************************************************************************************************************\nok: [192.168.32.178] =&gt; &#123;\n    &quot;msg&quot;: &quot;192.168.32.178&quot;\n&#125;\nok: [192.168.32.179] =&gt; &#123;\n    &quot;msg&quot;: &quot;192.168.32.179&quot;\n&#125;\n\nTASK [修改主机名] **********************************************************************************************************************\nchanged: [192.168.32.179]\nchanged: [192.168.32.178]\n\nPLAY RECAP *****************************************************************************************************************************\n192.168.32.178             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n192.168.32.179             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n[root@ansible ansible]# \n</code></pre>\n<p>####　性能优化</p>\n<p>每次执行 playbook, 默认会收集每个主机的所有 facts 变量，将会导致速度很慢，可以采用下面方法加速<br />\n方法 1<br />\n 关闭 facts 采集加速执行，此方法将导致无法使用 facts 变量</p>\n<pre><code>- hosts: all\n  gather_facts: no\n</code></pre>\n<p>方法 2<br />\n 当使用 gather_facts: no 关闭 facts，确实能加速 Ansible 执行，但是有时候又需要使用 facts 中的内容，还希望执行的速度快，这时候可以设置 facts 的缓存，将 facts 变量信息存在 redis 服务器中</p>\n<pre><code>[root@ansible ~]# cat /etc/ansible/ansible.cfg\n[defaults]\n# smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts\n# implicit 表示默认收集 facts，要禁止收集，必须使用 gather_facts: False\n# explicit 则表示默认不收集，要显式收集，必须使用gather_facts: True\ngathering = smart #在使用 facts 缓存时设置为smart\nfact_caching_timeout = 86400 #缓存时长\nfact_caching = redis #缓存存在redis中\nfact_caching_connection = 10.0.0.100:6379:0 #0表示redis的0号数据库\n#若redis设置了密码\nfact_caching_connection = 10.0.0.100:6379:0:password\n</code></pre>\n<h3 id=\"register-注册变量\"><a class=\"anchor\" href=\"#register-注册变量\">#</a> register 注册变量</h3>\n<p>在 playbook 中可以使用 register 将捕获命令的输出保存在临时变量中，方便后续调用此变量，比如可以使用 debug 模块进行显示输出<br />\n范例：利用 debug 模块输出变量</p>\n<pre><code>---\n- hosts: centos7\n  tasks:\n    - name: get variable\n      shell: hostname\n      register: name\n    - name: print variable\n      debug:\n        msg: &quot;&#123;&#123; name &#125;&#125;&quot; #输出register注册的name变量的全部信息,注意变量要加&quot; &quot;引起来\n         #msg: &quot;&#123;&#123; name.cmd &#125;&#125;&quot; #显示命令\n         #msg: &quot;&#123;&#123; name.rc &#125;&#125;&quot; #显示命令成功与否\n\t\t #msg: &quot;&#123;&#123; name.stdout &#125;&#125;&quot; #显示命令的输出结果为字符串形式,所有结果都放在一行里显示,适合于结果是单行输出\n\t    #msg: &quot;&#123;&#123; name.stdout_lines &#125;&#125;&quot; #显示命令的输出结果为列表形式,逐行标准输出,适用于多行显示\n\t\t#msg: &quot;&#123;&#123; name['stdout_lines'] &#125;&#125;&quot; #显示命令的执行结果为列表形式,和效果上面相同\n\t\t#msg: &quot;&#123;&#123; name.stdout_lines[0] &#125;&#125;&quot; #显示命令的输出结果的列表中的第一个元素\n#说明 第一个 task 中，使用了 register 注册变量名为 name ；当 shell 模块执行完毕后，会将数据放到该变量中。第二给 task 中，使用了 debug 模块，并从变量name中获取数据。\n</code></pre>\n<pre><code>[root@ansible ansible]# ansible-playbook -C register.yml \n\nPLAY [centos7] *************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************\nok: [192.168.32.179]\nok: [192.168.32.178]\n\nTASK [get variable] ********************************************************************************************************************\nskipping: [192.168.32.179]\nskipping: [192.168.32.178]\n\nTASK [print variable] ******************************************************************************************************************\nok: [192.168.32.178] =&gt; &#123;\n    &quot;msg&quot;: &#123;\n        &quot;changed&quot;: false,\n        &quot;cmd&quot;: &quot;hostname&quot;,\n        &quot;delta&quot;: null,\n        &quot;end&quot;: null,\n        &quot;failed&quot;: false,\n        &quot;msg&quot;: &quot;Command would have run if not in check mode&quot;,\n        &quot;rc&quot;: 0,\n        &quot;skipped&quot;: true,\n        &quot;start&quot;: null,\n        &quot;stderr&quot;: &quot;&quot;,\n        &quot;stderr_lines&quot;: [],\n        &quot;stdout&quot;: &quot;&quot;,\n        &quot;stdout_lines&quot;: []\n    &#125;\n&#125;\nok: [192.168.32.179] =&gt; &#123;\n    &quot;msg&quot;: &#123;\n        &quot;changed&quot;: false,\n        &quot;cmd&quot;: &quot;hostname&quot;,\n        &quot;delta&quot;: null,\n        &quot;end&quot;: null,\n        &quot;failed&quot;: false,\n        &quot;msg&quot;: &quot;Command would have run if not in check mode&quot;,\n        &quot;rc&quot;: 0,\n        &quot;skipped&quot;: true,\n        &quot;start&quot;: null,\n        &quot;stderr&quot;: &quot;&quot;,\n        &quot;stderr_lines&quot;: [],\n        &quot;stdout&quot;: &quot;&quot;,\n        &quot;stdout_lines&quot;: []\n    &#125;\n&#125;\n\nPLAY RECAP *****************************************************************************************************************************\n192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n\n[root@ansible ansible]# \n</code></pre>\n<p>范例：安装启动服务并检查</p>\n<pre><code>---\n- hosts: centos7\n  vars:\n    package_name: nginx\n    service_name: nginx\n  tasks:\n  - name: install &#123;&#123; package_name &#125;&#125;\n    yum: name=&#123;&#123; package_name &#125;&#125;\n  - name: start &#123;&#123; service_name &#125;&#125;\n    service: name=&#123;&#123; service_name &#125;&#125; state=started enabled=yes\n  - name: check\n    shell: ps axu|grep &#123;&#123; service_name &#125;&#125;\n    register: check_service\n  - name: debug\n    debug:\n      msg: &quot;&#123;&#123; check_service.stdout_lines &#125;&#125;&quot;\n</code></pre>\n<p>范例：修改主机名形式为 web_&lt;随机字符&gt;</p>\n<pre><code>- hosts: centos7\n  tasks:\n  - name: genarate random\n    shell:\n      cmd: openssl rand -base64 12 |tr -dc '[:alnum:]'\n    register:\n      num\n  - name: show random\n    debug:\n      msg: &quot;&#123;&#123; num &#125;&#125;&quot;\n  - name: change hostname\n    hostname:\n      name: web-&#123;&#123; num.stdout &#125;&#125;\n</code></pre>\n<p>范例：修改主机名形式为 web_随机数</p>\n<pre><code>- hosts: centos7\n  tasks:\n  - name: 定义一个随机数，设定为变量，然后后续调用\n    shell: echo $((RANDOM%255))\n    register: web_number\n  - name: 使用debug输出变量结果\n    debug: msg=&#123;&#123; web_number &#125;&#125;\n  - name: 使用hostname模块将主机名修改为web_随机数\n    hostname: name=web_&#123;&#123; web_number.stdout &#125;&#125;\n</code></pre>\n<p>范例：批量修改主机名为随机字符</p>\n<pre><code>- hosts: centos7\n  vars:\n    host: web\n    domain: wang.org\n  tasks:\n  - name: get variable\n    shell: echo $RANDOM | md5sum | cut -c 1-8\n    register: get_random\n  - name: print variable\n    debug:\n      msg: &quot;&#123;&#123; get_random.stdout &#125;&#125;&quot;\n  - name: set hostname\n    hostname: name=&#123;&#123; host &#125;&#125;-&#123;&#123; get_random.stdout &#125;&#125;.&#123;&#123; domain &#125;&#125;\n</code></pre>\n<p>范例：批量修改主机名为 IP 最后 1 位数字</p>\n<pre><code>- hosts: centos7\n  vars:\n    host: web\n    domain: wang.org\n  tasks:\n    - name: get variable\n      shell: hostname -I | awk '&#123;print $1&#125;'\n      register: get_ip\n    - name: print variable\n      debug:\n        msg: &quot;&#123;&#123; get_ip.stdout.split('.')[3] &#125;&#125;&quot;\n    - name: set hostname\n      hostname: name=&#123;&#123; host &#125;&#125;-&#123;&#123; get_ip.stdout.split('.')[3] &#125;&#125;.&#123;&#123; domain &#125;&#125;\n</code></pre>\n<h3 id=\"在-playbook-命令行中定义变量\"><a class=\"anchor\" href=\"#在-playbook-命令行中定义变量\">#</a> 在 Playbook 命令行中定义变量</h3>\n<p>范例：</p>\n<pre><code>---\n- hosts: centos7\n  remote_user: root\n  tasks:\n  - name: install nginx\n    yum: name=&#123;&#123; pkname &#125;&#125; state=present\n    \n    \n[root@ansible ~]#ansible-playbook -e pkname=nginx var2.yml\n</code></pre>\n<p>范例：</p>\n<pre><code>#也可以将多个变量放在一个文件中\n[root@ansible ~]#cat vars\npkname1: memcached\npkname2: vsftpd\n[root@ansible ~]#vim var2.yml\n---\n- hosts: centos7\n  remote_user: root\n  tasks:\n  - name: install package &#123;&#123; pkname1 &#125;\n    yum: name=&#123;&#123; pkname1 &#125;&#125; state=present\n  - name: install package &#123;&#123; pkname2 &#125;\n    yum: name=&#123;&#123; pkname2 &#125;&#125; state=present\n[root@ansible ~]#ansible-playbook -e pkname1=memcached -e pkname2=httpd var2.yml\n[root@ansible ~]#ansible-playbook -e '@vars' var2.yml\n</code></pre>\n<h3 id=\"在playbook文件中定义变量\"><a class=\"anchor\" href=\"#在playbook文件中定义变量\">#</a> 在 playbook 文件中定义变量</h3>\n<p>此方式定义的是私有变量，即只能在当前 playbook 中使用，不能被其它 Playbook 共用<br />\n范例：</p>\n<pre><code>- hosts: webservers\n  remote_user: root\n  vars:\n    username: user1\n    groupname: group1\n  tasks:\n  - name: create group &#123;&#123; groupname &#125;&#125;\n    group: name=&#123;&#123; groupname &#125;&#125; state=present\n  - name: create user &#123;&#123; username &#125;&#125;\n    user: name=&#123;&#123; username &#125;&#125; group=&#123;&#123; groupname &#125;&#125; state=present\n    \n[root@ansible ~]#ansible-playbook -e &quot;username=user2 groupname=group2&quot; var3.yml\n</code></pre>\n<p>范例：变量的相互调用</p>\n<pre><code>---\n- hosts: centos7\n  remote_user: root\n  vars:\n    collect_info: &quot;/data/test/&#123;&#123;ansible_default_ipv4['address']&#125;&#125;/&quot;\n  tasks:\n  - name: create IP directory\n    file: name=&quot;&#123;&#123;collect_info&#125;&#125;&quot; state=directory\n</code></pre>\n<h3 id=\"使用专用的公共的变量文件\"><a class=\"anchor\" href=\"#使用专用的公共的变量文件\">#</a> 使用专用的公共的变量文件</h3>\n<p>可以在一个独立的 playbook 文件中定义公共变量，在其它的 playbook 文件中可以引用变量文件中的变量<br />\n此方式比 playbook 中定义的变量优化级高</p>\n<pre><code>vim vars.yml\n---\n# variables file\npackage_name: mariadb-server\nservice_name: mariadb\n\nvim var5.yml\n---\n#install package and start service\n- hosts: dbsrvs\n  remote_user: root\n  vars_files:\n  # 指定变量文件名\n    - vars.yml\n  tasks:\n  - name: install package\n    yum: name=&#123;&#123; package_name &#125;&#125;\n    tags: install\n  - name: start service\n    service: name=&#123;&#123; service_name &#125;&#125; state=started enabled=yes\n</code></pre>\n<h3 id=\"在主机清单中定义主机和主机组的变量\"><a class=\"anchor\" href=\"#在主机清单中定义主机和主机组的变量\">#</a> 在主机清单中定义主机和主机组的变量</h3>\n<h4 id=\"所有项目的主机变量\"><a class=\"anchor\" href=\"#所有项目的主机变量\">#</a> 所有项目的主机变量</h4>\n<p>在 inventory 主机清单文件中为指定的主机定义变量以便于在 playbook 中使用<br />\n范例：</p>\n<pre><code>[webservers]\nwww1.wang.org http_port=80 maxRequestsPerChild=808\nwww2.wang.org http_port=8080 maxRequestsPerChild=909\n</code></pre>\n<h4 id=\"所有项目的组公共变量\"><a class=\"anchor\" href=\"#所有项目的组公共变量\">#</a> 所有项目的组（公共）变量</h4>\n<p>在 inventory 主机清单文件中赋予给指定组内所有主机上的在 playbook 中可用的变量，如果和主机变是同名，优先级低于主机变量</p>\n<p>案例：</p>\n<pre><code>[webservers:vars]\nhttp_port=80\nntp_server=ntp.wang.org\nnfs_server=nfs.wang.org\n[all:vars]\n# --------- Main Variables ---------------\n# Cluster container-runtime supported: docker, containerd\nCONTAINER_RUNTIME=&quot;docker&quot;\n# Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn\nCLUSTER_NETWORK=&quot;calico&quot;\n# Service proxy mode of kube-proxy: 'iptables' or 'ipvs'\nPROXY_MODE=&quot;ipvs&quot;\n# K8S Service CIDR, not overlap with node(host) networking\nSERVICE_CIDR=&quot;192.168.0.0/16&quot;\n# Cluster CIDR (Pod CIDR), not overlap with node(host) networking\nCLUSTER_CIDR=&quot;172.16.0.0/16&quot;\n# NodePort Range\nNODE_PORT_RANGE=&quot;20000-60000&quot;\n# Cluster DNS Domain\nCLUSTER_DNS_DOMAIN=&quot;magedu.local.&quot;\n</code></pre>\n<p>范例：</p>\n<pre><code>[root@ansible ~]#vim /etc/ansible/hosts\n[webservers]\n10.0.0.8 hname=www1 domain=magedu.io\n10.0.0.7 hname=www2\n[webservers:vars]\nmark=&quot;-&quot;\n[all:vars]\ndomain=wang.org\n[root@ansible ~]#ansible webservers -m hostname -a 'name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;\n&#123;&#123; domain &#125;&#125;'\n#命令行指定变量：\n[root@ansible ~]#ansible webservers -e domain=magedu.cn -m hostname -a 'name=\n&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; domain &#125;&#125;'\n</code></pre>\n<h3 id=\"针对当前项目的主机和主机组的变量\"><a class=\"anchor\" href=\"#针对当前项目的主机和主机组的变量\">#</a> 针对当前项目的主机和主机组的变量</h3>\n<p>上面的方式是针对所有项目都有效，而官方更建议的方式是使用 ansible 特定项目的主机变量和组变量。生产建议在每个项目对应的目录中创建额外的两个变量目录，分别是 host_vars 和 group_vars</p>\n<ul>\n<li>host_vars 下面的文件名和主机清单主机名一致，针对单个主机进行变量定义格式:host_vars/hostname</li>\n<li>group_vars 下面的文件名和主机清单中组名一致，针对单个组进行变量定义格式: group_vars/groupname</li>\n<li>group_vars/all 文件内定义的变量对所有组都有效</li>\n</ul>\n<p>范例：特定项目的主机和组变量</p>\n<pre><code>[root@ansible ansible]#pwd\n/data/ansible\n[root@ansible ansible]#mkdir host_vars\n[root@ansible ansible]#mkdir group_vars\n[root@ansible ansible]#cat host_vars/10.0.0.8\nid: 2\n[root@ansible ansible]#cat host_vars/10.0.0.7\nid: 1\n[root@ansible ansible]#cat group_vars/webservers\nname: web\n[root@ansible ansible]#cat group_vars/all\ndomain: wang.org\n[root@ansible ansible]#tree host_vars/ group_vars/\nhost_vars/\n├── 10.0.0.7\n└── 10.0.0.8\ngroup_vars/\n├── all\n└── webservers\n0 directories, 4 files\n[root@ansible ansible]#cat test.yml\n- hosts: webservers\ntasks:\n- name: get variable\ncommand: echo &quot;&#123;&#123;name&#125;&#125;&#123;&#123;id&#125;&#125;.&#123;&#123;domain&#125;&#125;&quot;\nregister: result\n- name: print variable\ndebug:\nmsg: &quot;&#123;&#123;result.stdout&#125;&#125;&quot;\n[root@ansible ansible]#ansible-playbook test.yml\nPLAY [webservers]\n********************************************************************************\n***************************************\nTASK [Gathering Facts]\n********************************************************************************\n*******************************\nok: [10.0.0.7]\nok: [10.0.0.8]\nTASK [get variable]\n********************************************************************************\n**********************************\nchanged: [10.0.0.7]\nchanged: [10.0.0.8]\nTASK [print variable]\n********************************************************************************\n********************************\nok: [10.0.0.7] =&gt; &#123;\n&quot;msg&quot;: &quot;web1.wang.org&quot;\n&#125;\nok: [10.0.0.8] =&gt; &#123;\n&quot;msg&quot;: &quot;web2.wang.org&quot;\n&#125;\nPLAY RECAP\n********************************************************************************\n*******************************************\n10.0.0.7 : ok=3 changed=1 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n10.0.0.8 : ok=3 changed=1 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n</code></pre>\n<h2 id=\"template-模板\"><a class=\"anchor\" href=\"#template-模板\">#</a> Template 模板</h2>\n<p>模板是一个文本文件，可以用于根据每个主机的不同环境而为生成不同的文件<br />\n模板文件中支持嵌套 jinja2 语言的指令，来实现变量，条件判断，循环等功能<br />\n需要使用 template 模块实现文件的复制到远程主机，但和 copy 模块不同，复制过去的文件每个主机可以会有所不同</p>\n<h3 id=\"jinja2语言\"><a class=\"anchor\" href=\"#jinja2语言\">#</a> jinja2 语言</h3>\n<p><img data-src=\"../image.assets/1677662324156.png\" alt=\"1677662324156\" /></p>\n<p>Jinja2 是一个现代的，设计者友好的，仿照 Django 模板的 Python 模板语言。 它速度快，被广泛使用，并且提供了可选的沙箱模板执行环境保证安全:<br />\n 特性:</p>\n<ul>\n<li>沙箱中执行</li>\n<li>强大的 HTML 自动转义系统保护系统免受 XSS</li>\n<li>模板继承</li>\n<li>及时编译最优的 python 代码</li>\n<li>可选提前编译模板的时间</li>\n<li>易于调试。异常的行数直接指向模板中的对应行。</li>\n<li>可配置的语法</li>\n</ul>\n<p>官方网站：</p>\n<pre><code>http://jinja.pocoo.org/\nhttps://jinja.palletsprojects.com/en/2.11.x/\n</code></pre>\n<p>官方中文文档</p>\n<pre><code>http://docs.jinkan.org/docs/jinja2/\nhttps://www.w3cschool.cn/yshfid/\n</code></pre>\n<p>jinja2 语言支持多种数据类型和操作:<br />\n 字面量，如：字符串：使用单引号或双引号，数字：整数，浮点数<br />\n列表：[item1, item2, ...]<br />\n 元组：(item1, item2, ...)<br />\n 字典：{key1:value1, key2:value2, ...}<br />\n 布尔型：true/false<br />\n 算术运算：+, -, *, /, //, %, **<br />\n 比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=</p>\n<p>逻辑运算：and，or，not<br />\n 流表达式：For，If，When</p>\n<p><strong>字面量：</strong><br />\n表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python 对象。如 &quot;Hello World&quot;<br />\n 双引号或单引号中间的一切都是字符串。无论何时你需要在模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），如 42，42.23<br />\n 数值可以为整数和浮点数。如果有小数点，则为浮点数，否则为整数。在 Python 里， 42 和 42.0 是不一样的</p>\n<p><strong>算术运算：</strong><br />\nJinja 允许用计算值。支持下面的运算符<br />\n +：把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接<br />\n它们。无论如何这不是首选的连接字符串的方式！连接字符串见～运算符。 2 等于 2<br />\n-：用第一个数减去第二个数。 1 等于 1<br />\n/：对两个数做除法。返回值会是一个浮点数。 0.5 等于 0.5<br />\n//：对两个数做除法，返回整数商。 2 等于 2<br />\n%：计算整数除法的余数。 4 等于 4<br />\n*：用右边的数乘左边的操作数。 4 会返回 4 。也可以用于重 复一个字符串多次。 NaN<br />\n 会打印 80 个等号的横条<br />\n **：取左操作数的右操作数次幂。 8 会返回 8</p>\n<p><strong>比较操作符</strong></p>\n<p>== 比较两个对象是否相等<br />\n！= 比较两个对象是否不等</p>\n<blockquote>\n<p>如果左边大于右边，返回 true<br />\n= 如果左边大于等于右边，返回 true<br />\n&lt; 如果左边小于右边，返回 true<br />\n&lt;= 如果左边小于等于右边，返回 true<br />\n 逻辑运算符</p>\n</blockquote>\n<p>对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式<br />\n and 如果左操作数和右操作数同为真，返回 true<br />\nor 如果左操作数和右操作数有一个为真，返回 true<br />\nnot 对一个表达式取反<br />\n (expr) 表达式组<br />\n true /false true 永远是 true ，而 false 始终是 false</p>\n<h3 id=\"template\"><a class=\"anchor\" href=\"#template\">#</a> template</h3>\n<p>template 功能：可以根据和参考模块文件，动态生成相类似的配置文件<br />\n template 文件存建议放于 templates 目录下，且命名为 .j2 结尾</p>\n<p>yaml/yml 文件和 templates 目录平级，此时 playbook 中指定模版文件时可不用指定路径，目录结构如下<br />\n示例：</p>\n<pre><code>./\n├── temnginx.yml\n└── templates\n   └── nginx.conf.j2\n</code></pre>\n<p>范例：利用 template 同步 nginx 配置文件</p>\n<pre><code>#准备templates/nginx.conf.j2文件\n[root@ansible ~]#vim temnginx.yml\n---\n- hosts: centos7\n  remote_user: root\n  tasks:\n  - name: template config to remote hosts\n    template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf\n    \n[root@ansible ~]#ansible-playbook temnginx.yml\n</code></pre>\n<p>template 变更替换<br />\n范例：</p>\n<pre><code>#修改文件nginx.conf.j2\n[root@ansible ~]#mkdir templates\n[root@ansible ~]#vim templates/nginx.conf.j2\n......\nworker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;;\n......\n[root@ansible ~]#vim temnginx2.yml\n---\n- hosts: centos7\n  remote_user: root\n  tasks:\n  - name: install nginx\n    yum: name=nginx\n  - name: template config to remote hosts\n    template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf\n  - name: start service\n    service: name=nginx state=started enabled=yes\n[root@ansible ~]#ansible-playbook temnginx2.yml\n</code></pre>\n<h2 id=\"roles-角色\"><a class=\"anchor\" href=\"#roles-角色\">#</a> Roles 角色</h2>\n<p>角色是 ansible 自 1.2 版本引入的新特性，用于层次性、结构化地组织 playbook。roles 能够根据层次型结构自动装载变量文件、tasks 以及 handlers 等。要使用 roles 只需要在 playbook 中使用 include 指令即可。简单来讲，roles 就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地 include 它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中<br />\n运维复杂的场景：建议使用 roles，代码复用度高<br />\n roles：多个角色的集合目录， 可以将多个的 role，分别放至 roles 目录下的独立子目录中，如下示例</p>\n<pre><code>roles/\nmysql/\nnginx/\ntomcat/\nredis/\n</code></pre>\n<p>默认 roles 存放路径</p>\n<pre><code>/root/.ansible/roles\n/usr/share/ansible/roles\n/etc/ansible/roles\n</code></pre>\n<p>官方文档:</p>\n<pre><code>https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html\n</code></pre>\n<h3 id=\"ansible-roles目录编排\"><a class=\"anchor\" href=\"#ansible-roles目录编排\">#</a> Ansible Roles 目录编排</h3>\n<p>roles 目录结构如下所示</p>\n<p><img data-src=\"../image.assets/1677664119238.png\" alt=\"1677664119238\" /></p>\n<p>每个角色，以特定的层级目录结构进行组织<br />\n roles 目录结构：</p>\n<pre><code>playbook1.yml\nplaybook2.yml\nroles/\nproject1/\ntasks/\nfiles/\nvars/\ntemplates/\nhandlers/\ndefault/\nmeta/\nproject2/\ntasks/\nfiles/\nvars/\ntemplates/\nhandlers/\ndefault/\nmeta/\n</code></pre>\n<p>Roles 各目录作用<br />\n roles/project/ : 项目名称，有以下子目录</p>\n<ul>\n<li>files/ ：存放由 copy 或 script 模块等调用的文件</li>\n<li>templates/：template 模块查找所需要模板文件的目录</li>\n<li>tasks/：定义 task,role 的基本元素，至少应该包含一个名为 main.yml 的文件；其它的文件需要在此文件中通过 include 进行包含</li>\n<li>handlers/：至少应该包含一个名为 main.yml 的文件；此目录下的其它的文件需要在此文件中通过 include 进行包含</li>\n<li>vars/：定义变量，至少应该包含一个名为 main.yml 的文件；此目录下的其它的变量文件需要在此文件中通过 include 进行包含，也可以通过项目目录中的 group_vars/all 定义变量，从而实现角色通用代码和项目数据的分离</li>\n<li>meta/：定义当前角色的特殊设定及其依赖关系，至少应该包含一个名为 main.yml 的文件，其它文件需在此文件中通过 include 进行包含</li>\n<li>default/：设定默认变量时使用此目录中的 main.yml 文件，比 vars 的优先级低</li>\n</ul>\n<h3 id=\"创建-role\"><a class=\"anchor\" href=\"#创建-role\">#</a> 创建 role</h3>\n<p>创建 role 的步骤</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>1 创建role的目录结构.在以roles命名的目录下分别创建以各角色名称命名的目录，如mysql等,在每个角色命名的目录中分别创建相关的目录和文件,比如tasks、files、handlers、templates和vars等目录；用不到的目录可以创建为空目录，也可以不创建</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>2 编写和准备指定role的功能文件,包括: tasks,templates,vars等相关文件</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>3 编写playbook文件调用上面定义的role,应用到指定的主机</pre></td></tr></table></figure><p>针对大型项目使用 Roles 进行编排<br />\n范例：利用 ansible-galaxy 创建角色目录的结构</p>\n<pre><code>#创建初始化目录结构\n[root@ansible roles]#ansible-galaxy role init test_role\n- Role test_role was created successfully\n[root@ansible roles]#tree test_role/\ntest_role/\n├── defaults\n│ └── main.yml\n├── files\n├── handlers\n│ └── main.yml\n├── meta\n│ └── main.yml\n├── README.md\n├── tasks\n│ └── main.yml\n├── templates\n├── tests\n│ ├── inventory\n│ └── test.yml\n└── vars\n└── main.yml\n8 directories, 8 files\n</code></pre>\n<p>范例：roles 的目录结构</p>\n<pre><code>nginx-role.yml\nroles/\n└── nginx\n├── files\n│ └── nginx.conf\n├── tasks\n│ ├── groupadd.yml\n│ ├── install.yml\n│ ├── main.yml\n│ ├── restart.yml\n│ └── useradd.yml\n└── vars\n└── main.yml\n</code></pre>\n<h3 id=\"playbook-调用角色\"><a class=\"anchor\" href=\"#playbook-调用角色\">#</a> Playbook 调用角色</h3>\n<p>调用角色方法 1：</p>\n<pre><code>---\n- hosts: webservers\n  remote_user: root\n  roles:\n    - mysql\n    - memcached\n    - nginx\n</code></pre>\n<p>调用角色方法 2：<br />\n键 role 用于指定角色名称，后续的 k/v 用于传递变量给角色</p>\n<pre><code>---\n- hosts: all\n  remote_user: root\n  roles:\n    - role: mysql\n    username: mysql\n    - &#123; role: nginx, username: nginx &#125;\n</code></pre>\n<p>调用角色方法 3：<br />\n还可基于条件测试实现角色调用</p>\n<pre><code>---\n- hosts: all\n  remote_user: root\n  roles:\n   - &#123; role: nginx, username: nginx, when: ansible_distribution_major_version == '7' &#125;\n</code></pre>\n<h3 id=\"roles-中-tags-使用\"><a class=\"anchor\" href=\"#roles-中-tags-使用\">#</a> Roles 中 Tags 使用</h3>\n<pre><code>[root@ansible ~]#vi app-role.yml\n---\n#可以有多个play\n- hosts: lbserver\n  roles:\n    - role: haproxy\n    - role: keepalived\n    - hosts: appsrvs\n  remote_user: root\n  roles:\n    - &#123; role: nginx ,tags: [ 'nginx', 'web' ] ,when:\n    ansible_distribution_major_version == &quot;6&quot; &#125;\n    - &#123; role: httpd ,tags: [ 'httpd', 'web' ] &#125;\n    - &#123; role: mysql ,tags: [ 'mysql', 'db' ] &#125;\n    - role: mariadb\n      tags:\n      - mariadb\n      - db\n  tags: app #play的tag\n[root@ansible ~]#ansible-playbook --tags=&quot;nginx,mysql&quot; app-role.yml\n</code></pre>\n<h3 id=\"实战案例\"><a class=\"anchor\" href=\"#实战案例\">#</a> 实战案例</h3>\n<h4 id=\"实现httpd角色\"><a class=\"anchor\" href=\"#实现httpd角色\">#</a> 实现 httpd 角色</h4>\n<pre><code># 创建role目录\n[root@ansible data]# ansible-galaxy role init httpd\n- Role htppd was created successfully\n[root@ansible data]# tree httpd/\nhttpd/\n├── defaults\n│   └── main.yml\n├── files\n├── handlers\n│   └── main.yml\n├── meta\n│   └── main.yml\n├── README.md\n├── tasks\n│   └── main.yml\n├── templates\n├── tests\n│   ├── inventory\n│   └── test.yml\n└── vars\n    └── main.yml\n\n8 directories, 8 files\n[root@ansible data]# \n\n#main.yml 是task的入口文件\n[root@ansible tasks]# cat main.yml \n---\n# tasks file for httpd\n- include: group.yml\n- include: user.yml\n- include: install_httpd.yml\n- include: config.yml\n- inclusde: index.yml\n- include: service.yml\n[root@ansible tasks]# \n\n# 创建用户组\n[root@ansible httpd]# cat tasks/group.yml \n- name: add group \n  group: name=&#123;&#123; httpd_group&#125;&#125; system=yes gid=&#123;&#123; httpd_gid &#125;&#125;\n[root@ansible htppd]# \n\n# 创建用户\n[root@ansible httpd]# cat tasks/user.yml \n- name: add httpd user\n  user: name=&#123;&#123; httpd_user &#125;&#125; system=yes shel=/sbin/nologin home=/var/www uid=&#123;&#123; httpd_uid &#125;&#125; group=&#123;&#123; httpd_group &#125;&#125;\n[root@ansible htppd]# \n\n# yum install httpd\n[root@ansible httpd]# cat tasks/install_httpd.yml \n- name: install httpd\n  yum: name=httpd\n[root@ansible httpd]# \n\n# 拷贝配置文件\n#注意: 文件是放在files目录下,但src的路径无需写files目录名\n[root@ansible htppd]# cat tasks/config.yml\n- name: httpd config\n  copy: src=httpd.conf dest=/etc/httpd/conf backup=yes\n  notify: restart httpd\n \n # 准备测试文件\n[root@ansible htppd]# cat tasks/index.yml \n- name: copy index.html\n  copy: src=index.html dest=/var/www/html\n[root@ansible htppd]# \n\n# start httpd\n[root@ansible htppd]# cat tasks/service.yml \n- name: start httpd\n  service: name=httpd state=started enabled=yes\n[root@ansible htppd]# \n\n# 配置文件修改则重启httpd\n[root@ansible htppd]# cat handlers/main.yml \n---\n# handlers file for httpd\n- name: restart httpd\n  service: name=httpd state=restarted\n[root@ansible htppd]# \n\n#在files目录下准备两个文件\n[root@ansible data]# ll httpd/files\ntotal 16\n-rw-r--r-- 1 root root 11753 Mar  1 18:36 httpd.conf\n-rw-r--r-- 1 root root    23 Mar  1 21:10 index.html\n\n# 准备变量文件\n[root@ansible data]# cat httpd/vars/main.yml \n---\n# vars file for httpd\nhttpd_group: apache\nhttpd_gid: 88\nhttpd_user: apache\nhttpd_uid: 88\n[root@ansible data]# \n\n#在playbook中调用角色\n[root@ansible data]# cat web_roles.yml \n---\n- hosts: centos7\n  remote_user: root\n  roles:\n    - httpd\n    \n#运行playbook\n[root@ansible data]# ansible-playbook /data/web_roles.yml\n</code></pre>\n<h4 id=\"实现nginx角色\"><a class=\"anchor\" href=\"#实现nginx角色\">#</a> 实现 Nginx 角色</h4>\n<pre><code># 创建roles目录\n[root@ansible data]# ansible-galaxy init nginx\n- Role nginx was created successfully\n[root@ansible data]# ll\ntotal 12\n-rw-r--r--  1 root root  614 Mar  1 21:07 ansible.cfg\n-rw-r--r--  1 root root 1382 Mar  1 21:07 hosts\ndrwxr-xr-x 10 root root  154 Mar  1 18:07 httpd\ndrwxr-xr-x 10 root root  154 Mar  1 21:52 nginx\n-rw-r--r--  1 root root   63 Mar  1 21:14 web_roles.yml\n[root@ansible data]# \n\n# 创建tasks文件\n[root@ansible data]# cat nginx/tasks/main.yml \n---\n# tasks file for nginx\n- include: install_nginx.yml\n- import_playbook: config.yml\n- include: index.yml\n- import_playbook: service.yml\n[root@ansible data]#\n\n# 安装nginx\n[root@ansible data]# cat nginx/tasks/install_nginx.yml\n---\n- name: install nginx\n  yum:\n    name: nginx\n    state: present\n[root@ansible data]# \n\n# 配置文件\n[root@ansible data]# cat nginx/tasks/config.yml\n---\n- name: copy config\n  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf\n  notify: restart nginx\n  \n# 创建测试文件\n[root@ansible data]# cat nginx/tasks/index.yml\n---\n- name: copt index.html\n  copy: src=index.html dest=/usr/share/nginx/html/\n\n# 启动nginx\n[root@ansible data]# cat nginx/tasks/service.yml\n---\n- name: start nginx\n  service: name=nginx state=started enabled=yes\n  \n#创建handler文件\n[root@ansible data]# cat nginx/handlers/main.yml \n---\n# handlers file for nginx\n- name: restart nginx\n  service: naem=nginx state=restarted\n[root@ansible data]# ll\n\n#创建template文件\n[root@ansible data]# ll nginx/templates/\ntotal 4\n-rw-r--r-- 1 root root 2336 Mar  1 22:12 nginx.conf.j2\n[root@ansible data]# \n\n\n# 创建测试文件\n[root@ansible data]# ll nginx/files/\ntotal 4\n-rw-r--r-- 1 root root 23 Mar  1 22:14 index.html\n[root@ansible data]#\n\n#在playbook中调用角色\n[root@ansible data]# cat web_roles.yml \n---\n- hosts: centos7\n  remote_user: root\n  roles:\n  #  - httpd\n    - nginx\n[root@ansible data]# \n#运行playbook\n[root@ansible data]# ansible-playbook web_roles.yml \n</code></pre>\n<h4 id=\"实现mysql8角色\"><a class=\"anchor\" href=\"#实现mysql8角色\">#</a> 实现 MySql8 角色</h4>\n<ul>\n<li>创建角色目录</li>\n</ul>\n<pre><code>[root@ansible data]# ansible-galaxy init mysql8\n[root@ansible data]# ll\ntotal 12\n-rw-r--r--  1 root root  614 Mar  1 21:07 ansible.cfg\n-rw-r--r--  1 root root 1382 Mar  1 21:07 hosts\ndrwxr-xr-x 10 root root  154 Mar  1 18:07 httpd\ndrwxr-xr-x 10 root root  154 Mar  1 22:55 mysql8\ndrwxr-xr-x  8 root root  125 Mar  1 22:44 nginx\n-rw-r--r--  1 root root   75 Mar  1 22:38 web_roles.yml\n[root@ansible data]# \n</code></pre>\n<ul>\n<li>创建 tasks yml 文件</li>\n</ul>\n<pre><code># 安装包\n[root@ansible data]# cat mysql8/tasks/install_package.yml\n---\n- name: install package\n  yum: name=&#123;&#123; item &#125;&#125; state=latest\n  loop:\n    - libaio\n    - numactl-libs\n    \n# add group\n[root@ansible data]# cat mysql8/tasks/group.yml\n---\n- name: add group\n  group: name=&#123;&#123; group &#125;&#125; gid=&#123;&#123; group_gid &#125;&#125;\n[root@ansible data]# \n\n# add user\n[root@ansible data]# cat mysql8/tasks/user.yml\n---\n- name: add user\n  user: name=&#123;&#123; user &#125;&#125; uid=&#123;&#123; user_uid &#125;&#125; shell=/sbin/nologin group=&#123;&#123; group &#125;&#125; create_home=no system=yes home=/data/mysql\n[root@ansible data]# \n\n# 准备my.cnf文件\n[root@ansible data]# cat mysql8/files/my.cnf\n[mysqld]\nserver-id=1\nlog-bin\ndatadir=/data/mysql\nsocket=/data/mysql/mysql.sock\nlog-error=/data/mysql/mysql.log\npid-file=/data/mysql/mysql.pid\n[client]\nsocket=/data/mysql/mysql.sock\n\n# 准备mysql二进制包\n[root@ansible data]# ll mysql8/files/\ntotal 1176056\n-rw-r--r-- 1 root root        181 Mar  1 23:10 my.cnf\n-rw-r--r-- 1 root root 1204277208 Dec 18  2021 mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz\n[root@ansible data]# \n\n# 将mysql二进制包解压到远程主机\n[root@ansible data]# cat mysql8/tasks/unarchive.yml\n---\n- name: copy mysql tar host\n  # mysql_tar 为mysql二进制的压缩包名称\n  unarchive: src=&#123;&#123; mysql_tar &#125;&#125; dest=/usr/local/ owner=root group=root\n[root@ansible data]# \n\n# 将远程主机解压出的二进制包创建软连接\n[root@ansible data]# cat mysql8/tasks/linkfile.yml\n---\n- name: create link\n  file: src=/usr/local/mysql-&#123;&#123; mysql_version &#125;&#125;-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link\n[root@ansible data]# \n\n# 初始化数据库\n[root@ansible data]# cat mysql8/tasks/init_mysql_data.yml\n---\n- name: create datadir dir\n  file: path=/data/mysql state=directory owner=&#123;&#123; user &#125;&#125; group=</code></pre>\n",
            "tags": [
                "Ansible"
            ]
        },
        {
            "id": "http://blog.itshare.work/Ansible/Ansible/",
            "url": "http://blog.itshare.work/Ansible/Ansible/",
            "title": "运维自动化工具Ansible(一)",
            "date_published": "2023-02-21T11:12:21.000Z",
            "content_html": "<h1 id=\"ansible介绍和架构\"><a class=\"anchor\" href=\"#ansible介绍和架构\">#</a> Ansible 介绍和架构</h1>\n<h2 id=\"ansible发展史\"><a class=\"anchor\" href=\"#ansible发展史\">#</a> Ansible 发展史</h2>\n<p>Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗<br />\n 2012-03-09，发布 0.0.1 版，2015-10-17，Red Hat 宣布 1.5 亿美元收购<br />\n官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5zaWJsZS5jb20v\">https://www.ansible.com/</span><br />\n 官方文档：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmFuc2libGUuY29tLw==\">https://docs.ansible.com/</span></p>\n<h2 id=\"ansible-功能\"><a class=\"anchor\" href=\"#ansible-功能\">#</a> Ansible 功能</h2>\n<ul>\n<li>批量执行远程命令，可以对远程的多台主机同时进行命令的执行</li>\n<li>批量安装和配置软件服务，可以对远程的多台主机进行自动化的方式配置和管理各种服务</li>\n<li>编排高级的企业级复杂的 IT 架构任务，Ansible 的 Playbook 和 role 可以轻松实现大型的 IT 复杂架构</li>\n<li>提供自动化运维工具的开发 API, 有很多运维工具，如 jumpserver 就是基于 ansible 实现自动化管工功能</li>\n</ul>\n<h2 id=\"ansible-特点\"><a class=\"anchor\" href=\"#ansible-特点\">#</a> Ansible 特点</h2>\n<p><strong>优点</strong></p>\n<ul>\n<li>功能丰富的模块：提供了多达数千个的各种功能的模块，完成特定任务只需调用特定模块即可，还</li>\n<li>支持自定义模块，可使用任何编程语言写模块</li>\n<li>使用和部署简单：无需安装专用代理软件，基于 python 和 SSH (默认已安装) 实现</li>\n<li>安全：基于 OpenSSH 实现安全通讯无需专用协议</li>\n<li>幂等性：一个任务执行 1 遍和执行 n 遍效果一样，不因重复执行带来意外情况，此特性和模块有关</li>\n<li>支持 playbook 编排任务，YAML 格式，编排任务，支持丰富的数据结构</li>\n<li>较强大的多层解决方案 Role</li>\n<li>Python 语言实现，基于 Paramiko（python 对 ssh 的实现），PyYAML，Jinja2（模板语言）三个关键模块</li>\n<li>属于红帽 (IBM) 公司产品，背景强大，未来发展前景光明</li>\n</ul>\n<p><strong>缺点</strong></p>\n<ul>\n<li>如果管理的主机较多时，执行效率不如 saltstack 高</li>\n<li>当前还不支持像 MySQL 数据库一样的事务回滚</li>\n</ul>\n<h2 id=\"ansible-架构\"><a class=\"anchor\" href=\"#ansible-架构\">#</a> Ansible 架构</h2>\n<h3 id=\"ansible-组成\"><a class=\"anchor\" href=\"#ansible-组成\">#</a> Ansible 组成</h3>\n<p>组合 INVENTORY、API、MODULES、PLUGINS 的绿框，为 ansible 命令工具，其为核心执行工具</p>\n<p><img data-src=\"../image.assets/1676984392121.png\" alt=\"1676984392121\" /></p>\n<ul>\n<li>INVENTORY：Ansible 管理主机的清单文件，默认为 /etc/ansible/hosts</li>\n<li>MODULES：Ansible 执行命令的功能模块，多数为内置核心模块，也可自定义</li>\n<li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li>\n<li>API：供第三方程序调用的应用程序编程接口</li>\n</ul>\n<h3 id=\"ansible-命令执行来源\"><a class=\"anchor\" href=\"#ansible-命令执行来源\">#</a> Ansible 命令执行来源</h3>\n<ul>\n<li>USER 普通用户，即 SYSTEM ADMINISTRATOR</li>\n<li>PLAYBOOKS：任务剧本（任务集），编排定义 Ansible 任务集的配置文件，由 Ansible 顺序依次执行，通常是 JSON 格式的 YML 文件</li>\n<li>CMDB（配置管理数据库） API 调用</li>\n<li>PUBLIC/PRIVATE CLOUD API 调用</li>\n<li>USER-&gt; Ansible Playbook -&gt; Ansibile</li>\n</ul>\n<h3 id=\"注意事项\"><a class=\"anchor\" href=\"#注意事项\">#</a> 注意事项</h3>\n<ul>\n<li>执行 ansible 的主机一般称为管理端，主控端，中控，master 或堡垒机</li>\n<li>主控端 Python 版本需要 2.6 或以上</li>\n<li>被控端 Python 版本小于 2.4，需要安装 python-simplejson</li>\n<li>被控端如开启 SELinux 需要安装 libselinux-python</li>\n<li>windows 不能做为主控端，只能做为被控制端</li>\n</ul>\n<h1 id=\"ansible-安装和常见模块\"><a class=\"anchor\" href=\"#ansible-安装和常见模块\">#</a> Ansible 安装和常见模块</h1>\n<h2 id=\"ansible-安装\"><a class=\"anchor\" href=\"#ansible-安装\">#</a> Ansible 安装</h2>\n<p>ansible 的安装方法有多种<br />\n官方文档</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>https://docs.ansible.com/ansible/latest/installation_guide/index.html</pre></td></tr></table></figure><p>下载</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>https://releases.ansible.com/ansible/</pre></td></tr></table></figure><p>pip 下载</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>https://pypi.org/project/ansible/</pre></td></tr></table></figure><h3 id=\"包安装方式\"><a class=\"anchor\" href=\"#包安装方式\">#</a> 包安装方式</h3>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>#CentOS 的EPEL源的rpm包安装</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root@centos ~]#yum install ansible</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>#ubuntu 安装</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[root@ubuntu ~]#apt -y install ansible</pre></td></tr></table></figure><h3 id=\"pip安装\"><a class=\"anchor\" href=\"#pip安装\">#</a> pip 安装</h3>\n<p>pip 是安装 Python 包的管理器，类似 yum<br />\n 范例：在 rocky8 上通过 pip3 安装 ansible</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@rocky8 ~]#yum -y install python39 rust</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root@rocky8 ~]#pip3 install ansible</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[root@rocky8 ~]#ansible --version</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ansible [core 2.12.6]</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>config file = None</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ansible python module location = /usr/lib/python3.9/site-packages/ansible</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ansible collection location =</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/root/.ansible/collections:/usr/share/ansible/collections</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>(Red Hat 8.5.0-3)]</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>jinja version = 3.1.2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>libyaml = True</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>[root@rocky8 ~]#ansible-doc -l 2> /dev/null|wc -l</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>6763</pre></td></tr></table></figure><p>范例：安装 python3.8 支持 ansible2.12 以上版本</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@rocky8 ~]#yum -y install python38 python38-pip</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[root@rocky8 ~]#ansible --version</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ansible [core 2.12.6]</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>config file = None</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ansible python module location = /usr/local/lib/python3.8/site-</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>packages/ansible</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ansible collection location =</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>/root/.ansible/collections:/usr/share/ansible/collections</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>executable location = /usr/local/bin/ansible</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>python version = 3.8.8 (default, Nov 9 2021, 13:31:34) [GCC 8.5.0 20210514</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>(Red Hat 8.5.0-3)]</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>jinja version = 3.1.2</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>libyaml = True</pre></td></tr></table></figure><p>范例：安装默认的 python3.6 版本会有警报提示</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@rocky8 ~]#yum -y install python3</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[root@rocky8 ~]#ansible --version</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>[DEPRECATION WARNING]: Ansible will require Python 3.8 or newer on the</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>controller starting with Ansible 2.12. Current version: 3.6.8 (default, Nov</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>9 2021, 14:44:26) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)]. This feature will be</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>removed from ansible-core in version 2.12. Deprecation warnings</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>can be disabled by setting deprecation_warnings=False in ansible.cfg.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/usr/local/lib/python3.6/site-packages/ansible/parsing/vault/__init__.py:44:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>CryptographyDeprecationWarning: Python 3.6 is no longer supported by the Python</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>core team. Therefore, support for it is deprecated in cryptography and will be</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>removed in a future release.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>from cryptography.exceptions import InvalidSignature</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ansible [core 2.11.12]</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>config file = None</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ansible python module location = /usr/local/lib/python3.6/site-</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>packages/ansible</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ansible collection location =</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>/root/.ansible/collections:/usr/share/ansible/collections</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>executable location = /usr/local/bin/ansible</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>python version = 3.6.8 (default, Nov 9 2021, 14:44:26) [GCC 8.5.0 20210514</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>(Red Hat 8.5.0-3)]</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>jinja version = 3.0.3</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>libyaml = True</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>[root@rocky8 ~]#ansible-doc -l 2> /dev/null|wc -l</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>6141</pre></td></tr></table></figure><p><img data-src=\"../image.assets/1676985923345.png\" alt=\"1676985923345\" /></p>\n<p>范例</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos7 ~]#yum -y install python-pip</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root@centos7 ~]#pip install --upgrade pip</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[root@centos7 ~]#pip install ansible --upgrade</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[root@centos7 ~]#ansible --version</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/usr/lib64/python2.7/site-packages/cryptography/__init__.py:39:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CryptographyDeprecationWarning: Python 2 is no longer supported by the Python</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>core team. Support for it is now deprecated in cryptography, and will be removed</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>in a future release.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>CryptographyDeprecationWarning,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ansible 2.9.12</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>config file = None</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>configured module search path = [u'/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>u'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ansible python module location = /usr/lib/python2.7/site-packages/ansible</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>python version = 2.7.5 (default, Apr 2 2020, 13:16:51) [GCC 4.8.5 20150623</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>(Red Hat 4.8.5-39)]</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>[root@centos7 ~]#ll /opt/etc/ansible/ansible.cfg</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>-rw-r--r-- 1 wang bin 19980 Aug 11 21:34 /opt/etc/ansible/ansible.cfg</pre></td></tr></table></figure><h3 id=\"确认安装\"><a class=\"anchor\" href=\"#确认安装\">#</a> 确认安装</h3>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@ansible ~]#ansible --version</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ansible 2.9.5</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>config file = /etc/ansible/ansible.cfg</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ansible python module location = /usr/lib/python3.6/site-packages/ansible</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>(Red Hat 8.3.1-4)]</pre></td></tr></table></figure><h2 id=\"ansible-相关文件\"><a class=\"anchor\" href=\"#ansible-相关文件\">#</a> Ansible 相关文件</h2>\n<h3 id=\"ansible-配置文件列表\"><a class=\"anchor\" href=\"#ansible-配置文件列表\">#</a> Ansible 配置文件列表</h3>\n<ul>\n<li>/etc/ansible/ansible.cfg 主配置文件，配置 ansible 工作特性，也可以在项目的目录中创建此文件，当前目录下如果也有 ansible.cfg, 则此文件优先生效，建议每个项目目录下，创建独有的 ansible.cfg 文<br />\n件</li>\n<li>/etc/ansible/hosts 主机清单</li>\n<li>/etc/ansible/roles/ 存放角色的目录</li>\n</ul>\n<h3 id=\"ansible-主配置文件\"><a class=\"anchor\" href=\"#ansible-主配置文件\">#</a> Ansible 主配置文件</h3>\n<p>Ansible 的配置文件可以放在多个不同地方，优先级从高到低顺序如下</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ANSIBLE_CONFIG #环境变量,目录下的文件必须存在才能生效</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./ansible.cfg #当前目录下的ansible.cfg,一般一个项目对应一个专用配置文件,推荐使用</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>~/.ansible.cfg #当前用户家目录下的.ansible.cfg</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/etc/ansible/ansible.cfg #系统默认配置文件</pre></td></tr></table></figure><p>Ansible 的默认配置文件 /etc/ansible/ansible.cfg , 其中大部分的配置内容无需进行修改</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[defaults]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>#inventory = /etc/ansible/hosts #主机列表配置文件</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>#library = /usr/share/my_modules/ #库文件存放目录</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>#remote_tmp = $HOME/.ansible/tmp #临时py命令文件存放在远程主机目录</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>#local_tmp = $HOME/.ansible/tmp #本机的临时命令执行目录</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>#forks = 5 #默认并发数</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>#sudo_user = root #默认sudo 用户</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>#ask_sudo_pass = True #每次执行ansible命令是否询问ssh密码</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>#ask_pass = True</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>#remote_port = 22</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>#host_key_checking = False #检查对应服务器的host_key，建议取消此行注释,实现第一次连</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>接自动信任目标主机</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>#log_path=/var/log/ansible.log #日志文件，建议启用</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>#module_name = command #默认模块，可以修改为shell模块</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>[privilege_escalation] #普通用户提权配置</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>#become=True</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>#become_method=sudo</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>#become_user=root</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>#become_ask_pass=False</pre></td></tr></table></figure><p>范例：通过环境变量 ANSIBLE_CONFIG 指定 ansible 配置文件路径</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@rocky8 ~]#cd /data/ansible/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root@rocky8 ansible]#cat ansbile.cfg</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[defaults]</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>inventory = ./hosts</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>[root@rocky8 ansible]#cat hosts</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>[ubuntu]</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>10.0.0.100</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>[centos]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>10.0.0.7</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>10.0.0.8</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>#定义变量</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>[root@rocky8 ansible]#export ANSIBLE_CONFIG=./ansbile.cfg</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>[root@rocky8 ansible]#ansible --version</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ansible [core 2.12.6]</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>config file = /data/ansible/ansbile.cfg</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ansible python module location = /usr/lib/python3.9/site-packages/ansible</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ansible collection location =</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>/root/.ansible/collections:/usr/share/ansible/collections</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>(Red Hat 8.5.0-3)]</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>jinja version = 3.1.2</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>libyaml = True</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>[root@rocky8 ansible]#ansible --list-hosts all</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>hosts (3):</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>10.0.0.100</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>10.0.0.7</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>10.0.0.8</pre></td></tr></table></figure><p>范例：创建 ansible 指定项目专用的配置文件</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@ubuntu2004 ~]#ansible --version</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ansible 2.9.6</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>config file = /etc/ansible/ansible.cfg</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ansible python module location = /usr/lib/python3/dist-packages/ansible</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>[root@ubuntu2004 ~]#mkdir /data/ansible -p</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>[root@ubuntu2004 ~]#cd /data/ansible/</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>[root@ubuntu2004 ansible]#touch ansible.cfg</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>[root@ubuntu2004 ansible]#ansible --version</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ansible 2.9.6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>config file = /data/ansible/ansible.cfg</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ansible python module location = /usr/lib/python3/dist-packages/ansible</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>[root@ubuntu2004 ansible]#cd</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>[root@ubuntu2004 ~]#ansible --version</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ansible 2.9.6</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>config file = /etc/ansible/ansible.cfg</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>ansible python module location = /usr/lib/python3/dist-packages/ansible</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]</pre></td></tr></table></figure><p>范例：当前目录下的 ansible 的配置文件优先生效</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@ansible ~]#ansible --version</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ansible 2.9.17</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>config file = /etc/ansible/ansible.cfg</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ansible python module location = /usr/lib/python3.6/site-packages/ansible</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>(Red Hat 8.3.1-5)]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>[root@ansible ~]#cp /etc/ansible/ansible.cfg .</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>[root@ansible ~]#ansible --version</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ansible 2.9.17</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>config file = /root/ansible.cfg #注意配置文件路径</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>configured module search path = ['/root/.ansible/plugins/modules',</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>'/usr/share/ansible/plugins/modules']</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ansible python module location = /usr/lib/python3.6/site-packages/ansible</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>executable location = /usr/bin/ansible</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>(Red Hat 8.3.1-5)]</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>[root@ansible ~]#</pre></td></tr></table></figure><h3 id=\"inventory-主机清单文件\"><a class=\"anchor\" href=\"#inventory-主机清单文件\">#</a> Inventory 主机清单文件</h3>\n<p>ansible 的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在 inventory 主机清单文件中将其分组组织<br />\n默认的 inventory file 为 /etc/ansible/hosts<br />\ninventory file 可以有多个，且也可以通过 Dynamic Inventory 来动态生成<br />\n注意:</p>\n<ul>\n<li>生产建议在每个项目目录下创建项目独立的 hosts 文件</li>\n<li>通过项目目录下的 ansible.cfg 文件中的 inventory = ./hosts 实现</li>\n</ul>\n<p>官方文档:</p>\n<figure class=\"highlight url\"><figcaption data-lang=\"url\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token scheme\">https<span class=\"token scheme-delimiter\">:</span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">docs.ansible.com</span></span><span class=\"token path\"><span class=\"token path-separator\">/</span>ansible<span class=\"token path-separator\">/</span>latest<span class=\"token path-separator\">/</span>user_guide<span class=\"token path-separator\">/</span>intro_inventory.html</span></pre></td></tr></table></figure><p><strong>主机清单文件格式</strong><br />\n inventory 文件遵循 INI 文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中，此外，当如若目标主机使用了非默认的 SSH 端口，还可以在主机名称之后使用冒号加端口号来标明，如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机<br />\n<strong> Inventory 参数说明</strong></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ansible_ssh_host #将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ansible_ssh_port #ssh端口号.如果不是默认的端口号,通过此变量设置.这种可以使用 ip:端口</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>192.168.1.100:2222</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ansible_ssh_user #默认的 ssh 用户名</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ansible_ssh_pass #ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥)</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ansible_sudo_pass #sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass)</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ansible_sudo_exe (new in version 1.8) #sudo 命令路径(适用于1.8及以上版本)</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ansible_connection #与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 'smart','smart' 方式会根据是否支持 ControlPersist,来判断'ssh' 方式是否可行.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ansible_ssh_private_key_file #ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ansible_shell_type #目标系统的shell类型.默认情况下,命令的执行使用 'sh' 语法,可设置为'csh' 或 'fish'.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ansible_python_interpreter #目标主机的 python 路径.适用于的情况: 系统中有多个 Python,或者命令路径不是\"/usr/bin/python\",比如 \\*BSD, 或者 /usr/bin/python 不是 2.X 版本的Python.之所以不使用 \"/usr/bin/env\" 机制,因为这要求远程用户的路径设置正确,且要求 \"python\"可执行程序名不可为 python以外的名字(实际有可能名为python26).与ansible_python_interpreter 的工作方式相同,可设定如 ruby 或 perl 的路径....</pre></td></tr></table></figure><p>范例：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ntp.wang.org</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[webservers]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>www1.wang.org:2222</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>www2.wang.org</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>[dbservers]</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>db1.wang.org</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>db2.wang.org</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>db3.wang.org</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>#或者</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>db[1:3].wang.org</pre></td></tr></table></figure><p>范例：组嵌套</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[webservers]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>www[1:100].example.com</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[dbservers]</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>db-[a:f].example.com</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>[appservers]</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>10.0.0.[1:100]</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>#定义testsrvs组中包括两个其它分组,实现组嵌套</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>[testsrvs:children]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>webservers</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>dbservers</pre></td></tr></table></figure><p>范例：基于用户名和密码的 ssh 连接主机清单</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[test]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>10.0.0.8 ansible_connection=local #指定本地连接,无需ssh配置</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>#每个主机分别指定用户和密码,ansible_connection=ssh 需要StrictHostKeyChecking no 或者host_key_checking = False</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>10.0.0.7 ansible_connection=ssh ansible_ssh_port=2222 ansible_ssh_user=wangansible_ssh_password=123456</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>10.0.0.6 ansible_ssh_user=root ansible_ssh_password=123456</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>#对每个分组的所有主机统一定义用户和密码,执行ansible命令时显示别名,如web01</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>[websrvs]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>web01 ansible_ssh_host=10.0.0.101</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>web02 ansible_ssh_host=10.0.0.102</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>[websrvs:vars]</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ansible_ssh_password=magedu</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>some_host ansible_ssh_port=2222 ansible_ssh_user=manager</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>aws_host ansible_ssh_private_key_file=/home/example/.ssh/aws.pem</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>freebsd_host ansible_python_interpreter=/usr/local/bin/python</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ruby_module_host ansible_ruby_interpreter=/usr/bin/ruby.1.9.3</pre></td></tr></table></figure><h2 id=\"ansible相关工具\"><a class=\"anchor\" href=\"#ansible相关工具\">#</a> Ansible 相关工具</h2>\n<ul>\n<li>\n<p>/usr/bin/ansible 主程序，临时命令执行工具</p>\n</li>\n<li>\n<p>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具，相当于 man</p>\n</li>\n<li>\n<p>/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具，相当于脚本</p>\n</li>\n<li>\n<p>/usr/bin/ansible-pull 远程执行命令的工具</p>\n</li>\n<li>\n<p>/usr/bin/ansible-vault 文件加密工具</p>\n</li>\n<li>\n<p>/usr/bin/ansible-console 基于 Console 界面与用户交互的执行工具</p>\n</li>\n<li>\n<p>/usr/bin/ansible-galaxy 下载 / 上传优秀代码或 Roles 模块的官网平台</p>\n</li>\n</ul>\n<p><strong>利用 ansible 实现管理的主要方式：</strong></p>\n<ul>\n<li>\n<p>Ansible Ad-Hoc 即利用 ansible 命令，主要用于临时命令使用场景</p>\n</li>\n<li>\n<p>Ansible playbook 主要用于长期规划好的，大型项目的场景，需要有前期的规划过程</p>\n</li>\n</ul>\n<p><strong>ansible 使用前准备</strong><br />\n ansible 相关工具大多数是通过 ssh 协议，实现对远程主机的配置管理、应用部署、任务执行等功能<br />\n建议：使用此工具前，先配置 ansible 主控端能基于密钥认证的方式联系各个被管理节点<br />\n范例：利用 sshpass 批量实现基于 key 验证脚本 1</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos8 ~]#vim /etc/ssh/ssh_config</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>#修改下面一行</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>StrictHostKeyChecking no</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[root@centos8 ~]#cat hosts.list</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>192.168.32.178</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>192.168.32.179</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>[root@centos8 ~]#vim push_ssh_key.sh</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>#!/bin/bash</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>rpm -ql shpass &amp;> /dev/null || yum -y install sshpass</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P ''</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>export SSHPASS=123456</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>while read IP;do</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tsshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>done &lt; hosts.list</pre></td></tr></table></figure><p>范例：实现基于 key 验证的脚本 2</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos8 ~]#cat ssh_key.sh</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>#!/bin/bash</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PLIST=\"</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>192.168.32.178</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>192.168.32.179\"</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rpm -q sshpass &amp;> /dev/null || yum -y install sshpass</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P ''</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>export SSHPASS=123456</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>for IP in $IPLIST;do</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>       &#123; sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP; &#125; &amp;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>done</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>wait</pre></td></tr></table></figure><h3 id=\"ansible-doc\"><a class=\"anchor\" href=\"#ansible-doc\">#</a> ansible-doc</h3>\n<p>此工具用来显示模块帮助，相当于 man<br />\n 格式</p>\n<pre><code>ansible-doc [options] [module...]\n-l, --list #列出可用模块\n-s, --snippet #显示指定模块的playbook片段\n</code></pre>\n<p>范例：查看帮助</p>\n<pre><code>[root@rocky ~]# ansible-doc --help\nusage: ansible-doc [-h] [--version] [-v] [-M MODULE_PATH] [--playbook-dir BASEDIR]\n                   [-t &#123;become,cache,callback,cliconf,connection,httpapi,inventory,lookup,netconf,shell,vars,module,strategy,role,keyword&#125;]\n                   [-j] [-r ROLES_PATH] [-e ENTRY_POINT | -s | -F | -l | --metadata-dump] [--no-fail-on-errors]\n                   [plugin ...]\n\nplugin documentation tool\n\npositional arguments:\n  plugin                Plugin\n\n</code></pre>\n<p>范例：</p>\n<pre><code>#列出所有模块\nansible-doc -l\n#查看指定模块帮助用法\nansible-doc ping\n#查看指定模块帮助用法\nansible-doc -s ping\n</code></pre>\n<p>范例：查看指定的插件</p>\n<pre><code>[root@rocky ~]# ansible-doc -t connection -l\nlocal        execute on controller                                                                                                 \nparamiko_ssh Run tasks via python ssh (paramiko)                                                                                   \npsrp         Run tasks over Microsoft PowerShell Remoting Protocol                                                                 \nssh          connect via SSH client binary                                                                                         \nwinrm        Run tasks over Microsoft's WinRM                                                                                      \n[root@rocky ~]# \n[root@rocky ~]# ansible-doc -t lookup -l\nconfig              Lookup current Ansible configuration values                                                                    \ncsvfile             read data from a TSV or CSV file                                                                               \ndict                returns key/value pair items from dictionaries                                                                 \nenv                 Read the value of environment variables                                                                        \nfile                read file contents                                                                                             \nfileglob            list files matching a pattern                                                                                  \nfirst_found         return first file found from list                                                                              \nindexed_items       rewrites lists to return 'indexed items'                                                                       \nini                 read data from an ini file                                                                                     \ninventory_hostnames list of inventory hosts matching a host pattern                                                                \nitems               list of items                                                                                                  \nlines               read lines from command                                                                                        \nlist                simply returns what it is given                                                                                \nnested              composes a list with nested elements of other lists                                                            \npassword            retrieve or generate a random password, stored in a file                                                       \npipe                read output from a command                                                                                     \nrandom_choice       return random element from list                                                                                \nsequence            generate a list based on a number sequence                                                                     \nsubelements         traverse nested key from a list of dictionaries                                                                \ntemplate            retrieve contents of file after templating with Jinja2                                                         \ntogether            merges lists into synchronized list                                                                            \nunvault             read vaulted file(s) contents                                                                                  \nurl                 return contents from URL                                                                                       \nvarnames            Lookup matching variable names                                                                                 \nvars                Lookup templated value of variables                                                                            \n[root@rocky ~]# \n\n</code></pre>\n<h3 id=\"ansible\"><a class=\"anchor\" href=\"#ansible\">#</a> ansible</h3>\n<h4 id=\"ansible-ad-hoc-介绍\"><a class=\"anchor\" href=\"#ansible-ad-hoc-介绍\">#</a> Ansible Ad-Hoc 介绍</h4>\n<p>Ansible Ad-Hoc 的执行方式的主要工具就是 ansible<br />\n 特点：一次性的执行，不会保存执行命令信息，只适合临时性或测试性的任务</p>\n<h4 id=\"ansible-命令用法\"><a class=\"anchor\" href=\"#ansible-命令用法\">#</a> ansible 命令用法</h4>\n<p>格式：</p>\n<pre><code>ansible &lt;host-pattern&gt; [-m module_name] [-a args]\n</code></pre>\n<p>选项说明：</p>\n<pre><code>--version #显示版本\n-m module #指定模块，默认为command\n-v #详细过程 -vv -vvv更详细\n--list-hosts #显示主机列表，可简写 --list\n-C, --check #检查，并不执行\n-T, --timeout=TIMEOUT #执行命令的超时时间，默认10s\n-k, --ask-pass #提示输入ssh连接密码，默认Key验证\n-u, --user=REMOTE_USER #执行远程执行的用户,默认root\n-b, --become #代替旧版的sudo实现通过sudo机制实现提升权限\n--become-user=USERNAME #指定sudo的runas用户，默认为root\n-K, --ask-become-pass #提示输入sudo时的口令\n-f FORKS, --forks FORKS #指定并发同时执行ansible任务的主机数\n-i INVENTORY, --inventory INVENTORY #指定主机清单文件\n</code></pre>\n<p>范例:</p>\n<pre><code>#以wang用户执行ping存活检测\nansible all -m ping -u wang -k\n#以wang sudo至root执行ping存活检测\nansible all -m ping -u wang -k -b\n#以wang sudo至mage用户执行ping存活检测\nansible all -m ping -u wang -k -b --become-user=mage\n#以wang sudo至root用户执行ls\nansible all -m command -u wang -a 'ls /root' -b --become-user=root -k -K\n</code></pre>\n<p>范例：并发执行控制</p>\n<pre><code>#分别执行下面两条命令观察结果\n[root@ansible ~]#ansible all -a 'sleep 5' -f1\n[root@ansible ~]#ansible all -a 'sleep 5' -f10\n</code></pre>\n<p>范例：使用普能用户进行远程管理</p>\n<pre><code>#在所有控制端和被控制端创建用户和密码\n[root@rocky8 ~]#useradd wang\n[root@rocky8 ~]#echo wang:123456 | chpasswd\n#在所有被控制端对用户sudo授权\n[root@rocky8 ~]#visudo\nwang ALL=(ALL) NOPASSWD: ALL\n[root@rocky8 ~]#visudo -c\n/etc/sudoers: parsed OK\n#实现从控制端到被控制端的基于key验证\n[root@ansible ~]#su - wang\nwang@ansible:~$ssh-keygen -f ~/.ssh/id_rsa -P ''\nwang@ansible:~$$ssh-copy-id wang@'10.0.0.8'\n#使用普通用户测试连接,默认连接权限不足失败\nwang@ansible:~$ ansible 10.0.0.8 -m shell -a 'ls /root'\n10.0.0.8 | FAILED | rc=2 &gt;&gt;\nls: cannot open directory '/root': Permission deniednon-zero return code\n#使用普通用户通过-b选项连接实现sudo提权后连接成功\nwang@ansible:~$ ansible 10.0.0.8 -m shell -a 'ls /root' -b --become-user root\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nanaconda-ks.cfg\n#修改配置文件指定sudo机制\n[root@ansible ~]#vim /etc/ansible/ansible.cfg\n#取消下面行前面的注释\n[privilege_escalation]\nbecome=True\nbecome_method=sudo\nbecome_user=root\nbecome_ask_pass=False\n#再次测试\n[root@ansible ~]#su - wang\nwang@ansible:~$ ansible 10.0.0.8 -m shell -a 'ls /root'\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nanaconda-ks.cfg\n</code></pre>\n<p>范例：使用普通用户连接远程主机执行代替另一个用户身份执行操作</p>\n<pre><code>[root@centos8 ~]#useradd wang\n[root@centos8 ~]#echo wang:123456 | chpasswd\n#先在被控制端能过sudo对普通用户授权\n[root@centos8 ~]#grep wang /etc/sudoers\nwang ALL=(ALL) NOPASSWD: ALL\n#以wang的用户连接用户,并利用sudo代表mage执行whoami命令\n[root@ansible ~]#ansible 10.0.0.8 -m shell -a 'whoami' -u wang -k -b --become-\nuser=mage\nSSH password: #输入远程主机wang用户ssh连接密码\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nmage\n</code></pre>\n<h4 id=\"ansible的host-pattern\"><a class=\"anchor\" href=\"#ansible的host-pattern\">#</a> ansible 的 Host-pattern</h4>\n<p>用于匹配被控制的主机的列表<br />\n All ：表示所有 Inventory 中的所有主机<br />\n范例</p>\n<pre><code>ansible all -m ping\n</code></pre>\n<p>*: 通配符</p>\n<pre><code>ansible &quot;*&quot; -m ping\nansible 192.168.1.* -m ping\nansible &quot;srvs&quot; -m ping\nansible &quot;10.0.0.6 10.0.0.7&quot; -m ping\n</code></pre>\n<p>或关系</p>\n<pre><code>ansible &quot;websrvs:appsrvs&quot; -m ping\nansible &quot;192.168.1.10:192.168.1.20&quot; -m ping\n</code></pre>\n<p>逻辑与</p>\n<pre><code>#在websrvs组并且在dbsrvs组中的主机\nansible &quot;websrvs:&amp;dbsrvs&quot; -m ping\n</code></pre>\n<p>逻辑非</p>\n<pre><code>#在所有主机,但不在websrvs组和dbsrvs组中的主机\n#注意：此处为单引号\nansible 'all:!dbsrvs:!websrvs' -m ping\n</code></pre>\n<p>综合逻辑</p>\n<pre><code>ansible 'websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs' -m ping\n</code></pre>\n<p>正则表达式</p>\n<pre><code>ansible &quot;websrvs:dbsrvs&quot; -m ping\nansible &quot;~(web|db).*\\.magedu\\.com&quot; -m ping\n</code></pre>\n<h5 id=\"ansible-命令的执行过程\"><a class=\"anchor\" href=\"#ansible-命令的执行过程\">#</a> ansible 命令的执行过程</h5>\n<ol>\n<li>加载自己的配置文件，默认 /etc/ansible/ansible.cfg</li>\n<li>查找主机清单中对应的主机或主机组</li>\n<li>加载自己对应的模块文件，如：command</li>\n<li>通过 ansible 将模块或命令生成对应的临时 py 文件，并将该文件传输至远程服务器的对应执行用户<br />\n $HOME/.ansible/tmp/ansible-tmp - 数字 / XXX.PY 文件</li>\n<li>给文件 + x 执行</li>\n<li>执行并返回结果</li>\n<li>删除临时 py 文件，退出</li>\n</ol>\n<h5 id=\"ansible-命令的执行状态\"><a class=\"anchor\" href=\"#ansible-命令的执行状态\">#</a> ansible 命令的执行状态</h5>\n<pre><code>[root@centos8 ~]#grep -A 14 '\\[colors\\]' /etc/ansible/ansible.cfg\n[colors]\n#highlight = white\n#verbose = blue\n#warn = bright purple\n#error = red\n#debug = dark gray\n#deprecate = purple\n#skip = cyan\n#unreachable = red\n#ok = green\n#changed = yellow\n#diff_add = green\n#diff_remove = red\n#diff_lines = cyan\n</code></pre>\n<ul>\n<li>绿色：执行成功并且对目标主机不需要做改变的操作</li>\n<li>黄色：执行成功并且对目标主机做变更</li>\n<li>红色：执行失败</li>\n</ul>\n<h3 id=\"ansible-console\"><a class=\"anchor\" href=\"#ansible-console\">#</a> ansible-console</h3>\n<p>此工具可交互执行命令，支持 tab，ansible 2.0 + 新增<br />\n提示符格式：</p>\n<pre><code>执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$\n</code></pre>\n<p>常用子命令：</p>\n<ul>\n<li>设置并发数： forks n 例如： forks 10</li>\n<li>切换组： cd 主机组 例如： cd web</li>\n<li>列出当前组主机列表： list</li>\n<li>列出所有的内置命令： ? 或 help</li>\n</ul>\n<p>范例</p>\n<pre><code>[root@ansible ~]#ansible-console\nWelcome to the ansible console.\nType help or ? to list commands.\nroot@all (3)[f:5]$ ping\n10.0.0.7 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;\n&#125;,\n&quot;changed&quot;: false,\n&quot;ping&quot;: &quot;pong&quot;\n&#125;\n10.0.0.6 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;\n&#125;,\n&quot;changed&quot;: false,\n&quot;ping&quot;: &quot;pong&quot;\n&#125;\n10.0.0.8 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;\n&#125;,\n&quot;changed&quot;: false,\n&quot;ping&quot;: &quot;pong&quot;\n&#125;\nroot@all (3)[f:5]$ list\n10.0.0.8\n10.0.0.7\n10.0.0.6\nroot@all (3)[f:5]$ cd websrvs\nroot@websrvs (2)[f:5]$ list\n10.0.0.7\n10.0.0.8\nroot@websrvs (2)[f:5]$ forks 10\nroot@websrvs (2)[f:10]$ cd appsrvs\nroot@appsrvs (2)[f:5]$ yum name=httpd state=present\nroot@appsrvs (2)[f:5]$ service name=httpd state=started\n</code></pre>\n<h3 id=\"ansible-playbook\"><a class=\"anchor\" href=\"#ansible-playbook\">#</a> ansible-playbook</h3>\n<p>此工具用于执行编写好的 playbook 任务<br />\n范例：</p>\n<pre><code>ansible-playbook hello.yml\ncat hello.yml\n---\n#hello world yml file\n- hosts: websrvs\n  remote_user: root\n  gather_facts: no\n  tasks:\n  - name: hello world\n    command: /usr/bin/wall hello world\n</code></pre>\n<h3 id=\"ansible-vault\"><a class=\"anchor\" href=\"#ansible-vault\">#</a> ansible-vault</h3>\n<p>此工具可以用于加密解密 yml 文件<br />\n格式：</p>\n<pre><code>ansible-vault [create|decrypt|edit|encrypt|rekey|view]\n</code></pre>\n<p>范例</p>\n<pre><code>ansible-vault encrypt hello.yml #加密\nansible-vault decrypt hello.yml #解密\nansible-vault view hello.yml #查看\nansible-vault edit hello.yml #编辑加密文件\nansible-vault rekey hello.yml #修改口令\nansible-vault create new.yml #创建新文件\n#执行加密的playbook,交互式输入密码\nchmod 600 hello.yml\nansible-playbook --ask-vault-pass hello.yml\n#从pass.txt文件中读取密码\nansible-playbook --vault-password-file pass.txt hello.yml\n#从配置文件中取得密码\n#vi /etc/ansible/ansible.cfg\n[defaults]\nault-password-file=pass.txt\n#可以直接执行加密文件\nansible-playbook hello.yml\n</code></pre>\n<h3 id=\"ansible-galaxy\"><a class=\"anchor\" href=\"#ansible-galaxy\">#</a> ansible-galaxy</h3>\n<p>Galaxy 是一个免费网站，类似于 github 网站，网站上发布了很多的共享的 roles 角色。<br />\nAnsible 提供了 ansible-galaxy 命令行工具连接 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9nYWxheHkuYW5zaWJsZS5jb20=\">https://galaxy.ansible.com</span> 网站下载相应的 roles, 进行 init (初始化、search ( 查拘、install (安装、 remove (移除) 等操作。</p>\n<p><img data-src=\"../image.assets/1677156776774.png\" alt=\"1677156776774\" /></p>\n<p>范例：</p>\n<pre><code>#搜索项目\n[root@ansible ~]#ansible-galaxy search lamp\n#列出所有已安装的galaxy\nansible-galaxy list\n#安装galaxy,默认下载到~/.ansible/roles下\nansible-galaxy install geerlingguy.mysql\nansible-galaxy install geerlingguy.redis\n#删除galaxy\nansible-galaxy remove geerlingguy.redis\n</code></pre>\n<h2 id=\"ansible常用模块\"><a class=\"anchor\" href=\"#ansible常用模块\">#</a> Ansible 常用模块</h2>\n<p>2015 年 12 月只 270 多个模块<br />\n 2016 年 12 年 26 日 ansible 1.9.2 有 540 个模块<br />\n 2018 年 01 月 12 日 ansible 2.3.8 有 1378 个模块<br />\n 2018 年 05 月 28 日 ansible 2.5.3 有 1562 个模块<br />\n 2018 年 07 月 15 日 ansible 2.6.3 有 1852 个模块<br />\n 2018 年 11 月 19 日 ansible 2.7.2 有 2080 个模块<br />\n 2020 年 03 月 02 日 ansible 2.9.5 有 3387 个模块<br />\n 2021 年 12 月 22 日 ansible 2.11.8 有 6141 个模块<br />\n 2022 年 06 月 04 日 ansible 2.12.6 有 6763 个模块<br />\n虽然模块众多，但最常用的模块也就 2，30 个而已，针对特定业务只需要熟悉 10 几个模块即可<br />\n常用模块帮助文档参考：</p>\n<pre><code>https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html\nhttps://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html\nhttps://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html\nhttps://docs.ansible.com/ansible/latest/modules/modules_by_category.html\n</code></pre>\n<h3 id=\"command-模块\"><a class=\"anchor\" href=\"#command-模块\">#</a> Command 模块</h3>\n<p>功能：在远程主机执行命令，此为默认模块，可忽略 -m 选项<br />\n注意：此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，可用 shell 模块实现<br />\n注意：此模块不具有幂等性<br />\n常见选项</p>\n<pre><code>chdir=dir #执行命令前,先切换至目录dir\ncreates=file #当file不存在时才会执行\nremoves=file #当file存在时才会执行\n</code></pre>\n<p>范例：</p>\n<pre><code>[root@ansible ~]#ansible websrvs -m command -a 'chdir=/etc cat centos-release'\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\nCentOS Linux release 7.7.1908 (Core)\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nCentOS Linux release 8.1.1911 (Core)\n[root@ansible ~]#ansible websrvs -m command -a 'chdir=/etc creates=/data/f1.txt cat centos-release'\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\nCentOS Linux release 7.7.1908 (Core)\n10.0.0.8 | SUCCESS | rc=0 &gt;&gt;\nskipped, since /data/f1.txt exists\n[root@ansible ~]#ansible websrvs -m command -a 'chdir=/etc removes=/data/f1.txt cat centos-release'\n10.0.0.7 | SUCCESS | rc=0 &gt;&gt;\nskipped, since /data/f1.txt does not exist\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nCentOS Linux release 8.1.1911 (Core)\nansible websrvs -m command -a 'service vsftpd start'\nansible websrvs -m command -a 'echo magedu |passwd --stdin wang'\nansible websrvs -m command -a 'rm -rf /data/'\nansible websrvs -m command -a 'echo hello &gt; /data/hello.log'\n\nansible websrvs -m command -a &quot;echo $HOSTNAME&quot;\n</code></pre>\n<h3 id=\"shell-模块\"><a class=\"anchor\" href=\"#shell-模块\">#</a> Shell 模块</h3>\n<p>功能：和 command 相似，用 shell 执行命令，支持各种符号，比如:*,$, &gt; , 相当于增强版的 command 模块<br />\n注意：此模块不具有幂等性，建议能不能就用此模块，最好使用专用模块<br />\n常见选项</p>\n<pre><code>chdir=dir #执行命令前,先切换至目录dir\ncreates=file #当file不存在时才会执行\nremoves=file #当file存在时才会执行\n</code></pre>\n<p>范例：</p>\n<pre><code>[root@ansible ~]#ansible websrvs -m shell -a &quot;echo $HOSTNAME&quot;\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\nansible\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nansible\n[root@ansible ~]#ansible websrvs -m shell -a 'echo $HOSTNAME'\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\ncentos7.wangxiaochun.com\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\ncentos8.localdomain\n[root@ansible ~]#ansible websrvs -m shell -a 'echo centos | passwd --stdin wang'\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\nChanging password for user wang.\npasswd: all authentication tokens updated successfully.\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nChanging password for user wang.\npasswd: all authentication tokens updated successfully.\n[root@ansible ~]#ansible websrvs -m shell -a 'ls -l /etc/shadow'\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\n---------- 1 root root 889 Mar 2 14:34 /etc/shadow\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\n---------- 1 root root 944 Mar 2 14:34 /etc/shadow\n[root@ansible ~]#ansible websrvs -m shell -a 'echo hello &gt; /data/hello.log'\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\n[root@ansible ~]#ansible websrvs -m shell -a 'cat /data/hello.log'\n10.0.0.7 | CHANGED | rc=0 &gt;&gt;\nhello\n10.0.0.8 | CHANGED | rc=0 &gt;&gt;\nhello\n</code></pre>\n<p>注意：调用 bash 执行命令 类似 cat /tmp/test.md | awk -F'|' '{print $1,$2}' &amp;&gt; /tmp/example.txt 这些复杂命令，即使使用 shell 也可能会失败，解决办法：写到脚本时，copy 到远程，执行，再把需要的结果拉回执行命令的机器<br />\n范例：将 shell 模块代替 command，设为模块</p>\n<pre><code>[root@ansible ~]#vim /etc/ansible/ansible.cfg\n#修改下面一行\nmodule_name = shell\n</code></pre>\n<h3 id=\"script-模块\"><a class=\"anchor\" href=\"#script-模块\">#</a> Script 模块</h3>\n<p>功能：在远程主机上运行 ansible 服务器上的脚本 (无需执行权限)<br />\n 注意：此模块不具有幂等性<br />\n常见选项</p>\n<pre><code>chdir=dir #执行命令前,先切换至目录dir\ncmd #指定ansible主机的命令\ncreates=file #当file不存在时才会执行\nremoves=file #当file存在时才会执行\n</code></pre>\n<p>范例：</p>\n<pre><code>ansible websrvs -m script -a /data/test.sh\n</code></pre>\n<h3 id=\"copy-模块\"><a class=\"anchor\" href=\"#copy-模块\">#</a> Copy 模块</h3>\n<p>功能：复制 ansible 服务器主控端或远程的本机的文件到远程主机<br />\n注意: src=file 如果是没指明路径，则为当前目录或当前目录下的 files 目录下的 file 文件<br />\n常见选项</p>\n<pre><code>src #控制端的源文件路径\ndest #被控端的文件路径\nowner #属主\ngroup #属组\nmode #权限\nbackup #是否备份\nvalidate #验证成功才会执行copy\nremote_src #no是默认值,表示src文件在ansible主机,yes表示src文件在远程主机\n</code></pre>\n<p>范例:</p>\n<pre><code>#如目标存在，默认覆盖，此处指定先备\nansible websrvs -m copy -a &quot;src=/root/test1.sh dest=/tmp/test2.sh owner=wang mode=600 backup=yes&quot;\n#指定内容，直接生成目标文件\nansible websrvs -m copy -a &quot;content='wang 123456\\nxiao 654321\\n' dest=/etc/rsync.pas owner=root group=root mode=0600&quot;\n#复制/etc目录自身,注意/etc/后面没有/\nansible websrvs -m copy -a &quot;src=/etc dest=/backup&quot;\n#复制/etc/下的文件，不包括/etc/目录自身,注意/etc/后面有/\nansible websrvs -m copy -a &quot;src=/etc/ dest=/backup&quot;\n#复制/etc/suders,并校验语法\nansible websrvs -m copy -a &quot;src=/etc/suders dest=/etc/sudoers.edit remote_src=yes validate=/usr/sbin/visudo -csf %s&quot;\n</code></pre>\n<h3 id=\"get_url-模块\"><a class=\"anchor\" href=\"#get_url-模块\">#</a> Get_url 模块</h3>\n<p>功能：用于将文件从 http、https 或 ftp 下载到被管理机节点上<br />\n常用参数如下：</p>\n<pre><code>url #下载文件的URL,支持HTTP，HTTPS或FTP协议\ndest #下载到目标路径（绝对路径），如果目标是一个目录，就用原文件名，如果目标设置了名称就用目标\n设置的名称\nowner #指定属主\ngroup #指定属组\nmode #指定权限\nforce #如果yes，dest不是目录，将每次下载文件，如果内容改变替换文件。如果no，则只有在目标不存\n在时才会下载\nchecksum #对目标文件在下载后计算摘要，以确保其完整性\n#示例: checksum=&quot;sha256:D98291AC[...]B6DC7B97&quot;,\nchecksum=&quot;sha256:http://example.com/path/sha256sum.txt&quot;\nurl_username #用于HTTP基本认证的用户名。 对于允许空密码的站点，此参数可以不使用`url_password'\nurl_password #用于HTTP基本认证的密码。 如果未指定`url_username'参数，则不会使用`url_password'参数\nvalidate_certs #如果“no”，SSL证书将不会被验证。 适用于自签名证书在私有网站上使用\ntimeout #URL请求的超时时间,秒为单位\n</code></pre>\n<p>范例：下载并 MD5 验证</p>\n<pre><code>[root@ansible ~]#ansible websrvs -m get_url -a 'url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src/nginx.tar.gz checksum=&quot;md5:b2d33d24d89b8b1f87ff5d251aa27eb8&quot;'\n</code></pre>\n<h3 id=\"fetch-模块\"><a class=\"anchor\" href=\"#fetch-模块\">#</a> Fetch 模块</h3>\n<p>功能：从远程主机提取文件至 ansible 的主控端，copy 相反，目前不支持目录<br />\n常见选项</p>\n<pre><code>src #被控制端的源文件路径,只支持文件\ndest #ansible控制端的目录路径\n</code></pre>\n<p>范例：</p>\n<pre><code>ansible websrvs -m fetch -a 'src=/root/test.sh dest=/data/scripts'\n</code></pre>\n<p>范例：</p>\n<pre><code>[root@ansible ~]#ansible all -m fetch -a 'src=/etc/redhat-release\ndest=/data/os'\n[root@ansible ~]#tree /data/os/\n/data/os/\n├── 10.0.0.6\n│ └── etc\n│ └── redhat-release\n├── 10.0.0.7\n│ └── etc\n│ └── redhat-release\n└── 10.0.0.8\n└── etc\n└── redhat-release\n6 directories, 3 files\n</code></pre>\n<h3 id=\"file-模块\"><a class=\"anchor\" href=\"#file-模块\">#</a> File 模块</h3>\n<p>功能：设置文件属性，创建文件，目录和软链接等<br />\n常见选项</p>\n<pre><code>path #在被控端创建的路径\nowner #属主\ngroup #属组\nmode #权限\nstate #状态\n=touch #创建文件\n=directory #创建目录\n=link #软链接\n=hard #硬链接\nrecurse #yes表示递归授权\n</code></pre>\n<p>范例：</p>\n<pre><code>#创建空文件\nansible all -m file -a 'path=/data/test.txt state=touch'\nansible all -m file -a 'path=/data/test.txt state=absent'\nansible all -m file -a &quot;path=/root/test.sh owner=wang mode=755&quot;\n#创建目录\nansible all -m file -a &quot;path=/data/mysql state=directory owner=mysql group=mysql&quot;\n#创建软链接\nansible all -m file -a 'src=/data/testfile path|dest|name=/data/testfile-link state=link'\n#创建目录\nansible all -m file -a 'path=/data/testdir state=directory'\n#递归修改目录属性,但不递归至子目录\nansible all -m file -a &quot;path=/data/mysql state=directory owner=mysql group=mysql&quot;\n#递归修改目录及子目录的属性\nansible all -m file -a &quot;path=/data/mysql state=directory owner=mysql group=mysql recurse=yes&quot;\n</code></pre>\n<h3 id=\"stat-模块\"><a class=\"anchor\" href=\"#stat-模块\">#</a> stat 模块</h3>\n<p>功能：检查文件或文件系统的状态<br />\n注意：对于 Windows 目标，请改用 win_stat 模块</p>\n<p>常见选项</p>\n<pre><code>path #文件/对象的完整路径（必须）\n</code></pre>\n<p>常用的返回值判断：</p>\n<pre><code>exists： 判断是否存在\nisuid： 调用用户的ID与所有者ID是否匹配\n</code></pre>\n<p>范例:</p>\n<pre><code>[root@ansible ~]#ansible 127.0.0.1 -m stat -a 'path=/etc/passwd'\n127.0.0.1 | SUCCESS =&gt; &#123;\n&quot;changed&quot;: false,\n&quot;stat&quot;: &#123;\n&quot;atime&quot;: 1614601466.7493012,\n&quot;attr_flags&quot;: &quot;&quot;,\n&quot;attributes&quot;: [],\n&quot;block_size&quot;: 4096,\n&quot;blocks&quot;: 8,\n&quot;charset&quot;: &quot;us-ascii&quot;,\n&quot;checksum&quot;: &quot;8f7a9a996d24de98bf1eab4a047f8e89e9c708cf&quot;,\n&quot;ctime&quot;: 1614334259.4498665,\n&quot;dev&quot;: 2050,\n&quot;device_type&quot;: 0,\n&quot;executable&quot;: false,\n&quot;exists&quot;: true,\n&quot;gid&quot;: 0,\n&quot;gr_name&quot;: &quot;root&quot;,\n&quot;inode&quot;: 134691833,\n&quot;isblk&quot;: false,\n&quot;ischr&quot;: false,\n&quot;isdir&quot;: false,\n&quot;isfifo&quot;: false,\n&quot;isgid&quot;: false,\n&quot;islnk&quot;: false,\n&quot;isreg&quot;: true,\n&quot;issock&quot;: false,\n&quot;isuid&quot;: false,\n&quot;mimetype&quot;: &quot;text/plain&quot;,\n&quot;mode&quot;: &quot;0000&quot;,\n&quot;mtime&quot;: 1614334259.4498665,\n&quot;nlink&quot;: 1,\n&quot;path&quot;: &quot;/etc/passwd&quot;,\n&quot;pw_name&quot;: &quot;root&quot;,\n&quot;readable&quot;: true,\n&quot;rgrp&quot;: false,\n&quot;roth&quot;: false,\n&quot;rusr&quot;: false,\n&quot;size&quot;: 1030,\n&quot;uid&quot;: 0,\n&quot;version&quot;: &quot;671641160&quot;,\n&quot;wgrp&quot;: false,\n&quot;woth&quot;: false,\n&quot;writeable&quot;: true,\n&quot;wusr&quot;: false,\n&quot;xgrp&quot;: false,\n&quot;xoth&quot;: false,\n&quot;xusr&quot;: false\n&#125;\n&#125;\n</code></pre>\n<p>案例：</p>\n<pre><code>- name: install | Check if file is already configured.\n  stat: path=&#123;&#123; nginx_file_path &#125;&#125;\n  connection: local\n  register: nginx_file_result\n- name: install | Download nginx file\n  get_url: url=&#123;&#123; nginx_file_url &#125;&#125; dest=&#123;&#123; software_files_path &#125;&#125;\n  validate_certs=no\n  connection: local\n  when:，not. nginx_file_result.stat.exists\n</code></pre>\n<p>范例:</p>\n<pre><code>[root@ansible ansible]#cat stat.yml\n---\n- hosts: websrvs\n  tasks:\n  - name: check file\n    stat: path=/data/mysql\n    register: st\n  - name: debug\n    debug:\n      msg: &quot;/data/mysql is not exist&quot;\n    when: not st.stat.exists\n[root@ansible ansible]#ansible-playbook stat.yml\nPLAY [websrvs]\n********************************************************************************\n***************************************\nTASK [Gathering Facts]\n********************************************************************************\n*******************************\nok: [10.0.0.7]\nok: [10.0.0.8]\nTASK [check file]\n********************************************************************************\n************************************\nok: [10.0.0.7]\nok: [10.0.0.8]\nTASK [debug]\n********************************************************************************\n*****************************************\nok: [10.0.0.7] =&gt; &#123;\n&quot;msg&quot;: &quot;/data/mysql is not exist&quot;\n&#125;\nok: [10.0.0.8] =&gt; &#123;\n&quot;msg&quot;: &quot;/data/mysql is not exist&quot;\n&#125;\nPLAY RECAP\n********************************************************************************\n*******************************************\n10.0.0.7 : ok=3 changed=0 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n10.0.0.8 : ok=3 changed=0 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n</code></pre>\n<h3 id=\"unarchive-模块\"><a class=\"anchor\" href=\"#unarchive-模块\">#</a> unarchive 模块</h3>\n<p>功能：解包解压缩<br />\n实现有两种用法：</p>\n<ul>\n<li>将 ansible 主机上的压缩包传到远程主机后解压缩至特定目录，设置 remote_src=no, 此为默认值，可省略</li>\n<li>将远程本主机上或非 ansible 的其它主机的某个压缩包解压缩到远程主机本机的指定路径下，需要设置 remote_src=yes</li>\n</ul>\n<p>常见参数：</p>\n<pre><code>remote_src #和copy功能一样且选项互斥，yes表示源文件在远程被控主机或其它非ansible的其它主机上，no表示文件在ansible主机上,默认值为no, 此选项代替copy选项\ncopy #默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy=no，会在远程主机上寻找src源文件,此选项已废弃\nsrc #源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置remote_src=yes\ndest #远程主机上的目标路径\nmode #设置解压缩后的文件权限\ncreates=/path/file #当绝对路径/path/file不存在时才会执行\n</code></pre>\n<p>范例：</p>\n<pre><code>ansible all -m unarchive -a 'src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin'\n\nansible all -m unarchive -a 'src=/tmp/foo.zip dest=/data  mode=0777'\n\nansible all -m unarchive -a 'src=https://example.com/example.zip dest=/data '\n\nansible websrvs -m unarchive -a 'src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/data/ owner=root remote_src=yes'\n\nansible websrvs -m unarchive -a 'src=http://nginx.org/download/nginx- 1.18.0.tar.gz dest=/usr/local/src/ remote_src=yes''\n</code></pre>\n<h3 id=\"archive-模块\"><a class=\"anchor\" href=\"#archive-模块\">#</a> Archive 模块</h3>\n<p>功能：打包压缩保存在被管理节点</p>\n<p>常见选项</p>\n<pre><code>path #压缩的文件或目录\ndest #压缩后的文件\nformat #压缩格式,支持gz,bz2,xz,tar,zip\n</code></pre>\n<p>范例：</p>\n<pre><code>ansible websrvs -m archive -a 'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600'\n</code></pre>\n<h3 id=\"hostname-模块\"><a class=\"anchor\" href=\"#hostname-模块\">#</a> Hostname 模块</h3>\n<p>功能：管理主机名<br />\n常见选项</p>\n<pre><code>name #修改后的主机名称\n</code></pre>\n<p>范例：</p>\n<pre><code>ansible node1 -m hostname -a &quot;name=websrv&quot;\nansible 10.0.0.18 -m hostname -a 'name=node18.wang.org'\n</code></pre>\n<h3 id=\"cron-模块\"><a class=\"anchor\" href=\"#cron-模块\">#</a> Cron 模块</h3>\n<p>功能：计划任务<br />\n支持时间：minute，hour，day，month，weekday<br />\n 常见选项</p>\n<pre><code>name #描述脚本的作用\nminute #分钟\nhour #小时\nweekday #周\nuser #任务由哪个用户运行；默认root\njob #任务\n</code></pre>\n<p>范例：</p>\n<pre><code>#备份数据库脚本\n[root@centos8 ~]#cat /root/mysql_backup.sh\n#!/bin/bash\nmysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip &gt; /data/mysql_`date +%F_%T`.sql.gz\n#创建任务\nansible 10.0.0.8 -m cron -a 'hour=2 minute=30 weekday=1-5 name=&quot;backup mysql&quot; job=/root/mysql_backup.sh'\n\nansible websrvs -m cron -a &quot;minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com &amp;&gt;/dev/null' name=Synctime&quot;\n\n#禁用计划任务\nansible websrvs -m cron -a &quot;minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null' name=Synctime disabled=yes&quot;\n\n#启用计划任务\nansible websrvs -m cron -a &quot;minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 &amp;&gt; /dev/null' name=Synctime disabled=no&quot;\n\n#删除任务\nansible websrvs -m cron -a &quot;name='backup mysql' state=absent&quot;\nansible websrvs -m cron -a 'state=absent name=Synctime'\n</code></pre>\n<h3 id=\"yum-和-apt-模块\"><a class=\"anchor\" href=\"#yum-和-apt-模块\">#</a> Yum 和 Apt 模块</h3>\n<p>功能：管理软件包<br />\n yum 管理软件包，只支持 RHEL，CentOS，fedora，不支持 Ubuntu 其它版本<br />\n apt 模块管理 Debian 相关版本的软件包<br />\n yum 常见选项</p>\n<pre><code>name #软件包名称\nstate #状态\n=present #安装,此为默认值\n=absent #删除\n=latest #最新版\nlist #列出指定包\nenablerepo #启用哪个仓库安装\ndisablerepo #不使用哪些仓库的包\nexclude #排除指定的包\nvalidate #是否检验,默认为yes\n</code></pre>\n<p>范例：</p>\n<pre><code>[root@ansible ~]#ansible websrvs -m yum -a 'name=httpd state=present'\n#安装zabbix agent rpm包\n\n[root@ansible ~]#ansible websrvs -m yum -a 'name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no'\n\n#启用epel源进行安装\n[root@ansible ~]#ansible websrvs -m yum -a 'name=nginx state=present enablerepo=epel'\n\n#升级除kernel和foo开头以外的所有包\n[root@ansible ~]#ansible websrvs -m yum -a 'name=* state=lastest exclude=kernel*,foo*'\n\n#删除\n[root@ansible ~]#ansible websrvs -m yum -a 'name=httpd state=absent'\n[root@ansible ~]#ansible websrvs -m yum -a 'name=sl,cowsay'\n</code></pre>\n<h3 id=\"yum_repository-模块\"><a class=\"anchor\" href=\"#yum_repository-模块\">#</a> yum_repository 模块</h3>\n<p>功能：此模块实现 yum 的仓库配置管理<br />\n常见选项</p>\n<pre><code>name #仓库id\ndescription #仓库描述名称,对应配置文件中的name=\nbaseurl #仓库的地址\ngpgcheck #验证开启\ngpgkey #仓库公钥路径\nstate=absen  #删除\n</code></pre>\n<p>范例：</p>\n<pre><code>ansible websrvs -m yum_repository -a 'name=ansible_nginx description=&quot;nginx repo&quot; baseurl=&quot;http://nginx.org/packages/centos/$releasever/$basearch/&quot; gpgcheck=yes gpgkey=&quot;https://nginx.org/keys/nginx_signing.key&quot;'\n\n[root@rocky8 ~]#cat /etc/yum.repos.d/ansible_nginx.repo\n[ansible_nginx]\nbaseurl = http://nginx.org/packages/centos/$releasever/$basearch/\ngpgcheck = 1\ngpgkey = https://nginx.org/keys/nginx_signing.key\nname = nginx repo\n</code></pre>\n<h3 id=\"service-模块\"><a class=\"anchor\" href=\"#service-模块\">#</a> Service 模块</h3>\n<p>此模块和 sytemd 功能相似，选项很多相同<br />\n功能：管理服务<br />\n常见选项</p>\n<pre><code>name #服务名称\nstate #服务状态\n=started #启动\n=stopped #停止\n=restarted #重启\n=reloaded #重载\nenabled #开启自启动\ndaemon_reload #加载新的配置文件,适用于systemd模块\n</code></pre>\n<p>范例：</p>\n<pre><code>ansible all -m service -a 'name=httpd state=started enabled=yes'\nansible all -m service -a 'name=httpd state=stopped'\nansible all -m service -a 'name=httpd state=reloaded'\nansible all -m shell -a &quot;sed -i 's/^Listen 80/Listen 8080/'\n/etc/httpd/conf/httpd.conf&quot;\nansible all -m service -a 'name=httpd state=restarted'\n#重启动指定网卡服务\nansible all -m service -a 'name=network state=absent args=eth0'\n</code></pre>\n<h3 id=\"user-模块\"><a class=\"anchor\" href=\"#user-模块\">#</a> User 模块</h3>\n<p>功能：管理用户<br />\n常见选项</p>\n<pre><code>name #创建的名称\nuid #指定uid\ngroup #指定基本组\nshell #登录shell类型默认/bin/bash\ncreate_home #是否创建家目录\npassword #设定对应的密码，必须是加密后的字符串才行，否则不生效\nsystem #yes表示系统用户\ngroups #附加组\nappend #追加附加组使用,yes表示增加新的附加组\nstate #absen删除\nremove #yes表示删除用户时将家目录一起删除\ngenerate_ssh_key #创建私钥\nssh_keyu_bits #私钥位数\nssh_key_file #私钥文件路径\n</code></pre>\n<p>范例：</p>\n<pre><code>#创建用户\nansible all -m user -a 'name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1group=root'\nansible all -m user -a 'name=nginx comment=nginx uid=88 group=nginxgroups=&quot;root,daemon&quot; shell=/sbin/nologin system=yes create_home=nohome=/data/nginx non_unique=yes'\n#remove=yes表示删除用户及家目录等数据,默认remove=no\nansible all -m user -a 'name=nginx state=absent remove=yes'\n#生成123456加密的密码\nansible localhost -m debug -a &quot;msg=&#123;&#123; '123456'| password_hash('sha512','salt')&#125;&#125;&quot; localhost | SUCCESS =&gt; &#123; &quot;msg&quot;: &quot;$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.&quot;\n&#125;\n#用上面创建的密码创建用户\nansible websrvs -m user -a 'name=www group=www system=yes shell=/sbin/nlogin password=&quot;$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.&quot;'\n#创建用户test,并生成4096bit的私钥\nansible websrvs -m user -a 'name=test generate_ssh_key=yes ssh_key_bits=4096 ssh_key_file=.ssh/id_rsa'\n</code></pre>\n<h3 id=\"group-模块\"><a class=\"anchor\" href=\"#group-模块\">#</a> Group 模块</h3>\n<p>功能：管理组<br />\n常见选项</p>\n<pre><code>name #指定组名称\ngid #指定gid\nstate\n=present #创建,默认\n=absent #删除\n</code></pre>\n<p>范例：</p>\n<pre><code>#创建组\nansible websrvs -m group -a 'name=nginx gid=88 system=yes'\n#删除组\nansible websrvs -m group -a 'name=nginx state=absent'\n</code></pre>\n<h3 id=\"lineinfile-模块\"><a class=\"anchor\" href=\"#lineinfile-模块\">#</a> Lineinfile 模块</h3>\n<p>ansible 在使用 sed 进行替换时，经常会遇到需要转义的问题，而且 ansible 在遇到特殊符号进行替换时，<br />\n会存在问题，无法正常进行替换 。</p>\n<p>ansible 自身提供了两个模块：lineinfile 模块和 replace 模块，可以方便的进行替换一般在 ansible 当中去修改某个文件的单行进行替换的时候需要使用 lineinfile 模块<br />\n功能：相当于 sed，主要用于修改一行的文件内容<br />\n常见选项</p>\n<pre><code>path #被控端文件的路径\nregexp #正则匹配语法格式,表示被替换的内容\nline #替换为的内容\nstate #absent表示删除\ninsertafter #插入到替换内容前面,如和regexp同时存在,只在没找到与regexp匹配时才使用\ninsertafter\ninsertbefore #插入到替换内容后面,如和regexp同时存在,只在没找到与regexp匹配时才使用\ninsertafter\nbackrefs #支持后面引用,yes和no\nbackup #修改前先备份\ncreate #如果文件不存在,则创建,默认不存在会出错\nmode #指定权限\nowner #指定用户\ngroup #指定组\n#注意\nregexp参数 ：使用正则表达式匹配对应的行，当替换文本时，如果有多行文本都能被匹配，则只有最后面被\n匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。\n</code></pre>\n<p>注意：如果想进行多行匹配进行替换需要使用 replace 模块<br />\n范例：</p>\n<pre><code>#修改监听端口\nansible websrvs -m lineinfile -a &quot;path=/etc/httpd/conf/httpd.conf regexp='^Listen' line='Listen 8080'&quot;\n\n#修改SELinux\nansible all -m lineinfile -a &quot;path=/etc/selinux/config regexp='^SELINUX='line='SELINUX=disabled'&quot;\n\n#添加网关\nansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth0 line=&quot;GATEWAY=10.0.0.254&quot;'\n\n#给主机增加一个网关，但需要增加到NAME=下面\nansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth0 insertafter=&quot;^NAME=&quot; line=&quot;GATEWAY=10.0.0.254&quot;'\n#效果如下\ncat /etc/sysconfig/network-scripts/ifcfg-eth0\nDEVICE=eth0\nNAME=eth0\nGATEWAY=10.0.0.254\n#给主机增加一个网关，但需要增加到NAME=上面\nansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-\neth0 insertbefore=&quot;^NAME=&quot; line=&quot;GATEWAY=10.0.0.254&quot;'\n#效果如下\ncat /etc/sysconfig/network-scripts/ifcfg-eth0\nDEVICE=eth0\nGATEWAY=10.0.0.254\nNAME=eth0\n#删除网关\nansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth0 regexp=&quot;^GATEWAY&quot; state=absent'\n#删除#开头的行\nansible all -m lineinfile -a 'dest=/etc/fstab state=absent regexp=&quot;^#&quot;'\n</code></pre>\n<h3 id=\"replace-模块\"><a class=\"anchor\" href=\"#replace-模块\">#</a> Replace 模块</h3>\n<p>该模块有点类似于 sed 命令，主要也是基于正则进行匹配和替换，建议使用<br />\n功能：多行修改替换<br />\n常见选项</p>\n<pre><code>path #被控端文件的路径\nregexp #正则匹配语法格式,表示被替换的内容\nreplace #替换为的内容\nafter #插入到替换内容前面,\nbefore #插入到替换内容后面\nbackup #修改前先备份\nmode #指定权限\nowner #指定用户\ngroup #指定组\n</code></pre>\n<p>范例</p>\n<pre><code>ansible all -m replace -a &quot;path=/etc/fstab regexp='^(UUID.*)' replace='#\\1'&quot;\nansible all -m replace -a &quot;path=/etc/fstab regexp='^#(UUID.*)' replace='\\1'&quot;\n</code></pre>\n<h3 id=\"selinux-模块\"><a class=\"anchor\" href=\"#selinux-模块\">#</a> SELinux 模块</h3>\n<p>功能：该模块管理 SELInux 策略<br />\n常见选项</p>\n<pre><code>policy #指定SELINUXTYPE=targeted\nstate #指定SELINUX=disabled\n</code></pre>\n<p>范例</p>\n<pre><code>[root@rocky ansible-apps]# ansible 192.168.32.132 -m selinux -a 'state=disabled'\n192.168.32.132 | FAILED! =&gt; &#123;\n    &quot;msg&quot;: &quot;The module selinux was redirected to ansible.posix.selinux, which could not be loaded.&quot;\n&#125;\n\n# ansible版本2.13.3出现如下错误\n &quot;msg&quot;: &quot;The module selinux was redirected to ansible.posix.selinux, which could not be loaded.&quot;\n \n # 解决方法\n [root@rocky ansible-apps]# ansible-galaxy collection install ansible.posix\n\n\n# 再次执行，显示成功\n[root@rocky ansible-apps]# ansible 192.168.32.132 -m selinux -a 'state=disabled'\n[WARNING]: SELinux state temporarily changed from 'enforcing' to 'permissive'. State change will take effect next reboot.\n192.168.32.132 | CHANGED =&gt; &#123;\n    &quot;ansible_facts&quot;: &#123;\n        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;\n    &#125;,\n    &quot;changed&quot;: true,\n    &quot;configfile&quot;: &quot;/etc/selinux/config&quot;,\n    &quot;msg&quot;: &quot;Config SELinux state changed from 'enforcing' to 'disabled'&quot;,\n    &quot;policy&quot;: &quot;targeted&quot;,\n    &quot;reboot_required&quot;: true,\n    &quot;state&quot;: &quot;disabled&quot;\n&#125;\n\n</code></pre>\n<h3 id=\"reboot-模块\"><a class=\"anchor\" href=\"#reboot-模块\">#</a> reboot 模块</h3>\n<p>功能：重启<br />\n常见选项</p>\n<pre><code>msg #重启提示\npre_reboot_delay #重启前延迟时间的秒数\npost_reboot_delay #重启后延迟时间的秒数后,再验证系统正常启动\nreboot_timeout #重启后延迟时间再执行测试成功与否的命令\ntest_command #执行测试成功与否的命令\n</code></pre>\n<p>范例:</p>\n<pre><code>[root@ansible ~]#ansible websrvs -m reboot -a 'msg=&quot;host will be reboot&quot;'\n</code></pre>\n<h3 id=\"mount-模块\"><a class=\"anchor\" href=\"#mount-模块\">#</a> mount 模块</h3>\n<p>功能：挂载和卸载文件系统<br />\n常见选项</p>\n<pre><code>src #源设备路径，或网络地址\npath #挂载至本地哪个路径下\nfstype #设备类型； nfs\nopts #挂载的选项\nstate #挂载还是卸载\n=present #永久挂载，但没有立即生效\n=absent #卸载临时挂载,并删除永久挂载\n=mounted #临时挂载\n=unmounted #临时卸载\n</code></pre>\n<p>范例:</p>\n<pre><code>#修改fstab文件永久挂载,但不立即生效\nmount websrvs -m mount -a 'src=&quot;UUID=b3e48f45-f933-4c8e-a700-22a159ec9077&quot; path=/home fstype=xfs opts=noatime state=present'\n#临时取消挂载\nmount websrvs -m mount -a 'path=/home fstype=xfs opts=noatime state=unmounted'\n#永久挂载,并立即生效\nansible websrvs -m mount -a 'src=10.0.0.8:/data/wordpress path=/var/www/html/wp- content/uploads opts=&quot;_netdev&quot; state=mounted'\n#永久卸载,并立即生效\nansible websrvs -m mount -a 'src=10.0.0.8:/data/wordpress path=/var/www/html/wp- content/uploads state=absent'\n</code></pre>\n<h3 id=\"setup-模块\"><a class=\"anchor\" href=\"#setup-模块\">#</a> Setup 模块</h3>\n<p>功能： setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机<br />\n较多，会影响执行速度<br />\n可以使用 gather_facts: no 来禁止 Ansible 收集 facts 信息<br />\n常见选项</p>\n<pre><code>filter #指定过滤条件\n</code></pre>\n<p>范例:</p>\n<pre><code>ansible all -m setup\nansible all -m setup -a &quot;filter=ansible_nodename&quot;\nansible all -m setup -a &quot;filter=ansible_hostname&quot;  #  主机名称\nansible all -m setup -a &quot;filter=ansible_domain&quot;\nansible all -m setup -a &quot;filter=ansible_memtotal_mb&quot;\nansible all -m setup -a &quot;filter=ansible_memory_mb&quot;\nansible all -m setup -a &quot;filter=ansible_memfree_mb&quot;\nansible all -m setup -a &quot;filter=ansible_os_family&quot;\nansible all -m setup -a &quot;filter=ansible_distribution&quot;\nansible all -m setup -a &quot;filter=ansible_distribution_major_version&quot;\nansible all -m setup -a &quot;filter=ansible_distribution_version&quot;\nansible all -m setup -a &quot;filter=ansible_processor_vcpus&quot;\nansible all -m setup -a &quot;filter=ansible_all_ipv4_addresses&quot;\nansible all -m setup -a &quot;filter=ansible_architecture&quot;\nansible all -m setup -a &quot;filter=ansible_uptime_seconds&quot;\nansible all -m setup -a &quot;filter=ansible_processor*&quot;\nansible all -m setup -a 'filter=ansible_env'\n</code></pre>\n<p>范例：</p>\n<pre><code>[root@ansible ~]#ansible all -m setup -a 'filter=ansible_python_version'\n10.0.0.7 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;ansible_python_version&quot;: &quot;2.7.5&quot;,\n&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;\n&#125;,\n&quot;changed&quot;: false\n&#125;\n10.0.0.6 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;ansible_python_version&quot;: &quot;2.6.6&quot;,\n&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;\n&#125;,\n&quot;changed&quot;: false\n&#125;\n10.0.0.8 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;ansible_python_version&quot;: &quot;3.6.8&quot;,\n&quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;\n&#125;,\n&quot;changed&quot;: false\n&#125;\n[root@ansible ~]#\n</code></pre>\n<p>范例：取 IP 地址</p>\n<pre><code>#取所有IP\nansible 10.0.0.101 -m setup -a 'filter=ansible_all_ipv4_addresses'\n10.0.0.101 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;ansible_all_ipv4_addresses&quot;: [\n&quot;192.168.0.1&quot;,\n&quot;192.168.0.2&quot;,\n&quot;192.168.64.238&quot;,\n&quot;192.168.13.36&quot;,\n&quot;10.0.0.101&quot;,\n&quot;172.16.1.0&quot;,\n&quot;172.17.0.1&quot;\n]\n&#125;,\n&quot;changed&quot;: false\n&#125;\n#取默认IP\nansible all -m setup -a 'filter=&quot;ansible_default_ipv4&quot;'\n10.0.0.101 | SUCCESS =&gt; &#123;\n&quot;ansible_facts&quot;: &#123;\n&quot;ansible_default_ipv4&quot;: &#123;\n&quot;address&quot;: &quot;10.0.0.101&quot;,\n&quot;alias&quot;: &quot;eth0&quot;,\n&quot;broadcast&quot;: &quot;10.0.0.255&quot;,\n&quot;gateway&quot;: &quot;10.0.0.2&quot;,\n&quot;interface&quot;: &quot;eth0&quot;,\n&quot;macaddress&quot;: &quot;00:0c:29:e8:c7:9b&quot;,\n&quot;mtu&quot;: 1500,\n&quot;netmask&quot;: &quot;255.255.255.0&quot;,\n&quot;network&quot;: &quot;10.0.0.0&quot;,\n&quot;type&quot;: &quot;ether&quot;\n&#125;\n&#125;,\n&quot;changed&quot;: false\n&#125;\n</code></pre>\n<h3 id=\"debug-模块\"><a class=\"anchor\" href=\"#debug-模块\">#</a> debug 模块</h3>\n<p>功能：此模块可以用于输出信息，并且通过 msg 定制输出的信息内容，功能类似于 echo 命令<br />\n注意: msg 后面的变量有时需要加 &quot; &quot; 引起来<br />\n常见选项</p>\n<pre><code>msg #指定命令输出的信息\nvar #指定变量名,和msg互斥\nverbosity #详细度\n</code></pre>\n<p>范例: debug 模块默认输出 Hello world</p>\n<pre><code>[root@ansible ~]#ansible 10.0.0.18 -m debug\n10.0.0.18 | SUCCESS =&gt; &#123;\n&quot;msg&quot;: &quot;Hello world!&quot;\n&#125;\n[root@ansible ansible]#cat debug.yml\n---\n- hosts: websrvs\ntasks:\n- name: output Hello world\ndebug:\n#默认没有指定msg,默认输出&quot;Hello world!&quot;\n[root@ansible ansible]#ansible-playbook debug.yml\n.....\nTASK [output variables]\n********************************************************************************\n******************************\nok: [10.0.0.7] =&gt; &#123;\n&quot;msg&quot;: &quot;Hello world!&quot;\n&#125;\nok: [10.0.0.8] =&gt; &#123;\n&quot;msg&quot;: &quot;Hello world!&quot;\n&#125;\nPLAY RECAP\n********************************************************************************\n*******************************************\n10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n</code></pre>\n<p>范例：利用 debug 模块输出变量</p>\n<pre><code>[root@centos8 ~]#cat debug.yaml\n---\n- hosts: websrvs\ntasks:\n- name: output variables\ndebug:\nmsg: Host &quot;&#123;&#123; ansible_nodename &#125;&#125;&quot; Ip &quot;&#123;&#123; ansible_default_ipv4.address\n&#125;&#125;&quot;\n[root@centos8 ~]#ansible-playbook debug.yaml\nPLAY [websrvs]\n********************************************************************************\n***************************************\nTASK [Gathering Facts]\n********************************************************************************\n*******************************\nok: [10.0.0.7]\nok: [10.0.0.8]\nTASK [output variables]\n********************************************************************************\n******************************\nok: [10.0.0.7] =&gt; &#123;\n&quot;msg&quot;: &quot;Host \\&quot;centos7.wangxiaochun.com\\&quot; Ip \\&quot;10.0.0.7\\&quot;&quot;\n&#125;\nok: [10.0.0.8] =&gt; &#123;\n&quot;msg&quot;: &quot;Host \\&quot;centos8.wangxiaochun.com\\&quot; Ip \\&quot;10.0.0.8\\&quot;&quot;\n&#125;\nPLAY RECAP\n********************************************************************************\n*******************************************\n10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0\nskipped=0 rescued=0 ignored=0\n</code></pre>\n<p>范例：显示字符串特定字符</p>\n<pre><code># cat debug.yml\n- hosts: all\n  gather_facts: no\n  vars:\n    a: &quot;12345&quot;\n  tasks:\n  - debug:\n    msg:\n      - &quot;&#123;&#123;a[0]&#125;&#125;&quot;\n      - &quot;&#123;&#123;a[1]&#125;&#125;&quot;\n      - &quot;&#123;&#123;a[2]&#125;&#125;&quot;\n#定义了一个字符串变量a，如果想要获取a字符串的第3个字符，则可以使用”a[2]”获取，索引从0开始，执行上例playbook，debug的输出信息如下：\nTASK [debug] *************************\nok: [test1] =&gt; &#123;\n&quot;msg&quot;: &quot;1&quot;\n&quot;msg&quot;: &quot;2&quot;\n&quot;msg&quot;: &quot;3&quot;\n&#125;\n</code></pre>\n<h3 id=\"sysctl-模块\"><a class=\"anchor\" href=\"#sysctl-模块\">#</a> sysctl 模块</h3>\n<p>功能：修改内核参数<br />\n常见选项</p>\n<pre><code>name #内核参数\nvalue #指定值\nstate #是否保存在sysctl.conf文件中,默认present\nsysctl_set #使用sysctl -w 验证值生效\n</code></pre>\n<p>范例:</p>\n<pre><code>ansible websrvs -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present'\n</code></pre>\n<p>范例：内核参数优化</p>\n<pre><code>- name: Change Port Range\n  sysctl:\n    name: net.ipv4.ip_local_port_range\n\tvalue: '1024 65000'\n\tsysctl_set: yes\n- name: Enabled Forward\n  sysctl:\n\tname: net.ipv4.ip_forward\n\tvalue: '1'\n\tsysctl_set: yes\n- name: Enabled tcp_reuse\n  sysctl:\n    name: net.ipv4.tcp_tw_reuse\n    value: '1'\n    sysctl_set: yes\n- name: Chanage tcp tw_buckets\n  sysctl:\n    name: net.ipv4.tcp_max_tw_buckets\n    value: '5000'\n    sysctl_set: yes\n- name: Chanage tcp_syncookies\n  sysctl:\n    name: net.ipv4.tcp_syncookies\n    value: '1'\n    sysctl_set: yes\n- name: Chanage tcp max_syn_backlog\n  sysctl:\n    name: net.ipv4.tcp_max_syn_backlog\n    value: '8192'\n    sysctl_set: yes\n- name: Chanage tcp Established Maxconn\n  sysctl:\n    name: net.core.somaxconn\n    value: '32768'\n    sysctl_set: yes\n    state: present\n- name: Chanage tcp_syn_retries\n  sysctl:\n    name: net.ipv4.tcp_syn_retries\n    value: '2'\n    sysctl_set: yes\n    state: present\n- name: Chanage net.ipv4.tcp_synack_retries\n  sysctl:\n    name: net.ipv4.tcp_synack_retries\n    value: '2'\n    sysctl_set: yes\n    state: presen\n</code></pre>\n<h3 id=\"pam_limits\"><a class=\"anchor\" href=\"#pam_limits\">#</a> pam_limits</h3>\n<p>功能：管理资源限制<br />\n范例</p>\n<pre><code>- name: Change Limit /etc/security/limit.conf\n  pam_limits:\n  domain: &quot;*&quot;\n    limit_type: &quot;&#123;&#123; item.limit_type &#125;&#125;&quot;\n    limit_item: &quot;&#123;&#123; item.limit_item &#125;&#125;&quot;\n    value: &quot;&#123;&#123; item.value &#125;&#125;&quot;\n  loop:\n    - &#123; limit_type: 'soft', limit_item: 'nofile',value: '100000' &#125;\n    - &#123; limit_type: 'hard', limit_item: 'nofile',value: '10000' &#125;\n</code></pre>\n<h3 id=\"apt_repository-模块\"><a class=\"anchor\" href=\"#apt_repository-模块\">#</a> apt_repository 模块</h3>\n<p>功能：此模块实现 apt 的仓库配置管理<br />\n常见选项</p>\n<pre><code>repo #仓库信息\nstate #添加或删除\nupdate_cache #是否apt update,默认yes\nfilename #仓库文件,默认放在/etc/apt/sources.list.d/file.list\n</code></pre>\n<p>范例:</p>\n<pre><code>ansible ubuntu-servers -m apt_repository -a 'repo=&quot;deb\nhttp://archive.canonical.com/ubuntu focal partner&quot; filename=google-chrome'\n[root@ubuntu2004 ~]#cat /etc/apt/sources.list.d/google-chrome.list\ndeb http://archive.canonical.com/ubuntu focal partner\n</code></pre>\n<h3 id=\"apt_key-模块\"><a class=\"anchor\" href=\"#apt_key-模块\">#</a> apt_key 模块</h3>\n<p>功能：添加和删除 apt key<br />\n 常见选项</p>\n<pre><code>url #key路径\nstate #添加或删除\n</code></pre>\n<p>范例：生成 ceph 仓库配置</p>\n<pre><code>#先导入key,注意先后顺序\nansible ubuntu-servers -m apt_key -a\n'url=https://download.ceph.com/keys/release.asc state=present'\n#再生成apt配置,如果不导入key此步会出错\nansible ubuntu-servers -m apt_repository -a 'repo=&quot;deb\nhttp://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main&quot;\nfilename=ansible_ceph'\n#验证结果\n[root@ubuntu2004 ~]#cat /etc/apt/sources.list.d/ansible_ceph.list\ndeb http://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main\n</code></pre>\n<h3 id=\"其它模块\"><a class=\"anchor\" href=\"#其它模块\">#</a> 其它模块</h3>\n<p>ansible 还提供了很多针对各种应用的模块，比如</p>\n<pre><code>nginx_status_info\nnginx_status_facts\nmysql_db #需要安装MySQL-python包\nmysql_user #需要安装MySQL-python包\nredis\nmongodb*\npostgresql*\nhaproxy\ngit\n</code></pre>\n",
            "tags": [
                "Ansible"
            ]
        },
        {
            "id": "http://blog.itshare.work/Docker/docker-compose%E9%83%A8%E7%BD%B2MySQL/",
            "url": "http://blog.itshare.work/Docker/docker-compose%E9%83%A8%E7%BD%B2MySQL/",
            "title": "docker-compose部署MySql",
            "date_published": "2023-01-06T06:00:26.000Z",
            "content_html": "<h1 id=\"centos-docker-安装\"><a class=\"anchor\" href=\"#centos-docker-安装\">#</a> CentOS Docker 安装</h1>\n<p>Docker 支持以下的 64 位 CentOS 版本：</p>\n<ul>\n<li>CentOS 7</li>\n<li>CentOS 8</li>\n<li>更高版本...</li>\n</ul>\n<h2 id=\"官方安装脚本自动安装\"><a class=\"anchor\" href=\"#官方安装脚本自动安装\">#</a> 官方安装脚本自动安装</h2>\n<p>安装命令如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://get.docker.com <span class=\"token operator\">|</span> <span class=\"token function\">bash</span> <span class=\"token parameter variable\">-s</span> <span class=\"token function\">docker</span> <span class=\"token parameter variable\">--mirror</span> Aliyun</pre></td></tr></table></figure><p>也可以使用国内 daocloud 一键安装命令：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-sSL</span> https://get.daocloud.io/docker <span class=\"token operator\">|</span> <span class=\"token function\">sh</span></pre></td></tr></table></figure><h1 id=\"安装docker-compose\"><a class=\"anchor\" href=\"#安装docker-compose\">#</a> 安装 docker-compose</h1>\n<p>Compose 简介<br />\n Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，您可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。<br />\nCompose 安装<br />\n Linux 上我们可以从 Github 上下载它的二进制包来使用，最新发行的版本地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2RvY2tlci9jb21wb3NlL3JlbGVhc2VzJUUzJTgwJTgy\">https://github.com/docker/compose/releases。</span></p>\n<p>运行以下命令以下载 Docker Compose 的当前稳定版本：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-L</span> <span class=\"token string\">\"https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-s</span><span class=\"token variable\">)</span></span>-<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-m</span><span class=\"token variable\">)</span></span>\"</span> <span class=\"token parameter variable\">-o</span> /usr/local/bin/docker-compose</pre></td></tr></table></figure><p>要安装其他版本的 Compose，请替换 v2.2.2。</p>\n<p>Docker Compose 存放在 GitHub，不太稳定。</p>\n<p>你可以也通过执行下面的命令，高速安装 Docker Compose。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-L</span> https://get.daocloud.io/docker/compose/releases/download/v2.4.1/docker-compose-<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-s</span><span class=\"token variable\">`</span></span>-<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-m</span><span class=\"token variable\">`</span></span> <span class=\"token operator\">></span> /usr/local/bin/docker-compose</pre></td></tr></table></figure><p>将可执行权限应用于二进制文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">chmod</span> +x /usr/local/bin/docker-compose</pre></td></tr></table></figure><p>创建软链：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /usr/local/bin/docker-compose /usr/bin/docker-compose</pre></td></tr></table></figure><p>测试是否安装成功：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose version</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Docker Compose version v2.4.1</pre></td></tr></table></figure><h1 id=\"docker-compose一键部署mysql\"><a class=\"anchor\" href=\"#docker-compose一键部署mysql\">#</a> docker-compose 一键部署 mysql</h1>\n<ul>\n<li>创建安装目录，根据实际情况修改</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mkdr mysql</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">cd</span> mysql</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> data/db</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> etc</pre></td></tr></table></figure><ul>\n<li>编写 docker-compose.yml</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> mysql</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> docker-compose.yml</pre></td></tr></table></figure><p>docker-compose.yml 内容如下</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>version: '3.1'</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>services:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  mysql:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    image: mysql:5.7 #mysql版本</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    container_name: $&#123;MYSQL_NAME&#125;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    volumes:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      - ./data/db:/var/lib/mysql</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      - ./etc/my.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    restart: always</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    ports:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      - $&#123;MYSQL_PORT&#125;:3306</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    environment:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      MYSQL_ROOT_PASSWORD: $&#123;MYSQL_ROOT_PASSWD&#125; #访问密码</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      secure_file_priv:</pre></td></tr></table></figure><ul>\n<li>创建 MySQL 配置文件</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> mysql/etc</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> my.cnf</pre></td></tr></table></figure><p>my.cnf 文件内容如下</p>\n<pre><code>[mysqld]\ncharacter-set-server=utf8\nlog-bin=mysql-bin\nserver-id=1\npid-file        = /var/run/mysqld/mysqld.pid\nsocket          = /var/run/mysqld/mysqld.sock\ndatadir         = /var/lib/mysql\nsql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\nsymbolic-links=0\nsecure_file_priv =\nwait_timeout=120\ninteractive_timeout=120\ndefault-time_zone = '+8:00'\nskip-external-locking\nskip-name-resolve\nopen_files_limit = 10240\nmax_connections = 1000\nmax_connect_errors = 6000\ntable_open_cache = 800\nmax_allowed_packet = 40m\nsort_buffer_size = 2M\njoin_buffer_size = 1M\nthread_cache_size = 32\nquery_cache_size = 64M\ntransaction_isolation = READ-COMMITTED\ntmp_table_size = 128M\nmax_heap_table_size = 128M\nlog-bin = mysql-bin\nsync-binlog = 1\nbinlog_format = ROW\nbinlog_cache_size = 1M\nkey_buffer_size = 128M\nread_buffer_size = 2M\nread_rnd_buffer_size = 4M\nbulk_insert_buffer_size = 64M\nlower_case_table_names = 1\nexplicit_defaults_for_timestamp=true\nskip_name_resolve = ON\nevent_scheduler = ON\nlog_bin_trust_function_creators = 1\ninnodb_buffer_pool_size = 512M\ninnodb_flush_log_at_trx_commit = 1\ninnodb_file_per_table = 1\ninnodb_log_buffer_size = 4M\ninnodb_log_file_size = 256M\ninnodb_max_dirty_pages_pct = 90\ninnodb_read_io_threads = 4\ninnodb_write_io_threads = 4\n</code></pre>\n<ul>\n<li>编写重启脚本</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> mysql</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> restart.sh</pre></td></tr></table></figure><p>restart.sh 文件内容</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">docker-compose</span> stop</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">docker-compose</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span></pre></td></tr></table></figure><ul>\n<li>编写.env 文件</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> .env</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 容器名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">MYSQL_NAME</span><span class=\"token operator\">=</span>docker-mysql</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 启用端口</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">MYSQL_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># root 密码</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">MYSQL_ROOT_PASSWD</span><span class=\"token operator\">=</span><span class=\"token number\">123456</span></pre></td></tr></table></figure><ul>\n<li>验证</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 执行启动脚本</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">bash</span> restart.sh</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 查看运行的容器</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">docker</span> <span class=\"token function\">ps</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                                                  NAMES</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>36d09017f331   mysql:5.7                <span class=\"token string\">\"docker-entrypoint.s…\"</span>   <span class=\"token number\">2</span> minutes ago   Up <span class=\"token number\">2</span> minutes   <span class=\"token number\">0.0</span>.0.0:3306-<span class=\"token operator\">></span><span class=\"token number\">3306</span>/tcp, :::3306-<span class=\"token operator\">></span><span class=\"token number\">3306</span>/tcp, <span class=\"token number\">33060</span>/tcp   docker-mysql</pre></td></tr></table></figure>",
            "tags": [
                "Docker",
                "Linux从入门到放弃"
            ]
        },
        {
            "id": "http://blog.itshare.work/Linux/centos%E7%B3%BB%E7%BB%9Fyum%E9%85%8D%E7%BD%AE/",
            "url": "http://blog.itshare.work/Linux/centos%E7%B3%BB%E7%BB%9Fyum%E9%85%8D%E7%BD%AE/",
            "title": "Centos系统yum源配置",
            "date_published": "2022-12-17T01:28:09.000Z",
            "content_html": "<ul>\n<li>\n<p>系统<br />\n Centos7.9</p>\n</li>\n<li>\n<p>步骤</p>\n</li>\n</ul>\n<p>1. 备份</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos7-master ~]# mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</pre></td></tr></table></figure><p>2. 创建 /etc/yum.repos.d/CentOS-Base.repo 文件并复制如下内容</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[base]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name=CentOS-$releasever - Base</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>baseurl=http://mirrors.163.com/centos/$releasever/os/$basearch/</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        http://mirrors.aliyun.com/centos/$releasever/os/$basearch/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        http://mirrors.cloud.tencent.com/centos/$releasever/os/$basearch/</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        http://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/os/$basearch/</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        http://mirrors.huaweicloud.com/centos/$releasever/os/$basearch/</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        http://mirror.centos.org/centos/$releasever/os/$basearch/\t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>gpgcheck=0</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>#released updates </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>[updates]</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>name=CentOS-$releasever - Updates</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>baseurl=http://mirrors.163.com/centos/$releasever/updates/$basearch/</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        http://mirrors.aliyun.com/centos/$releasever/updates/$basearch/</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        http://mirrors.cloud.tencent.com/centos/$releasever/updates/$basearch/</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        http://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/updates/$basearch/</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\thttp://mirrors.huaweicloud.com/centos/$releasever/updates/$basearch/</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        http://mirror.centos.org/centos/$releasever/updates/$basearch/\t\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>gpgcheck=0</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>#additional packages that may be useful</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>[extras]</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>name=CentOS-$releasever - Extras</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>baseurl=http://mirrors.163.com/centos/$releasever/extras/$basearch/</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        http://mirrors.aliyun.com/centos/$releasever/extras/$basearch/</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\thttp://mirrors.cloud.tencent.com/centos/$releasever/extras/$basearch/</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        http://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/extras/$basearch/</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        http://mirrors.huaweicloud.com/centos/$releasever/extras/$basearch/</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\thttp://mirror.centos.org/centos/$releasever/extras/$basearch/</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>gpgcheck=0</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>#additional packages that extend functionality of existing packages</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>[centosplus]</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>name=CentOS-$releasever - Plus</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>baseurl=http://mirrors.163.com/centos/$releasever/centosplus/$basearch/</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        http://mirrors.aliyun.com/centos/$releasever/centosplus/$basearch/</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        http://mirrors.cloud.tencent.com/centos/$releasever/centosplus/$basearch/</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        http://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/centosplus/$basearch/</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        http://mirrors.huaweicloud.com/centos/$releasever/centosplus/$basearch/</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\thttp://mirror.centos.org/centos/$releasever/centosplus/$basearch/</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>gpgcheck=0</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>enabled=1</pre></td></tr></table></figure><p>3. 清除缓存</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum clean all</pre></td></tr></table></figure><p>4. 重新生成缓存</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum makecache</pre></td></tr></table></figure>",
            "tags": [
                "Linux",
                "Linux从入门到放弃"
            ]
        },
        {
            "id": "http://blog.itshare.work/MySQL/MySQL%E9%9B%86%E7%BE%A4/",
            "url": "http://blog.itshare.work/MySQL/MySQL%E9%9B%86%E7%BE%A4/",
            "title": "MySQL集群",
            "date_published": "2022-11-23T05:38:00.000Z",
            "content_html": "<h1 id=\"mysql集群\"><a class=\"anchor\" href=\"#mysql集群\">#</a> MySQL 集群</h1>\n<h2 id=\"主从复制架构和原理\"><a class=\"anchor\" href=\"#主从复制架构和原理\">#</a> 主从复制架构和原理</h2>\n<h3 id=\"mysql主从复制\"><a class=\"anchor\" href=\"#mysql主从复制\">#</a> MySQL 主从复制</h3>\n<ul>\n<li>读写分离</li>\n<li>复制：每个节点都有相同的数据集，向外扩展，基于二进制日志的单向复制</li>\n</ul>\n<h3 id=\"复制的功用\"><a class=\"anchor\" href=\"#复制的功用\">#</a> 复制的功用</h3>\n<ul>\n<li>负载均衡读操作</li>\n<li>备份</li>\n<li>高可用和故障切换</li>\n<li>数据分布</li>\n<li>MySQL 升级</li>\n</ul>\n<h3 id=\"复制架构\"><a class=\"anchor\" href=\"#复制架构\">#</a> 复制架构</h3>\n<p><strong>一主一从复制架构</strong></p>\n<p><img data-src=\"../image.assets/1669185369127.png\" alt=\"1669185369127\" /></p>\n<p><strong>一主多从复制架构</strong></p>\n<p><img data-src=\"../image.assets/1669185402487.png\" alt=\"1669185402487\" /></p>\n<h3 id=\"主从复制原理\"><a class=\"anchor\" href=\"#主从复制原理\">#</a> 主从复制原理</h3>\n<p><img data-src=\"../image.assets/1669185434299.png\" alt=\"1669185434299\" /></p>\n<h3 id=\"主从复制相关线程\"><a class=\"anchor\" href=\"#主从复制相关线程\">#</a> 主从复制相关线程</h3>\n<ul>\n<li>主节点：<br />\ndump Thread：为每个 Slave 的 I/O Thread 启动一个 dump 线程，用于向其发送 binary log events</li>\n<li>从节点：<br />\nI/O Thread：向 Master 请求二进制日志事件，并保存于中继日志中<br />\n SQL Thread：从中继日志中读取日志事件，在本地完成重放</li>\n</ul>\n<h3 id=\"跟复制功能相关的文件\"><a class=\"anchor\" href=\"#跟复制功能相关的文件\">#</a> 跟复制功能相关的文件：</h3>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL21hc3Rlci5pbmZv\">master.info</span>：用于保存 slave 连接至 master 时的相关信息，例如账号、密码、服务器地址等</li>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL3JlbGF5LWxvZy5pbmZv\">relay-log.info</span>：保存在当前 slave 节点上已经复制的当前二进制日志和本地 relay log 日志的对应关<br />\n系</li>\n<li>mysql-relay-bin.00000#: 中继日志，保存从主节点复制过来的二进制日志，本质就是二进制日志</li>\n</ul>\n<p>说明:</p>\n<pre><code>范例: 中继日志\nMySQL8.0 取消 master.info 和 relay-log.info文件\n</code></pre>\n<h3 id=\"实现主从复制配置\"><a class=\"anchor\" href=\"#实现主从复制配置\">#</a> 实现主从复制配置</h3>\n<p>官网参考</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>https://dev.mysql.com/doc/refman/8.0/en/replication-configuration.html</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>https://dev.mysql.com/doc/refman/5.7/en/replication-configuration.html</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>https://dev.mysql.com/doc/refman/5.5/en/replication-configuration.html</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>https://mariadb.com/kb/en/library/setting-up-replication/</pre></td></tr></table></figure><ul>\n<li>MySQL 版本：5.7.38</li>\n<li>centos7.9</li>\n</ul>\n<p><strong>主节点配置</strong></p>\n<p>（1）启用二进制日志</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>vim /etc/my.cnf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>log_bin</pre></td></tr></table></figure><p>(2) 为当前节点设置一个全局唯一的 ID 号</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server-id=#</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>log-basename=master #可选项，设置datadir中日志名称，确保不依赖主机名</pre></td></tr></table></figure><p><strong>说明</strong></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>server-id的取值范围</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>1 to 4294967295 (>= MariaDB 10.2.2)，默认值为1，MySQL8.0默认值为1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>0 to 4294967295 (&lt;= MariaDB 10.2.1)，默认值为0，如果从节点为0，所有master都将拒绝此</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>slave的连接</pre></td></tr></table></figure><p><img data-src=\"../image.assets/1669215296538.png\" alt=\"1669215296538\" /></p>\n<p><strong>注意：修改配置文件后重启 mysql 服务</strong></p>\n<p>（3）创建有复制权限的用户账号</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>#MySQL8.0 分成两步实现</pre></td></tr><tr><td data-num=\"2\"></td><td><pre># 创建用户</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mysql> create user test@'192.168.179.165' identified by'123456';</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Query OK, 0 rows affected (0.02 sec)</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>mysql> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre># 赋予权限</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>mysql> grant replication slave on *.* to test@'192.168.179.165';</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Query OK, 0 rows affected (0.01 sec)</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>mysql> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>#其他</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>mysql> GRANT REPLICATION SLAVE ON *.* TO 'test'@'HOST' IDENTIFIED BY '123456';</pre></td></tr></table></figure><p>(4) 完全备份数据库</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos7 ~]# mysqldum -A -F --master-data=1 --single-transaction > /backup/all_`date +%F`.sql</pre></td></tr></table></figure><figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos7 backup]# ll /backup/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>total 1216</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-rw-r--r-- 1 root root 1244691 Nov 23 23:07 all_2022-11-23.sql</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[root@centos7 backup]#</pre></td></tr></table></figure><p><strong>从节点配置</strong></p>\n<p>(1) 修改从节点 server-id, 不能和主节点 server-id 一致</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server-id=2</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>#或者使用如下配置</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server_id=# #为当前节点设置一个全局惟的ID号</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>log-bin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>read_only=ON #设置数据库只读，针对supper user无效</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>relay_log=relay-log #relay log的文件路径，默认值hostname-relay-bin</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>relay_log_index=relay-log.index #默认值hostname-relay-bin.index</pre></td></tr></table></figure><p>（2）使用有复制权限的用户账号连接至主服务器，并启动复制线程</p>\n<p>从节点导入主节点完全备份的数据</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># 关闭二进制日志</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mysql> set sql_log_bin=0;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Query OK, 0 rows affected (0.00 sec)</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mysql> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre># 还原备份</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>mysql> source all_2022-11-23.sql;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre># 开启二进制日志</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>mysql> set sql_log_bin=1;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Query OK, 0 rows affected (0.00 sec)</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>mysql> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre># 开启线程</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>mysql> start slave;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Query OK, 0 rows affected, 1 warning (0.03 sec)</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>mysql></pre></td></tr></table></figure><p>mysql 客户端命令行执行如下内容</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CHANGE MASTER TO MASTER_HOST='192.168.179.170', MASTER_USER='test',MASTER_PASSWORD='123456',MASTER_LOG_FILE='mysql-bin.000007', MASTER_LOG_POS=154;</pre></td></tr></table></figure><p>MASTER_LOG_FILE='mysql-bin.000007', MASTER_LOG_POS=154; 的值可以从备份 sql 文件中找到，如图所示：</p>\n<p><img data-src=\"../image.assets/1669262500961.png\" alt=\"1669262500961\" /></p>\n<p>最后启动复制线程</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>start slave</pre></td></tr></table></figure><p>扩展：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>show slave status\\G  # 查看相关状态信息</pre></td></tr></table></figure><p><img data-src=\"../image.assets/1669262596413.png\" alt=\"1669262596413\" /></p>\n<p>从节点更换主节点</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>>mysql stop slave;  #停止复制线程</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>>mysql reset slave all;   # 清除信息 </pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>再次使用有复制权限的用户账号连接至主服务器，并启动复制线程</pre></td></tr></table></figure><h3 id=\"级联复制\"><a class=\"anchor\" href=\"#级联复制\">#</a> 级联复制</h3>\n<p>案例：三台主机实现级联复制</p>\n<p><img data-src=\"../image.assets/1669306551265.png\" alt=\"1669306551265\" /></p>\n<p><strong>步骤</strong></p>\n<pre><code># 192.168.179.170充当master\n# 192.168.179.171充当slave1\n# 192.168.179.157充当slave2\n# 操作系统：centos7.9\n#MySQL版本：5.7.38\n</code></pre>\n<p><strong>在 master 上实现，即 192.168.179.170</strong></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># 在master上实现，即192.168.179.170</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>vim /etc/my.cnf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>server-id=170</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>log-bin=/data/mysql/mysql-bin</pre></td></tr></table></figure><p><img data-src=\"../image.assets/1669342445575.png\" alt=\"1669342445575\" /></p>\n<p><strong>重启服务</strong></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos7 ~]# systemctl restart mysql</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[root@centos7 ~]#</pre></td></tr></table></figure><p><strong>创建具有复制权限的账号</strong></p>\n<pre><code>mysql&gt; grant replication slave on *.* to 'test'@'192.168.179.%' identified by '123456';\nQuery OK, 0 rows affected, 1 warning (0.00 sec)\n\nmysql&gt; \n</code></pre>\n<p><strong>完全备份</strong></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@centos7 ~]# mysqldump  -uroot -p123456 -A -F --single-transaction --master-data=1 > /data/all.sql;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[root@centos7 ~]# scp /data/all.sql root@192.168.179.171:/data</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[root@centos7 ~]# scp /data/all.sql root@192.168.179.157:/data</pre></td></tr></table></figure><p><strong>在中间级联实现</strong></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>#在中间级联实现,即192.168.179.171</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>#修改配置文件</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>vim /etc/my.cnf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server-id=171</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>log-bin=/data/mysql/slave1-bin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>read-only</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>log_slave_updates #级联复制中间节点的必选项,MySQL8.0此为默认值,可以不要人为添加</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>#重启mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>service mysqld restart或者systemctl restart mysql</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre># 还原数据库</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>vim /data/all.sql</pre></td></tr></table></figure><p><img data-src=\"../image.assets/1669343598599.png\" alt=\"1669343598599\" /></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql> set sql_log_bin=0;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Query OK, 0 rows affected (0.00 sec)</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mysql> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mysql> source /data/all.sql;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mysql> show master logs;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>+-------------------+-----------+</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>| Log_name          | File_size |</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>+-------------------+-----------+</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>| slave1-bin.000001 |       801 |</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>| slave1-bin.000002 |       458 |</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>+-------------------+-----------+</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>2 rows in set (0.01 sec)</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>mysql> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>mysql> set sql_log_bin=1;</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Query OK, 0 rows affected (0.00 sec)</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>mysql> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql> start slave;</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Query OK, 0 rows affected (0.01 sec)</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql></pre></td></tr></table></figure><p><strong>在第三个节点 slave 上实现</strong></p>\n<pre><code>vim /etc/my.cnf\n[mysqld]\nserver-id=157\nlog-bin=/data/mysql/slave2-bin\n\n# 还原数据库\nvim /data/all.sql\n</code></pre>\n<p><img data-src=\"../image.assets/1669346692481.png\" alt=\"1669346692481\" /></p>\n<pre><code>mysql&gt; set sql_log_bin=0;\nmysql&gt; source /data/all.sql\nmysql&gt; set sql_log_bin=1;\nmysql&gt; start slave;\n</code></pre>\n<h3 id=\"半同步复制\"><a class=\"anchor\" href=\"#半同步复制\">#</a> 半同步复制</h3>\n<p><img data-src=\"../image.assets/1669367459560.png\" alt=\"1669367459560\" /></p>\n<p>范例：centos7.9 在 MySQL5.7.38 实现半同步复制</p>\n<pre><code># 主服务器配置，安装semisync_slave.so插件\nmysql&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';\nQuery OK, 0 rows affected (0.05 sec)\n\nmysql&gt; \n# 修改配置文件\nvim /etc/my.cnf\nrpl_semi_sync_master_enabled=ON \n#修改此行,需要先安装semisync_master.so插件后,再重启,否则无法启动\nrpl_semi_sync_master_timeout=3000 \n#设置3s内无法同步，也将返回成功信息给客户端 \n\n# 重启服务\nsystemctl restart mysql\n\n#slave服务器配置\n#安装semisync_slave.so插件\nmysql&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';\nQuery OK, 0 rows affected (0.05 sec)\n\n#注意:如果已经实现主从复制,需要stop slave;start slave;\nmysql&gt; stop slave;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; start slave\n    -&gt; ;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; \n\n# 重启mysql服务\nsystemctl restart mysql\n\n# 修改配置文件\nvim /etc/my.cnf\nrpl_semi_sync_slave_enabled=ON\n\n# 重启mysql服务\nsystemctl restart mysql\n</code></pre>\n<p>测试半同步</p>\n<pre><code># 停止从库slave1\n[root@centos7 ~]# systemctl stop mysql\n# 主库创建表\nmysql&gt; create database hellodb;\nQuery OK, 1 row affected (3.00 sec)\n\nmysql&gt; \n# 设置的是三秒内无法同步返回成功，所以看到是3S后返回成功\n\n</code></pre>\n<h3 id=\"实战案例利用mycat实现mysql的读写分离\"><a class=\"anchor\" href=\"#实战案例利用mycat实现mysql的读写分离\">#</a> 实战案例：利用 Mycat 实现 MySQL 的读写分离</h3>\n<p><img data-src=\"../image.assets/1669456007835.png\" alt=\"1669456007835\" /></p>\n<p><strong>所有主机系统环境</strong></p>\n<pre><code>centos7.9\n</code></pre>\n<p><strong>服务器三台</strong></p>\n<pre><code>mycat-server 192.168.179.157 #内存建议2G以上\nmysql-master 192.168.179.170 MySQL 5.7\nmysql-slave  192.168.179.171 MySQL 5.7\n</code></pre>\n<p><strong>关闭 SELinux 和防火墙</strong></p>\n<pre><code>systemctl stop firewalld\nsetenforce 0\n时间同步\n</code></pre>\n<p><img data-src=\"../image.assets/1669455589146.png\" alt=\"1669455589146\" /></p>\n<p><strong>注意：主从复制的过程省略，参考实现主从复制过程</strong></p>\n<p><strong>代理服务器上安装 Mycat</strong></p>\n<p>下载地址:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL015Q0FUQXBhY2hlL015Y2F0LVNlcnZlci9yZWxlYXNlcy90YWcvTXljYXQtc2VydmVyLTEuNi43LjQtcmVsZWFzZQ==\">https://github.com/MyCATApache/Mycat-Server/releases/tag/Mycat-server-1.6.7.4-release</span></p>\n<pre><code># 安装jdk\n[root@centos7 ~]# yum install -y java\n\n# 验证\n[root@centos7 ~]# java -version\nopenjdk version &quot;1.8.0_352&quot;\nOpenJDK Runtime Environment (build 1.8.0_352-b08)\nOpenJDK 64-Bit Server VM (build 25.352-b08, mixed mode)\n[root@centos7 ~]# \n\n[root@centos7 ~]# mkdir /apps\n\n[root@centos7 ~]# tar xf Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz -C /apps/\n[root@centos7 ~]# \n\n#配置环境变量\n[root@centos7 ~]# echo 'PATH=/apps/mycat/bin:$PATH' &gt; /etc/profile.d/mycat.sh\n[root@centos7 ~]# source /etc/profile.d/mycat.sh\n\n#注意: 此步启动较慢,需要等一会儿,另外如果内存太小,会导致无法启动\n[root@centos7 ~]# mycat start\nStarting Mycat-server...\n[root@centos7 ~]# \n\n# 查看日志是否启动成功\n[root@centos7 ~]# tail -f /apps/mycat/logs/wrapper.log \nSTATUS | wrapper  | 2022/11/26 23:27:52 | --&gt; Wrapper Started as Daemon\nSTATUS | wrapper  | 2022/11/26 23:27:52 | Launching a JVM...\nINFO   | jvm 1    | 2022/11/26 23:28:08 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org\nINFO   | jvm 1    | 2022/11/26 23:28:08 |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.\nINFO   | jvm 1    | 2022/11/26 23:28:08 | \nINFO   | jvm 1    | 2022/11/26 23:28:10 | MyCAT Server startup successfully. see logs in logs/mycat.log\n\n#用默认密码123456来连接mycat\n[root@centos7 ~]# mysql -uroot -p123456 -h 192.168.179.157 -P8066\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 1\nServer version: 5.6.29-mycat-1.6.7.4-release-20200105164103 MyCat Server (OpenCloudDB)\n\nCopyright (c) 2000, 2022, Oracle and/or its affiliates.\n\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nmysql&gt; show databases;\n+----------+\n| DATABASE |\n+----------+\n| TESTDB   |\n+----------+\n1 row in set (0.00 sec)\n\nmysql&gt; \n\n# 在主节点上创建账号用于mycat数据读写分离\nmysql&gt;create user admin@'192.168.179.%' identified by'123456';\n\n# 赋予权限\nmysql&gt; grant all on *.* to 'admin'@'192.168.179.%' IDENTIFIED BY '123456';\nQuery OK, 0 rows affected, 1 warning (0.01 sec)\n\n# 刷新\n# mysql&gt; flush privileges;\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql&gt; \n\n</code></pre>\n<p><strong>修改 schema.xml 实现读写分离策略</strong></p>\n<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;\n&lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;\n&lt;mycat:schema xmlns:mycat=&quot;http://io.mycat/&quot;&gt;\n    &lt;schema name=&quot;TESTDB&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;dn1&quot;&gt;\n    &lt;/schema&gt;\n    &lt;dataNode name=&quot;dn1&quot; dataHost=&quot;localhost1&quot; database=&quot;reggie&quot; /&gt;\n    &lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;\n              writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot;  slaveThreshold=&quot;100&quot;&gt;\n        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;\n        &lt;writeHost host=&quot;host1&quot; url=&quot;192.168.179.170:3306&quot; user=&quot;admin&quot;\n                   password=&quot;123456&quot;&gt;\n         &lt;readHost host=&quot;host2&quot; url=&quot;192.168.179.171:3306&quot; user=&quot;admin&quot; password=&quot;123456&quot; /&gt;\n        &lt;/writeHost&gt;\n    &lt;/dataHost&gt;\n&lt;/mycat:schema&gt;\n\n</code></pre>\n<p><img data-src=\"../image.assets/1669482336285.png\" alt=\"1669482336285\" /></p>\n<p>重启 mycat</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mycat restart</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Stopping Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Stopped Mycat-server.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Starting Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>在 Mycat 服务器上连接并测试</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@centos8 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p123456 -h 192.168.179.157 -P8066</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mysql<span class=\"token operator\">></span> show databases<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> DATABASE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> TESTDB   <span class=\"token operator\">|</span>   //只能看一个虚拟数据库,数据库内容映射的是reggie内容</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>mysql<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>mysql<span class=\"token operator\">></span> use TESTDB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Reading table information <span class=\"token keyword\">for</span> completion of table and <span class=\"token function\">column</span> names</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>You can turn off this feature to get a quicker startup with <span class=\"token parameter variable\">-A</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Database changed</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>mysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">|</span> Tables_in_reggie <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">|</span> address_book     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">|</span> category         <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">|</span> dish             <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">|</span> dish_flavor      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">|</span> employee         <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">|</span> order_detail     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">|</span> orders           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">|</span> setmeal          <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">|</span> setmeal_dish     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">|</span> shopping_cart    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">|</span> user             <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">11</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>mysql<span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"mha实战案例\"><a class=\"anchor\" href=\"#mha实战案例\">#</a> MHA 实战案例</h3>\n<p><img data-src=\"../image.assets/1669541563329.png\" alt=\"1669541563329\" /></p>\n<p><strong>主从复制搭建过程省略</strong></p>\n<p><strong>在所有 MySQL 服务器上安装 mha4mysql-node 包</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>下载地址</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mha4mysql-manager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mha4mysql-node</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#下载</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>https://github.com/yoshinorim/mha4mysql-node/releases/tag/v0.58</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>https://github.com/yoshinorim/mha4mysql-node/releases/tag/v0.58</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>yum <span class=\"token parameter variable\">-y</span> <span class=\"token function\">install</span> mha4mysql-node-0.58-0.el7.centos.noarch.rpm</pre></td></tr></table></figure><p><strong>在管理节点上安装两个包 mha4mysql-manager 和 mha4mysql-node</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mha-manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#yum -y install mha4mysql-manager-0.58-</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">0</span>.el7.centos.noarch.rpm</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@mha-manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#yum -y install mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span></pre></td></tr></table></figure><p><strong>在所有节点实现相互之间 ssh key 验证</strong></p>\n<pre><code>[root@centos7 ~]# ssh-keygen \n[root@centos7 ~]# ssh-copy-id 127.0.0.1\n[root@centos7 ~]# scp -r .ssh 192.168.179.170:/root/\n[root@centos7 ~]# scp -r .ssh 192.168.179.171:/root/\n[root@centos7 ~]# scp -r .ssh 192.168.179.157:/root/\n</code></pre>\n<p><strong>在管理节点创建配置文件</strong></p>\n<pre><code>[root@centos7 ~]# mkdir /etc//mastermha/\n[root@centos7 ~]# vim app1.cnf\n# 文件内容\n[server default]\nuser=mhauser #用于远程连接MySQL所有节点的用户,需要有管理员的权限\npassword=123456\nmanager_workdir=/data/mastermha/app1/ #目录会自动生成,无需手动创建\nmanager_log=/data/mastermha/app1/manager.log\nremote_workdir=/data/mastermha/app1/\nssh_user=root #用于实现远程ssh基于KEY的连接,访问二进制日志\nrepl_user=test #主从复制的用户信息\nrepl_password=123456\nping_interval=1 #健康性检查的时间间隔\nmaster_ip_failover_script=/usr/local/bin/master_ip_failover #切换VIP的perl脚本,不\n支持跨网络,也可用Keepalived实现\nreport_script=/usr/local/bin/sendmail.sh #当执行报警脚本\ncheck_repl_delay=0 #默认值为1,表示如果slave中从库落后主库relay log超过100M，主库不会选\n择这个从库为新的master，因为这个从库进行恢复需要很长的时间.通过设置参数check_repl_delay=0，\nmha触发主从切换时会忽略复制的延时，对于设置candidate_master=1的从库非常有用，这样确保这个从库\n一定能成为最新的master\nmaster_binlog_dir=/data/mysql/ #指定二进制日志存放的目录,mha4mysql-manager-0.58必须指\n定,之前版本不需要指定\n[server1]\nhostname=192.168.179.170\nport=3306\ncandidate_master=1\n[server2]\nhostname=192.168.179.171\nport=3306\ncandidate_master=1 #设置为优先候选master，即使不是集群中事件最新的slave,也会优先当\nmaster\n[server3]\nhostname=192.168.179.157\nport=3306\n</code></pre>\n<p>最终文件内容</p>\n<pre><code>[server default]\nuser=mhauser\npassword=123456\nmanager_workdir=/data/mastermha/app1/\nmanager_log=/data/mastermha/app1/manager.log\nremote_workdir=/data/mastermha/app1/\nssh_user=root\nrepl_user=test\nrepl_password=123456\nping_interval=1\nmaster_ip_failover_script=/usr/local/bin/master_ip_failover\nreport_script=/usr/local/bin/sendmail.sh # 发送邮件脚本\ncheck_repl_delay=0\nmaster_binlog_dir=/data/mysql/\n\n[server1]\nhostname=192.168.179.170\ncandidate_master=1\n[server2]\nhostname=192.168.179.171\n[server3]\nhostname=192.168.179.157\n</code></pre>\n<p>主节点创建账号 user=mhauser #用于远程连接 MySQL 所有节点的用户，需要有管理员的权限<br />\n password=123456</p>\n<pre><code>mysql&gt; create user mhauser@'192.168.179.%' identified by '123456';\nQuery OK, 0 rows affected (0.05 sec)\n\nmysql&gt; \n\nmysql&gt; grant all on *.* to mhauser@'192.168.179.%';\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; \n</code></pre>\n<p>master_ip_failover_script=/usr/local/bin/master_ip_failover 文件内容</p>\n<pre><code>#!/usr/bin/env perl\n\n#  Copyright (C) 2011 DeNA Co.,Ltd.\n#\n#  This program is free software; you can redistribute it and/or modify\n#  it under the terms of the GNU General Public License as published by\n#  the Free Software Foundation; either version 2 of the License, or\n#  (at your option) any later version.\n#\n#  This program is distributed in the hope that it will be useful,\n#  but WITHOUT ANY WARRANTY; without even the implied warranty of\n#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n#  GNU General Public License for more details.\n#\n#  You should have received a copy of the GNU General Public License\n#   along with this program; if not, write to the Free Software\n#  Foundation, Inc.,\n#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n\n## Note: This is a sample script and is not complete. Modify the script based on your environment.\n\nuse strict;\nuse warnings FATAL =&gt; 'all';\n\nuse Getopt::Long;\nuse MHA::DBHelper;\n\nmy (\n  $command,        $ssh_user,         $orig_master_host,\n  $orig_master_ip, $orig_master_port, $new_master_host,\n  $new_master_ip,  $new_master_port,  $new_master_user,\n  $new_master_password\n);\nmy $vip = '192.168.179.157/24';\nmy $key = &quot;1&quot;;\nmy $ssh_start_vip = &quot;/sbin/ifconfig eth0:$key $vip&quot;;\nmy $ssh_stop_vip = &quot;/sbin/ifconfig eth0:$key down&quot;;\n\nGetOptions(\n  'command=s'             =&gt; \\$command,\n  'ssh_user=s'            =&gt; \\$ssh_user,\n  'orig_master_host=s'    =&gt; \\$orig_master_host,\n  'orig_master_ip=s'      =&gt; \\$orig_master_ip,\n  'orig_master_port=i'    =&gt; \\$orig_master_port,\n  'new_master_host=s'     =&gt; \\$new_master_host,\n  'new_master_ip=s'       =&gt; \\$new_master_ip,\n  'new_master_port=i'     =&gt; \\$new_master_port,\n  'new_master_user=s'     =&gt; \\$new_master_user,\n  'new_master_password=s' =&gt; \\$new_master_password,\n);\n\nexit &amp;main();\n\nsub main &#123;\n  if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123;\n\n    # $orig_master_host, $orig_master_ip, $orig_master_port are passed.\n    # If you manage master ip address at global catalog database,\n    # invalidate orig_master_ip here.\n    my $exit_code = 1;\n    eval &#123;\n\n      # updating global catalog, etc\n      $exit_code = 0;\n    &#125;;\n    if ($@) &#123;\n      warn &quot;Got Error: $@\\n&quot;;\n      exit $exit_code;\n    &#125;\n    exit $exit_code;\n  &#125;\n    elsif ( $command eq &quot;start&quot; ) &#123;\n\n        # all arguments are passed.\n        # If you manage master ip address at global catalog database,\n        # activate new_master_ip here.\n        # You can also grant write access (create user, set read_only=0, etc) here.\n        my $exit_code = 10;\n        eval &#123;\n            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \\n&quot;;\n            &amp;start_vip();\n            &amp;stop_vip();\n            $exit_code = 0;\n        &#125;;\n        if ($@) &#123;\n            warn $@;\n            exit $exit_code;\n        &#125;\n        exit $exit_code;\n    &#125;\n    elsif ( $command eq &quot;status&quot; ) &#123;\n        print &quot;Checking the Status of the script.. OK \\n&quot;;\n        `ssh $ssh_user\\@$orig_master_host \\&quot; $ssh_start_vip \\&quot;`;\n        exit 0;\n    &#125;\n    else &#123;\n        &amp;usage();\n        exit 1;\n    &#125;\n&#125;\n\n\nsub start_vip() &#123;\n    `ssh $ssh_user\\@$new_master_host \\&quot; $ssh_start_vip \\&quot;`;\n&#125;\n# A simple system call that disable the VIP on the old_master \nsub stop_vip() &#123;\n   `ssh $ssh_user\\@$orig_master_host \\&quot; $ssh_stop_vip \\&quot;`;\n&#125;\n\n\nsub usage &#123;\n  print\n&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\\n&quot;;\n&#125;\n</code></pre>\n<p>master 修改 mysql 配置文件</p>\n<pre><code>[mysqld]\nserver_id=170\nlog-bin=/data/mysql/mysql-bin\nskip_name_resolve=1\n</code></pre>\n<p>slave 节点上修改</p>\n<pre><code>[mysqld]\nserver_id=171 #不同节点此值各不相同\nlog-bin=/data/mysql/mysql-bin\nread_only\nrelay_log_purge=0\nskip_name_resolve=1\n</code></pre>\n<p>检查环境</p>\n<pre><code class=\"language-\\\">masterha_check_ssh --conf=/etc/mastermha/app1.cnf\n# 范例\n[root@centos7 ~]# masterha_check_ssh --conf=/etc/mastermha/app1.cnf\nTue Nov 29 22:21:44 2022 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nTue Nov 29 22:21:44 2022 - [info] Reading application default configuration from /etc/mastermha/app1.cnf..\nTue Nov 29 22:21:44 2022 - [info] Reading server configuration from /etc/mastermha/app1.cnf..\nTue Nov 29 22:21:44 2022 - [info] Starting SSH connection tests..\nTue Nov 29 22:21:45 2022 - [debug] \nTue Nov 29 22:21:44 2022 - [debug]  Connecting via SSH from root@192.168.179.170(192.168.179.170:22) to root@192.168.179.171(192.168.179.171:22)..\nTue Nov 29 22:21:44 2022 - [debug]   ok.\nTue Nov 29 22:21:44 2022 - [debug]  Connecting via SSH from root@192.168.179.170(192.168.179.170:22) to root@192.168.179.157(192.168.179.157:22)..\nTue Nov 29 22:21:45 2022 - [debug]   ok.\nTue Nov 29 22:21:46 2022 - [debug] \nTue Nov 29 22:21:45 2022 - [debug]  Connecting via SSH from root@192.168.179.171(192.168.179.171:22) to root@192.168.179.170(192.168.179.170:22)..\nTue Nov 29 22:21:45 2022 - [debug]   ok.\nTue Nov 29 22:21:45 2022 - [debug]  Connecting via SSH from root@192.168.179.171(192.168.179.171:22) to root@192.168.179.157(192.168.179.157:22)..\nTue Nov 29 22:21:45 2022 - [debug]   ok.\nTue Nov 29 22:21:47 2022 - [debug] \nTue Nov 29 22:21:45 2022 - [debug]  Connecting via SSH from root@192.168.179.157(192.168.179.157:22) to root@192.168.179.170(192.168.179.170:22)..\nTue Nov 29 22:21:45 2022 - [debug]   ok.\nTue Nov 29 22:21:45 2022 - [debug]  Connecting via SSH from root@192.168.179.157(192.168.179.157:22) to root@192.168.179.171(192.168.179.171:22)..\nTue Nov 29 22:21:46 2022 - [debug]   ok.\nTue Nov 29 22:21:47 2022 - [info] All SSH connection tests passed successfully.\n[root@centos7 ~]# \n\nmasterha_check_repl --conf=/etc/mastermha/app1.cnf\n# 范例\n[root@centos7 ~]# masterha_check_repl --conf=/etc/mastermha/app1.cnf\n......\n......\nter_host=192.168.179.170 --orig_master_ip=192.168.179.170 --orig_master_port=3306 \nChecking the Status of the script.. OK \nbash: /sbin/ifconfig: No such file or directory\nTue Nov 29 22:45:13 2022 - [info]  OK.\nTue Nov 29 22:45:13 2022 - [warning] shutdown_script is not defined.\nTue Nov 29 22:45:13 2022 - [info] Got exit code 0 (Not master dead).\n\nMySQL Replication Health is OK.\n\n</code></pre>\n<p>查看状态</p>\n<pre><code>masterha_check_status --conf=/etc/mastermha/app1.cnf\napp1 is stopped(2:NOT_RUNNING).\n</code></pre>\n<p>启动和停止 mha</p>\n<pre><code># 后台运行\nnohup masterha_manager --conf=/etc/mastermha/app1.cnf --remove_dead_master_conf\n--ignore_last_failover &amp;&gt; /dev/null\n# 前台运行\nmasterha_manager --conf=/etc/mastermha/app1.cnf --\nremove_dead_master_conf --ignore_last_failover\n</code></pre>\n<pre><code>#如果想停止后台执行的MHA,可以执行下面命令\n[root@mha-master ~]#masterha_stop --conf=/etc/mastermha/app1.cnf\nStopped app1 successfully.\n</code></pre>\n<p>查看状态</p>\n<pre><code>[root@centos7 app1]# masterha_check_status --conf=/etc/mastermha/app1.cnf\napp1 (pid:48280) is running(0:PING_OK), master:192.168.179.170\n</code></pre>\n",
            "tags": [
                "MySQL",
                "MySQL基础"
            ]
        },
        {
            "id": "http://blog.itshare.work/MySQL/MySQL/",
            "url": "http://blog.itshare.work/MySQL/MySQL/",
            "title": "MySQL数据库基础和安装使用",
            "date_published": "2022-09-28T14:42:41.000Z",
            "content_html": "<p>MySQL 是一个关系型数据库管理系统，由瑞典 MySQL AB 公司开发，属于 Oracle 旗下产品。MySQL 是最流行的关系型数据库管理系统之一，在 WEB 应用方面，MySQL 是最好的 RDBMS (Relational Database Management System，关系数据库管理系统) 应用软件之一<br />\n<span id=\"more\"></span></p>\n<h1 id=\"mysql的特性\"><a class=\"anchor\" href=\"#mysql的特性\">#</a> MySQL 的特性</h1>\n<p><img data-src=\"../image.assets/1668695639684.png\" alt=\"1668695639684\" /></p>\n<h1 id=\"mysql安装\"><a class=\"anchor\" href=\"#mysql安装\">#</a> MySQL 安装</h1>\n<h2 id=\"安装方式介绍\"><a class=\"anchor\" href=\"#安装方式介绍\">#</a> 安装方式介绍</h2>\n<p>程序包管理器管理的程序包<br />\n源代码编译安装<br />\n二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用</p>\n<h3 id=\"rpm安装\"><a class=\"anchor\" href=\"#rpm安装\">#</a> rpm 安装</h3>\n<p>CentOS 安装光盘<br />\n项目官方：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb3dubG9hZHMubWFyaWFkYi5vcmcvbWFyaWFkYi9yZXBvc2l0b3JpZXMv\">https://downloads.mariadb.org/mariadb/repositories/</span><br />\n 国内镜像：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXJyb3JzLnR1bmEudHNpbmdodWEuZWR1LmNuL21hcmlhZGIveXVtLw==\">https://mirrors.tuna.tsinghua.edu.cn/mariadb/yum/</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXJyb3JzLnR1bmEudHNpbmdodWEuZWR1LmNuL215c3FsL3l1bS8=\">https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/</span></p>\n<p><strong>范例 1：CentOS 7 利用 yum 源安装 MySQL8.0</strong></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXYubXlzcWwuY29tL2Rvd25sb2Fkcy9yZXBvL3l1bS8=\">MySQL 官网</span></p>\n<ul>\n<li>官网下载 rpm 包</li>\n</ul>\n<p><img data-src=\"../image.assets/1664415600826.png\" alt=\"1664415600826\" /></p>\n<ul>\n<li>利用 rz 命令将 rpm 包上传到主机</li>\n</ul>\n<p><strong>扩展：</strong></p>\n<pre><code class=\"language-TEXT\">rz命令yum安装:yum install lrzsz\n</code></pre>\n<p><img data-src=\"../image.assets/1664415914209.png\" alt=\"1664415914209\" /></p>\n<ul>\n<li>安装 rpm 包</li>\n</ul>\n<pre><code class=\"language-TEXT\">root@centos7[~]-&gt;yum install mysql80-community-release-el7-7.noarch.rpm\n</code></pre>\n<ul>\n<li>安装 MySQL</li>\n</ul>\n<pre><code class=\"language-TEXT\">root@centos7[~]-&gt;yum install -y mysql-community-server\n</code></pre>\n<p><strong>范例 2：CentOS 7 利用 yum 源安装 MySQL5.7</strong></p>\n<pre><code class=\"language-TEXT\">[root@centos7 ~]#tee /etc/yum.repos.d/mysql.repo &lt;&lt;EOF\n[mysql]\nname=mysql5.7\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-\nx86_64/\ngpgcheck=0\nEOF\n[root@centos7 ~]#yum -y install mysql-community-server\n[root@centos7 ~]#systemctl enable --now mysqld\n</code></pre>\n<h3 id=\"二进制安装\"><a class=\"anchor\" href=\"#二进制安装\">#</a> 二进制安装</h3>\n<p><strong>环境</strong></p>\n<p>系统：rocky8.5</p>\n<p>MySQL 版本：mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz</p>\n<p><strong>步骤</strong></p>\n<ul>\n<li>安装相关包</li>\n</ul>\n<pre><code class=\"language-TEXT\">yum -y install libaio numactl-libs\n</code></pre>\n<ul>\n<li>准备用户</li>\n</ul>\n<pre><code class=\"language-TEXT\">groupadd mysql\nuseradd -r -g mysql -s /bin/false mysql\n</code></pre>\n<ul>\n<li>下载二进制程序包</li>\n</ul>\n<pre><code class=\"language-TEXT\"># -P下载到指定目录\nwget https://cdn.mysql.com/archives/mysql-8.0/mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz -P /usr/local/  \n\n ln -s mysql-8.0.28-linux-glibc2.12-x86_64 mysql\n \n chown -R root.root /usr/local/mysql/\n</code></pre>\n<ul>\n<li>准备环境变量</li>\n</ul>\n<pre><code class=\"language-TEXT\">echo 'PATH=/usr/local/mysql/bin:$PATH' &gt; /etc/profile.d/mysql.sh\n. /etc/profile.d/mysql.sh\n</code></pre>\n<ul>\n<li>准备配置文件</li>\n</ul>\n<pre><code class=\"language-TEXT\">vim /etc/my.cnf\n[mysqld]\ndatadir=/data/mysql\nskip_name_resolve=1\nsocket=/data/mysql/mysql.sock\nlog-error=/data/mysql/mysql.log\npid-file=/data/mysql/mysql.pid\n[client]\nsocket=/data/mysql/mysql.sock\n</code></pre>\n<ul>\n<li>初始化数据库文件并提取 root 密码</li>\n</ul>\n<pre><code class=\"language-TEXT\">mkdir -pv /data/mysql\ngrep password /data/mysql/mysql.log\n</code></pre>\n<p>生成随机密码</p>\n<pre><code class=\"language-TEXT\">mysqld --initialize --user=mysql --datadir=/data/mysql\n</code></pre>\n<p>生成空密码</p>\n<pre><code class=\"language-TEXT\">mysqld --initialize-insecure --user=mysql --datadir=/data/mysql\n</code></pre>\n<ul>\n<li>准备服务脚本和启动</li>\n</ul>\n<pre><code class=\"language-TEXT\">[root@rocky local]# cp /usr/local/mysql/support-files/mysql.server  /etc/init.d/mysqld\n\nchkconfig --add mysqld\n# 启动服务\nservice mysqld start\n</code></pre>\n<ul>\n<li>修改口令</li>\n</ul>\n<pre><code class=\"language-TEXT\"># 修改随机密码为指定密码\nmysqladmin -uroot -p'9ATjCOB(jIef' password 123456\n\n#修改前面生成的空密码为指定密码\nmysqladmin -uroot password 123456\n</code></pre>\n<ul>\n<li>测试登录</li>\n</ul>\n<pre><code class=\"language-TEXT\">mysql -uroot -p'123456'\n</code></pre>\n<p>注意：登录 mysql 报如下信息</p>\n<pre><code class=\"language-TEXT\">mysql: error while loading shared libraries: libtinfo.so.5: cannot open shared object file: No such file or directory\n</code></pre>\n<p>解决方法：</p>\n<pre><code class=\"language-TEXT\">ln -s /usr/lib64/libtinfo.so.6.1 /usr/lib64/libtinfo.so.5\n</code></pre>\n<p>登录成功：</p>\n<p><img data-src=\"../image.assets/1664459241867.png\" alt=\"1664459241867\" /></p>\n<h3 id=\"源码编译安装\"><a class=\"anchor\" href=\"#源码编译安装\">#</a> 源码编译安装</h3>\n<h1 id=\"mysql多实例\"><a class=\"anchor\" href=\"#mysql多实例\">#</a> MySQL 多实例</h1>\n<h1 id=\"sql语言\"><a class=\"anchor\" href=\"#sql语言\">#</a> SQL 语言</h1>\n<h2 id=\"sql语言的兴起与语法标准\"><a class=\"anchor\" href=\"#sql语言的兴起与语法标准\">#</a> SQL 语言的兴起与语法标准</h2>\n<h3 id=\"sql语句分类\"><a class=\"anchor\" href=\"#sql语句分类\">#</a> SQL 语句分类</h3>\n<ul>\n<li>DDL: Data Defination Language 数据定义语言<br />\n CREATE，DROP，ALTER</li>\n<li>DML: Data Manipulation Language 数据操纵语言<br />\n INSERT，DELETE，UPDATE<br />\n 软件开发：CRUD</li>\n<li>DQL：Data Query Language 数据查询语言<br />\n SELECT</li>\n<li>DCL：Data Control Language 数据控制语言<br />\n GRANT，REVOKE</li>\n<li>TCL：Transaction Control Language 事务控制语言<br />\n COMMIT，ROLLBACK，SAVEPOINT</li>\n</ul>\n<h3 id=\"字符集和排序\"><a class=\"anchor\" href=\"#字符集和排序\">#</a> 字符集和排序</h3>\n<ul>\n<li>查看所有支持的字符集</li>\n</ul>\n<pre><code>show character set;\nshow charset;\n</code></pre>\n<ul>\n<li>查看支持的所有排序</li>\n</ul>\n<pre><code>show collation;\n#注意\nutf8_general_ci不区分大小写\nutf8_bin 区分大小写\n</code></pre>\n<ul>\n<li>查看当前使用的排序规则</li>\n</ul>\n<pre><code>mysql&gt; show variables like 'collation%';\n+----------------------+-------------------+\n| Variable_name        | Value             |\n+----------------------+-------------------+\n| collation_connection | utf8_general_ci   |\n| collation_database   | latin1_swedish_ci |\n| collation_server     | latin1_swedish_ci |\n+----------------------+-------------------+\n3 rows in set (0.01 sec)\n</code></pre>\n<ul>\n<li>设置服务器端默认字符集</li>\n</ul>\n<pre><code>vim /etc/my.cnf\n#针对mysql客户端\n[mysql]\ndefault-character-set=utf8mb4\n#针对所有MySQL客户端\n[client]\ndefault-character-set=utf8mb4\n</code></pre>\n<ul>\n<li>查看当前字符集的使用情况</li>\n</ul>\n<pre><code>mysql&gt; show variables like 'character%';\n+--------------------------+----------------------------------------------------------------+\n| Variable_name            | Value                                                          |\n+--------------------------+----------------------------------------------------------------+\n| character_set_client     | utf8mb4                                                        |\n| character_set_connection | utf8mb4                                                        |\n| character_set_database   | latin1                                                         |\n| character_set_filesystem | binary                                                         |\n| character_set_results    | utf8mb4                                                        |\n| character_set_server     | latin1                                                         |\n| character_set_system     | utf8                                                           |\n| character_sets_dir       | /usr/local/mysql-5.7.39-linux-glibc2.12-x86_64/share/charsets/ |\n+--------------------------+----------------------------------------------------------------+\n8 rows in set (0.00 sec)\n\nmysql&gt; \n</code></pre>\n<p><strong>面试题: VARCHAR (50) 能存放几个 UTF8 编码的汉字？</strong></p>\n<pre><code>存放的汉字个数与版本相关。\nmysql 4.0以下版本，varchar(50) 指的是 50 字节，如果存放 UTF8 格式编码的汉字时（每个汉字3字\n节），只能存放16 个。\nmysql 5.0以上版本，varchar(50) 指的是 50 字符，无论存放的是数字、字母还是 UTF8 编码的汉字，\n都可以存放 50 个。\n</code></pre>\n<p>#　ＭySQL 用户管理</p>\n<ul>\n<li>相关数据库和表</li>\n</ul>\n<pre><code>元数据数据库：mysql\n系统授权表：db, host, user,columns_priv, tables_priv, procs_priv, proxies_priv\n</code></pre>\n<ul>\n<li>用户账号</li>\n</ul>\n<pre><code>'USERNAME'@'HOST'\n@'HOST': 主机名： user1@'web1.magedu.org'\nIP地址或Network\n通配符： % _\n示例：wang@'172.16.%.%'\nuser2@'192.168.1.%'\nmage@'10.0.0.0/255.255.0.0'\n</code></pre>\n<ul>\n<li>创建用户：create user</li>\n</ul>\n<pre><code>CREATE USER 'USERNAME'@'HOST' [IDENTIFIED BY 'password']；\n#示例:\ncreate user test@'10.0.0.0/255.255.255.0' identified by '123456';\ncreate user test2@'10.0.0.%' identified by 123456\n</code></pre>\n<p>新建用户的默认权限：USAGE</p>\n<ul>\n<li>用户重命名：RENAME USER</li>\n</ul>\n<pre><code>RENAME USER old_user_name TO new_user_name;\n</code></pre>\n<ul>\n<li>删除用户</li>\n</ul>\n<pre><code>DROP USER 'USERNAME'@'HOST'\n</code></pre>\n<p><strong>删除空用户</strong></p>\n<pre><code>DROP USER ''@'localhost';\n</code></pre>\n<p><strong>修改密码</strong></p>\n<ul>\n<li>注意</li>\n</ul>\n<p>新版 mysql 中用户密码可以保存在 mysql.user 表的 authentication_string 字段中<br />\n如果 mysql.user 表的 authentication_string 和 password 字段都保存密码，authentication_string<br />\n 优先生效</p>\n<pre><code>#方法1,用户可以也可通过此方式修改自已的密码\nSET PASSWORD FOR 'user'@'host' = PASSWORD('password'); #MySQL8.0 版本不支持此方法,\n因为password函数被取消\nset password for root@'localhost'='123456' ; #MySQL8.0版本支持此方法,此方式直接将密码\n123456加密后存放在mysql.user表的authentication_string字段\n#方法2\nALTER USER test@'%' IDENTIFIED BY 'centos'; #通用改密码方法, 用户可以也可通过此方式修\n改自已的密码,MySQL8 版本修改密码\n#方法3 此方式MySQL8.0不支持,因为password函数被取消\nUPDATE mysql.user SET password=PASSWORD('password') WHERE clause;\n#mariadb 10.3\nupdate mysql.user set authentication_string=password('ubuntu') where\nuser='mage';\n#此方法需要执行下面指令才能生效：\nFLUSH PRIVILEGES;\n</code></pre>\n<p><strong>忘记管理员密码解决方法</strong></p>\n<ol>\n<li>启动 mysqld 进程时，为其使用如下选项：</li>\n</ol>\n<pre><code>--skip-grant-tables\n--skip-networking\n</code></pre>\n<ol start=\"2\">\n<li>使用 UPDATE 命令修改管理员密码</li>\n<li>关闭 mysqld 进程，移除上述两个选项，重启 mysqld</li>\n</ol>\n<p>范例：Mariadb 和 MySQL5.6 版之前破解 root 密码</p>\n<pre><code>[root@centos8 ~]#vim /etc/my.cnf\n[mysqld]\nskip-grant-tables\nskip-networking\n[root@centos8 ~]#systemctl restart mysqld|mariadb\n[root@centos8 ~]#mysql\n#方法1\n#mariadb 旧版和MySQL5.6版之前\nMariaDB [(none)]&gt; update mysql.user set password=password('ubuntu') where\nuser='root';\n#mariadb 新版\nMariaDB [(none)]&gt; update mysql.user set authentication_string=password('ubuntu')\nwhere user='root';\n#方法2\nMariaDB [(none)]&gt; flush privileges;\nMariaDB [(none)]&gt; alter user root@'localhost' identified by 'ubuntu';\n[root@centos8 ~]#vim /etc/my.cnf\n[mysqld]\n#skip-grant-tables\n#skip-networking\n\n[root@centos8 ~]#systemctl restart mysqld|mariadb\n[root@centos8 ~]#mysql -uroot -pubuntu\n</code></pre>\n<p>范例: MySQL5.7 和 8.0 破解 root 密码</p>\n<pre><code>[root@centos8 ~]#vim /etc/my.cnf\n[mysqld]\nskip-grant-tables\nskip-networking #MySQL8.0不需要\n[root@centos8 ~]#systemctl restart mysqld\n#方法1\nmysql&gt; update mysql.user set authentication_string='' where user='root' and\nhost='localhost';\n#方法2\nmysql&gt; flush privileges;\n#再执行下面任意一个命令\nmysql&gt; alter user root@'localhost' identified by 'ubuntu';\nmysql&gt; set password for root@'localhost'='ubuntu';\n[root@centos8 ~]#vim /etc/my.cnf\n[mysqld]\n#skip-grant-tables\n#skip-networking\n[root@centos8 ~]#systemctl restart mysqld\n[root@centos8 ~]#mysql -uroot -pubuntu\n</code></pre>\n<p>范例：删库跑路之清空 root 密码方法</p>\n<pre><code>#此方法适用于包安装方式的MySQL或Mariadb\n[root@centos8 ~]#systemctl stop mysqld\n[root@centos8 ~]#rm -rf /var/lib/mysql/*\n[root@centos8 ~]#systemctl start mysqld\n</code></pre>\n<h1 id=\"权限管理\"><a class=\"anchor\" href=\"#权限管理\">#</a> 权限管理</h1>\n<p><strong>权限类别：</strong></p>\n<ul>\n<li>\n<p>管理类</p>\n</li>\n<li>\n<p>程序类</p>\n</li>\n<li>\n<p>数据库级别</p>\n</li>\n<li>\n<p>表级别</p>\n</li>\n<li>\n<p>字段级别</p>\n</li>\n</ul>\n<p><strong>管理类：</strong></p>\n<ul>\n<li>CREATE USER</li>\n<li>FILE</li>\n<li>SUPER</li>\n<li>SHOW DATABASES</li>\n<li>RELOAD</li>\n<li>SHUTDOWN</li>\n<li>REPLICATION SLAVE</li>\n<li>REPLICATION CLIENT</li>\n<li>LOCK TABLES</li>\n<li>PROCESS</li>\n<li>CREATE TEMPORARY TABLES</li>\n</ul>\n<p><strong>程序类：针对 FUNCTION、PROCEDURE、TRIGGER</strong></p>\n<ul>\n<li>CREATE</li>\n<li>ALTER</li>\n<li>DROP</li>\n<li>EXCUTE<br />\n<strong> 库和表级别：针对 DATABASE、TABLE</strong></li>\n<li>ALTER</li>\n<li>CREATE</li>\n<li>CREATE VIEW</li>\n<li>DROP INDEX</li>\n<li>SHOW VIEW</li>\n<li>WITH GRANT OPTION：能将自己获得的权限转赠给其他用户<br />\n<strong>数据操作</strong></li>\n<li>SELECT<br />\n-INSERT</li>\n<li>DELETE</li>\n<li>UPDATE<br />\n<strong> 字段级别</strong></li>\n<li>SELECT(col1,col2,...)</li>\n<li>UPDATE(col1,col2,...)</li>\n<li>INSERT(col1,col2,...)<br />\n<strong> 所有权限</strong></li>\n<li>ALL PRIVILEGES 或 ALL</li>\n</ul>\n<p><strong>授权</strong></p>\n<ul>\n<li>授权：GRANT</li>\n</ul>\n<pre><code>GRANT SELECT (col1), INSERT (col1,col2) ON mydb.mytbl TO 'someuser'@'somehost';\nGRANT ALL ON wordpress.* TO wordpress@'10.0.0.%' ;\nGRANT ALL PRIVILEGES ON *.* TO 'root'@'10.0.0.%' WITH GRANT OPTION;\n#创建用户和授权同时执行的方式在MySQL8.0取消了\nGRANT ALL ON wordpress.* TO wordpress@'192.168.8.%' IDENTIFIED BY 'magedu';\nGRANT ALL PRIVILEGES ON *.* TO 'root'@'192.168.8.%' IDENTIFIED BY 'magedu'\nWITH GRANT OPTION;\n</code></pre>\n<p><strong>取消授权</strong></p>\n<ul>\n<li>取消授权：REVOKE</li>\n</ul>\n<pre><code>REVOKE DELETE ON *.* FROM 'testuser'@'172.16.0.%';\n</code></pre>\n<p><strong>查看指定用户获得的授权</strong></p>\n<pre><code>Help SHOW GRANTS\nSHOW GRANTS FOR 'user'@'host';\nSHOW GRANTS FOR CURRENT_USER[()];\n</code></pre>\n<p><strong>注意：</strong><br />\nMariaDB 服务进程启动时会读取 mysql 库中所有授权表至内存<br />\n (1) GRANT 或 REVOKE 等执行权限操作会保存于系统表中，MariaDB 的服务进程通常会自动重读授权表，<br />\n使之生效<br />\n (2) 对于不能够或不能及时重读授权表的命令，可手动让 MariaDB 的服务进程重读授权表：<br />\nmysql&gt; FLUSH PRIVILEGES;</p>\n<h1 id=\"myisam-存储引擎\"><a class=\"anchor\" href=\"#myisam-存储引擎\">#</a> MyISAM 存储引擎</h1>\n<h2 id=\"myisam-引擎特点\"><a class=\"anchor\" href=\"#myisam-引擎特点\">#</a> MyISAM 引擎特点</h2>\n<ul>\n<li>不支持事务</li>\n<li>表级锁定</li>\n<li>读写相互阻塞，写入不能读，读时不能写</li>\n<li>只缓存索引</li>\n<li>不支持外键约束</li>\n<li>不支持聚簇索引</li>\n<li>读取数据较快，占用资源较少</li>\n<li>不支持 MVCC（多版本并发控制机制）高并发</li>\n<li>崩溃恢复性较差</li>\n<li>MySQL5.5.5 前默认的数据库引擎</li>\n</ul>\n<h2 id=\"myisam-存储引擎适用场景\"><a class=\"anchor\" href=\"#myisam-存储引擎适用场景\">#</a> MyISAM 存储引擎适用场景</h2>\n<ul>\n<li>只读（或者写较少）</li>\n<li>表较小（可以接受长时间进行修复操作）</li>\n</ul>\n<h2 id=\"myisam-引擎文件\"><a class=\"anchor\" href=\"#myisam-引擎文件\">#</a> MyISAM 引擎文件</h2>\n<ul>\n<li>tbl_name.frm 表格式定义</li>\n<li>tbl_name.MYD 数据文件</li>\n<li>tbl_name.MYI 索引文件</li>\n</ul>\n<h1 id=\"innodb-引擎\"><a class=\"anchor\" href=\"#innodb-引擎\">#</a> InnoDB 引擎</h1>\n<h2 id=\"innodb引擎特点\"><a class=\"anchor\" href=\"#innodb引擎特点\">#</a> InnoDB 引擎特点</h2>\n<ul>\n<li>行级锁</li>\n<li>支持事务，适合处理大量短期事务</li>\n<li>读写阻塞与事务隔离级别相关</li>\n<li>可缓存数据和索引</li>\n<li>支持聚簇索引</li>\n<li>崩溃恢复性更好</li>\n<li>支持 MVCC 高并发</li>\n<li>从 MySQL5.5 后支持全文索引</li>\n<li>从 MySQL5.5.5 开始为默认的数据库引擎</li>\n</ul>\n<h1 id=\"管理存储引擎\"><a class=\"anchor\" href=\"#管理存储引擎\">#</a> 管理存储引擎</h1>\n<p>查看 mysql 支持的存储引擎</p>\n<pre><code>show engines;\n</code></pre>\n<p>查看当前默认的存储引擎</p>\n<pre><code>show variables like '%storage_engine%';\n</code></pre>\n<p>设置默认的存储引擎</p>\n<pre><code>vim /etc/my.cnf\n[mysqld]\ndefault_storage_engine= InnoDB\n</code></pre>\n<p>查看库中所有表使用的存储引擎</p>\n<pre><code>show table status from db_name;\n</code></pre>\n<p>查看库中指定表的存储引擎</p>\n<pre><code>show table status like 'tb_name';\nshow create table tb_name;\n</code></pre>\n<p>设置表的存储引擎：</p>\n<pre><code>CREATE TABLE tb_name(... ) ENGINE=InnoDB;\nALTER TABLE tb_name ENGINE=InnoDB;\n</code></pre>\n<h1 id=\"实战案例数据库冷备份和热备份\"><a class=\"anchor\" href=\"#实战案例数据库冷备份和热备份\">#</a> 实战案例：数据库冷备份和热备份</h1>\n<p>MySQL8.0</p>\n<p>冷备份：</p>\n<pre><code>备份过程\n# 停止数据库\nsystemctl stop mysql\n# rsync可以保留文件属性\n[root@centos8 ~]#rsync -a /var/lib/mysql 10.0.0.28:/data/\n#如果配置及二进制文件相关有特殊设置也需要备份\n#还原\n[root@centos8 ~]#yum -y install mysql-server\n[root@centos8 ~]#cp -a /data/mysql/* /var/lib/mysql/\n[root@centos8 ~]#systemctl start mysqld\n</code></pre>\n<h1 id=\"mysqldump备份工具\"><a class=\"anchor\" href=\"#mysqldump备份工具\">#</a> mysqldump 备份工具</h1>\n<p>mysqldump 说明<br />\n逻辑备份工具：<br />\nmysqldump, mydumper, phpMyAdmin<br />\nSchema 和数据存储在一起、巨大的 SQL 语句、单个巨大的备份文件<br />\n mysqldump 是 MySQL 的客户端命令，通过 mysql 协议连接至 mysql 服务器进行备份<br />\n命令格式:</p>\n<pre><code>mysqldump [OPTIONS] database [tables] #支持指定数据库和指定多表的备份，但数据库本身定义\n不备份\nmysqldump [OPTIONS] -B DB1 [DB2 DB3...] #支持指定数据库备份，包含数据库本身定义也会备份\nmysqldump [OPTIONS] -A [OPTIONS] #备份所有数据库，包含数据库本身定义也会备份\n</code></pre>\n<p>mysqldump 参考：</p>\n<pre><code>https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html\n</code></pre>\n<p>mysqldump 常见通用选项：</p>\n<pre><code>-u, --user=name User for login if not current user\n-p, --password[=name] Password to use when connecting to server\n-A, --all-databases #备份所有数据库，含create database\n-B, --databases db_name… #指定备份的数据库，包括create database语句\n-E, --events：#备份相关的所有event scheduler\n-R, --routines：#备份所有存储过程和自定义函数\n--triggers：#备份表相关触发器，默认启用,用--skip-triggers，不备份触发器\n--default-character-set=utf8 #指定字符集\n--master-data[=#]：#注意：MySQL8.0.26版以后，此选项变为--source-data\n#此选项须启用二进制日志\n#1：所备份的数据之前加一条记录为CHANGE MASTER TO语句，非注释，不指定#，默认为1，适合于主从复\n制多机使用\n#2：记录为被注释的#CHANGE MASTER TO语句，适合于单机使用,适用于备份还原\n#此选项会自动关闭--lock-tables功能，自动打开-x | --lock-all-tables功能（除非开启--\nsingle-transaction）\n-F, --flush-logs #备份前滚动日志，锁定表完成后，执行flush logs命令,生成新的二进制日志文件，\n配合-A 或 -B 选项时，会导致刷新多次数据库。建议在同一时刻执行转储和日志刷新，可通过和--single-\ntransaction或-x，--master-data 一起使用实现，此时只刷新一次二进制日志\n--compact #去掉注释，适合调试，节约备份占用的空间,生产不使用\n-d, --no-data #只备份表结构,不备份数据,即只备份create table\n-t, --no-create-info #只备份数据,不备份表结构,即不备份create table\n-n,--no-create-db #不备份create database，可被-A或-B覆盖\n--flush-privileges #备份mysql或相关时需要使用\n-f, --force #忽略SQL错误，继续执行\n--hex-blob #使用十六进制符号转储二进制列，当有包括BINARY,VARBINARY,BLOB，\nBIT的数据类型的列时使用，避免乱码\n-q, --quick #不缓存查询，直接输出，加快备份速度\n</code></pre>\n<p>mysqldump 的 MyISAM 存储引擎相关的备份选项：<br />\nMyISAM 不支持事务，只能支持温备；不支持热备，所以必须先锁定要备份的库，而后启动备份操作</p>\n<pre><code>-x,--lock-all-tables #加全局读锁，锁定所有库的所有表，同时加--single-transaction或--\nlock-tables选项会关闭此选项功能，注意：数据量大时，可能会导致长时间无法并发访问数据库\n-l,--lock-tables #对于需要备份的每个数据库，在启动备份之前分别锁定其所有表，默认为on,--\nskip-lock-tables选项可禁用,对备份MyISAM的多个库,可能会造成数据不一致\n#注：以上选项对InnoDB表一样生效，实现温备，但不推荐使用\n</code></pre>\n<p>mysqldump 的 InnoDB 存储引擎相关的备份选项：<br />\nInnoDB 存储引擎支持事务，可以利用事务的相应的隔离级别，实现热备，也可以实现温备但不建议用</p>\n<pre><code>--single-transaction\n#此选项Innodb中推荐使用，不适用MyISAM，此选项会开始备份前，先执行START TRANSACTION指令开启\n事务\n#此选项通过在单个事务中转储所有表来创建一致的快照。 仅适用于存储在支持多版本控制的存储引擎中的表\n（目前只有InnoDB可以）; 转储不保证与其他存储引擎保持一致。 在进行单事务转储时，要确保有效的转储\n文件（正确的表内容和二进制日志位置），没有其他连接应该使用以下语句：ALTER TABLE，DROP TABLE，\nRENAME TABLE，TRUNCATE TABLE,此选项和--lock-tables（此选项隐含提交挂起的事务）选项是相互\n排斥,备份大型表时，建议将--single-transaction选项和--quick结合一起使用\n</code></pre>\n<h1 id=\"生产环境实战备份策略\"><a class=\"anchor\" href=\"#生产环境实战备份策略\">#</a> 生产环境实战备份策略</h1>\n<p>InnoDB 建议备份策略</p>\n<pre><code>mysqldump -uroot -p -A -F -E -R --triggers --single-transaction --master-data=1\n--flush-privileges --default-character-set=utf8 --hex-blob\n&gt;$&#123;BACKUP&#125;/fullbak_$&#123;BACKUP_TIME&#125;.sql\n</code></pre>\n<p>MyISAM 建议备份策略</p>\n<pre><code>mysqldump -uroot -p -A -F -E -R -x --master-data=1 --flush-privileges --\ntriggers --default-character-set=utf8 --hex-blob\n&gt;$&#123;BACKUP&#125;/fullbak_$&#123;BACKUP_TIME&#125;.sql\n</code></pre>\n<h1 id=\"mysqldump-备份还原实战案例\"><a class=\"anchor\" href=\"#mysqldump-备份还原实战案例\">#</a> mysqldump 备份还原实战案例</h1>\n<h2 id=\"实战案例特定数据库的备份脚本\"><a class=\"anchor\" href=\"#实战案例特定数据库的备份脚本\">#</a> 实战案例：特定数据库的备份脚本</h2>\n<p>系统：centos8.5</p>\n<p>mysql:8.0</p>\n<pre><code>#!/bin/bash\nTIME=`date +%F_%H-%M-%S`\n# 备份目录\nDIR=/mysql_backup\n# 备份数据库\nDB=hellodb\n# 数据库密码\nPASSWD=123456\n\n# 判断备份数据库目录是否存在\n\n[ -d $DIR ] || mkdir $DIR\n\n# 备份\nmysqldump -uroot -p&quot;$PASSWD&quot; -F -E -R --triggers --single-transaction --master-data=2 --default-character-set=utf8mb4 -q -B $DB | gzip &gt; $&#123;DIR&#125;/$&#123;DB&#125;_$&#123;TIME&#125;.sql.gz\n</code></pre>\n<h1 id=\"实战案例分库备份的实战脚本\"><a class=\"anchor\" href=\"#实战案例分库备份的实战脚本\">#</a> 实战案例：分库备份的实战脚本</h1>\n<ul>\n<li>系统：centos8.5</li>\n<li>MySQL 版本：8.0</li>\n</ul>\n<pre><code>#!/bin/bash\nTIME=`date +%F_%H-%M-%S`\nDIR=/backup\nPASS=123456\n[ -d &quot;$DIR&quot; ] || mkdir $DIR\nfor DB in `mysql -uroot -p&quot;$PASS&quot; -e 'show databases' | grep -Ev &quot;^Database|.*schema$&quot;`;do\n    mysqldump -uroot -p&quot;$PASS&quot; -F --single-transaction --master-data=2 --default-character-set=utf8mb4 -q -B $DB | gzip &gt; $&#123;DIR&#125;/$&#123;DB&#125;_$&#123;TIME&#125;.sql.gz\ndone\n</code></pre>\n<h1 id=\"实战案例完全备份和还原\"><a class=\"anchor\" href=\"#实战案例完全备份和还原\">#</a> 实战案例：完全备份和还原</h1>\n<pre><code>#开启二进制日志\n[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf\n[mysqld]\nlog-bin\n#备份\n[root@centos8 ~]#mysqldump -uroot -pmagedu -A -F --single-transaction --master-\ndata=2 |gzip &gt; /backup/all-`date +%F`.sql.gz\n#还原\n[root@centos8 backup]#dnf install mariadb-server\n[root@centos8 backup]#gzip -d all-2019-11-27.sql.gz\n[root@centos8 ~]#mysql\nMariaDB [(none)]&gt; set sql_log_bin=off;\nMariaDB [(none)]&gt; source /backup/all-2019-11-27.sql\nMariaDB [(none)]&gt; set sql_log_bin=on;\n</code></pre>\n<h1 id=\"实战案例恢复误删除的表\"><a class=\"anchor\" href=\"#实战案例恢复误删除的表\">#</a> 实战案例：恢复误删除的表</h1>\n<p>案例说明：每天 2：30 做完全备份，早上 10：00 误删除了表 students，10：10 才发现故障，现需要将数<br />\n据库还原到 10：10 的状态，且恢复被删除的 students 表</p>\n<pre><code>#查看数据库是否开启二进制\nmysql&gt; select @@log_bin;\n+-----------+\n| @@log_bin |\n+-----------+\n|         1 |\n+-----------+\n1 row in set (0.01 sec)\n\nmysql&gt; select @@sql_log_bin;\n+---------------+\n| @@sql_log_bin |\n+---------------+\n|             1 |\n+---------------+\n1 row in set (0.01 sec)\n\nmysql&gt; \n\n# log_bin、sql_log_bin的值为1说明已经开启二进制日志\n\n# 查看当前二进制文件在什么位置\nmysql&gt; show master logs;\n+------------------+-----------+-----------+\n| Log_name         | File_size | Encrypted |\n+------------------+-----------+-----------+\n| mysql-bin.000001 |       204 | No        |\n| mysql-bin.000002 |       157 | No        |\n+------------------+-----------+-----------+\n2 rows in set (0.01 sec)\n\nmysql&gt; \n# 备份的时候开启刷新二进制日志，会生成新的二进制的日志\n\n#完全备份\n[root@centos7 ~]# mysqldump -uroot -p123456 -A -F --single-transaction --master-data=2 | gzip &gt; /backup/all_`date +%F`.sql.gz\n\n# 完全备份后进行数据更新\nmysql&gt; insert students (name,age,gender) values('jack',22,'M');\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; insert students (name,age,gender) values('rose',20,'f');\nQuery OK, 1 row affected (0.01 sec)\n\n# 误删除学生表\nmysql&gt; drop table students;\nQuery OK, 0 rows affected (0.07 sec)\n\nmysql&gt; \n\n# 后续其他表继续更新\nmysql&gt; insert teachers (name,age,gender)values('wang',30,'M');\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; \n\nmysql&gt; insert teachers (name,age,gender)values('mage',28,'M');\nQuery OK, 1 row affected (0.05 sec)\n\nmysql&gt; \n\n# 停止数据库访问\n\n# 备份从完全备份后的二进制日志\n[root@centos7 ~]# mysqlbinlog --start-position=157 /data/mysql/mysql-bin.000003 &gt; /backup/inc.sql\n\n# 找到误删除的语句，从备份中删除此语句\n#DROP TABLE `students` /* generated by server */\n#利用完全备份和修改过的二进制日志进行还原\n[root@centos8 ~]#mysql -uroot -p\nmysql&gt; set sql_log_bin=0;\nmysql&gt; source /backup/allbackup_2019-11-27_10:20:08.sql;\nmysql&gt; source /backup/inc.sql\nmysql&gt; set sql_log_bin=1;\n</code></pre>\n",
            "tags": [
                "MySQL",
                "MySQL基础"
            ]
        },
        {
            "id": "http://blog.itshare.work/Linux/DNS/",
            "url": "http://blog.itshare.work/Linux/DNS/",
            "title": "DNS服务",
            "date_published": "2022-09-22T14:01:44.000Z",
            "content_html": "<p>DNS 一般指域名系统。 域名系统（英文：Domain Name System，缩写：DNS）是互联网的一项服务。它作为将域名和 IP 地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。DNS 使用 UDP 端口 53<br />\n<span id=\"more\"></span></p>\n<h1 id=\"名字解析介绍和dns\"><a class=\"anchor\" href=\"#名字解析介绍和dns\">#</a> 名字解析介绍和 DNS</h1>\n<h2 id=\"dns服务工作原理\"><a class=\"anchor\" href=\"#dns服务工作原理\">#</a> DNS 服务工作原理</h2>\n<p><img data-src=\"../image.assets/1664088991760.png\" alt=\"1664088991760\" /></p>\n<h2 id=\"dns查询类型\"><a class=\"anchor\" href=\"#dns查询类型\">#</a> DNS 查询类型</h2>\n<p><img data-src=\"../image.assets/1664089216470.png\" alt=\"1664089216470\" /></p>\n<ul>\n<li>递归查询：<br />\n是指 DNS 服务器在收到用户发起的请求时，必须向用户返回一个准确的查询结果。如果 DNS 服务器<br />\n本地没有存储与之对应的信息，则该服务器需要询问其他服务器，并将返回的查询结构提交给用<br />\n户。<br />\n一般客户机和本地 DNS 服务器之间属于递归查询，即当客户机向 DNS 服务器发出请求后，若 DNS 服<br />\n务器本身不能解析，则会向另外的 DNS 服务器发出查询请求，得到最终的肯定或否定的结果后转交<br />\n给客户机。此查询的源和目标保持不变，为了查询结果只需要发起一次查询<br />\n递归算法：客户端向 LocalDNS 发起域名查询 --&gt;localDNS 不知道域名对应的 IP--&gt; 但它知道谁知道 -&gt; 他<br />\n代为帮客户端去查找 --&gt; 最后再返回最终结果</li>\n<li>迭代查询：<br />\n是指 DNS 服务器在收到用户发起的请求时，并不直接回复查询结果，而是告诉另一台 DNS 服务器的<br />\n地址，用户再向这台 DNS 服务器提交请求，这样依次反复，直到返回查询结果。<br />\n一般情况下 (有例外) 本地的 DNS 服务器向其它 DNS 服务器的查询属于迭代查询，如：若对方不能返回<br />\n权威的结果，则它会向下一个 DNS 服务器 (参考前一个 DNS 服务器返回的结果) 再次发起进行查询，<br />\n直到返回查询的结果为止。此查询的源不变，但查询的目标不断变化，为查询结果一般需要发起多次<br />\n查询</li>\n<li>迭代算法︰<br />\n客户端向 LocalDNS 发起域名查询 --&gt;localDNS 不知道域名对应的 IP--&gt; 但它知道谁知道并<br />\n推荐客户端应该找谁 --&gt; 客户端自己去找它</li>\n<li>DNS 缓存:<br />\nDNS 缓存是将解析数据存储在靠近发起请求的客户端的位置，也可以说 DNS 数据是可以缓存在任意<br />\n位置，最终目的是以此减少递归查询过程，可以更快的让用户获得请求结果。</li>\n</ul>\n<h2 id=\"解析类型\"><a class=\"anchor\" href=\"#解析类型\">#</a> 解析类型</h2>\n<ul>\n<li>FQDN --&gt; IP 正向解析</li>\n<li>IP --&gt; FQDN 反向解析<br />\n<strong>注意：正反向解析是两个不同的名称空间，是两棵不同的解析树</strong></li>\n</ul>\n<h2 id=\"完整查询流程\"><a class=\"anchor\" href=\"#完整查询流程\">#</a> 完整查询流程</h2>\n<pre><code class=\"language-TEXT\">Client --&gt;hosts文件 --&gt; Client DNS Service Local Cache --&gt; DNS Server (recursion递\n归) --&gt; DNS Server Cache --&gt;DNS iteration(迭代) --&gt; 根--&gt; 顶级域名DNS--&gt;二级域名DNS…\n</code></pre>\n<h1 id=\"dns服务相关概念和技术\"><a class=\"anchor\" href=\"#dns服务相关概念和技术\">#</a> DNS 服务相关概念和技术</h1>\n<h2 id=\"各种资源记录\"><a class=\"anchor\" href=\"#各种资源记录\">#</a> 各种资源记录</h2>\n<p>区域解析库：由众多资源记录 RR (Resource Record) 组成<br />\n记录类型：A, AAAA, PTR, SOA, NS, CNAME, MX</p>\n<ul>\n<li>SOA：Start Of Authority，起始授权记录；一个区域解析库有且仅能有一个 SOA 记录，必须位于解析库的第一条记录</li>\n<li>A：internet Address，作用，FQDN --&gt; IP</li>\n<li>AAAA：FQDN --&gt; IPv6</li>\n<li>PTR：PoinTeR，IP --&gt; FQDN</li>\n<li>NS：Name Server，专用于标明当前区域的 DNS 服务器</li>\n<li>CNAME ： Canonical Name，别名记录</li>\n<li>MX：Mail eXchanger，邮件交换器</li>\n<li>TXT：对域名进行标识和说明的一种方式，一般做验证记录时会使用此项，如：SPF（反垃圾邮<br />\n件）记录，https 验证等，如下示例：</li>\n</ul>\n<pre><code class=\"language-TEXT\">_dnsauth TXT 2012011200000051qgs69bwoh4h6nht4n1h0lr038x\n</code></pre>\n<h3 id=\"soa记录\"><a class=\"anchor\" href=\"#soa记录\">#</a> SOA 记录</h3>\n<p>name: 当前区域的名字，例如 &quot;<span class=\"exturl\" data-url=\"aHR0cDovL21hZ2VkdS5vcmc=\">magedu.org</span>.&quot;<br />\nvalue: 有多部分组成<br />\n注意：</p>\n<ol>\n<li>当前区域的主 DNS 服务器的 FQDN，也可以使用当前区域的名字，只是注释功能，可以不需要配置<br />\n对应的 NS 记录和 A 记录</li>\n<li>当前区域管理员的邮箱地址；但地址中不能使用 @符号，一般用。替换，例如：<span class=\"exturl\" data-url=\"aHR0cDovL2FkbWluLm1hZ2VkdS5vcmc=\">admin.magedu.org</span></li>\n<li>主从服务区域传输相关定义以及否定的答案的统一的 TTL</li>\n</ol>\n<p><strong>范例</strong></p>\n<pre><code class=\"language-TEXT\">magedu.org. 86400 IN SOA ns.magedu.org. nsadmin.magedu.org. (\n2015042201 ;序列号\n2H ;刷新时间\n10M ;重试时间\n1W ;过期时间\n1D ;否定答案的TTL值\n)\n</code></pre>\n<h3 id=\"ns记录\"><a class=\"anchor\" href=\"#ns记录\">#</a> NS 记录</h3>\n<p>name: 当前区域的名字<br />\n value: 当前区域的某 DNS 服务器的名字，例如: <span class=\"exturl\" data-url=\"aHR0cDovL25zLm1hZ2VkdS5vcmc=\">ns.magedu.org</span>.<br />\n 注意：</p>\n<ol>\n<li>相邻的两个资源记录的 name 相同时，后续的可省略</li>\n<li>对 NS 记录而言，任何一个 ns 记录后面的服务器名字，都应该在后续有一个 A 记录</li>\n<li>一个区域可以有多个 NS 记录<br />\n范例：</li>\n</ol>\n<pre><code class=\"language-TEXT\">magedu.org. IN NS ns1.magedu.org.\nmagedu.org. IN NS ns2.magedu.org.\n</code></pre>\n<h3 id=\"mx记录\"><a class=\"anchor\" href=\"#mx记录\">#</a> MX 记录</h3>\n<p>name: 当前区域的名字<br />\n value: 当前区域的某邮件服务器 (smtp 服务器) 的主机名<br />\n<strong>注意：</strong></p>\n<ol>\n<li>一个区域内，MX 记录可有多个；但每个记录的 value 之前应该有一个数字 (0-99)，表示此服务器的优先级；数字越小优先级越高</li>\n<li>对 MX 记录而言，任何一个 MX 记录后面的服务器名字，都应该在后续有一个 A 记录<br />\n范例：</li>\n</ol>\n<pre><code class=\"language-TEXT\">magedu.org. IN MX 10 mx1.magedu.org.\nIN MX 20 mx2.magedu.org.\nmx1 A 10.0.0.100\nmx2 A 10.0.0.200  \n</code></pre>\n<h3 id=\"a记录\"><a class=\"anchor\" href=\"#a记录\">#</a> A 记录</h3>\n<p>name: 某主机的 FQDN，例如：<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5tYWdlZHUub3Jn\">www.magedu.org</span>.<br />\nvalue: 主机名对应主机的 IP 地址<br />\n避免用户写错名称时给错误答案，可通过泛域名解析进行解析至某特定地址<br />\n范例：</p>\n<pre><code class=\"language-TEXT\">www.magedu.org. IN A 1.1.1.1\nwww.magedu.org. IN A 2.2.2.2\nmx1.magedu.org. IN A 3.3.3.3\nmx2.magedu.org. IN A 4.4.4.4\n$GENERATE 1-254 HOST$ IN A 1.2.3.$\n*.magedu.org. IN A 5.5.5.5\nmagedu.org. IN A 6.6.6.6\n#注意：如果有和DNS的IP相同的多个同名的A记录，优先返回DNS的本机IP  \n</code></pre>\n<h3 id=\"aaaa记录\"><a class=\"anchor\" href=\"#aaaa记录\">#</a> AAAA 记录</h3>\n<pre><code class=\"language-TEXT\">name: FQDN  \nvalue: IPv6  \n</code></pre>\n<h3 id=\"ptr记录\"><a class=\"anchor\" href=\"#ptr记录\">#</a> PTR 记录</h3>\n<pre><code class=\"language-TEXT\">name: IP，有特定格式，把IP地址反过来写，1.2.3.4，要写作4.3.2.1；而有特定后缀：in-\naddr.arpa.，所以完整写法为：4.3.2.1.in-addr.arpa.\nvalue: FQDN\n</code></pre>\n<p>注意：网络地址及后缀可省略；主机地址依然需要反着写<br />\n例如：</p>\n<pre><code class=\"language-TEXT\">4.3.2.1.in-addr.arpa. IN PTR www.magedu.org.\n#如1.2.3为网络地址，可简写成：\n4 IN PTR www.magedu.org.\n</code></pre>\n<h3 id=\"cname别名记录\"><a class=\"anchor\" href=\"#cname别名记录\">#</a> CNAME 别名记录</h3>\n<pre><code class=\"language-TEXT\">name: 别名的FQDN\nvalue: 真正名字的FQDN  \n</code></pre>\n<p><strong>例如</strong></p>\n<pre><code class=\"language-TEXT\">www.magedu.org. IN CNAME websrv.magedu.org.\n</code></pre>\n<h2 id=\"dns软件bind\"><a class=\"anchor\" href=\"#dns软件bind\">#</a> DNS 软件 bind</h2>\n<p>DNS 服务器软件：bind，powerdns，dnsmasq，unbound，coredns</p>\n<h3 id=\"bind相关程序包\"><a class=\"anchor\" href=\"#bind相关程序包\">#</a> bind 相关程序包</h3>\n<p>yum list all bind*</p>\n<p>bind：服务器<br />\n bind-utils: 客户端<br />\n bind-libs：相关库，依赖关系自动安装<br />\n bind-chroot: 安全包，将 dns 相关文件放至 /var/named/chroot/</p>\n<p><strong>范例：安装 bind 软件</strong></p>\n<pre><code class=\"language-TEXT\">[root@centos8 ~]#dnf -y install bind bind-utils\n[root@ubuntu2004 ~]#apt -y install bind9 bind9-utils\n</code></pre>\n<h3 id=\"bind包相关文件\"><a class=\"anchor\" href=\"#bind包相关文件\">#</a> bind 包相关文件</h3>\n<p>BIND 主程序：/usr/sbin/named<br />\n 服务脚本和 Unit 名称：/etc/rc.d/init.d/named，/usr/lib/systemd/system/named.service<br />\n 主配置文件：/etc/named.conf, /etc/named.rfc1912.zones, /etc/rndc.key<br />\n 管理工具：/usr/sbin/rndc：remote name domain controller，默认与 bind 安装在同一主机，且<br />\n只能通过 127.0.0.1 连接 named 进程，提供辅助性的管理功能；953/tcp<br />\n 解析库文件：/var/named/ZONE_NAME.ZONE<br />\n 注意：<br />\n(1) 一台物理服务器可同时为多个区域提供解析<br />\n (2) 必须要有根区域文件；<span class=\"exturl\" data-url=\"aHR0cDovL25hbWVkLmNh\">named.ca</span><br />\n (3) 应该有两个（如果包括 ipv6 的，应该更多）实现 localhost 和本地回环地址的解析库</p>\n<h3 id=\"主配置文件\"><a class=\"anchor\" href=\"#主配置文件\">#</a> 主配置文件</h3>\n<ul>\n<li>全局配置：options {};</li>\n<li>日志子系统配置：logging {};</li>\n<li>区域定义：本机能够为哪些 zone 进行解析，就要定义哪些 zone<br />\nzone &quot;ZONE_NAME&quot; IN {};<br />\n<strong> 注意：</strong></li>\n<li>任何服务程序如果期望其能够通过网络被其它主机访问，至少应该监听在一个能与外部主机通信的<br />\n IP 地址上</li>\n<li>缓存名称服务器的配置：监听外部地址即可</li>\n<li>dnssec: 建议关闭 dnssec，设为 no</li>\n</ul>\n",
            "tags": [
                "Linux",
                "Linux从入门到放弃"
            ]
        },
        {
            "id": "http://blog.itshare.work/Linux/Disk/",
            "url": "http://blog.itshare.work/Linux/Disk/",
            "title": "磁盘存储和文件系统管理",
            "date_published": "2022-08-07T00:40:59.000Z",
            "content_html": "<h1 id=\"磁盘管理与文件系统\"><a class=\"anchor\" href=\"#磁盘管理与文件系统\">#</a> 磁盘管理与文件系统</h1>\n<p><strong>前言</strong><br />\n磁盘是计算机主要的存储介质，可以存储大量的二进制数据，并且断电后也能保持数据不丢失，使用磁盘存储数据的时候我们可以将磁盘划分成我们所需要的格式来进行使用</p>\n<h1 id=\"1-磁盘结构\"><a class=\"anchor\" href=\"#1-磁盘结构\">#</a> 1. 磁盘结构</h1>\n<p><strong>1、硬盘的物理结构</strong><br />\n盘片：硬盘有多个盘片，每个盘片有 2 面<br />\n磁头：每面有一个磁头</p>\n<p><strong>2. 硬盘数据结构</strong><br />\n扇区：磁盘上的每个磁道被等分为若干个弧段，这些弧段便是硬盘的扇区。硬盘的第一个扇区，叫做引导扇区 ，盘片被分为多个扇形区域，每个扇区存放 512 字节的数据，是硬盘最小的存储单元<br />\n磁道：当磁盘旋转时，磁头若保持在一个位置上，则每个磁头都会在磁盘表面划出一个圆形轨迹，这些圆形轨迹就叫做磁道<br />\n柱面：在有多个盘片构成的盘组中，由不同盘片的面，但处于同一半径圆的多个磁道组成的一个圆柱面</p>\n<p><strong>3、磁盘结构</strong><br />\n硬盘存储容量 = 磁头数 x 磁道（柱面）数 x 每道扇区数 x 每扇区字节数（512 字节）<br />\n可以用柱面 / 磁头 / 扇区来唯一定位磁盘上的每一个区域<br />\n磁盘的接口类型：IDE、SATA、SCSI、SAS、光纤通道<br />\n用 fdisk -l 查看分区信息</p>\n<h1 id=\"2-管理存储\"><a class=\"anchor\" href=\"#2-管理存储\">#</a> 2. 管理存储</h1>\n<h2 id=\"21-磁盘分区\"><a class=\"anchor\" href=\"#21-磁盘分区\">#</a> 2.1 磁盘分区</h2>\n<h3 id=\"211-为什么分区\"><a class=\"anchor\" href=\"#211-为什么分区\">#</a> 2.1.1 为什么分区</h3>\n<ul>\n<li>优化 I/O 性能</li>\n<li>实现磁盘空间配额限制</li>\n<li>提高修复速度</li>\n<li>隔离系统和程序</li>\n<li>安装多个 OS</li>\n<li>采用不同文件系统</li>\n</ul>\n<h3 id=\"212-分区方式\"><a class=\"anchor\" href=\"#212-分区方式\">#</a> 2.1.2 分区方式</h3>\n<p>两种分区方式：MBR，GPT</p>\n<p><strong>MBR 分区</strong></p>\n<p>MBR：Master Boot Record，1982 年，使用 32 位表示扇区数，分区不超过 2T<br />\n 划分分区的单位：<br />\nCentOS 5 之前按整柱面划分<br />\n CentOS 6 版本后可以按 Sector 划分<br />\n 0 磁道 0 扇区：512bytes<br />\n446bytes: boot loader 启动相关<br />\n 64bytes：分区表，其中每 16bytes 标识一个分区<br />\n 2bytes: 55AA，标识位<br />\n MBR 分区中一块硬盘最多有 4 个主分区，也可以 3 主分区 + 1 扩展 (N 个逻辑分区)<br />\n MBR 分区：主和扩展分区对应的 1--4，/dev/sda3，逻辑分区从 5 开始，/dev/sda5</p>\n<p>问题：利用分区策略相同的另一台主机的分区表来还原和恢复当前主机破环的分区表？</p>\n<p><strong>GPT 分区</strong><br />\n GPT：GUID（Globals Unique Identifiers） partition table 支持 128 个分区，使用 64 位，支持 8Z（<br />\n512Byte/block ）64Z （ 4096Byte/block）<br />\n使用 128 位 UUID (Universally Unique Identifier) 表示磁盘和分区 GPT 分区表自动备份在头和尾两份，<br />\n并有 CRC 校验位<br />\n UEFI (Unified Extensible Firmware Interface 统一可扩展固件接口) 硬件支持 GPT，使得操作系统可以<br />\n启动</p>\n<p><strong>GPT 分区结构分为 4 个区域：</strong></p>\n<ul>\n<li>GPT 头</li>\n<li>分区表</li>\n<li>GPT 分区</li>\n<li>备份区域</li>\n</ul>\n<h2 id=\"22-管理分区\"><a class=\"anchor\" href=\"#22-管理分区\">#</a> 2.2 管理分区</h2>\n<p><strong>列出块设备</strong></p>\n<pre><code>lsblk\n</code></pre>\n<p><strong>创建分区命令</strong></p>\n<pre><code>fdisk 管理MBR分区\ngdisk 管理GPT分区\nparted 高级分区操作，可以是交互或非交互方式\n</code></pre>\n<p><strong>重新设置内存中的内核分区表版本，适合于除了 CentOS 6 以外的其它版本 5，7，8</strong></p>\n<pre><code>partprobe\n</code></pre>\n<h3 id=\"221-添加并检测新硬盘\"><a class=\"anchor\" href=\"#221-添加并检测新硬盘\">#</a> 2.2.1 添加并检测新硬盘</h3>\n<p>1、添加新硬盘使用 lsblk 命令显示出块设备</p>\n<pre><code>root@ubuntu200404:~# lsblk\nNAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nloop0                       7:0    0 61.9M  1 loop /snap/core20/1328\nloop1                       7:1    0 67.2M  1 loop /snap/lxd/21835\nloop2                       7:2    0   62M  1 loop /snap/core20/1587\nloop3                       7:3    0 43.6M  1 loop /snap/snapd/14978\nloop4                       7:4    0   47M  1 loop /snap/snapd/16292\nloop5                       7:5    0 67.8M  1 loop /snap/lxd/22753\nsda                         8:0    0   20G  0 disk \n├─sda1                      8:1    0    1M  0 part \n├─sda2                      8:2    0  1.5G  0 part /boot\n└─sda3                      8:3    0 18.5G  0 part \n  └─ubuntu--vg-ubuntu--lv 253:0    0   10G  0 lvm  /\nsr0                        11:0    1  1.2G  0 rom \n</code></pre>\n<p>发现并没有检测出来新添加的硬盘</p>\n<p>2、检测新硬盘</p>\n<p>方法 1：可以重启电脑</p>\n<p>方法 2： 重新扫描存储设备的 scsi 总线</p>\n<pre><code># host后面的数字不是固定的，以实际为准\nroot@ubuntu200404:~# echo '- - -' &gt; /sys/class/scsi_host/host32/scan\n</code></pre>\n<p>再次使用 lsblk 命令查看发现已经多了 sda 的硬盘，说明成功了</p>\n<pre><code>root@ubuntu200404:~# lsblk\nNAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nloop0                       7:0    0 61.9M  1 loop /snap/core20/1328\nloop1                       7:1    0 67.2M  1 loop /snap/lxd/21835\nloop2                       7:2    0   62M  1 loop /snap/core20/1587\nloop3                       7:3    0 43.6M  1 loop /snap/snapd/14978\nloop4                       7:4    0   47M  1 loop /snap/snapd/16292\nloop5                       7:5    0 67.8M  1 loop /snap/lxd/22753\nsda                         8:0    0   20G  0 disk \n├─sda1                      8:1    0    1M  0 part \n├─sda2                      8:2    0  1.5G  0 part /boot\n└─sda3                      8:3    0 18.5G  0 part \n  └─ubuntu--vg-ubuntu--lv 253:0    0   10G  0 lvm  /\nsdb                         8:16   0   20G  0 disk\t\t\t\t# 新添加的硬盘 \nsr0                        11:0    1  1.2G  0 rom\n</code></pre>\n<h3 id=\"222-partend命令\"><a class=\"anchor\" href=\"#222-partend命令\">#</a> 2.2.2 partend 命令</h3>\n<p><strong>注意：parted 的操作都是实时生效的，小心使用</strong></p>\n<p>格式:</p>\n<pre><code>parted [选项]... [设备 [命令 [参数]...]...]\n</code></pre>\n<p>范例：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>parted /dev/sdb mklabel gpt|msdos</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>parted /dev/sdb print</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>parted /dev/sdb mkpart primary 1 200 （默认M）</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>parted /dev/sdb rm 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>parted -l 列出所有硬盘分区信息</pre></td></tr></table></figure><h3 id=\"223-分区工具fdisk和gdisk\"><a class=\"anchor\" href=\"#223-分区工具fdisk和gdisk\">#</a> 2.2.3 分区工具 fdisk 和 gdisk</h3>\n<pre><code>fdisk -l [-u] [device...] 查看分区\nfdisk [device...] 管理MBR分区\ngdisk [device...] 类fdisk 的GPT分区工具\n\n# 范例：\nfdisk /dev/sdb\n</code></pre>\n<p><strong>子命令：</strong></p>\n<pre><code>p 分区列表\nt 更改分区类型\nn 创建新分区\nd 删除分区\nv 校验分区\nu 转换单位\nw 保存并退出\nq 不保存并退出\n</code></pre>\n<p><strong>查看内核是否已经识别新的分区</strong></p>\n<pre><code>cat /proc/partitions\n</code></pre>\n<p><strong>CentOS 7,8 同步分区表:</strong></p>\n<pre><code>partprobe\n</code></pre>\n<h2 id=\"23-文件系统\"><a class=\"anchor\" href=\"#23-文件系统\">#</a> 2.3 文件系统</h2>\n<h3 id=\"231-文件系统概念\"><a class=\"anchor\" href=\"#231-文件系统概念\">#</a> 2.3.1 文件系统概念</h3>\n<p>文件系统是操作系统用于明确存储设备或分区上的文件的方法和数据结构；即在存储设备上组织文件的<br />\n方法。操作系统中负责管理和存储文件信息的软件结构称为文件管理系统，简称文件系统<br />\n从系统角度来看，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进<br />\n行保护和检索的系统。具体地说，它负责为用户建立文件，存入、读出、修改、转储文件，控制文件的<br />\n存取，安全控制，日志，压缩，加密等<br />\n支持的文件系统：</p>\n<pre><code>/lib/modules/`uname -r`/kernel/fs\n</code></pre>\n<p>(各种文件系统)[<span class=\"exturl\" data-url=\"aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29tcGFyaXNvbl9vZl9maWxlX3N5c3RlbXM=\">https://en.wikipedia.org/wiki/Comparison_of_file_systems</span>]</p>\n<p>** 帮助：**man 5 fs</p>\n<h3 id=\"232-文件系统类型\"><a class=\"anchor\" href=\"#232-文件系统类型\">#</a> 2.3.2 文件系统类型</h3>\n<p><strong>Linux 常用文件系统</strong></p>\n<ul>\n<li>ext2：Extended file system 适用于那些分区容量不是太大，更新也不频繁的情况，例如 /boot 分<br />\n区</li>\n<li>ext3：是 ext2 的改进版本，其支持日志功能，能够帮助系统从非正常关机导致的异常中恢复</li>\n<li>ext4：是 ext 文件系统的最新版。提供了很多新的特性，包括纳秒级时间戳、创建和使用巨型文件<br />\n (16TB)、最大 1EB 的文件系统，以及速度的提升</li>\n<li>xfs：SGI，支持最大 8EB 的文件系统</li>\n<li>swap</li>\n<li>iso9660 光盘</li>\n<li>btrfs（Oracle）</li>\n<li>reiserfs</li>\n</ul>\n<p><strong>Windows 常用文件系统</strong></p>\n<ul>\n<li>FAT32</li>\n<li>NTFS</li>\n<li>exFAT</li>\n<li>Unix：</li>\n<li>FFS（fast）</li>\n<li>UFS（unix）</li>\n<li>JFS2</li>\n</ul>\n<p><strong>网络文件系统：</strong></p>\n<ul>\n<li>NFS</li>\n<li>CIFS</li>\n</ul>\n<p><strong>集群文件系统：</strong></p>\n<ul>\n<li>GFS2</li>\n<li>OCFS2（oracle）</li>\n</ul>\n<p><strong>分布式文件系统：</strong></p>\n<ul>\n<li>fastdfs</li>\n<li>ceph</li>\n<li>moosefs</li>\n<li>mogilefs</li>\n<li>glusterfs</li>\n<li>Lustre</li>\n</ul>\n<p><strong>RAW：</strong></p>\n<p>裸文件系统，未经处理或者未经格式化产生的文件系统<br />\n常用的文件系统特性：</p>\n<p><strong>FAT32</strong></p>\n<ul>\n<li>最多只能支持 16TB 的文件系统和 4GB 的文件</li>\n</ul>\n<p><strong>NTFS</strong></p>\n<ul>\n<li>最多只能支持 16EB 的文件系统和 16EB 的文件</li>\n</ul>\n<p><strong>EXT3</strong></p>\n<ul>\n<li>最多只能支持 32TB 的文件系统和 2TB 的文件，实际只能容纳 2TB 的文件系统和 16GB 的文件</li>\n<li>Ext3 目前只支持 32000 个子目录</li>\n<li>Ext3 文件系统使用 32 位空间记录块数量和 inode 数量</li>\n<li>当数据写入到 Ext3 文件系统中时，Ext3 的数据块分配器每次只能分配一个 4KB 的块</li>\n</ul>\n<p><strong>EXT4：</strong></p>\n<ul>\n<li>EXT4 是 Linux 系统下的日志文件系统，是 EXT3 文件系统的后继版本</li>\n<li>Ext4 的文件系统容量达到 1EB，而支持单个文件则达到 16TB</li>\n<li>理论上支持无限数量的子目录</li>\n<li>Ext4 文件系统使用 64 位空间记录块数量和 inode 数量</li>\n<li>Ext4 的多块分配器支持一次调用分配多个数据块</li>\n<li>修复速度更快</li>\n</ul>\n<p><strong>XFS</strong></p>\n<ul>\n<li>根据所记录的日志在很短的时间内迅速恢复磁盘文件内容</li>\n<li>用优化算法，日志记录对整体文件操作影响非常小</li>\n<li>是一个全 64-bit 的文件系统，最大可以支持 8EB 的文件系统，而支持单个文件则达到 8EB</li>\n<li>能以接近裸设备 I/O 的性能存储数据</li>\n</ul>\n<p><strong>查前支持的文件系统：</strong></p>\n<pre><code>cat /proc/filesystems\n</code></pre>\n<h3 id=\"233-文件系统的组成部分\"><a class=\"anchor\" href=\"#233-文件系统的组成部分\">#</a> 2.3.3 文件系统的组成部分</h3>\n<p>内核中的模块：ext4, xfs, vfat<br />\nLinux 的虚拟文件系统：VFS<br />\n 用户空间的管理工具：mkfs.ext4, mkfs.xfs,mkfs.vfat</p>\n<h3 id=\"234-文件系统选择管理\"><a class=\"anchor\" href=\"#234-文件系统选择管理\">#</a> 2.3.4 文件系统选择管理</h3>\n<h4 id=\"2341-创建文件系统\"><a class=\"anchor\" href=\"#2341-创建文件系统\">#</a> 2.3.4.1 创建文件系统</h4>\n<p><strong>创建文件管理工具</strong></p>\n<pre><code>mkfs命令：\n(1) mkfs.FS_TYPE /dev/DEVICE\next4\nxfs\nbtrfs\nvfat\n(2) mkfs -t FS_TYPE /dev/DEVICE\n-L 'LABEL' 设定卷标\nmke2fs：ext系列文件系统专用管理工具\n</code></pre>\n<p><strong>常用选项：</strong></p>\n<pre><code>-t &#123;ext2|ext3|ext4|xfs&#125; 指定文件系统类型\n-b &#123;1024|2048|4096&#125; 指定块 block 大小\n-L ‘LABEL’ 设置卷标\n-j 相当于 -t ext3， mkfs.ext3 = mkfs -t ext3 = mke2fs -j = mke2fs -t ext3\n-i # 为数据空间中每多少个字节创建一个inode；不应该小于block大\n小\n-N # 指定分区中创建多少个inode\n-I 一个inode记录占用的磁盘空间大小，128---4096\n-m # 默认5%,为管理人员预留空间占总空间的百分比\n-O FEATURE[,...] 启用指定特性\n-O ^FEATURE \n</code></pre>\n<p><strong>案例：mkfs.ext4 /dev/sdb1</strong></p>\n<pre><code>root@ubuntu200404:~# mkfs.ext4 /dev/sdb1\nmke2fs 1.45.5 (07-Jan-2020)\nCreating filesystem with 2621440 4k blocks and 655360 inodes\nFilesystem UUID: a7ef4142-26e5-43dd-b9d0-24c4d09155a1\nSuperblock backups stored on blocks: \n\t32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632\n\nAllocating group tables: done                            \nWriting inode tables: done                            \nCreating journal (16384 blocks): done\nWriting superblocks and filesystem accounting information: done \n\nroot@ubuntu200404:~# \n</code></pre>\n<h4 id=\"2342-查看和管理分区信息\"><a class=\"anchor\" href=\"#2342-查看和管理分区信息\">#</a> 2.3.4.2 查看和管理分区信息</h4>\n<p>blkid 可以查看块设备属性信息<br />\n格式：</p>\n<pre><code>blkid [OPTION]... [DEVICE]\n</code></pre>\n<p>常用选项：</p>\n<pre><code>-U UUID 根据指定的UUID来查找对应的设备\n-L LABEL 根据指定的LABEL来查找对应的设备\ne2label：管理ext系列文件系统的LABEL\n</code></pre>\n<pre><code>e2label DEVICE [LABEL]\n</code></pre>\n<p><strong>范例</strong></p>\n<pre><code>root@ubuntu200404:~# blkid /dev/sdb1\n/dev/sdb1: UUID=&quot;a7ef4142-26e5-43dd-b9d0-24c4d09155a1&quot; TYPE=&quot;ext4&quot; PARTUUID=&quot;db60ac71-01&quot;\nroot@ubuntu200404:~# \n</code></pre>\n<p><strong>查找分区</strong></p>\n<pre><code>findfs [options] LABEL=&lt;label&gt;\nfindfs [options] UUID=&lt;uuid&gt;\n</code></pre>\n<p><strong>tune2fs：重新设定 ext 系列文件系统可调整参数的值</strong></p>\n<pre><code>-l 查看指定文件系统超级块信息；super block\n-L 'LABEL’ 修改卷标\n-m # 修预留给管理员的空间百分比\n-j 将ext2升级为ext3\n-O 文件系统属性启用或禁用, -O ^has_journal\n-o 调整文件系统的默认挂载选项，-o ^acl\n-U UUID 修改UUID号\n</code></pre>\n<p><strong>dumpe2fs：显示 ext 文件系统信息，将磁盘块分组管理</strong><br />\n - h：查看超级块信息，不显示分组信息</p>\n<p><strong>范例：查看 ext 文件系统的元数据和块组信息</strong></p>\n<pre><code>root@ubuntu200404:~# dumpe2fs /dev/sdb1\ndumpe2fs 1.45.5 (07-Jan-2020)\nFilesystem volume name:   &lt;none&gt;\nLast mounted on:          &lt;not available&gt;\nFilesystem UUID:          a7ef4142-26e5-43dd-b9d0-24c4d09155a1\nFilesystem magic number:  0xEF53\nFilesystem revision #:    1 (dynamic)\nFilesystem features:      has_journal ext_attr resize_inode dir_index filetype extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum\nFilesystem flags:         signed_directory_hash \nDefault mount options:    user_xattr acl\nFilesystem state:         clean\nErrors behavior:          Continue\nFilesystem OS type:       Linux\nInode count:              655360\nBlock count:              2621440\nReserved block count:     131072\nFree blocks:              2554687\nFree inodes:              655349\nFirst block:              0\n......\n......\n......\n</code></pre>\n<p><strong>xfs_info：显示示挂载或已挂载的 xfs 文件系统信息</strong></p>\n<pre><code>xfs_info mountpoint|devname\n</code></pre>\n<p><strong>范例</strong></p>\n<pre><code>xfs_info /dev/sda1\n</code></pre>\n<h4 id=\"2343-文件系统检测和修复\"><a class=\"anchor\" href=\"#2343-文件系统检测和修复\">#</a> 2.3.4.3 文件系统检测和修复</h4>\n<p>文件系统夹故障常发生于死机或者非正常关机之后，挂载为文件系统标记为 “no clean”<br />\n<strong> 注意：一定不要在挂载状态下执行下面命令修复</strong></p>\n<p>fsck: File System Check</p>\n<pre><code>fsck.FS_TYPE\nfsck -t FS_TYPE\n</code></pre>\n<p><strong>注意：FS_TYPE 一定要与分区上已经文件类型相同</strong></p>\n<p><strong>常用选项</strong></p>\n<pre><code>-a 自动修复\n-r 交互式修复错误\n</code></pre>\n<p><strong>e2fsck：ext 系列文件专用的检测修复工具</strong></p>\n<pre><code>-y 自动回答为yes\n-f 强制修复\n-p 自动进行安全的修复文件系统问题\n</code></pre>\n<p><strong>用法：</strong></p>\n<pre><code>e2fsck /dev/sdb2\n</code></pre>\n<p><strong>xfs_repair：xfs 文件系统专用检测修复工具</strong><br />\n<strong>常用选项：</strong></p>\n<pre><code>-f 修复文件，而设备\n-n 只检查\n-d 允许修复只读的挂载设备，在单用户下修复 / 时使用，然后立即reboot\n</code></pre>\n<p><strong>用法：</strong></p>\n<pre><code>xfs_repair /dev/sda1 \n</code></pre>\n<h2 id=\"24-挂载\"><a class=\"anchor\" href=\"#24-挂载\">#</a> 2.4 挂载</h2>\n<p>挂载：将额外文件系统与根文件系统某现存的目录建立起关联关系，进而使得此目录做为其它文件访问入<br />\n口的行为<br />\n卸载：为解除此关联关系的过程<br />\n把设备关联挂载点：mount Point<br />\n 挂载点下原有文件在挂载完成后会被临时隐藏，因此，挂载点目录一般为空<br />\n进程正在使用中的设备无法被卸载</p>\n<h3 id=\"241-挂载文件系统-mount\"><a class=\"anchor\" href=\"#241-挂载文件系统-mount\">#</a> 2.4.1 挂载文件系统 mount</h3>\n<p><strong>格式</strong></p>\n<pre><code>mount [-fnrsvw] [-t vfstype] [-o options] device mountpoint\n</code></pre>\n<p>device：指明要挂载的设备</p>\n<ul>\n<li>设备文件：例如:/dev/sda5</li>\n<li>卷标：-L 'LABEL', 例如 -L 'MYDATA'</li>\n<li>UUID： -U 'UUID'：例如 -U '0c50523c-43f1-45e7-85c0-a126711d406e'</li>\n<li>伪文件系统名称：proc, sysfs, devtmpfs, configfs</li>\n</ul>\n<p>mountpoint：挂载点目录必须事先存在，建议使用空目录<br />\n mount 常用命令选项</p>\n<pre><code>-t fstype 指定要挂载的设备上的文件系统类型,如:ext4,xfs\n-r readonly，只读挂载\n-w read and write, 读写挂载,此为默认设置,可省略\n-n 不更新/etc/mtab，mount不可见\n-a 自动挂载所有支持自动挂载的设备(定义在了/etc/fstab文件中，且挂载选项中有\nauto功能)\n-L 'LABEL' 以卷标指定挂载设备\n-U 'UUID' 以UUID指定要挂载的设备\n-B, --bind 绑定目录到另一个目录上\n-o options：(挂载文件系统的选项)，多个选项使用逗号分隔\nasync 异步模式,内存更改时,写入缓存区buffer,过一段时间再写到磁盘中，效率高，但不安全\nsync 同步模式,内存更改时，同时写磁盘，安全，但效率低下\natime/noatime 包含目录和文件\ndiratime/nodiratime 目录的访问时间戳\nauto/noauto 是否支持开机自动挂载，是否支持-a选项\nexec/noexec 是否支持将文件系统上运行应用程序\ndev/nodev 是否支持在此文件系统上使用设备文件\nsuid/nosuid 是否支持suid和sgid权限\nremount 重新挂载\nro/rw 只读、读写\nuser/nouser 是否允许普通用户挂载此设备，/etc/fstab使用\nacl/noacl 启用此文件系统上的acl功能\nloop 使用loop设备\n_netdev 当网络可用时才对网络资源进行挂载，如：NFS文件系统\ndefaults 相当于rw, suid, dev, exec, auto, nouser, async\n</code></pre>\n<p><strong>挂载规则:</strong></p>\n<ul>\n<li>一个挂载点同一时间只能挂载一个设备</li>\n<li>一个挂载点同一时间挂载了多个设备，只能看到最后一个设备的数据，其它设备上的数据将被隐藏</li>\n<li>一个设备可以同时挂载到多个挂载点</li>\n<li>通常挂载点一般是已存在空的目录</li>\n</ul>\n<p><strong>范例：挂载案例</strong></p>\n<pre><code>root@ubuntu200404:/data# mount /dev/sdb1 /data/mysql_mount/\nroot@ubuntu200404:/data# df\n</code></pre>\n<p><img data-src=\"../image.assets/1659865748687.png\" alt=\"1659865748687\" /></p>\n<p>###　2.4.2 卸载文件系统 umount<br />\n 卸载时：可使用设备，也可以使用挂载点</p>\n<pre><code>umount 设备名|挂载点\n</code></pre>\n<h3 id=\"243-查看挂载情况\"><a class=\"anchor\" href=\"#243-查看挂载情况\">#</a> 2.4.3 查看挂载情况</h3>\n<p><strong>查看挂载</strong></p>\n<pre><code>#通过查看/etc/mtab文件显示当前已挂载的所有设备\nmount\n#查看内核追踪到的已挂载的所有设备\ncat /proc/mounts\n</code></pre>\n<p><strong>查看挂载点情况</strong></p>\n<pre><code>findmnt MOUNT_POINT|device\n</code></pre>\n<p><strong>查看正在访问指定文件系统的进程</strong></p>\n<pre><code>lsof MOUNT_POINT\nfuser -v MOUNT_POINT\n</code></pre>\n<p><strong>终止所有在正访问指定的文件系统的进程</strong></p>\n<pre><code>fuser -km MOUNT_POINT\n</code></pre>\n<h3 id=\"244-持久挂载\"><a class=\"anchor\" href=\"#244-持久挂载\">#</a> 2.4.4 持久挂载</h3>\n<p>将挂载保存到 /etc/fstab 中可以下次开机时，自动启用挂载<br />\n /etc/fstab 格式帮助：</p>\n<pre><code>man 5 fstab\n</code></pre>\n<p>每行定义一个要挂载的文件系统，，其中包括共 6 项</p>\n<ul>\n<li>要挂载的设备或伪文件系统设备文件<br />\n LABEL：LABEL=&quot;&quot;<br />\nUUID：UUID=&quot;&quot;<br />\n 伪文件系统名称：proc, sysfs</li>\n<li>挂载点：必须是事先存在的目录</li>\n<li>文件系统类型：ext4，xfs，iso9660，nfs，none</li>\n<li>挂载选项：defaults ，acl，bind</li>\n<li>转储频率：0：不做备份 1：每天转储 2：每隔一天转储</li>\n<li>fsck 检查的文件系统的顺序：允许的数字是 0 1 2<br />\n0：不自检 ，1：首先自检；一般只有 rootfs 才用 2：非 rootfs 使用</li>\n</ul>\n<p><strong>添加新的挂载项，需要执行下面命令生效</strong></p>\n<pre><code>mount -a\n</code></pre>\n<p><strong>范例：centos7, 8 /etc/fstab 的分区 UUID 错误，无法启动</strong> *</p>\n<pre><code>自动进入emergency mode,输入root 密码\n#cat /proc/mounts 可以查看到/ 以rw方式挂载\n#vim /etc/fstab\n#reboot\n</code></pre>\n<p><strong>范例：centos 6 /etc/fstab 的分区 UUID 错误，无法启动</strong></p>\n<pre><code>如果/etc/fstab 的挂载设备出错，比如文件系统故障，并且文件系统检测项（即第6项为非0），将导致无\n法启动\n自动进入emergency mode,输入root 密码\n#cat /proc/mounts 可以查看到/ 以ro方式挂载，无法直接修改配置文件\n#mount -o remount,rw /\n#vim /etc/fstab\n将故障行的最后1项，即第6项修改为0，开机不检测此项挂载设备的健康性，从而忽略错误，能实现启动\n</code></pre>\n<p><strong>范例：/etc/fstab 格式</strong></p>\n<pre><code>root@ubuntu200404:/data# cat /etc/fstab \n# /etc/fstab: static file system information.\n#\n# Use 'blkid' to print the universally unique identifier for a\n# device; this may be used with UUID= as a more robust way to name devices\n# that works even if disks are added and removed. See fstab(5).\n#\n# &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;\n# / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation\n/dev/disk/by-id/dm-uuid-LVM-3aQ0WgB04ZXwNPYVAYy9ssb3Wd06E34ggUUxCcYQaVwAb0L03K40wpOxbnqqqa3f / ext4 defaults 0 1\n# /boot was on /dev/sda2 during curtin installation\n/dev/disk/by-uuid/5e8f9763-2db8-48d0-85e2-a26d76521e2f /boot ext4 defaults 0 1\n/swap.img\tnone\tswap\tsw\t0\t0\nroot@ubuntu200404:/data# \n</code></pre>\n<p><strong>范例：添加新的挂载点后修改 /etc/fstab 文件</strong></p>\n<pre><code># /etc/fstab: static file system information.\n# \n# Use 'blkid' to print the universally unique identifier for a\n# device; this may be used with UUID= as a more robust way to name devices\n# that works even if disks are added and removed. See fstab(5).\n#\n# &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;\n# / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation\n/dev/disk/by-id/dm-uuid-LVM-3aQ0WgB04ZXwNPYVAYy9ssb3Wd06E34ggUUxCcYQaVwAb0L03K40wpOxbnqqqa3f / ext4 defaults 0 1\n# /boot was on /dev/sda2 during curtin installation\n/dev/disk/by-uuid/5e8f9763-2db8-48d0-85e2-a26d76521e2f /boot ext4 defaults 0 1\n/swap.img       none    swap    sw      0       0\n\n# 添加该行后、重启系统\nUUID=0e850a4a-028d-48b2-aa18-dd8b16090aa6  /data/mysql_mount  ext4  defaults  0  0\n</code></pre>\n<h2 id=\"25-处理交换文件和分区\"><a class=\"anchor\" href=\"#25-处理交换文件和分区\">#</a> 2.5 处理交换文件和分区</h2>\n<h3 id=\"251-swap分区\"><a class=\"anchor\" href=\"#251-swap分区\">#</a> 2.5.1 swap 分区</h3>\n<p>swap 交换分区是系统 RAM 的补充，swap 分区支持虚拟内存。当没有足够的 RAM 保存系统处理的数据<br />\n时会将数据写入 swap 分区，当系统缺乏 swap 空间时，内核会因 RAM 内存耗尽而终止进程。配置过<br />\n多 swap 空间会造成存储设备处于分配状态但闲置，造成浪费，过多 swap 空间还会掩盖内存泄露<br />\n注意：为优化性能，可以将 swap 分布存放，或高性能磁盘存放</p>\n<h3 id=\"252-交换分区实现过程\"><a class=\"anchor\" href=\"#252-交换分区实现过程\">#</a> 2.5.2 交换分区实现过程</h3>\n<ol>\n<li>创建交换分区或者文件</li>\n<li>使用 mkswap 写入特殊签名</li>\n<li>在 /etc/fstab 文件中添加适当的条目</li>\n<li>使用 swapon -a 激活交换空间</li>\n</ol>\n<p><strong>启用 swap 分区</strong></p>\n<pre><code>swapon [OPTION]... [DEVICE]\n</code></pre>\n<p><strong>常用选项</strong></p>\n<pre><code>-a #激活所有的交换分区\n-p PRIORITY #指定优先级(-1到32767之间)，值越大,优先级越高.也可在/etc/fstab文件中的第4列指\n定：pri=value\n</code></pre>\n<p><strong>范例：创建 swap 分区</strong></p>\n<pre><code>[root@centos8 ~]#mkswap /dev/sdc1\n</code></pre>\n<p><strong>禁用 swap 分区</strong></p>\n<pre><code>swapoff [OPTION]... [DEVICE]\n</code></pre>\n<p><strong>范例：禁用 swap 分区</strong></p>\n<pre><code>[root@centos8 ~]#sed -i.bak '/swap/d' /etc/fstab\n[root@centos8 ~]#swapoff -a\n</code></pre>\n<h3 id=\"253-swap的使用策略\"><a class=\"anchor\" href=\"#253-swap的使用策略\">#</a> 2.5.3 swap 的使用策略</h3>\n<p>/proc/sys/vm/swappiness 的值决定了当内存占用达到一定的百分比时，会启用 swap 分区的空间<br />\n使用规则</p>\n<pre><code>当内存使用率达到100-swappiness时,会启用交换分区\n简单地说这个参数定义了系统对swap的使用倾向，此值越大表示越倾向于使用swap。\n可以设为0，这样做并不会禁止对swap的使用，只是最大限度地降低了使用swap的可能性\n</code></pre>\n<p><strong>范例</strong></p>\n<pre><code>#说明：CentOS7和8默认值为30，内存在使用到100-30=70%的时候，就开始出现有交换分区的使用。\n[root@centos8 ~]# cat /proc/sys/vm/swappiness\n</code></pre>\n<h2 id=\"26-磁盘常见工具\"><a class=\"anchor\" href=\"#26-磁盘常见工具\">#</a> 2.6 磁盘常见工具</h2>\n<h3 id=\"261-df\"><a class=\"anchor\" href=\"#261-df\">#</a> 2.6.1 df</h3>\n<p>文件系统空间实际真正占用等信息的查看工具 df</p>\n<pre><code>df [OPTION]... [FILE]...\n</code></pre>\n<p><strong>常用选项</strong></p>\n<pre><code>-H 以10为单位\n-T 文件系统类型\n-h human-readable\n-i inodes instead of blocks\n-P 以Posix兼容的格式输出\n</code></pre>\n<h3 id=\"263-du\"><a class=\"anchor\" href=\"#263-du\">#</a> 2.6.3 du</h3>\n<p>查看某目录总体空间实际占用状态 du</p>\n<p>显示指定目录下面各个子目录的大小，单位为 KB</p>\n<p><strong>常用选项</strong></p>\n<pre><code>-a --all 显示所有文件和目录的大小,默认只显示目录大小\n-h human-readable\n-s summary\n--max-depth=# 指定最大目录层级\n-x, --one-file-system #忽略不在同一个文件系统的目录\n</code></pre>\n<p><strong>面试题</strong></p>\n<p>1.df 和 du 区别？什么时候 df &gt;du（空分区的时候)<br />\n df 查看是文件系统的空间使用，包括元数据和数据，删除文件后，如果此文件正在使用，不会立即释放空间；du 查看是文件数据空间使用，不包括元数据，删除文件后空间立即释放。</p>\n<p>2. 什么时候 df &lt; du?<br />\n 目录内挂载有其它分区时的情况</p>\n<p>3. 当删除文件但不释放空间时，有什么不同？<br />\ndu 查看文件空间释放，df 不释放</p>\n<h1 id=\"3-raid\"><a class=\"anchor\" href=\"#3-raid\">#</a> 3. RAID</h1>\n",
            "tags": [
                "Linux",
                "Linux从入门到放弃"
            ]
        }
    ]
}